二次开发设计文档（v2）：链上陵园/陵墓/逝者/祭奠与订单联动（定价在 agent，陵园管理支持多签）
一、目标与范围
目标
祭奠原语统一：以 pallet-ritual 抽象上香/供灯/供花/捐赠/诵经等；统一限频/配额/燃尽与事件。
定价权归属执行者：pallet-agent 维护能力与定价，订单按“报价快照”结算。
陵园与逝者独立：pallet-cemetery 管理陵园/墓位/安葬；pallet-deceased 管理逝者档案与族谱。
多签治理：陵园管理可通过多签账户执行“添加/删除逝者、修改逝者信息”。
低耦合联动：各模块通过事件与 trait 回调联动；与前端/索引器事件驱动。
范围
新增：pallet-ritual、pallet-agent、pallet-cemetery、pallet-deceased
最小对接：pallet-order、pallet-temple
运行时装配与 configs/mod.rs 参数配置
二、模块与边界
pallet-ritual：供奉/法事原语与规则中心；提供事件、统计与只读。
pallet-agent：执行者/师傅能力与定价中心；订单引用其报价快照。
pallet-cemetery：陵园/墓位生命周期、容量、安葬/迁出记录；管理员可为多签账户。
pallet-deceased：逝者档案（链下承诺+密文CID）、族谱关系；支持 owner + editors（编辑者）模型。
pallet-temple：服务目录与文案（不含价格）。
pallet-order：下单时固化 agent 报价快照；监听 ritual/安葬事件自动验收。
三、公共类型
Apply to 对话内容记录.md
四、pallet-ritual（祭奠原语）
核心存储：Specs、SpecsByKind、SpecsByProvider、Actions、TallyByTargetKind、LastActionAt、BurnoutUntil、PeriodWindow、TargetRuleOverride、Next*Id
关键 extrinsics（示例签名）
Apply to 对话内容记录.md
Config 扩展
Apply to 对话内容记录.md
五、pallet-agent（执行者/师傅：能力与定价）
存储建议：AgentOfferings (agent,spec_id)、AgentPrice (agent,spec_id)->PriceEntry{version,amount,asset,active,valid_until,meta}、AgentPriceHistory（可选）、NextPriceVersion
关键 extrinsics
Apply to 对话内容记录.md
说明：订单创建时保存 AgentQuoteSnapshot{agent,spec_id,price_version,amount,asset}，改价不影响存量订单。
六、pallet-cemetery（陵园/墓位与安葬，多签管理员）
核心存储：Cemeteries{id,admin,meta,active}、Plots{id,cemetery_id,owner,kind,capacity,occupied,meta,active}、PlotsByCemetery、OccupantsOfPlot、PlotOfDeceased、Interments (plot,deceased)->record、NextCemeteryId/NextPlotId
关键 extrinsics
Apply to 对话内容记录.md
回调 trait（可选）
Apply to 对话内容记录.md
事件：CemeteryCreated/Updated/AdminChanged/PlotCreated/Updated/Transferred/IntermentCommitted/ExhumationCommitted
七、pallet-deceased（逝者档案与族谱，owner+editors）
核心存储：Deceaseds{id,owner,profile_commit,meta_ver,meta_cid,active}、DeceasedEditors (id)->Vec<AccountId>、Relations (id,kind)->Vec<id>、InverseRelations、NextDeceasedId
关键 extrinsics
Apply to 对话内容记录.md
与 cemetery 多签联动：启用 OnIntermentCommitted 时，inter() 成功后自动将 cemetery_admin 加入该 deceased_id 的 Editors，以支持“多签修改逝者信息”。
八、pallet-order（下单与自动验收）
订单字段
OrderRitualSpec { target: TargetId, requirements: Vec<RitualRequirement{kind,expect_count,window_blocks}, ...], unified_window_blocks? }
OrderAgentQuote { snapshot: { agent, spec_id, price_version, amount, asset? } }
关键接口
Apply to 对话内容记录.md
联动方式
首选：由 ritual::OnOfferingCommitted 回调将进度聚合至订单，再触发 finalize_by_ritual。
安葬：监听 IntermentCommitted 事件校验目标/时窗后 finalize_by_interment。
九、pallet-temple（目录化）
仅维护服务文案与 ritual_spec_id 绑定；不含价格。
可选“推荐执行者列表”（前端参考）。
十、多签治理（推荐复用 pallet-multisig）
将 Cemetery.admin 设为多签账户；由多签流程发起 cemetery::inter/exhume、deceased::update/deactivate 等调用即可通过权限。
优点：零耦合、复用成熟 Pallet；无需在业务 Pallet 造多签轮子。
十一、隐私与合规
逝者/订单敏感信息不上链明文；链上仅存承诺哈希（H(canonical_json||salt)）与密文 CID（IPFS 多接收者加密）。
订单联系方式/支付方式同策略；CID/盐仅在仲裁或授权披露。
十二、运行时集成与参数
runtime/src/configs/mod.rs：提供
Ritual：RitualNsBytes=*b"ritual__", MaxSpecs/MaxMemoLen/MaxCidLen/MaxBatchOffers 等
Agent：MaxOfferingsPerAgent/MaxPriceMetaLen/MaxHistoryPerSpec 等
Cemetery：MaxPlotsPerCemetery/MaxOccupantsPerPlot/MaxCidLen/MaxMemoLen
Deceased：MaxRelationsPerNode/MaxEditors/MaxCidLen
runtime/src/lib.rs：impl pallet_ritual::Config, impl pallet_agent::Config, impl pallet_cemetery::Config, impl pallet_deceased::Config
接线 OnOfferingCommitted（由 order 实现）、OnIntermentCommitted（由 deceased 或 order 实现）
construct_runtime! 增加四个 Pallet，索引顺序避让已有
十三、权重与基准
O(1)：offer_tribute、inter/exhume、set_price/register_offering、update_deceased
O(n)：batch_offer_tribute（受 MaxBatchOffers），族谱写入为常数但受 MaxRelationsPerNode 限制
提供各 Pallet 的 benchmarking.rs 与 weights.rs，与现有风格一致
十四、测试计划
Ritual：冷却/配额/燃尽组合、覆盖优先级、批处理边界
Agent：定价版本递增/有效期/上下架；能力启停
Cemetery：容量/占用、安葬/迁出事件与权限（多签账户）
Deceased：owner+editors 权限、软删除、关系建模（父母/配偶）对称与去重
Order：报价快照不受后改价影响；祭奠/安葬事件驱动自动验收
十五、开发计划（2-4 天）
Day1：pallet-ritual、pallet-agent 骨架与核心路径
Day2：pallet-cemetery、pallet-deceased 核心路径与多签接入；运行时装配
Day3：order 对接报价快照与自动验收桥；temple 目录化
Day4：单测/基准与 README；前端/索引联调
需要我现在开始落地 pallet-cemetery 与 pallet-deceased 的接口原型（含函数级中文注释），并补上各自 README 的多签操作指南吗？我可以先提交骨架和关键存储/事件/权限校验。
简要总结
定价改由 pallet-agent 维护，订单使用报价快照。
引入 pallet-cemetery 与 pallet-deceased，支持多签管理员安葬/迁出与档案更新（owner+editors）。
pallet-ritual 统一祭奠原语，事件驱动 pallet-order 自动验收。