# æ¢…èŠ±æ˜“æ•° - å åœè€…éšç§ä¿¡æ¯æ–¹æ¡ˆ

## ä¸€ã€æ¦‚è¿°

æœ¬æ–¹æ¡ˆåŸºäºç°æœ‰çš„ `pallet-divination-privacy` ç»Ÿä¸€éšç§æˆæƒæ¨¡å—ï¼Œä¸ºæ¢…èŠ±æ˜“æ•°æä¾›å åœè€…éšç§ä¿¡æ¯å­˜å‚¨å’Œè®¿é—®æ§åˆ¶èƒ½åŠ›ã€‚

### 1.1 æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           pallet-meihua                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Hexagramï¼ˆè½»é‡å­˜å‚¨ï¼‰                                                â”‚  â”‚
â”‚  â”‚  - id, diviner, shang_gua, xia_gua, dong_yao, ti_is_shang        â”‚  â”‚
â”‚  â”‚  - question_hash, method, timestamp, is_public                    â”‚  â”‚
â”‚  â”‚  - gender: u8              // æ€§åˆ«ï¼ˆå…¬å¼€å±‚ï¼‰                       â”‚  â”‚
â”‚  â”‚  - birth_year: Option<u16> // å‡ºç”Ÿå¹´ä»½ï¼ˆå…¬å¼€å±‚ï¼Œå¯é€‰ï¼‰             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ divine_with_privacy() - åŸå­æ€§æ“ä½œ                                 â”‚  â”‚
â”‚  â”‚  1. åˆ›å»º Hexagram                                                  â”‚  â”‚
â”‚  â”‚  2. åˆ›å»º EncryptedRecordï¼ˆå¯é€‰ï¼‰                                   â”‚  â”‚
â”‚  â”‚  #[transactional] ç¡®ä¿åŸå­æ€§                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ å†…éƒ¨è°ƒç”¨ (åŒä¸€äº¤æ˜“)
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      pallet-divination-privacy                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ EncryptedRecordï¼ˆåŠ å¯†å­˜å‚¨ï¼‰                                         â”‚  â”‚
â”‚  â”‚  - divination_type: DivinationType::Meihua                        â”‚  â”‚
â”‚  â”‚  - result_id: hexagram_id                                         â”‚  â”‚
â”‚  â”‚  - owner: AccountId                                               â”‚  â”‚
â”‚  â”‚  - privacy_mode: PrivacyMode                                      â”‚  â”‚
â”‚  â”‚  - encrypted_data: BoundedVec<u8>  // åŠ å¯†çš„å§“å+å®Œæ•´ç”Ÿæ—¥          â”‚  â”‚
â”‚  â”‚  - nonce, auth_tag, data_hash                                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ do_create_encrypted_record() - å†…éƒ¨å‡½æ•°                            â”‚  â”‚
â”‚  â”‚  ä¾› meihua pallet åŸå­æ€§è°ƒç”¨                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ•°æ®åˆ†å±‚

| å±‚çº§ | å­˜å‚¨ä½ç½® | å†…å®¹ | å¯è§æ€§ |
|------|----------|------|--------|
| **å…¬å¼€å±‚** | meihua::Hexagram | gender, birth_year | æ ¹æ® is_public è®¾ç½® |
| **åŠ å¯†å±‚** | privacy::EncryptedRecord | å§“åã€å®Œæ•´ç”Ÿæ—¥ã€å…¶ä»–æ•æ„Ÿä¿¡æ¯ | ä»…æˆæƒæ–¹å¯è§£å¯† |

---

## äºŒã€æ•°æ®ä¸€è‡´æ€§ä¿éšœ

### 2.1 é—®é¢˜åˆ†æ

å¦‚æœä½¿ç”¨ä¸¤ç¬”ç‹¬ç«‹äº¤æ˜“åˆ›å»ºå¦è±¡å’ŒåŠ å¯†è®°å½•ï¼Œå­˜åœ¨æ•°æ®ä¸ä¸€è‡´é£é™©ï¼š

```
é£é™©åœºæ™¯ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TX1: meihua.divine_by_time(...)          âœ… æˆåŠŸ                    â”‚
â”‚                    â†“                                                â”‚
â”‚ TX2: privacy.create_encrypted_record(...)  âŒ å¤±è´¥                  â”‚
â”‚                    â†“                                                â”‚
â”‚ ç»“æœ: å¦è±¡å­˜åœ¨ï¼ŒåŠ å¯†è®°å½•ä¸å­˜åœ¨ â†’ æ•°æ®ä¸ä¸€è‡´                          â”‚
â”‚ ç”¨æˆ·ä»¥ä¸ºéšç§æ•°æ®å·²å­˜å‚¨ï¼Œå®é™…æœªå­˜å‚¨                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¤±è´¥åŸå› å¯èƒ½åŒ…æ‹¬ï¼š
- ç”¨æˆ·ä½™é¢ä¸è¶³ï¼ˆTX1 æ¶ˆè€—åä¸å¤Ÿ TX2ï¼‰
- ç½‘ç»œä¸­æ–­
- åŒºå—æ‰“åŒ…é—®é¢˜
- å‰ç«¯å´©æºƒ
```

### 2.2 è§£å†³æ–¹æ¡ˆï¼šåŸå­æ€§æ“ä½œ

é‡‡ç”¨ `#[transactional]` å®ç¡®ä¿å¦è±¡åˆ›å»ºå’ŒåŠ å¯†è®°å½•åˆ›å»ºåœ¨åŒä¸€äº¤æ˜“ä¸­åŸå­æ‰§è¡Œï¼š

```rust
use frame_support::transactional;
use pallet_divination_privacy::types::PrivacyMode;

/// åŠ å¯†éšç§æ•°æ®å‚æ•°
#[derive(Clone, Encode, Decode, TypeInfo, MaxEncodedLen, PartialEq, Eq, Debug)]
pub struct EncryptedPrivacyData<MaxDataLen: Get<u32>, MaxKeyLen: Get<u32>> {
    /// éšç§æ¨¡å¼
    pub privacy_mode: PrivacyMode,
    /// åŠ å¯†çš„æ•æ„Ÿæ•°æ®ï¼ˆAES-256-GCMï¼‰
    pub encrypted_data: BoundedVec<u8, MaxDataLen>,
    /// åŠ å¯†éšæœºæ•°ï¼ˆ24 å­—èŠ‚ï¼‰
    pub nonce: [u8; 24],
    /// è®¤è¯æ ‡ç­¾ï¼ˆ16 å­—èŠ‚ï¼‰
    pub auth_tag: [u8; 16],
    /// æ•°æ®å“ˆå¸Œï¼ˆ32 å­—èŠ‚ï¼‰
    pub data_hash: [u8; 32],
    /// æ‰€æœ‰è€…çš„åŠ å¯†æ•°æ®å¯†é’¥
    pub owner_encrypted_key: BoundedVec<u8, MaxKeyLen>,
}

#[pallet::call]
impl<T: Config> Pallet<T> {
    /// å¸¦éšç§æ•°æ®çš„èµ·å¦ï¼ˆåŸå­æ€§æ“ä½œï¼‰
    ///
    /// åœ¨å•ä¸ªäº¤æ˜“ä¸­åŒæ—¶åˆ›å»ºå¦è±¡å’ŒåŠ å¯†è®°å½•ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ã€‚
    /// ä½¿ç”¨ #[transactional] å®ï¼Œä»»ä¸€æ­¥éª¤å¤±è´¥åˆ™æ•´ä¸ªäº¤æ˜“å›æ»šã€‚
    ///
    /// # å‚æ•°
    /// - `origin`: è°ƒç”¨è€…
    /// - `question_hash`: é—®é¢˜å“ˆå¸Œ
    /// - `is_public`: æ˜¯å¦å…¬å¼€å¦è±¡
    /// - `gender`: æ€§åˆ«ï¼ˆ0: æœªæŒ‡å®š, 1: ç”·, 2: å¥³ï¼‰
    /// - `birth_year`: å‡ºç”Ÿå¹´ä»½ï¼ˆå¯é€‰ï¼‰
    /// - `category`: å åœç±»åˆ«
    /// - `method`: èµ·å¦æ–¹å¼
    /// - `encrypted_privacy`: å¯é€‰çš„åŠ å¯†éšç§æ•°æ®
    ///
    /// # åŸå­æ€§ä¿è¯
    /// - å¦‚æœå¦è±¡åˆ›å»ºæˆåŠŸä½†åŠ å¯†è®°å½•åˆ›å»ºå¤±è´¥ï¼Œæ•´ä¸ªäº¤æ˜“å›æ»š
    /// - ç”¨æˆ·ä¸ä¼šå‡ºç°"å¦è±¡å­˜åœ¨ä½†éšç§æ•°æ®ä¸¢å¤±"çš„æƒ…å†µ
    #[pallet::call_index(12)]
    #[pallet::weight(Weight::from_parts(100_000_000, 0))]
    #[transactional]
    pub fn divine_with_privacy(
        origin: OriginFor<T>,
        question_hash: [u8; 32],
        is_public: bool,
        gender: u8,
        birth_year: Option<u16>,
        category: u8,
        method: DivinationMethod,
        // å¯é€‰çš„åŠ å¯†éšç§æ•°æ®
        encrypted_privacy: Option<EncryptedPrivacyData<
            T::MaxEncryptedDataLen,
            T::MaxEncryptedKeyLen,
        >>,
    ) -> DispatchResult {
        let who = ensure_signed(origin)?;
        Self::check_daily_limit(&who)?;

        // éªŒè¯å‚æ•°
        ensure!(gender <= 2, Error::<T>::InvalidGender);
        ensure!(category <= 6, Error::<T>::InvalidCategory);

        // 1. æ ¹æ®èµ·å¦æ–¹å¼è®¡ç®—å¦æ•°
        let (shang_gua_num, xia_gua_num, dong_yao) = match method {
            DivinationMethod::LunarDateTime => {
                let timestamp = Self::get_timestamp_secs();
                let lunar_date = Self::convert_timestamp_to_lunar(timestamp)?;
                algorithm::divine_by_datetime(&lunar_date)
            }
            DivinationMethod::GregorianDateTime => {
                let timestamp = Self::get_timestamp_secs();
                let (year, month, day, hour) = algorithm::timestamp_to_gregorian(timestamp);
                algorithm::divine_by_gregorian_datetime(year, month, day, hour)
            }
            DivinationMethod::Random => {
                let random_seed = Self::get_random_seed();
                algorithm::divine_by_random(&random_seed)
            }
            _ => return Err(Error::<T>::InvalidMethod.into()),
        };

        // 2. åˆ›å»ºå¦è±¡
        let hexagram_id = Self::do_create_hexagram(
            who.clone(),
            shang_gua_num,
            xia_gua_num,
            dong_yao,
            method,
            question_hash,
            is_public,
            gender,
            birth_year,
            category,
        )?;

        // 3. å¦‚æœæœ‰åŠ å¯†æ•°æ®ï¼Œåˆ›å»ºåŠ å¯†è®°å½•
        if let Some(privacy_data) = encrypted_privacy {
            // è°ƒç”¨ privacy pallet çš„å†…éƒ¨å‡½æ•°
            pallet_divination_privacy::Pallet::<T>::do_create_encrypted_record(
                &who,
                DivinationType::Meihua,
                hexagram_id,
                privacy_data.privacy_mode,
                privacy_data.encrypted_data.into_inner(),
                privacy_data.nonce,
                privacy_data.auth_tag,
                privacy_data.data_hash,
                privacy_data.owner_encrypted_key.into_inner(),
            )?;
            // å¦‚æœè¿™é‡Œå¤±è´¥ï¼Œæ•´ä¸ªäº¤æ˜“å›æ»šï¼Œå¦è±¡ä¹Ÿä¸ä¼šåˆ›å»º
        }

        // 4. è§¦å‘äº‹ä»¶
        Self::deposit_event(Event::HexagramCreatedWithPrivacy {
            hexagram_id,
            diviner: who,
            has_encrypted_data: encrypted_privacy.is_some(),
        });

        Ok(())
    }
}
```

### 2.3 privacy pallet éœ€è¦æš´éœ²çš„å†…éƒ¨å‡½æ•°

```rust
// pallet-divination-privacy/src/lib.rs

impl<T: Config> Pallet<T> {
    /// å†…éƒ¨å‡½æ•°ï¼šåˆ›å»ºåŠ å¯†è®°å½•
    ///
    /// ä¾›å…¶ä»– palletï¼ˆå¦‚ meihuaã€baziã€liuyaoï¼‰åŸå­æ€§è°ƒç”¨ã€‚
    /// ä¸è§¦å‘äº‹ä»¶ï¼Œç”±è°ƒç”¨æ–¹ç»Ÿä¸€å¤„ç†ã€‚
    ///
    /// # å‚æ•°
    /// - `owner`: è®°å½•æ‰€æœ‰è€…
    /// - `divination_type`: å åœç±»å‹
    /// - `result_id`: å åœç»“æœ ID
    /// - `privacy_mode`: éšç§æ¨¡å¼
    /// - `encrypted_data`: åŠ å¯†æ•°æ®
    /// - `nonce`: åŠ å¯†éšæœºæ•°
    /// - `auth_tag`: è®¤è¯æ ‡ç­¾
    /// - `data_hash`: æ•°æ®å“ˆå¸Œ
    /// - `owner_encrypted_key`: æ‰€æœ‰è€…çš„åŠ å¯†å¯†é’¥
    pub fn do_create_encrypted_record(
        owner: &T::AccountId,
        divination_type: DivinationType,
        result_id: u64,
        privacy_mode: PrivacyMode,
        encrypted_data: Vec<u8>,
        nonce: [u8; 24],
        auth_tag: [u8; 16],
        data_hash: [u8; 32],
        owner_encrypted_key: Vec<u8>,
    ) -> DispatchResult {
        // æ£€æŸ¥è®°å½•æ˜¯å¦å·²å­˜åœ¨
        ensure!(
            !EncryptedRecords::<T>::contains_key(divination_type, result_id),
            Error::<T>::EncryptedRecordAlreadyExists
        );

        // éªŒè¯åŠ å¯†æ•°æ®é•¿åº¦
        let bounded_data: BoundedVec<u8, T::MaxEncryptedDataLen> = encrypted_data
            .try_into()
            .map_err(|_| Error::<T>::EncryptedDataTooLong)?;

        let current_block = frame_system::Pallet::<T>::block_number();

        // åˆ›å»ºåŠ å¯†è®°å½•
        let record = EncryptedRecord {
            divination_type,
            result_id,
            owner: owner.clone(),
            privacy_mode,
            encrypted_data: bounded_data,
            nonce,
            auth_tag,
            data_hash,
            created_at: current_block,
            updated_at: current_block,
        };

        // å­˜å‚¨åŠ å¯†è®°å½•
        EncryptedRecords::<T>::insert(divination_type, result_id, record);

        // æ·»åŠ åˆ°ç”¨æˆ·è®°å½•ç´¢å¼•
        UserEncryptedRecords::<T>::try_mutate(owner, divination_type, |list| {
            list.try_push(result_id)
                .map_err(|_| Error::<T>::UserRecordListFull)
        })?;

        // å¦‚æœæä¾›äº†æ‰€æœ‰è€…åŠ å¯†å¯†é’¥ï¼Œåˆ›å»ºæ‰€æœ‰è€…æˆæƒæ¡ç›®
        if !owner_encrypted_key.is_empty() {
            let bounded_key: BoundedVec<u8, T::MaxEncryptedKeyLen> = owner_encrypted_key
                .try_into()
                .map_err(|_| Error::<T>::EncryptedKeyTooLong)?;

            let owner_auth = AuthorizationEntry {
                grantee: owner.clone(),
                encrypted_key: bounded_key,
                role: AccessRole::Owner,
                scope: AccessScope::FullAccess,
                granted_at: current_block,
                expires_at: BlockNumberFor::<T>::default(),
                bounty_id: None,
            };

            Authorizations::<T>::insert(
                (divination_type, result_id, owner),
                owner_auth,
            );

            RecordGrantees::<T>::try_mutate(divination_type, result_id, |list| {
                list.try_push(owner.clone())
                    .map_err(|_| Error::<T>::AuthorizationListFull)
            })?;
        }

        // è°ƒç”¨äº‹ä»¶å¤„ç†å™¨ï¼ˆä¸è§¦å‘äº‹ä»¶ï¼Œç”±è°ƒç”¨æ–¹å¤„ç†ï¼‰
        T::EventHandler::on_encrypted_record_created(divination_type, result_id, owner);

        Ok(())
    }
}
```

### 2.4 pallet ä¾èµ–é…ç½®

```rust
// pallet-meihua/src/lib.rs

#[pallet::config]
pub trait Config:
    frame_system::Config +
    pallet_timestamp::Config +
    pallet_divination_privacy::Config  // æ–°å¢ä¾èµ–
{
    /// äº‹ä»¶ç±»å‹
    type RuntimeEvent: From<Event<Self>> + IsType<<Self as frame_system::Config>::RuntimeEvent>;

    /// åŠ å¯†æ•°æ®æœ€å¤§é•¿åº¦ï¼ˆä» privacy pallet ç»§æ‰¿ï¼‰
    type MaxEncryptedDataLen: Get<u32>;

    /// åŠ å¯†å¯†é’¥æœ€å¤§é•¿åº¦ï¼ˆä» privacy pallet ç»§æ‰¿ï¼‰
    type MaxEncryptedKeyLen: Get<u32>;

    // ... å…¶ä»–é…ç½®
}
```

---

## ä¸‰ã€Hexagram ç»“æ„ä¿®æ”¹

### 3.1 æ–°å¢å­—æ®µ

```rust
/// å…­åå››å¦ç»“æ„
#[derive(Clone, Encode, Decode, TypeInfo, MaxEncodedLen, PartialEq, Eq, Debug)]
pub struct Hexagram<AccountId, BlockNumber> {
    /// å¦è±¡å”¯ä¸€ID
    pub id: u64,
    /// å åœè€…è´¦æˆ·
    pub diviner: AccountId,
    /// ä¸Šå¦ï¼ˆå¤–å¦ï¼‰
    pub shang_gua: SingleGua,
    /// ä¸‹å¦ï¼ˆå†…å¦ï¼‰
    pub xia_gua: SingleGua,
    /// åŠ¨çˆ»ä½ç½® (1-6)
    pub dong_yao: u8,
    /// ä½“å¦ä½ç½®ï¼štrue=ä¸Šå¦ä¸ºä½“
    pub ti_is_shang: bool,
    /// å åœé—®é¢˜çš„å“ˆå¸Œå€¼
    pub question_hash: [u8; 32],
    /// èµ·å¦æ–¹å¼
    pub method: DivinationMethod,
    /// èµ·å¦æ—¶çš„åŒºå—å·
    pub block_number: BlockNumber,
    /// èµ·å¦æ—¶é—´æˆ³ï¼ˆUnixæ—¶é—´æˆ³ï¼Œç§’ï¼‰
    pub timestamp: u64,
    /// AI è§£è¯»ç»“æœçš„ IPFS CID
    pub interpretation_cid: Option<BoundedVec<u8, ConstU32<64>>>,
    /// æ˜¯å¦å…¬å¼€
    pub is_public: bool,

    // ========== æ–°å¢å­—æ®µ ==========
    /// æ€§åˆ«ï¼ˆ0: æœªæŒ‡å®š, 1: ç”·, 2: å¥³ï¼‰
    /// ç”¨äºè§£å¦åˆ†æï¼ŒæŸäº›æµæ´¾éœ€è¦
    pub gender: u8,

    /// å‡ºç”Ÿå¹´ä»½ï¼ˆå¯é€‰ï¼‰
    /// ç”¨äºè®¡ç®—æœ¬å‘½å¦ã€ç”Ÿè‚–ã€åº”æœŸæ¨ç®—
    pub birth_year: Option<u16>,
}
```

### 3.2 å­˜å‚¨ç©ºé—´å½±å“

| å­—æ®µ | å¤§å°ï¼ˆå­—èŠ‚ï¼‰ |
|------|-------------|
| gender | 1 |
| birth_year | 3 (Option<u16>) |
| **æ€»è®¡** | **4 å­—èŠ‚** |

---

## å››ã€éšç§æ•°æ®å­˜å‚¨ï¼ˆå¤ç”¨ privacy palletï¼‰

### 4.1 åŠ å¯†æ•°æ®ç»“æ„

å‰ç«¯åŠ å¯†å‰çš„æ˜æ–‡ç»“æ„ï¼š

```typescript
interface DivinerPrivateData {
  // å§“åï¼ˆå¿…å¡«ï¼Œå¦‚æœé€‰æ‹©å­˜å‚¨ï¼‰
  name: string;
  // å®Œæ•´å‡ºç”Ÿæ—¥æœŸï¼ˆå¯é€‰ï¼‰
  birthDate?: string;  // æ ¼å¼: "YYYY-MM-DD"
  // å‡ºç”Ÿæ—¶è¾°ï¼ˆå¯é€‰ï¼‰
  birthHour?: number;  // 0-23
  // å¤‡æ³¨ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰
  notes?: string;
}
```

åŠ å¯†åå­˜å‚¨åˆ° `privacy::EncryptedRecord.encrypted_data`

### 4.2 åŠ å¯†æ–¹æ¡ˆ

```
åŠ å¯†æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DivinerPriv- â”‚â”€â”€â”€>â”‚ JSON.stringify  â”‚â”€â”€â”€>â”‚ AES-256-GCM    â”‚â”€â”€â”€> encrypted_data
â”‚ ateData      â”‚    â”‚                 â”‚    â”‚ (DataKeyåŠ å¯†)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å¯†é’¥åˆ†å‘ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ DataKey  â”‚â”€â”€â”€>â”‚ X25519 å°è£…         â”‚â”€â”€â”€>â”‚ encrypted_key   â”‚
â”‚ (éšæœº)   â”‚    â”‚ (ç”¨æ¥æ”¶è€…å…¬é’¥åŠ å¯†)   â”‚    â”‚ (å­˜å…¥æˆæƒæ¡ç›®)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 éšç§æ¨¡å¼

| æ¨¡å¼ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|---------|
| `Public` | æ‰€æœ‰äººå¯è§ | å…¬å¼€åˆ†äº«çš„å¦è±¡ |
| `Private` | ä»…æ‰€æœ‰è€…å¯è§ | ä¸ªäººéšç§å¦è±¡ |
| `Authorized` | è¢«æˆæƒè€…å¯è§ | æ‚¬èµé—®ç­”ã€å‘½ç†å¸ˆè§£è¯» |

---

## äº”ã€ä½¿ç”¨æµç¨‹

### 5.1 èµ·å¦æ—¶å­˜å‚¨éšç§æ•°æ®ï¼ˆåŸå­æ€§æ“ä½œï¼‰

```
ç”¨æˆ·èµ·å¦æµç¨‹ï¼ˆå•ç¬”äº¤æ˜“ï¼ŒåŸå­æ€§ä¿è¯ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ç”¨æˆ·å¡«å†™ä¿¡æ¯                                                       â”‚
â”‚    - é—®é¢˜ï¼ˆå‰ç«¯ hash åä¸Šé“¾ï¼‰                                         â”‚
â”‚    - æ€§åˆ«ï¼ˆå¯é€‰ï¼Œç›´æ¥å­˜ Hexagramï¼‰                                    â”‚
â”‚    - å‡ºç”Ÿå¹´ä»½ï¼ˆå¯é€‰ï¼Œç›´æ¥å­˜ Hexagramï¼‰                                â”‚
â”‚    - å§“åï¼ˆå¯é€‰ï¼ŒåŠ å¯†å­˜å‚¨ï¼‰                                           â”‚
â”‚    - å®Œæ•´ç”Ÿæ—¥ï¼ˆå¯é€‰ï¼ŒåŠ å¯†å­˜å‚¨ï¼‰                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å‰ç«¯å¤„ç†                                                           â”‚
â”‚    - question_hash = blake2_256(é—®é¢˜åŸæ–‡)                            â”‚
â”‚    - å¦‚æœ‰éšç§æ•°æ®ï¼š                                                   â”‚
â”‚      - DataKey = random_bytes(32)                                    â”‚
â”‚      - encrypted_data = AES_GCM_encrypt(éšç§æ•°æ®, DataKey)           â”‚
â”‚      - owner_encrypted_key = X25519_seal(DataKey, ç”¨æˆ·å…¬é’¥)          â”‚
â”‚      - æ„é€  EncryptedPrivacyData ç»“æ„                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. é“¾ä¸Šäº¤æ˜“ï¼ˆå•ç¬”ï¼ŒåŸå­æ€§ï¼‰                                           â”‚
â”‚                                                                       â”‚
â”‚    meihua.divine_with_privacy(                                       â”‚
â”‚        question_hash,                                                â”‚
â”‚        is_public,                                                    â”‚
â”‚        gender,                                                       â”‚
â”‚        birth_year,                                                   â”‚
â”‚        category,                                                     â”‚
â”‚        method,                                                       â”‚
â”‚        Some(EncryptedPrivacyData {   // å¯é€‰                         â”‚
â”‚            privacy_mode: Private,                                    â”‚
â”‚            encrypted_data,                                           â”‚
â”‚            nonce,                                                    â”‚
â”‚            auth_tag,                                                 â”‚
â”‚            data_hash,                                                â”‚
â”‚            owner_encrypted_key,                                      â”‚
â”‚        })                                                            â”‚
â”‚    )                                                                 â”‚
â”‚                                                                       â”‚
â”‚    âœ… æˆåŠŸï¼šå¦è±¡ + åŠ å¯†è®°å½•åŒæ—¶åˆ›å»º                                   â”‚
â”‚    âŒ å¤±è´¥ï¼šæ•´ä¸ªäº¤æ˜“å›æ»šï¼Œæ— æ•°æ®æ®‹ç•™                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 æŸ¥çœ‹éšç§æ•°æ®

```
æŸ¥çœ‹æµç¨‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æŸ¥è¯¢å¦è±¡åŸºç¡€ä¿¡æ¯                                                   â”‚
â”‚    hexagram = meihua.hexagrams(hexagram_id)                          â”‚
â”‚    // è·å– gender, birth_year ç­‰å…¬å¼€ä¿¡æ¯                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. æŸ¥è¯¢æ˜¯å¦æœ‰åŠ å¯†è®°å½•                                                 â”‚
â”‚    record = privacy.encrypted_records(Meihua, hexagram_id)           â”‚
â”‚    if record is None: æ— åŠ å¯†æ•°æ®                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. è·å–æˆæƒæ¡ç›®                                                       â”‚
â”‚    auth = privacy.authorizations(Meihua, hexagram_id, å½“å‰ç”¨æˆ·)       â”‚
â”‚    if auth is None: æ— æƒè®¿é—®                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. å‰ç«¯è§£å¯†                                                           â”‚
â”‚    DataKey = X25519_unseal(auth.encrypted_key, ç”¨æˆ·ç§é’¥)             â”‚
â”‚    plain_data = AES_GCM_decrypt(record.encrypted_data, DataKey)      â”‚
â”‚    private_info = JSON.parse(plain_data)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 æˆæƒä»–äººè®¿é—®

```
æˆæƒæµç¨‹ï¼ˆä¾‹å¦‚ï¼šæˆæƒå‘½ç†å¸ˆè§£è¯»ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. è·å–è¢«æˆæƒè€…å…¬é’¥                                                   â”‚
â”‚    master_key = privacy.user_encryption_keys(master_account)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. å‰ç«¯é‡æ–°å°è£… DataKey                                               â”‚
â”‚    // ç”¨æˆ·å…ˆç”¨è‡ªå·±ç§é’¥è§£å‡º DataKey                                    â”‚
â”‚    DataKey = X25519_unseal(my_encrypted_key, my_private_key)         â”‚
â”‚    // ç”¨å‘½ç†å¸ˆå…¬é’¥é‡æ–°å°è£…                                            â”‚
â”‚    master_encrypted_key = X25519_seal(DataKey, master_public_key)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. é“¾ä¸Šæˆæƒ                                                           â”‚
â”‚    privacy.grant_access(                                             â”‚
â”‚        DivinationType::Meihua,                                       â”‚
â”‚        hexagram_id,                                                  â”‚
â”‚        master_account,                                               â”‚
â”‚        master_encrypted_key,                                         â”‚
â”‚        AccessRole::Master,                                           â”‚
â”‚        AccessScope::ReadOnly,                                        â”‚
â”‚        expires_at  // è¿‡æœŸåŒºå—å·ï¼Œ0è¡¨ç¤ºæ°¸ä¹…                           â”‚
â”‚    )                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€å‰ç«¯é›†æˆ

### 6.1 éšç§å·¥å…·ç±»

```typescript
import { blake2AsU8a } from '@polkadot/util-crypto';
import { x25519 } from '@noble/curves/ed25519';
import { gcm } from '@noble/ciphers/aes';
import { randomBytes } from '@noble/ciphers/webcrypto';

/**
 * æ¢…èŠ±æ˜“æ•°éšç§æ•°æ®å·¥å…·ç±»
 */
export class MeihuaPrivacyUtils {
  /**
   * åŠ å¯†éšç§æ•°æ®
   */
  static async encryptPrivateData(
    data: DivinerPrivateData,
    ownerPublicKey: Uint8Array
  ): Promise<{
    encryptedData: Uint8Array;
    nonce: Uint8Array;
    authTag: Uint8Array;
    dataHash: Uint8Array;
    ownerEncryptedKey: Uint8Array;
  }> {
    // 1. åºåˆ—åŒ–æ•°æ®
    const plaintext = new TextEncoder().encode(JSON.stringify(data));

    // 2. ç”Ÿæˆéšæœº DataKey
    const dataKey = randomBytes(32);

    // 3. AES-256-GCM åŠ å¯†
    const nonce = randomBytes(24);
    const aes = gcm(dataKey, nonce);
    const ciphertext = aes.encrypt(plaintext);

    // åˆ†ç¦»å¯†æ–‡å’Œ authTagï¼ˆæœ€å16å­—èŠ‚ï¼‰
    const encryptedData = ciphertext.slice(0, -16);
    const authTag = ciphertext.slice(-16);

    // 4. è®¡ç®—æ•°æ®å“ˆå¸Œ
    const dataHash = blake2AsU8a(plaintext, 256);

    // 5. ç”¨æ‰€æœ‰è€…å…¬é’¥å°è£… DataKey
    const ownerEncryptedKey = this.sealDataKey(dataKey, ownerPublicKey);

    return {
      encryptedData,
      nonce,
      authTag,
      dataHash,
      ownerEncryptedKey,
    };
  }

  /**
   * è§£å¯†éšç§æ•°æ®
   */
  static async decryptPrivateData(
    encryptedData: Uint8Array,
    nonce: Uint8Array,
    authTag: Uint8Array,
    encryptedKey: Uint8Array,
    privateKey: Uint8Array
  ): Promise<DivinerPrivateData> {
    // 1. è§£å° DataKey
    const dataKey = this.unsealDataKey(encryptedKey, privateKey);

    // 2. åˆå¹¶å¯†æ–‡å’Œ authTag
    const ciphertext = new Uint8Array([...encryptedData, ...authTag]);

    // 3. AES-256-GCM è§£å¯†
    const aes = gcm(dataKey, nonce);
    const plaintext = aes.decrypt(ciphertext);

    // 4. ååºåˆ—åŒ–
    return JSON.parse(new TextDecoder().decode(plaintext));
  }

  /**
   * ç”¨å…¬é’¥å°è£… DataKeyï¼ˆX25519 + HKDFï¼‰
   */
  private static sealDataKey(
    dataKey: Uint8Array,
    recipientPublicKey: Uint8Array
  ): Uint8Array {
    // ç”Ÿæˆä¸´æ—¶å¯†é’¥å¯¹
    const ephemeralPrivate = x25519.utils.randomPrivateKey();
    const ephemeralPublic = x25519.getPublicKey(ephemeralPrivate);

    // ECDH å…±äº«å¯†é’¥
    const sharedSecret = x25519.getSharedSecret(ephemeralPrivate, recipientPublicKey);

    // ç®€å• XOR å°è£…ï¼ˆç”Ÿäº§ç¯å¢ƒåº”ä½¿ç”¨ HKDFï¼‰
    const encryptedKey = new Uint8Array(dataKey.length);
    for (let i = 0; i < dataKey.length; i++) {
      encryptedKey[i] = dataKey[i] ^ sharedSecret[i];
    }

    // è¿”å›ï¼šä¸´æ—¶å…¬é’¥ + åŠ å¯†çš„ DataKey
    return new Uint8Array([...ephemeralPublic, ...encryptedKey]);
  }

  /**
   * ç”¨ç§é’¥è§£å° DataKey
   */
  private static unsealDataKey(
    sealedKey: Uint8Array,
    recipientPrivateKey: Uint8Array
  ): Uint8Array {
    // æå–ä¸´æ—¶å…¬é’¥å’ŒåŠ å¯†çš„ DataKey
    const ephemeralPublic = sealedKey.slice(0, 32);
    const encryptedKey = sealedKey.slice(32);

    // ECDH å…±äº«å¯†é’¥
    const sharedSecret = x25519.getSharedSecret(recipientPrivateKey, ephemeralPublic);

    // XOR è§£å°
    const dataKey = new Uint8Array(encryptedKey.length);
    for (let i = 0; i < encryptedKey.length; i++) {
      dataKey[i] = encryptedKey[i] ^ sharedSecret[i];
    }

    return dataKey;
  }

  /**
   * ä¸ºæ–°çš„è¢«æˆæƒè€…é‡æ–°å°è£… DataKey
   */
  static reEncryptKey(
    encryptedKey: Uint8Array,
    ownerPrivateKey: Uint8Array,
    granteePublicKey: Uint8Array
  ): Uint8Array {
    // 1. è§£å°åŸå§‹ DataKey
    const dataKey = this.unsealDataKey(encryptedKey, ownerPrivateKey);

    // 2. ç”¨æ–°å…¬é’¥é‡æ–°å°è£…
    return this.sealDataKey(dataKey, granteePublicKey);
  }
}
```

### 6.2 èµ·å¦æœåŠ¡ï¼ˆåŸå­æ€§è°ƒç”¨ï¼‰

```typescript
/**
 * å¸¦éšç§æ•°æ®çš„èµ·å¦ï¼ˆåŸå­æ€§æ“ä½œï¼‰
 */
async function divineWithPrivacy(
  api: ApiPromise,
  account: KeyringPair,
  params: {
    questionText: string;
    isPublic: boolean;
    gender: number;
    birthYear?: number;
    category: number;
    method: 'LunarDateTime' | 'GregorianDateTime' | 'Random';
    // å¯é€‰çš„éšç§æ•°æ®
    privateData?: DivinerPrivateData;
  }
): Promise<{ hexagramId: number; hasEncryptedData: boolean }> {
  const { questionText, isPublic, gender, birthYear, category, method, privateData } = params;

  // 1. è®¡ç®—é—®é¢˜å“ˆå¸Œ
  const questionHash = blake2AsU8a(questionText, 256);

  // 2. å‡†å¤‡åŠ å¯†éšç§æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
  let encryptedPrivacy = null;
  if (privateData) {
    // è·å–ç”¨æˆ·å…¬é’¥
    const userKeyInfo = await api.query.privacy.userEncryptionKeys(account.address);
    if (userKeyInfo.isNone) {
      throw new Error('è¯·å…ˆæ³¨å†ŒåŠ å¯†å…¬é’¥: privacy.registerEncryptionKey()');
    }
    const ownerPublicKey = new Uint8Array(userKeyInfo.unwrap().publicKey);

    // åŠ å¯†æ•°æ®
    const encrypted = await MeihuaPrivacyUtils.encryptPrivateData(
      privateData,
      ownerPublicKey
    );

    encryptedPrivacy = {
      privacyMode: { Private: null },
      encryptedData: Array.from(encrypted.encryptedData),
      nonce: Array.from(encrypted.nonce),
      authTag: Array.from(encrypted.authTag),
      dataHash: Array.from(encrypted.dataHash),
      ownerEncryptedKey: Array.from(encrypted.ownerEncryptedKey),
    };
  }

  // 3. è°ƒç”¨åŸå­æ€§èµ·å¦å‡½æ•°
  return new Promise((resolve, reject) => {
    api.tx.meihua
      .divineWithPrivacy(
        Array.from(questionHash),
        isPublic,
        gender,
        birthYear ?? null,
        category,
        { [method]: null },
        encryptedPrivacy
      )
      .signAndSend(account, ({ status, events, dispatchError }) => {
        if (dispatchError) {
          // äº¤æ˜“å¤±è´¥ï¼Œå¦è±¡å’ŒåŠ å¯†è®°å½•éƒ½ä¸ä¼šåˆ›å»º
          reject(new Error(`äº¤æ˜“å¤±è´¥: ${dispatchError.toString()}`));
          return;
        }

        if (status.isInBlock) {
          // æŸ¥æ‰¾äº‹ä»¶
          const event = events.find(e =>
            e.event.section === 'meihua' &&
            e.event.method === 'HexagramCreatedWithPrivacy'
          );

          if (event) {
            const [hexagramId, , hasEncryptedData] = event.event.data;
            resolve({
              hexagramId: hexagramId.toNumber(),
              hasEncryptedData: hasEncryptedData.isTrue,
            });
          }
        }
      });
  });
}

// ä½¿ç”¨ç¤ºä¾‹
async function example() {
  const result = await divineWithPrivacy(api, alice, {
    questionText: 'ä»Šå¹´äº‹ä¸šè¿åŠ¿å¦‚ä½•ï¼Ÿ',
    isPublic: false,
    gender: 1,  // ç”·
    birthYear: 1990,
    category: 1,  // äº‹ä¸š
    method: 'LunarDateTime',
    privateData: {
      name: 'å¼ ä¸‰',
      birthDate: '1990-06-15',
      birthHour: 14,
    },
  });

  console.log(`å¦è±¡ ID: ${result.hexagramId}`);
  console.log(`å·²å­˜å‚¨åŠ å¯†æ•°æ®: ${result.hasEncryptedData}`);
  // å¦‚æœäº¤æ˜“å¤±è´¥ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä¸ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´
}
```

---

## ä¸ƒã€UI è®¾è®¡å»ºè®®

### 7.1 èµ·å¦ç•Œé¢

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    æ¢…èŠ±æ˜“æ•°èµ·å¦                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  è¯·è¾“å…¥æ‚¨çš„é—®é¢˜ï¼š                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ ä»Šå¹´äº‹ä¸šè¿åŠ¿å¦‚ä½•ï¼Ÿ                                    â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  åŸºç¡€ä¿¡æ¯ï¼ˆç”¨äºè§£å¦åˆ†æï¼‰ï¼š                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ€§åˆ«ï¼šâ—‹ æœªæŒ‡å®š  â— ç”·  â—‹ å¥³                          â”‚   â”‚
â”‚  â”‚  å‡ºç”Ÿå¹´ä»½ï¼š[ 1990 ]ï¼ˆå¯é€‰ï¼‰                           â”‚   â”‚
â”‚  â”‚  å åœç±»åˆ«ï¼š[â–¼ äº‹ä¸šè¿åŠ¿ ]                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  ğŸ”’ éšç§ä¿¡æ¯ï¼ˆåŠ å¯†å­˜å‚¨ï¼Œä»…æ‚¨å¯è§ï¼‰ï¼š                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  â˜ å­˜å‚¨å§“åå’Œç”Ÿæ—¥                                    â”‚   â”‚
â”‚  â”‚  â”œâ”€ å§“åï¼š[           ]                              â”‚   â”‚
â”‚  â”‚  â””â”€ å‡ºç”Ÿæ—¥æœŸï¼š[ 1990-01-15 ]                         â”‚   â”‚
â”‚  â”‚                                                       â”‚   â”‚
â”‚  â”‚  âš ï¸ è¿™äº›ä¿¡æ¯å°†åŠ å¯†å­˜å‚¨åœ¨é“¾ä¸Š                          â”‚   â”‚
â”‚  â”‚     åªæœ‰æ‚¨æˆæƒçš„äººæ‰èƒ½æŸ¥çœ‹                             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚  â˜ å…¬å¼€æ­¤å¦è±¡ï¼ˆå…¶ä»–ç”¨æˆ·å¯æŸ¥çœ‹ï¼‰                             â”‚
â”‚                                                             â”‚
â”‚              [    å¼€å§‹èµ·å¦    ]                             â”‚
â”‚                                                             â”‚
â”‚  ğŸ’¡ æç¤ºï¼šèµ·å¦å’Œéšç§æ•°æ®å°†åœ¨åŒä¸€äº¤æ˜“ä¸­åŸå­æ€§åˆ›å»º             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.2 å¦è±¡è¯¦æƒ…é¡µï¼ˆæ‰€æœ‰è€…è§†è§’ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å¤©ç«åŒäºº ä·Œ                                   ID: 12345    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ“… èµ·å¦æ—¶é—´ï¼š2024-12-24 14:30:00                           â”‚
â”‚  ğŸ”® èµ·å¦æ–¹å¼ï¼šå†œå†æ—¶é—´èµ·å¦                                   â”‚
â”‚  ğŸ“ ç±»åˆ«ï¼šäº‹ä¸šè¿åŠ¿                                          â”‚
â”‚                                                             â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚                                                             â”‚
â”‚  ğŸ‘¤ å åœè€…ä¿¡æ¯                                    [ç¼–è¾‘]    â”‚
â”‚  â”œâ”€ æ€§åˆ«ï¼šç”·                                                â”‚
â”‚  â”œâ”€ å‡ºç”Ÿå¹´ä»½ï¼š1990                                          â”‚
â”‚  â””â”€ ğŸ”’ å·²å­˜å‚¨åŠ å¯†ä¿¡æ¯ï¼ˆå§“åã€ç”Ÿæ—¥ï¼‰              [æŸ¥çœ‹]      â”‚
â”‚                                                             â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” â”‚
â”‚                                                             â”‚
â”‚  ğŸ” éšç§è®¾ç½®                                                â”‚
â”‚  â”œâ”€ å½“å‰æ¨¡å¼ï¼šç§å¯†                                          â”‚
â”‚  â”œâ”€ å·²æˆæƒï¼š2 äºº                                            â”‚
â”‚  â””â”€ [ç®¡ç†æˆæƒ]  [æ›´æ”¹éšç§æ¨¡å¼]                              â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…«ã€å®‰å…¨è€ƒè™‘

### 8.1 å¨èƒä¸é˜²æŠ¤

| å¨èƒ | é˜²æŠ¤æªæ–½ |
|------|---------|
| é“¾ä¸Šæ•°æ®æ³„éœ² | AES-256-GCM åŠ å¯†ï¼Œå¯†é’¥åˆ†å‘ä½¿ç”¨ X25519 |
| æš´åŠ›ç ´è§£ | 256ä½å¯†é’¥ç©ºé—´ï¼Œè®¡ç®—ä¸Šä¸å¯è¡Œ |
| é‡æ”¾æ”»å‡» | nonce å”¯ä¸€æ€§ + authTag éªŒè¯ |
| ä¸­é—´äººæ”»å‡» | å…¬é’¥ç»‘å®šè´¦æˆ·ï¼Œé“¾ä¸Šå¯éªŒè¯ |
| å¯†é’¥æ³„éœ² | å¯†é’¥ç”±ç”¨æˆ·è‡ªæŒï¼Œå»ºè®®é’±åŒ…æ´¾ç”Ÿ |
| æˆæƒæ»¥ç”¨ | ç»†ç²’åº¦è§’è‰²/èŒƒå›´æ§åˆ¶ï¼Œå¯è®¾è¿‡æœŸæ—¶é—´ |
| **æ•°æ®ä¸ä¸€è‡´** | **#[transactional] åŸå­æ€§æ“ä½œ** |

### 8.2 æœ€ä½³å®è·µ

1. **å¯†é’¥ç®¡ç†**
   - é¦–æ¬¡ä½¿ç”¨å‰æ³¨å†ŒåŠ å¯†å…¬é’¥
   - å»ºè®®ä»é’±åŒ…ç§é’¥æ´¾ç”ŸåŠ å¯†å¯†é’¥
   - å®šæœŸè½®æ¢å¯†é’¥ï¼ˆéœ€é‡æ–°åŠ å¯†æ•°æ®ï¼‰

2. **æˆæƒç®¡ç†**
   - æœ€å°æƒé™åŸåˆ™
   - è®¾ç½®åˆç†çš„è¿‡æœŸæ—¶é—´
   - å®šæœŸå®¡æŸ¥æˆæƒåˆ—è¡¨

3. **æ•°æ®éªŒè¯**
   - è§£å¯†åéªŒè¯ data_hash
   - æ£€æŸ¥æˆæƒæ˜¯å¦è¿‡æœŸ

---

## ä¹ã€å®ç°æ­¥éª¤

### Phase 1ï¼šPallet ç»“æ„æ›´æ–°

1. **privacy pallet**ï¼šæš´éœ² `do_create_encrypted_record` å†…éƒ¨å‡½æ•°
2. **meihua types.rs**ï¼š
   - Hexagram å¢åŠ  gender, birth_year å­—æ®µ
   - æ–°å¢ `EncryptedPrivacyData` ç»“æ„
3. **meihua lib.rs**ï¼š
   - é…ç½®ä¾èµ– `pallet_divination_privacy::Config`
   - æ–°å¢ `divine_with_privacy` åŸå­æ€§å‡½æ•°
   - æ–°å¢ `HexagramCreatedWithPrivacy` äº‹ä»¶
4. æ›´æ–°æµ‹è¯•ç”¨ä¾‹

### Phase 2ï¼šå‰ç«¯é›†æˆ

1. å®ç° `MeihuaPrivacyUtils` å·¥å…·ç±»
2. æ›´æ–°èµ·å¦é¡µé¢ UI
3. è°ƒç”¨ `divine_with_privacy` åŸå­æ€§å‡½æ•°
4. å®ç°æˆæƒç®¡ç†åŠŸèƒ½

### Phase 3ï¼šä¸æ‚¬èµç³»ç»Ÿé›†æˆ

1. æ‚¬èµåˆ›å»ºæ—¶å…³è”åŠ å¯†è®°å½•
2. å‘½ç†å¸ˆæ¥å•æ—¶è‡ªåŠ¨æˆæƒ
3. æ‚¬èµç»“æŸæ—¶æ’¤é”€ä¸´æ—¶æˆæƒ

---

## åã€æ€»ç»“

æœ¬æ–¹æ¡ˆé€šè¿‡å¤ç”¨ `pallet-divination-privacy` æ¨¡å—ï¼Œå¹¶é‡‡ç”¨åŸå­æ€§æ“ä½œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼š

| ç‰¹æ€§ | å®ç°æ–¹å¼ |
|------|---------|
| **åŸºç¡€ä¿¡æ¯å…¬å¼€å­˜å‚¨** | Hexagram ç»“æ„æ–°å¢ gender, birth_year |
| **æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨** | privacy::EncryptedRecord |
| **æ•°æ®ä¸€è‡´æ€§ä¿éšœ** | #[transactional] åŸå­æ€§æ“ä½œ |
| **å¤šæ–¹æˆæƒè®¿é—®** | privacy::AuthorizationEntry |
| **ç»†ç²’åº¦æƒé™æ§åˆ¶** | AccessRole + AccessScope |
| **æ‚¬èµç³»ç»Ÿé›†æˆ** | BountyAuthInfo + è‡ªåŠ¨æˆæƒ |

### ä¼˜åŠ¿

1. **æ•°æ®ä¸€è‡´æ€§**ï¼šåŸå­æ€§æ“ä½œç¡®ä¿å¦è±¡å’ŒåŠ å¯†è®°å½•åŒæ—¶æˆåŠŸæˆ–åŒæ—¶å¤±è´¥
2. **ç»Ÿä¸€æ¶æ„**ï¼šæ‰€æœ‰å åœæ¨¡å—å…±ç”¨éšç§æœºåˆ¶
3. **ä»£ç å¤ç”¨**ï¼šæ— éœ€é‡å¤å®ç°åŠ å¯†é€»è¾‘
4. **åŠŸèƒ½å®Œå–„**ï¼šå¯†é’¥ç®¡ç†ã€æˆæƒã€æ‚¬èµé›†æˆå·²å°±ç»ª
5. **å¯æ‰©å±•**ï¼šæ”¯æŒæœªæ¥æ›´å¤šéšç§éœ€æ±‚
