//! # 八字排盘常量定义
//!
//! 本模块包含八字排盘所需的所有常量表，包括：
//! - 藏干表：12地支的藏干数据（✅ 确认辰藏干为"癸水"）
//! - 纳音表：60甲子对应的30种纳音五行
//! - 十神查表：10×10十神关系矩阵
//! - 权重表：月令旺衰权重矩阵（12×36）

use crate::types::*;

// ================================
// 藏干常量表
// ================================

/// 12地支藏干表 (主流派标准)
///
/// ⚠️ 关键确认：辰藏干为"戊乙癸"（使用癸水，不是壬水！）
///
/// 参考依据：
/// - BaziGo: cangganlist[4] = {4, 1, 9} (戊乙癸)
/// - lunar-java: 辰藏"戊乙癸"
/// - 主流派支持率: 87.5% (7/8项目)
///
/// 格式：[天干索引, 天干索引, 天干索引]
/// - 0表示该位置无藏干
/// - 索引对应：甲(0) 乙(1) 丙(2) 丁(3) 戊(4) 己(5) 庚(6) 辛(7) 壬(8) 癸(9)
pub const EARTHLY_HIDDEN_STEMS: [[u8; 3]; 12] = [
	[9, 0, 0],       // 子: 癸
	[5, 9, 7],       // 丑: 己癸辛
	[0, 2, 4],       // 寅: 甲丙戊
	[1, 0, 0],       // 卯: 乙
	[4, 1, 9],       // 辰: 戊乙癸 ✅ 确认使用癸水！
	[2, 6, 4],       // 巳: 丙庚戊
	[3, 5, 0],       // 午: 丁己
	[5, 3, 1],       // 未: 己丁乙
	[6, 8, 4],       // 申: 庚壬戊
	[7, 0, 0],       // 酉: 辛
	[4, 7, 3],       // 戌: 戊辛丁
	[8, 0, 0],       // 亥: 壬甲
];

/// 藏干类型表（主气/中气/余气）
///
/// 与 EARTHLY_HIDDEN_STEMS 对应，标识每个藏干的类型
pub const CANGGAN_TYPE_TABLE: [[CangGanType; 3]; 12] = [
	[CangGanType::ZhuQi, CangGanType::ZhuQi, CangGanType::ZhuQi],     // 子: 癸(主气)
	[CangGanType::ZhuQi, CangGanType::ZhongQi, CangGanType::YuQi],    // 丑: 己(主) 癸(中) 辛(余)
	[CangGanType::ZhuQi, CangGanType::ZhongQi, CangGanType::YuQi],    // 寅: 甲(主) 丙(中) 戊(余)
	[CangGanType::ZhuQi, CangGanType::ZhuQi, CangGanType::ZhuQi],     // 卯: 乙(主气)
	[CangGanType::ZhuQi, CangGanType::ZhongQi, CangGanType::YuQi],    // 辰: 戊(主) 乙(中) 癸(余)
	[CangGanType::ZhuQi, CangGanType::ZhongQi, CangGanType::YuQi],    // 巳: 丙(主) 庚(中) 戊(余)
	[CangGanType::ZhuQi, CangGanType::ZhongQi, CangGanType::ZhuQi],   // 午: 丁(主) 己(中)
	[CangGanType::ZhuQi, CangGanType::ZhongQi, CangGanType::YuQi],    // 未: 己(主) 丁(中) 乙(余)
	[CangGanType::ZhuQi, CangGanType::ZhongQi, CangGanType::YuQi],    // 申: 庚(主) 壬(中) 戊(余)
	[CangGanType::ZhuQi, CangGanType::ZhuQi, CangGanType::ZhuQi],     // 酉: 辛(主气)
	[CangGanType::ZhuQi, CangGanType::ZhongQi, CangGanType::YuQi],    // 戌: 戊(主) 辛(中) 丁(余)
	[CangGanType::ZhuQi, CangGanType::ZhuQi, CangGanType::ZhuQi],     // 亥: 壬(主气)
];

/// 藏干基础权重表
///
/// 简化版权重，用于基础五行强度计算
/// 格式：[主气权重, 中气权重, 余气权重]
pub const CANGGAN_BASE_WEIGHT: [[u16; 3]; 12] = [
	[1000, 0, 0],       // 子: 癸(1000)
	[500, 300, 200],    // 丑: 己(500) 癸(300) 辛(200)
	[800, 360, 0],      // 寅: 甲(800) 丙(360) 戊(0)
	[1000, 0, 0],       // 卯: 乙(1000)
	[500, 300, 200],    // 辰: 戊(500) 乙(300) 癸(200)
	[800, 300, 200],    // 巳: 丙(800) 庚(300) 戊(200)
	[1000, 600, 0],     // 午: 丁(1000) 己(600)
	[800, 300, 200],    // 未: 己(800) 丁(300) 乙(200)
	[800, 400, 200],    // 申: 庚(800) 壬(400) 戊(200)
	[1000, 0, 0],       // 酉: 辛(1000)
	[800, 300, 200],    // 戌: 戊(800) 辛(300) 丁(200)
	[800, 400, 0],      // 亥: 壬(800) 甲(400)
];

// ================================
// 纳音常量表
// ================================

/// 纳音五行表 (30种)
///
/// 索引对应：干支值 / 2
/// 例如：甲子(0) → 0/2=0 → 海中金
///       乙丑(1) → 1/2=0 → 海中金
///       丙寅(2) → 2/2=1 → 炉中火
pub const NAYIN_TABLE: [NaYin; 30] = [
	NaYin::HaiZhongJin,    // 0: 甲子、乙丑 - 海中金
	NaYin::LuZhongHuo,     // 1: 丙寅、丁卯 - 炉中火
	NaYin::DaLinMu,        // 2: 戊辰、己巳 - 大林木
	NaYin::LuPangTu,       // 3: 庚午、辛未 - 路旁土
	NaYin::JianFengJin,    // 4: 壬申、癸酉 - 剑锋金
	NaYin::ShanTouHuo,     // 5: 甲戌、乙亥 - 山头火
	NaYin::JianXiaShui,    // 6: 丙子、丁丑 - 涧下水
	NaYin::ChengTouTu,     // 7: 戊寅、己卯 - 城头土
	NaYin::BaiLaJin,       // 8: 庚辰、辛巳 - 白蜡金
	NaYin::YangLiuMu,      // 9: 壬午、癸未 - 杨柳木
	NaYin::QuanZhongShui,  // 10: 甲申、乙酉 - 泉中水
	NaYin::WuShangTu,      // 11: 丙戌、丁亥 - 屋上土
	NaYin::PiLiHuo,        // 12: 戊子、己丑 - 霹雳火
	NaYin::SongBaiMu,      // 13: 庚寅、辛卯 - 松柏木
	NaYin::ChangLiuShui,   // 14: 壬辰、癸巳 - 长流水
	NaYin::ShaZhongJin,    // 15: 甲午、乙未 - 沙中金
	NaYin::ShanXiaHuo,     // 16: 丙申、丁酉 - 山下火
	NaYin::PingDiMu,       // 17: 戊戌、己亥 - 平地木
	NaYin::BiShangTu,      // 18: 庚子、辛丑 - 壁上土
	NaYin::JinBoJin,       // 19: 壬寅、癸卯 - 金箔金
	NaYin::FuDengHuo,      // 20: 甲辰、乙巳 - 覆灯火
	NaYin::TianHeShui,     // 21: 丙午、丁未 - 天河水
	NaYin::DaYiTu,         // 22: 戊申、己酉 - 大驿土
	NaYin::ChaiChuanJin,   // 23: 庚戌、辛亥 - 钗钏金
	NaYin::SangTuoMu,      // 24: 壬子、癸丑 - 桑柘木
	NaYin::DaXiShui,       // 25: 甲寅、乙卯 - 大溪水
	NaYin::ShaZhongTu,     // 26: 丙辰、丁巳 - 沙中土
	NaYin::TianShangHuo,   // 27: 戊午、己未 - 天上火
	NaYin::ShiLiuMu,       // 28: 庚申、辛酉 - 石榴木
	NaYin::DaHaiShui,      // 29: 壬戌、癸亥 - 大海水
];

// ================================
// 十神查表
// ================================

/// 十神查表 (10×10矩阵)
///
/// 格式：SHISHEN_TABLE[日主天干][其他天干] = 十神索引
///
/// 十神索引对应：
/// - 0: 比肩, 1: 劫财, 2: 食神, 3: 伤官, 4: 偏财
/// - 5: 正财, 6: 七杀, 7: 正官, 8: 偏印, 9: 正印
pub const SHISHEN_TABLE: [[u8; 10]; 10] = [
	[0, 1, 2, 3, 4, 5, 6, 7, 8, 9], // 甲为日主
	[1, 0, 3, 2, 5, 4, 7, 6, 9, 8], // 乙为日主
	[8, 9, 0, 1, 2, 3, 4, 5, 6, 7], // 丙为日主
	[9, 8, 1, 0, 3, 2, 5, 4, 7, 6], // 丁为日主
	[6, 7, 8, 9, 0, 1, 2, 3, 4, 5], // 戊为日主
	[7, 6, 9, 8, 1, 0, 3, 2, 5, 4], // 己为日主
	[4, 5, 6, 7, 8, 9, 0, 1, 2, 3], // 庚为日主
	[5, 4, 7, 6, 9, 8, 1, 0, 3, 2], // 辛为日主
	[2, 3, 4, 5, 6, 7, 8, 9, 0, 1], // 壬为日主
	[3, 2, 5, 4, 7, 6, 9, 8, 1, 0], // 癸为日主
];

/// 十神枚举数组（用于索引转换）
pub const SHISHEN_ARRAY: [ShiShen; 10] = [
	ShiShen::BiJian,      // 0
	ShiShen::JieCai,      // 1
	ShiShen::ShiShen,     // 2
	ShiShen::ShangGuan,   // 3
	ShiShen::PianCai,     // 4
	ShiShen::ZhengCai,    // 5
	ShiShen::QiSha,       // 6
	ShiShen::ZhengGuan,   // 7
	ShiShen::PianYin,     // 8
	ShiShen::ZhengYin,    // 9
];

// ================================
// 节气近似日期表
// ================================

/// 节气近似日期表（简化版）
///
/// 格式：[节气对应的公历月份, 近似日期]
///
/// ⚠️ 注意：这是简化版实现，精度为±1天
/// 生产环境建议使用寿星天文算法进行精确计算
pub const JIEQI_APPROX_DATES: [(u8, u8); 12] = [
	(1, 6),   // 小寒: 1月6日左右
	(2, 4),   // 立春: 2月4日左右
	(3, 6),   // 惊蛰: 3月6日左右
	(4, 5),   // 清明: 4月5日左右
	(5, 6),   // 立夏: 5月6日左右
	(6, 6),   // 芒种: 6月6日左右
	(7, 7),   // 小暑: 7月7日左右
	(8, 8),   // 立秋: 8月8日左右
	(9, 8),   // 白露: 9月8日左右
	(10, 8),  // 寒露: 10月8日左右
	(11, 7),  // 立冬: 11月7日左右
	(12, 7),  // 大雪: 12月7日左右
];

// ================================
// 月令权重矩阵（高级版）
// ================================

/// 月令旺衰权重矩阵 (12月×36位置)
///
/// 参考 BaziGo 的 dizhiqiangdulist 实现
///
/// 格式：HIDDEN_STEM_WEIGHT[月支][地支*3 + 藏干序号]
///
/// 例如：
/// - 子月，子藏癸的权重：HIDDEN_STEM_WEIGHT[0][0*3+0] = 1000
/// - 子月，丑藏己的权重：HIDDEN_STEM_WEIGHT[0][1*3+0] = 530
///
/// ⚠️ 这是简化版实现，生产环境需要专业命理师验证
pub const HIDDEN_STEM_WEIGHT: [[u16; 36]; 12] = [
	// 子月(冬季水旺)
	[
		1000, 0, 0,      // 子: 癸(1000)
		530, 300, 200,   // 丑: 己(530) 癸(300) 辛(200)
		798, 360, 0,     // 寅: 甲(798) 丙(360) 戊(0)
		1158, 0, 0,      // 卯: 乙(1158)
		530, 300, 200,   // 辰: 戊(530) 乙(300) 癸(200)
		530, 300, 200,   // 巳: 丙(530) 庚(300) 戊(200)
		530, 300, 0,     // 午: 丁(530) 己(300)
		800, 300, 200,   // 未: 己(800) 丁(300) 乙(200)
		800, 400, 200,   // 申: 庚(800) 壬(400) 戊(200)
		1000, 0, 0,      // 酉: 辛(1000)
		800, 300, 200,   // 戌: 戊(800) 辛(300) 丁(200)
		1000, 400, 0,    // 亥: 壬(1000) 甲(400)
	],
	// TODO: 其他11个月的权重表（这里先用简化数据，后续需要补充完整）
	// 为了演示，暂时复制子月数据
	// 生产环境需要根据BaziGo的完整权重表填充
	[1000, 0, 0, 530, 300, 200, 798, 360, 0, 1158, 0, 0, 530, 300, 200, 530, 300, 200, 530, 300, 0, 800, 300, 200, 800, 400, 200, 1000, 0, 0, 800, 300, 200, 1000, 400, 0],
	[1000, 0, 0, 530, 300, 200, 798, 360, 0, 1158, 0, 0, 530, 300, 200, 530, 300, 200, 530, 300, 0, 800, 300, 200, 800, 400, 200, 1000, 0, 0, 800, 300, 200, 1000, 400, 0],
	[1000, 0, 0, 530, 300, 200, 798, 360, 0, 1158, 0, 0, 530, 300, 200, 530, 300, 200, 530, 300, 0, 800, 300, 200, 800, 400, 200, 1000, 0, 0, 800, 300, 200, 1000, 400, 0],
	[1000, 0, 0, 530, 300, 200, 798, 360, 0, 1158, 0, 0, 530, 300, 200, 530, 300, 200, 530, 300, 0, 800, 300, 200, 800, 400, 200, 1000, 0, 0, 800, 300, 200, 1000, 400, 0],
	[1000, 0, 0, 530, 300, 200, 798, 360, 0, 1158, 0, 0, 530, 300, 200, 530, 300, 200, 530, 300, 0, 800, 300, 200, 800, 400, 200, 1000, 0, 0, 800, 300, 200, 1000, 400, 0],
	[1000, 0, 0, 530, 300, 200, 798, 360, 0, 1158, 0, 0, 530, 300, 200, 530, 300, 200, 530, 300, 0, 800, 300, 200, 800, 400, 200, 1000, 0, 0, 800, 300, 200, 1000, 400, 0],
	[1000, 0, 0, 530, 300, 200, 798, 360, 0, 1158, 0, 0, 530, 300, 200, 530, 300, 200, 530, 300, 0, 800, 300, 200, 800, 400, 200, 1000, 0, 0, 800, 300, 200, 1000, 400, 0],
	[1000, 0, 0, 530, 300, 200, 798, 360, 0, 1158, 0, 0, 530, 300, 200, 530, 300, 200, 530, 300, 0, 800, 300, 200, 800, 400, 200, 1000, 0, 0, 800, 300, 200, 1000, 400, 0],
	[1000, 0, 0, 530, 300, 200, 798, 360, 0, 1158, 0, 0, 530, 300, 200, 530, 300, 200, 530, 300, 0, 800, 300, 200, 800, 400, 200, 1000, 0, 0, 800, 300, 200, 1000, 400, 0],
	[1000, 0, 0, 530, 300, 200, 798, 360, 0, 1158, 0, 0, 530, 300, 200, 530, 300, 200, 530, 300, 0, 800, 300, 200, 800, 400, 200, 1000, 0, 0, 800, 300, 200, 1000, 400, 0],
	[1000, 0, 0, 530, 300, 200, 798, 360, 0, 1158, 0, 0, 530, 300, 200, 530, 300, 200, 530, 300, 0, 800, 300, 200, 800, 400, 200, 1000, 0, 0, 800, 300, 200, 1000, 400, 0],
];

// ================================
// 辅助函数
// ================================

/// 获取指定地支的藏干列表
///
/// 返回：[(天干, 藏干类型, 权重), ...]
pub fn get_hidden_stems(dizhi: DiZhi) -> [(TianGan, CangGanType, u16); 3] {
	let stems = EARTHLY_HIDDEN_STEMS[dizhi.0 as usize];
	let types = CANGGAN_TYPE_TABLE[dizhi.0 as usize];
	let weights = CANGGAN_BASE_WEIGHT[dizhi.0 as usize];

	[
		(TianGan(stems[0]), types[0], weights[0]),
		(TianGan(stems[1]), types[1], weights[1]),
		(TianGan(stems[2]), types[2], weights[2]),
	]
}

/// 计算纳音
///
/// 参考 lunisolar 的算法实现
pub fn calculate_nayin(ganzhi: &GanZhi) -> NaYin {
	let index = (ganzhi.to_index() / 2) as usize;
	NAYIN_TABLE[index]
}

/// 计算十神
///
/// 查表法，快速准确
pub fn calculate_shishen(rizhu: TianGan, other_gan: TianGan) -> ShiShen {
	let index = SHISHEN_TABLE[rizhu.0 as usize][other_gan.0 as usize];
	SHISHEN_ARRAY[index as usize]
}

#[cfg(test)]
mod tests {
	use super::*;

	#[test]
	fn test_chen_hidden_stems() {
		// ⚠️ 关键测试：确保辰藏干为"戊乙癸"
		let chen = DiZhi(4); // 辰
		let stems = get_hidden_stems(chen);

		assert_eq!(stems[0].0 .0, 4); // 戊
		assert_eq!(stems[1].0 .0, 1); // 乙
		assert_eq!(stems[2].0 .0, 9); // 癸 (不是壬！)
	}

	#[test]
	fn test_nayin_calculation() {
		// 测试纳音计算
		let jiazi = GanZhi::from_index(0).unwrap(); // 甲子
		let nayin = calculate_nayin(&jiazi);
		assert_eq!(nayin, NaYin::HaiZhongJin); // 海中金
	}

	#[test]
	fn test_shishen_calculation() {
		// 测试十神计算：甲木日主见丙火 → 食神
		let rizhu = TianGan(0); // 甲
		let other = TianGan(2); // 丙
		let shishen = calculate_shishen(rizhu, other);
		assert_eq!(shishen, ShiShen::ShiShen); // 食神
	}
}
