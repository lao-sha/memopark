# 统一隐私授权模块设计

> 文档版本：1.0
> 创建日期：2025-12-24
> 状态：设计中

## 1. 设计背景

### 1.1 当前问题

目前 V6 加密机制**仅在 `pallet-bazi` 中实现**，存在以下问题：

| 问题 | 说明 |
|------|------|
| 功能孤岛 | 其他占卜模块（梅花、六爻、奇门、紫微）无法使用加密功能 |
| 代码重复 | 如果各模块各自实现，会有大量重复代码 |
| 标准不一 | 各模块可能使用不同的加密方案和授权逻辑 |
| 集成困难 | 悬赏系统需要与多个模块分别集成 |

### 1.2 需求分析

所有占卜模块都需要：

1. **加密存储**：敏感数据（出生时间、起卦时间、问事内容等）可选加密
2. **非加密存储**：公开数据，任何人可见
3. **授权机制**：所有者可授权大师、AI、家人访问加密数据
4. **悬赏集成**：创建悬赏时自动/手动处理授权

---

## 2. 架构决策

### 2.1 方案对比

| 方案 | 描述 | 优点 | 缺点 |
|------|------|------|------|
| **A: 独立 Pallet** | 创建 `pallet-divination-privacy` | 统一管理、易于集成、可扩展 | 需要重构现有代码 |
| B: 各模块独立 | 每个占卜模块自己实现 | 模块独立 | 代码重复、标准不一 |
| C: 公共库 | 创建共享 crate | 共享逻辑 | 授权仍分散 |

### 2.2 推荐方案

**采用方案 A：创建独立的 `pallet-divination-privacy` 模块**

理由：
1. **单一职责**：专门处理隐私和授权，符合设计原则
2. **统一标准**：所有占卜模块使用相同的加密和授权机制
3. **易于集成**：悬赏系统只需与此 Pallet 交互
4. **可扩展**：新增占卜模块时，隐私功能开箱即用

---

## 3. 模块架构

### 3.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        pallet-divination-market                          │
│                         (悬赏问答 & 订单系统)                              │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │ DivinationPrivacy trait
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                       pallet-divination-privacy                          │
│                         (统一隐私授权模块)                                │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────┐    │
│  │ 密钥管理    │ │ 授权管理    │ │ 加密存储    │ │ 服务提供者管理  │    │
│  │ - 公钥注册  │ │ - 授权/撤销 │ │ - 加密数据  │ │ - 命理师注册    │    │
│  │ - 密钥更新  │ │ - 角色/范围 │ │ - 解密凭证  │ │ - AI服务注册    │    │
│  └─────────────┘ └─────────────┘ └─────────────┘ └─────────────────┘    │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │ 提供 trait 接口
                  ┌─────────────────┼─────────────────┐
                  ▼                 ▼                 ▼
         ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
         │ pallet-bazi  │  │pallet-meihua │  │pallet-liuyao │  ...
         │   (八字)     │  │  (梅花易数)   │  │   (六爻)     │
         └──────────────┘  └──────────────┘  └──────────────┘
```

### 3.2 模块职责划分

| 模块 | 职责 | 存储内容 |
|------|------|----------|
| `pallet-divination-privacy` | 隐私授权 | 公钥、授权关系、加密数据、服务提供者 |
| `pallet-bazi` | 八字业务 | 四柱索引、解盘结果（明文部分） |
| `pallet-meihua` | 梅花业务 | 卦象数据、解卦结果（明文部分） |
| `pallet-liuyao` | 六爻业务 | 六爻数据、解卦结果（明文部分） |
| `pallet-qimen` | 奇门业务 | 奇门盘数据（明文部分） |
| `pallet-ziwei` | 紫微业务 | 紫微盘数据（明文部分） |
| `pallet-divination-market` | 悬赏订单 | 悬赏、订单、评价 |

---

## 4. 数据模型设计

### 4.1 核心枚举

```rust
/// 占卜类型（与 divination-common 共享）
#[derive(Clone, Copy, Encode, Decode, TypeInfo, MaxEncodedLen, PartialEq, Eq)]
pub enum DivinationType {
    Meihua = 0,    // 梅花易数
    Bazi = 1,      // 八字命理
    Liuyao = 2,    // 六爻占卜
    Qimen = 3,     // 奇门遁甲
    Ziwei = 4,     // 紫微斗数
}

/// 授权角色
#[derive(Clone, Copy, Encode, Decode, TypeInfo, MaxEncodedLen, PartialEq, Eq)]
pub enum AccessRole {
    Owner = 0,          // 所有者（不可撤销）
    Master = 1,         // 命理师
    Family = 2,         // 家族成员
    AiService = 3,      // AI 服务
    BountyAnswerer = 4, // 悬赏回答者（临时）
}

/// 访问范围
#[derive(Clone, Copy, Encode, Decode, TypeInfo, MaxEncodedLen, PartialEq, Eq)]
pub enum AccessScope {
    ReadOnly = 0,    // 只读
    CanComment = 1,  // 可评论
    FullAccess = 2,  // 完全访问
}

/// 服务提供者类型
#[derive(Clone, Copy, Encode, Decode, TypeInfo, MaxEncodedLen, PartialEq, Eq)]
pub enum ServiceProviderType {
    MingLiShi = 0,    // 命理师
    AiService = 1,    // AI 服务
    FamilyMember = 2, // 家族成员
    Research = 3,     // 研究机构
}

/// 隐私模式
#[derive(Clone, Copy, Encode, Decode, TypeInfo, MaxEncodedLen, PartialEq, Eq, Default)]
pub enum PrivacyMode {
    #[default]
    Public = 0,      // 公开 - 所有人可见
    Private = 1,     // 私密 - 仅所有者可见
    Authorized = 2,  // 授权 - 被授权者可见
}
```

### 4.2 核心数据结构

```rust
/// 加密数据记录（通用）
///
/// 适用于所有占卜类型的敏感数据加密存储
#[derive(Clone, Encode, Decode, TypeInfo, MaxEncodedLen)]
pub struct EncryptedRecord<T: Config> {
    /// 占卜类型
    pub divination_type: DivinationType,

    /// 原始结果 ID（在对应占卜模块中的 ID）
    pub result_id: u64,

    /// 所有者
    pub owner: T::AccountId,

    /// 隐私模式
    pub privacy_mode: PrivacyMode,

    /// 加密的敏感数据（AES-256-GCM 加密）
    pub encrypted_data: BoundedVec<u8, ConstU32<512>>,

    /// 加密随机数（24 字节）
    pub nonce: [u8; 24],

    /// 认证标签（16 字节）
    pub auth_tag: [u8; 16],

    /// 数据哈希（用于验证完整性）
    pub data_hash: [u8; 32],

    /// 创建区块
    pub created_at: BlockNumberFor<T>,

    /// 更新区块
    pub updated_at: BlockNumberFor<T>,
}

/// 授权条目
#[derive(Clone, Encode, Decode, TypeInfo, MaxEncodedLen)]
pub struct AuthorizationEntry<T: Config> {
    /// 被授权账户
    pub grantee: T::AccountId,

    /// 加密的 DataKey（用被授权者公钥封装）
    pub encrypted_key: BoundedVec<u8, ConstU32<128>>,

    /// 授权角色
    pub role: AccessRole,

    /// 访问范围
    pub scope: AccessScope,

    /// 授权时间
    pub granted_at: BlockNumberFor<T>,

    /// 过期时间（0 表示永久）
    pub expires_at: BlockNumberFor<T>,

    /// 关联的悬赏 ID（如果是悬赏授权）
    pub bounty_id: Option<u64>,
}

/// 服务提供者信息
#[derive(Clone, Encode, Decode, TypeInfo, MaxEncodedLen)]
pub struct ServiceProvider<T: Config> {
    /// 提供者类型
    pub provider_type: ServiceProviderType,

    /// X25519 公钥（32 字节）
    pub public_key: [u8; 32],

    /// 信誉分（0-100）
    pub reputation: u8,

    /// 是否活跃
    pub is_active: bool,

    /// 注册时间
    pub registered_at: BlockNumberFor<T>,

    /// 完成服务数
    pub completed_services: u32,
}

/// 用户加密密钥信息
#[derive(Clone, Encode, Decode, TypeInfo, MaxEncodedLen)]
pub struct UserEncryptionInfo<T: Config> {
    /// X25519 公钥（32 字节）
    pub public_key: [u8; 32],

    /// 注册时间
    pub registered_at: BlockNumberFor<T>,

    /// 更新时间
    pub updated_at: BlockNumberFor<T>,
}
```

### 4.3 复合键设计

为了高效查询，使用复合键：

```rust
/// 加密记录唯一标识
/// (DivinationType, result_id) -> EncryptedRecord
pub type RecordKey = (DivinationType, u64);

/// 授权关系索引
/// (DivinationType, result_id, grantee) -> AuthorizationEntry
pub type AuthKey = (DivinationType, u64, AccountId);
```

---

## 5. 存储设计

```rust
// ==================== 用户密钥管理 ====================

/// 用户加密公钥
/// AccountId -> UserEncryptionInfo
#[pallet::storage]
pub type UserEncryptionKeys<T: Config> =
    StorageMap<_, Blake2_128Concat, T::AccountId, UserEncryptionInfo<T>>;

// ==================== 服务提供者管理 ====================

/// 服务提供者信息
/// AccountId -> ServiceProvider
#[pallet::storage]
pub type ServiceProviders<T: Config> =
    StorageMap<_, Blake2_128Concat, T::AccountId, ServiceProvider<T>>;

/// 按类型索引服务提供者
/// ServiceProviderType -> Vec<AccountId>
#[pallet::storage]
pub type ProvidersByType<T: Config> =
    StorageMap<_, Blake2_128Concat, ServiceProviderType, BoundedVec<T::AccountId, ConstU32<1000>>>;

// ==================== 加密数据存储 ====================

/// 加密记录存储（通用）
/// (DivinationType, result_id) -> EncryptedRecord
#[pallet::storage]
pub type EncryptedRecords<T: Config> = StorageDoubleMap<
    _,
    Blake2_128Concat, DivinationType,
    Blake2_128Concat, u64,
    EncryptedRecord<T>,
>;

/// 用户的加密记录索引
/// (AccountId, DivinationType) -> Vec<result_id>
#[pallet::storage]
pub type UserEncryptedRecords<T: Config> = StorageDoubleMap<
    _,
    Blake2_128Concat, T::AccountId,
    Blake2_128Concat, DivinationType,
    BoundedVec<u64, ConstU32<1000>>,
    ValueQuery,
>;

// ==================== 授权管理 ====================

/// 授权关系存储
/// (DivinationType, result_id, grantee) -> AuthorizationEntry
#[pallet::storage]
pub type Authorizations<T: Config> = StorageNMap<
    _,
    (
        NMapKey<Blake2_128Concat, DivinationType>,
        NMapKey<Blake2_128Concat, u64>,
        NMapKey<Blake2_128Concat, T::AccountId>,
    ),
    AuthorizationEntry<T>,
>;

/// 记录的授权列表索引
/// (DivinationType, result_id) -> Vec<grantee>
#[pallet::storage]
pub type RecordGrantees<T: Config> = StorageDoubleMap<
    _,
    Blake2_128Concat, DivinationType,
    Blake2_128Concat, u64,
    BoundedVec<T::AccountId, ConstU32<20>>,
    ValueQuery,
>;

/// 提供者被授权的记录索引（反向索引）
/// AccountId -> Vec<(DivinationType, result_id)>
#[pallet::storage]
pub type ProviderGrants<T: Config> =
    StorageMap<_, Blake2_128Concat, T::AccountId, BoundedVec<RecordKey, ConstU32<500>>, ValueQuery>;

// ==================== 悬赏授权关联 ====================

/// 悬赏的授权记录
/// bounty_id -> Vec<(DivinationType, result_id, grantee)>
#[pallet::storage]
pub type BountyAuthorizations<T: Config> =
    StorageMap<_, Blake2_128Concat, u64, BoundedVec<(DivinationType, u64, T::AccountId), ConstU32<100>>, ValueQuery>;
```

---

## 6. 交易接口设计

### 6.1 密钥管理

```rust
/// 注册用户加密公钥
#[pallet::call_index(0)]
pub fn register_encryption_key(
    origin: OriginFor<T>,
    public_key: [u8; 32],
) -> DispatchResult;

/// 更新用户加密公钥
#[pallet::call_index(1)]
pub fn update_encryption_key(
    origin: OriginFor<T>,
    new_public_key: [u8; 32],
) -> DispatchResult;
```

### 6.2 服务提供者管理

```rust
/// 注册为服务提供者
#[pallet::call_index(10)]
pub fn register_provider(
    origin: OriginFor<T>,
    provider_type: ServiceProviderType,
    public_key: [u8; 32],
) -> DispatchResult;

/// 更新提供者公钥
#[pallet::call_index(11)]
pub fn update_provider_key(
    origin: OriginFor<T>,
    new_public_key: [u8; 32],
) -> DispatchResult;

/// 设置提供者活跃状态
#[pallet::call_index(12)]
pub fn set_provider_active(
    origin: OriginFor<T>,
    is_active: bool,
) -> DispatchResult;

/// 注销服务提供者
#[pallet::call_index(13)]
pub fn unregister_provider(
    origin: OriginFor<T>,
) -> DispatchResult;
```

### 6.3 加密数据管理

```rust
/// 创建加密记录
///
/// 由各占卜模块在创建结果时调用（通过 trait）
#[pallet::call_index(20)]
pub fn create_encrypted_record(
    origin: OriginFor<T>,
    divination_type: DivinationType,
    result_id: u64,
    privacy_mode: PrivacyMode,
    encrypted_data: Vec<u8>,
    nonce: [u8; 24],
    auth_tag: [u8; 16],
    data_hash: [u8; 32],
    // 所有者的加密 DataKey
    owner_encrypted_key: Vec<u8>,
) -> DispatchResult;

/// 更新加密记录
#[pallet::call_index(21)]
pub fn update_encrypted_record(
    origin: OriginFor<T>,
    divination_type: DivinationType,
    result_id: u64,
    encrypted_data: Vec<u8>,
    nonce: [u8; 24],
    auth_tag: [u8; 16],
    data_hash: [u8; 32],
) -> DispatchResult;

/// 更改隐私模式
#[pallet::call_index(22)]
pub fn change_privacy_mode(
    origin: OriginFor<T>,
    divination_type: DivinationType,
    result_id: u64,
    new_mode: PrivacyMode,
) -> DispatchResult;

/// 删除加密记录
#[pallet::call_index(23)]
pub fn delete_encrypted_record(
    origin: OriginFor<T>,
    divination_type: DivinationType,
    result_id: u64,
) -> DispatchResult;
```

### 6.4 授权管理

```rust
/// 授权访问
#[pallet::call_index(30)]
pub fn grant_access(
    origin: OriginFor<T>,
    divination_type: DivinationType,
    result_id: u64,
    grantee: T::AccountId,
    encrypted_key: Vec<u8>,  // 用 grantee 公钥封装的 DataKey
    role: AccessRole,
    scope: AccessScope,
    expires_at: BlockNumberFor<T>,  // 0 表示永久
) -> DispatchResult;

/// 撤销授权
#[pallet::call_index(31)]
pub fn revoke_access(
    origin: OriginFor<T>,
    divination_type: DivinationType,
    result_id: u64,
    grantee: T::AccountId,
) -> DispatchResult;

/// 撤销所有授权
#[pallet::call_index(32)]
pub fn revoke_all_access(
    origin: OriginFor<T>,
    divination_type: DivinationType,
    result_id: u64,
) -> DispatchResult;

/// 更新授权范围
#[pallet::call_index(33)]
pub fn update_access_scope(
    origin: OriginFor<T>,
    divination_type: DivinationType,
    result_id: u64,
    grantee: T::AccountId,
    new_scope: AccessScope,
) -> DispatchResult;
```

### 6.5 悬赏授权集成

```rust
/// 为悬赏创建批量授权（发布悬赏时调用）
///
/// 预授权所有潜在回答者访问加密数据
#[pallet::call_index(40)]
pub fn create_bounty_authorization(
    origin: OriginFor<T>,
    bounty_id: u64,
    divination_type: DivinationType,
    result_id: u64,
    // 预授权的回答者列表（可选）
    pre_authorized: Option<Vec<T::AccountId>>,
    // 授权过期时间
    expires_at: BlockNumberFor<T>,
) -> DispatchResult;

/// 为悬赏回答者添加授权
///
/// 大师接单时，系统自动调用或用户手动调用
#[pallet::call_index(41)]
pub fn authorize_bounty_answerer(
    origin: OriginFor<T>,
    bounty_id: u64,
    answerer: T::AccountId,
    encrypted_key: Vec<u8>,
) -> DispatchResult;

/// 悬赏结束时撤销所有临时授权
#[pallet::call_index(42)]
pub fn revoke_bounty_authorizations(
    origin: OriginFor<T>,
    bounty_id: u64,
) -> DispatchResult;
```

---

## 7. Trait 接口设计

### 7.1 供各占卜模块使用的 Trait

```rust
/// 隐私管理 Trait
///
/// 各占卜模块通过此 trait 与隐私模块交互
pub trait DivinationPrivacy<AccountId, BlockNumber> {
    /// 检查记录是否为加密存储
    fn is_encrypted(
        divination_type: DivinationType,
        result_id: u64,
    ) -> bool;

    /// 获取记录的隐私模式
    fn get_privacy_mode(
        divination_type: DivinationType,
        result_id: u64,
    ) -> Option<PrivacyMode>;

    /// 检查账户是否有访问权限
    fn has_access(
        divination_type: DivinationType,
        result_id: u64,
        account: &AccountId,
    ) -> bool;

    /// 获取账户的访问角色
    fn get_access_role(
        divination_type: DivinationType,
        result_id: u64,
        account: &AccountId,
    ) -> Option<AccessRole>;

    /// 获取记录的所有授权账户
    fn get_grantees(
        divination_type: DivinationType,
        result_id: u64,
    ) -> Vec<AccountId>;

    /// 获取用户的加密公钥
    fn get_user_public_key(account: &AccountId) -> Option<[u8; 32]>;

    /// 获取服务提供者信息
    fn get_provider_info(account: &AccountId) -> Option<ServiceProviderType>;
}
```

### 7.2 供悬赏系统使用的 Trait

```rust
/// 悬赏授权 Trait
///
/// 悬赏系统通过此 trait 管理授权
pub trait BountyPrivacy<AccountId, BlockNumber> {
    /// 检查悬赏关联的结果是否加密
    fn is_bounty_encrypted(
        divination_type: DivinationType,
        result_id: u64,
    ) -> bool;

    /// 检查回答者是否有权限访问
    fn can_answer_bounty(
        divination_type: DivinationType,
        result_id: u64,
        answerer: &AccountId,
    ) -> bool;

    /// 获取悬赏的授权列表
    fn get_bounty_authorizations(bounty_id: u64) -> Vec<AccountId>;

    /// 悬赏需要授权时的提示信息
    fn bounty_requires_authorization(
        divination_type: DivinationType,
        result_id: u64,
    ) -> bool;
}
```

---

## 8. 事件定义

```rust
#[pallet::event]
#[pallet::generate_deposit(pub(super) fn deposit_event)]
pub enum Event<T: Config> {
    // ========== 密钥管理 ==========

    /// 用户注册了加密公钥
    EncryptionKeyRegistered {
        account: T::AccountId,
        public_key: [u8; 32],
    },

    /// 用户更新了加密公钥
    EncryptionKeyUpdated {
        account: T::AccountId,
        old_key: [u8; 32],
        new_key: [u8; 32],
    },

    // ========== 服务提供者 ==========

    /// 服务提供者注册
    ProviderRegistered {
        account: T::AccountId,
        provider_type: ServiceProviderType,
    },

    /// 服务提供者注销
    ProviderUnregistered {
        account: T::AccountId,
    },

    /// 提供者状态变更
    ProviderStatusChanged {
        account: T::AccountId,
        is_active: bool,
    },

    // ========== 加密记录 ==========

    /// 创建加密记录
    EncryptedRecordCreated {
        divination_type: DivinationType,
        result_id: u64,
        owner: T::AccountId,
        privacy_mode: PrivacyMode,
    },

    /// 隐私模式变更
    PrivacyModeChanged {
        divination_type: DivinationType,
        result_id: u64,
        old_mode: PrivacyMode,
        new_mode: PrivacyMode,
    },

    /// 删除加密记录
    EncryptedRecordDeleted {
        divination_type: DivinationType,
        result_id: u64,
    },

    // ========== 授权管理 ==========

    /// 授权访问
    AccessGranted {
        divination_type: DivinationType,
        result_id: u64,
        grantee: T::AccountId,
        role: AccessRole,
        scope: AccessScope,
        expires_at: BlockNumberFor<T>,
    },

    /// 撤销授权
    AccessRevoked {
        divination_type: DivinationType,
        result_id: u64,
        grantee: T::AccountId,
    },

    /// 撤销所有授权
    AllAccessRevoked {
        divination_type: DivinationType,
        result_id: u64,
        count: u32,
    },

    // ========== 悬赏授权 ==========

    /// 创建悬赏授权
    BountyAuthorizationCreated {
        bounty_id: u64,
        divination_type: DivinationType,
        result_id: u64,
    },

    /// 悬赏回答者获得授权
    BountyAnswererAuthorized {
        bounty_id: u64,
        answerer: T::AccountId,
    },

    /// 悬赏授权撤销
    BountyAuthorizationsRevoked {
        bounty_id: u64,
        count: u32,
    },
}
```

---

## 9. Runtime API

```rust
decl_runtime_apis! {
    pub trait DivinationPrivacyApi<AccountId, BlockNumber> {
        // ========== 查询接口 ==========

        /// 获取用户加密公钥
        fn get_user_encryption_key(account: AccountId) -> Option<[u8; 32]>;

        /// 获取服务提供者信息
        fn get_service_provider(account: AccountId) -> Option<ServiceProviderInfo>;

        /// 按类型获取服务提供者列表
        fn get_providers_by_type(provider_type: u8) -> Vec<AccountId>;

        /// 获取加密记录信息
        fn get_encrypted_record_info(
            divination_type: u8,
            result_id: u64,
        ) -> Option<EncryptedRecordInfo>;

        /// 检查是否有访问权限
        fn has_access(
            divination_type: u8,
            result_id: u64,
            account: AccountId,
        ) -> bool;

        /// 获取授权列表
        fn get_authorizations(
            divination_type: u8,
            result_id: u64,
        ) -> Vec<AuthorizationInfo>;

        /// 获取提供者被授权的记录
        fn get_provider_grants(account: AccountId) -> Vec<(u8, u64)>;

        /// 获取悬赏授权状态
        fn get_bounty_authorization_status(bounty_id: u64) -> BountyAuthorizationStatus;
    }
}
```

---

## 10. 与现有模块的集成

### 10.1 八字模块集成

**迁移步骤**：

1. **保留明文数据**：`SiZhuIndex`、`Gender`、解盘结果继续存储在 `pallet-bazi`
2. **移除 V6 加密功能**：删除 `pallet-bazi` 中的 V6 相关存储和交易
3. **添加 trait 依赖**：`pallet-bazi` 配置中添加 `type Privacy: DivinationPrivacy<...>`
4. **创建时调用**：创建八字时，如果选择加密，调用 Privacy Pallet

```rust
// pallet-bazi 配置
#[pallet::config]
pub trait Config: frame_system::Config {
    // ... 其他配置 ...

    /// 隐私模块
    type Privacy: DivinationPrivacy<Self::AccountId, BlockNumberFor<Self>>;
}

// 创建八字时
impl<T: Config> Pallet<T> {
    fn create_bazi_chart_with_privacy(
        who: &T::AccountId,
        sizhu_index: SiZhuIndex,
        gender: Gender,
        privacy_mode: PrivacyMode,
        encrypted_data: Option<Vec<u8>>,
        // ... 其他加密参数 ...
    ) -> Result<u64, DispatchError> {
        // 1. 创建明文记录
        let chart_id = Self::create_chart_internal(who, sizhu_index, gender)?;

        // 2. 如果需要加密，调用隐私模块
        if privacy_mode != PrivacyMode::Public {
            T::Privacy::create_encrypted_record(
                DivinationType::Bazi,
                chart_id,
                privacy_mode,
                encrypted_data.unwrap(),
                // ...
            )?;
        }

        Ok(chart_id)
    }
}
```

### 10.2 悬赏系统集成

```rust
// pallet-divination-market 配置
#[pallet::config]
pub trait Config: frame_system::Config {
    // ... 其他配置 ...

    /// 隐私模块
    type Privacy: BountyPrivacy<Self::AccountId, BlockNumberFor<Self>>;
}

// 创建悬赏时检查
fn create_bounty(...) -> DispatchResult {
    // ...

    // 检查是否需要授权
    let requires_auth = T::Privacy::bounty_requires_authorization(
        divination_type,
        result_id,
    );

    if requires_auth {
        // 记录悬赏需要授权
        BountyRequiresAuth::<T>::insert(bounty_id, true);

        // 触发事件提醒用户
        Self::deposit_event(Event::BountyRequiresAuthorization {
            bounty_id,
            divination_type,
            result_id,
        });
    }

    // ...
}

// 提交回答时检查（可选）
fn submit_bounty_answer(...) -> DispatchResult {
    // ...

    // 检查是否有权限（软检查，不强制阻止）
    let has_access = T::Privacy::can_answer_bounty(
        bounty.divination_type,
        bounty.result_id,
        &who,
    );

    if !has_access {
        // 触发警告事件，但不阻止
        Self::deposit_event(Event::AnswererLacksAuthorization {
            bounty_id,
            answerer: who.clone(),
        });
    }

    // ...
}
```

---

## 11. 目录结构

```
pallets/divination/
├── privacy/                          # 新增：统一隐私授权模块
│   ├── Cargo.toml
│   ├── README.md
│   ├── src/
│   │   ├── lib.rs                    # Pallet 主文件
│   │   ├── types.rs                  # 类型定义
│   │   ├── traits.rs                 # Trait 定义
│   │   ├── weights.rs                # 权重
│   │   ├── runtime_api.rs            # Runtime API
│   │   └── tests.rs                  # 测试
│   └── docs/
│       └── README.md
├── common/                           # 已有：公共定义
├── market/                           # 已有：悬赏订单
├── bazi/                             # 已有：八字（移除 V6）
├── meihua/                           # 已有：梅花
├── liuyao/                           # 已有：六爻
├── qimen/                            # 已有：奇门
└── ziwei/                            # 已有：紫微
```

---

## 12. 实施计划

### 阶段 1：创建基础模块（1-2 周）

- [ ] 创建 `pallet-divination-privacy` 基础结构
- [ ] 实现密钥管理功能
- [ ] 实现服务提供者管理
- [ ] 编写单元测试

### 阶段 2：实现核心功能（1-2 周）

- [ ] 实现加密记录存储
- [ ] 实现授权管理
- [ ] 实现 Trait 接口
- [ ] 实现 Runtime API

### 阶段 3：迁移八字模块（1 周）

- [ ] 从 `pallet-bazi` 迁移 V6 功能
- [ ] 更新 `pallet-bazi` 集成新模块
- [ ] 数据迁移（如有）
- [ ] 更新前端

### 阶段 4：悬赏系统集成（1 周）

- [ ] 修改 `pallet-divination-market` 集成
- [ ] 实现悬赏授权流程
- [ ] 更新前端悬赏组件

### 阶段 5：其他模块集成（2 周）

- [ ] 梅花模块集成
- [ ] 六爻模块集成
- [ ] 奇门模块集成
- [ ] 紫微模块集成

### 阶段 6：测试与文档（1 周）

- [ ] 集成测试
- [ ] 性能测试
- [ ] 完善文档
- [ ] 前端完整集成

---

## 13. 总结

### 13.1 方案优势

1. **统一标准**：所有占卜模块使用相同的隐私和授权机制
2. **代码复用**：避免在各模块中重复实现加密逻辑
3. **易于集成**：悬赏系统只需与一个模块交互
4. **可扩展**：新增占卜模块时，隐私功能开箱即用
5. **职责清晰**：各模块专注于业务逻辑，隐私由专门模块处理

### 13.2 技术要点

1. 使用 Trait 实现模块间解耦
2. 使用复合键优化存储查询
3. 支持灵活的授权角色和范围
4. 与悬赏系统深度集成

### 13.3 后续考虑

1. 链上加密计算（如 MPC、TEE）
2. 零知识证明验证
3. 跨链授权
