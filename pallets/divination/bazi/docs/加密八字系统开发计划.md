# 加密八字存储与多方授权系统 - 开发计划

## 开发顺序总览

```
Phase 1: 核心 Pallet 功能 (3-4 天)
    ├── 1.1 数据类型定义
    ├── 1.2 用户加密公钥注册
    ├── 1.3 加密命盘创建
    ├── 1.4 授权访问
    └── 1.5 撤销授权

Phase 2: 服务提供者系统 (1-2 天)
    ├── 2.1 提供者注册/注销
    └── 2.2 授权索引

Phase 3: 前端集成 (3-4 天)
    ├── 3.1 加密工具库
    ├── 3.2 创建加密命盘 UI
    └── 3.3 解密和授权管理 UI

Phase 4: Runtime API (1 天)
    └── 查询接口

Phase 5: 测试与优化 (2 天)
    ├── 单元测试
    └── 集成测试
```

---

## Phase 1: 核心 Pallet 功能

### 1.1 定义核心数据类型

**文件**: `src/types.rs` (新增加密相关类型)

```rust
// 待实现的类型
pub enum AccessRole { Owner, Master, Family, AiService }
pub enum AccessScope { ReadOnly, CanComment, FullAccess }
pub struct EncryptedKeyEntry<AccountId> { ... }
pub struct EncryptedBaziChart<T: Config> { ... }
```

**依赖**: 无
**预计时间**: 0.5 天

---

### 1.2 用户加密公钥注册

**新增存储**:
```rust
pub type UserEncryptionKeys<T> = StorageMap<_, Blake2_128Concat, T::AccountId, [u8; 32]>;
```

**新增交易**:
```rust
#[pallet::call_index(40)]
pub fn register_encryption_key(origin, public_key: [u8; 32]) -> DispatchResult;

#[pallet::call_index(41)]
pub fn update_encryption_key(origin, new_public_key: [u8; 32]) -> DispatchResult;
```

**关键验证**:
- 公钥长度必须是 32 bytes
- 同一账户只能注册一个公钥（可更新）

**依赖**: 1.1
**预计时间**: 0.5 天

---

### 1.3 加密命盘创建

**新增存储**:
```rust
pub type EncryptedChartById<T> = StorageMap<_, Blake2_128Concat, u64, EncryptedBaziChart<T>>;
pub type UserEncryptedCharts<T> = StorageMap<_, Blake2_128Concat, T::AccountId, BoundedVec<u64, MaxChartsPerAccount>>;
pub type NextEncryptedChartId<T> = StorageValue<_, u64, ValueQuery>;
```

**新增交易**:
```rust
#[pallet::call_index(42)]
pub fn create_encrypted_chart(
    origin,
    sizhu_index: SiZhuIndex,
    gender: Gender,
    encrypted_data: BoundedVec<u8, ConstU32<256>>,
    nonce: [u8; 12],
    auth_tag: [u8; 16],
    encrypted_keys: BoundedVec<EncryptedKeyEntry<T::AccountId>, ConstU32<10>>,
    data_hash: [u8; 32],
) -> DispatchResult;
```

**关键验证**:
- sizhu_index 有效性
- encrypted_keys 必须包含 Owner 且账户匹配调用者
- 调用者必须已注册加密公钥
- 命盘数量不超过限制

**依赖**: 1.1, 1.2
**预计时间**: 1 天

---

### 1.4 授权访问

**新增交易**:
```rust
#[pallet::call_index(43)]
pub fn grant_chart_access(
    origin,
    chart_id: u64,
    grantee: T::AccountId,
    encrypted_key: BoundedVec<u8, ConstU32<64>>,
    role: AccessRole,
    scope: AccessScope,
    duration_blocks: Option<u32>,
) -> DispatchResult;
```

**关键验证**:
- 只有所有者可授权
- 被授权方必须已注册加密公钥（或是注册的服务提供者）
- 授权数量不超过 10 个
- 不能授权给自己
- 不能重复授权

**依赖**: 1.3
**预计时间**: 0.5 天

---

### 1.5 撤销授权

**新增交易**:
```rust
#[pallet::call_index(44)]
pub fn revoke_chart_access(
    origin,
    chart_id: u64,
    revokee: T::AccountId,
) -> DispatchResult;

#[pallet::call_index(45)]
pub fn revoke_all_access(
    origin,
    chart_id: u64,
) -> DispatchResult;
```

**关键验证**:
- 只有所有者可撤销
- 不能撤销 Owner 自己
- 授权必须存在

**依赖**: 1.3
**预计时间**: 0.5 天

---

## Phase 2: 服务提供者系统

### 2.1 提供者注册

**新增存储**:
```rust
pub type Providers<T> = StorageMap<_, Blake2_128Concat, T::AccountId, ServiceProvider<T>>;
```

**新增交易**:
```rust
#[pallet::call_index(46)]
pub fn register_provider(
    origin,
    provider_type: ServiceProviderType,
    public_key: [u8; 32],
) -> DispatchResult;

#[pallet::call_index(47)]
pub fn update_provider_key(origin, new_public_key: [u8; 32]) -> DispatchResult;

#[pallet::call_index(48)]
pub fn deregister_provider(origin) -> DispatchResult;
```

**依赖**: 1.1
**预计时间**: 0.5 天

---

### 2.2 授权索引

**新增存储**:
```rust
pub type ProviderGrants<T> = StorageMap<_, Blake2_128Concat, T::AccountId, BoundedVec<u64, ConstU32<1000>>>;
```

**更新逻辑**:
- `grant_chart_access` 时更新 ProviderGrants
- `revoke_chart_access` 时更新 ProviderGrants
- `revoke_all_access` 时批量更新

**依赖**: 2.1, 1.4, 1.5
**预计时间**: 0.5 天

---

## Phase 3: 前端集成

### 3.1 加密工具库

**文件**: `stardust-dapp/src/services/crypto-utils.ts`

```typescript
// 实现函数
export function deriveX25519FromEd25519(seed: Uint8Array): X25519KeyPair;
export function generateX25519KeyPair(): X25519KeyPair;
export function generateDataKey(): Uint8Array;
export async function encryptWithAES(plaintext: string, key: Uint8Array): Promise<EncryptedData>;
export async function decryptWithAES(ciphertext: Uint8Array, nonce: Uint8Array, tag: Uint8Array, key: Uint8Array): Promise<string>;
export function encryptKeyForRecipient(dataKey: Uint8Array, recipientPublicKey: Uint8Array, senderSecretKey: Uint8Array): Uint8Array;
export function decryptKeyFromSender(encryptedKey: Uint8Array, senderPublicKey: Uint8Array, recipientSecretKey: Uint8Array): Uint8Array | null;
```

**依赖**: Phase 1 完成
**预计时间**: 1 天

---

### 3.2 创建加密命盘 UI

**文件**: `stardust-dapp/src/features/bazi/` 目录下新增组件

**功能**:
1. X25519 密钥对生成/导入界面
2. 加密公钥注册流程
3. 创建加密命盘表单
4. 初始授权方选择

**依赖**: 3.1
**预计时间**: 1.5 天

---

### 3.3 解密和授权管理 UI

**功能**:
1. 查看加密命盘列表
2. 解密并显示命盘详情
3. 授权管理界面（添加/撤销）
4. 服务提供者选择器

**依赖**: 3.1, 3.2
**预计时间**: 1.5 天

---

## Phase 4: Runtime API

**文件**: `src/runtime_api.rs`

```rust
// 新增 API
fn get_encrypted_chart(chart_id: u64) -> Option<EncryptedChartInfo>;
fn get_chart_access_list(chart_id: u64) -> Vec<AccessInfo>;
fn get_user_encryption_key(account: AccountId) -> Option<[u8; 32]>;
fn get_provider_charts(provider: AccountId) -> Vec<u64>;
fn check_chart_access(chart_id: u64, account: AccountId) -> AccessCheckResult;
```

**依赖**: Phase 1, Phase 2
**预计时间**: 1 天

---

## Phase 5: 测试

### 5.1 单元测试

**文件**: `src/tests.rs` 新增测试模块

```rust
mod encrypted_chart_tests {
    #[test]
    fn test_register_encryption_key();
    #[test]
    fn test_create_encrypted_chart();
    #[test]
    fn test_grant_access();
    #[test]
    fn test_revoke_access();
    #[test]
    fn test_access_expiration();
    // ...
}
```

**预计时间**: 1 天

---

### 5.2 集成测试

**测试场景**:
1. 完整流程：注册公钥 → 创建命盘 → 授权 → 解密 → 撤销
2. 边界条件：最大授权数、过期处理
3. 错误场景：无权限、已过期、重复操作

**预计时间**: 1 天

---

## 文件变更清单

### Pallet 文件 (`pallets/divination/bazi/`)

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `src/types.rs` | 修改 | 新增加密相关类型 |
| `src/lib.rs` | 修改 | 新增存储、交易、事件、错误 |
| `src/runtime_api.rs` | 修改 | 新增 Runtime API |
| `src/tests.rs` | 修改 | 新增测试用例 |

### 前端文件 (`stardust-dapp/`)

| 文件 | 变更类型 | 说明 |
|------|----------|------|
| `src/services/crypto-utils.ts` | 新增 | 加密工具库 |
| `src/services/encryptedBaziService.ts` | 新增 | 加密命盘服务 |
| `src/features/bazi/EncryptedChartCreate.tsx` | 新增 | 创建加密命盘页面 |
| `src/features/bazi/EncryptedChartDetail.tsx` | 新增 | 加密命盘详情页面 |
| `src/features/bazi/AccessManagement.tsx` | 新增 | 授权管理组件 |
| `src/types/encrypted-bazi.ts` | 新增 | TypeScript 类型定义 |

---

## 依赖关系图

```
1.1 数据类型
    │
    ├──► 1.2 加密公钥注册
    │       │
    │       └──► 1.3 加密命盘创建
    │               │
    │               ├──► 1.4 授权访问 ──► 2.2 授权索引
    │               │
    │               └──► 1.5 撤销授权 ──► 2.2 授权索引
    │
    └──► 2.1 提供者注册 ──► 2.2 授权索引

Phase 1 + 2 完成
    │
    └──► 3.1 加密工具库
            │
            ├──► 3.2 创建命盘 UI
            │
            └──► 3.3 授权管理 UI

Phase 1-3 完成
    │
    └──► Phase 4 Runtime API
            │
            └──► Phase 5 测试
```

---

## 风险与注意事项

### 密码学风险

| 风险 | 缓解措施 |
|------|----------|
| 使用错误的密钥类型 | 严格区分签名密钥和加密密钥，文档明确说明 |
| 时序攻击 | 使用时间恒定的比较函数 |
| 随机数质量 | 使用 Web Crypto API 的 getRandomValues |

### 实现风险

| 风险 | 缓解措施 |
|------|----------|
| X25519 密钥丢失 | 提供密钥导出/备份功能 |
| 链上存储过大 | 限制授权数量（最多 10 个） |
| 前端加密失败 | 完善错误处理和用户提示 |

### 兼容性风险

| 风险 | 缓解措施 |
|------|----------|
| 现有命盘迁移 | 保留旧版本 API，新旧并存 |
| 浏览器兼容 | 检测 Web Crypto API 支持 |

---

## 开始开发

准备好后，从 **Phase 1.1: 定义核心数据类型** 开始！
