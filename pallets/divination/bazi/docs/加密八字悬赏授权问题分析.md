# 加密八字悬赏授权问题分析

> 文档版本：1.0
> 创建日期：2025-12-24
> 状态：待解决

## 1. 问题概述

### 1.1 问题描述

当发布者创建基于**加密八字**（V6 MultiKeyEncryptedBaziChart）的悬赏问答时，存在授权缺口：

- ✅ 发布者可以基于加密八字创建悬赏
- ✅ 大师可以自由接单
- ❌ **大师无法访问加密的出生时间等敏感信息**
- ❌ 大师只能看到四柱索引（明文）和性别，无法查看完整数据

### 1.2 问题根源

悬赏系统（`pallet-divination-market`）和加密八字系统（`pallet-bazi` V6）之间**没有授权集成**：

1. **创建悬赏时**：没有区分普通八字和加密八字，没有自动授权机制
2. **大师接单时**：没有检查是否有访问权限
3. **前端展示**：没有提示用户授权大师

---

## 2. 当前实现分析

### 2.1 悬赏创建流程

**文件**: `pallets/divination/market/src/lib.rs:2137-2236`

```rust
pub fn create_bounty(
    origin: OriginFor<T>,
    divination_type: DivinationType,
    result_id: u64,                    // 八字命盘 ID
    question_cid: Vec<u8>,
    bounty_amount: BalanceOf<T>,
    ...
) -> DispatchResult {
    let who = ensure_signed(origin)?;

    // ✅ 验证占卜结果存在
    ensure!(
        T::DivinationProvider::result_exists(divination_type, result_id),
        Error::<T>::DivinationResultNotFound
    );

    // ✅ 验证调用者是占卜结果的创建者
    let result_creator = T::DivinationProvider::result_creator(divination_type, result_id)
        .ok_or(Error::<T>::DivinationResultNotFound)?;
    ensure!(result_creator == who, Error::<T>::NotResultCreator);

    // ❌ 问题1: 没有检查是否为加密八字
    // ❌ 问题2: 没有任何授权逻辑

    // ... 创建悬赏 ...
}
```

### 2.2 大师提交回答流程

**文件**: `pallets/divination/market/src/lib.rs:2245-2340`

```rust
pub fn submit_bounty_answer(
    origin: OriginFor<T>,
    bounty_id: u64,
    answer_cid: Vec<u8>,
) -> DispatchResult {
    let who = ensure_signed(origin)?;

    let bounty = BountyQuestions::<T>::get(bounty_id)
        .ok_or(Error::<T>::BountyNotFound)?;

    // ✅ 验证悬赏状态为开放
    ensure!(bounty.status == BountyStatus::Open, Error::<T>::BountyNotOpen);

    // ❌ 问题: 没有检查大师是否有访问加密数据的权限
    // 大师可以接单，但如果是加密八字，无法看到完整数据

    // ... 提交回答 ...
}
```

### 2.3 加密八字存储结构

**文件**: `pallets/divination/bazi/src/types.rs:186-217`

```rust
pub struct MultiKeyEncryptedBaziChart<T: Config> {
    /// 所有者
    pub owner: T::AccountId,

    /// 四柱索引（明文存储 - 用于解盘计算）
    pub sizhu_index: SiZhuIndex,

    /// 性别（明文存储）
    pub gender: Gender,

    /// 加密的敏感数据（出生时间、备注等）
    pub encrypted_data: BoundedVec<u8, ConstU32<256>>,

    /// 加密随机数
    pub nonce: [u8; 24],

    /// 认证标签
    pub auth_tag: [u8; 16],

    /// 多方授权密钥列表
    pub encrypted_keys: BoundedVec<EncryptedKeyEntry<T::AccountId>, ConstU32<10>>,

    /// 数据哈希（用于验证）
    pub data_hash: [u8; 32],

    /// 创建区块
    pub created_at: BlockNumberFor<T>,
}
```

---

## 3. 数据可见性分析

### 3.1 大师可见数据

| 数据项 | 存储方式 | 可见性 | 说明 |
|--------|----------|--------|------|
| 四柱索引 (sizhu_index) | 明文 | ✅ 可见 | 年月日时的干支组合索引 |
| 性别 (gender) | 明文 | ✅ 可见 | 男/女 |
| 链上解盘结果 | 明文 | ✅ 可见 | 通过 Runtime API 获取 |

### 3.2 大师不可见数据（加密）

| 数据项 | 存储方式 | 可见性 | 影响 |
|--------|----------|--------|------|
| 出生年份 | 加密 | ❌ 不可见 | 无法验证四柱计算准确性 |
| 出生月日 | 加密 | ❌ 不可见 | 无法判断交界月 |
| 出生时分 | 加密 | ❌ 不可见 | 无法判断交界时辰 |
| 出生地点 | 加密 | ❌ 不可见 | 无法校正真太阳时 |
| 备注说明 | 加密 | ❌ 不可见 | 丢失用户附加信息 |

### 3.3 对八字解读的影响

虽然**四柱索引**本身包含了命理分析的核心信息（天干地支组合），但精确的出生时间对以下场景非常重要：

1. **交界时辰判断**：子时前后、卯辰交接等需要精确时间
2. **真太阳时校正**：不同经度出生地需要时间校正
3. **大运起运时间**：精确计算需要知道出生日期
4. **流年精确分析**：需要知道具体年龄
5. **用户背景信息**：备注中可能包含重要的咨询背景

---

## 4. 问题流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                        当前问题流程                              │
└─────────────────────────────────────────────────────────────────┘

用户创建加密八字                大师接单回答
     │                              │
     ▼                              ▼
┌──────────────┐              ┌──────────────┐
│ 敏感数据加密  │              │  提交回答    │
│ 只有授权方    │              │  ❌ 无授权检查 │
│ 才能解密      │              │              │
└──────────────┘              └──────────────┘
     │                              │
     ▼                              ▼
┌──────────────┐              ┌──────────────┐
│ 创建悬赏     │              │  解读命盘    │
│ ❌ 无授权检查 │──────────────│  ❌ 看不到    │
│ ❌ 无授权触发 │              │    完整数据   │
└──────────────┘              └──────────────┘

                    ❌ 授权断层
```

---

## 5. 解决方案

### 5.1 方案 A：前端引导 + 手动授权（推荐）

**复杂度**：低
**改动范围**：仅前端

#### 实现方式

1. **创建悬赏时检测**：
   - 前端调用 `getMultiKeyEncryptedChartInfo(resultId)` 检查是否为加密八字
   - 如果是加密八字，显示提醒：
     > "您正在基于加密八字创建悬赏。大师接单后，需要您手动授权才能查看完整的出生信息。"

2. **大师接单后通知**：
   - 创建链上事件监听
   - 有大师接单时，通知发布者："大师 XXX 已接单，请前往授权管理为其开放访问权限"

3. **悬赏详情页优化**：
   - 显示当前已授权的大师列表
   - 提供一键授权入口
   - 显示授权状态标签

#### 优点
- 实现简单，仅需前端改动
- 用户有完全控制权
- 不影响现有 Pallet 逻辑

#### 缺点
- 需要用户手动操作
- 可能忘记授权导致大师无法解读

---

### 5.2 方案 B：悬赏自动授权

**复杂度**：高
**改动范围**：Pallet + 前端

#### 实现方式

1. **新增授权角色**：
   ```rust
   pub enum AccessRole {
       Owner = 0,
       Master = 1,
       Family = 2,
       AiService = 3,
       BountyAnswerer = 4,  // 新增：悬赏回答者
   }
   ```

2. **修改 `create_bounty` 交易**：
   - 检查 `result_id` 是否为加密八字
   - 如果是，要求传入 `owner_sealed_data_key`（用自己私钥解密的 DataKey）
   - 生成悬赏专属授权凭证

3. **修改 `submit_bounty_answer` 交易**：
   - 如果是加密八字悬赏，自动为回答者生成授权
   - 使用悬赏凭证为回答者封装 DataKey

4. **自动撤销**：
   - 悬赏结束后，自动撤销所有 `BountyAnswerer` 授权

#### 优点
- 完全自动化，用户无感知
- 授权与悬赏生命周期绑定

#### 缺点
- 实现复杂，需要跨 Pallet 交互
- 需要修改多个交易的签名
- 安全性需要仔细设计

---

### 5.3 方案 C：悬赏系统集成授权检查

**复杂度**：中
**改动范围**：Pallet + 前端

#### 实现方式

1. **修改 `create_bounty`**：
   ```rust
   pub fn create_bounty(
       origin: OriginFor<T>,
       divination_type: DivinationType,
       result_id: u64,
       question_cid: Vec<u8>,
       bounty_amount: BalanceOf<T>,
       // 新增：预授权列表（可选）
       pre_authorized_accounts: Option<Vec<T::AccountId>>,
       ...
   ) -> DispatchResult {
       // 检查是否为加密八字
       let is_encrypted = Self::is_encrypted_chart(divination_type, result_id);

       if is_encrypted {
           // 记录悬赏需要授权
           BountyRequiresAuth::<T>::insert(bounty_id, true);

           // 如果提供了预授权列表，记录下来
           if let Some(accounts) = pre_authorized_accounts {
               BountyPreAuthorized::<T>::insert(bounty_id, accounts);
           }
       }
       ...
   }
   ```

2. **修改 `submit_bounty_answer`**：
   ```rust
   pub fn submit_bounty_answer(...) -> DispatchResult {
       // 检查是否需要授权
       if BountyRequiresAuth::<T>::get(bounty_id) {
           // 检查回答者是否已被授权
           let is_authorized = Self::check_chart_authorization(
               bounty.result_id,
               &who
           );
           ensure!(is_authorized, Error::<T>::NotAuthorizedToAnswer);
       }
       ...
   }
   ```

3. **新增授权检查接口**：
   - `is_encrypted_chart(divination_type, result_id) -> bool`
   - `check_chart_authorization(chart_id, account) -> bool`

#### 优点
- 在链上强制执行授权检查
- 防止未授权的大师接单

#### 缺点
- 需要跨 Pallet 调用
- 可能限制悬赏的开放性

---

### 5.4 方案 D：混合方案（推荐生产使用）

**复杂度**：中
**改动范围**：Pallet + 前端

#### 实现方式

结合方案 A 和方案 C 的优点：

1. **Pallet 层**：
   - 记录悬赏是否基于加密八字
   - 提供授权状态查询 Runtime API
   - **不强制阻止**未授权大师接单（保持开放性）

2. **前端层**：
   - 创建悬赏时提醒用户
   - 显示授权状态
   - 大师接单时显示警告："您尚未获得完整数据访问权限"
   - 引导用户完成授权

3. **用户体验**：
   - 悬赏可以正常创建和接单
   - 但明确告知授权状态
   - 大师可选择等待授权或基于明文数据解读

---

## 6. 推荐实施路径

### 第一阶段：前端优化（紧急）

1. 修改 `CreateBountyModal.tsx`：
   - 检测是否为加密八字
   - 显示授权提醒

2. 修改 `BountyDetailPage.tsx`：
   - 显示授权状态
   - 添加授权管理入口

### 第二阶段：Pallet 增强（后续）

1. 新增存储和查询接口
2. 新增 Runtime API
3. 完善跨 Pallet 调用

### 第三阶段：完整自动化（远期）

1. 实现悬赏级别的自动授权
2. 实现授权生命周期管理
3. 实现授权撤销机制

---

## 7. 相关文件

| 文件路径 | 说明 |
|----------|------|
| `pallets/divination/market/src/lib.rs` | 悬赏系统 Pallet |
| `pallets/divination/market/src/types.rs` | 悬赏数据类型定义 |
| `pallets/divination/bazi/src/lib.rs` | 八字 Pallet（含 V6 加密功能） |
| `pallets/divination/bazi/src/types.rs` | 八字数据类型（含 V6 加密结构） |
| `stardust-dapp/src/features/bounty/components/CreateBountyModal.tsx` | 悬赏创建前端组件 |
| `stardust-dapp/src/features/bazi/components/v6/ChartAuthorization.tsx` | 授权管理前端组件 |

---

## 8. 参考文档

- [加密八字存储与多方授权系统设计-简化版.md](./加密八字存储与多方授权系统设计-简化版.md)
- [加密八字系统开发计划.md](./加密八字系统开发计划.md)
