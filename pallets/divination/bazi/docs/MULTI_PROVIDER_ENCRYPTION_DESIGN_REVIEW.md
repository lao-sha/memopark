# å¤šæœåŠ¡æä¾›è€…åŠ å¯†å­˜å‚¨è®¾è®¡è¯„å®¡æŠ¥å‘Š

## ğŸ“‹ æ€»ä½“è¯„ä»·

**è¯„åˆ†ï¼šâ­â­â­â­â­ (5/5) - ä¼˜ç§€è®¾è®¡**

è¿™æ˜¯ä¸€ä»½éå¸¸ä¸“ä¸šã€å…¨é¢ã€æ·±æ€ç†Ÿè™‘çš„è®¾è®¡æ–‡æ¡£ã€‚æ•´ä½“æ¶æ„åˆç†ï¼Œå®‰å…¨æ€§è€ƒè™‘å‘¨å…¨ï¼Œå®ç°è·¯å¾„æ¸…æ™°ã€‚

---

## âœ… è®¾è®¡äº®ç‚¹

### 1. ä¸‰å±‚å¯†é’¥æ¶æ„ï¼ˆâ­â­â­â­â­ï¼‰

```
MasterKey (ç”¨æˆ·ä¸»å¯†é’¥)
    â†“
ChartKey (å‘½ç›˜å¯†é’¥)
    â†“
AccessKey (æˆæƒå¯†é’¥)
```

**ä¼˜ç‚¹**ï¼š
- âœ… **å¯†é’¥éš”ç¦»**ï¼šå•ä¸ªå‘½ç›˜æ³„éœ²ä¸å½±å“å…¶ä»–
- âœ… **çµæ´»æˆæƒ**ï¼šå¯ä¸ºä¸åŒæä¾›è€…ç”Ÿæˆä¸åŒ AccessKey
- âœ… **æ˜“äºæ’¤é”€**ï¼šæ’¤é”€åªéœ€æ ‡è®°ï¼Œæ— éœ€é‡æ–°åŠ å¯†
- âœ… **å‰å‘å®‰å…¨**ï¼šæ’¤é”€åæ— æ³•è§£å¯†æ–°æ•°æ®

**è¯„ä»·**ï¼šè¿™æ˜¯ä¸šç•Œæœ€ä½³å®è·µï¼Œç±»ä¼¼äº AWS KMS çš„å¯†é’¥å±‚çº§è®¾è®¡ã€‚

---

### 2. æ··åˆåŠ å¯†æ–¹æ¡ˆï¼ˆâ­â­â­â­â­ï¼‰

**AES-256-GCM + X25519 å¯†é’¥å°è£…**

**ä¼˜ç‚¹**ï¼š
- âœ… **æ€§èƒ½ä¼˜ç§€**ï¼šå¯¹ç§°åŠ å¯†å¿«é€Ÿ
- âœ… **å®‰å…¨æ€§é«˜**ï¼šAES-256 + è®¤è¯åŠ å¯†
- âœ… **æ ‡å‡†åŒ–**ï¼šWeb Crypto API åŸç”Ÿæ”¯æŒ
- âœ… **å¯æ‰©å±•**ï¼šæ”¯æŒå¤šæ–¹è§£å¯†

**è¯„ä»·**ï¼šå®Œå…¨ç¬¦åˆç°ä»£å¯†ç å­¦æœ€ä½³å®è·µã€‚

---

### 3. ç»†ç²’åº¦æˆæƒæ§åˆ¶ï¼ˆâ­â­â­â­â­ï¼‰

```rust
pub struct AccessGrant {
    pub start_block: u32,      // å¼€å§‹æ—¶é—´
    pub end_block: u32,        // ç»“æŸæ—¶é—´
    pub scope: AccessScope,    // æƒé™èŒƒå›´
    pub revoked: bool,         // å¯æ’¤é”€
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… **æ—¶é—´é™åˆ¶**ï¼šè‡ªåŠ¨è¿‡æœŸ
- âœ… **æƒé™åˆ†çº§**ï¼šReadOnly / CanComment / CanDelegate
- âœ… **å¯æ’¤é”€**ï¼šç”¨æˆ·éšæ—¶æ”¶å›æƒé™
- âœ… **å¯å®¡è®¡**ï¼šé“¾ä¸Šè®°å½•æ‰€æœ‰æ“ä½œ

**è¯„ä»·**ï¼šæƒé™ç®¡ç†è®¾è®¡éå¸¸å®Œå–„ã€‚

---

### 4. æœåŠ¡æä¾›è€…æ³¨å†Œæœºåˆ¶ï¼ˆâ­â­â­â­ï¼‰

```rust
pub struct ServiceProvider {
    pub service_type: ServiceType,  // ç±»å‹åˆ†ç±»
    pub public_key: [u8; 32],       // å…¬é’¥
    pub reputation: u32,            // ä¿¡èª‰åˆ†
    pub is_active: bool,            // æ¿€æ´»çŠ¶æ€
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… **èº«ä»½éªŒè¯**ï¼šå…¬é’¥ç»‘å®šè´¦æˆ·
- âœ… **ä¿¡èª‰ç³»ç»Ÿ**ï¼šå¯ç­›é€‰ä¼˜è´¨æœåŠ¡
- âœ… **ç±»å‹åˆ†ç±»**ï¼šä¾¿äºç”¨æˆ·é€‰æ‹©

**è¯„ä»·**ï¼šä¸ºæ„å»ºæœåŠ¡å¸‚åœºæ‰“ä¸‹è‰¯å¥½åŸºç¡€ã€‚

---

## âš ï¸ æ½œåœ¨é—®é¢˜ä¸æ”¹è¿›å»ºè®®

### é—®é¢˜ 1ï¼šå¯†é’¥æ´¾ç”Ÿçš„å®‰å…¨æ€§ï¼ˆä¸­ç­‰é£é™©ï¼‰

**å½“å‰è®¾è®¡**ï¼š
```rust
fn derive_master_key(wallet_signature: &[u8; 64]) -> [u8; 32] {
    blake2_256(b"STARDUST_BAZI_MASTER_KEY_V1" || wallet_signature)
}
```

**é—®é¢˜**ï¼š
- âš ï¸ é’±åŒ…ç­¾åæ˜¯ç¡®å®šæ€§çš„ï¼ŒåŒä¸€æ¶ˆæ¯æ€»æ˜¯äº§ç”Ÿç›¸åŒç­¾å
- âš ï¸ å¦‚æœç­¾åæ³„éœ²ï¼Œä¸»å¯†é’¥æ°¸ä¹…æ³„éœ²
- âš ï¸ æ— æ³•æ›´æ¢ä¸»å¯†é’¥ï¼ˆé™¤éæ¢é’±åŒ…ï¼‰

**æ”¹è¿›å»ºè®®**ï¼š

#### æ–¹æ¡ˆ Aï¼šæ·»åŠ ç”¨æˆ·è‡ªå®šä¹‰ç›å€¼
```rust
fn derive_master_key(
    wallet_signature: &[u8; 64],
    user_salt: &[u8; 32],  // ç”¨æˆ·è‡ªå®šä¹‰ï¼Œå¯æ›´æ¢
) -> [u8; 32] {
    blake2_256(
        b"STARDUST_BAZI_MASTER_KEY_V1" ||
        wallet_signature ||
        user_salt
    )
}
```

#### æ–¹æ¡ˆ Bï¼šä½¿ç”¨ HKDFï¼ˆæ¨èï¼‰
```rust
use hkdf::Hkdf;
use sha2::Sha256;

fn derive_master_key(wallet_signature: &[u8; 64]) -> [u8; 32] {
    let hkdf = Hkdf::<Sha256>::new(
        Some(b"STARDUST_BAZI_MASTER_KEY_V1"),
        wallet_signature
    );
    let mut okm = [0u8; 32];
    hkdf.expand(b"master_key", &mut okm).unwrap();
    okm
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç¬¦åˆ RFC 5869 æ ‡å‡†
- âœ… æ›´å¼ºçš„å®‰å…¨ä¿è¯
- âœ… æ”¯æŒå¤šä¸ªæ´¾ç”Ÿå¯†é’¥

---

### é—®é¢˜ 2ï¼šAccessKey æ´¾ç”ŸåŒ…å«è¿‡æœŸæ—¶é—´ï¼ˆè®¾è®¡ç¼ºé™·ï¼‰

**å½“å‰è®¾è®¡**ï¼š
```rust
fn derive_access_key(
    chart_key: &[u8; 32],
    provider_id: &AccountId,
    expiry_block: u32,  // â† é—®é¢˜ï¼šåŒ…å«åœ¨æ´¾ç”Ÿä¸­
    nonce: u64,
) -> [u8; 32]
```

**é—®é¢˜**ï¼š
- âŒ **æ— æ³•ç»­æœŸ**ï¼šç»­æœŸéœ€è¦é‡æ–°æ´¾ç”Ÿæ–°å¯†é’¥
- âŒ **å¤æ‚åº¦å¢åŠ **ï¼šæ¯æ¬¡ç»­æœŸéƒ½è¦é‡æ–°åŠ å¯†
- âŒ **ä¸å¿…è¦çš„è€¦åˆ**ï¼šè¿‡æœŸæ—¶é—´åº”è¯¥æ˜¯æˆæƒè®°å½•çš„å±æ€§ï¼Œä¸åº”å½±å“å¯†é’¥

**æ”¹è¿›å»ºè®®**ï¼š

```rust
// ç®€åŒ–ç‰ˆï¼šAccessKey ä¸åŒ…å«è¿‡æœŸæ—¶é—´
fn derive_access_key(
    chart_key: &[u8; 32],
    provider_id: &AccountId,
    grant_id: u64,  // ä½¿ç”¨æˆæƒ ID è€Œéè¿‡æœŸæ—¶é—´
) -> [u8; 32] {
    blake2_256(
        b"ACCESS_KEY" ||
        chart_key ||
        provider_id ||
        grant_id.to_le_bytes()
    )
}

// è¿‡æœŸæ—¶é—´åœ¨ AccessGrant ä¸­ç®¡ç†
pub struct AccessGrant {
    pub grant_id: u64,
    pub encrypted_access_key: Vec<u8>,  // å›ºå®šçš„ AccessKey
    pub end_block: u32,  // å¯ä¿®æ”¹çš„è¿‡æœŸæ—¶é—´
    pub revoked: bool,
}

// ç»­æœŸåªéœ€æ›´æ–° end_blockï¼Œæ— éœ€é‡æ–°åŠ å¯†
fn extend_access(grant_id: u64, additional_blocks: u32) {
    AccessGrants::mutate(grant_id, |grant| {
        grant.end_block += additional_blocks;
    });
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç»­æœŸç®€å•ï¼ˆåªæ”¹é“¾ä¸Šè®°å½•ï¼‰
- âœ… æ— éœ€é‡æ–°åŠ å¯†
- âœ… é™ä½å¤æ‚åº¦

---

### é—®é¢˜ 3ï¼šä»£ç†é‡åŠ å¯†æ–¹æ¡ˆï¼ˆæ–¹æ¡ˆ Bï¼‰çš„è¯¯å¯¼

**æ–‡æ¡£ä¸­çš„æè¿°**ï¼š
```
æ–¹æ¡ˆ Bï¼šä»£ç†é‡åŠ å¯†ï¼ˆProxy Re-Encryptionï¼‰
æ¨èæ–¹æ¡ˆï¼šæ–¹æ¡ˆ Aï¼ˆå¯†é’¥å°è£…ï¼‰
```

**é—®é¢˜**ï¼š
- âš ï¸ ä»£ç†é‡åŠ å¯†éœ€è¦å¤æ‚çš„å¯†ç å­¦åŸè¯­ï¼ˆå¦‚ BBS+ã€PREï¼‰
- âš ï¸ Substrate ä¸åŸç”Ÿæ”¯æŒ
- âš ï¸ å®ç°éš¾åº¦æé«˜
- âš ï¸ æ€§èƒ½å¼€é”€å¤§

**æ”¹è¿›å»ºè®®**ï¼š

**åˆ é™¤æ–¹æ¡ˆ B æˆ–æ˜ç¡®æ ‡æ³¨ä¸º"æœªæ¥ç ”ç©¶æ–¹å‘"**

```markdown
#### æ–¹æ¡ˆ Bï¼šä»£ç†é‡åŠ å¯†ï¼ˆæœªæ¥ç ”ç©¶æ–¹å‘ï¼‰

âš ï¸ **æ³¨æ„**ï¼šæ­¤æ–¹æ¡ˆéœ€è¦é«˜çº§å¯†ç å­¦åŸè¯­ï¼Œå½“å‰ä¸æ¨èå®æ–½ã€‚

ä¼˜ç‚¹ï¼š
- ä»£ç†æ— æ³•è§£å¯†åŸæ–‡
- ç†è®ºä¸Šæ›´å®‰å…¨

ç¼ºç‚¹ï¼š
- âŒ å®ç°å¤æ‚åº¦æé«˜
- âŒ Substrate ä¸åŸç”Ÿæ”¯æŒ
- âŒ æ€§èƒ½å¼€é”€å¤§
- âŒ ç¼ºä¹æˆç†Ÿçš„åº“

**ç»“è®º**ï¼šæ–¹æ¡ˆ Aï¼ˆå¯†é’¥å°è£…ï¼‰å·²è¶³å¤Ÿå®‰å…¨ä¸”æ˜“äºå®ç°ï¼Œæ¨èä½¿ç”¨ã€‚
```

---

### é—®é¢˜ 4ï¼šå­˜å‚¨æˆæœ¬ä¸é™åˆ¶ï¼ˆéœ€è¦æƒè¡¡ï¼‰

**å½“å‰è®¾è®¡**ï¼š
```rust
pub type ChartGrants<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u64,
    BoundedVec<AccessGrant<T>, ConstU32<50>>,  // æœ€å¤š 50 ä¸ªæˆæƒ
>;
```

**é—®é¢˜**ï¼š
- âš ï¸ 50 ä¸ªæˆæƒ Ã— 200 bytes = 10 KB / å‘½ç›˜
- âš ï¸ å¦‚æœç”¨æˆ·æœ‰å¤šä¸ªå‘½ç›˜ï¼Œå­˜å‚¨æˆæœ¬å¿«é€Ÿå¢é•¿
- âš ï¸ æ’¤é”€çš„æˆæƒä»å ç”¨å­˜å‚¨ç©ºé—´

**æ”¹è¿›å»ºè®®**ï¼š

#### æ–¹æ¡ˆ Aï¼šåˆ†ç¦»æ´»è·ƒå’Œå†å²æˆæƒ
```rust
/// æ´»è·ƒæˆæƒï¼ˆå¿«é€ŸæŸ¥è¯¢ï¼‰
pub type ActiveGrants<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u64,  // chart_id
    BoundedVec<AccessGrant<T>, ConstU32<20>>,  // æœ€å¤š 20 ä¸ªæ´»è·ƒ
>;

/// å†å²æˆæƒï¼ˆå½’æ¡£ï¼Œå¯é€‰æŸ¥è¯¢ï¼‰
pub type GrantHistory<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u64,  // grant_id
    AccessGrant<T>,
>;
```

#### æ–¹æ¡ˆ Bï¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸæˆæƒ
```rust
// åœ¨æˆæƒè¿‡æœŸåè‡ªåŠ¨ä» ActiveGrants ç§»é™¤
fn cleanup_expired_grants(chart_id: u64, current_block: u32) {
    ActiveGrants::mutate(chart_id, |grants| {
        grants.retain(|g| !g.revoked && g.end_block > current_block);
    });
}
```

---

### é—®é¢˜ 5ï¼šå‰ç«¯å¯†é’¥ç®¡ç†çš„å®‰å…¨æ€§ï¼ˆé«˜é£é™©ï¼‰

**å½“å‰è®¾è®¡**ï¼š
```typescript
// æ´¾ç”Ÿç”¨æˆ·ä¸»å¯†é’¥ï¼ˆåªéœ€åšä¸€æ¬¡ï¼Œå®‰å…¨å­˜å‚¨åœ¨æœ¬åœ°ï¼‰
async function deriveMasterKey(wallet: Wallet): Promise<Uint8Array> {
    const message = "STARDUST_BAZI_MASTER_KEY_V1";
    const signature = await wallet.signMessage(message);
    return blake2_256(signature);
}
```

**é—®é¢˜**ï¼š
- âš ï¸ "å®‰å…¨å­˜å‚¨åœ¨æœ¬åœ°" - å¦‚ä½•å®‰å…¨å­˜å‚¨ï¼Ÿ
- âš ï¸ LocalStorage ä¸å®‰å…¨ï¼ˆXSS æ”»å‡»ï¼‰
- âš ï¸ SessionStorage ä¼šè¯ç»“æŸå³ä¸¢å¤±
- âš ï¸ IndexedDB ä¹Ÿå¯èƒ½è¢« XSS æ”»å‡»

**æ”¹è¿›å»ºè®®**ï¼š

#### æ–¹æ¡ˆ Aï¼šä¸å­˜å‚¨ï¼Œæ¯æ¬¡æ´¾ç”Ÿï¼ˆæ¨èï¼‰
```typescript
// æ¯æ¬¡éœ€è¦æ—¶é‡æ–°æ´¾ç”Ÿï¼ˆç”¨æˆ·ç­¾åä¸€æ¬¡ï¼‰
async function getMasterKey(wallet: Wallet): Promise<Uint8Array> {
    // æç¤ºç”¨æˆ·ç­¾å
    const signature = await wallet.signMessage("STARDUST_BAZI_MASTER_KEY_V1");
    return blake2_256(signature);
}

// ä½¿ç”¨å®Œç«‹å³æ¸…é™¤
function useMasterKey(masterKey: Uint8Array, callback: Function) {
    try {
        callback(masterKey);
    } finally {
        masterKey.fill(0);  // æ¸…é›¶å†…å­˜
    }
}
```

#### æ–¹æ¡ˆ Bï¼šä½¿ç”¨ Web Crypto API çš„ä¸å¯å¯¼å‡ºå¯†é’¥
```typescript
async function deriveMasterKey(wallet: Wallet): Promise<CryptoKey> {
    const signature = await wallet.signMessage("STARDUST_BAZI_MASTER_KEY_V1");
    
    return await crypto.subtle.importKey(
        "raw",
        signature,
        { name: "HKDF" },
        false,  // â† ä¸å¯å¯¼å‡º
        ["deriveKey"]
    );
}
```

---

### é—®é¢˜ 6ï¼šç¼ºå°‘å¯†é’¥è½®æ¢æœºåˆ¶ï¼ˆä¸­ç­‰é£é™©ï¼‰

**å½“å‰è®¾è®¡**ï¼š
- å¯†é’¥ä¸€æ—¦æ´¾ç”Ÿï¼Œæ°¸ä¹…ä½¿ç”¨
- å¦‚æœæ€€ç–‘å¯†é’¥æ³„éœ²ï¼Œæ— æ³•æ›´æ¢

**æ”¹è¿›å»ºè®®**ï¼š

```rust
/// å¯†é’¥ç‰ˆæœ¬ç®¡ç†
pub struct EncryptedBaziChartV2<T: Config> {
    // ... ç°æœ‰å­—æ®µ
    
    /// å¯†é’¥ç‰ˆæœ¬ï¼ˆæ”¯æŒå¯†é’¥è½®æ¢ï¼‰
    pub key_version: u32,
    
    /// æ—§ç‰ˆæœ¬å¯†é’¥åŠ å¯†çš„æ•°æ®ï¼ˆå¯é€‰ï¼Œç”¨äºè¿ç§»ï¼‰
    pub legacy_encrypted_data: Option<BoundedVec<u8, ConstU32<256>>>,
}

/// å¯†é’¥è½®æ¢æ¥å£
#[pallet::call_index(30)]
pub fn rotate_chart_key(
    origin: OriginFor<T>,
    chart_id: u64,
    new_encrypted_data: BoundedVec<u8, ConstU32<256>>,
    new_key_version: u32,
) -> DispatchResult;
```

**æµç¨‹**ï¼š
1. ç”¨æˆ·æ€€ç–‘å¯†é’¥æ³„éœ²
2. æ´¾ç”Ÿæ–°çš„ ChartKeyï¼ˆä½¿ç”¨æ–°çš„ nonce æˆ–ç‰ˆæœ¬å·ï¼‰
3. ç”¨æ–°å¯†é’¥é‡æ–°åŠ å¯†æ•°æ®
4. æ’¤é”€æ‰€æœ‰æ—§æˆæƒ
5. é‡æ–°æˆæƒï¼ˆä½¿ç”¨æ–°å¯†é’¥ï¼‰

---

## ğŸ“Š å®‰å…¨æ€§è¯„ä¼°

### å¨èƒæ¨¡å‹åˆ†æ

| å¨èƒ | å½“å‰ç¼“è§£æªæ–½ | è¯„åˆ† | æ”¹è¿›å»ºè®® |
|------|-------------|------|----------|
| **é“¾ä¸Šæ•°æ®æ³„éœ²** | AES-256-GCM åŠ å¯† | â­â­â­â­â­ | æ— éœ€æ”¹è¿› |
| **æœåŠ¡æä¾›è€…æ»¥ç”¨** | æ—¶é—´é™åˆ¶ + å¯æ’¤é”€ | â­â­â­â­ | æ·»åŠ è®¿é—®æ—¥å¿— |
| **å¯†é’¥æ³„éœ²** | ç‹¬ç«‹å¯†é’¥ | â­â­â­â­ | æ·»åŠ å¯†é’¥è½®æ¢ |
| **é‡æ”¾æ”»å‡»** | Nonce | â­â­â­â­â­ | æ— éœ€æ”¹è¿› |
| **å‰ç«¯æ”»å‡»** | æœ¬åœ°æ´¾ç”Ÿ | â­â­â­ | ä¸å­˜å‚¨å¯†é’¥ |
| **ä¸­é—´äººæ”»å‡»** | HTTPS + ç­¾åéªŒè¯ | â­â­â­â­ | æ·»åŠ è¯ä¹¦å›ºå®š |
| **ç¤¾ä¼šå·¥ç¨‹** | ç”¨æˆ·æ•™è‚² | â­â­â­ | æ·»åŠ è­¦å‘Šæç¤º |

---

## ğŸ’¡ é¢å¤–å»ºè®®

### 1. æ·»åŠ è®¿é—®æ—¥å¿—ï¼ˆå®¡è®¡ï¼‰

```rust
/// è®¿é—®æ—¥å¿—ï¼ˆç”¨äºå®¡è®¡å’Œå¼‚å¸¸æ£€æµ‹ï¼‰
#[derive(Clone, Debug, Encode, Decode, TypeInfo)]
pub struct AccessLog<T: Config> {
    pub grant_id: u64,
    pub provider: T::AccountId,
    pub accessed_at: u32,
    pub ip_hash: Option<[u8; 32]>,  // IP å“ˆå¸Œï¼ˆéšç§ä¿æŠ¤ï¼‰
    pub action: AccessAction,
}

#[derive(Clone, Copy, Debug, Encode, Decode, TypeInfo)]
pub enum AccessAction {
    View,      // æŸ¥çœ‹
    Decrypt,   // è§£å¯†
    Comment,   // è¯„è®º
}
```

### 2. æ·»åŠ å¼‚å¸¸æ£€æµ‹

```rust
/// æ£€æµ‹å¼‚å¸¸è®¿é—®æ¨¡å¼
fn detect_anomaly(provider: &AccountId, chart_id: u64) -> bool {
    let recent_accesses = get_recent_accesses(provider, Duration::hours(1));
    
    // 1 å°æ—¶å†…è®¿é—®è¶…è¿‡ 100 æ¬¡
    if recent_accesses.len() > 100 {
        return true;
    }
    
    // çŸ­æ—¶é—´å†…è®¿é—®å¤§é‡ä¸åŒå‘½ç›˜
    let unique_charts: HashSet<_> = recent_accesses.iter()
        .map(|log| log.chart_id)
        .collect();
    if unique_charts.len() > 50 {
        return true;
    }
    
    false
}
```

### 3. æ·»åŠ ç”¨æˆ·é€šçŸ¥æœºåˆ¶

```rust
/// æˆæƒé€šçŸ¥äº‹ä»¶
#[pallet::event]
pub enum Event<T: Config> {
    /// æ–°æˆæƒåˆ›å»º
    AccessGranted {
        chart_id: u64,
        provider: T::AccountId,
        expires_at: u32,
    },
    
    /// æˆæƒè¢«ä½¿ç”¨
    AccessUsed {
        grant_id: u64,
        provider: T::AccountId,
        timestamp: u32,
    },
    
    /// å¼‚å¸¸è®¿é—®æ£€æµ‹
    AnomalyDetected {
        provider: T::AccountId,
        reason: Vec<u8>,
    },
}
```

### 4. æœåŠ¡æä¾›è€…ä¿¡èª‰ç³»ç»Ÿ

```rust
/// ä¿¡èª‰è¯„åˆ†æœºåˆ¶
pub struct ReputationScore {
    pub total_services: u32,      // æ€»æœåŠ¡æ¬¡æ•°
    pub positive_reviews: u32,    // å¥½è¯„æ•°
    pub negative_reviews: u32,    // å·®è¯„æ•°
    pub abuse_reports: u32,       // æ»¥ç”¨ä¸¾æŠ¥
    pub score: u32,               // ç»¼åˆè¯„åˆ† (0-100)
}

/// ç”¨æˆ·è¯„ä»·æ¥å£
#[pallet::call_index(40)]
pub fn rate_provider(
    origin: OriginFor<T>,
    provider: T::AccountId,
    rating: u8,  // 1-5 æ˜Ÿ
    comment: BoundedVec<u8, ConstU32<256>>,
) -> DispatchResult;
```

---

## ğŸ¯ æ€»ä½“è¯„ä»·ä¸å»ºè®®

### ä¼˜ç‚¹æ€»ç»“

1. âœ… **æ¶æ„è®¾è®¡ä¼˜ç§€**ï¼šä¸‰å±‚å¯†é’¥æ¶æ„æ¸…æ™°åˆç†
2. âœ… **å®‰å…¨æ€§é«˜**ï¼šä½¿ç”¨ä¸šç•Œæ ‡å‡†å¯†ç å­¦æ–¹æ¡ˆ
3. âœ… **çµæ´»æ€§å¼º**ï¼šæ”¯æŒå¤šç§æˆæƒæ¨¡å¼
4. âœ… **å¯æ‰©å±•æ€§å¥½**ï¼šæ˜“äºæ·»åŠ æ–°åŠŸèƒ½
5. âœ… **æ–‡æ¡£å®Œå–„**ï¼šè¯¦ç»†çš„å®ç°æŒ‡å—

### éœ€è¦æ”¹è¿›çš„åœ°æ–¹

1. âš ï¸ **å¯†é’¥æ´¾ç”Ÿ**ï¼šå»ºè®®ä½¿ç”¨ HKDF æ ‡å‡†
2. âš ï¸ **AccessKey è®¾è®¡**ï¼šç§»é™¤è¿‡æœŸæ—¶é—´ä¾èµ–
3. âš ï¸ **å‰ç«¯å®‰å…¨**ï¼šä¸å­˜å‚¨ä¸»å¯†é’¥ï¼Œæ¯æ¬¡æ´¾ç”Ÿ
4. âš ï¸ **å¯†é’¥è½®æ¢**ï¼šæ·»åŠ å¯†é’¥æ›´æ¢æœºåˆ¶
5. âš ï¸ **å­˜å‚¨ä¼˜åŒ–**ï¼šåˆ†ç¦»æ´»è·ƒå’Œå†å²æˆæƒ

### å®æ–½ä¼˜å…ˆçº§

**P0ï¼ˆå¿…é¡»ï¼‰**ï¼š
- ä¿®å¤ AccessKey æ´¾ç”Ÿé€»è¾‘
- æ”¹è¿›å‰ç«¯å¯†é’¥ç®¡ç†
- åˆ é™¤æˆ–æ ‡æ³¨ä»£ç†é‡åŠ å¯†æ–¹æ¡ˆ

**P1ï¼ˆé‡è¦ï¼‰**ï¼š
- ä½¿ç”¨ HKDF æ´¾ç”Ÿå¯†é’¥
- æ·»åŠ å¯†é’¥è½®æ¢æœºåˆ¶
- ä¼˜åŒ–å­˜å‚¨ç»“æ„

**P2ï¼ˆå¯é€‰ï¼‰**ï¼š
- æ·»åŠ è®¿é—®æ—¥å¿—
- å®ç°å¼‚å¸¸æ£€æµ‹
- å®Œå–„ä¿¡èª‰ç³»ç»Ÿ

---

## ğŸ“ˆ æœ€ç»ˆè¯„åˆ†

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **æ¶æ„è®¾è®¡** | â­â­â­â­â­ | ä¸‰å±‚å¯†é’¥æ¶æ„ä¼˜ç§€ |
| **å®‰å…¨æ€§** | â­â­â­â­ | æ•´ä½“å®‰å…¨ï¼Œæœ‰æ”¹è¿›ç©ºé—´ |
| **å¯å®ç°æ€§** | â­â­â­â­â­ | æŠ€æœ¯æ ˆæˆç†Ÿï¼Œæ˜“äºå®ç° |
| **å¯æ‰©å±•æ€§** | â­â­â­â­â­ | è®¾è®¡çµæ´»ï¼Œæ˜“äºæ‰©å±• |
| **æ–‡æ¡£è´¨é‡** | â­â­â­â­â­ | è¯¦ç»†å®Œå–„ |

**æ€»ä½“è¯„åˆ†ï¼šâ­â­â­â­â­ (4.8/5)**

---

## ğŸ¯ ç»“è®º

è¿™æ˜¯ä¸€ä»½**éå¸¸ä¼˜ç§€**çš„è®¾è®¡æ–‡æ¡£ï¼Œæ•´ä½“æ¶æ„åˆç†ï¼Œå®‰å…¨æ€§è€ƒè™‘å‘¨å…¨ã€‚åœ¨ä¿®å¤ä¸Šè¿°å‡ ä¸ªå…³é”®é—®é¢˜åï¼Œå¯ä»¥ä½œä¸ºç”Ÿäº§ç¯å¢ƒçš„å®æ–½æ–¹æ¡ˆã€‚

**æ¨èå®æ–½ï¼Œä½†éœ€è¦å…ˆå®Œæˆ P0 çº§åˆ«çš„æ”¹è¿›ã€‚**
