# create_encrypted_chart å‡½æ•°è¯¦è§£

## ğŸ“‹ å‡½æ•°ç­¾å

```rust
pub fn create_encrypted_chart(
    origin: OriginFor<T>,
    sizhu_index: SiZhuIndex,           // å››æŸ±ç´¢å¼•ï¼ˆ8 bytesï¼Œæ˜æ–‡ï¼‰
    gender: Gender,                     // æ€§åˆ«ï¼ˆ1 byteï¼Œæ˜æ–‡ï¼‰
    encrypted_data: BoundedVec<u8, ConstU32<256>>,  // åŠ å¯†æ•°æ®ï¼ˆæœ€å¤§ 256 bytesï¼‰
    data_hash: [u8; 32],               // æ•°æ®å“ˆå¸Œï¼ˆ32 bytesï¼‰
) -> DispatchResult
```

---

## ğŸ¯ æ ¸å¿ƒä½œç”¨

**create_encrypted_chart** æ˜¯å…«å­—æ’ç›˜ç³»ç»Ÿçš„**éšç§ä¿æŠ¤ç‰ˆæœ¬**åˆ›å»ºæ¥å£ï¼Œå…è®¸ç”¨æˆ·åœ¨é“¾ä¸Šå­˜å‚¨å…«å­—å‘½ç›˜çš„åŒæ—¶ï¼Œä¿æŠ¤æ•æ„Ÿçš„å‡ºç”Ÿä¿¡æ¯ä¸è¢«å…¬å¼€ã€‚

### ä¸æ ‡å‡†æ¥å£çš„å¯¹æ¯”

| ç‰¹æ€§ | create_bazi_chartï¼ˆæ ‡å‡†ç‰ˆï¼‰ | create_encrypted_chartï¼ˆéšç§ç‰ˆï¼‰ |
|------|---------------------------|--------------------------------|
| **å‡ºç”Ÿæ—¶é—´** | æ˜æ–‡å­˜å‚¨ | å‰ç«¯åŠ å¯†åå­˜å‚¨ |
| **å§“å** | æ˜æ–‡å­˜å‚¨ | å‰ç«¯åŠ å¯†åå­˜å‚¨ |
| **å››æŸ±** | é“¾ä¸Šè®¡ç®— | å‰ç«¯è®¡ç®—ï¼Œä»…å­˜ç´¢å¼• |
| **è§£ç›˜åŠŸèƒ½** | Runtime API å…è´¹è®¡ç®— | Runtime API å…è´¹è®¡ç®—ï¼ˆåŸºäºç´¢å¼•ï¼‰ |
| **éšç§ä¿æŠ¤** | âŒ æ‰€æœ‰æ•°æ®å…¬å¼€ | âœ… æ•æ„Ÿæ•°æ®åŠ å¯† |
| **å­˜å‚¨å¤§å°** | ~841 bytes | ~300 bytes |

---

## ğŸ” éšç§ä¿æŠ¤æœºåˆ¶

### 1. æ•°æ®åˆ†å±‚å­˜å‚¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           é“¾ä¸Šå­˜å‚¨ï¼ˆå…¬å¼€å¯è§ï¼‰                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ… æ˜æ–‡æ•°æ®ï¼ˆç”¨äºè®¡ç®—ï¼‰                         â”‚
â”‚     - sizhu_index: å››æŸ±ç´¢å¼•ï¼ˆ8 bytesï¼‰          â”‚
â”‚     - gender: æ€§åˆ«ï¼ˆ1 byteï¼‰                    â”‚
â”‚     - data_hash: æ•°æ®å“ˆå¸Œï¼ˆ32 bytesï¼‰           â”‚
â”‚                                                 â”‚
â”‚  ğŸ”’ åŠ å¯†æ•°æ®ï¼ˆæ— æ³•ç›´æ¥è¯»å–ï¼‰                     â”‚
â”‚     - encrypted_data: AES-256-GCM å¯†æ–‡          â”‚
â”‚       åŒ…å«ï¼šå‡ºç”Ÿæ—¶é—´ã€å§“åã€å‡ºç”Ÿåœ°ç­‰             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. å››æŸ±ç´¢å¼•ï¼ˆSiZhuIndexï¼‰

```rust
/// å››æŸ±ç´¢å¼•ï¼š8 bytes ç´§å‡‘å­˜å‚¨
pub struct SiZhuIndex {
    pub year_gan: u8,   // å¹´æŸ±å¤©å¹² (0-9)
    pub year_zhi: u8,   // å¹´æŸ±åœ°æ”¯ (0-11)
    pub month_gan: u8,  // æœˆæŸ±å¤©å¹² (0-9)
    pub month_zhi: u8,  // æœˆæŸ±åœ°æ”¯ (0-11)
    pub day_gan: u8,    // æ—¥æŸ±å¤©å¹² (0-9)
    pub day_zhi: u8,    // æ—¥æŸ±åœ°æ”¯ (0-11)
    pub hour_gan: u8,   // æ—¶æŸ±å¤©å¹² (0-9)
    pub hour_zhi: u8,   // æ—¶æŸ±åœ°æ”¯ (0-11)
}
```

**å…³é”®ç‰¹æ€§**ï¼š
- âœ… åŒ…å«å®Œæ•´å››æŸ±ä¿¡æ¯ï¼Œè¶³å¤Ÿè¿›è¡Œå‘½ç†åˆ†æ
- âœ… ä¸åŒ…å«å…·ä½“å‡ºç”Ÿæ—¶é—´ï¼Œæ— æ³•åæ¨
- âœ… æ”¯æŒ Runtime API å…è´¹è®¡ç®—è§£ç›˜
- âœ… ä»… 8 bytesï¼Œå­˜å‚¨æˆæœ¬æä½

**ç¤ºä¾‹**ï¼š
```
å‡ºç”Ÿæ—¶é—´ï¼š1990å¹´5æœˆ15æ—¥14:30
å››æŸ±ï¼šåºšåˆå¹´ è¾›å·³æœˆ ç”²å­æ—¥ è¾›æœªæ—¶

SiZhuIndex:
  year_gan: 6 (åºš), year_zhi: 6 (åˆ)
  month_gan: 7 (è¾›), month_zhi: 5 (å·³)
  day_gan: 0 (ç”²), day_zhi: 0 (å­)
  hour_gan: 7 (è¾›), hour_zhi: 7 (æœª)
```

### 3. åŠ å¯†æ•°æ®ç»“æ„

```rust
/// å‰ç«¯åŠ å¯†å‰çš„åŸå§‹æ•°æ®ï¼ˆJSON æ ¼å¼ï¼‰
{
    "name": "å¼ ä¸‰",
    "birth_time": {
        "year": 1990,
        "month": 5,
        "day": 15,
        "hour": 14,
        "minute": 30
    },
    "location": {
        "longitude": 116.4074,
        "latitude": 39.9042
    },
    "zishi_mode": "Modern"
}

// å‰ç«¯åŠ å¯†æµç¨‹
1. JSON.stringify() â†’ å­—ç¬¦ä¸²
2. AES-256-GCM åŠ å¯† â†’ å¯†æ–‡
3. è®¡ç®— Blake2-256 å“ˆå¸Œ â†’ data_hash
4. ä¸Šä¼ åˆ°é“¾ä¸Š
```

---

## ğŸ”‘ å¯†é’¥ç®¡ç†æ–¹æ¡ˆ

### æ–¹æ¡ˆ Aï¼šé’±åŒ…ç­¾åæ´¾ç”Ÿï¼ˆæ¨èï¼‰

```typescript
// å‰ç«¯å®ç°
async function deriveEncryptionKey(account: Account): Promise<CryptoKey> {
    // 1. ä½¿ç”¨é’±åŒ…ç­¾åå›ºå®šæ¶ˆæ¯
    const message = "bazi-chart-encryption-key-v1";
    const signature = await account.sign(message);
    
    // 2. ä»ç­¾åæ´¾ç”Ÿ AES-256 å¯†é’¥
    const keyMaterial = await crypto.subtle.importKey(
        "raw",
        signature.slice(0, 32),  // å–å‰ 32 bytes
        "PBKDF2",
        false,
        ["deriveKey"]
    );
    
    const key = await crypto.subtle.deriveKey(
        {
            name: "PBKDF2",
            salt: new Uint8Array(16),  // å›ºå®š salt
            iterations: 100000,
            hash: "SHA-256"
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
    );
    
    return key;
}

// åŠ å¯†æ•°æ®
async function encryptBaziData(data: any, account: Account) {
    const key = await deriveEncryptionKey(account);
    const iv = crypto.getRandomValues(new Uint8Array(12));
    
    const plaintext = new TextEncoder().encode(JSON.stringify(data));
    const ciphertext = await crypto.subtle.encrypt(
        { name: "AES-GCM", iv },
        key,
        plaintext
    );
    
    // ç»„åˆ IV + å¯†æ–‡
    const encrypted = new Uint8Array(iv.length + ciphertext.byteLength);
    encrypted.set(iv, 0);
    encrypted.set(new Uint8Array(ciphertext), iv.length);
    
    // è®¡ç®—å“ˆå¸Œ
    const hash = await crypto.subtle.digest("SHA-256", plaintext);
    
    return {
        encrypted_data: Array.from(encrypted),
        data_hash: Array.from(new Uint8Array(hash))
    };
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ— éœ€é¢å¤–å­˜å‚¨å¯†é’¥
- âœ… é’±åŒ…å³å¯†é’¥ç®¡ç†å™¨
- âœ… è·¨è®¾å¤‡åŒæ­¥ï¼ˆåªéœ€é’±åŒ…åŠ©è®°è¯ï¼‰

**ç¼ºç‚¹**ï¼š
- âš ï¸ é’±åŒ…ä¸¢å¤± = æ•°æ®æ°¸ä¹…ä¸¢å¤±
- âš ï¸ æ— æ³•åˆ†äº«ç»™ä»–äºº

### æ–¹æ¡ˆ Bï¼šç”¨æˆ·è‡ªå®šä¹‰å¯†ç 

```typescript
async function deriveKeyFromPassword(password: string, salt: Uint8Array) {
    const keyMaterial = await crypto.subtle.importKey(
        "raw",
        new TextEncoder().encode(password),
        "PBKDF2",
        false,
        ["deriveKey"]
    );
    
    return await crypto.subtle.deriveKey(
        {
            name: "PBKDF2",
            salt,
            iterations: 100000,
            hash: "SHA-256"
        },
        keyMaterial,
        { name: "AES-GCM", length: 256 },
        false,
        ["encrypt", "decrypt"]
    );
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… å¯ä»¥åˆ†äº«å¯†ç ç»™ä»–äººæŸ¥çœ‹
- âœ… å¯ä»¥è®¾ç½®ä¸åŒå¯†ç ä¿æŠ¤ä¸åŒå‘½ç›˜

**ç¼ºç‚¹**ï¼š
- âš ï¸ ç”¨æˆ·éœ€è¦è®°ä½å¯†ç 
- âš ï¸ å¯†ç æ³„éœ² = éšç§æ³„éœ²

---

## ğŸ“Š åº”ç”¨åœºæ™¯

### åœºæ™¯ 1ï¼šä¸ªäººéšç§ä¿æŠ¤

**ç”¨æˆ·éœ€æ±‚**ï¼š
- æƒ³åœ¨é“¾ä¸Šæ°¸ä¹…ä¿å­˜è‡ªå·±çš„å…«å­—å‘½ç›˜
- ä¸å¸Œæœ›å‡ºç”Ÿæ—¶é—´ã€å§“åç­‰æ•æ„Ÿä¿¡æ¯è¢«å…¬å¼€
- éœ€è¦éšæ—¶æŸ¥çœ‹è§£ç›˜ç»“æœ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// 1. å‰ç«¯è®¡ç®—å››æŸ±
const sizhu = calculateSiZhu(birthTime);
const sizhuIndex = SiZhuIndex.fromSiZhu(sizhu);

// 2. åŠ å¯†æ•æ„Ÿæ•°æ®
const sensitiveData = {
    name: "å¼ ä¸‰",
    birth_time: birthTime,
    location: { longitude: 116.4074, latitude: 39.9042 }
};
const { encrypted_data, data_hash } = await encryptBaziData(
    sensitiveData,
    account
);

// 3. åˆ›å»ºåŠ å¯†å‘½ç›˜
await api.tx.baziChart.createEncryptedChart(
    sizhuIndex,
    "Female",
    encrypted_data,
    data_hash
).signAndSend(account);

// 4. æŸ¥çœ‹è§£ç›˜ï¼ˆå…è´¹ï¼‰
const interpretation = await api.call.baziChartApi.getEncryptedChartInterpretation(chartId);
```

### åœºæ™¯ 2ï¼šå‘½ç†å¸ˆå®¢æˆ·ç®¡ç†

**ç”¨æˆ·éœ€æ±‚**ï¼š
- å‘½ç†å¸ˆéœ€è¦ç®¡ç†å¤§é‡å®¢æˆ·å‘½ç›˜
- å®¢æˆ·éšç§å¿…é¡»ä¿æŠ¤
- éœ€è¦å¿«é€ŸæŸ¥è¯¢å’Œåˆ†æ

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// å‘½ç†å¸ˆä¸ºå®¢æˆ·åˆ›å»ºåŠ å¯†å‘½ç›˜
async function createClientChart(clientData: ClientData) {
    // 1. è®¡ç®—å››æŸ±
    const sizhu = calculateSiZhu(clientData.birthTime);
    
    // 2. åŠ å¯†å®¢æˆ·ä¿¡æ¯ï¼ˆä½¿ç”¨å‘½ç†å¸ˆçš„å¯†é’¥ï¼‰
    const encrypted = await encryptBaziData({
        name: clientData.name,
        phone: clientData.phone,
        birth_time: clientData.birthTime,
        notes: clientData.notes
    }, masterAccount);
    
    // 3. ä¸Šé“¾å­˜å‚¨
    const chartId = await createEncryptedChart(
        sizhu.toIndex(),
        clientData.gender,
        encrypted.encrypted_data,
        encrypted.data_hash
    );
    
    // 4. æœ¬åœ°æ•°æ®åº“è®°å½•æ˜ å°„
    await db.clients.insert({
        client_id: clientData.id,
        chart_id: chartId,
        created_at: Date.now()
    });
    
    return chartId;
}

// æŸ¥è¯¢å®¢æˆ·å‘½ç›˜
async function getClientInterpretation(clientId: string) {
    const { chart_id } = await db.clients.findOne({ client_id: clientId });
    return await api.call.baziChartApi.getEncryptedChartInterpretation(chart_id);
}
```

### åœºæ™¯ 3ï¼šå®¶æ—å‘½ç›˜å­˜æ¡£

**ç”¨æˆ·éœ€æ±‚**ï¼š
- ä¿å­˜å®¶æ—æˆå‘˜çš„å…«å­—å‘½ç›˜
- ä¸–ä»£ä¼ æ‰¿ï¼Œæ°¸ä¹…ä¿å­˜
- éšç§ä¿æŠ¤ï¼Œåªæœ‰å®¶æ—æˆå‘˜å¯è§£å¯†

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// ä½¿ç”¨å®¶æ—å…±äº«å¯†é’¥
const familyPassword = "family-secret-key-2024";

// ä¸ºå®¶æ—æˆå‘˜åˆ›å»ºå‘½ç›˜
async function createFamilyMemberChart(member: FamilyMember) {
    const encrypted = await encryptWithPassword(
        {
            name: member.name,
            relation: member.relation,  // å…³ç³»ï¼šçˆ¶äº²ã€æ¯äº²ã€å„¿å­ç­‰
            birth_time: member.birthTime
        },
        familyPassword
    );
    
    return await createEncryptedChart(
        member.sizhuIndex,
        member.gender,
        encrypted.encrypted_data,
        encrypted.data_hash
    );
}

// å®¶æ—æˆå‘˜å¯ä»¥ç”¨å…±äº«å¯†ç è§£å¯†
async function viewFamilyMemberChart(chartId: number) {
    const chart = await api.query.baziChart.encryptedChartById(chartId);
    const decrypted = await decryptWithPassword(
        chart.encrypted_data,
        familyPassword
    );
    return JSON.parse(decrypted);
}
```

### åœºæ™¯ 4ï¼šNFT å‘½ç›˜ï¼ˆéšç§ç‰ˆï¼‰

**ç”¨æˆ·éœ€æ±‚**ï¼š
- å°†å…«å­—å‘½ç›˜é“¸é€ ä¸º NFT
- NFT å¯ä»¥äº¤æ˜“ï¼Œä½†éšç§æ•°æ®ä¸æ³„éœ²
- æ–°ä¸»äººå¯ä»¥æŸ¥çœ‹è§£ç›˜ï¼Œä½†çœ‹ä¸åˆ°åŸå§‹å‡ºç”Ÿä¿¡æ¯

**è§£å†³æ–¹æ¡ˆ**ï¼š
```typescript
// 1. åˆ›å»ºåŠ å¯†å‘½ç›˜
const chartId = await createEncryptedChart(...);

// 2. é“¸é€  NFTï¼ˆå…³è” chart_idï¼‰
const nftId = await api.tx.nft.mint(
    collection_id,
    {
        chart_id: chartId,
        chart_type: "EncryptedBazi",
        // å…ƒæ•°æ®ï¼šåªåŒ…å«éæ•æ„Ÿä¿¡æ¯
        metadata: {
            gender: "Female",
            year_pillar: "åºšåˆ",
            // ä¸åŒ…å«å…·ä½“å‡ºç”Ÿæ—¶é—´
        }
    }
).signAndSend(account);

// 3. NFT æŒæœ‰è€…å¯ä»¥æŸ¥çœ‹è§£ç›˜
const interpretation = await api.call.baziChartApi.getEncryptedChartInterpretation(chartId);

// 4. ä½†æ— æ³•è§£å¯†åŸå§‹æ•°æ®ï¼ˆé™¤éåŸä¸»äººåˆ†äº«å¯†é’¥ï¼‰
```

---

## ğŸ”„ å®Œæ•´å·¥ä½œæµç¨‹

### åˆ›å»ºæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ DApp  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. ç”¨æˆ·è¾“å…¥å‡ºç”Ÿä¿¡æ¯
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®¡ç®—å››æŸ±                    â”‚
â”‚  - å…¬å† â†’ å››æŸ±å¹²æ”¯           â”‚
â”‚  - ç”Ÿæˆ SiZhuIndex (8 bytes)â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. åŠ å¯†æ•æ„Ÿæ•°æ®
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AES-256-GCM åŠ å¯†            â”‚
â”‚  - å§“åã€å‡ºç”Ÿæ—¶é—´ã€åœ°ç‚¹      â”‚
â”‚  - ç”Ÿæˆå¯†æ–‡ + å“ˆå¸Œ           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. æäº¤åˆ°é“¾ä¸Š
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  create_encrypted_chart()   â”‚
â”‚  - éªŒè¯å››æŸ±ç´¢å¼•æœ‰æ•ˆæ€§        â”‚
â”‚  - å­˜å‚¨åˆ° EncryptedChartByIdâ”‚
â”‚  - è§¦å‘äº‹ä»¶                  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. è¿”å› chart_id
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ä¿å­˜   â”‚
â”‚  chart_id   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŸ¥è¯¢æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ DApp  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. è¯·æ±‚è§£ç›˜
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Runtime API                â”‚
â”‚  getEncryptedChartInterpretation(chart_id)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. è¯»å–é“¾ä¸Šæ•°æ®
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EncryptedChartById         â”‚
â”‚  - sizhu_index (æ˜æ–‡)       â”‚
â”‚  - gender (æ˜æ–‡)            â”‚
â”‚  - encrypted_data (å¯†æ–‡)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. åŸºäºç´¢å¼•è®¡ç®—
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  calculate_interpretation_from_index()
â”‚  - æ ¼å±€ã€å¼ºå¼±ã€ç”¨ç¥          â”‚
â”‚  - æ€§æ ¼åˆ†æã€èŒä¸šå»ºè®®        â”‚
â”‚  - å®Œå…¨åŸºäºå››æŸ±ç´¢å¼•          â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. è¿”å›è§£ç›˜ç»“æœï¼ˆå…è´¹ï¼‰
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯å±•ç¤º   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### è§£å¯†æµç¨‹ï¼ˆå¯é€‰ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ DApp  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 1. ç”¨æˆ·è¯·æ±‚æŸ¥çœ‹åŸå§‹æ•°æ®
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯»å– encrypted_data        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 2. æ´¾ç”Ÿè§£å¯†å¯†é’¥
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  deriveEncryptionKey()      â”‚
â”‚  - é’±åŒ…ç­¾å â†’ å¯†é’¥           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 3. AES-256-GCM è§£å¯†
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  crypto.subtle.decrypt()    â”‚
â”‚  - å¯†æ–‡ â†’ æ˜æ–‡               â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 4. éªŒè¯å“ˆå¸Œ
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Blake2-256(æ˜æ–‡) == data_hash?
â”‚  - éªŒè¯è§£å¯†æ­£ç¡®æ€§            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ 5. è§£æ JSON
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ˜¾ç¤ºåŸå§‹   â”‚
â”‚  å‡ºç”Ÿä¿¡æ¯   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ˆ å­˜å‚¨æˆæœ¬å¯¹æ¯”

| æ•°æ®é¡¹ | æ ‡å‡†ç‰ˆ | åŠ å¯†ç‰ˆ | èŠ‚çœ |
|--------|--------|--------|------|
| å‡ºç”Ÿæ—¶é—´ | 7 bytes | 0 bytesï¼ˆåŠ å¯†ï¼‰ | -7 |
| å§“å | 65 bytes | 0 bytesï¼ˆåŠ å¯†ï¼‰ | -65 |
| å››æŸ±å®Œæ•´ | ~200 bytes | 8 bytesï¼ˆç´¢å¼•ï¼‰ | -192 |
| å¤§è¿ | ~500 bytes | 0 bytesï¼ˆä¸å­˜ï¼‰ | -500 |
| åŠ å¯†æ•°æ® | 0 | ~150 bytes | +150 |
| æ•°æ®å“ˆå¸Œ | 0 | 32 bytes | +32 |
| **æ€»è®¡** | **~841 bytes** | **~300 bytes** | **-64%** |

---

## âš ï¸ æ³¨æ„äº‹é¡¹ä¸é™åˆ¶

### 1. è§£ç›˜ç²¾åº¦

| åŠŸèƒ½ | æ ‡å‡†ç‰ˆ | åŠ å¯†ç‰ˆ |
|------|--------|--------|
| æ ¼å±€åˆ†æ | âœ… å®Œæ•´ | âœ… å®Œæ•´ |
| å¼ºå¼±åˆ¤æ–­ | âœ… å®Œæ•´ | âœ… å®Œæ•´ |
| ç”¨ç¥å–œå¿Œ | âœ… å®Œæ•´ | âœ… å®Œæ•´ |
| æ€§æ ¼åˆ†æ | âœ… å®Œæ•´ | âœ… å®Œæ•´ |
| å¤§è¿æ¨ç®— | âœ… å®Œæ•´ | âš ï¸ ç®€åŒ–ï¼ˆæ— å…·ä½“å¹´ä»½ï¼‰ |
| æµå¹´åˆ†æ | âœ… å®Œæ•´ | âŒ ä¸æ”¯æŒï¼ˆéœ€å‡ºç”Ÿå¹´ä»½ï¼‰ |

### 2. å¯†é’¥ç®¡ç†é£é™©

- âš ï¸ **é’±åŒ…ä¸¢å¤±** = æ•°æ®æ°¸ä¹…æ— æ³•è§£å¯†
- âš ï¸ **å¯†ç é—å¿˜** = æ— æ³•æ¢å¤åŸå§‹ä¿¡æ¯
- âš ï¸ **å¯†é’¥æ³„éœ²** = éšç§å®Œå…¨æš´éœ²

**å»ºè®®**ï¼š
- ä½¿ç”¨é’±åŒ…ç­¾åæ´¾ç”Ÿå¯†é’¥ï¼ˆæ¨èï¼‰
- å¤‡ä»½é’±åŒ…åŠ©è®°è¯
- é‡è¦å‘½ç›˜å¯ä»¥å¯¼å‡ºåŠ å¯†å¤‡ä»½

### 3. æ•°æ®éªŒè¯

```rust
// é“¾ä¸ŠéªŒè¯
ensure!(sizhu_index.is_valid(), Error::<T>::InvalidSiZhuIndex);

// å‰ç«¯éªŒè¯ï¼ˆè§£å¯†åï¼‰
const decrypted = await decrypt(encrypted_data, key);
const hash = blake2_256(decrypted);
if (hash !== data_hash) {
    throw new Error("è§£å¯†å¤±è´¥æˆ–æ•°æ®å·²æŸå");
}
```

---

## ğŸ¯ æ€»ç»“

### é€‚ç”¨äººç¾¤

| ç”¨æˆ·ç±»å‹ | æ¨èæ¥å£ | ç†ç”± |
|----------|----------|------|
| **æ™®é€šç”¨æˆ·** | create_bazi_chart | ç®€å•æ–¹ä¾¿ï¼Œæ— éœ€ç®¡ç†å¯†é’¥ |
| **éšç§æ•æ„Ÿç”¨æˆ·** | create_encrypted_chart | ä¿æŠ¤ä¸ªäººä¿¡æ¯ |
| **å‘½ç†å¸ˆ** | create_encrypted_chart | ä¿æŠ¤å®¢æˆ·éšç§ |
| **ä¼ä¸šåº”ç”¨** | create_encrypted_chart | åˆè§„è¦æ±‚ |

### æ ¸å¿ƒä¼˜åŠ¿

1. âœ… **éšç§ä¿æŠ¤**ï¼šæ•æ„Ÿæ•°æ®åŠ å¯†ï¼Œé“¾ä¸Šä¸å¯è§
2. âœ… **åŠŸèƒ½å®Œæ•´**ï¼šè§£ç›˜åŠŸèƒ½ä¸å—å½±å“
3. âœ… **æˆæœ¬æ›´ä½**ï¼šå­˜å‚¨ç©ºé—´å‡å°‘ 64%
4. âœ… **çµæ´»å¯†é’¥**ï¼šæ”¯æŒå¤šç§å¯†é’¥ç®¡ç†æ–¹æ¡ˆ
5. âœ… **æ°¸ä¹…ä¿å­˜**ï¼šé“¾ä¸Šæ•°æ®ä¸å¯ç¯¡æ”¹

### æŠ€æœ¯åˆ›æ–°

- ğŸ” **åˆ†å±‚å­˜å‚¨**ï¼šæ˜æ–‡ç´¢å¼• + åŠ å¯†æ•°æ®
- ğŸ¯ **é›¶çŸ¥è¯†è®¡ç®—**ï¼šåŸºäºç´¢å¼•è§£ç›˜ï¼Œæ— éœ€è§£å¯†
- ğŸ”‘ **é’±åŒ…å³å¯†é’¥**ï¼šæ— éœ€é¢å¤–å¯†é’¥ç®¡ç†
- ğŸ“Š **å­˜å‚¨ä¼˜åŒ–**ï¼šç´§å‡‘ç´¢å¼•è®¾è®¡

**create_encrypted_chart æ˜¯åŒºå—é“¾å…«å­—æ’ç›˜ç³»ç»Ÿçš„éšç§ä¿æŠ¤æ ¸å¿ƒåŠŸèƒ½ï¼Œå®Œç¾å¹³è¡¡äº†éšç§ä¿æŠ¤ä¸åŠŸèƒ½å®Œæ•´æ€§ã€‚**
