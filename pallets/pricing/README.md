# Pallet Pricing - MEMOä»·æ ¼ç®¡ç†ç³»ç»Ÿ

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

`pallet-pricing` æ˜¯Stardustç”Ÿæ€çš„**ä»·æ ¼å‘ç°ä¸èšåˆæ¨¡å—**ï¼ŒåŸºäºOTCå’ŒBridgeä¸¤ä¸ªå¸‚åœºçš„çœŸå®äº¤æ˜“æ•°æ®ï¼Œè®¡ç®—MEMOçš„å¸‚åœºåŠ æƒå‡ä»·ã€‚é‡‡ç”¨å¾ªç¯ç¼“å†²åŒº+æ»‘åŠ¨çª—å£ç®—æ³•ï¼Œç»´æŠ¤æœ€è¿‘100ä¸‡MEMOçš„ä»·æ ¼ç»Ÿè®¡ï¼Œä¸ºOTCè®¢å•å’Œæ¡¥æ¥å…‘æ¢æä¾›å¯é çš„ä»·æ ¼åŸºå‡†ã€‚

### è®¾è®¡ç†å¿µ

- **çœŸå®æ•°æ®é©±åŠ¨**ï¼šåŸºäºå®é™…æˆäº¤ä»·æ ¼ï¼Œéé¢„è¨€æœºå–‚ä»·
- **åŒå¸‚åœºèšåˆ**ï¼šOTC+Bridgeä»·æ ¼åŠ æƒå¹³å‡
- **æ»‘åŠ¨çª—å£**ï¼šæœ€è¿‘100ä¸‡MEMOäº¤æ˜“ï¼ŒåŠ¨æ€æ›´æ–°
- **å†·å¯åŠ¨ä¿æŠ¤**ï¼šåˆæœŸäº¤æ˜“é‡ä¸è¶³æ—¶ä½¿ç”¨é»˜è®¤ä»·æ ¼
- **å¾ªç¯ç¼“å†²åŒº**ï¼šæœ€å¤šå­˜å‚¨1ä¸‡ç¬”è®¢å•ï¼Œå†…å­˜é«˜æ•ˆ

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     OTCè®¢å•å®Œæˆ                      â”‚
â”‚  - ä»·æ ¼: 0.0102 USDT/MEMO           â”‚
â”‚  - æ•°é‡: 100 MEMO                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“ æ·»åŠ åˆ°èšåˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     OTCä»·æ ¼èšåˆ                      â”‚
â”‚  - ç´¯è®¡MEMO: 850,000                â”‚
â”‚  - ç´¯è®¡USDT: 8,670                  â”‚
â”‚  - å‡ä»·: 0.0102 USDT/MEMO           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Bridgeå…‘æ¢å®Œæˆ                   â”‚
â”‚  - ä»·æ ¼: 0.0098 USDT/MEMO           â”‚
â”‚  - æ•°é‡: 200 MEMO                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“ æ·»åŠ åˆ°èšåˆ
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Bridgeä»·æ ¼èšåˆ                   â”‚
â”‚  - ç´¯è®¡MEMO: 780,000                â”‚
â”‚  - ç´¯è®¡USDT: 7,644                  â”‚
â”‚  - å‡ä»·: 0.0098 USDT/MEMO           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â†“ åŠ æƒå¹³å‡
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     å¸‚åœºåŠ æƒå‡ä»·                     â”‚
â”‚  weighted_price = (OTC_price Ã— OTC_volume + Bridge_price Ã— Bridge_volume) / (OTC_volume + Bridge_volume)
â”‚  = (0.0102 Ã— 850,000 + 0.0098 Ã— 780,000) / (850,000 + 780,000)
â”‚  = 0.0100 USDT/MEMO
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½

### 1. ä»·æ ¼èšåˆç®—æ³•

#### å¾ªç¯ç¼“å†²åŒº
```rust
// å­˜å‚¨æœ€å¤š10,000ç¬”è®¢å•å¿«ç…§
pub type OtcOrderRingBuffer<T> = StorageMap<
    _,
    Blake2_128Concat,
    u32,  // ç´¢å¼• 0-9999
    OrderSnapshot,
>;

pub struct OrderSnapshot {
    pub timestamp: u64,         // æ—¶é—´æˆ³
    pub price_usdt: u64,        // USDTå•ä»·ï¼ˆç²¾åº¦10^6ï¼‰
    pub memo_qty: u128,         // MEMOæ•°é‡ï¼ˆç²¾åº¦10^12ï¼‰
}
```

#### æ»‘åŠ¨çª—å£èšåˆ
```rust
pub struct PriceAggregateData {
    pub total_memo: u128,       // ç´¯è®¡MEMOæ•°é‡
    pub total_usdt: u128,       // ç´¯è®¡USDTé‡‘é¢
    pub order_count: u32,       // è®¢å•æ•°é‡
    pub oldest_index: u32,      // æœ€æ—§è®¢å•ç´¢å¼•
    pub newest_index: u32,      // æœ€æ–°è®¢å•ç´¢å¼•
}
```

#### add_otc_order - æ·»åŠ OTCè®¢å•
```rust
pub fn add_otc_order(
    origin: OriginFor<T>,
    price_usdt: u64,
    memo_qty: u128,
    timestamp: u64,
) -> DispatchResult
```

**ç®—æ³•**ï¼š
1. æ·»åŠ æ–°è®¢å•åˆ°ç¼“å†²åŒº
2. ç´¯è®¡total_memoå’Œtotal_usdt
3. å¦‚æœtotal_memoè¶…è¿‡100ä¸‡MEMOï¼Œä»oldest_indexå¼€å§‹åˆ é™¤æ—§è®¢å•
4. æ›´æ–°èšåˆæ•°æ®å’Œå‡ä»·

### 2. å¸‚åœºä»·æ ¼è®¡ç®—

#### get_market_price - è·å–å¸‚åœºä»·æ ¼
```rust
impl<T: Config> PricingProvider for Pallet<T> {
    fn get_market_price() -> u64 {
        // 1. æ£€æŸ¥å†·å¯åŠ¨çŠ¶æ€
        if !Self::cold_start_exited() {
            let otc_volume = Self::otc_aggregate().total_memo;
            let bridge_volume = Self::bridge_aggregate().total_memo;
            let threshold = Self::cold_start_threshold();
            
            if otc_volume + bridge_volume < threshold {
                // è¿”å›é»˜è®¤ä»·æ ¼ï¼ˆ0.000001 USDT/MEMOï¼‰
                return Self::default_price();
            } else {
                // è¾¾åˆ°é˜ˆå€¼ï¼Œé€€å‡ºå†·å¯åŠ¨
                ColdStartExited::<T>::put(true);
            }
        }
        
        // 2. è®¡ç®—åŠ æƒå¹³å‡ä»·
        let otc_agg = Self::otc_aggregate();
        let bridge_agg = Self::bridge_aggregate();
        
        let otc_price = if otc_agg.total_memo > 0 {
            (otc_agg.total_usdt / otc_agg.total_memo) as u64
        } else {
            0
        };
        
        let bridge_price = if bridge_agg.total_memo > 0 {
            (bridge_agg.total_usdt / bridge_agg.total_memo) as u64
        } else {
            0
        };
        
        let total_volume = otc_agg.total_memo + bridge_agg.total_memo;
        if total_volume == 0 {
            return Self::default_price();
        }
        
        // åŠ æƒå¹³å‡
        let weighted_price = (
            (otc_price as u128 * otc_agg.total_memo) +
            (bridge_price as u128 * bridge_agg.total_memo)
        ) / total_volume;
        
        weighted_price as u64
    }
}
```

### 3. å†·å¯åŠ¨æœºåˆ¶

#### å†·å¯åŠ¨é˜ˆå€¼
```rust
pub type ColdStartThreshold<T> = StorageValue<_, u128, ValueQuery>;

// é»˜è®¤å€¼ï¼š100,000,000 MEMOï¼ˆ1äº¿ï¼‰
fn DefaultColdStartThreshold() -> u128 {
    100_000_000u128 * 1_000_000_000_000u128
}
```

#### é»˜è®¤ä»·æ ¼
```rust
pub type DefaultPrice<T> = StorageValue<_, u64, ValueQuery>;

// é»˜è®¤å€¼ï¼š1ï¼ˆ0.000001 USDT/MEMOï¼Œç²¾åº¦10^6ï¼‰
fn DefaultPriceValue() -> u64 {
    1u64
}
```

#### å•å‘é”å®šé€€å‡º
```rust
pub type ColdStartExited<T> = StorageValue<_, bool, ValueQuery>;
```

**è¯´æ˜**ï¼šä¸€æ—¦è¾¾åˆ°é˜ˆå€¼å¹¶é€€å‡ºå†·å¯åŠ¨ï¼Œæ­¤æ ‡è®°æ°¸ä¹…ä¸ºtrueï¼Œä¸å†å›é€€åˆ°é»˜è®¤ä»·æ ¼ã€‚é¿å…åœ¨é˜ˆå€¼é™„è¿‘ä»·æ ¼å‰§çƒˆæ³¢åŠ¨ã€‚

### 4. å¸‚åœºç»Ÿè®¡

#### get_market_stats - è·å–å¸‚åœºç»Ÿè®¡
```rust
pub fn get_market_stats() -> MarketStats {
    MarketStats {
        otc_price,          // OTCå‡ä»·
        bridge_price,       // Bridgeå‡ä»·
        weighted_price,     // åŠ æƒå¹³å‡ä»·
        simple_avg_price,   // ç®€å•å¹³å‡ä»·
        otc_volume,         // OTCäº¤æ˜“é‡
        bridge_volume,      // Bridgeäº¤æ˜“é‡
        total_volume,       // æ€»äº¤æ˜“é‡
        otc_order_count,    // OTCè®¢å•æ•°
        bridge_swap_count,  // Bridgeå…‘æ¢æ•°
    }
}
```

## ğŸ“¦ å­˜å‚¨ç»“æ„

### OTCä»·æ ¼èšåˆ
```rust
pub type OtcPriceAggregate<T> = StorageValue<_, PriceAggregateData, ValueQuery>;
pub type OtcOrderRingBuffer<T> = StorageMap<_, Blake2_128Concat, u32, OrderSnapshot>;
```

### Bridgeä»·æ ¼èšåˆ
```rust
pub type BridgePriceAggregate<T> = StorageValue<_, PriceAggregateData, ValueQuery>;
pub type BridgeOrderRingBuffer<T> = StorageMap<_, Blake2_128Concat, u32, OrderSnapshot>;
```

### å†·å¯åŠ¨é…ç½®
```rust
pub type ColdStartThreshold<T> = StorageValue<_, u128, ValueQuery>;
pub type DefaultPrice<T> = StorageValue<_, u64, ValueQuery>;
pub type ColdStartExited<T> = StorageValue<_, bool, ValueQuery>;
```

## ğŸ”§ é…ç½®å‚æ•°

```rust
pub trait Config: frame_system::Config {
    /// äº‹ä»¶ç±»å‹
    type RuntimeEvent: From<Event<Self>> + IsType<<Self as frame_system::Config>::RuntimeEvent>;

    /// æœ€å¤§ä»·æ ¼åç¦»ï¼ˆåŸºç‚¹ï¼Œé»˜è®¤2000 = 20%ï¼‰
    type MaxPriceDeviation: Get<u16>;
}
```

## ğŸ“¡ å¯è°ƒç”¨æ¥å£

### æ•°æ®æäº¤æ¥å£

#### 1. add_otc_order - æ·»åŠ OTCè®¢å•
```rust
#[pallet::call_index(0)]
pub fn add_otc_order(
    origin: OriginFor<T>,
    price_usdt: u64,
    memo_qty: u128,
    timestamp: u64,
) -> DispatchResult
```

#### 2. add_bridge_swap - æ·»åŠ Bridgeå…‘æ¢
```rust
#[pallet::call_index(1)]
pub fn add_bridge_swap(
    origin: OriginFor<T>,
    price_usdt: u64,
    memo_qty: u128,
    timestamp: u64,
) -> DispatchResult
```

### æ²»ç†æ¥å£

#### 3. set_cold_start_threshold - è®¾ç½®å†·å¯åŠ¨é˜ˆå€¼
```rust
#[pallet::call_index(2)]
pub fn set_cold_start_threshold(
    origin: OriginFor<T>,
    threshold: u128,
) -> DispatchResult
```

#### 4. set_default_price - è®¾ç½®é»˜è®¤ä»·æ ¼
```rust
#[pallet::call_index(3)]
pub fn set_default_price(
    origin: OriginFor<T>,
    price: u64,
) -> DispatchResult
```

## ğŸ‰ äº‹ä»¶

### OtcOrderAdded - OTCè®¢å•æ·»åŠ äº‹ä»¶
```rust
OtcOrderAdded {
    price_usdt: u64,
    memo_qty: u128,
    new_avg_price: u64,
}
```

### BridgeSwapAdded - Bridgeå…‘æ¢æ·»åŠ äº‹ä»¶
```rust
BridgeSwapAdded {
    price_usdt: u64,
    memo_qty: u128,
    new_avg_price: u64,
}
```

### ColdStartExited - å†·å¯åŠ¨é€€å‡ºäº‹ä»¶
```rust
ColdStartExited {
    final_volume: u128,
}
```

## ğŸ”Œ ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯1ï¼šOTCè®¢å•å®Œæˆåæäº¤ä»·æ ¼

```rust
// pallet-otc-orderè°ƒç”¨
pallet_pricing::Pallet::<T>::add_otc_order(
    system_origin,
    10_200u64,  // 0.0102 USDT/MEMOï¼ˆç²¾åº¦10^6ï¼‰
    100_000_000_000_000u128,  // 100 MEMO
    current_timestamp,
)?;

// æŸ¥è¯¢æœ€æ–°å¸‚åœºä»·æ ¼
let market_price = <pallet_pricing::Pallet<T> as PricingProvider>::get_market_price();
// market_price = 10_000 (0.01 USDT/MEMO)
```

### åœºæ™¯2ï¼šåˆ›å»ºOTCè®¢å•æ—¶ä½¿ç”¨å¸‚åœºä»·æ ¼

```rust
// 1. è·å–å¸‚åœºä»·æ ¼
let base_price = <T::PricingProvider as PricingProvider>::get_market_price();
// base_price = 10_000 (0.01 USDT/MEMO)

// 2. åº”ç”¨åšå¸‚å•†æº¢ä»·
let maker_premium_bps = 200; // +2%
let final_price = base_price * (10000 + maker_premium_bps) / 10000;
// final_price = 10_200 (0.0102 USDT/MEMO)

// 3. è®¡ç®—è®¢å•é‡‘é¢
let usdt_amount = (qty * final_price) / 1_000_000_000_000;
```

## ğŸ›¡ï¸ å®‰å…¨æœºåˆ¶

### 1. æ»‘åŠ¨çª—å£

- æœ€è¿‘100ä¸‡MEMOäº¤æ˜“
- é˜²æ­¢å†å²ä»·æ ¼å½±å“
- åŠ¨æ€åæ˜ å¸‚åœºå˜åŒ–

### 2. å†·å¯åŠ¨ä¿æŠ¤

- åˆæœŸäº¤æ˜“é‡ä¸è¶³æ—¶ä½¿ç”¨é»˜è®¤ä»·æ ¼
- é¿å…æç«¯ä»·æ ¼
- å•å‘é”å®šé€€å‡º

### 3. å¾ªç¯ç¼“å†²åŒº

- æœ€å¤šå­˜å‚¨1ä¸‡ç¬”è®¢å•
- å†…å­˜é«˜æ•ˆ
- è‡ªåŠ¨æ¸…ç†æ—§æ•°æ®

### 4. åŒå¸‚åœºèšåˆ

- OTC+Bridgeä»·æ ¼åŠ æƒ
- å…¨é¢åæ˜ å¸‚åœº
- é˜²æ­¢å•ä¸€å¸‚åœºæ“çºµ

## ğŸ“ æœ€ä½³å®è·µ

### 1. ä»·æ ¼ä½¿ç”¨

- æ€»æ˜¯ä½¿ç”¨`get_market_price()`è·å–æœ€æ–°ä»·æ ¼
- åº”ç”¨åšå¸‚å•†æº¢ä»·å‰å…ˆè·å–åŸºå‡†ä»·
- æ£€æŸ¥å†·å¯åŠ¨çŠ¶æ€

### 2. æ•°æ®æäº¤

- OTCè®¢å•é‡Šæ”¾åç«‹å³æäº¤
- Bridgeå…‘æ¢å®Œæˆåç«‹å³æäº¤
- æäº¤å‡†ç¡®çš„ä»·æ ¼å’Œæ•°é‡

### 3. ç›‘æ§æŒ‡æ ‡

- å†·å¯åŠ¨çŠ¶æ€
- OTC/Bridgeäº¤æ˜“é‡
- ä»·æ ¼åç¦»ç¨‹åº¦
- ç¼“å†²åŒºä½¿ç”¨ç‡

## ğŸ”— ç›¸å…³æ¨¡å—

- **pallet-otc-order**: OTCè®¢å•ï¼ˆä½¿ç”¨å¸‚åœºä»·æ ¼ï¼‰
- **pallet-simple-bridge**: æ¡¥æ¥å…‘æ¢ï¼ˆä½¿ç”¨å¸‚åœºä»·æ ¼ï¼‰
- **pallet-market-maker**: åšå¸‚å•†ç®¡ç†ï¼ˆåº”ç”¨æº¢ä»·ï¼‰

## ğŸ“š å‚è€ƒèµ„æº

- [ä»·æ ¼èšåˆç®—æ³•](../../docs/pricing-aggregation-algorithm.md)
- [æ»‘åŠ¨çª—å£è®¾è®¡](../../docs/sliding-window-design.md)
- [å†·å¯åŠ¨ç­–ç•¥](../../docs/cold-start-strategy.md)

---

**ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2025-10-27  
**ç»´æŠ¤è€…**: Stardust å¼€å‘å›¢é˜Ÿ
