# Pallet Affiliate - è”ç›Ÿè®¡é…¬æ‰˜ç®¡å±‚

## ğŸ“‹ æ¨¡å—æ¦‚è¿°

`pallet-affiliate` æ˜¯è”ç›Ÿè®¡é…¬ç³»ç»Ÿçš„**èµ„é‡‘æ‰˜ç®¡å±‚**ï¼Œä¸“æ³¨äºMEMOèµ„é‡‘çš„å®‰å…¨æ‰˜ç®¡ä¸ç®¡ç†ã€‚æœ¬æ¨¡å—èŒè´£å•ä¸€ï¼šåªè´Ÿè´£èµ„é‡‘çš„å­˜å…¥ã€æå–å’Œä½™é¢æŸ¥è¯¢ï¼Œä¸æ¶‰åŠåˆ†é…é€»è¾‘ï¼Œç¡®ä¿èµ„é‡‘å®‰å…¨éš”ç¦»ã€‚

### è®¾è®¡ç†å¿µ

- **å•ä¸€èŒè´£**ï¼šåªç®¡ç†èµ„é‡‘æ‰˜ç®¡ï¼Œåˆ†é…é€»è¾‘ç”±å…¶ä»–palletå®ç°
- **èµ„é‡‘éš”ç¦»**ï¼šä½¿ç”¨ç‹¬ç«‹çš„æ‰˜ç®¡è´¦æˆ·(`*b"affiliat"`)ï¼Œä¸OTCæ‰˜ç®¡è´¦æˆ·å®Œå…¨éš”ç¦»
- **æ¥å£æ¸…æ™°**ï¼šæä¾›ç®€æ´çš„å­˜å–æ¥å£ï¼Œä¾›åˆ†é…æ¨¡å—è°ƒç”¨

## ğŸ—ï¸ æ¶æ„è®¾è®¡

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pallet-affiliate     â”‚ â† æ‰˜ç®¡å±‚ï¼ˆæœ¬æ¨¡å—ï¼‰
â”‚ - æ‰˜ç®¡èµ„é‡‘           â”‚    æä¾›æ‰˜ç®¡è´¦æˆ·
â”‚ - å­˜å–æ¥å£           â”‚    ç®¡ç†èµ„é‡‘è¿›å‡º
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†‘
         â”‚ è°ƒç”¨æ‰˜ç®¡è´¦æˆ·
         â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pallet-affiliate-weekly       â”‚ â† åˆ†é…å±‚
â”‚ - åˆ†é…é€»è¾‘                     â”‚    å‘¨æœŸç»“ç®—
â”‚ - å‘¨æœŸç»“ç®—                     â”‚    ä»æ‰˜ç®¡è´¦æˆ·æå–
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸å…¶ä»–æ¨¡å—çš„å…³ç³»

| æ¨¡å— | å…³ç³» | è¯´æ˜ |
|------|------|------|
| `pallet-affiliate-instant` | å¹³è¡Œ | å³æ—¶åˆ†æˆå·¥å…·ï¼Œèµ„é‡‘ç”±è°ƒç”¨æ–¹ä¼ å…¥ |
| `pallet-affiliate-weekly` | è°ƒç”¨è€… | å‘¨ç»“ç®—å·¥å…·ï¼Œèµ„é‡‘ä»æœ¬æ‰˜ç®¡å±‚è¯»å– |
| `pallet-affiliate-config` | åè°ƒè€… | é…ç½®ç®¡ç†ï¼Œåè°ƒå³æ—¶å’Œå‘¨ç»“ç®—æ¨¡å¼ |
| `pallet-memo-offerings` | èµ„é‡‘æ¥æº | ä¾›å¥‰æ”¶å…¥é€šè¿‡å¤šè·¯åˆ†è´¦æµå…¥æ‰˜ç®¡ |

## ğŸ”‘ æ ¸å¿ƒåŠŸèƒ½

### 1. æ‰˜ç®¡è´¦æˆ·ç®¡ç†

- **ç‹¬ç«‹è´¦æˆ·**ï¼šä½¿ç”¨ `AffiliatePalletId (*b"affiliat")` æ´¾ç”Ÿæ‰˜ç®¡è´¦æˆ·
- **èµ„é‡‘éš”ç¦»**ï¼šä¸OTCæ‰˜ç®¡è´¦æˆ·å®Œå…¨éš”ç¦»ï¼Œèµ„é‡‘å®‰å…¨ç‹¬ç«‹
- **è´¦æˆ·æŸ¥è¯¢**ï¼šæä¾› `escrow_account()` æ–¹æ³•è·å–æ‰˜ç®¡è´¦æˆ·åœ°å€

### 2. èµ„é‡‘å­˜å–æ¥å£

#### å­˜å…¥æ¥å£
```rust
/// å½’é›†èµ„é‡‘åˆ°æ‰˜ç®¡è´¦æˆ·
fn deposit(from: &AccountId, amount: Balance) -> Result<(), &'static str>
```
- **æƒé™**ï¼šä»»ä½•è´¦æˆ·éƒ½å¯ä»¥å‘æ‰˜ç®¡è´¦æˆ·è½¬è´¦
- **ç”¨é€”**ï¼šä¾›å¥‰ç³»ç»Ÿå½’é›†èµ„é‡‘åˆ°æ‰˜ç®¡æ± 

#### æå–æ¥å£
```rust
/// ä»æ‰˜ç®¡è´¦æˆ·æå–èµ„é‡‘ï¼ˆä»…ä¾›æˆæƒæ¨¡å—è°ƒç”¨ï¼‰
fn withdraw(to: &AccountId, amount: Balance) -> Result<(), &'static str>
```
- **æƒé™**ï¼šåªæœ‰æˆæƒçš„åˆ†é…æ¨¡å—å¯ä»¥æå–èµ„é‡‘
- **ç”¨é€”**ï¼šåˆ†é…ç³»ç»Ÿä»æ‰˜ç®¡æ± æå–èµ„é‡‘è¿›è¡Œåˆ†æˆ

### 3. ä½™é¢æŸ¥è¯¢

```rust
/// æŸ¥è¯¢æ‰˜ç®¡è´¦æˆ·ä½™é¢
fn escrow_balance() -> Balance
```
- **å®æ—¶æŸ¥è¯¢**ï¼šè¿”å›å½“å‰æ‰˜ç®¡è´¦æˆ·çš„å¯ç”¨ä½™é¢
- **æ— æƒé™é™åˆ¶**ï¼šä»»ä½•äººéƒ½å¯ä»¥æŸ¥è¯¢

## ğŸ“¦ å­˜å‚¨ç»“æ„

### ç´¯è®¡å­˜å…¥é‡‘é¢
```rust
pub type TotalDeposited<T: Config> = StorageValue<_, BalanceOf<T>, ValueQuery>;
```
- **ç”¨é€”**ï¼šç»Ÿè®¡ç´¯è®¡å­˜å…¥é‡‘é¢ï¼ˆåªå¢ä¸å‡ï¼‰
- **ç±»å‹**ï¼šBalance
- **åˆå§‹å€¼**ï¼š0

### ç´¯è®¡æå–é‡‘é¢
```rust
pub type TotalWithdrawn<T: Config> = StorageValue<_, BalanceOf<T>, ValueQuery>;
```
- **ç”¨é€”**ï¼šç»Ÿè®¡ç´¯è®¡æå–é‡‘é¢ï¼ˆåªå¢ä¸å‡ï¼‰
- **ç±»å‹**ï¼šBalance
- **åˆå§‹å€¼**ï¼š0

## ğŸ”§ é…ç½®å‚æ•°

```rust
pub trait Config: frame_system::Config {
    /// äº‹ä»¶ç±»å‹
    type RuntimeEvent: From<Event<Self>> + IsType<<Self as frame_system::Config>::RuntimeEvent>;

    /// è´§å¸ç³»ç»Ÿ
    type Currency: Currency<Self::AccountId>;

    /// æ‰˜ç®¡ PalletIdï¼ˆæ´¾ç”Ÿç‹¬ç«‹çš„æ‰˜ç®¡è´¦æˆ·ï¼‰
    type EscrowPalletId: Get<PalletId>;

    /// ææ¬¾æƒé™æ§åˆ¶
    /// å¦‚æœè®¾ç½®ï¼Œåˆ™åªæœ‰æŒ‡å®šçš„ Origin å¯ä»¥è°ƒç”¨ withdraw
    type WithdrawOrigin: EnsureOrigin<Self::RuntimeOrigin>;
}
```

### Runtime é…ç½®ç¤ºä¾‹

```rust
impl pallet_affiliate::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type Currency = Balances;
    type EscrowPalletId = AffiliatePalletId;
    type WithdrawOrigin = EnsureRoot<AccountId>; // æˆ–å§”å‘˜ä¼šå¤šç­¾
}

parameter_types! {
    pub const AffiliatePalletId: PalletId = PalletId(*b"affiliat");
}
```

## ğŸ“¡ å¯è°ƒç”¨æ¥å£

### 1. deposit - å­˜å…¥èµ„é‡‘

```rust
#[pallet::call_index(0)]
#[pallet::weight(Weight::from_parts(10_000_000, 0))]
pub fn deposit(
    origin: OriginFor<T>,
    amount: BalanceOf<T>,
) -> DispatchResult
```

**å‚æ•°è¯´æ˜**ï¼š
- `origin`: ç­¾åè´¦æˆ·ï¼ˆå­˜æ¬¾äººï¼‰
- `amount`: å­˜æ¬¾é‡‘é¢

**åŠŸèƒ½**ï¼š
- ä»è°ƒç”¨è€…è´¦æˆ·è½¬è´¦åˆ°æ‰˜ç®¡è´¦æˆ·
- æ›´æ–°ç´¯è®¡å­˜å…¥é‡‘é¢ç»Ÿè®¡
- è§¦å‘ `Deposited` äº‹ä»¶

**æƒé™**ï¼šä»»ä½•ç­¾åè´¦æˆ·

**ç¤ºä¾‹**ï¼š
```rust
// ç”¨æˆ·å‘æ‰˜ç®¡è´¦æˆ·å­˜å…¥ 1000 MEMO
affiliate::deposit(origin, 1_000_000_000_000)?;
```

### 2. withdraw - æå–èµ„é‡‘

```rust
#[pallet::call_index(1)]
#[pallet::weight(Weight::from_parts(10_000_000, 0))]
pub fn withdraw(
    origin: OriginFor<T>,
    to: T::AccountId,
    amount: BalanceOf<T>,
) -> DispatchResult
```

**å‚æ•°è¯´æ˜**ï¼š
- `origin`: æˆæƒæ¥æºï¼ˆRootæˆ–å§”å‘˜ä¼šï¼‰
- `to`: æ¥æ”¶è€…è´¦æˆ·
- `amount`: æå–é‡‘é¢

**åŠŸèƒ½**ï¼š
- ä»æ‰˜ç®¡è´¦æˆ·è½¬è´¦åˆ°æŒ‡å®šè´¦æˆ·
- æ›´æ–°ç´¯è®¡æå–é‡‘é¢ç»Ÿè®¡
- è§¦å‘ `Withdrawn` äº‹ä»¶

**æƒé™**ï¼šåªæœ‰ `WithdrawOrigin` æˆæƒçš„è´¦æˆ·

**æ ¡éªŒ**ï¼š
- âœ… éªŒè¯è°ƒç”¨è€…æƒé™
- âœ… æ£€æŸ¥é‡‘é¢ä¸ä¸ºé›¶
- âœ… ç¡®ä¿æ‰˜ç®¡è´¦æˆ·ä½™é¢å……è¶³

**ç¤ºä¾‹**ï¼š
```rust
// Root ä»æ‰˜ç®¡è´¦æˆ·æå– 500 MEMO åˆ°ç”¨æˆ·è´¦æˆ·
affiliate::withdraw(RootOrigin, user_account, 500_000_000_000)?;
```

## ğŸ‰ äº‹ä»¶

### Deposited - èµ„é‡‘å­˜å…¥äº‹ä»¶
```rust
Deposited {
    from: T::AccountId,
    amount: BalanceOf<T>,
}
```

**è§¦å‘æ—¶æœº**ï¼šæˆåŠŸå­˜å…¥èµ„é‡‘æ—¶

**å‚æ•°è¯´æ˜**ï¼š
- `from`: å­˜æ¬¾äººè´¦æˆ·
- `amount`: å­˜æ¬¾é‡‘é¢

### Withdrawn - èµ„é‡‘æå–äº‹ä»¶
```rust
Withdrawn {
    to: T::AccountId,
    amount: BalanceOf<T>,
}
```

**è§¦å‘æ—¶æœº**ï¼šæˆåŠŸæå–èµ„é‡‘æ—¶

**å‚æ•°è¯´æ˜**ï¼š
- `to`: æ¥æ”¶è€…è´¦æˆ·
- `amount`: æå–é‡‘é¢

## âŒ é”™è¯¯å¤„ç†

### ZeroAmount
- **è¯´æ˜**ï¼šé‡‘é¢ä¸ºé›¶
- **è§¦å‘**ï¼šå­˜å…¥æˆ–æå–é‡‘é¢ä¸º 0 æ—¶

### InsufficientEscrowBalance
- **è¯´æ˜**ï¼šæ‰˜ç®¡è´¦æˆ·ä½™é¢ä¸è¶³
- **è§¦å‘**ï¼šæå–é‡‘é¢è¶…è¿‡æ‰˜ç®¡è´¦æˆ·ä½™é¢æ—¶

### Unauthorized
- **è¯´æ˜**ï¼šæœªæˆæƒçš„ææ¬¾æ“ä½œ
- **è§¦å‘**ï¼šéæˆæƒè´¦æˆ·è°ƒç”¨ withdraw æ—¶

## ğŸ”Œ Trait æ¥å£

### EscrowProvider Trait

æœ¬æ¨¡å—å®ç° `EscrowProvider` traitï¼Œä¾›å…¶ä»–æ¨¡å—è°ƒç”¨ï¼š

```rust
pub trait EscrowProvider<AccountId, Balance> {
    /// è·å–æ‰˜ç®¡è´¦æˆ·åœ°å€
    fn escrow_account() -> AccountId;
    
    /// æŸ¥è¯¢æ‰˜ç®¡è´¦æˆ·ä½™é¢
    fn escrow_balance() -> Balance;
    
    /// å½’é›†èµ„é‡‘åˆ°æ‰˜ç®¡è´¦æˆ·
    fn deposit(from: &AccountId, amount: Balance) -> Result<(), &'static str>;
    
    /// ä»æ‰˜ç®¡è´¦æˆ·æå–èµ„é‡‘
    fn withdraw(to: &AccountId, amount: Balance) -> Result<(), &'static str>;
}
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```rust
// å…¶ä»–æ¨¡å—è°ƒç”¨æ‰˜ç®¡æœåŠ¡
let escrow_account = AffiliateEscrow::escrow_account();
let balance = AffiliateEscrow::escrow_balance();
AffiliateEscrow::deposit(&user, 1000)?;
```

## ğŸ“Š èµ„é‡‘æµå‘å›¾

```text
ç”¨æˆ·ä¾›å¥‰
   â†“
å¤šè·¯åˆ†è´¦ï¼ˆpallet-memo-offeringsï¼‰
   â†“
è”ç›Ÿè®¡é…¬æ‰˜ç®¡è´¦æˆ·ï¼ˆæœ¬æ¨¡å—ï¼‰
   â†“
   â”œâ”€â†’ [å‘¨ç»“ç®—æ¨¡å¼] â†’ pallet-affiliate-weekly â†’ å‘¨æœŸæ‰¹é‡åˆ†é…
   â””â”€â†’ [å³æ—¶åˆ†æˆæ¨¡å¼] â†’ pallet-affiliate-instant â†’ å®æ—¶åˆ†é…
```

## ğŸ›¡ï¸ å®‰å…¨æœºåˆ¶

1. **æƒé™éš”ç¦»**
   - å­˜æ¬¾ï¼šä»»ä½•äººå¯ä»¥å­˜
   - ææ¬¾ï¼šåªæœ‰æˆæƒæ¨¡å—å¯ä»¥æ

2. **ä½™é¢æ ¡éªŒ**
   - ææ¬¾å‰å¿…é¡»æ£€æŸ¥ä½™é¢å……è¶³
   - ä½¿ç”¨ `saturating_add/sub` é˜²æ­¢æº¢å‡º

3. **è´¦æˆ·éš”ç¦»**
   - ç‹¬ç«‹çš„ PalletId æ´¾ç”Ÿè´¦æˆ·
   - ä¸OTCæ‰˜ç®¡è´¦æˆ·å®Œå…¨éš”ç¦»

4. **å®¡è®¡è¿½è¸ª**
   - è®°å½•ç´¯è®¡å­˜å…¥/æå–é‡‘é¢
   - æ‰€æœ‰æ“ä½œè§¦å‘äº‹ä»¶

## ğŸ“ˆ ç»Ÿè®¡æŸ¥è¯¢

### æŸ¥è¯¢æ‰˜ç®¡è´¦æˆ·åœ°å€
```rust
let escrow_account = Affiliate::escrow_account();
```

### æŸ¥è¯¢å½“å‰ä½™é¢
```rust
let balance = Affiliate::escrow_balance();
```

### æŸ¥è¯¢ç´¯è®¡å­˜å…¥
```rust
let total_deposited = Affiliate::total_deposited();
```

### æŸ¥è¯¢ç´¯è®¡æå–
```rust
let total_withdrawn = Affiliate::total_withdrawn();
```

## ğŸ”„ å·¥ä½œæµç¨‹

### å­˜å…¥æµç¨‹
1. ç”¨æˆ·è°ƒç”¨ `deposit(amount)`
2. éªŒè¯é‡‘é¢ä¸ä¸ºé›¶
3. ä»ç”¨æˆ·è´¦æˆ·è½¬è´¦åˆ°æ‰˜ç®¡è´¦æˆ·
4. æ›´æ–°ç´¯è®¡å­˜å…¥é‡‘é¢
5. è§¦å‘ `Deposited` äº‹ä»¶

### æå–æµç¨‹
1. æˆæƒæ¨¡å—è°ƒç”¨ `withdraw(to, amount)`
2. éªŒè¯è°ƒç”¨è€…æƒé™
3. éªŒè¯é‡‘é¢ä¸ä¸ºé›¶
4. æ£€æŸ¥æ‰˜ç®¡è´¦æˆ·ä½™é¢å……è¶³
5. ä»æ‰˜ç®¡è´¦æˆ·è½¬è´¦åˆ°ç›®æ ‡è´¦æˆ·
6. æ›´æ–°ç´¯è®¡æå–é‡‘é¢
7. è§¦å‘ `Withdrawn` äº‹ä»¶

## ğŸ“ æœ€ä½³å®è·µ

1. **åˆ†ç¦»èŒè´£**
   - æ‰˜ç®¡å±‚åªç®¡èµ„é‡‘å­˜å–
   - åˆ†é…é€»è¾‘ç”±å…¶ä»–æ¨¡å—å®ç°

2. **æƒé™æ§åˆ¶**
   - ææ¬¾æƒé™åº”é…ç½®ä¸º Root æˆ–å¤šç­¾å§”å‘˜ä¼š
   - é¿å…å•ç‚¹æ•…éšœ

3. **ç›‘æ§å®¡è®¡**
   - å®šæœŸæ£€æŸ¥ç´¯è®¡å­˜å…¥/æå–é‡‘é¢æ˜¯å¦ä¸€è‡´
   - ç›‘æ§æ‰˜ç®¡è´¦æˆ·ä½™é¢å˜åŒ–

4. **æµ‹è¯•è¦†ç›–**
   - æµ‹è¯•å­˜å…¥/æå–æ­£å¸¸æµç¨‹
   - æµ‹è¯•æƒé™æ ¡éªŒ
   - æµ‹è¯•ä½™é¢ä¸è¶³æƒ…å†µ

## ğŸ”— ç›¸å…³æ¨¡å—

- **pallet-affiliate-config**: è”ç›Ÿè®¡é…¬é…ç½®ç®¡ç†
- **pallet-affiliate-instant**: å³æ—¶åˆ†æˆç³»ç»Ÿ
- **pallet-affiliate-weekly**: å‘¨ç»“ç®—åˆ†é…å±‚
- **pallet-memo-offerings**: ä¾›å¥‰ç³»ç»Ÿï¼ˆèµ„é‡‘æ¥æºï¼‰

## ğŸ“š å‚è€ƒèµ„æº

- [Substrate Currency Trait](https://docs.rs/frame-support/latest/frame_support/traits/tokens/currency/trait.Currency.html)
- [PalletId è´¦æˆ·æ´¾ç”Ÿ](https://docs.rs/frame-support/latest/frame_support/traits/trait.AccountIdConversion.html)
- [è”ç›Ÿè®¡é…¬ç³»ç»Ÿæ¶æ„è®¾è®¡](../../docs/affiliate-architecture.md)

---

**ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2025-10-27  
**ç»´æŠ¤è€…**: Stardust å¼€å‘å›¢é˜Ÿ
