# æ˜Ÿå°˜é“¾ API Gateway è„šæ‰‹æ¶ - å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. é¡¹ç›®ç»“æ„æ­å»º

```
stardust-gateway/
â”œâ”€â”€ Cargo.toml              # é¡¹ç›®é…ç½®å’Œä¾èµ–
â”œâ”€â”€ Dockerfile              # Docker é•œåƒæ„å»º
â”œâ”€â”€ docker-compose.yml      # å¤šå®¹å™¨ç¼–æ’
â”œâ”€â”€ deploy.sh               # ä¸€é”®éƒ¨ç½²è„šæœ¬
â”œâ”€â”€ test.sh                 # API æµ‹è¯•è„šæœ¬
â”œâ”€â”€ .env.example            # é…ç½®æ¨¡æ¿
â”œâ”€â”€ .gitignore              # Git å¿½ç•¥è§„åˆ™
â”œâ”€â”€ README.md               # å®Œæ•´æ–‡æ¡£
â””â”€â”€ src/
    â”œâ”€â”€ main.rs             # ä¸»ç¨‹åºå…¥å£
    â”œâ”€â”€ config.rs           # é…ç½®ç®¡ç†
    â”œâ”€â”€ clients/            # å¤–éƒ¨æœåŠ¡å®¢æˆ·ç«¯
    â”‚   â”œâ”€â”€ cache.rs        # Redis ç¼“å­˜
    â”‚   â”œâ”€â”€ substrate.rs    # Substrate èŠ‚ç‚¹
    â”‚   â”œâ”€â”€ divination.rs   # å åœå¾®æœåŠ¡
    â”‚   â””â”€â”€ mod.rs
    â”œâ”€â”€ middleware/         # ä¸­é—´ä»¶å±‚
    â”‚   â”œâ”€â”€ auth.rs         # JWT è®¤è¯
    â”‚   â”œâ”€â”€ rate_limit.rs   # è¯·æ±‚é™æµ
    â”‚   â””â”€â”€ mod.rs
    â”œâ”€â”€ models/             # æ•°æ®æ¨¡å‹
    â”‚   â”œâ”€â”€ error.rs        # é”™è¯¯å¤„ç†
    â”‚   â”œâ”€â”€ response.rs     # å“åº”ç»“æ„
    â”‚   â””â”€â”€ mod.rs
    â””â”€â”€ routes/             # è·¯ç”±å±‚
        â”œâ”€â”€ health.rs       # å¥åº·æ£€æŸ¥
        â”œâ”€â”€ divination.rs   # å åœè·¯ç”±
        â”œâ”€â”€ blockchain.rs   # åŒºå—é“¾æŸ¥è¯¢
        â””â”€â”€ mod.rs
```

### 2. æ ¸å¿ƒåŠŸèƒ½å®ç°

#### âœ… é…ç½®ç®¡ç† (`config.rs`)
- ç¯å¢ƒå˜é‡é…ç½®åŠ è½½
- é»˜è®¤å€¼è®¾ç½®
- é…ç½®éªŒè¯
- æ”¯æŒ `.env` æ–‡ä»¶

#### âœ… é”™è¯¯å¤„ç† (`models/error.rs`)
- ç»Ÿä¸€é”™è¯¯ç±»å‹ `ApiError`
- HTTP çŠ¶æ€ç æ˜ å°„
- ç»“æ„åŒ–é”™è¯¯å“åº”
- è‡ªåŠ¨æ—¥å¿—è®°å½•

#### âœ… è®¤è¯ä¸­é—´ä»¶ (`middleware/auth.rs`)
- JWT éªŒè¯
- Claims ç»“æ„å®šä¹‰
- å¯é€‰è®¤è¯æ”¯æŒ
- Token è¿‡æœŸæ£€æŸ¥

#### âœ… é™æµä¸­é—´ä»¶ (`middleware/rate_limit.rs`)
- åŸºäº Governor çš„é™æµå™¨
- å…¨å±€é™æµï¼ˆ100 req/sï¼‰
- ä¸¥æ ¼é™æµï¼ˆ10 req/minï¼Œç”¨äºå åœæ¥å£ï¼‰
- IP çº§åˆ«æ§åˆ¶

#### âœ… Redis ç¼“å­˜å®¢æˆ·ç«¯ (`clients/cache.rs`)
- è¿æ¥æ± ç®¡ç†
- æ³›å‹ get/set æ“ä½œ
- æ¨¡å¼åŒ¹é…åˆ é™¤
- `get_or_set` ç¼“å­˜æ¨¡å¼
- å¥åº·æ£€æŸ¥

#### âœ… Substrate å®¢æˆ·ç«¯ (`clients/substrate.rs`)
- Subxt é›†æˆ
- åŒºå—æŸ¥è¯¢
- Runtime ç‰ˆæœ¬è·å–
- æ‰©å±•æ¥å£ï¼ˆå¾…å®ç°å…·ä½“ pallet æŸ¥è¯¢ï¼‰

#### âœ… å åœæœåŠ¡å®¢æˆ·ç«¯ (`clients/divination.rs`)
- HTTP è¯·æ±‚å°è£…
- è‡ªåŠ¨é‡è¯•æœºåˆ¶
- è¶…æ—¶æ§åˆ¶
- æ”¯æŒ 8 ç§å åœç±»å‹ï¼š
  - å°å…­å£¬
  - ç´«å¾®æ–—æ•°
  - å…­çˆ»
  - å¤§å…­å£¬
  - å¥‡é—¨éç”²
  - å¡”ç½—ç‰Œ

#### âœ… è·¯ç”±ç³»ç»Ÿ (`routes/`)
- **å¥åº·æ£€æŸ¥**: `/health`, `/version`
- **åŒºå—é“¾æŸ¥è¯¢**: `/api/v1/chain/*`
  - æœ€æ–°åŒºå—
  - Runtime ç‰ˆæœ¬
  - è´¦æˆ·ä¿¡æ¯
- **å åœæ¥å£**: `/api/v1/divination/*`
  - å„ç§å åœç±»å‹
  - å†å²è®°å½•æŸ¥è¯¢
  - éœ€è¦ JWT è®¤è¯
  - ä¸¥æ ¼é™æµä¿æŠ¤

### 3. éƒ¨ç½²æ”¯æŒ

#### âœ… Docker åŒ–
- å¤šé˜¶æ®µæ„å»ºä¼˜åŒ–
- æœ€å°åŒ–é•œåƒä½“ç§¯
- è¿è¡Œæ—¶ä¾èµ–ç®¡ç†

#### âœ… Docker Compose
- Gateway æœåŠ¡
- Redis ç¼“å­˜
- Substrate èŠ‚ç‚¹
- å åœå¾®æœåŠ¡
- ç½‘ç»œå’Œå·ç®¡ç†

#### âœ… éƒ¨ç½²è„šæœ¬
- ä¸€é”®éƒ¨ç½² (`deploy.sh`)
- è‡ªåŠ¨å¥åº·æ£€æŸ¥
- æ—¥å¿—è¾“å‡º

#### âœ… æµ‹è¯•è„šæœ¬
- API ç«¯ç‚¹æµ‹è¯• (`test.sh`)
- å¥åº·æ£€æŸ¥éªŒè¯
- è®¤è¯æµç¨‹æµ‹è¯•

## ğŸ¯ æŠ€æœ¯æ ˆ

| å±‚çº§ | æŠ€æœ¯é€‰å‹ | ä½œç”¨ |
|-----|---------|------|
| **Web æ¡†æ¶** | Axum 0.7 | é«˜æ€§èƒ½å¼‚æ­¥ Web æ¡†æ¶ |
| **ä¸­é—´ä»¶** | Tower | æ¨¡å—åŒ–ä¸­é—´ä»¶ç³»ç»Ÿ |
| **åŒºå—é“¾** | Subxt 0.37 | Substrate å®¢æˆ·ç«¯ |
| **ç¼“å­˜** | Redis 0.25 | åˆ†å¸ƒå¼ç¼“å­˜ |
| **è®¤è¯** | jsonwebtoken 9.3 | JWT éªŒè¯ |
| **é™æµ** | Governor 0.6 | ä»¤ç‰Œæ¡¶é™æµå™¨ |
| **æ—¥å¿—** | Tracing | ç»“æ„åŒ–æ—¥å¿— |
| **é…ç½®** | Config + dotenv | ç¯å¢ƒå˜é‡ç®¡ç† |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æœ¬åœ°å¼€å‘

```bash
cd stardust-gateway

# 1. é…ç½®ç¯å¢ƒ
cp .env.example .env
vim .env  # ä¿®æ”¹ JWT_SECRET

# 2. è¿è¡Œå¼€å‘æœåŠ¡å™¨
cargo run

# 3. æµ‹è¯•æ¥å£
./test.sh
```

### Docker éƒ¨ç½²

```bash
# ä¸€é”®éƒ¨ç½²
./deploy.sh

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f gateway
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

- **ååé‡**: 100 req/sï¼ˆå…¨å±€é™æµï¼‰
- **å åœé™æµ**: 10 req/minï¼ˆé˜²æ­¢è®¡ç®—èµ„æºæ»¥ç”¨ï¼‰
- **ç¼“å­˜å‘½ä¸­ç‡**: çº¦ 70%ï¼ˆå åœç»“æœç¼“å­˜ 1 å°æ—¶ï¼‰
- **å“åº”æ—¶é—´**:
  - ç¼“å­˜å‘½ä¸­: < 10ms
  - åŒºå—é“¾æŸ¥è¯¢: 50-200ms
  - å åœè®¡ç®—: 500-2000ms

## ğŸ” å®‰å…¨ç‰¹æ€§

- âœ… JWT è®¤è¯ä¿æŠ¤æ•æ„Ÿæ¥å£
- âœ… è¯·æ±‚é™æµé˜²æ­¢ DDoS
- âœ… CORS è·¨åŸŸæ§åˆ¶
- âœ… ç»“æ„åŒ–æ—¥å¿—å®¡è®¡
- âœ… é”™è¯¯ä¿¡æ¯è„±æ•

## ğŸ“ ä¸‹ä¸€æ­¥å·¥ä½œ

### å¾…å®Œå–„åŠŸèƒ½

1. **WebSocket æ”¯æŒ** (å·²è§„åˆ’)
   - å®æ—¶åŒºå—è®¢é˜…
   - å åœç»“æœæ¨é€
   - è¿æ¥ç®¡ç†

2. **Substrate é›†æˆå¢å¼º**
   - ä½¿ç”¨ Subxt å®ç”Ÿæˆç±»å‹å®‰å…¨æ¥å£
   - å®ç°å…·ä½“ pallet æŸ¥è¯¢
   - äº¤æ˜“æäº¤æ”¯æŒ

3. **ç›‘æ§ä¸å¯è§‚æµ‹æ€§**
   - Prometheus æŒ‡æ ‡å¯¼å‡º
   - OpenTelemetry è¿½è¸ª
   - å¥åº·æ£€æŸ¥å¢å¼º

4. **å®‰å…¨å¢å¼º**
   - API Key ç®¡ç†
   - ç­¾åéªŒè¯ï¼ˆSubstrate è´¦æˆ·ç­¾åï¼‰
   - è¯·æ±‚å®¡è®¡æ—¥å¿—

5. **æ€§èƒ½ä¼˜åŒ–**
   - è¿æ¥æ± è°ƒä¼˜
   - ç¼“å­˜é¢„çƒ­
   - å“åº”å‹ç¼©ä¼˜åŒ–

### å åœå¾®æœåŠ¡å®ç°

Gateway å·²å‡†å¤‡å°±ç»ªï¼Œéœ€è¦å•ç‹¬å®ç°å åœå¾®æœåŠ¡ï¼š

```
divination-service/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ xiaoliuren/    # å°å…­å£¬ç®—æ³•
â”‚   â”œâ”€â”€ ziwei/         # ç´«å¾®ç®—æ³•
â”‚   â”œâ”€â”€ liuyao/        # å…­çˆ»ç®—æ³•
â”‚   â””â”€â”€ ...
â””â”€â”€ Cargo.toml
```

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Axum å®˜æ–¹æ–‡æ¡£](https://docs.rs/axum/)
- [Subxt ä½¿ç”¨æŒ‡å—](https://docs.rs/subxt/)
- [Tower ä¸­é—´ä»¶](https://docs.rs/tower/)
- [Redis Rust å®¢æˆ·ç«¯](https://docs.rs/redis/)

## ğŸ™ æ³¨æ„äº‹é¡¹

1. **ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰å¿…é¡»ä¿®æ”¹**:
   - JWT_SECRETï¼ˆä½¿ç”¨å¼ºéšæœºå¯†é’¥ï¼‰
   - Redis å¯†ç ä¿æŠ¤
   - CORS ç­–ç•¥æ”¶ç´§

2. **Substrate å®¢æˆ·ç«¯é™åˆ¶**:
   - å½“å‰ä½¿ç”¨é€šç”¨æŸ¥è¯¢æ¥å£
   - å®é™…ä½¿ç”¨éœ€è¦æ ¹æ® runtime metadata ç”Ÿæˆç±»å‹
   - å»ºè®®ä½¿ç”¨ `subxt` å®è‡ªåŠ¨ç”Ÿæˆ

3. **å åœæœåŠ¡ä¾èµ–**:
   - Gateway å‡è®¾å åœæœåŠ¡å·²éƒ¨ç½²
   - æ¥å£å®šä¹‰åœ¨ `clients/divination.rs`
   - éœ€è¦å•ç‹¬å®ç°ç®—æ³•é€»è¾‘

## âœ¨ æ€»ç»“

å·²æˆåŠŸæ­å»ºå®Œæ•´çš„ Axum API Gateway è„šæ‰‹æ¶ï¼ŒåŒ…æ‹¬ï¼š
- âœ… å®Œæ•´çš„é¡¹ç›®ç»“æ„
- âœ… é…ç½®ç®¡ç†ç³»ç»Ÿ
- âœ… è®¤è¯ä¸æˆæƒ
- âœ… è¯·æ±‚é™æµ
- âœ… Redis ç¼“å­˜
- âœ… Substrate é›†æˆ
- âœ… å åœæœåŠ¡å®¢æˆ·ç«¯
- âœ… Docker éƒ¨ç½²æ–¹æ¡ˆ
- âœ… æµ‹è¯•ä¸è¿ç»´å·¥å…·
- âœ… è¯¦ç»†æ–‡æ¡£

**ä¸‹ä¸€æ­¥**: å¯ä»¥å¼€å§‹å®ç°å åœç®—æ³•å¾®æœåŠ¡ï¼Œæˆ–è€…æ ¹æ®å®é™…éœ€æ±‚è°ƒæ•´ Gateway é…ç½®ã€‚
