
根据chat对话里面的再次设计文档：

pallet-cemetery 与 pallet-deceased（支持单/合葬陵墓与族谱关系），与 pallet-ritual/pallet-order/pallet-agent 轻耦合

一、总体目标
将“陵园/墓位（单人/多人）”与“逝者/族谱关系”拆分为两个独立 Pallet，数据归属清晰、职责单一。
与供奉/法事原语 pallet-ritual 解耦，仅通过 TargetId::{Plot(u64), Deceased(u64)} 实现联动。
与订单 pallet-order 以事件驱动支持 finalize_by_interment 自动验收；定价与执行在 pallet-agent。
二、边界与解耦
pallet-cemetery：管理陵园与墓位生命周期、容量/占用、权属/授权、安葬记录。
pallet-deceased：管理逝者注册与族谱关系（父母/配偶），PII 走链下（IPFS），链上存承诺哈希。
pallet-ritual：对 Plot/Deceased 目标执行上香/供灯/供花/捐赠等，不依赖 cemetery/deceased 内部结构。
pallet-order：下单选择执行者(agent)与价格快照；监听安葬/供奉事件自动验收。

三、与其他 Pallet 的联动
与 pallet-ritual
TargetId::Plot(plot_id)、TargetId::Deceased(deceased_id) 允许供奉。
pallet-cemetery 实现 ritual::TargetControl：仅允许存在且 active 的目标。
与 pallet-order
订单类型“安葬”在 inter(plot_id, deceased_id, memo?) 成功后，触发 IntermentCommitted 事件；order 监听后执行 finalize_by_interment。
价格与执行者选择在 pallet-agent（报价快照）；order 继续托管与结算。
与 pallet-agent
无强依赖；agent 执行现场服务时可在 memo 放订单/证据承诺，与安葬/供奉事件对齐。

五、保持 Pallet 低耦合前提下，引入多签能力，支持陵园管理团队以多签形式执行关键操作。优先复用 pallet-multisig，避免在业务 Pallet 内重复造轮子；如需内置多签，也提供可选扩展。复用 pallet-multisig（零耦合接入）


佛境链（Buddha Land）统一需求与设计说明（精简版）
目标与原则
目标: 围绕冥想修行与寺庙供养，提供会话代付、设备与冥想记录、挖矿奖励、订单与仲裁、OTC、BUD→Karma 兑换等链上能力。
低耦合: Pallet 间仅通过接口 trait 交互，运行时做适配；上链仅存摘要/哈希/CID。
安全与治理: 权限与会话代付走 pallet-authorizer；资金走 pallet-escrow；纠纷走 pallet-arbitration。
Pallet 职责
authorizer: 域/命名空间白名单、赞助者、预算、可转发范围。
forwarder: 元交易转发 + 会话许可（TTL/范围/额度/nonce/防重放）。显式排除 pallet-exchange::exchange。
device: 头环设备唯一性（弱→中→强可升级）、注册/吊销、绑定账户。
meditation: 上链冥想会话摘要/承诺（不含原始脑波），校验设备绑定，触发挖矿。
mining: 会话奖励发放 BUD，含日上限/设备上限/全局上限与反刷。
escrow: 托管锁定/放款/退款。
arbitration: 统一纠纷入口；“域 + 路由 + 钩子 + 托管”应用到 order/otc 等。
otc-market: 场外交易订单与撮合（配合 escrow 与 arbitration）。
temple: 寺庙与“服务目录”的唯一事实源（服务名/说明/CID）。
agent: 代办人、与寺庙绑定（多对多）、发布项目与多规格/多价格（SKU）、媒体 CID、服务统计。
order: 买家下单→托管→代办接单/开工→提交凭证→买家确认/纠纷；完成后按金额 1:1 发放 Karma。
exchange: BUD→Karma 单向兑换；启用分配项 BPS 求和必须等于基点分母；按 PalletId 子账户分配；不走代付。
karma: Karma 记账与增发（由运行时适配）。
关键接口（运行时适配，解耦）
TempleCatalog：service_exists(temple_id, service_id) -> bool；get_service_name_cid(...)
AgentDirectory：
list_agents_for_service(temple_id, service_id) -> Vec<AccountId>
get_sku_snapshot(agent, temple_id, service_id, sku_id) -> Option<(price: Balance, sku_name: Vec<u8>, media_hashes: Vec<[u8;32]>)>
Escrow：lock(payer, order_id, amount) / release(to, order_id) / refund(to, order_id)
ArbitrationRouter：can_dispute(order_id) / apply_decision(order_id, decision)
KarmaMint：mint_karma(who, amount)
MiningInterface：reward_meditation(owner, valid, valid_minutes, quality_pct)
ForwarderAuthorizer/AdminAuthorizer/MiningAuthorizer：适配到 pallet-authorizer
数据与约束
服务名一致: 服务名称仅在 pallet-temple 存储与变更；pallet-agent 项目只存 (temple_id, service_id) 引用，可有副标题/标签，不得覆盖服务名。
绑定关系（多对多）: (agent_id, temple_id) -> Status(Pending/Active/Revoked)；同一代办人可绑定多个寺庙，寺庙也可绑定多个代办人。建议上限：MaxTemplesPerAgent、MaxAgentsPerTemple。
项目与规格（在 agent）:
AgentProject(agent, temple, service, project_id){subtitle, desc_cid, published}
ProjectSku(project_id, sku_id){name, price, unit, extra_meta_cid, enabled}；MaxSkusPerProject
媒体 CID：图片≤10、视频≤2、文档≤5（BoundedVec<u8, MaxCidLen>），项目与订单凭证两侧同约束。
发布时必须已绑定且 temple/service 启用；寺庙解绑或服务下线→自动 unpublish 禁止新单（老单不受影响）。
统计（在 agent）:
全局与按寺庙维度：orders_served、volume_served、reviews_pos/neg、after_sales
售后率(BPS)=after_sales*10000/max(1,orders_served)；好评率(BPS)=pos*10000/max(1,pos+neg)
由 order 在放款/评价/售后节点通过 AgentStatsWriter trait 更新，防重入。
业务流程
会话代付: 用户登录/开局签 Session Permit；白名单内调用走代付；预算/范围/TTL/nonce 限制；exchange 排除。
设备-冥想-挖矿: 设备校验与绑定→meditation 上链摘要→mining 发放 BUD（多上限/反刷）。
代办绑定与项目发布: 先绑定再发布；项目必须指向寺庙启用服务；多规格/多价格；媒体 CID 受限；编辑→发布两阶段。
买家下单到结算:
选寺庙→选服务→系统列出可服务代办人（倒排索引）→选代办/项目/规格→下单
下单校验：service_exists + get_sku_snapshot；金额必须匹配快照；Escrow::lock
代办：accept→start→submit_proof(CIDs)
买家：confirm（放款）或 dispute（仲裁）
完成后：按订单金额 1:1 调用 KarmaMint::mint_karma 给买家（放款成功后再发放、幂等）
仲裁: 统一 arbitration；结果驱动 Escrow::release/refund；订单侧记录状态与事件。
OTC: otc-market 下单撮合 + escrow 托管 + arbitration 纠纷。
兑换: 用户主动调用 exchange(amount)（普通交易）；按启用分配项 BPS 将 BUD 分配到 PalletId.into_sub_account_truncating([u8;8]) 子账户，BPS 总和必须等于分母（默认 10000）；随后为用户铸发等额 Karma；分配项由 authorizer 域白名单管理。
权限与治理
authorizer 域：OrderNsBytes、DeviceNsBytes、MeditationNsBytes、ArbitrationNsBytes 等；仅白名单内方法可代付。
管理操作（绑定审批、项目发布/下线、兑换分配管理）均纳入域白名单/治理。
会话可撤销；预算与可转发范围可变更。
事件与查询
绑定：TempleBound/Unbound/BindingRevoked
项目：ProjectPublished/Unpublished、SkuAdded/Updated/Disabled、ProjectMediaSet
订单：OrderPlaced/Accepted/Started/ProofSubmitted/Completed/Disputed/Arbitrated/Refunded
托管：EscrowLocked/Released/Refunded
奖励：MiningRewarded、KarmaAwarded
兑换：ExchangeAllocSet/Updated/Paused、Exchanged
统计：AgentStatsUpdated
只读查询：Temple 服务目录、按 (temple, service) 可服务代办人、项目/SKU、订单状态与凭证 CID、代办统计。
性能与上线
先用占位权重；对 order/otc-market/arbitration/exchange 生成基准权重后替换。
限制文本与 CID 长度、媒体数量，控制区块大小。
创世不预置 authorizer 白名单；上线后通过交易/治理添加。
运行时通过适配器实现上述 trait 绑定，保持可插拔。
验收要点
代办人与寺庙多对多绑定；仅在绑定且服务启用时可发布项目。
项目多规格多价格；媒体仅 CID 严格上限；下线/解绑自动禁新单。
下单→托管→履约→凭证→确认/仲裁 全流程可用；金额与 SKU 快照一致。
确认完成后为买家发放与订单金额等额 Karma（放款后、幂等）。
会话代付仅限白名单；exchange 强制走普通交易；Exchange 分配 BPS 校验严格等于分母。
简短总结
文档已按“职责矩阵—接口—数据—流程—权限—事件—验收”重排；突出代办与寺庙多对多、项目对齐服务、媒体 CID 限制、订单完成 1:1 Karma、Exchange 不代付与 BPS 校验，以及基于 trait 的低耦合适配。