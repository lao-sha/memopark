# 首购法币支付网关服务 Docker Compose 配置

version: '3.8'

services:
  # 首购服务
  first-purchase-service:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: memopark-first-purchase-service
    restart: unless-stopped
    ports:
      - "3100:3100"
    environment:
      NODE_ENV: production
      PORT: 3100
      LOG_LEVEL: info
      
      # 区块链配置
      WS_ENDPOINT: ws://host.docker.internal:9944
      FIAT_GATEWAY_SEED: ${FIAT_GATEWAY_SEED}
      
      # Redis配置
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      REDIS_DB: 0
      
      # epay配置
      EPAY_PID: ${EPAY_PID}
      EPAY_KEY: ${EPAY_KEY}
      EPAY_GATEWAY: ${EPAY_GATEWAY}
      EPAY_NOTIFY_URL: ${EPAY_NOTIFY_URL}
      EPAY_RETURN_URL: ${EPAY_RETURN_URL}
      
      # 首购配置
      MIN_FIRST_PURCHASE_AMOUNT: 50
      MAX_FIRST_PURCHASE_AMOUNT: 100
      ORDER_EXPIRY_SECONDS: 900
      MEMO_TO_CNY_RATE: 0.01
      REFERRAL_DISCOUNT_RATE: 0.9
      TREASURY_ACCOUNT: ${TREASURY_ACCOUNT}
      
      # 风控配置
      MAX_ORDERS_PER_IP_PER_DAY: 5
      MAX_ORDERS_PER_IP_PER_HOUR: 2
      
      # 监控配置
      TREASURY_BALANCE_ALERT_THRESHOLD: 10000
      ALERT_WEBHOOK_URL: ${ALERT_WEBHOOK_URL}
    
    volumes:
      - ./logs:/app/logs
    
    depends_on:
      - redis
    
    networks:
      - memopark-network
    
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # Redis服务
  redis:
    image: redis:7-alpine
    container_name: memopark-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --requirepass ${REDIS_PASSWORD}
    volumes:
      - redis-data:/data
    networks:
      - memopark-network

  # Nginx反向代理（可选）
  nginx:
    image: nginx:alpine
    container_name: memopark-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
    depends_on:
      - first-purchase-service
    networks:
      - memopark-network

volumes:
  redis-data:
    driver: local

networks:
  memopark-network:
    driver: bridge

