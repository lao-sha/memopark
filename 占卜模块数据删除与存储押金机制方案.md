# å åœæ¨¡å—æ•°æ®åˆ é™¤ä¸å­˜å‚¨æŠ¼é‡‘æœºåˆ¶å®Œæ•´æ–¹æ¡ˆ

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æ–¹æ¡ˆé’ˆå¯¹æ‰€æœ‰å åœæ¨¡å—ï¼ˆå…«å­—ã€ç´«å¾®ã€å…­çˆ»ã€æ¢…èŠ±ã€å¥‡é—¨ã€å¤§å…­å£¬ã€å°å…­å£¬ã€å¡”ç½—ã€é»„å†ï¼‰æå‡ºç»Ÿä¸€çš„æ•°æ®åˆ é™¤èƒ½åŠ›å’Œå­˜å‚¨æŠ¼é‡‘æœºåˆ¶è®¾è®¡ï¼Œæ—¨åœ¨ï¼š

1. **èµ‹äºˆç”¨æˆ·æ•°æ®è‡ªä¸»æƒ**ï¼šå…è®¸ç”¨æˆ·åˆ é™¤ä¸éœ€è¦çš„å åœè®°å½•
2. **é˜²æ­¢å­˜å‚¨æ»¥ç”¨**ï¼šé€šè¿‡æŠ¼é‡‘æœºåˆ¶é™åˆ¶æ¶æ„åˆ·æ•°æ®è¡Œä¸º
3. **ä¼˜åŒ–é“¾ä¸Šå­˜å‚¨**ï¼šé‡Šæ”¾å·²åˆ é™¤æ•°æ®çš„å­˜å‚¨ç©ºé—´
4. **ç»æµæ¿€åŠ±å¹³è¡¡**ï¼šåˆç†çš„æŠ¼é‡‘è®¾è®¡æ—¢ä¿æŠ¤ç³»ç»Ÿåˆä¸å½±å“ç”¨æˆ·ä½“éªŒ

---

## ğŸ¯ æ–¹æ¡ˆç›®æ ‡

### æ ¸å¿ƒç›®æ ‡
- âœ… å®ç°æ‰€æœ‰å åœæ¨¡å—çš„ç»Ÿä¸€åˆ é™¤æ¥å£
- âœ… å»ºç«‹åŸºäºUSDTè®¡ä»·çš„å­˜å‚¨æŠ¼é‡‘ç³»ç»Ÿ
- âœ… æ”¯æŒæŠ¼é‡‘è‡ªåŠ¨é€€è¿˜å’Œæ‰£é™¤æœºåˆ¶
- âœ… æä¾›çµæ´»çš„é…é¢å’Œå…è´¹é¢åº¦
- âœ… ç¡®ä¿æ•°æ®åˆ é™¤çš„å®‰å…¨æ€§å’Œå¯è¿½æº¯æ€§

### éç›®æ ‡
- âŒ ä¸å®ç°æ•°æ®å½’æ¡£åŠŸèƒ½ï¼ˆå®Œå…¨åˆ é™¤ï¼‰
- âŒ ä¸æ”¯æŒæ‰¹é‡åˆ é™¤ï¼ˆé˜²æ­¢è¯¯æ“ä½œï¼‰
- âŒ ä¸æä¾›åˆ é™¤åæ¢å¤åŠŸèƒ½ï¼ˆä¸å¯é€†ï¼‰

---

## ğŸ“Š ç°çŠ¶åˆ†æ

### 1. å åœæ¨¡å—æ¦‚è§ˆ

| æ¨¡å— | æ•°æ®ç±»å‹ | å­˜å‚¨ç»“æ„ | å½“å‰åˆ é™¤èƒ½åŠ› | æŠ¼é‡‘æœºåˆ¶ |
|------|---------|---------|------------|---------|
| **å…«å­— (bazi)** | å››æŸ±å‘½ç›˜ | ChartById | âŒ æ—  | âŒ æ—  |
| **ç´«å¾® (ziwei)** | ç´«å¾®å‘½ç›˜ | Charts | âŒ æ—  | âŒ æ—  |
| **å…­çˆ» (liuyao)** | å…­çˆ»å¦è±¡ | Guas | âŒ æ—  | âŒ æ—  |
| **æ¢…èŠ± (meihua)** | æ¢…èŠ±å¦è±¡ | Guas | âŒ æ—  | âŒ æ—  |
| **å¥‡é—¨ (qimen)** | å¥‡é—¨ç›˜ | Charts | âŒ æ—  | âŒ æ—  |
| **å¤§å…­å£¬ (daliuren)** | å…­å£¬è¯¾ | Charts | âŒ æ—  | âŒ æ—  |
| **å°å…­å£¬ (xiaoliuren)** | å°å…­å£¬å¦ | Guas | âŒ æ—  | âŒ æ—  |
| **å¡”ç½— (tarot)** | å¡”ç½—ç‰Œé˜µ | Spreads | âŒ æ—  | âŒ æ—  |
| **é»„å† (almanac)** | é»„å†æŸ¥è¯¢ | æ— å­˜å‚¨ | N/A | N/A |

### 2. ç°æœ‰å­˜å‚¨ç‰¹ç‚¹

#### å…±åŒç‰¹å¾
- **ç”¨æˆ·ç´¢å¼•**ï¼šæ‰€æœ‰æ¨¡å—éƒ½æœ‰ `UserCharts/UserGuas` æ˜ å°„
- **å…¬å¼€åˆ—è¡¨**ï¼šæ”¯æŒå…¬å¼€å±•ç¤ºçš„è®°å½•åˆ—è¡¨
- **æ¯æ—¥é™é¢**ï¼šé€šè¿‡ `DailyChartCount` é™åˆ¶åˆ›å»ºé¢‘ç‡
- **åŠ å¯†æ”¯æŒ**ï¼šéƒ¨åˆ†æ¨¡å—æ”¯æŒéšç§åŠ å¯†å­˜å‚¨

#### å­˜å‚¨æˆæœ¬ä¼°ç®—
```rust
// å•æ¡è®°å½•å¹³å‡å­˜å‚¨å¤§å°
å…«å­—å‘½ç›˜: ~2KB (å››æŸ± + å¤§è¿ + è§£è¯»)
ç´«å¾®å‘½ç›˜: ~3KB (åäºŒå®« + æ˜Ÿæ›œ + å››åŒ–)
å…­çˆ»å¦è±¡: ~1.5KB (å…­çˆ» + çº³ç”² + å…­ç¥)
æ¢…èŠ±å¦è±¡: ~1KB (æœ¬å¦ + å˜å¦ + äº’å¦)
å¥‡é—¨ç›˜: ~4KB (ä¹å®« + å…«é—¨ + ä¹æ˜Ÿ)
```

### 3. æ½œåœ¨é—®é¢˜

#### é—®é¢˜1ï¼šå­˜å‚¨æ— é™å¢é•¿
- **ç°è±¡**ï¼šç”¨æˆ·å¯ä»¥æ— é™åˆ›å»ºè®°å½•ï¼Œæ— åˆ é™¤æœºåˆ¶
- **å½±å“**ï¼šé“¾ä¸Šå­˜å‚¨æŒç»­è†¨èƒ€ï¼ŒèŠ‚ç‚¹è´Ÿæ‹…å¢åŠ 
- **æ¡ˆä¾‹**ï¼šæµ‹è¯•ç”¨æˆ·åˆ›å»º100+æ¡æµ‹è¯•è®°å½•æ— æ³•æ¸…ç†

#### é—®é¢˜2ï¼šæ¶æ„åˆ·æ•°æ®
- **ç°è±¡**ï¼šæ¯æ—¥é™é¢å¯é€šè¿‡å¤šè´¦æˆ·ç»•è¿‡
- **å½±å“**ï¼šå­˜å‚¨èµ„æºè¢«æ»¥ç”¨ï¼Œå½±å“æ­£å¸¸ç”¨æˆ·
- **æ¡ˆä¾‹**ï¼šæœºå™¨äººè´¦æˆ·æ‰¹é‡åˆ›å»ºåƒåœ¾æ•°æ®

#### é—®é¢˜3ï¼šç”¨æˆ·éšç§é¡¾è™‘
- **ç°è±¡**ï¼šç”¨æˆ·æ— æ³•åˆ é™¤æ•æ„Ÿå åœè®°å½•
- **å½±å“**ï¼šé™ä½ç”¨æˆ·ä¿¡ä»»åº¦ï¼Œå½±å“äº§å“é‡‡ç”¨
- **æ¡ˆä¾‹**ï¼šç”¨æˆ·æ‹…å¿ƒå‘½ç†æ•°æ®æ°¸ä¹…ä¿å­˜

---

## ğŸ—ï¸ æ–¹æ¡ˆè®¾è®¡

### æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   å åœæ¨¡å—ç»Ÿä¸€æ¶æ„                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ç”¨æˆ·æ“ä½œå±‚                                                   â”‚
â”‚  â”œâ”€ create_chart/gua (åˆ›å»ºè®°å½• + é”å®šæŠ¼é‡‘)                    â”‚
â”‚  â”œâ”€ delete_chart/gua (åˆ é™¤è®°å½• + é€€è¿˜æŠ¼é‡‘)                    â”‚
â”‚  â””â”€ supplement_deposit (è¡¥å……æŠ¼é‡‘)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æŠ¼é‡‘ç®¡ç†å±‚                                                   â”‚
â”‚  â”œâ”€ DivinationDepositRecords (æŠ¼é‡‘è®°å½•)                      â”‚
â”‚  â”œâ”€ UserDepositBalance (ç”¨æˆ·æŠ¼é‡‘ä½™é¢)                        â”‚
â”‚  â””â”€ DepositConfig (æŠ¼é‡‘é…ç½®å‚æ•°)                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å­˜å‚¨ç®¡ç†å±‚                                                   â”‚
â”‚  â”œâ”€ Charts/Guas (ä¸»æ•°æ®å­˜å‚¨)                                 â”‚
â”‚  â”œâ”€ UserCharts/UserGuas (ç”¨æˆ·ç´¢å¼•)                           â”‚
â”‚  â”œâ”€ PublicCharts/PublicGuas (å…¬å¼€åˆ—è¡¨)                       â”‚
â”‚  â””â”€ DeletedRecords (åˆ é™¤è®°å½•å®¡è®¡)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  é›†æˆå±‚                                                       â”‚
â”‚  â”œâ”€ pallet-pricing (æ±‡ç‡æŸ¥è¯¢)                                â”‚
â”‚  â”œâ”€ pallet-balances (æŠ¼é‡‘é”å®š/è§£é”)                          â”‚
â”‚  â””â”€ pallet-storage-treasury (å­˜å‚¨è´¹ç”¨)                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```


---

## ğŸ’° æŠ¼é‡‘æœºåˆ¶è®¾è®¡

### 1. æŠ¼é‡‘æ¨¡å‹

#### 1.1 åŸºç¡€æŠ¼é‡‘æ ‡å‡†ï¼ˆUSDTè®¡ä»·ï¼‰

| å åœç±»å‹ | åŸºç¡€æŠ¼é‡‘ | æ•°æ®å¤§å° | è®¡ç®—ä¾æ® |
|---------|---------|---------|---------|
| **å…«å­—å‘½ç›˜** | 0.5 USDT | ~2KB | å¤æ‚åº¦é«˜ï¼Œé•¿æœŸä¿å­˜ |
| **ç´«å¾®å‘½ç›˜** | 0.8 USDT | ~3KB | æ•°æ®é‡å¤§ï¼Œè®¡ç®—å¤æ‚ |
| **å…­çˆ»å¦è±¡** | 0.3 USDT | ~1.5KB | ä¸­ç­‰å¤æ‚åº¦ |
| **æ¢…èŠ±å¦è±¡** | 0.2 USDT | ~1KB | æ•°æ®é‡å° |
| **å¥‡é—¨ç›˜** | 1.0 USDT | ~4KB | æœ€å¤æ‚ï¼Œæ•°æ®é‡æœ€å¤§ |
| **å¤§å…­å£¬** | 0.8 USDT | ~3KB | å¤æ‚åº¦é«˜ |
| **å°å…­å£¬** | 0.2 USDT | ~1KB | ç®€å•å¿«é€Ÿ |
| **å¡”ç½—ç‰Œé˜µ** | 0.3 USDT | ~1.5KB | ä¸­ç­‰å¤æ‚åº¦ |

#### 1.2 æŠ¼é‡‘è®¡ç®—å…¬å¼

```rust
// æŠ¼é‡‘ = åŸºç¡€æŠ¼é‡‘ Ã— è§„æ¨¡ç³»æ•° Ã— åŠ å¯†ç³»æ•°
fn calculate_deposit(
    base_deposit_usdt: u32,      // åŸºç¡€æŠ¼é‡‘ï¼ˆUSDTï¼Œ6ä½ç²¾åº¦ï¼‰
    scale_multiplier: u32,        // è§„æ¨¡ç³»æ•°ï¼ˆ10000åŸºç‚¹ï¼‰
    encryption_multiplier: u32,   // åŠ å¯†ç³»æ•°ï¼ˆ10000åŸºç‚¹ï¼‰
) -> u32 {
    base_deposit_usdt
        .saturating_mul(scale_multiplier)
        .saturating_div(10000)
        .saturating_mul(encryption_multiplier)
        .saturating_div(10000)
}

// ç¤ºä¾‹ï¼šå…«å­—å‘½ç›˜ + æ ‡å‡†è§„æ¨¡ + åŠ å¯†å­˜å‚¨
// 0.5 USDT Ã— 1.0 Ã— 1.2 = 0.6 USDT
```

#### 1.3 è§„æ¨¡ç³»æ•°

| è§„æ¨¡ | ç³»æ•° | é€‚ç”¨åœºæ™¯ |
|-----|------|---------|
| **æ ‡å‡†** | 1.0x | å•æ¬¡å åœï¼Œæ­£å¸¸ä½¿ç”¨ |
| **æ‰¹é‡** | 1.5x | æ‰¹é‡åˆ›å»ºï¼ˆ>10æ¡/å¤©ï¼‰ |
| **å•†ä¸š** | 2.0x | å•†ä¸šç”¨é€”ï¼Œå…¬å¼€å±•ç¤º |

#### 1.4 åŠ å¯†ç³»æ•°

| åŠ å¯†çº§åˆ« | ç³»æ•° | è¯´æ˜ |
|---------|------|------|
| **Public** | 1.0x | å…¬å¼€å¯è§ï¼Œæ— åŠ å¯† |
| **Partial** | 1.2x | éƒ¨åˆ†åŠ å¯†ï¼ˆæ•æ„Ÿä¿¡æ¯ï¼‰ |
| **Private** | 1.5x | å®Œå…¨åŠ å¯†ï¼ˆå…¨éƒ¨æ•°æ®ï¼‰ |

### 2. æŠ¼é‡‘ç”Ÿå‘½å‘¨æœŸ

```
åˆ›å»ºè®°å½•
    â†“
é”å®šæŠ¼é‡‘ï¼ˆDUSTæŒ‰å½“å‰æ±‡ç‡ï¼‰
    â†“
ã€æ­£å¸¸ä½¿ç”¨æœŸã€‘
    â†“
ç”¨æˆ·åˆ é™¤è®°å½•
    â†“
éªŒè¯æƒé™ + æ¸…ç†æ•°æ®
    â†“
è§£é”æŠ¼é‡‘ï¼ˆ100%é€€è¿˜ï¼‰
    â†“
æŠ¼é‡‘è¿”å›ç”¨æˆ·è´¦æˆ·
```

### 3. æŠ¼é‡‘æ± ç®¡ç†

#### 3.1 ç”¨æˆ·æŠ¼é‡‘è´¦æˆ·

```rust
/// ç”¨æˆ·æŠ¼é‡‘ä½™é¢è®°å½•
pub struct UserDepositBalance<T: Config> {
    /// ç”¨æˆ·è´¦æˆ·
    pub account: T::AccountId,
    
    /// æ€»é”å®šæŠ¼é‡‘ï¼ˆUSDTï¼‰
    pub total_locked_usdt: u32,
    
    /// æ€»é”å®šæŠ¼é‡‘ï¼ˆDUSTï¼‰
    pub total_locked_dust: BalanceOf<T>,
    
    /// å¯ç”¨æŠ¼é‡‘ä½™é¢ï¼ˆUSDTï¼‰
    pub available_usdt: u32,
    
    /// å¯ç”¨æŠ¼é‡‘ä½™é¢ï¼ˆDUSTï¼‰
    pub available_dust: BalanceOf<T>,
    
    /// è®°å½•æ•°é‡
    pub record_count: u32,
    
    /// æœ€åæ›´æ–°æ—¶é—´
    pub last_updated: BlockNumberFor<T>,
}
```

#### 3.2 å•æ¡è®°å½•æŠ¼é‡‘

```rust
/// å åœè®°å½•æŠ¼é‡‘è¯¦æƒ…
pub struct DivinationDepositRecord<T: Config> {
    /// è®°å½•ID
    pub record_id: u64,
    
    /// å åœç±»å‹
    pub divination_type: DivinationType,
    
    /// æ‰€æœ‰è€…
    pub owner: T::AccountId,
    
    /// æŠ¼é‡‘é‡‘é¢ï¼ˆUSDTï¼‰
    pub deposit_usdt: u32,
    
    /// æŠ¼é‡‘é‡‘é¢ï¼ˆDUSTï¼‰
    pub deposit_dust: BalanceOf<T>,
    
    /// é”å®šæ—¶æ±‡ç‡
    pub exchange_rate: u64,
    
    /// é”å®šæ—¶é—´
    pub locked_at: BlockNumberFor<T>,
    
    /// æŠ¼é‡‘çŠ¶æ€
    pub status: DepositStatus,
}

/// æŠ¼é‡‘çŠ¶æ€
pub enum DepositStatus {
    Active,      // æ´»è·ƒï¼ˆæ­£å¸¸é”å®šï¼‰
    Released,    // å·²é‡Šæ”¾ï¼ˆåˆ é™¤åé€€è¿˜ï¼‰
    Slashed,     // å·²æ‰£é™¤ï¼ˆè¿è§„æƒ©ç½šï¼‰
}
```

### 4. å…è´¹é…é¢æœºåˆ¶

#### 4.1 æ¯æ—¥å…è´¹é¢åº¦

```rust
parameter_types! {
    // æ¯æ—¥å…è´¹åˆ›å»ºæ¬¡æ•°ï¼ˆæ— éœ€æŠ¼é‡‘ï¼‰
    pub const DailyFreeQuota: u32 = 3;
    
    // æ¯æœˆå…è´¹åˆ›å»ºæ¬¡æ•°
    pub const MonthlyFreeQuota: u32 = 10;
}
```

#### 4.2 é…é¢ä½¿ç”¨è§„åˆ™

1. **ä¼˜å…ˆä½¿ç”¨å…è´¹é…é¢**
   - æ¯æ—¥å‰3æ¬¡åˆ›å»ºæ— éœ€æŠ¼é‡‘
   - è¶…å‡ºåéœ€è¦é”å®šæŠ¼é‡‘

2. **é…é¢é‡ç½®å‘¨æœŸ**
   - æ¯æ—¥é…é¢ï¼šUTC 00:00 é‡ç½®
   - æ¯æœˆé…é¢ï¼šæ¯æœˆ1æ—¥é‡ç½®

3. **é…é¢ä¸ç´¯ç§¯**
   - æœªä½¿ç”¨çš„é…é¢ä¸ç»“è½¬
   - åˆ é™¤è®°å½•ä¸è¿”è¿˜é…é¢

#### 4.3 VIPç”¨æˆ·ç‰¹æƒ

```rust
/// VIPç­‰çº§é…é¢åŠ æˆ
pub enum VipLevel {
    None,        // æ™®é€šç”¨æˆ·ï¼š3æ¬¡/å¤©
    Bronze,      // é’é“œï¼š5æ¬¡/å¤©
    Silver,      // ç™½é“¶ï¼š10æ¬¡/å¤©
    Gold,        // é»„é‡‘ï¼š20æ¬¡/å¤©
    Platinum,    // é“‚é‡‘ï¼šæ— é™åˆ¶
}
```

---

## ğŸ—‘ï¸ æ•°æ®åˆ é™¤æœºåˆ¶

### 1. åˆ é™¤æ¥å£è®¾è®¡

#### 1.1 ç»Ÿä¸€åˆ é™¤æ¥å£

```rust
/// åˆ é™¤å åœè®°å½•ï¼ˆé€šç”¨æ¥å£ï¼‰
#[pallet::call_index(99)]
#[pallet::weight(T::WeightInfo::delete_record())]
pub fn delete_record(
    origin: OriginFor<T>,
    record_id: u64,
    record_type: DivinationType,
) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    // 1. éªŒè¯æ‰€æœ‰æƒ
    Self::ensure_record_owner(&who, record_id, record_type)?;
    
    // 2. æ£€æŸ¥åˆ é™¤æ¡ä»¶
    Self::check_deletion_conditions(record_id, record_type)?;
    
    // 3. æ‰§è¡Œåˆ é™¤
    Self::do_delete_record(record_id, record_type)?;
    
    // 4. é€€è¿˜æŠ¼é‡‘
    Self::refund_deposit(&who, record_id)?;
    
    // 5. è®°å½•å®¡è®¡æ—¥å¿—
    Self::log_deletion(&who, record_id, record_type)?;
    
    // 6. å‘å‡ºäº‹ä»¶
    Self::deposit_event(Event::RecordDeleted {
        record_id,
        record_type,
        owner: who,
        refunded_deposit: deposit_amount,
    });
    
    Ok(())
}
```

#### 1.2 æ¨¡å—ç‰¹å®šåˆ é™¤æ¥å£

```rust
// å…«å­—æ¨¡å—
#[pallet::call_index(10)]
pub fn delete_bazi_chart(
    origin: OriginFor<T>,
    chart_id: u64,
) -> DispatchResult {
    Self::delete_record(origin, chart_id, DivinationType::Bazi)
}

// ç´«å¾®æ¨¡å—
#[pallet::call_index(10)]
pub fn delete_ziwei_chart(
    origin: OriginFor<T>,
    chart_id: u64,
) -> DispatchResult {
    Self::delete_record(origin, chart_id, DivinationType::Ziwei)
}

// å…­çˆ»æ¨¡å—
#[pallet::call_index(10)]
pub fn delete_liuyao_gua(
    origin: OriginFor<T>,
    gua_id: u64,
) -> DispatchResult {
    Self::delete_record(origin, gua_id, DivinationType::Liuyao)
}
```

### 2. åˆ é™¤æµç¨‹

```
ç”¨æˆ·å‘èµ·åˆ é™¤è¯·æ±‚
    â†“
éªŒè¯æ‰€æœ‰æƒï¼ˆå¿…é¡»æ˜¯åˆ›å»ºè€…ï¼‰
    â†“
æ£€æŸ¥åˆ é™¤æ¡ä»¶
    â”œâ”€ è®°å½•å­˜åœ¨
    â”œâ”€ æœªè¢«é”å®š
    â””â”€ æ— å…³è”ä¾èµ–
    â†“
æ¸…ç†ä¸»æ•°æ®
    â”œâ”€ Charts/Guas å­˜å‚¨
    â”œâ”€ EncryptedData å­˜å‚¨
    â””â”€ OwnerKeyBackup å­˜å‚¨
    â†“
æ›´æ–°ç´¢å¼•
    â”œâ”€ UserCharts/UserGuas
    â”œâ”€ PublicCharts/PublicGuas
    â””â”€ ProviderGrantsï¼ˆå¦‚æœ‰æˆæƒï¼‰
    â†“
é€€è¿˜æŠ¼é‡‘
    â”œâ”€ è§£é” DUST
    â”œâ”€ è½¬è´¦åˆ°ç”¨æˆ·è´¦æˆ·
    â””â”€ æ›´æ–°æŠ¼é‡‘è®°å½•
    â†“
è®°å½•å®¡è®¡æ—¥å¿—
    â”œâ”€ DeletedRecords å­˜å‚¨
    â”œâ”€ è®°å½•åˆ é™¤æ—¶é—´
    â””â”€ è®°å½•åˆ é™¤åŸå› 
    â†“
å‘å‡ºåˆ é™¤äº‹ä»¶
```

### 3. åˆ é™¤æ¡ä»¶æ£€æŸ¥

```rust
fn check_deletion_conditions(
    record_id: u64,
    record_type: DivinationType,
) -> DispatchResult {
    // 1. è®°å½•å¿…é¡»å­˜åœ¨
    ensure!(
        Self::record_exists(record_id, record_type),
        Error::<T>::RecordNotFound
    );
    
    // 2. è®°å½•æœªè¢«é”å®š
    ensure!(
        !Self::is_record_locked(record_id),
        Error::<T>::RecordLocked
    );
    
    // 3. æ— NFTå…³è”ï¼ˆå¦‚æœå·²é“¸é€ NFTï¼Œä¸èƒ½åˆ é™¤ï¼‰
    ensure!(
        !Self::has_nft_minted(record_id),
        Error::<T>::NftAlreadyMinted
    );
    
    // 4. æ— å¸‚åœºè®¢å•ï¼ˆå¦‚æœåœ¨å¸‚åœºå‡ºå”®ï¼Œä¸èƒ½åˆ é™¤ï¼‰
    ensure!(
        !Self::has_active_market_order(record_id),
        Error::<T>::HasActiveMarketOrder
    );
    
    // 5. æ— AIè§£è¯»è¿›è¡Œä¸­
    ensure!(
        !Self::has_pending_ai_interpretation(record_id),
        Error::<T>::AiInterpretationPending
    );
    
    Ok(())
}
```

### 4. æ•°æ®æ¸…ç†èŒƒå›´

#### 4.1 å¿…é¡»æ¸…ç†çš„æ•°æ®

```rust
// ä¸»æ•°æ®å­˜å‚¨
ChartById::<T>::remove(chart_id);
EncryptedDataStorage::<T>::remove(chart_id);
OwnerKeyBackupStorage::<T>::remove(chart_id);
InterpretationCache::<T>::remove(chart_id);

// ç”¨æˆ·ç´¢å¼•
UserCharts::<T>::mutate(&owner, |charts| {
    charts.retain(|&id| id != chart_id);
});

// å…¬å¼€åˆ—è¡¨
PublicCharts::<T>::mutate(|charts| {
    charts.retain(|&id| id != chart_id);
});

// æˆæƒç´¢å¼•ï¼ˆå¦‚æœ‰ï¼‰
for grantee in grantees {
    ProviderGrants::<T>::mutate(&grantee, |grants| {
        grants.retain(|&id| id != chart_id);
    });
}
```

#### 4.2 ä¿ç•™çš„å®¡è®¡æ•°æ®

```rust
/// åˆ é™¤è®°å½•å®¡è®¡æ—¥å¿—
pub struct DeletedRecord<T: Config> {
    /// è®°å½•ID
    pub record_id: u64,
    
    /// å åœç±»å‹
    pub divination_type: DivinationType,
    
    /// åŸæ‰€æœ‰è€…
    pub owner: T::AccountId,
    
    /// åˆ é™¤æ—¶é—´
    pub deleted_at: BlockNumberFor<T>,
    
    /// é€€è¿˜æŠ¼é‡‘é‡‘é¢
    pub refunded_deposit: BalanceOf<T>,
    
    /// åˆ é™¤åŸå› ï¼ˆå¯é€‰ï¼‰
    pub reason: Option<BoundedVec<u8, ConstU32<128>>>,
}

// å­˜å‚¨æ˜ å°„ï¼šè®°å½•ID â†’ åˆ é™¤è®°å½•
pub type DeletedRecords<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u64,
    DeletedRecord<T>,
>;
```

### 5. åˆ é™¤é™åˆ¶

#### 5.1 æ—¶é—´é™åˆ¶

```rust
parameter_types! {
    // åˆ›å»ºå24å°æ—¶å†…å¯ä»¥å…è´¹åˆ é™¤
    pub const FreeDeletionPeriod: BlockNumber = 14_400; // 24å°æ—¶
    
    // åˆ›å»ºå7å¤©å†…å¯ä»¥åˆ é™¤
    pub const MaxDeletionPeriod: BlockNumber = 100_800; // 7å¤©
}

// è¶…è¿‡7å¤©çš„è®°å½•ä¸èƒ½åˆ é™¤ï¼ˆé˜²æ­¢å†å²æ•°æ®ä¸¢å¤±ï¼‰
fn check_deletion_time_limit(
    created_at: BlockNumber,
    current_block: BlockNumber,
) -> DispatchResult {
    let age = current_block.saturating_sub(created_at);
    
    ensure!(
        age <= T::MaxDeletionPeriod::get(),
        Error::<T>::DeletionPeriodExpired
    );
    
    Ok(())
}
```

#### 5.2 é¢‘ç‡é™åˆ¶

```rust
parameter_types! {
    // æ¯æ—¥æœ€å¤šåˆ é™¤æ¬¡æ•°
    pub const MaxDailyDeletions: u32 = 10;
}

// é˜²æ­¢æ¶æ„é¢‘ç¹åˆ é™¤
pub type DailyDeletionCount<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    (T::AccountId, u32), // (ç”¨æˆ·, æ—¥æœŸ)
    u32,                 // åˆ é™¤æ¬¡æ•°
    ValueQuery,
>;
```

---

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. æ•°æ®ç»“æ„å®šä¹‰

#### 1.1 å åœç±»å‹æšä¸¾

```rust
/// å åœç±»å‹æšä¸¾
#[derive(Encode, Decode, Clone, PartialEq, Eq, RuntimeDebug, TypeInfo, MaxEncodedLen)]
pub enum DivinationType {
    Bazi = 0,        // å…«å­—
    Ziwei = 1,       // ç´«å¾®
    Liuyao = 2,      // å…­çˆ»
    Meihua = 3,      // æ¢…èŠ±
    Qimen = 4,       // å¥‡é—¨
    Daliuren = 5,    // å¤§å…­å£¬
    Xiaoliuren = 6,  // å°å…­å£¬
    Tarot = 7,       // å¡”ç½—
}

impl DivinationType {
    /// è·å–åŸºç¡€æŠ¼é‡‘ï¼ˆUSDTï¼Œ6ä½ç²¾åº¦ï¼‰
    pub fn base_deposit_usdt(&self) -> u32 {
        match self {
            Self::Bazi => 500_000,        // 0.5 USDT
            Self::Ziwei => 800_000,       // 0.8 USDT
            Self::Liuyao => 300_000,      // 0.3 USDT
            Self::Meihua => 200_000,      // 0.2 USDT
            Self::Qimen => 1_000_000,     // 1.0 USDT
            Self::Daliuren => 800_000,    // 0.8 USDT
            Self::Xiaoliuren => 200_000,  // 0.2 USDT
            Self::Tarot => 300_000,       // 0.3 USDT
        }
    }
    
    /// è·å–æ•°æ®å¤§å°ä¼°ç®—ï¼ˆå­—èŠ‚ï¼‰
    pub fn estimated_size(&self) -> u32 {
        match self {
            Self::Bazi => 2048,
            Self::Ziwei => 3072,
            Self::Liuyao => 1536,
            Self::Meihua => 1024,
            Self::Qimen => 4096,
            Self::Daliuren => 3072,
            Self::Xiaoliuren => 1024,
            Self::Tarot => 1536,
        }
    }
}
```

#### 1.2 æŠ¼é‡‘é…ç½®

```rust
/// æŠ¼é‡‘é…ç½®å‚æ•°
#[derive(Encode, Decode, Clone, PartialEq, Eq, RuntimeDebug, TypeInfo)]
pub struct DepositConfig {
    /// æ˜¯å¦å¯ç”¨æŠ¼é‡‘æœºåˆ¶
    pub enabled: bool,
    
    /// æ¯æ—¥å…è´¹é…é¢
    pub daily_free_quota: u32,
    
    /// æ¯æœˆå…è´¹é…é¢
    pub monthly_free_quota: u32,
    
    /// æ ‡å‡†è§„æ¨¡ç³»æ•°ï¼ˆ10000åŸºç‚¹ï¼‰
    pub standard_scale_multiplier: u32,
    
    /// æ‰¹é‡è§„æ¨¡ç³»æ•°ï¼ˆ10000åŸºç‚¹ï¼‰
    pub batch_scale_multiplier: u32,
    
    /// å•†ä¸šè§„æ¨¡ç³»æ•°ï¼ˆ10000åŸºç‚¹ï¼‰
    pub commercial_scale_multiplier: u32,
    
    /// PublicåŠ å¯†ç³»æ•°ï¼ˆ10000åŸºç‚¹ï¼‰
    pub public_encryption_multiplier: u32,
    
    /// PartialåŠ å¯†ç³»æ•°ï¼ˆ10000åŸºç‚¹ï¼‰
    pub partial_encryption_multiplier: u32,
    
    /// PrivateåŠ å¯†ç³»æ•°ï¼ˆ10000åŸºç‚¹ï¼‰
    pub private_encryption_multiplier: u32,
    
    /// å…è´¹åˆ é™¤æœŸé™ï¼ˆåŒºå—æ•°ï¼‰
    pub free_deletion_period: u32,
    
    /// æœ€å¤§åˆ é™¤æœŸé™ï¼ˆåŒºå—æ•°ï¼‰
    pub max_deletion_period: u32,
    
    /// æ¯æ—¥æœ€å¤§åˆ é™¤æ¬¡æ•°
    pub max_daily_deletions: u32,
}

impl Default for DepositConfig {
    fn default() -> Self {
        Self {
            enabled: true,
            daily_free_quota: 3,
            monthly_free_quota: 10,
            standard_scale_multiplier: 10000,      // 1.0x
            batch_scale_multiplier: 15000,         // 1.5x
            commercial_scale_multiplier: 20000,    // 2.0x
            public_encryption_multiplier: 10000,   // 1.0x
            partial_encryption_multiplier: 12000,  // 1.2x
            private_encryption_multiplier: 15000,  // 1.5x
            free_deletion_period: 14_400,          // 24å°æ—¶
            max_deletion_period: 100_800,          // 7å¤©
            max_daily_deletions: 10,
        }
    }
}
```

### 2. å­˜å‚¨é¡¹å®šä¹‰

```rust
/// æŠ¼é‡‘é…ç½®ï¼ˆæ²»ç†å¯ä¿®æ”¹ï¼‰
#[pallet::storage]
pub type DepositConfigStorage<T: Config> = StorageValue<
    _,
    DepositConfig,
    ValueQuery,
>;

/// ç”¨æˆ·æŠ¼é‡‘ä½™é¢
#[pallet::storage]
pub type UserDepositBalances<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    T::AccountId,
    UserDepositBalance<T>,
    ValueQuery,
>;

/// å åœè®°å½•æŠ¼é‡‘è¯¦æƒ…
#[pallet::storage]
pub type DivinationDepositRecords<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    (DivinationType, u64), // (ç±»å‹, è®°å½•ID)
    DivinationDepositRecord<T>,
>;

/// åˆ é™¤è®°å½•å®¡è®¡æ—¥å¿—
#[pallet::storage]
pub type DeletedRecords<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    (DivinationType, u64), // (ç±»å‹, è®°å½•ID)
    DeletedRecord<T>,
>;

/// æ¯æ—¥åˆ é™¤æ¬¡æ•°ç»Ÿè®¡
#[pallet::storage]
pub type DailyDeletionCount<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    (T::AccountId, u32), // (ç”¨æˆ·, æ—¥æœŸ)
    u32,
    ValueQuery,
>;

/// ç”¨æˆ·å…è´¹é…é¢ä½¿ç”¨æƒ…å†µ
#[pallet::storage]
pub type UserQuotaUsage<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    (T::AccountId, u32), // (ç”¨æˆ·, æ—¥æœŸ/æœˆä»½)
    QuotaUsage,
    ValueQuery,
>;

/// é…é¢ä½¿ç”¨è®°å½•
#[derive(Encode, Decode, Clone, PartialEq, Eq, RuntimeDebug, TypeInfo, MaxEncodedLen)]
pub struct QuotaUsage {
    /// æ¯æ—¥å·²ä½¿ç”¨æ¬¡æ•°
    pub daily_used: u32,
    /// æ¯æœˆå·²ä½¿ç”¨æ¬¡æ•°
    pub monthly_used: u32,
    /// æœ€åé‡ç½®æ—¶é—´
    pub last_reset: u32,
}
```

### 3. æ ¸å¿ƒå‡½æ•°å®ç°

#### 3.1 åˆ›å»ºè®°å½•æ—¶é”å®šæŠ¼é‡‘

```rust
/// åˆ›å»ºè®°å½•æ—¶å¤„ç†æŠ¼é‡‘
fn handle_deposit_on_create(
    who: &T::AccountId,
    record_id: u64,
    divination_type: DivinationType,
    privacy_mode: PrivacyMode,
    is_batch: bool,
) -> DispatchResult {
    // 1. æ£€æŸ¥å…è´¹é…é¢
    if Self::has_free_quota(who) {
        Self::consume_free_quota(who);
        return Ok(());
    }
    
    // 2. è®¡ç®—æŠ¼é‡‘
    let config = DepositConfigStorage::<T>::get();
    let base_deposit = divination_type.base_deposit_usdt();
    
    let scale_multiplier = if is_batch {
        config.batch_scale_multiplier
    } else {
        config.standard_scale_multiplier
    };
    
    let encryption_multiplier = match privacy_mode {
        PrivacyMode::Public => config.public_encryption_multiplier,
        PrivacyMode::Partial => config.partial_encryption_multiplier,
        PrivacyMode::Private => config.private_encryption_multiplier,
    };
    
    let deposit_usdt = base_deposit
        .saturating_mul(scale_multiplier)
        .saturating_div(10000)
        .saturating_mul(encryption_multiplier)
        .saturating_div(10000);
    
    // 3. è½¬æ¢ä¸ºDUST
    let exchange_rate = T::ExchangeRateProvider::get_rate()?;
    let deposit_dust = Self::usdt_to_dust(deposit_usdt, exchange_rate)?;
    
    // 4. é”å®šæŠ¼é‡‘
    T::Currency::reserve(who, deposit_dust)?;
    
    // 5. è®°å½•æŠ¼é‡‘ä¿¡æ¯
    let deposit_record = DivinationDepositRecord {
        record_id,
        divination_type,
        owner: who.clone(),
        deposit_usdt,
        deposit_dust,
        exchange_rate,
        locked_at: <frame_system::Pallet<T>>::block_number(),
        status: DepositStatus::Active,
    };
    
    DivinationDepositRecords::<T>::insert(
        (divination_type, record_id),
        deposit_record,
    );
    
    // 6. æ›´æ–°ç”¨æˆ·æŠ¼é‡‘ä½™é¢
    UserDepositBalances::<T>::mutate(who, |balance| {
        balance.total_locked_usdt = balance.total_locked_usdt.saturating_add(deposit_usdt);
        balance.total_locked_dust = balance.total_locked_dust.saturating_add(deposit_dust);
        balance.record_count = balance.record_count.saturating_add(1);
        balance.last_updated = <frame_system::Pallet<T>>::block_number();
    });
    
    // 7. å‘å‡ºäº‹ä»¶
    Self::deposit_event(Event::DepositLocked {
        account: who.clone(),
        record_id,
        divination_type,
        deposit_usdt,
        deposit_dust,
    });
    
    Ok(())
}
```

#### 3.2 åˆ é™¤è®°å½•æ—¶é€€è¿˜æŠ¼é‡‘

```rust
/// åˆ é™¤è®°å½•æ—¶é€€è¿˜æŠ¼é‡‘
fn refund_deposit_on_delete(
    who: &T::AccountId,
    record_id: u64,
    divination_type: DivinationType,
) -> DispatchResult {
    // 1. è·å–æŠ¼é‡‘è®°å½•
    let deposit_record = DivinationDepositRecords::<T>::get((divination_type, record_id))
        .ok_or(Error::<T>::DepositRecordNotFound)?;
    
    // 2. éªŒè¯æ‰€æœ‰æƒ
    ensure!(
        deposit_record.owner == *who,
        Error::<T>::NotDepositOwner
    );
    
    // 3. æ£€æŸ¥æŠ¼é‡‘çŠ¶æ€
    ensure!(
        deposit_record.status == DepositStatus::Active,
        Error::<T>::DepositNotActive
    );
    
    // 4. è§£é”æŠ¼é‡‘
    T::Currency::unreserve(who, deposit_record.deposit_dust);
    
    // 5. æ›´æ–°æŠ¼é‡‘è®°å½•çŠ¶æ€
    DivinationDepositRecords::<T>::mutate(
        (divination_type, record_id),
        |record| {
            if let Some(r) = record {
                r.status = DepositStatus::Released;
            }
        },
    );
    
    // 6. æ›´æ–°ç”¨æˆ·æŠ¼é‡‘ä½™é¢
    UserDepositBalances::<T>::mutate(who, |balance| {
        balance.total_locked_usdt = balance.total_locked_usdt
            .saturating_sub(deposit_record.deposit_usdt);
        balance.total_locked_dust = balance.total_locked_dust
            .saturating_sub(deposit_record.deposit_dust);
        balance.record_count = balance.record_count.saturating_sub(1);
        balance.last_updated = <frame_system::Pallet<T>>::block_number();
    });
    
    // 7. å‘å‡ºäº‹ä»¶
    Self::deposit_event(Event::DepositRefunded {
        account: who.clone(),
        record_id,
        divination_type,
        refunded_usdt: deposit_record.deposit_usdt,
        refunded_dust: deposit_record.deposit_dust,
    });
    
    Ok(())
}
```

