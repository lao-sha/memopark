# 做市商快速审批 - 投票状态显示功能说明

## 📋 功能更新概述

**版本：** v1.1.0  
**更新日期：** 2025-10-15  
**更新内容：** 添加投票状态显示和智能按钮禁用功能

---

## ✨ 新增功能

### 1. 审核状态列

在"待审批申请"表格中新增"审核状态"列，实时显示每个申请的投票进度：

| 状态显示 | 说明 | 示例 |
|---------|------|------|
| 未发起提案 | 该申请还没有任何提案 | ![灰色标签] |
| 1/2 票 | 已有1票赞成，需要2票 | ![蓝色进度标签] |
| 2/2 票 ✅ 可执行 | 已达到阈值，可以执行 | ![绿色成功标签] |
| 已投票 | 当前账户已对该提案投票 | ![蓝色"已投票"标签] |

### 2. 智能操作按钮

根据投票状态自动调整操作按钮的显示：

#### 情况 A：未投票（正常状态）

```
按钮文本：
- 如果提案不存在 → "一键批准"
- 如果提案已存在 → "继续投票"

按钮状态：启用
```

#### 情况 B：已投票但未达到阈值

```
显示内容：
┌─────────────────┐
│ 🔵 已投票       │
│ 等待其他成员投票 │
└─────────────────┘

按钮状态：禁用（显示为标签）
```

#### 情况 C：已投票且已达到阈值

```
显示内容：
┌─────────────────┐
│ ✅ 已投票·可执行 │
│ 请在普通审批页面 │
│ 执行              │
└─────────────────┘

按钮状态：禁用（显示为标签）
```

### 3. 自动状态检测

页面加载时自动检测：
- ✅ 每个申请是否有提案
- ✅ 提案的投票状态
- ✅ 当前账户是否已投票
- ✅ 是否达到执行阈值

### 4. 智能确认对话框

点击操作按钮时，根据提案状态显示不同的提示：

**如果提案已存在：**
```
┌────────────────────────┐
│ ℹ️ 提案已存在          │
│ 将跳过创建提案步骤，   │
│ 直接投票               │
└────────────────────────┘

将自动执行以下步骤：
1. 校验 Council 成员资格
2. 投赞成票
3. 如果达到阈值，关闭并执行提案
```

**如果提案不存在：**
```
将自动执行以下步骤：
1. 校验 Council 成员资格
2. 发起批准提案
3. 投赞成票
4. 如果达到阈值，关闭并执行提案
```

---

## 🎯 使用场景

### 场景 1：首次审批

1. **状态显示**：`未发起提案`
2. **操作按钮**：`一键批准`
3. **点击后**：自动创建提案并投票

### 场景 2：继续投票

1. **状态显示**：`1/2 票`
2. **操作按钮**：`继续投票`
3. **点击后**：跳过创建提案，直接投票

### 场景 3：已投票等待

1. **状态显示**：`1/2 票` + `已投票`
2. **操作显示**：`已投票 - 等待其他成员投票`（灰色标签）
3. **操作**：无法再次投票，需要等待其他成员

### 场景 4：可执行

1. **状态显示**：`2/2 票 ✅ 可执行` + `已投票`
2. **操作显示**：`已投票·可执行 - 请在普通审批页面执行`（绿色标签）
3. **操作**：访问普通审批页面执行提案

---

## 📊 界面示例

### 表格显示（新增审核状态列）

| MM ID | 申请人 | 押金 | 首购资金池 | Epay配置 | **审核状态** | 操作 |
|-------|--------|------|-----------|---------|------------|------|
| 0 | 5CSep...BJh9 | 1000 MEMO | 10000 MEMO | ✅ 已配置 | **未发起提案** | `一键批准` |
| 1 | 5CotZ...DFgSq | 1000 MEMO | 10000 MEMO | ✅ 已配置 | **1/2 票** | `继续投票` |
| 2 | 5CrDB...HUW4 | 1000 MEMO | 10000 MEMO | ✅ 已配置 | **1/2 票<br/>🔵 已投票** | `已投票<br/>等待其他成员` |
| 3 | 5Daa...XYz | 1000 MEMO | 10000 MEMO | ✅ 已配置 | **2/2 票<br/>✅ 可执行<br/>🔵 已投票** | `已投票·可执行<br/>请在普通审批页面执行` |

---

## 🔧 技术实现

### 数据加载流程

```typescript
loadApplications() {
  // 1. 加载所有待审批申请
  const apps = await api.query.marketMaker.applications.entries()
  
  // 2. 对每个申请检查提案状态
  for (const app of apps) {
    const innerCall = api.tx.marketMaker.approve(app.id)
    const proposalHash = innerCall.method.hash.toHex()
    
    // 3. 查询提案是否存在
    const proposalOpt = await api.query.council.proposalOf(proposalHash)
    
    if (proposalOpt.isSome) {
      // 4. 获取投票信息
      const votingOpt = await api.query.council.voting(proposalHash)
      const voting = votingOpt.unwrap().toJSON()
      
      // 5. 检查当前账户是否已投票
      const hasVoted = voting.ayes.includes(activeAccount) || 
                      voting.nays.includes(activeAccount)
      
      // 6. 保存状态信息
      app.hasProposal = true
      app.hasVoted = hasVoted
      app.votingInfo = {
        ayes: voting.ayes.length,
        nays: voting.nays.length,
        threshold: voting.threshold
      }
    }
  }
}
```

### 界面渲染逻辑

```typescript
// 审核状态列
{
  title: '审核状态',
  render: (record) => {
    if (!record.hasProposal) {
      return <Tag color="default">未发起提案</Tag>
    }
    
    const reachedThreshold = record.votingInfo.ayes >= record.votingInfo.threshold
    
    return (
      <Space direction="vertical">
        <Tag color={reachedThreshold ? 'success' : 'processing'}>
          {record.votingInfo.ayes}/{record.votingInfo.threshold} 票
        </Tag>
        {record.hasVoted && <Tag color="blue">已投票</Tag>}
        {reachedThreshold && <Text type="success">✅ 可执行</Text>}
      </Space>
    )
  }
}

// 操作列
{
  title: '操作',
  render: (record) => {
    const reachedThreshold = record.votingInfo?.ayes >= record.votingInfo?.threshold
    const hasVoted = record.hasVoted
    
    // 已投票且已达到阈值
    if (hasVoted && reachedThreshold) {
      return (
        <Space direction="vertical">
          <Tag color="success">已投票·可执行</Tag>
          <Text type="secondary">请在普通审批页面执行</Text>
        </Space>
      )
    }
    
    // 已投票但未达到阈值
    if (hasVoted) {
      return (
        <Space direction="vertical">
          <Tag color="blue">已投票</Tag>
          <Text type="secondary">等待其他成员投票</Text>
        </Space>
      )
    }
    
    // 未投票，显示操作按钮
    return (
      <Button onClick={...} disabled={isProcessing}>
        {record.hasProposal ? '继续投票' : '一键批准'}
      </Button>
    )
  }
}
```

---

## ⚠️ 注意事项

### 1. 账户切换

- 当切换账户时，页面会自动重新加载
- 投票状态会根据新账户重新计算

### 2. 数据更新

- 页面会在以下情况自动刷新：
  - 完成一键批准操作后
  - 手动点击"刷新"按钮后
  - 切换账户后

### 3. 已投票的提示

- 如果账户已投票，即使提案未达到阈值，也无法再次投票
- 需要等待其他 Council 成员投票
- 或者切换到其他 Council 成员账户继续投票

### 4. 执行提案

- 当提案达到阈值后，快速审批页面不会自动执行
- 需要访问"普通审批页面"手动关闭提案
- 或者再次点击"继续投票"，自动化流程会尝试执行

---

## 🐛 常见问题

### Q1: 为什么我已经投票了，但状态显示"未投票"？

**可能原因：**
- 账户切换了，当前账户不是之前投票的账户
- 页面缓存未更新

**解决方法：**
1. 点击"刷新"按钮重新加载数据
2. 硬刷新浏览器（Ctrl+Shift+R）
3. 确认当前选择的账户是否正确

### Q2: 状态显示"可执行"，但无法执行？

**原因：**
- 快速审批页面已投票的账户无法再次操作
- 需要在普通审批页面执行

**解决方法：**
访问"治理工具 → 做市商审批"页面，找到对应提案，点击"关闭提案"

### Q3: 如何强制刷新投票状态？

**方法：**
1. 点击页面顶部的"刷新"按钮
2. 硬刷新浏览器（Ctrl+Shift+R）
3. 切换到其他页面再切换回来

---

## 🔗 相关文档

- [做市商快速审批使用说明](./做市商快速审批页面使用说明.md)
- [做市商审批页面（普通流程）](/market-maker-governance)

---

## 📝 更新日志

### v1.1.0 (2025-10-15)

- ✅ 新增"审核状态"列
- ✅ 实现智能操作按钮（根据投票状态自动调整）
- ✅ 添加已投票状态检测
- ✅ 优化确认对话框提示信息
- ✅ 账户切换时自动重新加载数据
- ✅ 修复 `wasm unreachable` 错误（避免重复投票）

### v1.0.0 (2025-10-15)

- ✅ 初始版本发布
- ✅ 实现一键批准功能

---

**状态：** ✅ 已完成  
**最后更新：** 2025-10-15  
**适用版本：** memopark-governance v1.1.0

