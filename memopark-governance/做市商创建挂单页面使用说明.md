# 做市商创建挂单页面使用说明

## 📋 功能概述

**做市商创建挂单页面** 允许已审批通过的做市商创建 OTC 挂单，买家可以直接购买 MEMO 代币。

## 🎯 页面访问

**访问路径：** `http://localhost:3001/market-maker-listing`

**菜单位置：** 治理工具 → 做市商创建挂单

**权限要求：** 只有已审批通过的做市商才能访问

---

## ✨ 主要功能

### 1. 创建挂单

做市商可以创建卖单（暂不支持买单），设置以下参数：

| 参数 | 说明 | 示例 |
|------|------|------|
| **交易方向** | 买入/卖出 | 卖出 (Sell) |
| **交易对** | 基础货币/计价货币 | 0/1 (MEMO/CNY) |
| **价格 Spread** | 基于链上价格的扩展（基点） | 200 (2%) |
| **最小数量** | 单笔最小交易量 | 100 MEMO |
| **最大数量** | 单笔最大交易量 | 10000 MEMO |
| **总量** | 挂单总库存 | 100000 MEMO |
| **部分成交** | 是否允许部分成交 | 是/否 |
| **价格范围** | 可选的最低价/最高价 | 6.00 - 7.00 CNY |
| **有效期** | 挂单有效区块数 | 28800 (约1天) |
| **条款 CID** | IPFS CID，包含交易条款 | Qm... |

### 2. 查看挂单列表

显示当前账户创建的所有活跃挂单：

- 挂单ID
- 交易方向（买/卖）
- 交易对
- 价格 Spread
- 数量范围
- 总量/剩余
- 过期区块
- 状态
- 操作（取消）

### 3. 取消挂单

做市商可以随时取消自己的挂单：
- 取消后挂单状态变为"已下架"
- 退回剩余库存到账户
- 退回保证金（如有）

---

## 🚀 使用步骤

### 前提条件

1. ✅ 账户已申请做市商资格
2. ✅ 申请已通过审批（状态为 Approved）
3. ✅ 账户有足够的 MEMO 余额作为挂单库存
4. ✅ 账户有足够的余额支付上架费和保证金（如有）

### 步骤 1: 访问页面

在侧边栏点击：**治理工具 → 做市商创建挂单**

### 步骤 2: 填写挂单信息

#### 基本信息

**交易方向：**
- 当前仅支持"卖出 (Sell)"
- 买入功能暂未开放

**交易对：**
- 基础货币 ID: 0 (MEMO)
- 计价货币 ID: 1 (CNY)

**价格 Spread (基点)：**
- 范围：0-10000 (0%-100%)
- 示例：200 = 2%
- 说明：基于链上价格的扩展

#### 数量设置

**最小数量：**
- 单笔交易最小数量
- 示例：100 MEMO
- 说明：小于此数量的订单会被拒绝

**最大数量：**
- 单笔交易最大数量
- 示例：10000 MEMO
- 说明：大于此数量的订单会被拒绝

**总量：**
- 挂单总库存
- 示例：100000 MEMO
- **重要：** 创建时会立即锁定此数量到托管

**允许部分成交：**
- 开启：买家可以购买小于挂单剩余数量
- 关闭：买家必须购买完整剩余数量

#### 高级设置（可选）

**价格范围：**
- 最低价：例如 6.00 CNY
- 最高价：例如 7.00 CNY
- 说明：不填写则不限制价格范围

**有效期 (区块数)：**
- 当前区块：显示在表单下方
- 示例：28800 块 ≈ 1天（假设6秒/块）
- 说明：到期后挂单自动下架并退款

**条款承诺 CID：**
- IPFS CID
- 示例：QmXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
- 说明：包含交易条款、服务协议等

### 步骤 3: 提交创建

点击"创建挂单"按钮：

1. **输入密码** 签名交易
2. **等待确认** 交易打包到区块
3. **查看结果** 成功后显示区块哈希
4. **刷新列表** 2秒后自动刷新挂单列表

### 步骤 4: 管理挂单

在"我的挂单"表格中：

**查看挂单状态：**
- ID：挂单编号
- 方向：买入/卖出
- 交易对：货币对
- Spread：价格扩展
- 数量范围：最小-最大
- 总量/剩余：库存信息
- 过期区块：有效期
- 状态：活跃/已下架

**取消挂单：**
- 点击"取消"按钮
- 确认取消
- 输入密码签名
- 等待确认

---

## ⚠️ 注意事项

### 1. 权限要求

- **必须是已审批通过的做市商**
- 非做市商账户会看到权限提示
- 申请审批中的账户需要等待审批通过

### 2. 资金锁定

- 创建挂单时会**立即锁定**总量到托管
- 锁定的资金不能用于其他用途
- 取消挂单后退回剩余库存
- 部分成交会逐步释放已售部分

### 3. 上架费和保证金

- 上架费：一次性支付（配置值）
- 保证金：锁定到托管，取消时退回（配置值）
- 默认情况下可能都为 0（关闭）

### 4. 有效期管理

- 挂单到期后自动下架
- 系统在区块 `on_initialize` 中处理过期
- 到期后自动退回剩余库存和保证金

### 5. 限频控制

- 滑动窗口限频：防止刷屏
- 窗口大小：配置值（例如100个区块）
- 窗口内最多创建：配置值（例如10个挂单）
- 超出限制会报错

### 6. 余额要求

创建挂单前确保账户有足够余额：

```
所需余额 = 挂单总量 + 上架费 + 保证金 + 交易手续费
```

示例：
```
挂单总量: 100000 MEMO
上架费: 0 MEMO (假设为0)
保证金: 0 MEMO (假设为0)
交易手续费: 约 0.01 MEMO

总计: 100000.01 MEMO
```

---

## 📊 界面示例

### 创建挂单表单

```
┌─────────────────────────────────────┐
│ 创建新挂单                          │
├─────────────────────────────────────┤
│ 交易方向:  [卖出 (Sell) ▼]         │
│                                     │
│ 交易对:                             │
│   基础货币ID: [0 (MEMO)]           │
│   计价货币ID: [1 (CNY)]            │
│                                     │
│ 价格 Spread: [200] bps (2%)        │
│                                     │
│ 最小数量: [100.00] MEMO            │
│ 最大数量: [10000.00] MEMO          │
│ 总量: [100000.00] MEMO             │
│                                     │
│ 允许部分成交: [√] 是               │
│                                     │
│ 价格范围:                           │
│   最低价: [6.00] CNY               │
│   最高价: [7.00] CNY               │
│                                     │
│ 有效期: [28800] 块 (约1天)         │
│                                     │
│ 条款 CID: [Qm...]                  │
│                                     │
│         [创建挂单]                  │
└─────────────────────────────────────┘
```

### 挂单列表

```
┌─────────────────────────────────────────────────────────────────────┐
│ 我的挂单 (3)                                         [刷新]         │
├────┬──────┬──────┬────────┬──────────┬──────────┬──────────┬──────┤
│ ID │ 方向 │交易对│ Spread │ 数量范围 │ 总量/剩余 │ 过期区块 │ 操作 │
├────┼──────┼──────┼────────┼──────────┼──────────┼──────────┼──────┤
│ 0  │ 卖出 │ 0/1  │ 2%     │ 100-     │ 总: 100k │ 150000   │[取消]│
│    │      │      │        │ 10000    │ 剩: 80k  │ 剩28000块│      │
├────┼──────┼──────┼────────┼──────────┼──────────┼──────────┼──────┤
│ 1  │ 卖出 │ 0/1  │ 3%     │ 500-     │ 总: 50k  │ 145000   │[取消]│
│    │      │      │        │ 20000    │ 剩: 50k  │ 剩23000块│      │
└────┴──────┴──────┴────────┴──────────┴──────────┴──────────┴──────┘
```

---

## 🐛 常见问题

### Q1: 为什么我看到"权限不足"提示？

**可能原因：**
- 账户未申请做市商
- 申请正在审批中
- 申请被驳回

**解决方法：**
1. 在用户端 dapp 申请做市商资格
2. 等待审批通过
3. 审批通过后即可访问

### Q2: 创建挂单时提示"余额不足"？

**原因：**
- 账户可用余额 < 挂单总量 + 费用

**解决方法：**
1. 检查账户余额
2. 减少挂单总量
3. 或者充值更多 MEMO

### Q3: 为什么不能创建买单？

**原因：**
- 当前系统配置为仅允许卖单
- `AllowBuyListings` 参数为 false

**解决方法：**
- 等待治理投票开启买单功能
- 或联系管理员

### Q4: 创建挂单时提示"限频超限"？

**原因：**
- 短时间内创建了太多挂单
- 触发了滑动窗口限频

**解决方法：**
- 等待一段时间后再试
- 或减少创建频率

### Q5: 挂单到期后怎么办？

**自动处理：**
- 系统会自动下架挂单
- 自动退回剩余库存
- 自动退回保证金

**无需手动操作**

### Q6: 如何查看挂单的详细信息？

**方法：**
1. 在"我的挂单"表格中查看
2. 或访问区块链浏览器
3. 查询 `otcListing.listings(id)`

---

## 🔗 相关功能

### 做市商审批

- **审批页面：** /market-maker-governance
- **快速审批：** /market-maker-quick-approval
- **说明：** 创建挂单前必须先通过审批

### OTC 订单

- **买家购买：** 在用户端 dapp
- **订单管理：** 查看成交记录

---

## 📝 技术参数

### 货币 ID 对照表

| ID | 货币 | 说明 |
|----|------|------|
| 0 | MEMO | 主网代币 |
| 1 | CNY | 人民币 |

### Spread 计算

```
实际价格 = 链上价格 × (1 + Spread / 10000)

示例：
链上价格: 6.50 CNY
Spread: 200 bps (2%)
实际价格 = 6.50 × (1 + 200/10000) = 6.50 × 1.02 = 6.63 CNY
```

### 有效期估算

假设区块时间为 6 秒：

| 区块数 | 时间 |
|--------|------|
| 600 | 约 1 小时 |
| 14400 | 约 1 天 |
| 28800 | 约 2 天 |
| 100800 | 约 1 周 |
| 432000 | 约 1 个月 |

---

## 🔐 安全提示

1. **保管好钱包密码**
   - 创建挂单需要签名
   - 不要在公共场合输入密码

2. **合理设置数量**
   - 不要锁定全部余额
   - 保留一些余额用于其他用途

3. **注意价格范围**
   - 设置合理的价格上下限
   - 避免价格异常波动

4. **定期检查挂单**
   - 查看剩余库存
   - 及时调整或取消

---

## 📊 更新日志

### v1.0.0 (2025-10-15)

- ✅ 初始版本发布
- ✅ 支持创建卖单
- ✅ 支持设置价格、数量、有效期
- ✅ 支持查看和取消挂单
- ✅ 自动检测做市商资格
- ✅ 实时显示当前区块高度

---

**状态：** ✅ 已完成  
**最后更新：** 2025-10-15  
**适用版本：** memopark-governance v1.0.0

