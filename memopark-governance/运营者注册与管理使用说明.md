# 运营者注册与管理使用说明

## 概述

运营者管理页面提供了完整的 IPFS 存储运营者生命周期管理功能，包括：
- 注册成为运营者
- 查看运营者列表及 SLA 统计
- 执行奖励分配（需要治理权限）
- 监控运营者状态

## 访问入口

在治理平台侧边栏中，点击 **运营者管理** 菜单项，访问 `/operator-management` 路由。

---

## 功能模块

### 1. 数据统计概览

页面顶部显示 4 个统计卡片：

| 指标 | 说明 |
|------|------|
| 运营者总数 | 系统中注册的所有运营者数量 |
| 活跃运营者 | 当前状态为"活跃"的运营者数量 |
| 总容量 | 所有运营者声明的存储容量总和（GB） |
| 已用存储 | 当前所有运营者实际存储的数据总量（GB） |

**刷新频率**：每 30 秒自动刷新一次，或手动点击"刷新数据"按钮。

---

### 2. 注册为运营者

#### 2.1 准备工作

在注册之前，您需要完成以下准备：

1. **部署 IPFS 节点**
   - 安装并运行 IPFS Daemon
   - 获取您的 Peer ID（通过 `ipfs id` 命令）

2. **部署 IPFS Cluster**
   - 安装并运行 IPFS Cluster
   - 配置 API 端点（默认端口 9094）
   - 确保端点可从链端访问（公网 IP 或内网穿透）

3. **准备资金**
   - 账户中有足够的 MEMO 代币
   - 至少准备 1000 MEMO 作为保证金

#### 2.2 注册步骤

1. **点击"注册为运营者"按钮**
   
   页面将弹出注册表单对话框。

2. **填写注册信息**

   | 字段 | 说明 | 示例 | 验证规则 |
   |------|------|------|----------|
   | IPFS Peer ID | 您的 IPFS 节点 Peer ID | `QmXXXXXX...` | 必填，至少 40 个字符 |
   | 存储容量（GB） | 愿意提供的存储空间 | `1000` | 必填，最小 100 GB |
   | IPFS 集群端点 | Cluster API 地址 | `http://your-ipfs:9094` | 必填，有效 URL |
   | 保证金（MEMO） | 质押的保证金数量 | `1000` | 必填，最小 1000 MEMO |

3. **提交注册**

   - 点击"提交注册"按钮
   - 钱包插件弹出签名确认
   - 签名并发送交易
   - 等待交易上链（约 6-12 秒）

4. **注册成功**

   - 收到"注册成功"提示
   - 您的账户出现在运营者列表中
   - 保证金已被锁定
   - OCW 将开始为您分配 pin 任务

#### 2.3 注册要求

- ✅ 部署并运行 IPFS 节点
- ✅ 部署并运行 IPFS Cluster
- ✅ 提供至少 100 GB 存储空间
- ✅ 质押至少 1000 MEMO 作为保证金
- ✅ 保持节点在线（建议 > 95%）

---

### 3. 运营者列表

#### 3.1 列表字段说明

| 列名 | 说明 |
|------|------|
| 运营者账户 | 运营者的链上账户地址（简短显示） |
| 存储容量 | 声明的总存储容量（GB） |
| 已用存储 | 当前实际存储的数据量（GB） |
| 使用率 | 已用存储 / 总容量（%） |
| 可靠性 | 探测成功率，包含进度条和成功/失败次数 |
| 权重 | 计算的奖励权重（存储量 × 可靠性因子） |
| 保证金 | 质押的 MEMO 数量 |
| 状态 | 活跃 / 暂停 / 封禁 |

#### 3.2 可靠性显示

可靠性列包含两部分：
- **进度条**：
  - 绿色（≥ 90%）：优秀
  - 黄色（70% - 90%）：正常
  - 红色（< 70%）：需要改进
- **统计数字**：
  - ✅ 探测成功次数
  - ❌ 探测失败次数

#### 3.3 排序和筛选

- **点击列标题**：按该列排序
- **支持排序的列**：存储容量、已用存储、可靠性、权重
- **状态筛选**：点击"状态"列的筛选图标，选择活跃/暂停/封禁

---

### 4. 执行奖励分配

#### 4.1 权限要求

⚠️ **此功能需要治理权限**：
- Root 账户
- 或技术委员会成员

#### 4.2 分配步骤

1. **点击"执行奖励分配"按钮**

   对话框显示：
   - 当前托管账户余额
   - 活跃运营者数量

2. **设置分配金额**

   - 输入要分配的 MEMO 数量
   - 输入 `0` 表示分配托管账户的全部余额

3. **确认分配**

   - 点击"确认分配"
   - 钱包插件弹出签名确认
   - 签名并发送交易

4. **自动分配**

   链端将自动执行以下逻辑：
   - 计算每个活跃运营者的权重
   - 按权重比例分配奖励
   - 直接将奖励转入运营者账户

#### 4.3 权重计算公式

```
权重 = 已存储字节数 × 可靠性因子
可靠性因子 = 探测成功次数 / (探测成功次数 + 探测失败次数)
```

**示例**：
- 运营者 A：已存储 500 GB，可靠性 95%
  - 权重 = 500 × 0.95 = 475
- 运营者 B：已存储 300 GB，可靠性 80%
  - 权重 = 300 × 0.80 = 240

分配比例：
- 运营者 A：475 / (475 + 240) = 66.4%
- 运营者 B：240 / (475 + 240) = 33.6%

---

## 运营者最佳实践

### 1. 硬件要求

| 资源 | 最低配置 | 推荐配置 |
|------|----------|----------|
| CPU | 2 核 | 4 核+ |
| 内存 | 4 GB | 8 GB+ |
| 存储 | 500 GB SSD | 1 TB+ NVMe SSD |
| 网络 | 100 Mbps | 1 Gbps+ |

### 2. 节点维护

- **保持在线**：建议在线率 > 95%
- **及时响应**：确保 OCW 探测请求 < 5 秒响应
- **定期备份**：备份 IPFS 数据和 Cluster 配置
- **监控告警**：配置磁盘空间、网络状态监控

### 3. 保证金管理

- **风险提示**：如果可靠性长期低于阈值，保证金可能被罚没
- **增加保证金**：通过治理提案调整您的保证金金额
- **退出流程**：先调用 `leave_operator`，等待解锁期后提取保证金

### 4. 收益预期

**收益来源**：
- IPFS pin 服务费（从托管账户分配）
- 可靠性越高、存储量越大，收益越高

**计算示例**（假设托管账户每日分配 10000 MEMO）：
- 您的权重占总权重的 10%
- 预计每日收益：10000 × 10% = 1000 MEMO

---

## 常见问题

### Q1: 注册失败，提示"保证金不足"

**原因**：账户余额不足以支付保证金 + 交易手续费

**解决**：确保账户中至少有 `保证金金额 + 10 MEMO`（预留手续费）

---

### Q2: 注册成功，但从未收到 pin 任务

**排查步骤**：
1. 检查 IPFS Cluster 是否正常运行：`ipfs-cluster-ctl peers ls`
2. 检查端点是否可访问：`curl http://your-endpoint:9094/version`
3. 查看链端日志：是否有 OCW 探测失败记录
4. 检查您的状态：是否被暂停或封禁

---

### Q3: 可靠性一直很低，如何改进？

**原因**：OCW 探测失败次数过多

**改进措施**：
- 检查网络连通性（防火墙、安全组规则）
- 增加 IPFS Cluster 资源（CPU、内存）
- 优化 IPFS 配置（增加连接数限制）
- 使用稳定的云服务器（避免家庭宽带）

---

### Q4: 如何查看我的实时 SLA 统计？

在运营者列表中找到您的账户行，查看：
- **已用存储**：当前存储的数据量
- **可靠性**：实时探测成功率
- **权重**：您当前的奖励权重

---

### Q5: 如何退出运营者？

⚠️ **退出流程**（需要链端实现 `leave_operator` extrinsic）：
1. 调用 `leave_operator()` 发起退出
2. 等待解锁期（例如 7 天）
3. 调用 `withdraw_bond()` 提取保证金

**注意**：退出后您将不再收到 pin 任务和奖励。

---

## 技术细节

### 数据来源

- **运营者信息**：`memoIpfs.operators` 存储映射
- **SLA 统计**：`memoIpfs.operatorSla` 存储映射
- **保证金**：`memoIpfs.operatorBond` 存储映射
- **托管账户**：从 `OperatorEscrowPalletId` 派生

### 交易接口

**注册运营者**：
```rust
memoIpfs.joinOperator(
    peer_id: Vec<u8>,
    capacity_gib: u32,
    endpoint_hash: Hash,
    cert_fingerprint: Option<Vec<u8>>,
    bond: Balance
)
```

**分配奖励**（需要治理权限）：
```rust
memoIpfs.distributeToOperators(
    max_amount: Balance
)
```

### 事件监听

- `OperatorJoined`：运营者注册成功
- `OperatorRewarded`：单个运营者收到奖励
- `RewardDistributed`：奖励分配完成

---

## 安全提示

1. **保护私钥**：运营者账户私钥泄露将导致保证金被盗
2. **使用 HTTPS**：IPFS Cluster API 端点建议使用 HTTPS + 证书
3. **监控异常**：定期检查账户余额和 SLA 统计
4. **备份数据**：定期备份 IPFS 数据，避免数据丢失

---

## 联系支持

如有问题，请通过以下方式联系：
- GitHub Issues: [memopark/issues](https://github.com/memopark/memopark/issues)
- 治理论坛: [forum.memopark.io](https://forum.memopark.io)
- 技术委员会提案：通过链上提案反馈问题

---

**最后更新**：2025-10-13

