# æ²»ç†å¹³å°ç®€å•è¯Šæ–­ - ä¸¤æ­¥èµ°

## ğŸ¯ é—®é¢˜

åœ¨æµè§ˆå™¨æ§åˆ¶å°è¿è¡Œè¯Šæ–­æ—¶é‡åˆ°ï¼š`Cannot read properties of undefined (reading 'query')`

**åŸå› **ï¼šæ²»ç†å¹³å°çš„ API åœ¨ React Context ä¸­ï¼Œä¸åœ¨ `window.api`

---

## âœ… è§£å†³æ–¹æ³•ï¼ˆä¸¤æ­¥èµ°ï¼‰

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»º API è¿æ¥

åœ¨æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰ç²˜è´´ä»¥ä¸‹ä»£ç ï¼š

```javascript
// ç¬¬ä¸€æ­¥ï¼šåˆ›å»º API è¿æ¥
(async () => {
  console.log('æ­£åœ¨è¿æ¥é“¾ç«¯...')
  
  try {
    // ä»é¡µé¢åŠ è½½çš„ @polkadot/api è·å–
    const polkadotApi = window.polkadotApi || await import('https://cdn.jsdelivr.net/npm/@polkadot/api@latest/+esm')
    const { ApiPromise, WsProvider } = polkadotApi
    
    // åˆ›å»º WebSocket è¿æ¥
    const provider = new WsProvider('ws://127.0.0.1:9944')
    
    // åˆ›å»º API å®ä¾‹
    window.__MEMOPARK_API__ = await ApiPromise.create({ provider })
    
    console.log('âœ… API è¿æ¥æˆåŠŸï¼')
    console.log('ç°åœ¨å¯ä»¥è¿è¡Œç¬¬äºŒæ­¥äº†')
    
  } catch (e) {
    console.error('âŒ è¿æ¥å¤±è´¥:', e)
    console.log('è¯·ç¡®è®¤ï¼š')
    console.log('1. é“¾ç«¯æ˜¯å¦åœ¨è¿è¡Œï¼Ÿ')
    console.log('2. WebSocket ç«¯å£æ˜¯å¦æ˜¯ 9944ï¼Ÿ')
  }
})()
```

**ç­‰å¾…è¾“å‡º**ï¼š`âœ… API è¿æ¥æˆåŠŸï¼`

---

### ç¬¬äºŒæ­¥ï¼šè¿è¡Œè¯Šæ–­

åœ¨æ§åˆ¶å°ç²˜è´´ä»¥ä¸‹ä»£ç ï¼š

```javascript
// ç¬¬äºŒæ­¥ï¼šè¿è¡Œè¯Šæ–­
(async () => {
  const api = window.__MEMOPARK_API__
  
  if (!api) {
    console.error('âŒ API æœªåˆ›å»ºï¼Œè¯·å…ˆè¿è¡Œç¬¬ä¸€æ­¥')
    return
  }
  
  console.group('ğŸ” è¯Šæ–­ç»“æœ')
  
  try {
    // æ£€æŸ¥ mmId=1
    const mmId = 1
    console.log('æ£€æŸ¥ mmId=' + mmId)
    
    const appOption = await api.query.marketMaker.applications(mmId)
    
    if (appOption.isNone) {
      console.error('âŒ mmId=' + mmId + ' ä¸å­˜åœ¨ï¼')
      console.log('\nğŸ’¡ è§£å†³æ–¹æ³•ï¼š')
      console.log('1. åˆ°ç”¨æˆ·ç«¯åˆ›å»ºç”³è¯·')
      console.log('   è®¿é—®: http://localhost:5173/#/otc/market-maker-create')
      console.log('2. å®Œæˆè´¨æŠ¼ + æäº¤èµ„æ–™')
      console.log('3. è®°å½•ç”Ÿæˆçš„ mmIdï¼ˆå¯èƒ½æ˜¯ 0ï¼‰')
      console.log('4. å›åˆ°æ²»ç†å¹³å°ï¼Œä½¿ç”¨æ­£ç¡®çš„ mmId')
      
      // æŸ¥çœ‹æ‰€æœ‰ç”³è¯·
      console.log('\næŸ¥è¯¢æ‰€æœ‰ç°æœ‰ç”³è¯·ï¼š')
      const entries = await api.query.marketMaker.applications.entries()
      
      if (entries.length === 0) {
        console.log('ğŸ“­ å½“å‰æ²¡æœ‰ä»»ä½•ç”³è¯·')
      } else {
        console.log('æ‰¾åˆ° ' + entries.length + ' ä¸ªç”³è¯·ï¼š')
        entries.forEach(([key, value]) => {
          const id = key.args[0].toNumber()
          const app = value.unwrap().toJSON()
          console.log('  mmId=' + id + ', status=' + app.status)
        })
      }
      
    } else {
      // ç”³è¯·å­˜åœ¨
      const appData = appOption.unwrap().toJSON()
      
      console.log('âœ… mmId=' + mmId + ' å­˜åœ¨')
      console.log('çŠ¶æ€: ' + appData.status)
      console.log('ç”³è¯·äºº: ' + appData.owner)
      
      // æ£€æŸ¥çŠ¶æ€
      if (appData.status !== 'PendingReview') {
        console.error('âŒ çŠ¶æ€ä¸å¯¹ï¼')
        console.log('å½“å‰çŠ¶æ€: ' + appData.status)
        console.log('éœ€è¦çŠ¶æ€: PendingReview')
        
        if (appData.status === 'DepositLocked') {
          console.log('\nğŸ’¡ éœ€è¦å®Œæˆç¬¬äºŒæ­¥ï¼šæäº¤èµ„æ–™')
          console.log('è®¿é—®ç”¨æˆ·ç«¯å®Œæˆç”³è¯·æµç¨‹')
        } else if (appData.status === 'Active') {
          console.log('\nğŸ’¡ è¯¥ç”³è¯·å·²è¢«æ‰¹å‡†ï¼Œæ— éœ€åˆ›å»ºææ¡ˆ')
        }
        
      } else {
        console.log('âœ… çŠ¶æ€æ­£ç¡®')
        
        // æµ‹è¯•æ„å»ºäº¤æ˜“
        console.log('\nğŸ§ª æµ‹è¯•æ„å»ºäº¤æ˜“ï¼š')
        try {
          const innerCall = api.tx.marketMaker.approve(mmId)
          const proposeTx = api.tx.council.propose(2, innerCall, innerCall.encodedLength)
          console.log('âœ… äº¤æ˜“æ„å»ºæˆåŠŸ')
          console.log('\næ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼å¦‚æœä»å¤±è´¥ï¼Œå¯èƒ½éœ€è¦é‡æ–°ç¼–è¯‘é“¾ç«¯')
        } catch (e) {
          console.error('âŒ äº¤æ˜“æ„å»ºå¤±è´¥:', e)
        }
      }
    }
    
  } catch (e) {
    console.error('âŒ è¯Šæ–­å¤±è´¥:', e)
  } finally {
    console.groupEnd()
  }
})()
```

---

## ğŸ“Š å¯èƒ½çš„ç»“æœ

### ç»“æœ Aï¼šmmId ä¸å­˜åœ¨

```
âŒ mmId=1 ä¸å­˜åœ¨ï¼
ğŸ“­ å½“å‰æ²¡æœ‰ä»»ä½•ç”³è¯·
```

**æ“ä½œ**ï¼š
```bash
cd /home/xiaodong/æ–‡æ¡£/memopark/memopark-dapp
npm run dev
# è®¿é—® http://localhost:5173/#/otc/market-maker-create
# å®Œæˆç”³è¯·æµç¨‹
```

---

### ç»“æœ Bï¼šçŠ¶æ€ä¸å¯¹

```
âœ… mmId=1 å­˜åœ¨
âŒ çŠ¶æ€ä¸å¯¹ï¼
å½“å‰çŠ¶æ€: DepositLocked
```

**æ“ä½œ**ï¼šå›åˆ°ç”¨æˆ·ç«¯å®Œæˆç¬¬äºŒæ­¥"æäº¤èµ„æ–™"

---

### ç»“æœ Cï¼šæ‰€æœ‰æ£€æŸ¥é€šè¿‡

```
âœ… mmId=1 å­˜åœ¨
âœ… çŠ¶æ€æ­£ç¡®
âœ… äº¤æ˜“æ„å»ºæˆåŠŸ
```

**å¦‚æœä»ç„¶å¤±è´¥**ï¼š
```bash
# é‡æ–°ç¼–è¯‘é“¾ç«¯
cd /home/xiaodong/æ–‡æ¡£/memopark
cargo build --release
./é“¾ç«¯å®Œå…¨é‡ç½®å¹¶å¯åŠ¨.sh
```

---

## ğŸš€ å¿«é€Ÿä¿®å¤ï¼ˆå¦‚æœæ‡’å¾—è¯Šæ–­ï¼‰

```bash
# 1. å®Œå…¨é‡ç½®é“¾ç«¯
cd /home/xiaodong/æ–‡æ¡£/memopark
./é“¾ç«¯å®Œå…¨é‡ç½®å¹¶å¯åŠ¨.sh

# 2. åˆ›å»ºæµ‹è¯•ç”³è¯·
cd memopark-dapp
npm run dev
# è®¿é—® http://localhost:5173/#/otc/market-maker-create
# å®Œæˆè´¨æŠ¼ + æäº¤èµ„æ–™ï¼Œè®°å½• mmId

# 3. åˆ›å»ºææ¡ˆ
cd ../memopark-governance
npm run dev
# è®¿é—® http://localhost:3000/proposals/create?mmId=0&type=approve
```

---

**ç‰ˆæœ¬**: v1.3.1  
**æ›´æ–°**: 2025-10-15

