# 做市商快速审批页面使用说明

## 📋 功能概述

**做市商快速审批页面** 是一个一键式自动化审批工具，模仿 `批准做市商完整流程.js` 脚本的逻辑，将完整的审批流程（发起提案 → 投票 → 执行）集成到一个按钮操作中。

## 🎯 设计目标

1. **简化操作**：将多步骤的审批流程简化为一键操作
2. **自动化执行**：自动完成提案创建、投票、执行（如果达到阈值）
3. **可视化日志**：显示详细的操作进度和日志
4. **安全可靠**：完整的参数校验和错误处理

## 🚀 页面访问

访问路径：`http://localhost:3001/market-maker-quick-approval`

菜单位置：**治理工具 → 做市商快速审批**

---

## 💡 功能特点

### 1. 一键批准

- 点击"一键批准"按钮
- 自动执行完整审批流程：
  1. ✅ 校验 Council 成员资格
  2. ✅ 发起批准提案
  3. ✅ 投赞成票
  4. ✅ 检查是否达到阈值
  5. ✅ 如果达到阈值，关闭并执行提案

### 2. 实时进度显示

- **进度条**：显示当前操作进度百分比
- **步骤指示器**：6个步骤的可视化展示
- **操作日志**：详细的时间戳和操作记录

### 3. Council 信息面板

显示：
- Council 成员数
- 投票阈值（默认 2/3 多数）
- 当前账户信息
- 是否为 Council 成员

### 4. 待审批申请列表

显示字段：
- MM ID
- 申请人地址
- 押金金额
- 首购资金池金额
- Epay 配置状态

操作：
- **一键批准**：启动自动化审批流程
- **查看详情**：查看完整的申请信息

---

## 📝 使用步骤

### 前提条件

1. ✅ 已在"钱包管理"中恢复 Council 成员账户
2. ✅ 当前选择的账户是 Council 成员
3. ✅ 账户有足够的余额支付交易费用

### 操作流程

#### 步骤 1: 访问页面

在侧边栏点击：**治理工具 → 做市商快速审批**

#### 步骤 2: 确认身份

页面顶部"Council 信息"面板中，确认：
- "当前账户"显示你的账户地址
- "是否为成员"显示 ✅ 是（绿色标签）

#### 步骤 3: 选择申请

在"待审批申请"表格中：
- 查看待审批的做市商申请
- 点击"查看详情"按钮查看完整信息（可选）

#### 步骤 4: 一键批准

点击目标申请的"一键批准"按钮，会弹出确认对话框：

```
确认一键批准？

将自动执行以下步骤：
1. 校验 Council 成员资格
2. 发起批准提案
3. 投赞成票
4. 如果达到阈值，关闭并执行提案

⚠️ 注意
如果当前投票未达到阈值，需要其他 Council 成员继续投票
```

点击"确认批准"开始自动化流程。

#### 步骤 5: 等待完成

系统会自动：
1. 弹出密码输入框（签名发起提案）
2. 再次弹出密码输入框（签名投票）
3. 如果达到阈值，第三次弹出密码输入框（签名执行）

**实时显示**：
- 进度条更新（0% → 100%）
- 步骤指示器高亮当前步骤
- 操作日志滚动显示详细信息

#### 步骤 6: 查看结果

成功情况：
```
✅ 提案已执行
🎊 完整流程成功！做市商已批准
```

部分成功（未达到阈值）：
```
⏳ 提案还需要 1 票才能执行
💡 提示：需要其他 Council 成员投票
```

失败情况：
```
❌ 操作失败: [具体错误信息]
```

---

## 🔍 与普通审批页面的区别

| 对比项 | 普通审批页面 | 快速审批页面 |
|--------|------------|------------|
| **操作复杂度** | 3 个独立步骤 | 1 个按钮 |
| **提案创建** | 手动填写表单 | 自动构建 |
| **投票** | 手动选择提案投票 | 自动投票 |
| **执行** | 手动关闭提案 | 自动执行（如果达到阈值）|
| **日志** | 无 | 详细操作日志 |
| **进度显示** | 无 | 进度条 + 步骤指示器 |
| **适用场景** | 需要精细控制 | 快速批量审批 |

---

## ⚙️ 技术实现

### 核心逻辑（参考 `批准做市商完整流程.js`）

```typescript
// 1. 校验成员资格
const members = await api.query.council.members()
if (!members.includes(activeAccount)) {
  throw new Error('您不是 Council 成员')
}

// 2. 发起提案
const innerCall = api.tx.marketMaker.approve(mmId)
const threshold = Math.ceil(members.length * 2 / 3)
const tx = api.tx.council.propose(threshold, innerCall, lengthBound)
await signAndSend(activeAccount, tx, { onSuccess, onError })

// 3. 投票
const voteTx = api.tx.council.vote(proposalHash, proposalIndex, true)
await signAndSend(activeAccount, voteTx, { onSuccess, onError })

// 4. 检查阈值并执行
const voting = await api.query.council.voting(proposalHash)
if (voting.ayes.length >= voting.threshold) {
  const closeTx = api.tx.council.close(proposalHash, proposalIndex, weightBound, lengthBound)
  await signAndSend(activeAccount, closeTx, { onSuccess, onError })
}
```

### 关键特性

1. **智能提案检查**
   - 自动检测提案是否已存在
   - 如果存在，跳过创建步骤，直接投票

2. **投票状态检查**
   - 自动检测当前账户是否已投票
   - 如果已投票，跳过投票步骤

3. **阈值智能判断**
   - 自动计算投票阈值（2/3 多数）
   - 只有达到阈值时才执行关闭操作

4. **详细日志记录**
   - 每个步骤的状态（pending/running/success/error）
   - 操作时间戳
   - 详细的错误信息

---

## ⚠️ 注意事项

### 1. 成员资格

- **必须使用 Council 成员账户**
- 非成员账户会在步骤1被拦截

### 2. 账户余额

- 确保账户有足够余额支付交易费用
- 通常每个交易需要约 0.01 MEMO 的手续费
- 完整流程（提案+投票+执行）约需 0.03 MEMO

### 3. 密码输入

- 每个步骤都需要输入钱包密码签名
- 请提前准备好密码
- 如果取消输入密码，流程会中止

### 4. 阈值要求

- 默认需要 2/3 多数票（当前是 2 票）
- 如果只有 1 个 Council 成员投票，提案不会自动执行
- 需要其他成员继续投票

### 5. 提案已存在

- 如果提案已经存在，会跳过创建步骤
- 直接进入投票环节
- 不会创建重复提案

---

## 🐛 常见问题

### Q1: 点击"一键批准"后没有反应？

**可能原因：**
- 当前账户不是 Council 成员
- 钱包未连接或未恢复

**解决方法：**
1. 检查页面顶部"Council 信息"面板
2. 确认"是否为成员"显示绿色 ✅
3. 如果不是成员，请切换到 Council 成员账户

### Q2: 提示"未找到指定地址的钱包"？

**可能原因：**
- 当前账户没有在本地 keystore 中

**解决方法：**
1. 访问"钱包管理 → 恢复钱包"
2. 输入 Council 成员账户的助记词
3. 恢复钱包后再试

### Q3: 操作进行到一半失败了？

**可能原因：**
- 账户余额不足
- 网络连接中断
- 交易被拒绝

**解决方法：**
1. 查看操作日志中的错误信息
2. 检查账户余额
3. 检查网络连接
4. 重试操作

### Q4: 流程完成但提案没有执行？

**可能原因：**
- 投票未达到阈值（需要 2 票，当前只有 1 票）

**解决方法：**
1. 查看操作日志：`⏳ 提案还需要 1 票才能执行`
2. 请其他 Council 成员继续投票
3. 或者在"做市商审批"页面手动投票和关闭

### Q5: 如何查看历史操作记录？

当前页面只显示本次操作的日志。

如需查看历史：
- 访问浏览器控制台（F12）
- 查看 `[步骤X]` 开头的日志
- 或访问区块链浏览器查询交易记录

---

## 📊 操作日志示例

### 成功流程

```
[19:30:15] SUCCESS: 加载到 1 个待审批申请
[19:30:15] SUCCESS: Council 成员数: 3，投票阈值: 2

[19:31:20] RUNNING: 正在校验 Council 成员资格...
[19:31:20] SUCCESS: ✅ 确认是 Council 成员
            地址: 5CotZ9gD2m...DFgSq

[19:31:21] RUNNING: 正在发起批准提案...
[19:31:21] RUNNING: 提案参数: mmId=0, threshold=2/3, lengthBound=12
[19:31:21] RUNNING: 提案哈希: 0x1234567890abcdef...
[19:31:25] SUCCESS: ✅ 提案已提交
            区块: 0xabcdef12...

[19:31:26] RUNNING: 正在投赞成票...
[19:31:30] SUCCESS: ✅ 投票成功
            区块: 0x9876543...

[19:31:31] RUNNING: 正在检查提案状态...
[19:31:32] SUCCESS: 最新投票: 2 赞成, 0 反对 (阈值: 2)
[19:31:32] SUCCESS: 🎉 提案已达到阈值！

[19:31:33] RUNNING: 正在关闭并执行提案...
[19:31:38] SUCCESS: ✅ 提案已执行
            区块: 0xfedcba...
[19:31:38] SUCCESS: 🎊 完整流程成功！做市商已批准
```

---

## 🔗 相关文档

- [做市商审批页面（普通流程）](/market-maker-governance)
- [钱包管理](/wallet/manage)
- [钱包恢复](/wallet/recover)
- [批准做市商完整流程.js 脚本](../批准做市商完整流程.js)

---

## 📝 更新日志

### v1.0.0 (2025-10-15)

- ✅ 初始版本发布
- ✅ 实现一键批准功能
- ✅ 实现进度显示
- ✅ 实现操作日志
- ✅ 实现 Council 信息面板
- ✅ 实现申请详情查看

---

**状态：** ✅ 已完成  
**最后更新：** 2025-10-15  
**适用版本：** memopark-governance v1.0.0

