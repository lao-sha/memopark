# 逝者分类审核脚本 - 快速参考

## 🎯 一键启动

```bash
# 方式1：使用Shell包装器（推荐，自动检查依赖）
./scripts/review-categories.sh          # 默认10天
./scripts/review-categories.sh 7        # 最近7天
./scripts/review-categories.sh 30       # 最近30天

# 方式2：直接运行Node脚本
node scripts/review-recent-deceased-categories.js
node scripts/review-recent-deceased-categories.js 15
```

---

## 📋 核心功能

| 功能 | 说明 |
|------|------|
| **时间范围查询** | 根据区块高度查询最近N天创建的逝者 |
| **详细信息展示** | 姓名、性别、生平、当前分类、所有者等 |
| **交互式选择** | 7种分类 + 跳过 + 退出选项 |
| **二次确认** | 防止误操作，显示变更前后对比 |
| **理由记录** | 可选输入变更理由，便于追溯 |
| **Sudo权限更新** | 使用sudo.sudo()强制更新，无需治理 |
| **自动日志** | JSON格式记录所有变更历史 |
| **实时统计** | 显示审核进度和结果统计 |

---

## 🎨 交互界面预览

```
================================================================================
📋 逝者ID: 10025
────────────────────────────────────────────────────────────────────────────────
姓名: 张三
性别: 男
生日: 1990/1/15
忌日: 2024/11/13
生平简介: 优秀的工程师，热爱技术和创新
当前分类: 普通民众 (Ordinary)
所有者: 5GrwvaEF...
创建者: 5GrwvaEF...
================================================================================

📝 可选分类：
  [0] 普通民众 (Ordinary)
  [1] 历史人物 (HistoricalFigure)
  [2] 革命烈士 (Martyr)
  [3] 英雄模范 (Hero)
  [4] 公众人物 (PublicFigure)
  [5] 宗教人物 (ReligiousFigure)
  [6] 事件馆 (EventHall)
  [s] 跳过
  [q] 退出

请选择新分类: 3

⚠️  确认变更：
   逝者ID: 10025
   旧分类: 普通民众
   新分类: 英雄模范
是否确认？(y/n): y

变更理由: 抗疫医护人员

🔧 正在使用sudo权限更新分类...
✅ 分类更新成功！
📄 审核日志已保存
```

---

## 📊 分类标准速查

| 代码 | 分类名称 | 典型对象 | 关键特征 |
|------|---------|---------|---------|
| **0** | 普通民众 | 普通逝者 | 默认分类，无特殊社会影响 |
| **1** | 历史人物 | 毛泽东、邓小平 | 对历史有重大影响 |
| **2** | 革命烈士 | 黄继光、董存瑞 | 为革命事业牺牲 |
| **3** | 英雄模范 | 袁隆平、钟南山 | 行业模范、杰出贡献 |
| **4** | 公众人物 | 明星、学者、企业家 | 社会知名度高 |
| **5** | 宗教人物 | 宗教领袖 | 重要宗教影响力 |
| **6** | 事件馆 | 汶川地震纪念 | 事件而非个人 |

---

## ⚡ 快捷键

| 按键 | 功能 | 说明 |
|------|------|------|
| `0-6` | 选择分类 | 输入数字代码 |
| `s` | 跳过 | 保持当前分类 |
| `q` | 退出 | 停止审核 |
| `y` | 确认 | 确认变更 |
| `n` | 取消 | 取消变更 |
| `Ctrl+C` | 强制退出 | 紧急停止 |

---

## 📁 输出文件

**日志位置**: `logs/category-review-YYYY-MM-DD.json`

**日志结构**:
```json
{
  "deceasedId": 10025,
  "fullName": "张三",
  "oldCategory": 0,
  "newCategory": 3,
  "reason": "抗疫医护人员",
  "blockHash": "0x1234...",
  "reviewer": "5GrwvaEF...",
  "timestamp": "2025-11-23T10:30:45Z"
}
```

---

## 🔧 技术细节

### 查询机制
- 使用 `DeceasedCreationTime` 区块索引
- 假设出块时间: 6秒/块
- 1天 = 14,400个区块
- 每100个区块查询一次（优化性能）

### 更新机制
- 调用: `sudo.sudo(deceased.forceSetCategory())`
- 权限要求: Sudo账户（默认Alice）
- 绕过治理流程，直接更新链上状态
- 实时更新分类索引 `DeceasedByCategory`

### 安全机制
- 二次确认防止误操作
- 详细日志记录所有变更
- 错误处理和异常恢复
- 可随时退出保留已完成记录

---

## ⚠️ 重要提示

1. **必须使用Sudo账户**（开发链默认Alice）
2. **影响公众纪念馆显示**（非Ordinary会展示）
3. **变更不可撤销**（需再次运行脚本修改）
4. **建议定期备份日志**（便于审计追溯）

---

## 🔗 相关文件

- **主脚本**: `scripts/review-recent-deceased-categories.js`
- **启动器**: `scripts/review-categories.sh`
- **详细文档**: `scripts/README-category-review.md`
- **Pallet源码**: `pallets/deceased/src/lib.rs`
- **审核日志**: `logs/category-review-*.json`

---

## 📞 故障排查

| 错误 | 原因 | 解决方案 |
|------|------|---------|
| `WebSocket connection failed` | 节点未运行 | 启动节点 `--dev` |
| `RequireSudo` | 账户无权限 | 使用Alice账户 |
| `找到0个逝者` | 时间范围内无数据 | 增大天数参数 |
| `交易失败` | 链上错误 | 查看错误详情 |

---

**版本**: v1.0.0
**最后更新**: 2025-11-23
**作者**: Stardust Team
