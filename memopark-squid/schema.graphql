# Listing（挂单）与时间线
type Listing @entity {
  id: ID!
  maker: String!
  side: Int!
  base: Int!
  quote: Int!
  price: BigInt!
  minQty: BigInt!
  maxQty: BigInt!
  total: BigInt!
  remaining: BigInt!
  partial: Boolean!
  expireAt: Int!
  active: Boolean!
  createdAt: Int!
  actions: [ListingAction!]! @derivedFrom(field: "listing")
}

type ListingAction @entity {
  id: ID!
  listing: Listing!
  kind: String!
  block: Int!
  extrinsicHash: String
  meta: String
}

# Order（订单）与时间线
type Order @entity {
  id: ID!
  listingId: BigInt!
  maker: String!
  taker: String!
  price: BigInt!
  qty: BigInt!
  amount: BigInt!
  state: String!
  createdAt: Int!
  expireAt: Int!
  actions: [OrderAction!]! @derivedFrom(field: "order")
}

type OrderAction @entity {
  id: ID!
  order: Order!
  kind: String!
  block: Int!
  extrinsicHash: String
  meta: String
}


# Arbitration（仲裁案件与时间线）
type ArbitrationCase @entity {
  id: ID!              # 组合键："<domainHex>-<id>"
  domain: String!
  objectId: BigInt!
  state: String!       # Disputed | Closed
  openedAt: Int!
  closedAt: Int
  decision: String     # Release | Refund | Partial
  bps: Int
  evidenceCount: Int!
  actions: [ArbitrationAction!]! @derivedFrom(field: "case")
}

type ArbitrationAction @entity {
  id: ID!
  case: ArbitrationCase!
  kind: String!        # Disputed | Arbitrated | AppendEvidence
  block: Int!
  extrinsicHash: String
  meta: String
}

# Notification（事件中心，统一时间线）
type Notification @entity {
  id: ID!
  module: String!
  kind: String!
  refId: String
  actor: String
  block: Int!
  extrinsicHash: String
  meta: String
}

# Pin 生命周期与计费（从 memo_ipfs）
type PinBillingEvent @entity {
  id: ID!           # "<cid>-<block>-<idx>"
  cid: String!
  kind: String!     # PinCharged | PinGrace | PinExpired
  amount: BigInt
  periodBlocks: Int
  nextChargeAt: Int
  block: Int!
}

# 仲裁日指标（仪表盘）
type ArbDailyStat @entity {
  id: ID!        # day key (blockHeight / blocksPerDay)
  day: Int!
  disputes: Int!
  arbitrated: Int!
  release: Int!
  refund: Int!
  partial: Int!
}

# Grave（墓地/纪念馆）与时间线、供奉/留言/媒体（只读层）
type Grave @entity {
  id: ID!                # grave_id
  owner: String!
  parkId: BigInt!
  kind: String!
  primaryDeceasedId: BigInt
  slug: String
  createdAt: Int!
  active: Boolean!
  offeringsCount: Int!
  offeringsAmount: BigInt!
  actions: [GraveAction!]! @derivedFrom(field: "grave")
}

type GraveAction @entity {
  id: ID!
  grave: Grave!
  kind: String!          # GraveCreated | GraveLinkedDeceased | GraveSetPark | VisibilityUpdated
  block: Int!
  extrinsicHash: String
  meta: String
}

type Offering @entity {
  id: ID!
  hallId: BigInt!
  who: String!
  amount: BigInt!
  block: Int!
}

# 新增：目录下单事件（携带 sacrifice_id 与 duration）
type OfferingBySacrifice @entity {
  id: ID!
  targetDomain: Int!
  targetId: BigInt!
  sacrificeId: BigInt!
  who: String!
  amount: BigInt!
  durationWeeks: Int
  block: Int!
}

# 供奉分账结算（由 OfferingRouted 事件产生，按 id 与 Offering 合并视图）
type OfferingSettlement @entity {
  id: ID!              # offering id
  targetDomain: Int!
  targetId: BigInt!
  gross: BigInt!
  remainder: BigInt!
  shares: String       # JSON 字符串：[{account, amount}]
  block: Int!
}

# Pin 合并视图（按 cid 聚合生命周期与费用曲线）
type PinOverview @entity {
  id: ID!            # cid(hex)
  firstSeen: Int!
  owner: String
  replicas: Int
  sizeBytes: BigInt
  totalCharged: BigInt!
  lastNextChargeAt: Int
  lastState: String
}

type GuestbookMessage @entity {
  id: ID!
  hallId: BigInt!
  who: String!
  text: String!
  block: Int!
}

type MediaItem @entity {
  id: ID!
  hallId: BigInt!
  kind: String!
  uri: String!
  block: Int!
}

# 推荐关系
type ReferralLink @entity {
  id: ID!
  who: String!
  sponsor: String!
  block: Int!
}

# 推荐码事件（默认码领取）
type ReferralCode @entity {
  id: ID!         # code
  owner: String!
  block: Int!
}

# Offering 价格快照（治理变更时间轴）
type OfferingPriceSnapshot @entity {
  id: ID!                 # 组合键："<kindCode>-<block>"
  kindCode: Int!
  fixedPrice: BigInt
  unitPricePerWeek: BigInt
  block: Int!
}

# 暂停事件快照（便于审计）
type OfferingPauseEvent @entity {
  id: ID!
  scope: String!   # Global | Domain
  domain: Int
  paused: Boolean!
  block: Int!
}

"""
供奉风控参数快照：在 OfferParamsUpdated 事件发生时记录
- offerWindow: 滑动窗口大小（块），为空表示“保持不变/未显式设置”
- offerMaxInWindow: 窗口内最大次数，空=保持
- minOfferAmount: 最小供奉金额（Planck），空=保持
"""
type OfferingParamsSnapshot @entity {
  id: ID!          # 组合键："<block>-<idx>"
  block: Int!
  offerWindow: Int
  offerMaxInWindow: Int
  minOfferAmount: BigInt
}

# ===== Governance（治理工单与时间线） =====
type GovCase @entity {
  id: ID!                # 组合键："deceased-<id>"
  pallet: String!        # deceased
  objectId: BigInt!      # deceased_id
  openedAt: Int!         # 首次记录证据事件区块
  lastActionAt: Int!
  evidenceCid: String!   # 最近一次证据 CID（明文）
  actions: [GovAction!]! @derivedFrom(field: "case")
}

type GovAction @entity {
  id: ID!
  case: GovCase!
  kind: String!          # GovEvidenceNoted | DeceasedUpdated | DeceasedTransferred | VisibilityChanged
  block: Int!
  extrinsicHash: String
  meta: String
}

