# 首购资金池管理功能使用说明

## 📋 概述

首购资金池管理功能为做市商提供了完整的资金池管理界面，包括资金充值、提取申请、执行提取等操作。本功能基于**派生账户方案**实现，确保资金安全隔离和灵活管理。

---

## 🎯 功能特性

### 1. 资金池状态监控
- ✅ 实时查看总额、可用余额、已使用、冻结金额
- ✅ 自动计算可服务用户数量
- ✅ 余额不足自动告警
- ✅ 使用率可视化进度条

### 2. 资金提取（7天冷却期）
- ✅ 申请提取资金（需满足最小保留余额）
- ✅ 7天冷却期保护，防止恶意快速提取
- ✅ 实时倒计时显示剩余等待时间
- ✅ 冷却期结束后一键执行提取
- ✅ 随时可取消提取申请并解冻资金

### 3. 服务控制
- ✅ 提取申请时可选择是否暂停服务
- ✅ 服务状态实时更新
- ✅ 防止资金不足时继续提供服务

### 4. 安全保障
- ✅ 资金隔离：每个做市商独立派生账户
- ✅ 冷却保护：7天冷却期给治理和用户反应时间
- ✅ 最小保留：确保始终有足够资金继续服务
- ✅ 治理监督：异常情况下治理委员会可介入

---

## 📱 页面访问路径

### 用户端（首购服务）
```
路由: #/first-purchase
路径: /home/xiaodong/文档/stardust/stardust-dapp/src/features/first-purchase/FirstPurchasePage.tsx
功能: 新用户购买少量 MEMO 作为 GAS 费
```

### 做市商端（配置管理）
```
路由: #/otc/market-maker-config
路径: /home/xiaodong/文档/stardust/stardust-dapp/src/features/otc/MarketMakerConfigPage.tsx
功能: 做市商配置 epay 信息、充值资金池
```

### 做市商端（资金池管理）
```
路由: #/first-purchase/pool
路径: /home/xiaodong/文档/stardust/stardust-dapp/src/features/first-purchase/MarketMakerPoolPage.tsx
功能: 做市商管理资金池、申请提取、执行提取
```

---

## 🚀 使用流程

### 做市商首次设置

1. **申请成为做市商**
   - 访问 `#/otc/mm-apply`
   - 质押保证金并提交申请
   - 填写 epay 配置和首购资金池金额
   - 等待治理委员会审核批准

2. **充值资金池**（审核通过后）
   - 访问 `#/otc/market-maker-config`
   - 点击"充值首购资金池"按钮
   - 输入充值金额（建议 1000+ MEMO）
   - 签名并发送交易

3. **开始提供服务**
   - 用户访问首购页面时会看到您的做市商信息
   - 系统自动从您的资金池转账给新用户
   - 实时更新已使用金额和服务用户数

### 资金提取流程

#### 步骤 1: 申请提取
```
访问: #/first-purchase/pool
点击: "申请提取资金" 按钮
```

**填写信息：**
- **提取金额**：输入要提取的金额（必须 ≤ 可用余额 - 最小保留余额）
- **服务控制**：选择是否在冷却期间暂停服务
  - ✅ 暂停：新用户无法使用您的做市服务
  - ❌ 不暂停：继续服务，但冻结资金无法使用

**系统验证：**
- 可用余额是否充足
- 提取后余额是否 ≥ 最小保留值（默认 1000 MEMO）
- 是否已有待处理的提取请求

**提交后：**
- 申请金额被冻结
- 进入 7 天冷却期
- 实时显示剩余等待时间

#### 步骤 2: 等待冷却期（7天）

**冷却期间：**
- 资金被冻结，无法用于首购服务
- 可以随时取消申请并解冻资金
- 实时倒计时显示（天、小时、分钟、秒）

**为什么需要冷却期？**
- 🛡️ 防止恶意快速提取攻击
- ⏰ 给治理和用户反应时间
- 🔒 保护新用户的首购服务稳定性

#### 步骤 3: 执行提取

**冷却期结束后：**
1. 页面显示 "已就绪，可以执行提取"
2. 点击 "执行提取" 按钮
3. 签名确认交易
4. 资金从派生账户转入您的账户
5. 冻结金额清零，提取请求删除

#### 步骤 4: 取消提取（可选）

**任何时候都可以取消：**
1. 点击 "取消申请" 按钮
2. 确认取消操作
3. 冻结资金解冻
4. 服务自动恢复（如果之前暂停）
5. 提取请求删除

---

## 📊 页面功能详解

### 1. 资金池概览卡片

```
💰 资金池概览
├─ 总额: 显示资金池总金额
├─ 可用余额: 可以使用的金额（绿色）
├─ 已使用: 已服务用户使用的金额（黄色）
└─ 冻结中: 提取申请中冻结的金额（红色）

📈 统计信息
├─ 已服务用户数: 累计服务的新用户数量
├─ 每次首购金额: 系统配置的固定金额（默认 100 MEMO）
├─ 最小保留余额: 提取后必须保留的最小值（默认 1000 MEMO）
└─ 可服务剩余人数: 可用余额 / 每次首购金额
```

### 2. 提取请求状态卡片（有申请时显示）

```
⏰ 提取申请进行中
├─ 申请金额: 显示要提取的金额
├─ 冷却期状态: 
│   ├─ 冷却中: 显示剩余时间（动态倒计时）
│   └─ 已就绪: 可以执行提取
├─ 申请时间: 提交申请的时间戳
└─ 可执行时间: 冷却期结束时间

操作按钮:
├─ 执行提取: 冷却期结束后启用
└─ 取消申请: 随时可用
```

### 3. 操作按钮区（无申请时显示）

```
🛠️ 资金池操作
├─ 申请提取资金: 开始提取流程
└─ 充值资金池: 跳转到配置页面充值
```

### 4. 安全提示卡片

```
🔒 安全提示
├─ 资金隔离: 每个做市商独立派生账户
├─ 冷却保护: 7天冷却期防止恶意提取
├─ 最小保留: 确保始终有足够资金服务
└─ 治理监督: 异常情况治理可介入
```

---

## ⚙️ 系统参数配置

### 链端常量（runtime 配置）

| 参数名 | 默认值 | 说明 |
|--------|--------|------|
| `MinFirstPurchasePool` | 1000 MEMO | 做市商资金池最小金额 |
| `FirstPurchaseAmount` | 100 MEMO | 每次首购转账金额 |
| `WithdrawalCooldown` | 7天（604800秒）| 提取冷却期时长 |
| `MinPoolBalance` | 1000 MEMO | 提取后最小保留余额 |
| `PalletId` | `mm/pool!` | 派生账户 Pallet ID |

### 前端 API 配置

```typescript
// 环境变量
VITE_FIRST_PURCHASE_API_URL=http://localhost:3100/api/first-purchase

// API 端点
GET  /market-makers/available     // 查询可用做市商
GET  /market-makers/:mmId         // 查询做市商详情
POST /create                      // 创建首购订单
GET  /status/:orderId             // 查询订单状态
GET  /check/:walletAddress        // 检查地址是否已首购
```

---

## 🔐 安全机制详解

### 1. 资金隔离（派生账户）

**实现方式：**
```rust
// 链端代码
pub fn first_purchase_pool_account(maker_id: u64) -> T::AccountId {
    T::PalletId::get().into_sub_account_truncating(maker_id)
}
```

**特点：**
- ✅ 每个做市商有独立的派生账户地址
- ✅ 资金不混淆，账目清晰
- ✅ 做市商无法直接访问派生账户
- ✅ 只能通过 pallet 接口操作资金

### 2. 冷却期保护（7天等待）

**流程：**
```
申请提取 -> 冻结资金 -> 7天冷却 -> 可执行提取
    ↓           ↓          ↓           ↓
  记录时间   更新状态   实时倒计时   验证时间
```

**保护作用：**
- 🛡️ 防止恶意快速抽空资金池
- ⏰ 给治理委员会反应时间
- 👥 给用户切换做市商的时间
- 🔍 便于社区监督和审计

### 3. 最小保留余额

**规则：**
```
可提取金额 = 可用余额 - 最小保留余额
           = (总额 - 已用 - 冻结) - 最小保留
```

**目的：**
- ✅ 确保资金池始终有足够余额
- ✅ 避免提取后无法继续提供服务
- ✅ 保护新用户的首购体验

### 4. 治理监督机制

**治理权限：**
```rust
// 紧急提取（仅治理）
pub fn emergency_withdrawal(
    origin: OriginFor<T>,
    maker_id: u64,
    recipient: T::AccountId,
    amount: BalanceOf<T>,
) -> DispatchResult
```

**使用场景：**
- 🚨 做市商账户丢失
- 🔧 系统升级需要迁移资金
- ⚖️ 严重违规需要扣罚
- 🆘 其他异常情况

---

## 📈 监控和统计

### 实时监控指标

1. **资金池健康度**
   - 总额 / 已使用 / 可用余额比例
   - 可服务剩余人数
   - 余额预警（低于2倍最小值）

2. **服务统计**
   - 已服务用户总数
   - 平均每日服务量
   - 资金池使用率

3. **提取请求监控**
   - 当前待处理请求数量
   - 冻结资金总额
   - 冷却期剩余时间

### 告警机制

| 告警类型 | 触发条件 | 告警级别 |
|---------|---------|---------|
| 余额不足 | 可用余额 < 最小保留值 | 🔴 严重 |
| 余额偏低 | 可用余额 < 2倍最小值 | 🟠 警告 |
| 服务暂停 | service_paused = true | 🟡 提示 |
| 提取申请中 | 存在待处理提取请求 | 🔵 信息 |

---

## 🐛 常见问题

### Q1: 为什么申请提取失败？

**可能原因：**
1. ❌ 可用余额不足
2. ❌ 提取后余额低于最小保留值
3. ❌ 已有待处理的提取请求（一次只能有一个）
4. ❌ 账户不是做市商所有者

**解决方案：**
- 检查可用余额是否充足
- 减少提取金额
- 等待当前提取请求处理完成

### Q2: 冷却期可以缩短吗？

**回答：**
- ❌ 不可以，7天冷却期是硬编码的安全机制
- ✅ 治理委员会可以通过 `emergency_withdrawal` 绕过冷却期
- ⏰ 您可以随时取消申请并重新提交

### Q3: 提取申请中可以继续服务吗？

**回答：**
- ✅ 可以，申请时选择"继续提供服务"
- ⚠️ 但冻结的资金无法用于首购服务
- 💡 建议：如果冻结金额较大，建议暂停服务

### Q4: 取消提取会损失什么吗？

**回答：**
- ✅ 不会，资金会立即解冻
- ✅ 服务会自动恢复（如果之前暂停）
- ✅ 可以随时重新申请提取

### Q5: 资金池余额不够怎么办？

**解决方案：**
1. 访问 `#/otc/market-maker-config`
2. 点击"充值首购资金池"
3. 输入充值金额并签名
4. 等待交易确认后余额更新

### Q6: 为什么用户看不到我的做市商服务？

**可能原因：**
1. ❌ 服务已暂停（`service_paused = true`）
2. ❌ 可用余额不足（< 每次首购金额）
3. ❌ 做市商状态不是 Active
4. ❌ 资金池余额低于最小值

**解决方案：**
- 检查服务状态
- 充值资金池
- 取消提取申请（如果有）

---

## 🔧 开发说明

### 前端技术栈
- React 18 + TypeScript
- Ant Design 5（UI 组件库）
- Polkadot.js API（区块链交互）
- React Router（路由管理）

### 关键文件

| 文件路径 | 说明 |
|---------|------|
| `MarketMakerPoolPage.tsx` | 资金池管理主页面 |
| `FirstPurchasePage.tsx` | 用户首购页面 |
| `MarketMakerConfigPage.tsx` | 做市商配置页面 |
| `api.ts` | 首购 API 接口封装 |
| `routes.tsx` | 路由配置文件 |

### 链端接口

```rust
// pallet-market-maker 关键接口

// 申请提取
request_withdrawal(maker_id, amount, pause_service)

// 执行提取
execute_withdrawal(maker_id)

// 取消提取
cancel_withdrawal(maker_id)

// 紧急提取（治理）
emergency_withdrawal(maker_id, recipient, amount)

// 查询接口
ActiveMarketMakers<mmId> -> Application
WithdrawalRequests<mmId> -> WithdrawalRequest
```

### 状态机

```
资金池状态流转:
正常服务 -> 申请提取 -> 冷却中 -> 可执行 -> 执行提取 -> 正常服务
             ↓                         ↓
           取消申请 <─────────────────┘
```

---

## 📚 参考资料

### 相关文档
- [做市商申请流程](./做市商审批功能实现总结.md)
- [首购服务配置](./做市商epay配置快速使用指南.md)
- [Polkadot.js API 文档](https://polkadot.js.org/docs/)

### 链端代码
- `/home/xiaodong/文档/stardust/pallets/market-maker/src/lib.rs`
- `/home/xiaodong/文档/stardust/pallets/market-maker/README.md`

### 前端代码
- `/home/xiaodong/文档/stardust/stardust-dapp/src/features/first-purchase/`
- `/home/xiaodong/文档/stardust/stardust-dapp/src/features/otc/`

---

## ✅ 总结

首购资金池管理功能提供了一套完整的做市商资金管理解决方案：

1. **安全性**：派生账户隔离 + 7天冷却期 + 最小保留余额 + 治理监督
2. **灵活性**：随时充值、申请提取、取消申请
3. **透明性**：实时余额监控、服务统计、操作日志
4. **易用性**：直观的 UI 界面、清晰的操作流程、详细的提示信息

该方案在**安全性、性能和可维护性**之间取得了良好的平衡，适合当前的首购服务场景。

---

**最后更新**: 2025-10-14  
**版本**: v1.0.0  
**维护者**: StarDust 开发团队

