# 逝者主图功能说明

> **功能添加时间**: 2024-01-15  
> **功能位置**: 创建逝者页面  
> **实现状态**: ✅ 已完成

---

## 📋 功能概述

### 什么是主图？

**主图（Main Image）** 是逝者档案的核心照片，通常是逝者的遗照。

**用途：**
- 📸 在纪念馆页面展示
- 👤 作为逝者的头像/代表图片
- 🎯 帮助亲友识别和缅怀
- ♾️ 永久保存在 IPFS 上

---

## 🎯 功能特点

### 1. 两步式设置

**为什么是两步？**

因为后端接口设计如下：
```rust
// 步骤1：创建逝者
create_deceased(
    grave_id,
    name,
    gender_code,
    name_full_cid,
    birth_ts,
    death_ts,
    links
)
// ❌ 创建时没有 main_image_cid 参数

// 步骤2：设置主图
set_main_image(
    deceased_id,
    cid  // ← 主图的 IPFS CID
)
```

**前端优化：**
- ✅ 用户在创建页面就可以上传照片
- ✅ 系统自动在创建成功后设置主图
- ✅ 用户感知上是"一步完成"

### 2. 自动化流程

**完整流程：**
```
用户操作：
1. 选择照片 → 点击上传
2. 系统上传到 IPFS → 获得 CID
3. 显示预览和 CID
4. 填写其他信息
5. 点击"创建逝者档案"

后台自动：
6. 创建逝者 → 获得 deceased_id
7. 检测到有主图 CID
8. 自动调用 set_main_image
9. 设置成功 → 显示提示
10. 跳转到"我的创建"
```

**用户体验：**
- ✅ 无需理解两步操作
- ✅ 系统自动处理
- ✅ 一次性完成所有设置

### 3. IPFS 存储

**自动 Pin 功能：**
- ✅ 上传后自动 pin 到 IPFS
- ✅ 确保永久可访问
- ✅ 防止被垃圾回收

**Pin 状态监听：**
- ✅ AutoPinSuccess - Pin 成功
- ✅ AutoPinFailed - Pin 失败（可重试）

---

## 🎨 UI 设计

### 上传前状态

```
┌────────────────────────────────────┐
│ 📷 逝者照片（主图）                │
├────────────────────────────────────┤
│                                    │
│  ┌──────────────────────────────┐ │
│  │  📤 选择照片并上传到 IPFS    │ │
│  └──────────────────────────────┘ │
│                                    │
│  建议上传清晰的遗照...            │
└────────────────────────────────────┘
```

**样式特点：**
- 虚线边框（深金色）
- 米白色背景
- 上传图标
- 悬停上浮效果

### 上传后状态（预览）

```
┌────────────────────────────────────┐
│ 📷 逝者照片（主图）                │
├────────────────────────────────────┤
│  ┌──────────────────────────────┐ │
│  │                              │ │
│  │      [逝者照片预览]          │ │
│  │                              │ │
│  │  (悬停显示"重新上传"按钮)   │ │
│  ├──────────────────────────────┤ │
│  │ 📋 QmXxx... [复制]           │ │
│  └──────────────────────────────┘ │
│                                    │
│  建议上传清晰的遗照...            │
└────────────────────────────────────┘
```

**样式特点：**
- 圆角卡片
- 照片适应性显示
- CID 显示可复制
- 悬停显示遮罩和操作按钮

---

## 🔧 技术实现

### 核心代码

#### 1. 上传处理

```tsx
const handleImageUpload = async (file: File) => {
  // 1. 验证文件类型
  if (!file.type.startsWith('image/')) {
    message.error('请上传图片文件')
    return false
  }
  
  // 2. 验证文件大小（最大 5MB）
  if (file.size > 5 * 1024 * 1024) {
    message.error('图片大小不能超过 5MB')
    return false
  }
  
  // 3. 创建预览
  const reader = new FileReader()
  reader.onload = (e) => {
    setMainImagePreview(e.target?.result as string)
  }
  reader.readAsDataURL(file)
  
  // 4. 上传到 IPFS
  const cid = await uploadToIpfs(file)
  setUploadedMainImageCid(cid)
  
  return false // 阻止自动上传
}
```

#### 2. 自动设置主图

```tsx
// 在创建逝者成功后
if (uploadedMainImageCid && createdDeceasedId) {
  // 使用相同密码自动设置主图
  await setMainImageOnChain(
    createdDeceasedId, 
    uploadedMainImageCid, 
    pwdVal
  )
}
```

#### 3. UI 组件

```tsx
<Upload
  beforeUpload={handleImageUpload}
  showUploadList={false}
  accept="image/*"
>
  <Button icon={<UploadOutlined />} loading={uploadingImage}>
    选择照片并上传到 IPFS
  </Button>
</Upload>
```

---

## 📐 设计规范

### 图片要求

**文件格式：**
- ✅ JPG/JPEG
- ✅ PNG
- ✅ GIF（不推荐，体积大）
- ❌ 其他格式

**文件大小：**
- 最大：5MB
- 推荐：1-2MB
- 说明：过大影响加载速度

**图片尺寸：**
- 推荐：800x800 以上
- 最小：400x400
- 比例：建议 1:1 或 3:4

**图片质量：**
- 清晰的照片
- 避免模糊图片
- 建议正面照
- 适当的光线

### 预览效果

**预览卡片：**
- 最大宽度：400px
- 最大高度：400px
- 适应性显示（object-fit: contain）
- 圆角边框
- 深金色边框

**悬停效果：**
- 半透明遮罩
- 显示"重新上传"按钮
- 平滑过渡动画

**CID 显示：**
- 底部卡片
- 可复制
- 省略显示
- 深金色文字

---

## 📊 后端接口

### 涉及的链上调用

**1. 创建逝者**
```rust
deceased.createDeceased(
    grave_id: u64,
    name: Vec<u8>,
    gender_code: u8,
    name_full_cid: Option<Vec<u8>>,
    birth_ts: Vec<u8>,
    death_ts: Vec<u8>,
    links: Vec<Vec<u8>>
)
```

**2. 设置主图**（创建成功后自动调用）
```rust
deceased.setMainImage(
    deceased_id: u64,
    cid: Vec<u8>
)
```

### 事件监听

**相关事件：**
- `DeceasedCreated(deceased_id, ...)` - 创建成功
- `AutoPinSuccess(pin_type, cid)` - IPFS pin 成功
- `AutoPinFailed(pin_type, cid)` - IPFS pin 失败
- `MainImageUpdated(deceased_id, operator, is_set)` - 主图更新

---

## 💡 使用场景

### 场景 1：创建时上传主图

**操作步骤：**
1. 填写逝者姓名
2. 点击"选择照片并上传到 IPFS"
3. 选择照片文件
4. 等待上传（显示进度）
5. 预览照片和 CID
6. 继续填写其他信息
7. 提交创建
8. 系统自动设置主图

**优势：**
- ✅ 一次性完成所有设置
- ✅ 无需后续手动操作
- ✅ 用户体验最佳

### 场景 2：创建后设置主图

**如果创建时未上传：**
1. 创建逝者档案
2. 跳转到"我的创建"
3. 找到对应逝者
4. 在管理页面设置主图

**说明：**
- 创建时主图为可选
- 可以稍后再上传
- 支持随时更换

### 场景 3：更换主图

**操作步骤：**
1. 点击"重新上传"
2. 选择新照片
3. 上传到 IPFS
4. 重新提交创建

**说明：**
- 创建前可随时更换
- 创建后需在管理页面修改

---

## ⚙️ 技术细节

### 上传流程

```
1. 用户选择文件
   ├─ 验证文件类型
   ├─ 验证文件大小
   └─ 通过验证 ✓

2. 创建本地预览
   ├─ FileReader 读取
   ├─ 转为 base64
   └─ 显示预览图 ✓

3. 上传到 IPFS
   ├─ 调用 uploadToIpfs
   ├─ 获取 CID
   └─ 保存到状态 ✓

4. 创建逝者提交
   ├─ 提交基本信息
   ├─ 获得 deceased_id
   └─ 等待事件 ✓

5. 自动设置主图
   ├─ 检测到有上传的 CID
   ├─ 调用 setMainImage
   └─ 设置成功 ✓
```

### 错误处理

**上传阶段：**
- ❌ 文件类型错误 → 提示"请上传图片文件"
- ❌ 文件过大 → 提示"图片大小不能超过 5MB"
- ❌ IPFS 上传失败 → 提示错误信息

**设置阶段：**
- ❌ 设置主图失败 → 提示"请稍后在管理页面手动设置"
- ✅ 不影响逝者创建
- ✅ 可以稍后重试

---

## 📱 界面展示

### 上传按钮

**未上传状态：**
```css
┌──────────────────────────────┐
│  📤 选择照片并上传到 IPFS    │
└──────────────────────────────┘

样式：
- 高度：48px
- 边框：虚线，深金色
- 背景：米白色半透明
- 图标：上传图标
```

**上传中状态：**
```css
┌──────────────────────────────┐
│  ⏳ 上传中...                │
└──────────────────────────────┘

样式：
- 显示 loading 动画
- 按钮禁用
- 提示"正在上传图片到 IPFS..."
```

### 照片预览

**预览卡片：**
```css
┌────────────────────┐
│                    │
│   [逝者照片]       │
│                    │
│  (悬停显示遮罩)    │
├────────────────────┤
│ 📋 QmXxx... [复制] │
└────────────────────┘

样式：
- 最大宽度：400px
- 圆角：12px
- 边框：深金色
- 背景：米白色
```

**悬停遮罩：**
```css
半透明黑色遮罩
└─ 重新上传按钮（深金色）

交互：
- 鼠标移入显示遮罩
- 点击可重新上传
- 平滑过渡动画
```

---

## 🔄 操作流程

### 完整的创建流程（含主图）

```
步骤1：选择纪念馆
└─ 从下拉框选择纪念馆ID

步骤2：填写基本信息
├─ 输入逝者姓名（必填）
└─ 上传逝者照片（可选）
    ├─ 点击上传按钮
    ├─ 选择照片文件
    ├─ 等待 IPFS 上传
    ├─ 显示预览和 CID
    └─ （可重新上传）

步骤3：选择性别
└─ 男/女/保密（默认保密）

步骤4：选择日期
├─ 出生日期（DatePicker）
└─ 离世日期（DatePicker）

步骤5：填写扩展信息（可选）
├─ 完整姓名 CID
└─ 外部链接（最多8条）

步骤6：提交创建
├─ 点击"创建逝者档案"
├─ 输入钱包密码
└─ 等待交易确认

步骤7：自动设置主图
├─ 创建成功后
├─ 检测到有主图 CID
├─ 自动调用 setMainImage
└─ 显示设置结果

步骤8：完成
├─ 显示 Pin 状态
└─ 自动跳转"我的创建"
```

---

## ⚠️ 注意事项

### 1. 文件要求

**必须满足：**
- ✅ 图片格式（JPG/PNG）
- ✅ 大小 ≤ 5MB
- ✅ 建议清晰的正面照

**推荐规格：**
- 分辨率：800x800 或更高
- 比例：1:1 或 3:4
- 质量：高清、清晰

### 2. 隐私说明

**重要提示：**
- ⚠️ 照片将永久保存在 IPFS 公开网络
- ⚠️ 任何人都可以通过 CID 访问
- ⚠️ 请确保照片适合公开展示
- ⚠️ 避免上传隐私或敏感照片

### 3. 设置时机

**推荐：**
- ✅ 创建时一次性上传
- ✅ 省去后续操作

**可选：**
- ⚠️ 创建时可以跳过
- ⚠️ 稍后在管理页面设置
- ⚠️ 支持随时更换

### 4. 失败处理

**上传失败：**
- 可以重试上传
- 不影响创建流程
- 可以稍后设置

**设置失败：**
- 逝者已成功创建
- 主图需在管理页面设置
- 系统会给出友好提示

---

## 💻 代码实现

### 关键状态

```tsx
// 主图相关状态
const [mainImageFile, setMainImageFile] = useState<File | null>(null)
const [mainImagePreview, setMainImagePreview] = useState<string>('')
const [uploadingImage, setUploadingImage] = useState(false)
const [uploadedMainImageCid, setUploadedMainImageCid] = useState<string>('')
```

### 上传函数

```tsx
const handleImageUpload = async (file: File) => {
  // 验证 + 预览 + 上传
  const cid = await uploadToIpfs(file)
  setUploadedMainImageCid(cid)
  return false
}
```

### 自动设置

```tsx
// 创建成功后
if (uploadedMainImageCid && createdDeceasedId) {
  await setMainImageOnChain(
    createdDeceasedId, 
    uploadedMainImageCid, 
    pwdVal
  )
}
```

---

## 📊 功能对比

### 有主图 vs 无主图

| 对比项 | 无主图 | 有主图 |
|-------|-------|--------|
| **识别度** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **视觉效果** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **缅怀感** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| **完整度** | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

### 用户体验提升

**有主图的优势：**
- ✅ 更直观的识别
- ✅ 更完整的档案
- ✅ 更好的缅怀体验
- ✅ 更高的情感共鸣

---

## 🎯 使用建议

### 推荐做法

1. **创建时上传**
   - 一次性完成所有设置
   - 避免后续遗忘
   - 档案更完整

2. **选择合适照片**
   - 清晰的遗照
   - 正面照片
   - 庄重得体
   - 适合公开

3. **注意隐私**
   - 确认照片可公开
   - 避免敏感信息
   - 尊重逝者形象

### 最佳实践

**照片选择：**
```
✅ 推荐：
- 清晰的正面遗照
- 庄重的纪念照
- 适当的生活照

❌ 避免：
- 模糊不清的照片
- 不雅或不当照片
- 包含隐私信息的照片
```

**上传时机：**
```
推荐：创建时立即上传
可选：稍后在管理页面设置
```

---

## ✅ 功能清单

### 已实现功能

- [x] 照片选择和上传
- [x] IPFS 存储
- [x] 本地预览
- [x] CID 显示和复制
- [x] 重新上传
- [x] 文件类型验证
- [x] 文件大小验证
- [x] 上传进度提示
- [x] 自动设置到链上
- [x] 错误处理
- [x] 成功提示

### 待优化功能

- [ ] 图片裁剪功能
- [ ] 多张照片上传（相册）
- [ ] 照片旋转调整
- [ ] 压缩优化

---

## 🎊 总结

### 功能价值

**用户价值：**
- ✅ 更完整的逝者档案
- ✅ 更好的视觉展示
- ✅ 更强的情感联系

**技术价值：**
- ✅ IPFS 分布式存储
- ✅ 永久保存
- ✅ 自动 Pin 机制

**业务价值：**
- ✅ 提升产品完整度
- ✅ 增强用户体验
- ✅ 提高使用率

---

**功能完成时间**: 2024-01-15  
**功能状态**: ✅ 已完成  
**测试状态**: ⏳ 待测试

