# ä¾›å¥‰é‡‘é¢ç»Ÿè®¡æ¥å£è¯´æ˜

> **Pallet**: `pallet-ledger`  
> **åˆ›å»ºæ—¥æœŸ**: 2025-11-08

---

## ğŸ“‹ æ¥å£æ¦‚è§ˆ

`pallet-ledger` æä¾›äº†å®Œæ•´çš„ä¾›å¥‰é‡‘é¢ç»Ÿè®¡æ¥å£ï¼ŒåŒ…æ‹¬ï¼š

1. **å¢“ä½ç´¯è®¡ä¾›å¥‰é‡‘é¢** - `totalMemoByGrave(graveId)`
2. **é€è€…ç´¯è®¡ä¾›å¥‰é‡‘é¢** - `totalMemoByDeceased(deceasedId)`
3. **å¢“ä½ç´¯è®¡ä¾›å¥‰æ¬¡æ•°** - `totalsByGrave(graveId)`
4. **å‘¨æ´»è·ƒæ ‡è®°** - `weeklyActive`

---

## ğŸ”§ æ¥å£è¯¦æƒ…

### 1. å¢“ä½ç´¯è®¡ä¾›å¥‰é‡‘é¢

**æ¥å£**: `api.query.ledger.totalMemoByGrave(graveId)`

**è¯´æ˜**: æŸ¥è¯¢æŒ‡å®šå¢“ä½çš„ç´¯è®¡ä¾›å¥‰é‡‘é¢ï¼ˆDUSTï¼‰

**å‚æ•°**:
- `graveId`: å¢“ä½IDï¼ˆu64ï¼‰

**è¿”å›**: `Balance` ç±»å‹ï¼ˆç´¯è®¡é‡‘é¢ï¼‰

**ç¤ºä¾‹**:
```typescript
import { getApi } from '../lib/polkadot'

const api = await getApi()
const graveId = 1 // å¢“ä½ID

// æŸ¥è¯¢å¢“ä½ç´¯è®¡ä¾›å¥‰é‡‘é¢
const totalAmount = await api.query.ledger.totalMemoByGrave(graveId)
console.log('ç´¯è®¡ä¾›å¥‰é‡‘é¢:', totalAmount.toString())

// è½¬æ¢ä¸ºå¯è¯»æ ¼å¼ï¼ˆDUSTå•ä½ï¼‰
const dust = Number(totalAmount) / 1_000_000_000_000_000
console.log('ç´¯è®¡ä¾›å¥‰é‡‘é¢:', `${dust} DUST`)
```

---

### 2. é€è€…ç´¯è®¡ä¾›å¥‰é‡‘é¢

**æ¥å£**: `api.query.ledger.totalMemoByDeceased(deceasedId)`

**è¯´æ˜**: æŸ¥è¯¢æŒ‡å®šé€è€…çš„ç´¯è®¡ä¾›å¥‰é‡‘é¢ï¼ˆDUSTï¼‰

**å‚æ•°**:
- `deceasedId`: é€è€…IDï¼ˆu64ï¼‰

**è¿”å›**: `Balance` ç±»å‹ï¼ˆç´¯è®¡é‡‘é¢ï¼‰

**ç¤ºä¾‹**:
```typescript
const deceasedId = 1 // é€è€…ID

// æŸ¥è¯¢é€è€…ç´¯è®¡ä¾›å¥‰é‡‘é¢
const deceasedTotal = await api.query.ledger.totalMemoByDeceased(deceasedId)
console.log('é€è€…ç´¯è®¡ä¾›å¥‰:', deceasedTotal.toString())

// è½¬æ¢ä¸ºå¯è¯»æ ¼å¼
const dust = Number(deceasedTotal) / 1_000_000_000_000_000
console.log('é€è€…ç´¯è®¡ä¾›å¥‰:', `${dust} DUST`)
```

---

### 3. å¢“ä½ç´¯è®¡ä¾›å¥‰æ¬¡æ•°

**æ¥å£**: `api.query.ledger.totalsByGrave(graveId)`

**è¯´æ˜**: æŸ¥è¯¢æŒ‡å®šå¢“ä½çš„ç´¯è®¡ä¾›å¥‰æ¬¡æ•°

**å‚æ•°**:
- `graveId`: å¢“ä½IDï¼ˆu64ï¼‰

**è¿”å›**: `u64` ç±»å‹ï¼ˆç´¯è®¡æ¬¡æ•°ï¼‰

**ç¤ºä¾‹**:
```typescript
// æŸ¥è¯¢å¢“ä½ç´¯è®¡ä¾›å¥‰æ¬¡æ•°
const totalCount = await api.query.ledger.totalsByGrave(graveId)
console.log('ç´¯è®¡ä¾›å¥‰æ¬¡æ•°:', totalCount.toNumber())
```

---

### 4. å‘¨æ´»è·ƒæ ‡è®°

**æ¥å£**: `api.query.ledger.weeklyActive(graveId, accountId, weekIndex)`

**è¯´æ˜**: æŸ¥è¯¢æŒ‡å®šè´¦æˆ·åœ¨æŒ‡å®šå¢“ä½çš„æŒ‡å®šå‘¨æ˜¯å¦æ´»è·ƒ

**å‚æ•°**:
- `graveId`: å¢“ä½ID
- `accountId`: è´¦æˆ·ID
- `weekIndex`: å‘¨ç´¢å¼•ï¼ˆu64ï¼‰

**è¿”å›**: `Option<()>` ç±»å‹ï¼ˆå­˜åœ¨è¡¨ç¤ºæ´»è·ƒï¼‰

**ç¤ºä¾‹**:
```typescript
const accountId = '5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY'
const weekIndex = 0 // å‘¨ç´¢å¼•

// æŸ¥è¯¢å‘¨æ´»è·ƒæ ‡è®°
const isActive = await api.query.ledger.weeklyActive(graveId, accountId, weekIndex)
console.log('æ˜¯å¦æ´»è·ƒ:', isActive.isSome)
```

---

## ğŸ’» å‰ç«¯é›†æˆç¤ºä¾‹

### åœ¨çºªå¿µé¦†é¡µé¢ä¸­æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯

```typescript
import React, { useState, useEffect } from 'react'
import { getApi } from '../../lib/polkadot'

interface MemorialStats {
  offeringCount: number
  totalAmount: number // DUST
  deceasedTotalAmount: number // DUST
}

const MemorialComprehensive: React.FC = () => {
  const [stats, setStats] = useState<MemorialStats>({
    offeringCount: 0,
    totalAmount: 0,
    deceasedTotalAmount: 0
  })

  /**
   * å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šåŠ è½½çºªå¿µé¦†ç»Ÿè®¡æ•°æ®
   */
  const loadStats = async (graveId: number, deceasedId?: number) => {
    try {
      const api = await getApi()

      // æŸ¥è¯¢å¢“ä½ç´¯è®¡ä¾›å¥‰æ¬¡æ•°
      const totalCount = await api.query.ledger.totalsByGrave(graveId)
      
      // æŸ¥è¯¢å¢“ä½ç´¯è®¡ä¾›å¥‰é‡‘é¢
      const totalAmount = await api.query.ledger.totalMemoByGrave(graveId)
      
      // æŸ¥è¯¢é€è€…ç´¯è®¡ä¾›å¥‰é‡‘é¢ï¼ˆå¦‚æœæœ‰é€è€…IDï¼‰
      let deceasedTotalAmount = 0
      if (deceasedId) {
        const deceasedTotal = await api.query.ledger.totalMemoByDeceased(deceasedId)
        deceasedTotalAmount = Number(deceasedTotal) / 1_000_000_000_000_000
      }

      // è½¬æ¢ä¸ºå¯è¯»æ ¼å¼
      const dust = Number(totalAmount) / 1_000_000_000_000_000

      setStats({
        offeringCount: totalCount.toNumber(),
        totalAmount: dust,
        deceasedTotalAmount
      })
    } catch (error) {
      console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error)
    }
  }

  useEffect(() => {
    // å‡è®¾ä»è·¯ç”±å‚æ•°è·å–å¢“ä½IDå’Œé€è€…ID
    const graveId = 1
    const deceasedId = 1
    loadStats(graveId, deceasedId)
  }, [])

  return (
    <div>
      <div>ç´¯è®¡ä¾›å¥‰æ¬¡æ•°: {stats.offeringCount}</div>
      <div>ç´¯è®¡ä¾›å¥‰é‡‘é¢: {stats.totalAmount} DUST</div>
      {stats.deceasedTotalAmount > 0 && (
        <div>é€è€…ç´¯è®¡ä¾›å¥‰: {stats.deceasedTotalAmount} DUST</div>
      )}
    </div>
  )
}
```

---

## ğŸ“Š æ•°æ®æ ¼å¼è¯´æ˜

### Balance ç±»å‹è½¬æ¢

é“¾ä¸Šçš„ `Balance` ç±»å‹ä½¿ç”¨æœ€å°å•ä½ï¼ˆç±»ä¼¼ Weiï¼‰ï¼Œéœ€è¦è½¬æ¢ä¸ºå¯è¯»æ ¼å¼ï¼š

```typescript
// DUST çš„æœ€å°å•ä½æ˜¯ 1e15ï¼ˆ1 DUST = 1_000_000_000_000_000 æœ€å°å•ä½ï¼‰
const DUST_UNIT = 1_000_000_000_000_000

// è½¬æ¢ä¸º DUST
const dust = Number(balance) / DUST_UNIT

// è½¬æ¢ä¸º DUSTï¼ˆå¦‚æœ DUST = DUSTï¼‰
const memo = dust
```

### æ ¼å¼åŒ–æ˜¾ç¤º

```typescript
/**
 * å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šæ ¼å¼åŒ–é‡‘é¢æ˜¾ç¤º
 */
const formatAmount = (amount: number): string => {
  if (amount === 0) return '0'
  if (amount < 0.01) return '< 0.01'
  if (amount < 1000) return amount.toFixed(2)
  if (amount < 1000000) return `${(amount / 1000).toFixed(2)}K`
  return `${(amount / 1000000).toFixed(2)}M`
}

// ä½¿ç”¨ç¤ºä¾‹
const amount = 1234.56
console.log(formatAmount(amount)) // "1.23K"
```

---

## ğŸ”„ æ•°æ®æ›´æ–°æœºåˆ¶

### è‡ªåŠ¨æ›´æ–°

å½“ç”¨æˆ·è¿›è¡Œä¾›å¥‰æ“ä½œæ—¶ï¼Œ`pallet-memorial` ä¼šé€šè¿‡ `OnOfferingCommitted` trait å›è°ƒ `pallet-ledger`ï¼Œè‡ªåŠ¨æ›´æ–°ç»Ÿè®¡æ•°æ®ï¼š

```rust
// pallet-memorial åœ¨ä¾›å¥‰å®Œæˆåè°ƒç”¨
T::OnOfferingCommitted::on_offering(target, kind_code, &who, amount, duration_weeks);

// pallet-ledger å®ç°è¯¥ traitï¼Œæ›´æ–°ç»Ÿè®¡
pub fn on_offering(
    target: (u8, u64),
    _kind_code: u8,
    who: &AccountId,
    amount: u128,
    _duration_weeks: Option<u32>,
) {
    // æ›´æ–°å¢“ä½ç»Ÿè®¡
    Ledger::record_from_hook_with_amount(grave_id, who, kind_code, Some(amount), None, None);
    
    // æ›´æ–°é€è€…ç»Ÿè®¡ï¼ˆå¦‚æœæœ‰é€è€…IDï¼‰
    if let Some(deceased_id) = get_deceased_id(target) {
        Ledger::add_to_deceased_total(deceased_id, amount);
    }
}
```

### å®æ—¶æŸ¥è¯¢

å‰ç«¯å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼å®æ—¶æŸ¥è¯¢æœ€æ–°æ•°æ®ï¼š

1. **è½®è¯¢æŸ¥è¯¢**: å®šæœŸæŸ¥è¯¢ç»Ÿè®¡æ•°æ®
2. **äº‹ä»¶ç›‘å¬**: ç›‘å¬ `OfferingCommitted` äº‹ä»¶ï¼Œè§¦å‘æ•°æ®åˆ·æ–°
3. **è®¢é˜…æŸ¥è¯¢**: ä½¿ç”¨ Polkadot.js çš„è®¢é˜…åŠŸèƒ½

---

## ğŸ“ å®Œæ•´ç¤ºä¾‹

### åœ¨çºªå¿µé¦†ç»¼åˆé¡µé¢ä¸­é›†æˆ

```typescript
// MemorialComprehensive.tsx

import { getApi } from '../../lib/polkadot'

const MemorialComprehensive: React.FC = () => {
  const [stats, setStats] = useState({
    offeringCount: 0,
    totalAmount: 0,
    candleCount: 0
  })

  useEffect(() => {
    const loadStats = async () => {
      try {
        const api = await getApi()
        const graveId = 1 // ä»è·¯ç”±å‚æ•°è·å–

        // å¹¶è¡ŒæŸ¥è¯¢æ‰€æœ‰ç»Ÿè®¡æ•°æ®
        const [totalCount, totalAmount] = await Promise.all([
          api.query.ledger.totalsByGrave(graveId),
          api.query.ledger.totalMemoByGrave(graveId)
        ])

        setStats({
          offeringCount: totalCount.toNumber(),
          totalAmount: Number(totalAmount) / 1_000_000_000_000_000,
          candleCount: 0 // TODO: ä»å…¶ä»–æ•°æ®æºè·å–
        })
      } catch (error) {
        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error)
      }
    }

    loadStats()
  }, [])

  return (
    <div>
      {/* ç»Ÿè®¡ä¿¡æ¯å±•ç¤º */}
      <div style={{ margin: '16px 0', fontSize: 13, color: '#666', lineHeight: 2 }}>
        <div>ä»–ä»¬ä¸­æœ€ä¹…çš„å·²ç»ç¦»å¼€æˆ‘ä»¬45å¹´äº†</div>
        <div>äº²å‹ä»¬å·²ç¥­æ‹œ{stats.offeringCount}æ¬¡ï¼Œå·²ç‚¹äº®èœ¡çƒ›{stats.candleCount}æ¬¡</div>
        <div>ç´¯è®¡ä¾›å¥‰é‡‘é¢: {stats.totalAmount.toFixed(2)} DUST</div>
      </div>
    </div>
  )
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å•ä½è½¬æ¢**: é“¾ä¸Šçš„ `Balance` ä½¿ç”¨æœ€å°å•ä½ï¼Œéœ€è¦é™¤ä»¥ `1_000_000_000_000_000` è½¬æ¢ä¸º DUST
2. **å¼‚æ­¥æŸ¥è¯¢**: æ‰€æœ‰æŸ¥è¯¢éƒ½æ˜¯å¼‚æ­¥çš„ï¼Œéœ€è¦ä½¿ç”¨ `await` æˆ– `.then()`
3. **é”™è¯¯å¤„ç†**: æŸ¥è¯¢å¯èƒ½å¤±è´¥ï¼Œéœ€è¦æ·»åŠ é”™è¯¯å¤„ç†
4. **æ•°æ®æ›´æ–°**: ç»Ÿè®¡æ•°æ®åœ¨ä¾›å¥‰å®Œæˆåè‡ªåŠ¨æ›´æ–°ï¼Œæ— éœ€æ‰‹åŠ¨åˆ·æ–°

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- `pallets/ledger/README.md` - Ledger Pallet å®Œæ•´æ–‡æ¡£
- `pallets/memorial/README.md` - Memorial Pallet æ–‡æ¡£

---

**ç»´æŠ¤è€…**: Stardust Team  
**æœ€åæ›´æ–°**: 2025-11-08

