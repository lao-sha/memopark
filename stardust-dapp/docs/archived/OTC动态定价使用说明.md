# OTC 动态定价使用说明

## 概述

OTC 挂单系统已升级至 **v2.0 动态定价版本**，引入基于市场均价的价格偏离检查（±20%），保护交易双方利益，防止恶意定价或误操作。

## 核心改进

### 1. 市场均价实时显示 ✨

**位置**：挂单创建页面顶部市场价格卡片

**内容**：
- 当前市场均价（USDT/MEMO）
- 允许的价格范围（±20%，可治理调整）
- 冷启动状态提示（市场价格为 0 时）

### 2. 价格偏离实时检查 ✨

**功能**：
- 用户输入价格时，实时计算相对市场均价的偏离度
- 视觉反馈：
  - ✅ **绿色对勾**：价格在允许范围内（±20%）
  - ⚠️ **黄色警告**：价格偏离较大（>10% 但 ≤20%）
  - 🚫 **红色警告**：价格偏离超出允许范围（>20%），链上交易将被拒绝

### 3. 快捷价格按钮 ✨

**位置**：价格输入框下方

**功能**：快速设置常用价格档位
- **市价 -5%**：低于市场均价 5%
- **市价**：等于市场均价
- **市价 +5%**：高于市场均价 5%
- **市价 +10%**：高于市场均价 10%

### 4. 价格偏离告警 ✨

**触发条件**：提交挂单时，价格超出允许范围（±20%）

**告警内容**：
- 显示价格偏离百分比
- 显示市场均价和用户价格对比
- 显示允许的价格范围
- 提供"调整价格"和"仍然提交"两个选项

**行为**：
- 选择"调整价格"：取消提交，返回表单修改
- 选择"仍然提交"：继续提交，但**链上交易将被拒绝**（PriceDeviationTooHigh 错误）

## 使用流程

### 步骤 1：查看市场价格

打开"创建挂单"页面，顶部自动显示：
- ✅ 市场均价：0.500000 USDT/MEMO
- ✅ 允许范围 (±20%)：0.400000 - 0.600000 USDT

### 步骤 2：输入挂单价格

#### 方式 1：手动输入

在"挂单价格（USDT/MEMO）"字段输入价格，例如：
- 输入 `520000`（精度 10^6）
- 自动换算显示：0.520000 USDT
- 实时显示偏离度：+4.00%

#### 方式 2：使用快捷按钮

点击"市价 +5%"按钮：
- 自动填入：525000
- 自动换算显示：0.525000 USDT
- 实时显示偏离度：+5.00%

### 步骤 3：查看价格状态

价格输入框下方会实时显示：

#### ✅ 正常状态（偏离 ≤10%）
```
你的价格：0.520000 USDT    +4.00%
```
- 绿色对勾图标
- 无告警信息

#### ⚠️ 警告状态（偏离 >10% 且 ≤20%）
```
你的价格：0.580000 USDT    +16.00%
⚠️ 价格偏离较大 (16.00%)，建议调整至市场均价附近。
```
- 黄色警告图标
- 黄色提示框

#### 🚫 错误状态（偏离 >20%）
```
你的价格：0.650000 USDT    +30.00%
❌ 价格偏离超出允许范围 (±20%)，链上交易将被拒绝！
```
- 红色警告图标
- 红色错误提示框
- 提交按钮变为红色，文本显示"价格超出范围，无法提交"

### 步骤 4：填写其他字段

| 字段 | 说明 | 示例 |
|------|------|------|
| 你的地址 | 挂单创建者地址 | 自动填充当前钱包地址 |
| 方向 | 固定为"卖出 MEMO" | 卖出 MEMO |
| 每笔最小数量 | 单笔订单最小购买量（MEMO） | 1000 |
| 每笔最大数量 | 单笔订单最大购买量（MEMO） | 5000 |
| 挂单总量 | 本次挂单总供应量（MEMO） | 10000 |
| 价带下限 | 可选，订单金额下限（MEMO） | 留空 |
| 价带上限 | 可选，订单金额上限（MEMO） | 留空 |
| 允许部分成交 | 是否允许买家分批购买 | ✅ 开启 |
| 过期区块高度 | 挂单过期时间（区块号） | 当前区块 + 14400 (≈24小时) |

### 步骤 5：提交挂单

#### 情况 1：价格在允许范围内

点击"创建挂单"按钮：
- 签名并发送交易
- 等待链上确认
- 成功后显示：`挂单创建成功：0x...`

#### 情况 2：价格超出允许范围

点击"创建挂单"按钮：
- 弹出价格偏离告警对话框
  ```
  价格偏离警告
  
  你的挂单价格偏离市场均价 30.00%，超出允许范围 (±20%)。
  
  市场均价：0.500000 USDT
  你的价格：0.650000 USDT
  允许范围：0.400000 - 0.600000 USDT
  
  ⚠️ 链上交易将被拒绝，请调整价格后重试。
  
  [调整价格]  [仍然提交]
  ```
- 选择"调整价格"：返回表单修改
- 选择"仍然提交"：链上交易失败（PriceDeviationTooHigh 错误）

## 冷启动期使用

### 什么是冷启动？

当市场价格尚未形成时（市场均价 = 0），系统处于"冷启动状态"。

### 冷启动期显示

顶部市场价格卡片显示：
- 市场均价：<Tag color="orange">冷启动状态</Tag>
- 提示：`当前处于冷启动状态，市场价格尚未形成，可自由定价。`

### 冷启动期行为

- ✅ **不进行价格偏离检查**
- ✅ **允许自由定价**（范围：0.01 - 100 USDT）
- ✅ **无快捷价格按钮**（因无市场价格参考）

### 建议

冷启动期建议参考其他交易所价格，确保定价合理，避免首批交易形成不合理的市场均价。

## 价格反馈闭环

```
市场成交 → pallet-pricing (滑动窗口统计) → 市场均价
    ↑                                           ↓
    └─────────── pallet-otc-listing (±20% 检查) ←┘
```

### 工作原理

1. **挂单创建**：做市商以市场均价 ±20% 范围内的价格创建挂单
2. **订单成交**：买家吃单，卖家放行
3. **数据上报**：`pallet-otc-order` 自动向 `pallet-pricing` 上报成交数据
4. **均价更新**：`pallet-pricing` 更新市场均价（滑动窗口统计）
5. **下次挂单**：做市商基于新的市场均价创建挂单

### 优势

- ✅ **自适应定价**：市场均价随真实成交动态调整
- ✅ **防止价格操纵**：±20% 限制防止极端价格
- ✅ **价格发现**：真实供需关系形成合理价格
- ✅ **闭环反馈**：成交推动均价，均价指导成交

## 常见问题

### Q1：为什么我的价格被拒绝了？

**A**：价格偏离市场均价超过 ±20%。请查看市场价格卡片，调整价格至允许范围内。

### Q2：我可以修改允许偏离范围吗？

**A**：允许偏离范围由治理（Root）设置，普通用户无法修改。当前默认为 ±20%。

### Q3：冷启动状态下，我应该如何定价？

**A**：参考其他交易所（如 Binance、Coinbase）的 MEMO/USDT 价格，确保首批交易形成合理的市场均价。

### Q4：快捷价格按钮为什么没有显示？

**A**：冷启动状态下（市场均价 = 0），无快捷价格按钮。等待第一批订单成交后，市场均价形成，快捷按钮将自动显示。

### Q5：我的挂单价格会随市场均价变化吗？

**A**：不会。挂单创建时价格即锁定，不受后续市场均价变化影响。

### Q6：如何查看当前市场均价？

**A**：
1. **挂单创建页面**：顶部市场价格卡片
2. **价格监控 Dashboard**：全局导航 → 价格监控
3. **链上查询**：`api.query.pricing.getMemoMarketPriceWeighted()`

### Q7：价格偏离告警可以关闭吗？

**A**：不能。价格偏离告警是为保护交易双方利益而设计的强制性风控机制。

## 技术细节

### 价格精度

- **精度**：10^6（6位小数）
- **示例**：
  - `500000` = 0.500000 USDT/MEMO
  - `1000000` = 1.000000 USDT/MEMO
  - `10000` = 0.010000 USDT/MEMO

### 价格范围限制

- **最低价**：0.01 USDT (10,000)
- **最高价**：100 USDT (100,000,000)

### 偏离度计算

```
deviation = (your_price - market_price) / market_price × 100%
```

### 允许范围计算

```
min_allowed = market_price × (1 - max_deviation / 10000)
max_allowed = market_price × (1 + max_deviation / 10000)
```

例如：市场均价 = 0.500000 USDT，max_deviation = 2000 (20%)
```
min_allowed = 0.500000 × (1 - 0.20) = 0.400000 USDT
max_allowed = 0.500000 × (1 + 0.20) = 0.600000 USDT
```

## 相关文档

- [pallet-otc-listing README](/home/xiaodong/文档/stardust/pallets/otc-listing/README.md)
- [pallet-otc-order README](/home/xiaodong/文档/stardust/pallets/otc-order/README.md)
- [pallet-pricing README](/home/xiaodong/文档/stardust/pallets/pricing/README.md)
- [定价基准价格±20%方案分析](/home/xiaodong/文档/stardust/docs/定价基准价格±20%方案分析.md)

## 版本信息

- **版本**：v2.0.0
- **发布日期**：2025-10-19
- **状态**：✅ 已完成

---

**✅ OTC 动态定价 v2.0 - 使用说明完成**

