# 价格监控 Dashboard 使用说明

## 概述

价格监控 Dashboard 提供全局的市场价格监控功能，实时展示市场加权均价、OTC/Bridge 平均价格、成交量统计、价格偏离计算等关键指标。

## 访问路径

**方式 1**：全局导航
- 点击顶部导航栏 → "价格监控"

**方式 2**：直接访问
- URL：`#/monitoring/price` 或 `#/price-dashboard`

## 页面结构

### 1. 冷启动状态提示（可选）

**显示条件**：市场价格为 0 时显示

**内容**：
```
⚠️ 冷启动状态
市场价格尚未形成，等待第一批订单成交。
冷启动期间，挂单不进行价格偏离检查。
```

### 2. 核心价格指标

#### 2.1 市场加权均价
- **说明**：OTC + Bridge 的加权平均价格
- **精度**：6 位小数（例如：0.500000 USDT/MEMO）
- **计算公式**：
  ```
  market_price = (otc_avg × otc_volume + bridge_avg × bridge_volume) 
                 / (otc_volume + bridge_volume)
  ```
- **冷启动**：价格为 0 时显示灰色

#### 2.2 OTC 平均价格
- **说明**：OTC 挂单成交的滑动窗口平均价格
- **精度**：6 位小数
- **颜色**：绿色（有数据）/ 灰色（无数据）

#### 2.3 Bridge 平均价格
- **说明**：Simple Bridge 兑换的滑动窗口平均价格
- **精度**：6 位小数
- **颜色**：橙色（有数据）/ 灰色（无数据）

### 3. 允许的挂单价格范围

**显示条件**：市场价格 > 0 且 MaxPriceDeviation > 0

**内容**：
| 指标 | 说明 |
|------|------|
| 最低价 | 市场均价 × (1 - max_deviation) |
| 偏离范围 | ±20%（默认，可治理调整） |
| 最高价 | 市场均价 × (1 + max_deviation) |

**示例**：
- 市场均价：0.500000 USDT
- 偏离范围：±20%
- 最低价：0.400000 USDT（绿色显示）
- 最高价：0.600000 USDT（红色显示）

### 4. 成交量统计

#### 4.1 OTC 累计成交量
- **当前成交量**：显示累计成交的 MEMO 数量
- **滑动窗口大小**：统计窗口的目标大小（例如：1,000,000 MEMO）
- **填充进度**：当前成交量 / 窗口大小 × 100%
  - < 100%：蓝色进度条
  - ≥ 100%：绿色进度条（窗口已填充）

#### 4.2 Bridge 累计成交量
- **当前成交量**：显示累计兑换的 MEMO 数量
- **滑动窗口大小**：统计窗口的目标大小（例如：500,000 MEMO）
- **填充进度**：当前成交量 / 窗口大小 × 100%
  - < 100%：蓝色进度条
  - ≥ 100%：绿色进度条（窗口已填充）

**说明**：
- 窗口未填充（< 100%）：平均价格基于当前所有成交
- 窗口已填充（≥ 100%）：平均价格基于最近 N MEMO 的成交（滑动窗口）

### 5. 价格偏离计算示例

**功能**：展示不同价格档位的偏离度和是否允许

**示例表格**：

| 价格档位 | 价格 (USDT) | 偏离度 | 状态 |
|---------|-------------|--------|------|
| 市价 -15% | 0.425000 | -15.00% | ❌ 拒绝（超出范围） |
| 市价 -10% | 0.450000 | -10.00% | ✅ 允许 |
| 市价 -5% | 0.475000 | -5.00% | ✅ 允许 |
| 市价 | 0.500000 | 0.00% | ✅ 允许 |
| 市价 +5% | 0.525000 | +5.00% | ✅ 允许 |
| 市价 +10% | 0.550000 | +10.00% | ✅ 允许 |
| 市价 +15% | 0.575000 | +15.00% | ❌ 拒绝（超出范围） |

**颜色说明**：
- **绿色文字**：负偏离（低于市场价）
- **红色文字**：正偏离（高于市场价）
- **绿色标签**：✅ 允许（价格在范围内）
- **红色标签**：❌ 拒绝（价格超出范围）

### 6. 说明区域

**内容**：
- 市场加权均价计算公式
- 滑动窗口机制说明
- 价格偏离检查说明
- 冷启动保护说明
- 数据刷新频率说明

## 使用场景

### 场景 1：创建挂单前查看市场价格

**步骤**：
1. 打开价格监控 Dashboard
2. 查看"市场加权均价"卡片
3. 查看"允许的挂单价格范围"卡片
4. 根据市场价格和允许范围，决定挂单价格

**示例**：
- 市场均价：0.500000 USDT
- 允许范围：0.400000 - 0.600000 USDT
- 建议挂单价格：
  - 卖单（希望快速成交）：0.480000 USDT（市价 -4%）
  - 卖单（期望更高收益）：0.580000 USDT（市价 +16%）

### 场景 2：监控价格偏离趋势

**步骤**：
1. 定期查看价格监控 Dashboard（建议每日查看）
2. 对比 OTC 平均价格和 Bridge 平均价格
3. 观察市场加权均价的变化趋势
4. 调整挂单策略

**分析**：
- **OTC 价格 > Bridge 价格**：OTC 市场供不应求，可提高挂单价格
- **OTC 价格 < Bridge 价格**：OTC 市场竞争激烈，建议降低挂单价格
- **OTC 价格 ≈ Bridge 价格**：市场均衡，按市场价格挂单

### 场景 3：检查窗口填充状态

**步骤**：
1. 查看"OTC 累计成交量"和"Bridge 累计成交量"卡片
2. 查看填充进度
3. 判断市场价格的可靠性

**解读**：
- **填充进度 < 20%**：
  - 市场价格可靠性较低
  - 容易受单笔大额交易影响
  - 建议谨慎参考
- **填充进度 20% - 100%**：
  - 市场价格逐渐稳定
  - 可以作为定价参考
- **填充进度 ≥ 100%**：
  - 滑动窗口已完全填充
  - 市场价格可靠性高
  - 可以放心参考

### 场景 4：测试价格偏离

**步骤**：
1. 查看"价格偏离计算示例"表格
2. 找到你计划挂单的价格档位
3. 查看偏离度和状态

**示例**：
- 计划挂单价格：0.575000 USDT
- 查表：市价 +15%，偏离度 +15.00%
- 状态：❌ 拒绝（超出 ±20% 范围）
- 建议：调整价格至 0.600000 USDT（市价 +20%）或更低

### 场景 5：冷启动期定价参考

**步骤**：
1. 查看页面顶部是否有"冷启动状态"提示
2. 如果处于冷启动状态，查看"价格偏离计算示例"表格
3. 参考其他交易所（如 Binance、Coinbase）的 MEMO/USDT 价格
4. 在合理范围内自由定价

**建议**：
- 参考主流交易所价格
- 避免极端定价（过高或过低）
- 首批交易将形成市场均价基准

## 数据刷新

### 自动刷新
- **频率**：每 30 秒自动刷新一次
- **内容**：所有价格数据、成交量统计、偏离示例

### 手动刷新
- **方法**：刷新浏览器页面（F5 或 Ctrl+R）

## 技术细节

### 数据来源

| 数据项 | 链上查询方法 |
|--------|-------------|
| 市场加权均价 | `api.query.pricing.getMemoMarketPriceWeighted()` |
| OTC 平均价格 | `api.query.pricing.otcAvgPrice()` |
| Bridge 平均价格 | `api.query.pricing.bridgeAvgPrice()` |
| OTC 累计成交量 | `api.query.pricing.otcCumulativeVolume()` |
| Bridge 累计成交量 | `api.query.pricing.bridgeCumulativeVolume()` |
| OTC 窗口大小 | `api.consts.pricing.otcVolumeWindowSize` |
| Bridge 窗口大小 | `api.consts.pricing.bridgeVolumeWindowSize` |
| 最大价格偏离 | `api.query.otcListing.maxPriceDeviation()` |

### 计算公式

#### 市场加权均价
```javascript
market_price = (otc_avg * otc_volume + bridge_avg * bridge_volume) 
               / (otc_volume + bridge_volume)
```

#### 价格偏离度
```javascript
deviation = (price - market_price) / market_price * 100
```

#### 允许的价格范围
```javascript
min_allowed = market_price * (1 - max_deviation / 10000)
max_allowed = market_price * (1 + max_deviation / 10000)
```

例如：market_price = 500000 (0.5 USDT), max_deviation = 2000 (20%)
```javascript
min_allowed = 500000 * (1 - 0.20) = 400000 (0.4 USDT)
max_allowed = 500000 * (1 + 0.20) = 600000 (0.6 USDT)
```

#### 窗口填充进度
```javascript
progress = (current_volume / window_size) * 100
```

## 常见问题

### Q1：为什么"市场加权均价"为 0？

**A**：处于冷启动状态，尚未有任何 OTC 或 Bridge 订单成交。等待第一批订单成交后，市场价格将自动形成。

### Q2："允许的挂单价格范围"卡片为什么没有显示？

**A**：市场价格为 0（冷启动）或 MaxPriceDeviation 为 0（价格检查已关闭）时，该卡片不显示。

### Q3：OTC 平均价格和 Bridge 平均价格为什么不一样？

**A**：
- OTC：做市商自由定价，价格可能偏高（做市商赚取价差）
- Bridge：官方兑换服务，价格接近市场均价
- 两者加权平均形成市场均价

### Q4：填充进度达到 100% 后会发生什么？

**A**：滑动窗口机制启动：
- 新成交加入窗口
- 最早的成交移出窗口
- 平均价格基于最近 N MEMO 的成交
- 防止历史成交影响当前价格

### Q5：如何判断市场价格是否可靠？

**A**：参考以下指标：
- ✅ **填充进度 ≥ 100%**：非常可靠
- ⚠️ **填充进度 50%-100%**：较可靠
- ⚠️ **填充进度 20%-50%**：一般可靠
- ❌ **填充进度 < 20%**：不太可靠

### Q6："价格偏离计算示例"表格的数据是实时的吗？

**A**：是的，表格基于当前市场均价和 MaxPriceDeviation 实时计算。每次市场均价更新，表格也会自动更新。

### Q7：可以导出历史价格数据吗？

**A**：当前版本暂不支持。未来版本将支持导出 CSV 格式的历史价格数据。

### Q8：价格监控 Dashboard 需要连接钱包吗？

**A**：不需要。价格监控是只读功能，无需连接钱包即可查看。

## 最佳实践

### 1. 定期查看

- **频率**：每日查看 1-2 次
- **时机**：
  - 创建挂单前
  - 市场波动较大时
  - 调整挂单策略时

### 2. 对比分析

- 对比 OTC 和 Bridge 的平均价格
- 观察两者的差距变化
- 判断市场供需关系

### 3. 结合其他指标

- 查看成交量趋势
- 查看窗口填充进度
- 综合判断市场状态

### 4. 参考建议挂单价格

- **快速成交**：市价 ±5%
- **平衡收益与速度**：市价 ±10%
- **追求高收益**：市价 ±15%（接近允许上限）

### 5. 避免极端定价

- 不建议挂单价格接近允许范围边界（±19% - ±20%）
- 留有缓冲空间，防止市场均价微小波动导致超出范围
- 建议挂单价格在 ±15% 以内

## 相关文档

- [OTC动态定价使用说明](/home/xiaodong/文档/stardust/stardust-dapp/OTC动态定价使用说明.md)
- [pallet-pricing README](/home/xiaodong/文档/stardust/pallets/pricing/README.md)
- [定价基准价格±20%方案分析](/home/xiaodong/文档/stardust/docs/定价基准价格±20%方案分析.md)

## 版本信息

- **版本**：v1.0.0
- **发布日期**：2025-10-19
- **状态**：✅ 已完成

---

**✅ 价格监控 Dashboard v1.0 - 使用说明完成**

