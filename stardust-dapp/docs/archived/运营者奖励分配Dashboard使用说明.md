# 运营者奖励分配 Dashboard 使用说明

## 📋 概述

运营者奖励分配 Dashboard 是 stardust-dapp 中用于管理和分配运营者奖励的前端界面。它展示所有活跃运营者的 SLA 统计，计算权重和预估收益，并提供一键分配功能。

## 🎯 功能特性

### 1. 数据展示

- ✅ **实时统计**：待分配金额、活跃运营者数、总权重、平均权重
- ✅ **运营者列表**：账户、存储量、可靠性、权重、预估收益
- ✅ **可视化**：进度条展示可靠性、百分比展示权重占比
- ✅ **排序功能**：支持按存储量、可靠性、权重、收益排序

### 2. 奖励分配

- ✅ **一键分配**：治理权限用户可直接执行分配
- ✅ **灵活金额**：支持全额分配或指定金额
- ✅ **实时反馈**：交易状态实时显示
- ✅ **自动刷新**：分配后自动刷新数据

### 3. 安全机制

- ✅ **权限检查**：仅治理 Origin 可执行分配
- ✅ **余额校验**：自动检查托管账户余额
- ✅ **错误处理**：完善的错误提示和处理

## 📦 组件位置

```
stardust-dapp/
  src/
    features/
      operator-rewards/
        OperatorRewardsDashboard.tsx  # 主组件
```

## 🔧 集成步骤

### 1. 添加路由

在 `src/routes.tsx` 中添加路由：

```tsx
import OperatorRewardsDashboard from './features/operator-rewards/OperatorRewardsDashboard';

const routes = [
  // ... 其他路由
  {
    path: '/operator-rewards',
    element: <OperatorRewardsDashboard />,
    meta: {
      title: '运营者奖励分配',
      requireAuth: true,
      requireGovernance: true, // 需要治理权限
    },
  },
];
```

### 2. 添加导航菜单

在侧边栏或顶部导航中添加入口：

```tsx
<Menu.Item key="operator-rewards" icon={<TrophyOutlined />}>
  <Link to="/operator-rewards">运营者奖励</Link>
</Menu.Item>
```

### 3. 添加依赖（如果缺失）

```bash
cd stardust-dapp
npm install @polkadot/util-crypto @polkadot/util
```

## 📱 界面说明

### 统计卡片区域

```
┌─────────────────────────────────────────────────────────────┐
│  待分配金额        活跃运营者       总权重        平均权重    │
│  10,000 MEMO       3             1,450         483.33       │
└─────────────────────────────────────────────────────────────┘
```

### 运营者列表

| 运营者账户 | 存储量 | 可靠性 | 权重 | 预估收益 | 状态 |
|-----------|--------|--------|------|----------|------|
| 5FHne... | 1000 GB | ██████████ 90% | 900 (62.07%) | 6,207 MEMO | 活跃 |
| 5GRvV... | 500 GB | ████████ 80% | 400 (27.59%) | 2,759 MEMO | 活跃 |
| 5DAcA... | 300 GB | █████ 50% | 150 (10.34%) | 1,034 MEMO | 活跃 |

### 分配对话框

```
┌────────────────────────────────────┐
│ 执行奖励分配                        │
├────────────────────────────────────┤
│ 当前托管账户余额: 10,000 MEMO       │
│ 活跃运营者数量: 3                   │
│                                    │
│ 分配金额（MEMO）：                  │
│ [         0         ] ←输入框      │
│ 提示：输入 0 表示分配全部余额        │
│                                    │
│ ⚠️ 此操作需要治理权限               │
├────────────────────────────────────┤
│        [取消]  [确认分配]           │
└────────────────────────────────────┘
```

## 🎮 使用流程

### 治理者操作流程

#### 1. 查看当前状态

1. 进入"运营者奖励分配"页面
2. 查看统计卡片：
   - 待分配金额：托管账户余额
   - 活跃运营者：当前可分配的运营者数量
   - 总权重：所有运营者权重之和
   - 平均权重：权重均值

#### 2. 检查运营者列表

查看每个运营者的：
- **存储量**：pinned_bytes，单位 GB
- **可靠性**：probe_ok / (probe_ok + probe_fail)
- **权重**：存储量 × 可靠性
- **预估收益**：按权重比例计算的预期分配金额

#### 3. 执行分配

1. 点击右上角"执行分配"按钮
2. 在对话框中输入分配金额：
   - 输入 `0`：分配全部托管账户余额
   - 输入具体数值：分配指定金额（如 10000）
3. 点击"确认分配"
4. 签名并发送交易
5. 等待交易确认

#### 4. 查看结果

- 交易成功后，页面自动刷新
- 查看事件日志（可在区块浏览器查看详细事件）
- 验证运营者账户余额是否增加

### 运营者操作流程

#### 1. 注册为运营者

```typescript
// 在 Polkadot.js Apps 或自定义界面调用
api.tx.memoIpfs.joinOperator(
  peer_id,           // IPFS peer ID
  capacity_gib,      // 存储容量（GiB）
  endpoint_hash,     // 集群端点哈希
  null,              // cert_fingerprint（可选）
  bond_amount        // 保证金
).signAndSend(account);
```

#### 2. 查看自己的数据

在运营者列表中找到自己的账户，查看：
- 当前存储量（pinned_bytes）
- 在线率（probe_ok / probe_fail）
- 综合权重
- 预估收益

#### 3. 提升收益策略

1. **增加存储量**：
   - 积极承接 pin 任务
   - 完成后及时上报 `mark_pinned`

2. **提高可靠性**：
   - 保持节点在线（提高 probe_ok）
   - 及时响应巡检
   - 避免频繁宕机

## 📊 数据计算逻辑

### 权重计算

```typescript
// 1. 计算可靠性（千分比）
const totalProbes = probe_ok + probe_fail;
const reliability = totalProbes > 0 
  ? (probe_ok * 1000) / totalProbes  // 实际可靠性
  : 500;                              // 新运营者默认 50%

// 2. 计算权重
const weight = (pinned_bytes * reliability) / 1000;

// 3. 计算权重占比
const share = weight / total_weight;
```

### 预估收益计算

```typescript
// 预估收益 = 托管账户余额 × (运营者权重 / 总权重)
const estimated_reward = escrow_balance * weight / total_weight;
```

### 实际分配

```rust
// 链端分配逻辑
let share_u128 = (total_amount as u128)
    .saturating_mul(weight as u128)
    .saturating_div(total_weight as u128);

let share: Balance = share_u128.saturated_into();
```

## 🔍 常见问题

### Q1: 为什么看不到"执行分配"按钮？

A: 可能原因：
- 当前账户没有治理权限
- 没有活跃的运营者（operator_count = 0）
- 托管账户余额为 0

### Q2: 为什么我的权重是 0？

A: 可能原因：
- `pinned_bytes = 0`（未承接任何 pin 任务）
- 状态不是 Active（被暂停或封禁）

### Q3: 预估收益和实际收益不一致？

A: 预估收益是基于当前余额和权重计算的，实际分配时：
- 如果指定了分配金额，实际金额可能不同
- 分配过程中如果有新交易修改了 SLA 数据，权重会变化

### Q4: 分配后余额去哪里了？

A: 按权重比例转账到各运营者的个人账户，可以在钱包中看到余额增加。

### Q5: 多久分配一次？

A: 建议每周执行一次，与供奉路由分配周期同步（每 7 天）。

## ⚠️ 注意事项

### 1. 权限要求

**只有具备治理权限的账户才能执行分配**：
- Root（sudo）
- 技术委员会 2/3 多签

### 2. Gas 费用

分配操作会遍历所有活跃运营者并执行转账，运营者数量越多，gas 费用越高。

### 3. 数据刷新

- 页面每 30 秒自动刷新一次
- 分配成功后会立即刷新
- 可手动刷新浏览器强制更新

### 4. 权重变化

运营者的权重会随着以下操作实时变化：
- 完成新的 pin 任务（增加 pinned_bytes）
- OCW 探测结果（更新 probe_ok/fail）
- 副本降级（增加 degraded）

## 🎨 自定义样式

### 修改主题颜色

在组件中修改 `valueStyle` 属性：

```tsx
<Statistic
  valueStyle={{ color: '#your-color' }}
  // ...
/>
```

### 修改表格样式

```tsx
<Table
  size="middle" // 'small' | 'middle' | 'large'
  bordered={true}
  // ...
/>
```

### 修改刷新间隔

```tsx
const interval = setInterval(loadOperators, 60000); // 改为 60 秒
```

## 📈 监控建议

### 关键指标监控

1. **托管账户余额**
   - 告警阈值：< 1000 MEMO
   - 建议：定期检查供奉路由是否正常

2. **活跃运营者数量**
   - 正常范围：≥ 3
   - 建议：鼓励更多节点加入

3. **平均可靠性**
   - 正常范围：> 80%
   - 建议：对低可靠性运营者进行沟通

4. **权重分布**
   - 建议：避免单个运营者权重过高（> 50%）
   - 策略：鼓励更多运营者提升容量

## 🚀 未来扩展

### 可能的功能增强

1. **历史记录**：展示过往分配记录
2. **图表可视化**：权重分布饼图、收益趋势图
3. **自动分配**：设置定时任务自动触发
4. **通知功能**：分配完成后发送通知
5. **导出功能**：导出运营者数据为 CSV

---

**版本**: v1.0  
**更新日期**: 2025-10-13  
**维护者**: Stardust 前端团队

