# 聊天功能前端使用说明

**创建日期**: 2025-10-21  
**版本**: v1.0.0  
**技术栈**: React 18 + TypeScript + Ant Design 5 + Polkadot.js  

---

## 📋 目录

1. [功能概述](#功能概述)
2. [技术架构](#技术架构)
3. [文件结构](#文件结构)
4. [页面组件](#页面组件)
5. [使用方法](#使用方法)
6. [依赖安装](#依赖安装)
7. [API 接口](#api-接口)
8. [注意事项](#注意事项)
9. [常见问题](#常见问题)

---

## 📱 功能概述

### 核心功能

1. ✅ **一对一私聊**：用户之间的端到端加密聊天
2. ✅ **会话管理**：自动创建和管理聊天会话
3. ✅ **消息加密**：使用 Polkadot.js 加密方案，确保隐私安全
4. ✅ **IPFS 存储**：消息内容存储在 IPFS，链上只保存元数据
5. ✅ **未读消息**：显示未读消息数量，支持标记已读
6. ✅ **实时更新**：监听链上事件，自动刷新消息
7. ✅ **响应式设计**：支持移动端、平板、桌面端自适应

### 适用场景

- ✅ **OTC 交易沟通**：买家与做市商的订单沟通（支持发送凭证截图 ✨）
- ✅ **做市商客服**：做市商与用户的一对一支持
- ✅ **家族私密沟通**：纪念馆管理者之间的沟通（支持分享文档 ✨）
- ✅ **证据提交**：需要分享图片或文件证据的场景 ✨

---

## 🏗️ 技术架构

### 整体架构

```
┌─────────────────────────────────────────────────────┐
│                   前端 (React)                       │
├─────────────────────────────────────────────────────┤
│  ChatPage (聊天页面)                                 │
│    ├── ChatList (会话列表)                           │
│    └── ChatWindow (聊天窗口)                         │
└────────┬────────────────────────────────────────────┘
         │
         ├─► Polkadot.js API (链上交互)
         │   └─► pallet-chat (链上模块)
         │
         ├─► IPFS (消息存储)
         │   └─► 加密消息内容
         │
         └─► Crypto (端到端加密)
             └─► @polkadot/util-crypto
```

### 数据流

```
发送消息:
用户输入 → 加密内容 → 上传到IPFS → 获取CID → 
调用链上接口 → 触发事件 → 对方收到通知

接收消息:
监听链上事件 → 获取消息元数据 → 从IPFS下载 → 
解密内容 → 显示消息 → 标记已读
```

---

## 📁 文件结构

```
stardust-dapp/
├── src/
│   ├── types/
│   │   └── chat.ts                  # 聊天相关类型定义
│   ├── lib/
│   │   ├── chat.ts                  # 聊天 Polkadot API 接口
│   │   ├── chat-ipfs.ts             # IPFS 上传下载工具
│   │   └── chat-crypto.ts           # 加密解密工具
│   ├── features/
│   │   └── chat/
│   │       ├── ChatPage.tsx         # 聊天主页面
│   │       ├── ChatPage.css         # 主页面样式
│   │       ├── ChatList.tsx         # 会话列表组件
│   │       ├── ChatList.css         # 列表样式
│   │       ├── ChatWindow.tsx       # 聊天窗口组件
│   │       ├── ChatWindow.css       # 窗口样式
│   │       ├── FileUploader.tsx     # 文件上传组件 ✨
│   │       ├── FileUploader.css     # 上传组件样式 ✨
│   │       ├── ImagePreview.tsx     # 图片预览组件 ✨
│   │       ├── ImagePreview.css     # 预览组件样式 ✨
│   │       ├── FileMessage.tsx      # 文件消息组件 ✨
│   │       └── FileMessage.css      # 文件消息样式 ✨
│   ├── hooks/
│   │   └── useMediaQuery.ts         # 媒体查询 Hook
│   └── routes.tsx                   # 路由配置（已添加 #/chat）
└── 聊天功能前端使用说明.md           # 本文档

✨ = Phase 2 新增
```

---

## 🧩 页面组件

### 1. ChatPage（聊天主页面）

**路由**: `#/chat`

**功能**:
- 管理聊天列表和聊天窗口的布局
- 响应式设计：桌面端左右分栏，移动端抽屉式
- 会话选择和切换

**Props**: 无

**使用示例**:
```typescript
// 访问 http://localhost:3000/#/chat
// 页面会自动加载
```

---

### 2. ChatList（会话列表）

**功能**:
- 显示所有会话列表
- 支持搜索会话（按地址或用户名）
- 显示未读消息数（红色徽章）
- 按最后活跃时间排序
- 显示最后一条消息预览

**Props**:
```typescript
interface ChatListProps {
  selectedSessionId?: string;          // 选中的会话ID
  onSelectSession: (session) => void;  // 选中会话回调
}
```

**使用示例**:
```tsx
<ChatList
  selectedSessionId={currentSession?.id}
  onSelectSession={(session) => setCurrentSession(session)}
/>
```

---

### 3. ChatWindow（聊天窗口）

**功能**:
- 显示消息列表（气泡式）
- 发送文本消息
- 自动标记已读
- 实时监听新消息
- 自动滚动到最新消息

**Props**:
```typescript
interface ChatWindowProps {
  session: Session;  // 当前会话
}
```

**使用示例**:
```tsx
<ChatWindow session={selectedSession} />
```

---

## 📖 使用方法

### 1. 访问聊天页面

在浏览器中访问：
```
http://localhost:3000/#/chat
```

### 2. 查看会话列表

- 页面左侧（桌面端）或抽屉（移动端）显示所有会话
- 红色徽章显示未读消息数
- 点击会话可切换聊天窗口

### 3. 发送消息

1. 在聊天窗口底部输入框输入消息
2. 按 `Enter` 键发送（`Shift+Enter` 换行）
3. 或点击"发送"按钮
4. 消息会自动加密并上传到 IPFS
5. 链上交易确认后，对方会收到通知

### 4. 接收消息

1. 页面会自动监听链上事件
2. 收到新消息时，会话列表自动更新
3. 打开会话后，消息会自动标记为已读
4. 未读数会实时更新

### 5. 搜索会话

在会话列表顶部搜索框输入：
- 对方地址（部分匹配）
- 对方用户名（如果有）

### 6. 发送图片 ✨ Phase 2

1. 点击输入框上方的"图片"按钮
2. 选择图片文件（支持 jpg, png, gif, webp）
3. 图片自动上传到 IPFS 并加密
4. 发送成功后，对方可查看图片
5. 点击图片可查看大图

**支持格式**:
- JPEG (.jpg, .jpeg)
- PNG (.png)
- GIF (.gif)
- WebP (.webp)

**大小限制**: 10MB

### 7. 发送文件 ✨ Phase 2

1. 点击输入框上方的"文件"按钮
2. 选择文件（支持 pdf, doc, docx, txt, zip, rar）
3. 文件自动上传到 IPFS 并加密
4. 发送成功后，对方可下载文件

**支持格式**:
- PDF (.pdf)
- Word (.doc, .docx)
- 文本 (.txt)
- 压缩包 (.zip, .rar)

**大小限制**: 10MB

---

## 📦 依赖安装

### 必需依赖

聊天功能需要以下 npm 包：

```bash
# 进入前端目录
cd /home/xiaodong/文档/stardust/stardust-dapp

# 安装依赖
npm install ipfs-http-client
npm install @polkadot/util
npm install @polkadot/util-crypto
npm install @polkadot/api
npm install antd
npm install react
npm install react-dom
```

### package.json 配置

确保 `package.json` 包含以下依赖：

```json
{
  "dependencies": {
    "@polkadot/api": "^10.0.0",
    "@polkadot/util": "^12.0.0",
    "@polkadot/util-crypto": "^12.0.0",
    "ipfs-http-client": "^60.0.0",
    "antd": "^5.0.0",
    "react": "^18.0.0",
    "react-dom": "^18.0.0"
  },
  "devDependencies": {
    "@types/react": "^18.0.0",
    "@types/react-dom": "^18.0.0",
    "typescript": "^5.0.0"
  }
}
```

---

## 🔌 API 接口

### 链上接口（pallet-chat）

#### 1. sendMessage - 发送消息

```typescript
await sendMessage(
  {
    receiver: '5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY',
    content: {
      text: '你好！',
      timestamp: Date.now(),
    },
    type: MessageType.Text,
    sessionId: '0x1234...', // 可选
  },
  account
);
```

#### 2. markMessageAsRead - 标记已读

```typescript
await markMessageAsRead(messageId, account);
```

#### 3. deleteMessage - 删除消息

```typescript
await deleteMessage(messageId, account);
```

#### 4. markSessionAsRead - 批量标记已读

```typescript
await markSessionAsRead(sessionId, account);
```

### 查询接口

#### 1. queryUserSessions - 查询用户会话

```typescript
const sessionIds = await queryUserSessions(userAddress);
// 返回: ['0x1234...', '0x5678...']
```

#### 2. querySession - 查询会话详情

```typescript
const session = await querySession(sessionId);
// 返回: Session 对象
```

#### 3. queryMessage - 查询消息

```typescript
const message = await queryMessage(
  messageId,
  myPrivateKey,
  myAddress
);
// 返回: Message 对象（已解密）
```

#### 4. queryUnreadCount - 查询未读数

```typescript
const count = await queryUnreadCount(userAddress, sessionId);
// 返回: 3
```

### 事件监听

```typescript
const unsubscribe = await subscribeChatEvents((event) => {
  if (event.type === 'MessageSent') {
    console.log('新消息:', event.data);
  }
});

// 取消监听
unsubscribe();
```

---

## ⚠️ 注意事项

### 1. IPFS 配置

**默认配置**:
```typescript
const IPFS_CONFIG = {
  url: 'https://ipfs.infura.io:5001/api/v0',
};
```

**如需使用自建 IPFS 节点**:

修改 `src/lib/chat-ipfs.ts`:
```typescript
const IPFS_CONFIG = {
  url: 'http://localhost:5001',  // 本地 IPFS 节点
};
```

### 2. 加密密钥

- ✅ 使用账户的 Polkadot 密钥对
- ✅ 私钥保存在本地，永不上传
- ✅ 公钥从账户地址解析
- ⚠️ **不要泄露私钥**

### 3. 消息隐私

- ✅ 消息内容端到端加密
- ✅ 只有发送方和接收方能解密
- ✅ IPFS 上存储的是加密内容
- ✅ 链上只有元数据（CID、地址等）

### 4. 链上成本

每条消息的链上成本：
- 发送消息：~0.01 MEMO（估算）
- 标记已读：~0.005 MEMO
- 删除消息：~0.005 MEMO

**建议**:
- 重要消息才发链上
- 可考虑批量操作（如批量标记已读）

### 5. IPFS 可靠性

**问题**: IPFS 内容可能被清理（Garbage Collection）

**解决方案**:
1. 使用 Pinata 或 Filebase 等托管服务
2. 自动 Pin 重要消息
3. 定期检查并重新 Pin

**代码示例**:
```typescript
import { pinContent } from '../lib/chat-ipfs';

// Pin 重要消息
await pinContent(cid);
```

### 6. 性能优化

**消息加载**:
- 默认加载最近 1000 条消息
- 可实现分页加载（未来版本）

**事件监听**:
- 使用 WebSocket 实时监听
- 避免频繁轮询

**缓存**:
- 可实现本地缓存（IndexedDB）
- 减少 IPFS 请求

---

## ❓ 常见问题

### Q1: 消息发送失败怎么办？

**可能原因**:
1. 账户余额不足（Gas 费）
2. IPFS 节点不可用
3. 网络连接问题

**解决方案**:
1. 检查账户余额
2. 检查 IPFS 配置
3. 查看浏览器控制台错误日志

---

### Q2: 无法解密消息？

**可能原因**:
1. 私钥不匹配
2. 消息损坏
3. IPFS 内容丢失

**解决方案**:
1. 确认使用正确的账户
2. 检查 IPFS CID 是否有效
3. 联系发送方重新发送

---

### Q3: 移动端无法显示聊天列表？

**解决方案**:
点击左上角菜单按钮（☰），打开抽屉式列表

---

### Q4: 支持哪些文件格式？

**图片**:
- JPEG (.jpg, .jpeg)
- PNG (.png)
- GIF (.gif)
- WebP (.webp)

**文件**:
- PDF (.pdf)
- Word (.doc, .docx)
- 文本 (.txt)
- 压缩包 (.zip, .rar)

**大小限制**: 单个文件最大 10MB

---

### Q5: 图片/文件上传失败？

**可能原因**:
1. 文件大小超过 10MB
2. 文件格式不支持
3. IPFS 节点不可用

**解决方案**:
1. 压缩文件或图片
2. 检查文件格式
3. 查看浏览器控制台错误

---

### Q6: 图片显示不出来？

**可能原因**:
1. IPFS 网关访问慢
2. CID 无效
3. 内容被清理

**解决方案**:
1. 等待 IPFS 加载
2. 切换 IPFS 网关
3. 请对方重新发送

---

### Q7: 消息能撤回吗？

**当前版本**: 仅支持软删除（标记删除，不真正删除）

**未来计划**: Phase 3 将支持消息撤回（时间窗口内）

---

### Q8: 如何导出聊天记录？

**当前版本**: 暂不支持

**未来计划**: Phase 3 将支持聊天记录导出

---

## 🚀 开发路线图

### Phase 1: MVP ✅ **已完成**
- ✅ 基本文本消息
- ✅ 一对一私聊
- ✅ 已读/未读状态
- ✅ 消息删除

### Phase 2: 增强功能 ✅ **已完成**
- ✅ 图片消息（支持 jpg, png, gif, webp）
- ✅ 文件消息（支持 pdf, doc, txt, zip等）
- ✅ 文件大小限制（10MB）
- ✅ 文件类型验证
- 📝 消息搜索（待开发）
- 📝 消息撤回（待开发）

### Phase 3: 高级功能 📝 **规划中**
- 📝 群聊
- 📝 语音消息
- 📝 消息转发
- 📝 聊天记录导出
- 📝 消息搜索（全文检索）

---

## 🔗 相关文档

- [链上聊天功能 Pallet 设计方案](/home/xiaodong/文档/stardust/docs/链上聊天功能Pallet设计方案.md)
- [Polkadot.js 文档](https://polkadot.js.org/docs/)
- [IPFS 文档](https://docs.ipfs.tech/)
- [Ant Design 文档](https://ant.design/)

---

## 📞 技术支持

如遇到问题，请：
1. 查看浏览器控制台日志
2. 检查链上交易状态
3. 查看 IPFS 节点状态
4. 联系开发团队

---

**文档完成** ✅

