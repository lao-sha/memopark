# Stardust DApp 架构图和补充说明

## 1. 整体架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                      Stardust DApp 前端应用                          │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────┐    │
│  │                    App.tsx (根组件)                          │    │
│  │  - ConfigProvider (Ant Design + 中文)                       │    │
│  │  - WalletProvider (钱包上下文)                              │    │
│  │  - GovernanceUiProvider (治理模式开关)                      │    │
│  └────────────────────────────────────────────────────────────┘    │
│                              │                                       │
│                 ┌────────────┼────────────┐                         │
│                 ▼            ▼            ▼                         │
│         ┌──────────────┐ ┌──────────┐ ┌──────────────┐             │
│         │ Routes.tsx   │ │BottomNav │ │SettingsDrawer│             │
│         │ (Hash Router)│ │  (导航)  │ │  (设置)     │             │
│         └──────┬───────┘ └──────────┘ └──────────────┘             │
│                │                                                    │
│    ┌───────────┴───────────────────────────────────┐               │
│    │                                               │               │
│    ├─────────────── Features (32个模块) ──────────┤               │
│    │                                               │               │
│    ├─ grave/        (纪念馆管理)     17个文件     │               │
│    ├─ chat/         (聊天系统)       21个文件     │               │
│    ├─ otc/          (OTC交易)        18个文件     │               │
│    ├─ offerings/    (供奉商品)       15个文件     │               │
│    ├─ auth/         (认证钱包)       9个文件      │               │
│    ├─ memorial/     (纪念馆展示)     8个文件      │               │
│    ├─ bridge/       (跨链桥接)       7个文件      │               │
│    ├─ first-purchase/ (首购系统)     7个文件      │               │
│    ├─ governance/   (治理投诉)       4个文件      │               │
│    └─ ... (其他13个)                              │               │
│                                                    │               │
└────────────────────────────────────────────────────┘               │
     ▼                    ▼                   ▼                       │
  ┌─────────┐      ┌──────────────┐    ┌──────────────┐             │
  │Components│      │   Services   │    │   Hooks      │             │
  │(18分类)  │      │   层         │    │   层         │             │
  └─────────┘      └──────────────┘    └──────────────┘             │
                                                                      │
└─────────────────────────────────────────────────────────────────────┘
                              │
                    ┌─────────┴──────────┐
                    ▼                    ▼
            ┌────────────────┐    ┌──────────────────┐
            │   Library 层   │    │   Storage 层     │
            │   (27个文件)   │    │                  │
            └────────────────┘    └──────────────────┘
                    │                    │
        ┌───────────┼──────────┬─────────┴──────┐
        ▼           ▼          ▼                ▼
   ┌─────────┐ ┌──────────┐ ┌──────────┐  ┌──────────┐
   │Polkadot │ │ IPFS     │ │ Chat     │  │ Session  │
   │ API     │ │ Storage  │ │ Crypto   │  │ Manager  │
   │Connection│ │          │ │          │  │          │
   └─────────┘ └──────────┘ └──────────┘  └──────────┘
        │
        ▼
   ┌─────────────────────────────────────────┐
   │  Substrate 区块链节点 (9944 端口)       │
   │                                         │
   │  - 30+ Pallets (memorial, trading, etc) │
   │  - 15-level affiliate system            │
   │  - Escrow settlement                    │
   └─────────────────────────────────────────┘
```

---

## 2. 数据流架构

### 2.1 用户认证流程

```
                        用户
                         │
                ┌────────┴────────┐
                ▼                 ▼
        ┌──────────────┐   ┌──────────────┐
        │  创建钱包    │   │  导入钱包    │
        │  (助记词)    │   │  (恢复)      │
        └──────┬───────┘   └────────┬─────┘
               │                    │
               └────────┬───────────┘
                        ▼
            ┌──────────────────────┐
            │ GenerateLocalWallet  │
            │ (PBKDF2+AES-GCM)     │
            └──────────┬───────────┘
                       ▼
            ┌──────────────────────┐
            │ SaveLocalKeystore    │
            │ (localStorage)       │
            └──────────┬───────────┘
                       ▼
            ┌──────────────────────┐
            │ SessionManager.init()│
            │ (纯前端会话)         │
            └──────────┬───────────┘
                       ▼
            ┌──────────────────────┐
            │ 钱包已就绪，可交互   │
            └──────────────────────┘
```

### 2.2 交易签名流程

```
用户操作 (如创建供奉)
     │
     ▼
┌─────────────────────────────────────────┐
│ 组件 (如 OfferingsList.tsx)              │
│ signAndSendLocal(section, method, args) │
└────────────┬────────────────────────────┘
             ▼
┌─────────────────────────────────────────┐
│ polkadot-safe.ts                        │
│ - 获取 keystore                         │
│ - 使用 password 解密                    │
│ - 创建 KeyPair                          │
│ - 签名交易 (sr25519)                    │
└────────────┬────────────────────────────┘
             ▼
┌─────────────────────────────────────────┐
│ 选择发送方式                            │
├─────────────────────────────────────────┤
│ 方式1: signAndSend()                    │
│ → 直连 WebSocket (9944)                 │
│                                         │
│ 方式2: sendViaForwarder()               │
│ → 通过代理服务 (可选)                   │
│ → 添加代付功能 (代付交易费)             │
└────────────┬────────────────────────────┘
             ▼
┌─────────────────────────────────────────┐
│ Substrate 节点处理                      │
│ - 验证签名                              │
│ - 执行 pallet 逻辑                      │
│ - 返回交易哈希                          │
└────────────┬────────────────────────────┘
             ▼
┌─────────────────────────────────────────┐
│ 组件更新 UI                              │
│ - 显示确认状态                          │
│ - 记录到 txHistory                      │
│ - localStorage 缓存                     │
└─────────────────────────────────────────┘
```

### 2.3 聊天消息流程

```
发送方输入消息
     │
     ▼
┌──────────────────────┐
│ ChatInput 组件       │
│ 消息明文             │
└─────────┬────────────┘
          ▼
┌──────────────────────────┐
│ chat-crypto.ts           │
│ 端到端加密               │
│ (接收方公钥加密)         │
└─────────┬────────────────┘
          ▼
       ┌──┬──┐
       │  │  │
     ┌─▼──▼─┐
     │ IPFS │ (如果包含文件)
     │ 上传 │
     └─┬────┘
       ▼
┌──────────────────────────────────┐
│ 链上存储 (pallet-chat)            │
│ - CID (内容地址)                  │
│ - 加密内容                        │
│ - 时间戳                          │
│ - 接收方地址                      │
└─────────┬──────────────────────────┘
          ▼
┌──────────────────────────────────┐
│ chat-cache.ts (IndexedDB 缓存)   │
│ 本地消息历史                      │
└──────────────────────────────────┘
          │
          └─ 同步到接收方
             │
             ▼
        ┌──────────────────────┐
        │ 接收方解密消息       │
        │ 显示在 ChatWindow    │
        └──────────────────────┘
```

---

## 3. 模块依赖关系

### 3.1 Features 模块依赖图（关键模块）

```
                    ┌─────────────────────────┐
                    │   auth/                 │
                    │  (认证钱包)             │
                    └────────────┬────────────┘
                                 │
                    ┌────────────▼────────────┐
                    │  wallet/                │
                    │  (钱包管理)             │
                    └────────────┬────────────┘
                                 │
                ┌────────────────┼────────────────┐
                ▼                ▼                ▼
        ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
        │  grave/      │  │  offerings/  │  │  otc/        │
        │ (纪念馆)     │  │  (供奉)      │  │ (OTC交易)    │
        │              │  │              │  │              │
        │ 依赖:        │  │ 依赖:        │  │ 依赖:        │
        │- deceased/   │  │- memorial/   │  │- first-      │
        │- ipfs/       │  │- trading/    │  │  purchase/   │
        └──────┬───────┘  └──────┬───────┘  └──────┬───────┘
               │                 │                 │
               └─────────┬───────┴─────────┬───────┘
                         ▼                 ▼
                    ┌──────────────┐  ┌──────────────┐
                    │   bridge/    │  │  membership/ │
                    │  (跨链)      │  │  (会员)      │
                    └──────┬───────┘  └──────────────┘
                           │
                    ┌──────▼───────────┐
                    │   governance/    │
                    │   (治理仲裁)     │
                    └──────────────────┘
                           │
            ┌──────────────▼────────────────┐
            │                               │
            ▼                               ▼
     ┌─────────────┐              ┌──────────────────┐
     │  evidence/  │              │  arbitration/    │
     │  (证据)     │              │  (仲裁)          │
     └─────────────┘              └──────────────────┘
```

### 3.2 服务层依赖关系

```
┌─────────────────────────────────────────────────────┐
│              Services Layer (服务层)                 │
└─────────────────────────────────────────────────────┘
                         │
        ┌────────────────┼────────────────┐
        │                │                │
        ▼                ▼                ▼
┌──────────────────┐ ┌──────────────┐ ┌──────────────────┐
│ memorialService  │ │tradingService│ │deceasedService   │
│  - 供奉品管理    │ │  - OTC 订单  │ │  - 逝者信息      │
│  - 祭祀品目录    │ │  - 做市商    │ │  - 关系管理      │
│  - 供奉操作      │ │  - 桥接      │ │  - 媒体管理      │
└────────┬─────────┘ └────┬─────────┘ └────────┬─────────┘
         │                │                   │
         └────────────────┼───────────────────┘
                          ▼
         ┌────────────────────────────────┐
         │ polkadot-safe.ts (API 层)      │
         │  - getApi()                    │
         │  - queryFreeBalance()          │
         │  - signAndSend()               │
         │  - sendViaForwarder()          │
         └────────────┬───────────────────┘
                      ▼
         ┌────────────────────────────────┐
         │ @polkadot/api (底层库)         │
         │  - WebSocket 连接              │
         │  - RPC 调用                    │
         │  - 类型编解码                  │
         └────────────┬───────────────────┘
                      ▼
         ┌────────────────────────────────┐
         │ Substrate 节点 (区块链)        │
         └────────────────────────────────┘
```

---

## 4. 状态管理架构详解

### 4.1 全局状态树

```
App Root
│
├─ WalletProvider Context
│  ├─ api: ApiPromise
│  ├─ accounts: InjectedAccountWithMeta[]
│  ├─ selectedAccount: InjectedAccountWithMeta | null
│  ├─ currentAccount: InjectedAccountWithMeta | null
│  ├─ isConnected: boolean
│  ├─ isLoading: boolean
│  ├─ error: string | null
│  ├─ current: string | null (当前地址)
│  └─ 函数:
│     ├─ connectWallet()
│     ├─ selectAccount()
│     ├─ signAndSend()
│     └─ sendViaForwarder()
│
├─ GovernanceUiProvider Context
│  ├─ expertMode: boolean (专家模式开关)
│  └─ toggleExpertMode()
│
├─ SessionManager (单例)
│  ├─ currentSession: SessionData
│  ├─ expiresAt: number
│  ├─ deviceFingerprint: string
│  └─ lastActivity: number
│
├─ KeyStore (localStorage + IndexedDB)
│  ├─ mp.keystore (加密的助记词)
│  ├─ mp.current (当前地址)
│  ├─ offeringsOrders (购买记录)
│  └─ chat.* (聊天缓存)
│
└─ 本地 Component State
   ├─ UI 状态 (modals, drawers, tabs)
   ├─ 表单数据 (inputs, selections)
   └─ 加载状态 (loading, error)
```

### 4.2 存储层分层

```
优先级    存储方式           用途                 生命周期
────────────────────────────────────────────────────────
  1      内存 (setState)     页面 UI 状态          页面会话
  2      SessionStorage      临时工作数据          浏览器会话
  3      localStorage        用户偏好、缓存        永久
  4      IndexedDB          大文件、消息历史       永久
  5      IPFS               内容存储              永久 (链接指向)
  6      区块链             关键数据、交易记录    永久 (不可篡改)
```

---

## 5. 关键页面流量分析

### 5.1 GraveDetailPage 数据流

```
用户导航到 #/grave/detail?id=123
│
▼
┌─────────────────────────────────────┐
│ GraveDetailPage 组件加载            │
└─────────────────┬───────────────────┘
                  │
    ┌─────────────┼─────────────┐
    │             │             │
    ▼             ▼             ▼
┌────────┐  ┌───────────┐  ┌──────────────┐
│查询墓地 │  │查询逝者列 │  │查询相册&媒体 │
│信息    │  │表         │  │              │
└────┬───┘  └─────┬─────┘  └──────┬───────┘
     │            │               │
     └────────┬───┴───────────┬───┘
              │               │
         localStorage      索引化    
         缓存检查          逐条查询
              │               │
              └───────┬───────┘
                      ▼
         ┌────────────────────────────┐
         │ 构建 UI 数据结构           │
         │ - deceased array           │
         │ - albums object            │
         │ - messages array           │
         │ - cover & main image CID   │
         └────────┬───────────────────┘
                  ▼
         ┌────────────────────────────┐
         │ 渲染 Tabs                  │
         │ - 逝者信息                 │
         │ - 相册                     │
         │ - 视频                     │
         │ - 文章                     │
         │ - 留言                     │
         └────────────────────────────┘
```

---

## 6. 性能优化架构

### 6.1 代码分割策略

```
npm run build 输出
│
├─ dist/
│  ├─ index.html                  (入口页面)
│  │
│  └─ assets/
│     │
│     ├─ vendor chunk
│     │  ├─ react-xxxxxx.js       (React 库, ~200KB)
│     │  ├─ antd-xxxxxx.js        (Ant Design, ~400KB)
│     │  └─ substrate-xxx.js      (Polkadot API, ~300KB)
│     │
│     ├─ route chunks
│     │  ├─ grave-xxxxx.js        (纪念馆模块)
│     │  ├─ otc-xxxxx.js          (OTC模块)
│     │  ├─ chat-xxxxx.js         (聊天模块)
│     │  └─ ...
│     │
│     ├─ main-xxxxx.js            (主应用逻辑)
│     └─ style-xxxxx.css          (全局样式)
```

### 6.2 缓存策略

```
用户操作                  缓存机制                    失效条件
─────────────────────────────────────────────────────────
浏览纪念馆                localStorage               用户清空
查看聊天历史              IndexedDB + localStorage  30 天无访问
查询账户余额              内存缓存 (60s)             60秒过期
读取交易记录              localStorage               手动清除
IPFS 文件                 浏览器 HTTP 缓存          浏览器清空
```

---

## 7. 安全架构

### 7.1 密钥保护流程

```
用户创建钱包
│
▼
┌─────────────────────────────────┐
│ 生成助记词 (mnemonicGenerate)   │
│ 12-24 个英文单词                │
└────────────┬────────────────────┘
             ▼
┌─────────────────────────────────┐
│ 用户设置密码 (SetPasswordPage)  │
└────────────┬────────────────────┘
             ▼
┌──────────────────────────────────┐
│ PBKDF2 密钥推导 (210,000 轮)    │
│ - 使用密码                       │
│ - 生成 16 字节 salt              │
│ - 生成 256-bit 密钥              │
└────────────┬─────────────────────┘
             ▼
┌──────────────────────────────────┐
│ AES-GCM 加密                    │
│ - 输入: 助记词                   │
│ - 密钥: 上面生成的密钥           │
│ - IV: 随机 12 字节               │
│ - 输出: 密文                     │
└────────────┬─────────────────────┘
             ▼
┌──────────────────────────────────┐
│ Base64 编码                      │
│ - 密文、salt、IV 都编码          │
└────────────┬─────────────────────┘
             ▼
┌──────────────────────────────────┐
│ localStorage 存储                │
│ JSON: {                          │
│   address: "xxx",               │
│   ciphertext: "...",            │
│   salt: "...",                  │
│   iv: "...",                    │
│   createdAt: timestamp          │
│ }                               │
└──────────────────────────────────┘
```

### 7.2 会话安全

```
登录
│
▼
┌────────────────────────────────────┐
│ SessionManager.init()              │
├────────────────────────────────────┤
│ 1. 生成设备指纹                    │
│    - userAgent                     │
│    - 屏幕分辨率                    │
│    - 时区                          │
│    - 其他设备特征                  │
│                                    │
│ 2. 检查现有会话                    │
│    - 是否过期 (24小时)             │
│    - 设备是否变更                  │
│    - 最后活动时间                  │
│                                    │
│ 3. 异常检测                        │
│    - 设备指纹匹配                  │
│    - 不合理的活动跳跃              │
│                                    │
│ 4. 创建新会话                      │
│    - sessionId (随机)              │
│    - address (用户地址)            │
│    - expiresAt (24小时后)          │
│    - deviceFingerprint             │
│    - lastActivity (当前时间)       │
└────────────┬───────────────────────┘
             ▼
┌────────────────────────────────────┐
│ SecureStorage 加密保存             │
│ (加密后存储于 localStorage)        │
└────────────────────────────────────┘
```

---

## 8. 网络请求流程

### 8.1 开发环境代理配置

```
浏览器请求
│
├─ WebSocket
│  └─ ws://127.0.0.1:9944
│     (直连 Substrate 节点)
│
├─ HTTP 请求 /api/*
│  └─ Vite 代理
│     └─ http://111.170.145.41/api/...
│
├─ HTTP 请求 /mapi.php
│  └─ Vite 代理 + 认证头
│     ├─ Authorization: Bearer <token>
│     ├─ X-Timestamp: <unix-timestamp>
│     ├─ X-Nonce: <random-string>
│     └─ http://111.170.145.41/mapi.php
│
└─ HTTP 请求 /epay
   └─ Vite 代理
      └─ http://111.170.145.41/epay/...
```

### 8.2 生产环境配置

```
环境变量                          默认值
─────────────────────────────────────────────
VITE_WS                          ws://127.0.0.1:9944
VITE_FORWARD_API                 http://127.0.0.1:8787/forward
VITE_EPAY_API_TOKEN              <从密钥管理获取>

生产环境建议:
VITE_WS=wss://mainnet-node.example.com:9944
VITE_EPAY_API_TOKEN=<secure-token-from-vault>
```

---

## 9. 业务流程示例

### 9.1 创建供奉订单流程

```
用户进入 OfferingsCatalog
  │
  ├─ 选择供奉品 (sacrificeId)
  │
  ├─ 输入信息
  │ ├─ 目标 (graveId, deceasedId)
  │ ├─ 数量 (duration 如果是按时间计费)
  │ ├─ 是否 VIP
  │ └─ 备注 (who)
  │
  ▼
┌────────────────────────────────────┐
│ 提交交易                           │
│ memorialService.createOffering()   │
└─────────┬──────────────────────────┘
          │
          ▼
  ┌────────────────────────────┐
  │ 构建交易                   │
  │ api.tx.memo_offerings      │
  │   .create_offering({...})  │
  └─────────┬──────────────────┘
            │
            ▼
  ┌────────────────────────────┐
  │ 签名交易                   │
  │ signAndSendLocal()         │
  │ (使用本地 keystore)        │
  └─────────┬──────────────────┘
            │
            ▼
  ┌────────────────────────────┐
  │ 发送到链上                 │
  │ WebSocket → Substrate      │
  └─────────┬──────────────────┘
            │
            ▼
  ┌────────────────────────────┐
  │ 获取 txHash                │
  │ 显示确认                   │
  └─────────┬──────────────────┘
            │
            ▼
  ┌────────────────────────────┐
  │ 链上处理                   │
  │ - 扣除用户余额             │
  │ - 触发 affiliate hooks      │
  │ - 调用 pallet-affiliate    │
  │ - 记录供奉历史             │
  └─────────┬──────────────────┘
            │
            ▼
  ┌────────────────────────────┐
  │ 返回结果                   │
  │ - 订单ID                   │
  │ - 确认状态                 │
  └─────────┬──────────────────┘
            │
            ▼
  ┌────────────────────────────┐
  │ UI 更新                    │
  │ - 显示成功消息             │
  │ - 刷新订单列表             │
  │ - 更新账户余额             │
  │ - 保存到 localStorage      │
  └────────────────────────────┘
```

### 9.2 聊天消息发送流程

```
用户在 ChatWindow 输入消息
  │
  ├─ 输入: "你好"
  ├─ 接收方: userB
  │
  ▼
┌────────────────────────────────────┐
│ 消息预处理                         │
│ - 去除首尾空白                     │
│ - 检查长度限制                     │
│ - 提取提及用户                     │
└─────────┬──────────────────────────┘
          │
          ▼
┌────────────────────────────────────┐
│ 端到端加密                         │
│ 使用 userB 的公钥加密              │
│ (如支持, 否则明文)                 │
└─────────┬──────────────────────────┘
          │
          ▼
  ├─ 包含文件?
  │ ├─ 是 → IPFS 上传, 获取 CID
  │ └─ 否 → 直接使用消息内容
  │
  ▼
┌────────────────────────────────────┐
│ 构建链上消息                       │
│ {                                  │
│   to: userB,                      │
│   content_cid: "Qm...",           │
│   encrypted: true,                │
│   timestamp: now,                 │
│   file_cid: "Qm..." (可选)        │
│ }                                 │
└─────────┬──────────────────────────┘
          │
          ▼
┌────────────────────────────────────┐
│ 签名并发送                         │
│ signAndSendLocal()                 │
│ → pallet-chat::send_message()      │
└─────────┬──────────────────────────┘
          │
          ▼
┌────────────────────────────────────┐
│ 链上确认                           │
│ - 扣除燃料费                       │
│ - 存储消息记录                     │
│ - 触发事件通知                     │
└─────────┬──────────────────────────┘
          │
          ▼
┌────────────────────────────────────┐
│ 本地缓存                           │
│ - IndexedDB 存储消息               │
│ - localStorage 更新时间戳          │
│ - chat-cache.ts 管理               │
└─────────┬──────────────────────────┘
          │
          ▼
┌────────────────────────────────────┐
│ 接收方同步                         │
│ - 定期轮询 pallet-chat            │
│ - 解密并显示                       │
│ - 更新聊天列表                     │
└────────────────────────────────────┘
```

---

## 10. 部署拓扑

### 10.1 开发环境

```
开发者机器
│
├─ npm run dev
│  └─ Vite Dev Server (http://localhost:5173)
│
├─ Substrate 节点 (./target/release/solochain-template-node --dev)
│  └─ WebSocket (ws://127.0.0.1:9944)
│
├─ IPFS 节点 (ipfs daemon)
│  └─ HTTP API (http://127.0.0.1:5001)
│
└─ 可选: 后端服务
   └─ 代付服务 (http://127.0.0.1:8787)
```

### 10.2 生产环境

```
CDN (静态资源)
│
├─ dist/index.html
├─ dist/assets/*.js
└─ dist/assets/*.css

用户浏览器
│
├─ 加载应用
│
├─ 连接 Substrate 节点 (wss://mainnet-node.example.com:9944)
│
├─ 使用公共 IPFS 网关 (https://gateway.ipfs.io)
│
└─ 支付接口 (生产环境)
   └─ https://payment.example.com/api/...
```

---

**总结**: 这份架构文档提供了 Stardust DApp 的详细架构视图、数据流、依赖关系和流程图。结合主报告中的代码质量分析，可以全面理解项目的设计和实现。

