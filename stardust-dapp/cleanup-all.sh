#!/bin/bash

# ===================================================================
# å‰ç«¯å†—ä½™ä»£ç ä¸€é”®æ¸…ç†è„šæœ¬
# 
# åŠŸèƒ½ï¼šè‡ªåŠ¨æ‰§è¡Œæ‰€æœ‰å†—ä½™ä»£ç æ¸…ç†ä»»åŠ¡
# ä½œè€…ï¼šStardust å¼€å‘å›¢é˜Ÿ
# æ—¥æœŸï¼š2025-11-02
# ===================================================================

set -e

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸ§¹ Stardust å‰ç«¯å†—ä½™ä»£ç ä¸€é”®æ¸…ç†å·¥å…·"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# æ£€æŸ¥æ˜¯å¦åœ¨æ­£ç¡®çš„ç›®å½•
if [ ! -d "src" ]; then
    echo "âŒ é”™è¯¯ï¼šè¯·åœ¨ stardust-dapp æ ¹ç›®å½•ä¸‹è¿è¡Œæ­¤è„šæœ¬"
    exit 1
fi

# å®‰å…¨ç¡®è®¤
echo "âš ï¸  è­¦å‘Šï¼šæ­¤è„šæœ¬å°†æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š"
echo ""
echo "   1. ä¿®å¤æ‰€æœ‰æ—§ Pallet API è°ƒç”¨"
echo "   2. åˆ é™¤å†—ä½™çš„ deceasedMedia æ¨¡å—"
echo "   3. æ•´ç†æ–‡æ¡£åˆ° docs/archived/"
echo "   4. æäº¤æ‰€æœ‰æ›´æ”¹åˆ° Git"
echo ""
echo "ğŸ“‹ å»ºè®®å…ˆå¤‡ä»½æˆ–åˆ›å»ºæ–°åˆ†æ”¯ï¼š"
echo "   git checkout -b cleanup/frontend-redundancy"
echo ""
read -p "ç¡®è®¤æ‰§è¡Œï¼Ÿ(yes/NO) " -r CONFIRM
echo

if [ "$CONFIRM" != "yes" ]; then
    echo "âŒ å·²å–æ¶ˆ"
    exit 0
fi

echo ""
echo "ğŸš€ å¼€å§‹æ¸…ç†..."
echo ""

# ===================================================================
# Step 1: ä¿®å¤ API è°ƒç”¨
# ===================================================================
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸ“Œ Step 1/4: ä¿®å¤ Pallet API è°ƒç”¨"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

if [ -f "fix-pallet-api.sh" ]; then
    bash fix-pallet-api.sh
else
    echo "âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ° fix-pallet-api.sh"
    exit 1
fi

echo ""
echo "âœ… Step 1 å®Œæˆ"
echo ""
sleep 1

# ===================================================================
# Step 2: åˆ é™¤å†—ä½™æ¨¡å—
# ===================================================================
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸ“Œ Step 2/4: åˆ é™¤å†—ä½™æ¨¡å—"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# æ£€æŸ¥æ˜¯å¦å­˜åœ¨ deceasedMedia æ¨¡å—
if [ -d "src/features/deceasedMedia" ]; then
    echo "ğŸ—‘ï¸  åˆ é™¤ deceasedMedia æ¨¡å—..."
    
    # å…ˆæ£€æŸ¥æ˜¯å¦è¢«å…¶ä»–æ–‡ä»¶å¼•ç”¨
    REFS=$(grep -r "from.*deceasedMedia\|import.*deceasedMedia" src/ \
        --include="*.ts" --include="*.tsx" \
        --exclude-dir=deceasedMedia 2>/dev/null | wc -l || echo 0)
    
    if [ "$REFS" -gt 0 ]; then
        echo "âš ï¸  è­¦å‘Šï¼šå‘ç° $REFS å¤„å¯¹ deceasedMedia çš„å¼•ç”¨"
        echo "   è¯·æ‰‹åŠ¨æ£€æŸ¥å¹¶åˆ é™¤è¿™äº›å¼•ç”¨åå†è¿è¡Œæ­¤è„šæœ¬"
        grep -r "from.*deceasedMedia\|import.*deceasedMedia" src/ \
            --include="*.ts" --include="*.tsx" \
            --exclude-dir=deceasedMedia
        exit 1
    fi
    
    # å®‰å…¨åˆ é™¤
    rm -rf src/features/deceasedMedia
    echo "   âœ… å·²åˆ é™¤ src/features/deceasedMedia/"
else
    echo "   âœ“ deceasedMedia æ¨¡å—ä¸å­˜åœ¨ï¼Œè·³è¿‡"
fi

echo ""
echo "âœ… Step 2 å®Œæˆ"
echo ""
sleep 1

# ===================================================================
# Step 3: æ•´ç†æ–‡æ¡£
# ===================================================================
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸ“Œ Step 3/4: æ•´ç†æ–‡æ¡£"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# åˆ›å»º archived ç›®å½•
mkdir -p docs/archived

# ç§»åŠ¨æ ¹ç›®å½•ä¸‹çš„ .md æ–‡ä»¶ï¼ˆä¿ç•™ README.mdï¼‰
MD_COUNT=0
for file in *.md; do
    if [ -f "$file" ] && [ "$file" != "README.md" ]; then
        mv "$file" docs/archived/
        MD_COUNT=$((MD_COUNT + 1))
        echo "   ğŸ“„ $file â†’ docs/archived/"
    fi
done

if [ $MD_COUNT -gt 0 ]; then
    echo ""
    echo "   âœ… å·²æ•´ç† $MD_COUNT ä¸ªæ–‡æ¡£åˆ° docs/archived/"
else
    echo "   âœ“ æ— éœ€æ•´ç†æ–‡æ¡£"
fi

echo ""
echo "âœ… Step 3 å®Œæˆ"
echo ""
sleep 1

# ===================================================================
# Step 4: Git æäº¤
# ===================================================================
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸ“Œ Step 4/4: æäº¤æ›´æ”¹"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
if git diff --quiet; then
    echo "   âœ“ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
else
    echo "ğŸ“ å‡†å¤‡æäº¤æ›´æ”¹..."
    
    # æ˜¾ç¤ºæ›´æ”¹æ‘˜è¦
    echo ""
    echo "æ›´æ”¹æ‘˜è¦ï¼š"
    git status --short
    echo ""
    
    # æ·»åŠ æ‰€æœ‰æ›´æ”¹
    git add .
    
    # æäº¤
    git commit -m "chore: å‰ç«¯å†—ä½™ä»£ç æ¸…ç†

- fix: ä¿®å¤ Pallet API è°ƒç”¨ï¼ˆé€‚é…é“¾ç«¯æ•´åˆï¼‰
  â€¢ marketMaker/otcOrder/simpleBridge â†’ trading
  â€¢ memoOfferings/memoSacrifice â†’ memorial
  â€¢ deceasedMedia/deceasedText â†’ deceased
  â€¢ affiliateWeekly/Config/Instant â†’ affiliate
  
- chore: åˆ é™¤å†—ä½™çš„ deceasedMedia æ¨¡å— (434 è¡Œ)
  â€¢ åŠŸèƒ½å·²ç”± deceased æ¨¡å—å®Œå…¨æ›¿ä»£
  â€¢ æœªåœ¨è·¯ç”±è¡¨ä¸­æ³¨å†Œ
  
- chore: æ•´ç†æ–‡æ¡£åˆ° docs/archived/ ($MD_COUNT ä¸ªæ–‡ä»¶)

å‚è€ƒï¼šdocs/stardust-dapp-å†—ä½™ä»£ç åˆ†ææŠ¥å‘Š.md
"
    
    echo "   âœ… å·²æäº¤æ›´æ”¹"
fi

echo ""
echo "âœ… Step 4 å®Œæˆ"
echo ""

# ===================================================================
# å®Œæˆæ€»ç»“
# ===================================================================
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  ğŸ‰ æ¸…ç†å®Œæˆï¼"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "ğŸ“Š æ¸…ç†ç»Ÿè®¡ï¼š"

# ç»Ÿè®¡ä¿®æ”¹çš„æ–‡ä»¶æ•°
MODIFIED=$(git diff HEAD~1 --name-only 2>/dev/null | wc -l || echo 0)
echo "   - ä¿®æ”¹æ–‡ä»¶: $MODIFIED ä¸ª"

# ç»Ÿè®¡åˆ é™¤çš„ä»£ç è¡Œæ•°
DELETED=$(git diff HEAD~1 --shortstat 2>/dev/null | \
    grep -oP '\d+(?= deletion)' || echo 0)
echo "   - åˆ é™¤ä»£ç : $DELETED è¡Œ"

# ç»Ÿè®¡æ•´ç†çš„æ–‡æ¡£æ•°
echo "   - æ•´ç†æ–‡æ¡£: $MD_COUNT ä¸ª"

echo ""
echo "ğŸ“‹ åç»­æ­¥éª¤ï¼š"
echo ""
echo "   1. å¯åŠ¨å¼€å‘æœåŠ¡å™¨æµ‹è¯•ï¼š"
echo "      npm run dev"
echo ""
echo "   2. æµ‹è¯•å…³é”®åŠŸèƒ½ï¼š"
echo "      â€¢ åšå¸‚å•†ç”³è¯· (#/otc/mm-apply)"
echo "      â€¢ OTC è®¢å•åˆ›å»º (#/otc/order)"
echo "      â€¢ å…è´¹é…é¢æŸ¥è¯¢"
echo "      â€¢ æ¡¥æ¥æœåŠ¡ (#/bridge/simple)"
echo "      â€¢ ä¾›å¥‰åŠŸèƒ½ (#/grave/detail)"
echo ""
echo "   3. å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œæ¨é€åˆ°è¿œç¨‹ï¼š"
echo "      git push origin cleanup/frontend-redundancy"
echo ""
echo "   4. å¦‚æœå‘ç°é—®é¢˜ï¼Œå¿«é€Ÿå›æ»šï¼š"
echo "      git reset --hard HEAD~1"
echo ""
echo "ğŸ“– è¯¦ç»†åˆ†ææŠ¥å‘Šï¼š"
echo "   docs/stardust-dapp-å†—ä½™ä»£ç åˆ†ææŠ¥å‘Š.md"
echo ""
echo "âœ¨ æ„Ÿè°¢ä½¿ç”¨ Stardust æ¸…ç†å·¥å…·ï¼"
echo ""

