# æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°åŠŸèƒ½è¯´æ˜

## âœ… åŠŸèƒ½å·²æ·»åŠ 

åœ¨åšå¸‚å•†ç”³è¯·é¡µé¢ï¼ˆ`http://127.0.0.1:5173/#/otc/mm-apply`ï¼‰å³ä¸Šè§’æ·»åŠ äº†**"æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°"**æŒ‰é’®ã€‚

---

## ğŸ¯ åŠŸèƒ½è¯´æ˜

### ä»€ä¹ˆæ—¶å€™ä½¿ç”¨ï¼Ÿ

å½“ä½ é‡åˆ°ä»¥ä¸‹æƒ…å†µæ—¶ï¼Œå¯ä»¥ç‚¹å‡»"æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°"æŒ‰é’®ï¼š

1. **é¡µé¢æ˜¾ç¤ºçš„æ•°æ®ä¸é“¾ä¸Šå®é™…æ•°æ®ä¸ä¸€è‡´**
2. **ç”³è¯·çŠ¶æ€å¡ä½ï¼Œæ— æ³•ç»§ç»­**
3. **åˆ‡æ¢äº†é’±åŒ…è´¦æˆ·ï¼Œä½†é¡µé¢è¿˜æ˜¾ç¤ºæ—§è´¦æˆ·çš„æ•°æ®**
4. **æƒ³ä»å¤´å¼€å§‹é‡æ–°ç”³è¯·**
5. **é“¾ç«¯é‡æ–°ç¼–è¯‘åï¼Œéœ€è¦åˆ·æ–°é¡µé¢æ•°æ®**

---

## ğŸ”§ åŠŸèƒ½è¯¦æƒ…

### æ‰§è¡Œçš„æ“ä½œ

ç‚¹å‡»"æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°"æŒ‰é’®åï¼Œç³»ç»Ÿä¼šï¼š

1. **æ¸…é™¤ localStorage ç¼“å­˜**
   - æ¸…é™¤ `mm_apply_id`ï¼ˆç”³è¯·IDç¼“å­˜ï¼‰
   - æ¸…é™¤ `mm_apply_deadline`ï¼ˆæˆªæ­¢æ—¶é—´ç¼“å­˜ï¼‰
   - æ¸…é™¤ `mm_apply_step`ï¼ˆå½“å‰æ­¥éª¤ç¼“å­˜ï¼‰

2. **é‡ç½®é¡µé¢çŠ¶æ€**
   - é‡ç½® mmId
   - é‡ç½®æˆªæ­¢æ—¶é—´
   - é‡ç½®å½“å‰æ­¥éª¤ï¼ˆå›åˆ°ç¬¬ä¸€æ­¥ï¼‰
   - æ¸…ç©ºç”³è¯·è¯¦æƒ…
   - æ¸…ç©ºé”™è¯¯ä¿¡æ¯

3. **æ¸…ç©ºè¡¨å•æ•°æ®**
   - æ¸…ç©ºç¬¬ä¸€æ­¥è¡¨å•
   - æ¸…ç©ºç¬¬äºŒæ­¥è¡¨å•

4. **é‡æ–°ä»é“¾ä¸Šæ‹‰å–æœ€æ–°æ•°æ®**
   - æŸ¥è¯¢åšå¸‚å•†é…ç½®
   - æŸ¥è¯¢å½“å‰è´¦æˆ·çš„ç”³è¯·çŠ¶æ€ï¼ˆé€šè¿‡ `ownerIndex`ï¼‰
   - å¦‚æœæ‰¾åˆ°ç”³è¯·ï¼Œè‡ªåŠ¨åŠ è½½ç”³è¯·è¯¦æƒ…
   - æ ¹æ®ç”³è¯·çŠ¶æ€è‡ªåŠ¨è·³è½¬åˆ°å¯¹åº”æ­¥éª¤

---

## ğŸ“‹ ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯ 1ï¼šé“¾ç«¯é‡æ–°ç¼–è¯‘å

```
1. é“¾ç«¯é‡æ–°ç¼–è¯‘å¹¶é‡ç½®
2. è®¿é—®ç”³è¯·é¡µé¢ï¼Œå‘ç°æ˜¾ç¤ºæ—§çš„ mmId
3. ç‚¹å‡»"æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°"
4. âœ… é¡µé¢é‡æ–°ä»é“¾ä¸Šæ‹‰å–æ•°æ®
5. âœ… æ˜¾ç¤º"å½“å‰è´¦æˆ·æ²¡æœ‰å¾…å¤„ç†çš„ç”³è¯·ï¼Œä»å¤´å¼€å§‹"
```

### åœºæ™¯ 2ï¼šé¡µé¢çŠ¶æ€å¡ä½

```
1. å®Œæˆè´¨æŠ¼ï¼Œç”Ÿæˆ mmId = 0
2. é¡µé¢åˆ·æ–°æˆ–å…³é—­åé‡æ–°æ‰“å¼€
3. é¡µé¢å¡åœ¨ç¬¬ä¸€æ­¥ï¼Œæ— æ³•ç»§ç»­
4. ç‚¹å‡»"æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°"
5. âœ… ç³»ç»Ÿé‡æ–°æŸ¥è¯¢é“¾ä¸Šæ•°æ®
6. âœ… è‡ªåŠ¨æ¢å¤åˆ°ç¬¬äºŒæ­¥ï¼šæäº¤èµ„æ–™
```

### åœºæ™¯ 3ï¼šåˆ‡æ¢é’±åŒ…è´¦æˆ·

```
1. ç”¨è´¦æˆ· A å®Œæˆäº†éƒ¨åˆ†ç”³è¯·
2. åˆ‡æ¢åˆ°è´¦æˆ· B
3. é¡µé¢è¿˜æ˜¾ç¤ºè´¦æˆ· A çš„ç”³è¯·æ•°æ®
4. ç‚¹å‡»"æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°"
5. âœ… æ¸…é™¤æ—§è´¦æˆ·çš„ç¼“å­˜
6. âœ… æŸ¥è¯¢è´¦æˆ· B çš„ç”³è¯·çŠ¶æ€
7. âœ… æ˜¾ç¤ºæ­£ç¡®çš„æ•°æ®
```

---

## ğŸ¨ UI ä½ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åšå¸‚å•†ç”³è¯·ï¼ˆä¸¤æ­¥å¼ï¼šå…ˆè´¨æŠ¼ â†’ å†æäº¤èµ„æ–™ï¼‰ â”‚ [ğŸ”„ æ¸…é™¤ç¼“å­˜å¹¶åˆ·æ–°]
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚   ç¬¬ä¸€æ­¥ï¼šè´¨æŠ¼ä¿è¯é‡‘                      â”‚
â”‚   ç¬¬äºŒæ­¥ï¼šæäº¤èµ„æ–™ï¼ˆå¾…å®¡ï¼‰                 â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

æŒ‰é’®ä½äº Card æ ‡é¢˜çš„å³ä¾§ï¼Œä½¿ç”¨é“¾æ¥æ ·å¼ï¼Œä¸ä¼šå¤ªçªå…€ã€‚

---

## ğŸ” æŠ€æœ¯å®ç°

### å‡½æ•°ï¼š`handleClearCacheAndRefresh`

```typescript
/**
 * å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šæ¸…é™¤ç¼“å­˜å¹¶é‡æ–°ä»é“¾ä¸Šæ‹‰å–æ•°æ®
 * - æ¸…é™¤ localStorage ä¸­çš„ç¼“å­˜æ•°æ®
 * - é‡ç½®é¡µé¢çŠ¶æ€
 * - é‡æ–°ä»é“¾ä¸ŠæŸ¥è¯¢æœ€æ–°æ•°æ®
 */
const handleClearCacheAndRefresh = async () => {
  try {
    // 1. æ¸…é™¤ç¼“å­˜
    localStorage.removeItem('mm_apply_id')
    localStorage.removeItem('mm_apply_deadline')
    localStorage.removeItem('mm_apply_step')
    
    // 2. é‡ç½®çŠ¶æ€
    setMmId(null)
    setDeadlineSec(0)
    setCurrent(0)
    setAppDetails(null)
    setError('')
    
    // 3. æ¸…ç©ºè¡¨å•
    form1.resetFields()
    form2.resetFields()
    
    // 4. é‡æ–°åŠ è½½é“¾ä¸Šæ•°æ®
    if (api) {
      await loadMarketMakerConfig()
      
      const currentAddress = localStorage.getItem('mp.current')
      if (currentAddress) {
        // é€šè¿‡ ownerIndex æŸ¥è¯¢çœŸå®çš„ mmId
        const ownerIndexOpt = await api.query.marketMaker.ownerIndex(currentAddress)
        if (ownerIndexOpt.isSome) {
          const realMmId = Number(ownerIndexOpt.unwrap().toString())
          
          // åŠ è½½ç”³è¯·è¯¦æƒ…
          await loadApplicationDetails(realMmId)
          setMmId(realMmId)
          
          // æ ¹æ®çŠ¶æ€åˆ¤æ–­å½“å‰æ­¥éª¤
          if (appDetails && appDetails.status === 'DepositLocked') {
            setCurrent(1) // è·³åˆ°ç¬¬äºŒæ­¥
          }
        }
      }
    }
  } catch (e) {
    message.error('æ¸…é™¤ç¼“å­˜å¤±è´¥ï¼š' + e.message)
  }
}
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **åªæ¸…é™¤é¡µé¢ç¼“å­˜ï¼Œä¸å½±å“é“¾ä¸Šæ•°æ®**
   - ä½ çš„ç”³è¯·ã€ä¿è¯é‡‘ç­‰æ•°æ®éƒ½åœ¨é“¾ä¸Šï¼Œä¸ä¼šè¢«æ¸…é™¤
   - åªæ˜¯æ¸…é™¤äº†æµè§ˆå™¨ä¸­çš„ä¸´æ—¶ç¼“å­˜

2. **è¡¨å•æ•°æ®ä¼šè¢«æ¸…ç©º**
   - å¦‚æœä½ æ­£åœ¨å¡«å†™è¡¨å•ä½†æœªæäº¤ï¼Œç‚¹å‡»æ­¤æŒ‰é’®ä¼šæ¸…ç©ºè¡¨å•æ•°æ®
   - å»ºè®®åœ¨æäº¤è¡¨å•åæˆ–é‡åˆ°é—®é¢˜æ—¶ä½¿ç”¨

3. **è‡ªåŠ¨æ¢å¤æœºåˆ¶**
   - æ¸…é™¤ç¼“å­˜åï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä»é“¾ä¸ŠæŸ¥è¯¢ä½ çš„ç”³è¯·çŠ¶æ€
   - å¦‚æœæœ‰å¾…å¤„ç†çš„ç”³è¯·ï¼Œä¼šè‡ªåŠ¨æ¢å¤åˆ°å¯¹åº”æ­¥éª¤
   - å¦‚æœæ²¡æœ‰ç”³è¯·ï¼Œä¼šä»ç¬¬ä¸€æ­¥å¼€å§‹

---

## ğŸ‰ æ€»ç»“

- âœ… ä½ç½®ï¼šå¡ç‰‡æ ‡é¢˜å³ä¾§
- âœ… å›¾æ ‡ï¼šğŸ”„ åˆ·æ–°å›¾æ ‡
- âœ… æ ·å¼ï¼šé“¾æ¥æŒ‰é’®ï¼ˆä¸çªå…€ï¼‰
- âœ… åŠŸèƒ½ï¼šæ¸…é™¤ç¼“å­˜ + é‡æ–°æ‹‰å–é“¾ä¸Šæ•°æ®
- âœ… å®‰å…¨ï¼šåªæ¸…é™¤æµè§ˆå™¨ç¼“å­˜ï¼Œä¸å½±å“é“¾ä¸Šæ•°æ®

**ç°åœ¨ä½ å¯ä»¥æ”¾å¿ƒåœ°ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½æ¥è§£å†³é¡µé¢æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼**

---

**ç‰ˆæœ¬**: v1.5.0  
**æ·»åŠ æ—¥æœŸ**: 2025-10-15  
**ç›¸å…³æ–‡ä»¶**: `src/features/otc/CreateMarketMakerPage.tsx`

