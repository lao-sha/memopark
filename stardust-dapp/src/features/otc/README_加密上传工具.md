# 做市商私密文件加密上传工具使用说明

## 概述

在做市商申请页面（`http://localhost:5173/#/otc/mm-apply`）的步骤2，现在集成了**文件加密上传工具**，允许用户直接在浏览器中加密私密文件并上传到 IPFS。

## 功能特性

✅ **浏览器端加密**：使用 Web Crypto API，数据不离开浏览器  
✅ **AES-256-GCM**：军事级加密算法，安全可靠  
✅ **PBKDF2 密钥派生**：100,000 次迭代，防止暴力破解  
✅ **自动填充 CID**：上传完成后自动填充到表单  
✅ **多文件支持**：一次加密多个文件  
✅ **Manifest 清单**：自动生成文件清单，方便审核  

## 使用流程

### 步骤 1：准备文件

准备需要加密的私密文件：
- 📄 营业执照（PDF）
- 🆔 身份证明（PDF/图片）
- 💰 资金证明（PDF）
- 📞 联系方式（JSON/文本）

### 步骤 2：打开工具

在做市商申请页面的步骤2，点击**"🔐 私密文件加密上传工具（点击展开）"**

### 步骤 3：选择文件

1. 点击"选择文件"按钮
2. 选择一个或多个需要加密的文件
3. 查看文件列表确认

### 步骤 4：设置密码

1. 在"设置加密密码"输入框中输入强密码
2. 密码建议：
   - 至少 12 位
   - 包含大小写字母、数字、符号
   - 使用密码管理器生成
   - 示例：`Abc123!@#XyzMemoMarket2025`

⚠️ **重要**：请妥善保管此密码，委员会审核时需要使用！

### 步骤 5：加密文件

1. 点击"加密文件"按钮
2. 等待加密完成（进度条显示 0% → 50%）
3. 查看"已加密文件"列表确认

### 步骤 6：上传到 IPFS

1. 点击"上传到 IPFS"按钮
2. 等待上传完成（进度条显示 50% → 100%）
3. 获取私密资料根 CID

### 步骤 7：提交申请

1. 生成的 CID 会自动填充到"私密资料根 CID"字段
2. 填写其他必需字段（公开 CID、费率、最小下单额）
3. 点击"提交资料"或"更新资料"

## 技术细节

### 加密算法

```
算法：AES-256-GCM
密钥派生：PBKDF2 (100,000 iterations)
哈希函数：SHA-256
盐值长度：16 字节（随机生成）
IV 长度：12 字节（随机生成）
```

### 加密文件结构

```
加密文件 = 盐值(16字节) + IV(12字节) + 加密数据
```

### Manifest 清单格式

```json
{
  "version": "1.0",
  "encrypted": true,
  "algorithm": "AES-256-GCM",
  "iterations": 100000,
  "files": [
    {
      "name": "license.pdf.enc",
      "original_name": "营业执照.pdf",
      "type": "business_license",
      "size": 123456,
      "encrypted_at": "2025-10-06T10:00:00Z"
    }
  ],
  "note": "委员会审核时需使用共享密钥解密"
}
```

## 委员会解密流程

委员会成员可以使用以下方式解密文件：

### 方式一：使用 OpenSSL（命令行）

```bash
# 1. 从 IPFS 下载加密文件
ipfs get <CID>

# 2. 解密文件（需要申请人提供的密码）
# 注意：浏览器端使用的是 Web Crypto API（原生格式），
# 需要专门的工具解密，或使用配套的解密页面
```

### 方式二：使用解密页面（推荐）

项目会提供专门的解密页面，委员会成员只需：
1. 输入 CID
2. 输入密码
3. 自动解密并显示文件

## 安全建议

### 对申请人

1. **密码管理**
   - 使用密码管理器生成和保存密码
   - 不要在公共场所输入密码
   - 通过加密通道（如加密邮件）分享给委员会

2. **文件准备**
   - 确保文件格式正确（PDF、图片等）
   - 确保文件内容清晰可读
   - 文件大小控制在合理范围（< 10MB）

3. **验证上传**
   - 记录生成的 CID
   - 验证 CID 是否正确填充到表单
   - 保存密码备份

### 对委员会

1. **密码获取**
   - 通过安全渠道接收密码
   - 不要在公共平台分享密码
   - 审核完成后安全删除密码

2. **文件处理**
   - 解密后的文件不要外传
   - 审核完成后安全删除本地文件
   - 严格保密申请人信息

## 常见问题

### Q1: 上传失败怎么办？

**A**: 当前版本使用模拟上传（TODO），实际项目需要集成真实的 IPFS 节点。如果失败：
1. 检查网络连接
2. 检查 IPFS 节点是否运行
3. 检查文件大小是否过大

### Q2: 忘记密码怎么办？

**A**: 加密密码无法找回！如果忘记密码：
1. 重新加密文件
2. 上传新的 CID
3. 使用"更新资料"功能替换旧 CID

### Q3: 可以修改密码吗？

**A**: 不能直接修改密码。如需更换：
1. 使用新密码重新加密文件
2. 上传获取新 CID
3. 更新申请资料中的 CID

### Q4: 如何验证加密是否成功？

**A**: 查看"已加密文件"列表：
- 文件名变为 `.enc` 后缀
- 显示"已加密"绿色标签
- 文件大小略有增加（增加了盐值和 IV）

### Q5: 支持哪些文件格式？

**A**: 支持所有文件格式：
- 文档：PDF、DOC、DOCX、TXT
- 图片：JPG、PNG、GIF、BMP
- 数据：JSON、XML、CSV
- 其他：任何二进制文件

## 后续优化计划

- [ ] 集成真实 IPFS 节点（替换模拟上传）
- [ ] 添加文件大小限制和验证
- [ ] 支持拖拽上传
- [ ] 添加加密进度显示
- [ ] 提供解密工具页面
- [ ] 支持文件预览
- [ ] 批量操作优化
- [ ] 上传历史记录

## 技术支持

如有问题，请联系技术团队或查看源代码：
- 加密组件：`stardust-dapp/src/components/FileEncryptUpload.tsx`
- 申请页面：`stardust-dapp/src/features/otc/CreateMarketMakerPage.tsx`

