# 金额格式化组件使用说明

## 概述

本次更新实现了统一的金额处理和显示系统，解决了DUST/USDT金额缩放、汇率显示和动态押金计算问题。

## 🚀 主要改进

### 1. 统一的金额格式化组件
- **位置**: `src/components/common/AmountFormatter.tsx`
- **功能**:
  - 自动处理DUST链上值（除以1e12）转换为显示值
  - 自动处理汇率值（除以1e6）转换为实际汇率
  - 支持多种显示模式（DUST only、USDT only、双币种、自动选择）
  - 支持加载状态和错误处理

### 2. 汇率查询Hook
- **位置**: `src/hooks/useExchangeRate.ts`
- **功能**:
  - 从链上查询实时汇率
  - 自动缓存和定期更新
  - 提供DUST↔USDT双向转换
  - 错误处理和默认值fallback

### 3. 押金计算Hook
- **位置**: `src/hooks/useDepositInfo.ts`
- **功能**:
  - 查询分类修改申请押金（10 USDT等值DUST）
  - 查询创建逝者押金（动态计算）
  - 支持不同内容规模的押金计算
  - 实时汇率转换

### 4. 更新的分类修改申请表单
- **位置**: `src/components/deceased/CategoryChangeRequestForm.tsx`
- **改进**:
  - 使用动态押金计算替代硬编码"10 DUST"
  - 显示USDT和DUST双币种金额
  - 显示实时汇率信息
  - 加载状态和错误处理

## 📝 使用方法

### 基础金额显示

```tsx
import { AmountFormatter, DustAmount, UsdtAmount } from '../components/common/AmountFormatter'

// DUST金额显示（自动处理1e12缩放）
<DustAmount amount="10000000000000" precision={4} strong />
// 输出：10.0000 DUST

// USDT金额显示
<UsdtAmount amount={25} strong />
// 输出：25 USDT

// 完整格式化器
<AmountFormatter
  dustAmount="10000000000000"
  usdtAmount={25}
  exchangeRate={500000} // 链上值，含1e6缩放
  mode="both"
  showRate
  strong
/>
// 输出：10.0000 DUST (25 USDT) [汇率图标]
```

### 汇率查询

```tsx
import { useExchangeRate, useDustToUsdt, useUsdtToDust } from '../hooks/useExchangeRate'

function MyComponent() {
  const { exchangeRate, actualRate, isLoading, refreshRate } = useExchangeRate()

  // actualRate 已经是除以1e6后的真实汇率
  console.log(`1 DUST = ${actualRate} USDT`)

  // DUST转USDT
  const { usdtAmount } = useDustToUsdt("5000000000000") // 5 DUST链上值

  // USDT转DUST
  const { dustAmount } = useUsdtToDust(10) // 10 USDT

  return (
    <div>
      <p>当前汇率: {actualRate?.toFixed(6)} USDT/DUST</p>
      <p>5 DUST = {usdtAmount} USDT</p>
      <p>10 USDT = {dustAmount} DUST(链上值)</p>
    </div>
  )
}
```

### 押金查询

```tsx
import { useCategoryChangeDeposit, useCreateDeceasedDeposit } from '../hooks/useDepositInfo'

function DepositInfo({ account }: { account: string }) {
  // 分类修改申请押金（固定10 USDT等值）
  const { depositInfo: categoryDeposit, isLoading } = useCategoryChangeDeposit()

  // 创建逝者押金（动态计算）
  const { depositInfo: createDeposit } = useCreateDeceasedDeposit(account, 'Medium')

  return (
    <div>
      <p>分类申请押金:
        <AmountFormatter
          dustAmount={categoryDeposit?.dustAmount}
          usdtAmount={categoryDeposit?.usdtAmount}
          mode="both"
          loading={isLoading}
        />
      </p>
      <p>创建逝者押金:
        <AmountFormatter
          dustAmount={createDeposit?.dustAmount}
          usdtAmount={createDeposit?.usdtAmount}
          mode="both"
        />
      </p>
    </div>
  )
}
```

## 🎯 核心设计原则

### 1. 金额缩放处理
- **前端**: 传递整数USDT金额，无需手动缩放
- **后端**: 自动进行1e12 DUST缩放和1e6汇率缩放
- **显示**: 组件自动除以对应缩放因子显示真实值

### 2. 一致性
- 所有DUST金额使用链上原始值传递
- 所有USDT金额使用整数值传递
- 组件内部统一处理缩放转换

### 3. 错误处理
- 查询失败时显示默认值或错误信息
- 网络异常时使用缓存数据
- 加载状态的友好提示

## 🔧 配置说明

### 默认汇率
- 当链上查询失败时，使用默认汇率 0.5 USDT per DUST (rawRate: 500000)

### 缓存策略
- 汇率数据缓存5分钟，每10分钟自动刷新
- 押金数据缓存3分钟，每5分钟自动刷新

### 精度控制
- DUST显示默认4位小数
- USDT显示默认2位小数
- 汇率显示默认6位小数

## 📋 测试页面

运行测试页面查看所有功能：
```tsx
import { AmountFormatterTestPage } from '../components/test'

// 在路由中添加测试页面
<Route path="/test/amount-formatter" component={AmountFormatterTestPage} />
```

## 🐛 已知问题

1. **后端Bug**: `request_category_change`函数当前硬编码10 DUST，应该修改为10 USDT等值
2. **汇率API**: 当前使用模拟的pricing query，需要连接实际的pallet-pricing接口
3. **TypeScript配置**: 项目整体存在一些类型配置问题，不影响运行时功能

## 📚 相关文件

### 新增文件
- `src/components/common/AmountFormatter.tsx` - 金额格式化组件
- `src/components/common/index.ts` - 组件导出
- `src/hooks/useExchangeRate.ts` - 汇率查询Hook
- `src/hooks/useDepositInfo.ts` - 押金查询Hook
- `src/components/test/AmountFormatterTestPage.tsx` - 测试页面
- `src/components/test/index.ts` - 测试组件导出

### 修改文件
- `src/components/deceased/CategoryChangeRequestForm.tsx` - 使用动态押金显示

## 💡 使用建议

1. **统一使用组件**: 项目中所有金额显示都应该使用AmountFormatter相关组件
2. **避免硬编码**: 不要再硬编码金额数值，使用动态查询
3. **错误处理**: 总是处理loading和error状态
4. **性能优化**: 使用enabled参数控制不必要的查询
5. **用户体验**: 合理使用加载状态和汇率信息提示

通过这次更新，前端金额处理系统变得更加统一、准确和用户友好。🎉