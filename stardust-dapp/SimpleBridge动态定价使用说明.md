# Simple Bridge 动态定价功能使用说明

## 概述

Simple Bridge 页面已升级为动态市场定价版本，提供更透明、更公平的 MEMO → USDT 兑换服务。

---

## 主要升级

### ✅ 1. 动态市场均价

**原理**：
- 从 `pallet-pricing` 实时读取市场加权均价
- 综合 OTC 和 Bridge 两个市场的交易数据
- 自动跟踪市场供需变化

**优势**：
- 价格透明：基于链上真实交易数据
- 自动更新：每 10 秒刷新一次
- 公平合理：消除固定汇率的套利空间

---

### ✅ 2. 冷启动保护

**场景**：
- 系统初期，市场交易量不足
- `pallet-pricing` 返回价格为 0

**保护机制**：
- 自动使用备用汇率：0.5 USDT/MEMO
- 页面显示 "冷启动保护" 标签
- 确保用户始终可以兑换

---

### ✅ 3. 实际汇率记录

**功能**：
- 兑换提交时锁定当前市场价格
- 从 `SwapCreated` 事件提取 `price_usdt` 字段
- 在完成页面显示实际使用的汇率

**用户体验**：
- 价格透明：用户知道实际兑换价格
- 避免争议：提交时价格已锁定
- 可追溯：事件中永久记录

---

## 使用流程

### 第1步：查看市场价格

进入页面后，顶部卡片显示：
- **市场均价**：当前 MEMO → USDT 的实时价格
- **数据来源**：OTC + Bridge 加权均价（或"备用汇率"）
- **刷新按钮**：可手动刷新价格

**示例**：
```
市场均价: 0.520000 USDT/MEMO
数据来源: OTC + Bridge 加权均价
```

**冷启动状态**：
```
市场均价: 0.500000 USDT/MEMO
数据来源: 备用汇率
[冷启动保护（使用备用汇率）]
```

---

### 第2步：填写兑换信息

**输入字段**：
1. **MEMO 数量**：
   - 最小 100 MEMO
   - 最大不超过钱包余额
   - 实时计算预估到账金额

2. **波场地址**：
   - 必须以 "T" 开头
   - 长度 34 个字符
   - 示例：`TYASr5UV6HEcXatwdFQfmLVUqQQQMUxHLS`

**兑换预估**：
页面自动显示：
- 当前汇率（基于市场均价）
- 手续费率（0.3%）
- USDT 总额
- 预计到账金额（扣除手续费）

**示例**：
```
兑换 1000 MEMO
当前汇率：0.520000 USDT/MEMO
USDT 总额：520.000000 USDT
手续费：1.560000 USDT (0.3%)
预计到账：518.440000 USDT
```

---

### 第3步：提交兑换

**操作**：
1. 检查信息无误
2. 点击 "立即兑换" 按钮
3. 输入钱包密码
4. 等待交易确认

**价格锁定**：
- 提交时使用当前市场价格
- 价格写入链上，不再变化
- 桥接服务按锁定价格发送 USDT

---

### 第4步：查看结果

**处理中**：
- 显示 "正在处理兑换..." 动画
- 桥接服务正在发送 USDT

**完成**：
- 显示兑换详情：
  - 兑换 ID
  - MEMO 数量
  - **实际汇率**（从事件提取）
  - USDT 到账金额
  - 波场地址

**示例**：
```
兑换 ID: 123
MEMO 数量: 1000 MEMO
实际汇率: 0.520000 USDT/MEMO
USDT 到账: 518.440000 USDT
波场地址: TYASr5UV6...
```

---

## 价格说明

### 市场价格来源

**计算公式**：
```
加权平均价格 = (OTC总USDT + Bridge总USDT) / (OTC总MEMO + Bridge总MEMO)
```

**示例**：
```
OTC 市场:    900,000 MEMO @ 0.52 USDT/MEMO  = 468,000 USDT
Bridge 市场: 100,000 MEMO @ 0.48 USDT/MEMO  =  48,000 USDT
加权平均:    1,000,000 MEMO                = 516,000 USDT
           => 516,000 / 1,000,000 = 0.516 USDT/MEMO
```

**优势**：
- 交易量权重：大交易量市场影响更大
- 反映真实供需：价格基于实际成交
- 防止操控：需要大量资金才能影响价格

---

### 冷启动保护

**触发条件**：
- 市场均价为 0（无交易数据）
- `pallet-pricing` 初始化中

**备用汇率**：
- 0.5 USDT/MEMO
- 与原固定汇率相同
- 仅在必要时使用

**退出条件**：
- 市场累计交易量达到阈值（例如 100,000,000 MEMO）
- 自动切换到市场均价
- 不可逆（单向退出）

---

## 技术细节

### API 调用

**查询市场价格**：
```typescript
const priceData = await api.query.pricing.getMemoMarketPriceWeighted();
const priceU64 = priceData.toNumber();
const priceUsdt = priceU64 / 1e6; // 转换为 USDT/MEMO
```

**提交兑换**：
```typescript
const tx = api.tx.simpleBridge.swap(
    BigInt(memoAmount * 1e12), // MEMO 12位小数
    tronAddress                // TRON 地址字符串
);
```

**事件监听**：
```typescript
if (event.section === 'simpleBridge' && event.method === 'SwapCreated') {
    const id = event.data.id?.toNumber();
    const priceUsdt = event.data.price_usdt?.toNumber();
    const actualRate = priceUsdt / 1e6;
    // 显示实际使用的汇率
}
```

---

### 价格刷新机制

**自动刷新**：
- 每 10 秒查询一次市场价格
- 使用 `setInterval` 定时器
- 组件卸载时清理定时器

**手动刷新**：
- 点击价格卡片的 "刷新" 按钮
- 立即查询最新市场价格
- 显示加载状态

**错误处理**：
- 价格加载失败时显示错误提示
- 自动回退到备用汇率
- 用户可重试

---

## 常见问题

### Q1: 价格会变化吗？

**A**: 是的，市场价格会实时变化。

- 价格基于链上真实交易数据
- 每 10 秒自动刷新一次
- 提交兑换时价格会锁定

**示例**：
```
09:00  市场价格 0.52 USDT/MEMO
09:05  市场价格 0.51 USDT/MEMO（价格下跌）
09:10  用户提交兑换，锁定 0.51 USDT/MEMO
```

---

### Q2: 如何确保价格公平？

**A**: 多重机制保障：

1. **数据来源透明**：
   - 价格来自链上交易数据
   - 可公开审计

2. **加权平均算法**：
   - 考虑交易量权重
   - 反映真实市场供需

3. **价格锁定**：
   - 提交时价格写入链上
   - 事件中永久记录
   - 可追溯验证

4. **冷启动保护**：
   - 初期使用备用汇率
   - 避免价格失真

---

### Q3: 什么时候会使用备用汇率？

**A**: 仅在以下情况：

1. **市场初期**：
   - 累计交易量 < 阈值
   - 市场均价为 0

2. **价格加载失败**：
   - 网络问题
   - `pallet-pricing` 故障

**显示标识**：
- 页面显示 "冷启动保护" 标签
- 数据来源显示 "备用汇率"
- 价格颜色为橙色（警告色）

---

### Q4: 实际到账金额会和预估不同吗？

**A**: 理论上一致，实际可能有微小差异。

**原因**：
1. **价格变化**：
   - 预估时使用当前市场价格
   - 提交时可能已变化
   - 实际使用提交时的价格

2. **精度问题**：
   - 链上精度 10^6（小数点后 6 位）
   - 前端显示可能四舍五入

**查看实际值**：
- 完成页面显示 "实际汇率"
- 基于链上事件的 `price_usdt` 字段
- 是最终准确值

---

### Q5: 如何监控价格变化？

**建议**：
1. 页面停留期间会自动刷新
2. 可手动点击 "刷新" 按钮
3. 提交前确认当前价格
4. 查看完成页面的 "实际汇率"

---

## 故障排查

### 价格加载失败

**症状**：
- 显示错误提示
- 价格显示为 0 或错误值

**解决方案**：
1. 点击 "刷新" 按钮重试
2. 检查网络连接
3. 系统会自动使用备用汇率（0.5 USDT/MEMO）
4. 可以正常兑换

---

### 兑换提交失败

**症状**：
- 提示 "MarketPriceNotAvailable"
- 交易被拒绝

**解决方案**：
1. 检查市场价格是否为 0
2. 确认备用汇率已设置
3. 联系管理员检查 `pallet-pricing` 状态

---

## 升级对比

### 旧版本（固定汇率）

```
优点：
- 简单明了
- 价格固定

缺点：
- 不跟踪市场变化
- 可能存在套利空间
- 需要人工调整
```

### 新版本（动态均价）

```
优点：
- 价格透明（基于真实交易）
- 自动跟踪市场
- 消除套利空间
- 无需人工维护

缺点：
- 价格会变化（但提交时锁定）
- 初期需要冷启动保护
```

---

## 相关文档

- [定价基准价格±20%方案分析](../../docs/定价基准价格±20%方案分析.md)
- [Simple Bridge README](../../pallets/simple-bridge/README.md)
- [pallet-pricing README](../../pallets/pricing/README.md)

---

**文档版本**：v1.0  
**创建日期**：2025-10-19  
**适用版本**：SimpleBridge v2.0.0+  
**作者**：MEMO 技术团队

