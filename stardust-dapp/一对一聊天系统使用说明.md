# 一对一聊天系统使用说明

## 📋 概述

基于 `pallet-chat` 实现的去中心化一对一聊天系统，提供端到端加密的私密通讯功能。

## 🎯 核心特性

### 链上功能（pallet-chat）
- ✅ **私聊功能**：1对1端到端加密通讯
- ✅ **会话管理**：自动创建和管理聊天会话
- ✅ **已读/未读状态**：实时同步消息状态
- ✅ **消息软删除**：用户可删除自己的消息
- ✅ **批量已读**：一键标记会话所有消息为已读
- ✅ **用户资料**：昵称、头像、个性签名
- ✅ **隐私设置**：控制陌生人消息、在线状态显示
- ✅ **黑名单**：拉黑/解除拉黑用户
- ✅ **频率限制**：防止消息轰炸

### 前端功能
- 🎨 **现代化UI设计**：渐变色背景、圆角卡片、流畅动画
- 📱 **移动端优先**：最大宽度480px，完美适配手机
- 💬 **实时通讯**：基于区块链事件的实时消息推送
- 🔍 **搜索功能**：快速搜索联系人
- 📋 **会话列表**：显示所有聊天会话和未读状态
- 💬 **聊天界面**：气泡式消息、已读回执、时间戳
- ⌨️ **智能输入**：支持多行输入、Enter发送、Shift+Enter换行

## 🏗️ 架构设计

### 数据流
```
用户A
  → 加密消息
  → 上传IPFS
  → 获取CID
  → 调用send_message
  → 链上存储元数据
  ↓
触发事件
  ↓
用户B
  ← 解密显示
  ← 下载IPFS
  ← 获取CID
  ← 监听事件
  ← 链上查询元数据
```

### 存储模型
- **链上存储**：消息元数据（发送方、接收方、CID、时间戳等）
- **IPFS存储**：加密的消息内容
- **端到端加密**：前端实现消息加密/解密

## 📝 API 接口

### Extrinsics（交易）

#### 1. 发送消息
```rust
send_message(
  receiver: AccountId,
  content_cid: Vec<u8>,
  msg_type_code: u8,  // 0=文本, 1=图片, 2=文件, 3=语音, 4=系统
  session_id: Option<Hash>
)
```

#### 2. 标记已读
```rust
mark_as_read(msg_id: u64)
mark_batch_as_read(msg_ids: Vec<u64>)
mark_session_as_read(session_id: Hash)
```

#### 3. 消息管理
```rust
delete_message(msg_id: u64)
archive_session(session_id: Hash)
```

#### 4. 用户管理
```rust
block_user(target_user: AccountId)
unblock_user(target_user: AccountId)
```

#### 5. 资料管理
```rust
register_chat_user(nickname: Option<Vec<u8>>)
update_chat_profile(
  nickname: Option<Vec<u8>>,
  avatar_cid: Option<Vec<u8>>,
  signature: Option<Vec<u8>>
)
set_user_status(status_code: u8)  // 0=在线, 1=离线, 2=忙碌, 3=离开, 4=隐身
update_privacy_settings(
  allow_stranger_messages: bool,
  show_online_status: bool,
  show_last_active: bool
)
```

### Queries（查询）

#### 1. 消息查询
```typescript
messages(msgId: u64): MessageMeta
sessionMessages(sessionId: Hash): Vec<u64>
```

#### 2. 会话查询
```typescript
sessions(sessionId: Hash): SessionInfo
userSessions(user: AccountId): Vec<Hash>
unreadCount(user: AccountId, sessionId: Hash): u32
```

#### 3. 用户查询
```typescript
accountToChatUserId(account: AccountId): u64
chatUserProfiles(chatUserId: u64): ChatUserProfile
blacklist(blocker: AccountId, blocked: AccountId): bool
```

### Events（事件）

```typescript
MessageSent { msgId, sessionId, sender, receiver }
MessageRead { msgId, reader }
MessageDeleted { msgId, deleter }
SessionCreated { sessionId, participants }
SessionMarkedAsRead { sessionId, user }
SessionArchived { sessionId, operator }
UserBlocked { blocker, blocked }
UserUnblocked { unblocker, unblocked }
ChatUserCreated { accountId, chatUserId }
ChatUserProfileUpdated { chatUserId }
```

## 💻 前端使用示例

### 1. 发送消息
```typescript
import { createChatService, MessageType } from '../services/chatService'

const chatService = await createChatService()

// 发送文本消息
await chatService.sendMessage(currentUser, {
  receiver: '5Gr...',
  contentCid: 'Qm...',  // 加密后的消息内容CID
  msgType: MessageType.Text,
  sessionId: '0x...'  // 可选，不提供则自动创建
})
```

### 2. 查询会话
```typescript
// 获取用户所有会话
const sessions = await chatService.getUserSessions(currentUser)

// 获取会话消息
const msgIds = await chatService.getSessionMessages(sessionId)
const messages = []
for (const msgId of msgIds) {
  const msg = await chatService.getMessage(msgId)
  if (msg) messages.push(msg)
}
```

### 3. 标记已读
```typescript
// 标记单条消息已读
const tx = chatService.buildMarkAsReadTx(msgId)
await tx.signAndSend(currentUser, { signer })

// 标记整个会话已读
const tx = chatService.buildMarkSessionAsReadTx(sessionId)
await tx.signAndSend(currentUser, { signer })
```

### 4. 监听事件
```typescript
const unsubscribe = chatService.subscribeToChatEvents({
  onMessageSent: (event) => {
    console.log('新消息:', event)
    // 刷新消息列表
  },
  onMessageRead: (event) => {
    console.log('消息已读:', event)
    // 更新已读状态
  }
})

// 清理订阅
return () => unsubscribe()
```

## 🎨 UI 设计

### 颜色方案
- **主色调**：蓝色 → 紫色渐变 (`from-blue-500 to-purple-500`)
- **背景**：淡蓝 → 白色 → 淡紫渐变
- **卡片**：白色，圆角2xl，淡阴影
- **消息气泡**：
  - 发送：蓝紫渐变，白色文字
  - 接收：白色背景，深色文字

### 布局特点
- 最大宽度：480px
- 居中显示
- 圆角设计：8px ~ 24px
- 阴影层次：sm → md → lg
- 毛玻璃效果：backdrop-blur-sm

## 🔒 安全特性

### 1. 访问控制
- ✅ 黑名单检查：被拉黑的用户无法发送消息
- ✅ 陌生人限制：可设置是否允许陌生人发消息
- ✅ 频率限制：防止消息轰炸

### 2. 加密保护
- ✅ CID加密验证：聊天消息的CID必须是加密的
- ✅ 端到端加密：消息内容在IPFS中加密存储
- ✅ 隐私设置：控制在线状态、最后活跃时间显示

### 3. 数据保护
- ✅ 软删除：用户删除消息不影响对方
- ✅ 链上元数据：只存储CID和基本信息
- ✅ IPFS内容：加密的完整消息内容

## 📱 页面路由

- `#/chat` - 一对一聊天主页面
- `#/chat/blocked` - 黑名单管理
- `#/chat/cache` - 缓存管理

## 🚀 后续优化

### 待实现功能
1. **IPFS集成**：实际的消息加密和上传
2. **图片/文件发送**：支持多媒体消息
3. **语音消息**：录音和播放
4. **消息撤回**：发送后一定时间内可撤回
5. **消息转发**：转发消息到其他会话
6. **群聊功能**：多人聊天支持
7. **离线消息**：推送通知
8. **消息搜索**：全文搜索历史消息

### 性能优化
1. **分页加载**：消息列表分页
2. **虚拟滚动**：长列表优化
3. **缓存策略**：本地消息缓存
4. **事件去重**：避免重复处理

### 体验优化
1. **输入状态**：显示对方正在输入
2. **消息预览**：会话列表显示最后一条消息
3. **@提醒**：群聊中的用户提醒
4. **表情包**：支持emoji和贴图

## 📖 相关文档

- [pallet-chat源码](/home/xiaodong/文档/stardust/pallets/chat/src/lib.rs)
- [chatService](/home/xiaodong/文档/stardust/stardust-dapp/src/services/chatService.ts)
- [OneOnOneChatPage](/home/xiaodong/文档/stardust/stardust-dapp/src/features/chat/OneOnOneChatPage.tsx)

---

**创建日期**: 2025-11-22
**版本**: v1.0.0