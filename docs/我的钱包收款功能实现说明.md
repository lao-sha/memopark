# 我的钱包 - 收款功能实现说明

## 📋 需求概述

在"我的钱包"页面添加收款功能,点击收款卡片后弹出当前钱包地址的二维码,方便用户接收转账。

---

## 🎯 实现目标

1. ✅ 在功能菜单中添加"收款"选项
2. ✅ 点击"收款"打开弹窗
3. ✅ 显示当前钱包地址的二维码
4. ✅ 显示完整的钱包地址
5. ✅ 提供"复制地址"功能
6. ✅ 美观的 UI 设计,与整体风格一致

---

## 🔧 技术实现

### 1. 依赖安装

**安装 qrcode.react**:
```bash
npm install qrcode.react --save
```

**用途**: 生成二维码组件

---

### 2. 导入依赖

```typescript
import { QRCodeCanvas } from 'qrcode.react';
import { QrcodeOutlined, CopyOutlined } from '@ant-design/icons';
import { Button } from 'antd';
```

**组件说明**:
- `QRCodeCanvas`: Canvas 渲染的二维码组件(性能更好)
- `QrcodeOutlined`: 二维码图标
- `CopyOutlined`: 复制图标
- `Button`: Ant Design 按钮组件

---

### 3. 状态管理

```typescript
const [receiveModalVisible, setReceiveModalVisible] = useState<boolean>(false);
```

**状态说明**:
- `receiveModalVisible`: 控制收款弹窗的显示/隐藏

---

### 4. 核心函数

#### 4.1 handleShowReceive()

```typescript
/**
 * 函数级详细中文注释：打开收款二维码弹窗
 * - 显示当前钱包地址的二维码
 * - 用户可扫码转账
 */
const handleShowReceive = () => {
  if (!address) {
    message.warning('请先连接钱包');
    return;
  }
  setReceiveModalVisible(true);
};
```

**功能**:
- 验证钱包地址是否存在
- 打开收款弹窗

---

#### 4.2 handleCopyAddress()

```typescript
/**
 * 函数级详细中文注释：复制钱包地址
 * - 将地址复制到剪贴板
 * - 显示成功提示
 */
const handleCopyAddress = async () => {
  if (!address) {
    message.warning('无地址可复制');
    return;
  }
  try {
    await navigator.clipboard.writeText(address);
    message.success('地址已复制到剪贴板');
  } catch (e) {
    message.error('复制失败，请手动复制');
  }
};
```

**功能**:
- 使用 Clipboard API 复制地址
- 显示成功或失败提示
- 错误处理

---

#### 4.3 handleCloseReceive()

```typescript
/**
 * 函数级详细中文注释：关闭收款弹窗
 */
const handleCloseReceive = () => {
  setReceiveModalVisible(false);
};
```

**功能**:
- 关闭收款弹窗

---

### 5. 菜单项配置

```typescript
const menuItems: MenuItem[] = [
  // ... 其他菜单项
  {
    icon: <QrcodeOutlined style={{ fontSize: '20px' }} />,
    title: '收款',
    onClick: handleShowReceive,
  },
  // ... 更多菜单项
];
```

**位置**: 在"转账"和"修改密码"之间

---

### 6. 收款弹窗 UI

#### 6.1 弹窗配置

```typescript
<Modal
  title={
    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
      <QrcodeOutlined style={{ fontSize: '20px', color: '#667eea' }} />
      <span>收款二维码</span>
    </div>
  }
  open={receiveModalVisible}
  onCancel={handleCloseReceive}
  footer={null}
  centered
  width={420}
>
```

**特点**:
- 自定义标题,包含二维码图标
- 无默认 footer,使用自定义按钮
- 居中显示
- 宽度 420px

---

#### 6.2 二维码组件

```typescript
<QRCodeCanvas
  value={address}           // 二维码内容(钱包地址)
  size={240}                // 尺寸 240x240
  level="H"                 // 纠错级别 High (30%)
  includeMargin={true}      // 包含边距
  imageSettings={{          // 不使用中心图标
    src: '',
    height: 0,
    width: 0,
    excavate: false,
  }}
/>
```

**QRCodeCanvas 参数说明**:
| 参数 | 值 | 说明 |
|------|-----|------|
| `value` | `address` | 钱包地址字符串 |
| `size` | `240` | 二维码尺寸 (像素) |
| `level` | `'H'` | 纠错级别 (L/M/Q/H) |
| `includeMargin` | `true` | 包含白边 |

**纠错级别说明**:
- `L`: 7% 容错
- `M`: 15% 容错
- `Q`: 25% 容错
- `H`: 30% 容错 ⭐ (推荐,即使部分损坏也能扫描)

---

#### 6.3 地址显示区域

```typescript
<div style={{ width: '100%', marginBottom: '16px' }}>
  <Text type="secondary" style={{ fontSize: '12px', textAlign: 'center' }}>
    我的钱包地址
  </Text>
  <div
    style={{
      background: '#f5f5f5',
      padding: '12px',
      borderRadius: '8px',
      wordBreak: 'break-all',
      textAlign: 'center',
      fontSize: '13px',
      fontFamily: 'monospace',
    }}
  >
    {address}
  </div>
</div>
```

**样式特点**:
- 灰色背景 (#f5f5f5)
- 等宽字体 (monospace)
- 自动换行 (wordBreak: 'break-all')
- 居中对齐

---

#### 6.4 复制按钮

```typescript
<Button
  type="primary"
  icon={<CopyOutlined />}
  onClick={handleCopyAddress}
  block
  size="large"
  style={{
    height: '48px',
    borderRadius: '8px',
    fontSize: '16px',
    fontWeight: 500,
    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
    border: 'none',
  }}
>
  复制地址
</Button>
```

**样式特点**:
- 紫色渐变背景
- 全宽按钮 (block)
- 高度 48px
- 大号按钮 (large)
- 圆角 8px

---

## 🎨 UI 设计

### 弹窗布局

```
┌─────────────────────────────┐
│  📱 收款二维码        ✕     │
├─────────────────────────────┤
│                             │
│      ┌─────────────┐        │
│      │             │        │
│      │  QR Code    │        │
│      │   240x240   │        │
│      │             │        │
│      └─────────────┘        │
│                             │
│     我的钱包地址            │
│  ┌─────────────────────┐   │
│  │ 5Cakw2y5...kPu6vj8  │   │
│  │ (完整地址显示)       │   │
│  └─────────────────────┘   │
│                             │
│  ┌─────────────────────┐   │
│  │  📋 复制地址         │   │
│  └─────────────────────┘   │
│                             │
│  💡 提示：请将此二维码    │
│     或地址发送给付款方    │
└─────────────────────────────┘
```

---

### 颜色系统

```typescript
const colors = {
  // 二维码容器
  qrContainer: {
    background: '#fff',
    boxShadow: '0 4px 12px rgba(0, 0, 0, 0.1)',
  },
  
  // 地址显示区域
  addressBox: {
    background: '#f5f5f5',
  },
  
  // 复制按钮
  copyButton: {
    background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
  },
  
  // 提示框
  tipBox: {
    background: '#f0f7ff',
  },
  
  // 图标颜色
  iconColor: '#667eea',
};
```

---

## 📱 响应式设计

### 弹窗尺寸

| 设备 | 弹窗宽度 | 二维码尺寸 |
|------|---------|-----------|
| 手机 | 自适应 | 240px |
| 平板 | 420px | 240px |
| 桌面 | 420px | 240px |

**自适应逻辑**:
- 弹窗 `width={420}` 在小屏幕上会自动缩小
- 二维码 `size={240}` 保持固定,确保扫描清晰度

---

## 🔄 用户流程

### 完整流程

```
1. 用户进入"我的钱包"页面
   ↓
2. 点击"收款"菜单项
   ↓
3. 验证钱包地址是否存在
   ↓
4. 打开收款弹窗
   ↓
5. 显示二维码和地址
   ↓
6. 用户可以:
   - 让付款方扫描二维码
   - 点击"复制地址"按钮
   - 将地址发送给付款方
   ↓
7. 付款方使用地址向用户转账
```

---

## 🧪 测试场景

### 1. 基本显示测试

**步骤**:
1. 进入"我的钱包"页面
2. 点击"收款"菜单项
3. 观察弹窗内容

**预期结果**:
- ✅ 弹窗正确显示
- ✅ 二维码清晰可见
- ✅ 地址完整显示
- ✅ 复制按钮可见

---

### 2. 二维码扫描测试

**步骤**:
1. 打开收款弹窗
2. 使用手机钱包应用扫描二维码
3. 验证扫描结果

**预期结果**:
- ✅ 二维码可正常扫描
- ✅ 扫描得到正确的钱包地址
- ✅ 地址格式正确

---

### 3. 复制地址测试

**步骤**:
1. 打开收款弹窗
2. 点击"复制地址"按钮
3. 粘贴到文本编辑器

**预期结果**:
- ✅ 显示"地址已复制到剪贴板"提示
- ✅ 剪贴板包含完整地址
- ✅ 地址格式正确

---

### 4. 无地址测试

**步骤**:
1. 未连接钱包时
2. 点击"收款"菜单项

**预期结果**:
- ✅ 显示"请先连接钱包"提示
- ✅ 弹窗不打开

---

### 5. 弹窗关闭测试

**步骤**:
1. 打开收款弹窗
2. 点击右上角关闭按钮
3. 或点击弹窗外部区域

**预期结果**:
- ✅ 弹窗正确关闭
- ✅ 状态重置

---

## 📝 代码修改

### 修改的文件

**文件**: `memopark-dapp/src/features/profile/MyWalletPage.tsx`

### 主要修改

#### 1. 新增依赖
```typescript
import { QRCodeCanvas } from 'qrcode.react';
import { QrcodeOutlined, CopyOutlined } from '@ant-design/icons';
import { Button } from 'antd';
```

#### 2. 新增状态
```typescript
const [receiveModalVisible, setReceiveModalVisible] = useState<boolean>(false);
```

#### 3. 新增函数
- `handleShowReceive()`: 打开收款弹窗
- `handleCopyAddress()`: 复制地址
- `handleCloseReceive()`: 关闭弹窗

#### 4. 新增菜单项
```typescript
{
  icon: <QrcodeOutlined style={{ fontSize: '20px' }} />,
  title: '收款',
  onClick: handleShowReceive,
}
```

#### 5. 新增收款弹窗组件
- 二维码显示
- 地址显示
- 复制按钮
- 提示信息

---

## 🎯 功能特点

| 特点 | 说明 |
|------|------|
| ✅ **二维码生成** | 使用 qrcode.react 生成高质量二维码 |
| ✅ **高纠错率** | Level H (30%) 纠错,即使损坏也能扫描 |
| ✅ **复制功能** | 一键复制地址到剪贴板 |
| ✅ **清晰显示** | 完整显示钱包地址,等宽字体 |
| ✅ **友好提示** | 使用说明和操作提示 |
| ✅ **美观 UI** | 紫色渐变主题,与整体风格一致 |
| ✅ **响应式** | 适配移动端和桌面端 |
| ✅ **错误处理** | 验证地址存在,处理复制失败 |

---

## ⚠️ 注意事项

### 1. 二维码尺寸

**推荐**: 240x240 像素
- ✅ 在手机屏幕上清晰可见
- ✅ 扫描距离适中
- ✅ 不占用过多空间

**不推荐**:
- ❌ 小于 200px - 可能难以扫描
- ❌ 大于 300px - 占用过多空间

---

### 2. 纠错级别

**推荐**: Level H (30%)
- ✅ 最高纠错率
- ✅ 即使部分损坏也能扫描
- ⚠️ 二维码密度较高

**其他选项**:
- L (7%): 简单场景
- M (15%): 一般场景
- Q (25%): 较复杂场景

---

### 3. 地址格式

**Substrate 地址特点**:
- 以 `5` 开头
- 长度约 47-48 字符
- Base58 编码
- 包含校验和

**示例**: `5Cakw2y5VmPsGoRfZ6kPu6vj8...`

---

### 4. Clipboard API 兼容性

**支持**: 现代浏览器 (Chrome, Firefox, Safari, Edge)

**错误处理**:
```typescript
try {
  await navigator.clipboard.writeText(address);
  message.success('地址已复制');
} catch (e) {
  message.error('复制失败，请手动复制');
}
```

---

### 5. 安全建议

**不要**:
- ❌ 不要在公共场所展示二维码太久
- ❌ 不要截图后在社交媒体分享
- ❌ 不要将二维码发送给不信任的人

**应该**:
- ✅ 仅向信任的付款方展示
- ✅ 使用后立即关闭弹窗
- ✅ 定期检查账户余额

---

## 🚀 未来优化方向

### 1. 金额预设
```typescript
// 添加金额参数到二维码
const qrValue = `${address}?amount=${amount}`;
```

### 2. 备注信息
```typescript
// 添加备注到二维码
const qrValue = `${address}?memo=${encodeURIComponent(memo)}`;
```

### 3. 保存二维码
```typescript
// 下载二维码图片
const downloadQRCode = () => {
  const canvas = document.querySelector('canvas');
  const url = canvas.toDataURL('image/png');
  const a = document.createElement('a');
  a.href = url;
  a.download = 'wallet-qrcode.png';
  a.click();
};
```

### 4. 分享功能
```typescript
// 使用 Web Share API
const shareQRCode = async () => {
  if (navigator.share) {
    await navigator.share({
      title: '我的钱包地址',
      text: address,
    });
  }
};
```

---

## 📚 相关文档

- [qrcode.react 文档](https://github.com/zpao/qrcode.react)
- [Clipboard API](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard_API)
- [QR Code 规范](https://www.qrcode.com/en/)
- [Substrate 地址格式](https://wiki.polkadot.network/docs/learn-accounts)

---

## 🎉 完成状态

**状态**: ✅ **已完成并通过 linter 检查**

**实现内容**:
- ✅ 安装 qrcode.react 依赖
- ✅ 添加收款菜单项
- ✅ 实现收款弹窗
- ✅ 生成二维码
- ✅ 显示地址
- ✅ 复制功能
- ✅ 美观 UI
- ✅ 错误处理

**验证方法**:
1. 进入"我的钱包"页面
2. 点击"收款"菜单项
3. 查看二维码和地址
4. 测试复制功能
5. 使用手机扫描二维码

---

**实现完成时间**: 2025-10-06  
**开发者**: Memopark Team  
**版本**: v1.0

