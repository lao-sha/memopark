# 我的钱包 - 推荐码显示功能实现说明

## 📋 需求概述

在"我的钱包"页面的当前钱包地址后面,插入推荐码显示功能。格式为: 地址后4个空格,显示"我的推荐码",再空1个格,显示推荐码。如果当前钱包没有推荐码,显示"获取推荐码"提示。

---

## 🎯 实现目标

1. ✅ 在当前钱包地址后显示推荐码
2. ✅ 4个空格分隔地址和"我的推荐码"
3. ✅ "我的推荐码"后1个空格显示推荐码内容
4. ✅ 未领取推荐码时显示"获取推荐码"
5. ✅ 已领取推荐码时显示实际推荐码
6. ✅ 账户切换时自动加载新账户的推荐码

---

## 🎨 UI 设计

### 显示格式

**有推荐码时**:
```
5Cakw2y5...kPu6vj8    我的推荐码 ABC123
```

**无推荐码时**:
```
5Cakw2y5...kPu6vj8    我的推荐码 获取推荐码
```

### 完整布局

```
┌─────────────────────────────────┐
│  👤  亲友 ✏️ 当前钱包            │
│      5Cakw2y5...kPu6vj8         │
│          我的推荐码 ABC123      │  ← 推荐码显示
└─────────────────────────────────┘
```

---

## 🔧 技术实现

### 1. 状态管理

```typescript
const [refCode, setRefCode] = useState<string>('');
```

**状态说明**:
- `refCode`: 存储当前账户的推荐码
- 空字符串表示未领取推荐码

---

### 2. 核心函数

#### loadRefCode()

```typescript
/**
 * 函数级详细中文注释：加载当前账户的推荐码
 * - 从链上 memoReferrals.codeOf 读取推荐码
 * - 如果未领取，设置为空字符串
 */
const loadRefCode = async (addr: string) => {
  try {
    const api = await getApi();
    const qroot: any = api.query as any;
    const sec = qroot.memoReferrals || qroot.memo_referrals;
    if (!sec || !sec.codeOf) {
      setRefCode('');
      return;
    }
    const raw = await sec.codeOf(addr);
    if (raw && raw.isSome) {
      const v = raw.unwrap();
      const code = Buffer.from(v.toU8a()).toString('utf8');
      setRefCode(code);
    } else {
      setRefCode('');
    }
  } catch (e: any) {
    console.warn('加载推荐码失败:', e);
    setRefCode('');
  }
};
```

**执行流程**:
```
1. 获取 API 实例
   ↓
2. 获取 memoReferrals 或 memo_referrals pallet
   ↓
3. 验证 pallet 和 codeOf 方法是否存在
   ↓
4. 查询 codeOf(address)
   ↓
5. 检查返回值是否存在 (isSome)
   ↓
6. 解析推荐码 (Buffer.from(...).toString('utf8'))
   ↓
7. 设置推荐码或空字符串
```

**错误处理**:
- pallet 不存在 → 设置为空
- codeOf 方法不存在 → 设置为空
- 查询失败 → 设置为空
- 未领取推荐码 → 设置为空

---

#### loadAddress() 修改

```typescript
const loadAddress = () => {
  const addr = getCurrentAddress();
  setAddress(addr);
  if (addr) {
    loadNickname(addr);
    loadRefCode(addr);  // ✅ 新增：加载推荐码
  }
};
```

---

### 3. UI 实现

#### 地址和推荐码显示区域

```typescript
<div style={{ display: 'flex', alignItems: 'center', gap: '4px', flexWrap: 'wrap' }}>
  {/* 钱包地址 */}
  <Text type="secondary" style={{ fontSize: '12px' }}>
    {address ? `${address.slice(0, 8)}...${address.slice(-8)}` : '未连接'}
  </Text>
  
  {/* 推荐码部分 */}
  {address && (
    <>
      {/* "我的推荐码"标签 (前面4个空格) */}
      <Text type="secondary" style={{ fontSize: '12px' }}>
        {'    '}我的推荐码
      </Text>
      
      {/* 推荐码内容或提示 */}
      <Text
        type="secondary"
        style={{
          fontSize: '12px',
          color: refCode ? '#1890ff' : '#8c8c8c',
          fontFamily: refCode ? 'monospace' : 'inherit',
        }}
      >
        {refCode || '获取推荐码'}
      </Text>
    </>
  )}
</div>
```

**样式特点**:
- `display: 'flex'`: 弹性布局
- `alignItems: 'center'`: 垂直居中
- `gap: '4px'`: 元素间距 4px
- `flexWrap: 'wrap'`: 自动换行
- 4个空格: `{'    '}`
- 推荐码颜色:
  - 有推荐码: 蓝色 (#1890ff)
  - 无推荐码: 灰色 (#8c8c8c)
- 推荐码字体:
  - 有推荐码: 等宽字体 (monospace)
  - 无推荐码: 默认字体

---

## 📊 数据来源

### 链上存储

**Pallet**: `memoReferrals` (或 `memo_referrals`)

**查询方法**: `codeOf(AccountId)`

**返回类型**: `Option<BoundedVec<u8, MaxCodeLength>>`

**数据解析**:
```typescript
if (raw && raw.isSome) {
  const v = raw.unwrap();
  const code = Buffer.from(v.toU8a()).toString('utf8');
}
```

---

### 推荐码特点

| 特性 | 说明 |
|------|------|
| **编码** | UTF-8 字符串 |
| **长度** | 受 MaxCodeLength 限制 |
| **唯一性** | 每个账户只能有一个推荐码 |
| **领取方式** | 调用 `memoReferrals.claimDefaultCode` |
| **前提条件** | 必须已绑定推荐人 |

---

## 🔄 自动更新机制

### 触发加载推荐码的场景

| 场景 | 事件 | 行为 |
|------|-----|------|
| 页面加载 | `useEffect` | 自动加载当前账户推荐码 |
| 账户切换 | `mp.accountsUpdate` | 重新加载新账户推荐码 |

### 事件监听

```typescript
useEffect(() => {
  loadAddress();  // 包含 loadRefCode()
  
  const handleAccountUpdate = () => {
    loadAddress();  // 包含 loadRefCode()
  };
  
  window.addEventListener('mp.accountsUpdate', handleAccountUpdate);
  
  return () => {
    window.removeEventListener('mp.accountsUpdate', handleAccountUpdate);
  };
}, []);
```

---

## 🎯 显示逻辑

### 条件判断

```typescript
{refCode || '获取推荐码'}
```

**逻辑**:
- `refCode` 非空 → 显示推荐码内容
- `refCode` 为空 → 显示"获取推荐码"

### 样式判断

```typescript
color: refCode ? '#1890ff' : '#8c8c8c',
fontFamily: refCode ? 'monospace' : 'inherit',
```

**逻辑**:
- 有推荐码:
  - 颜色: 蓝色 (#1890ff)
  - 字体: 等宽字体
- 无推荐码:
  - 颜色: 灰色 (#8c8c8c)
  - 字体: 默认字体

---

## 📝 代码修改

### 修改的文件

**文件**: `memopark-dapp/src/features/profile/MyWalletPage.tsx`

### 主要修改

#### 1. 新增状态
```typescript
const [refCode, setRefCode] = useState<string>('');
```

#### 2. 新增函数
```typescript
const loadRefCode = async (addr: string) => {
  // 加载推荐码逻辑
};
```

#### 3. 修改 loadAddress()
```typescript
const loadAddress = () => {
  const addr = getCurrentAddress();
  setAddress(addr);
  if (addr) {
    loadNickname(addr);
    loadRefCode(addr);  // 新增
  }
};
```

#### 4. 修改 UI
```typescript
<div style={{ display: 'flex', alignItems: 'center', gap: '4px', flexWrap: 'wrap' }}>
  <Text type="secondary">{address}</Text>
  {address && (
    <>
      <Text type="secondary">{'    '}我的推荐码</Text>
      <Text
        type="secondary"
        style={{
          color: refCode ? '#1890ff' : '#8c8c8c',
          fontFamily: refCode ? 'monospace' : 'inherit',
        }}
      >
        {refCode || '获取推荐码'}
      </Text>
    </>
  )}
</div>
```

---

## 🧪 测试场景

### 1. 有推荐码的账户

**步骤**:
1. 使用已领取推荐码的账户登录
2. 进入"我的钱包"页面
3. 查看地址下方

**预期结果**:
- ✅ 显示地址
- ✅ 4个空格后显示"我的推荐码"
- ✅ 1个空格后显示推荐码 (蓝色等宽字体)
- ✅ 例如: `5Cakw2y5...kPu6vj8    我的推荐码 ABC123`

---

### 2. 无推荐码的账户

**步骤**:
1. 使用未领取推荐码的账户登录
2. 进入"我的钱包"页面
3. 查看地址下方

**预期结果**:
- ✅ 显示地址
- ✅ 4个空格后显示"我的推荐码"
- ✅ 1个空格后显示"获取推荐码" (灰色普通字体)
- ✅ 例如: `5Cakw2y5...kPu6vj8    我的推荐码 获取推荐码`

---

### 3. 账户切换测试

**步骤**:
1. 账户A有推荐码 "ABC123"
2. 账户B无推荐码
3. 从账户A切换到账户B

**预期结果**:
- ✅ 切换前显示 "ABC123"
- ✅ 切换后显示 "获取推荐码"
- ✅ 推荐码自动更新

---

### 4. 链节点未启动测试

**步骤**:
1. 停止链节点
2. 进入"我的钱包"页面

**预期结果**:
- ✅ 显示地址
- ✅ 显示"获取推荐码"
- ✅ 控制台有"加载推荐码失败"警告
- ✅ 不影响其他功能

---

### 5. Pallet 不存在测试

**步骤**:
1. 使用没有 memoReferrals pallet 的链
2. 进入"我的钱包"页面

**预期结果**:
- ✅ 显示地址
- ✅ 显示"获取推荐码"
- ✅ 不报错

---

## 🎨 视觉效果

### 布局示例

```
┌─────────────────────────────────────┐
│  👤  亲友 ✏️ 当前钱包                │  ← 第一行
├─────────────────────────────────────┤
│      5Cakw2y5...kPu6vj8              │  ← 地址
│          我的推荐码 ABC123          │  ← 推荐码
└─────────────────────────────────────┘

或 (移动端自动换行):

┌───────────────────────────┐
│  👤  亲友 ✏️ 当前钱包      │
│      5Cakw2y5...kPu6vj8   │
│          我的推荐码       │  ← 自动换行
│      ABC123               │
└───────────────────────────┘
```

### 颜色对比

**有推荐码**:
```
5Cakw2y5...kPu6vj8    我的推荐码 ABC123
     ↑ 灰色                  ↑ 蓝色等宽
```

**无推荐码**:
```
5Cakw2y5...kPu6vj8    我的推荐码 获取推荐码
     ↑ 灰色                  ↑ 灰色普通
```

---

## 📊 代码统计

- **新增行数**: ~40 行
- **新增函数**: 1 个 (`loadRefCode`)
- **新增状态**: 1 个 (`refCode`)
- **修改函数**: 1 个 (`loadAddress`)
- **修改 UI**: 1 处 (地址显示区域)

---

## ⚠️ 注意事项

### 1. 推荐码领取条件

**前提条件**:
- ✅ 必须已绑定推荐人
- ❌ 未绑定推荐人无法领取

**领取方式**:
- 调用 `memoReferrals.claimDefaultCode`
- 需要签名交易

**提示**:
- 当前实现仅显示推荐码
- 领取推荐码功能在"个人中心(旧)"页面

---

### 2. 推荐码格式

**特点**:
- UTF-8 编码
- 可能包含字母、数字、特殊字符
- 建议使用等宽字体显示

**示例**:
- `ABC123`
- `REF-2024-001`
- `用户推荐码001`

---

### 3. 响应式设计

**自动换行**:
- 使用 `flexWrap: 'wrap'`
- 小屏幕时自动换行
- 保持良好的阅读体验

**间距控制**:
- `gap: '4px'`: 元素间距
- 4个空格: 地址与"我的推荐码"之间
- 1个空格: "我的推荐码"与推荐码之间

---

### 4. 性能考虑

**并行加载**:
```typescript
if (addr) {
  loadNickname(addr);  // 异步
  loadRefCode(addr);   // 异步
}
```
- 昵称和推荐码并行加载
- 互不阻塞
- 提升加载速度

---

## 🚀 未来优化方向

### 1. 点击跳转

**需求**: 点击"获取推荐码"跳转到领取页面

**实现**:
```typescript
<Text
  onClick={() => {
    if (!refCode) {
      // 跳转到个人中心页面
      window.location.hash = '#/profile';
    }
  }}
  style={{ cursor: refCode ? 'default' : 'pointer' }}
>
  {refCode || '获取推荐码'}
</Text>
```

---

### 2. 复制功能

**需求**: 点击推荐码复制到剪贴板

**实现**:
```typescript
<Text
  onClick={() => {
    if (refCode) {
      navigator.clipboard.writeText(refCode);
      message.success('推荐码已复制');
    }
  }}
  style={{ cursor: refCode ? 'pointer' : 'default' }}
>
  {refCode || '获取推荐码'}
</Text>
```

---

### 3. 分享功能

**需求**: 点击按钮生成分享链接

**实现**:
```typescript
const shareRefCode = async () => {
  const link = `${window.location.origin}/#/ref?code=${refCode}`;
  await navigator.clipboard.writeText(link);
  message.success('分享链接已复制');
};
```

---

### 4. 刷新按钮

**需求**: 手动刷新推荐码

**实现**:
```typescript
<ReloadOutlined
  onClick={() => loadRefCode(address)}
  style={{ fontSize: '12px', cursor: 'pointer' }}
/>
```

---

## 📚 相关文档

- [推荐系统设计文档](./推荐系统设计文档.md)
- [memoReferrals Pallet 文档](./memoReferrals-pallet文档.md)
- [个人中心页面实现说明](./个人中心页面实现说明.md)

---

## 🎉 完成状态

**状态**: ✅ **已完成并通过 linter 检查**

**实现内容**:
- ✅ 新增推荐码状态管理
- ✅ 实现推荐码加载函数
- ✅ 修改 UI 显示推荐码
- ✅ 4个空格分隔
- ✅ 有/无推荐码的不同显示
- ✅ 账户切换自动更新
- ✅ 错误处理完善

**验证方法**:
1. 启动链节点和前端项目
2. 使用有推荐码的账户登录
3. 进入"我的钱包"页面
4. 查看地址下方推荐码显示
5. 切换到无推荐码的账户
6. 验证显示"获取推荐码"

---

**实现完成时间**: 2025-10-06  
**开发者**: Memopark Team  
**版本**: v1.0

