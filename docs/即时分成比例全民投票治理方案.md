# å³æ—¶åˆ†æˆæ¯”ä¾‹å…¨æ°‘æŠ•ç¥¨æ²»ç†æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–¹æ¡ˆè®¾è®¡äº†ä¸€å¥—é€šè¿‡å…¨æ°‘æŠ•ç¥¨æœºåˆ¶ä¿®æ”¹å³æ—¶åˆ†æˆæ¯”ä¾‹ï¼ˆInstantLevelPercentsï¼‰çš„æ²»ç†ç³»ç»Ÿï¼Œç¡®ä¿åˆ†é…æ¯”ä¾‹çš„è°ƒæ•´é€æ˜ã€æ°‘ä¸»ã€å®‰å…¨ã€‚

## ğŸ¯ å½“å‰çŠ¶æ€

### ç°æœ‰åˆ†æˆæ¯”ä¾‹

```rust
// types.rs: default_instant_percents()
L1:  30% â†’ 27.0 DUST  (90 * 30%)
L2:  25% â†’ 22.5 DUST  (90 * 25%)
L3:  15% â†’ 13.5 DUST  (90 * 15%)
L4:  10% â†’ 9.0  DUST  (90 * 10%)
L5:   7% â†’ 6.3  DUST  (90 * 7%)
L6:   3% â†’ 2.7  DUST  (90 * 3%)
L7:   2% â†’ 1.8  DUST  (90 * 2%)
L8:   2% â†’ 1.8  DUST  (90 * 2%)
L9:   2% â†’ 1.8  DUST  (90 * 2%)
L10:  1% â†’ 0.9  DUST  (90 * 1%)
L11:  1% â†’ 0.9  DUST  (90 * 1%)
L12:  1% â†’ 0.9  DUST  (90 * 1%)
L13:  1% â†’ 0.9  DUST  (90 * 1%)
L14:  1% â†’ 0.9  DUST  (90 * 1%)
L15:  1% â†’ 0.9  DUST  (90 * 1%)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
æ€»è®¡: 99% â†’ 89.1 DUST
```

### ç³»ç»Ÿè´¹ç”¨åˆ†é…

```
æ€»é‡‘é¢: 100 DUST
â”œâ”€ é”€æ¯ (Burn): 5%     â†’ 5 DUST
â”œâ”€ å›½åº“ (Treasury): 2% â†’ 2 DUST
â”œâ”€ å­˜å‚¨ (Storage): 3%  â†’ 3 DUST
â””â”€ å¯åˆ†é…é‡‘é¢: 90%     â†’ 90 DUST â†’ è¿›å…¥æ¨èé“¾åˆ†é…
```

## ğŸ—ï¸ æ²»ç†æ¶æ„è®¾è®¡

### 1. æ²»ç†æ¨¡å—é›†æˆ

```rust
// runtime/src/lib.rs
impl pallet_affiliate::Config for Runtime {
    // ç°æœ‰é…ç½®...

    /// æ²»ç†èµ·æºï¼ˆç”¨äºä¿®æ”¹åˆ†æˆæ¯”ä¾‹ï¼‰
    type GovernanceOrigin = pallet_collective::EnsureProportionAtLeast<AccountId, CouncilCollective, 2, 3>;

    /// å…¬æŠ•èµ·æºï¼ˆç”¨äºå…¨æ°‘æŠ•ç¥¨ï¼‰
    type DemocracyOrigin = pallet_democracy::EnsureProposal<AccountId>;
}
```

### 2. æ²»ç†å±‚çº§ç»“æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å…¨æ°‘å…¬æŠ•å±‚                            â”‚
â”‚  â€¢ æœ€é«˜å†³ç­–æƒå¨                                         â”‚
â”‚  â€¢ å¯ä»¥æ¨ç¿»å§”å‘˜ä¼šå†³å®š                                    â”‚
â”‚  â€¢ é‡å¤§æ¯”ä¾‹è°ƒæ•´ï¼ˆæ€»å˜åŒ– > 10%ï¼‰                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æŠ€æœ¯å§”å‘˜ä¼šå±‚                           â”‚
â”‚  â€¢ 7äººä¸“å®¶å§”å‘˜ä¼š                                         â”‚
â”‚  â€¢ å¿«é€Ÿå®¡è®®æŠ€æœ¯ç»†èŠ‚                                      â”‚
â”‚  â€¢ å°å¹…è°ƒæ•´ï¼ˆæ€»å˜åŒ– â‰¤ 10%ï¼‰                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ææ¡ˆå‘èµ·å±‚                              â”‚
â”‚  â€¢ æŒå¸é‡ â‰¥ 10,000 DUST                                 â”‚
â”‚  â€¢ æˆ–è·å¾— 1000 äººè”ç½²                                    â”‚
â”‚  â€¢ æˆ–æŠ€æœ¯å§”å‘˜ä¼šæè®®                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“ ææ¡ˆæœºåˆ¶

### 1. ææ¡ˆç±»å‹

#### A. å¾®è°ƒææ¡ˆï¼ˆæŠ€æœ¯å§”å‘˜ä¼šå¤„ç†ï¼‰
- **æ¡ä»¶**ï¼šå•å±‚è°ƒæ•´ â‰¤ 3%ï¼Œæ€»å˜åŒ– â‰¤ 10%
- **ç¤ºä¾‹**ï¼šL1ä»30%è°ƒæ•´åˆ°32%
- **æµç¨‹**ï¼šæŠ€æœ¯å§”å‘˜ä¼š â†’ 7å¤©æŠ•ç¥¨ â†’ 2/3å¤šæ•°é€šè¿‡

#### B. é‡å¤§è°ƒæ•´ææ¡ˆï¼ˆå…¨æ°‘å…¬æŠ•ï¼‰
- **æ¡ä»¶**ï¼šå•å±‚è°ƒæ•´ > 3%ï¼Œæˆ–æ€»å˜åŒ– > 10%
- **ç¤ºä¾‹**ï¼šé‡æ–°è®¾è®¡æ•´ä¸ªåˆ†é…ç»“æ„
- **æµç¨‹**ï¼šææ¡ˆ â†’ å§”å‘˜ä¼šé¢„å®¡ â†’ å…¨æ°‘å…¬æŠ• â†’ æ‰§è¡Œ

#### C. ç´§æ€¥ææ¡ˆï¼ˆå¿«é€Ÿé€šé“ï¼‰
- **æ¡ä»¶**ï¼šä¿®å¤æ˜æ˜¾é”™è¯¯æˆ–å®‰å…¨é—®é¢˜
- **ç¤ºä¾‹**ï¼šæŸå±‚æ¯”ä¾‹é…ç½®ä¸º0å¯¼è‡´ç³»ç»Ÿå¼‚å¸¸
- **æµç¨‹**ï¼šæŠ€æœ¯å§”å‘˜ä¼š â†’ 24å°æ—¶ç´§æ€¥æŠ•ç¥¨ â†’ ç«‹å³æ‰§è¡Œ

### 2. ææ¡ˆå‘èµ·æ¡ä»¶

```rust
// ææ¡ˆå‘èµ·æƒé™
pub enum ProposalOrigin<AccountId, Balance> {
    /// å¤§æˆ·ææ¡ˆï¼šæŒå¸é‡ â‰¥ 10,000 DUST
    Whale {
        account: AccountId,
        stake: Balance // â‰¥ 10,000 DUST
    },

    /// è”ç½²ææ¡ˆï¼šâ‰¥ 1000 äººè”ç½²
    Petition {
        initiator: AccountId,
        signatories: Vec<AccountId>, // â‰¥ 1000 äºº
        total_stake: Balance // è”ç½²æ€»æŒå¸é‡
    },

    /// å§”å‘˜ä¼šææ¡ˆï¼šæŠ€æœ¯å§”å‘˜ä¼šæˆå‘˜æè®®
    Council {
        proposer: AccountId, // å§”å‘˜ä¼šæˆå‘˜
        co_sponsors: Vec<AccountId>, // â‰¥ 2 åè”åˆå‘èµ·äºº
    },
}
```

### 3. ææ¡ˆå†…å®¹è§„èŒƒ

```rust
/// åˆ†æˆæ¯”ä¾‹è°ƒæ•´ææ¡ˆ
#[derive(Encode, Decode, Clone, PartialEq, Eq, TypeInfo)]
pub struct PercentageAdjustmentProposal {
    /// ææ¡ˆID
    pub proposal_id: u64,

    /// ææ¡ˆæ ‡é¢˜ï¼ˆIPFS CIDï¼‰
    pub title_cid: BoundedVec<u8, ConstU32<64>>,

    /// ææ¡ˆè¯¦æƒ…ï¼ˆIPFS CIDï¼‰
    pub description_cid: BoundedVec<u8, ConstU32<64>>,

    /// æ–°çš„åˆ†æˆæ¯”ä¾‹ï¼ˆ15å±‚ï¼‰
    pub new_percentages: LevelPercents,

    /// ç”Ÿæ•ˆæ—¶é—´ï¼ˆåŒºå—é«˜åº¦ï¼‰
    pub effective_block: BlockNumber,

    /// ææ¡ˆç†ç”±ï¼ˆIPFS CIDï¼‰
    pub rationale_cid: BoundedVec<u8, ConstU32<64>>,

    /// å½±å“åˆ†æï¼ˆIPFS CIDï¼‰
    pub impact_analysis_cid: BoundedVec<u8, ConstU32<64>>,
}
```

## ğŸ—³ï¸ æŠ•ç¥¨æœºåˆ¶

### 1. æŠ•ç¥¨æƒé‡è®¡ç®—

#### A. æŒå¸æƒé‡ï¼ˆ70%ï¼‰
```rust
// æŒå¸é‡æƒé‡è®¡ç®—
pub fn calculate_stake_weight(balance: Balance) -> u128 {
    let balance_dust = balance / DUST_PRECISION;

    // å¹³æ–¹æ ¹æƒé‡ï¼Œé¿å…å·¨é²¸å„æ–­
    let sqrt_balance = (balance_dust as f64).sqrt() as u128;

    // æƒé‡ä¸Šé™ï¼šç›¸å½“äº100ä¸‡DUSTçš„æƒé‡
    let max_weight = 1000u128; // sqrt(1,000,000) = 1000

    sqrt_balance.min(max_weight)
}
```

#### B. å‚ä¸æƒé‡ï¼ˆ20%ï¼‰
```rust
// å†å²å‚ä¸åº¦æƒé‡
pub fn calculate_participation_weight(account: &AccountId) -> u128 {
    let vote_history = get_vote_history(account);
    let consecutive_votes = count_consecutive_votes(&vote_history);

    match consecutive_votes {
        0..=2 => 10,      // æ–°æ‰‹
        3..=5 => 25,      // æ´»è·ƒ
        6..=10 => 50,     // èµ„æ·±
        _ => 100,         // å…ƒè€
    }
}
```

#### C. è´¡çŒ®æƒé‡ï¼ˆ10%ï¼‰
```rust
// ç”Ÿæ€è´¡çŒ®æƒé‡
pub fn calculate_contribution_weight(account: &AccountId) -> u128 {
    let mut weight = 0u128;

    // æ¨èè´¡çŒ®
    let referral_count = count_successful_referrals(account);
    weight += referral_count.min(50) * 2;

    // æŠ€æœ¯è´¡çŒ®ï¼ˆå§”å‘˜ä¼šæˆå‘˜é¢å¤–æƒé‡ï¼‰
    if is_council_member(account) {
        weight += 200;
    }

    weight.min(300)
}
```

#### D. æœ€ç»ˆæƒé‡
```rust
// æ€»æŠ•ç¥¨æƒé‡
pub fn calculate_total_voting_power(account: &AccountId) -> u128 {
    let balance = get_balance(account);

    let stake_weight = calculate_stake_weight(balance) * 70 / 100;
    let participation_weight = calculate_participation_weight(account) * 20 / 100;
    let contribution_weight = calculate_contribution_weight(account) * 10 / 100;

    stake_weight + participation_weight + contribution_weight
}
```

### 2. æŠ•ç¥¨é€‰é¡¹

#### A. æ”¯æŒ/åå¯¹æŠ•ç¥¨
```rust
pub enum Vote {
    /// æ”¯æŒææ¡ˆ
    Aye,
    /// åå¯¹ææ¡ˆ
    Nay,
    /// å¼ƒæƒ
    Abstain,
}
```

#### B. ä¿¡å¿µæŠ•ç¥¨ï¼ˆConviction Votingï¼‰
```rust
pub enum Conviction {
    /// ä¸é”å®šï¼Œæƒé‡ x1
    None,
    /// é”å®š1å‘¨ï¼Œæƒé‡ x1.5
    Locked1x,
    /// é”å®š2å‘¨ï¼Œæƒé‡ x2
    Locked2x,
    /// é”å®š4å‘¨ï¼Œæƒé‡ x3
    Locked3x,
    /// é”å®š8å‘¨ï¼Œæƒé‡ x4
    Locked4x,
    /// é”å®š16å‘¨ï¼Œæƒé‡ x5
    Locked5x,
    /// é”å®š32å‘¨ï¼Œæƒé‡ x6
    Locked6x,
}
```

### 3. æŠ•ç¥¨å‘¨æœŸ

```rust
// æŠ•ç¥¨æ—¶é—´å‚æ•°
pub struct VotingTimeline {
    /// è®¨è®ºæœŸï¼š7å¤©
    pub discussion_period: BlockNumber,  // 100,800 blocks

    /// æŠ•ç¥¨æœŸï¼š14å¤©
    pub voting_period: BlockNumber,      // 201,600 blocks

    /// æ‰§è¡ŒæœŸï¼š3å¤©
    pub enactment_delay: BlockNumber,    // 43,200 blocks

    /// ç´§æ€¥æŠ•ç¥¨æœŸï¼š24å°æ—¶
    pub emergency_period: BlockNumber,   // 14,400 blocks
}
```

## âœ… é€šè¿‡æ¡ä»¶

### 1. æŠ€æœ¯å§”å‘˜ä¼šææ¡ˆ

```rust
// å§”å‘˜ä¼šæŠ•ç¥¨é€šè¿‡æ¡ä»¶
pub struct CouncilPassingCriteria {
    /// å‚ä¸ç‡ â‰¥ 5/7 (71%)
    pub min_participation: Perbill,  // 71%

    /// æ”¯æŒç‡ â‰¥ 2/3 (67%)
    pub min_approval: Perbill,       // 67%

    /// æœ€ä½æŠ•ç¥¨æœŸ
    pub min_voting_period: BlockNumber,  // 7å¤©
}
```

### 2. å…¨æ°‘å…¬æŠ•ææ¡ˆ

```rust
// å…¬æŠ•é€šè¿‡æ¡ä»¶ï¼ˆè‡ªé€‚åº”é˜ˆå€¼ï¼‰
pub struct ReferendumPassingCriteria {
    /// æœ€ä½å‚ä¸ç‡
    pub min_turnout: Perbill,        // 15%

    /// æ”¯æŒé˜ˆå€¼ï¼ˆåŸºäºå‚ä¸ç‡è°ƒæ•´ï¼‰
    pub approval_threshold: AdaptiveThreshold,

    /// æœ€ä½æŠ•ç¥¨æœŸ
    pub min_voting_period: BlockNumber,  // 14å¤©
}

// è‡ªé€‚åº”é˜ˆå€¼ï¼šå‚ä¸ç‡è¶Šé«˜ï¼Œé€šè¿‡é—¨æ§›è¶Šä½
impl AdaptiveThreshold {
    pub fn calculate(turnout: Perbill) -> Perbill {
        match turnout {
            t if t >= Perbill::from_percent(50) => Perbill::from_percent(50), // 50%å‚ä¸ â†’ 50%æ”¯æŒ
            t if t >= Perbill::from_percent(30) => Perbill::from_percent(55), // 30%å‚ä¸ â†’ 55%æ”¯æŒ
            t if t >= Perbill::from_percent(15) => Perbill::from_percent(60), // 15%å‚ä¸ â†’ 60%æ”¯æŒ
            _ => Perbill::from_percent(100), // å‚ä¸ç‡ä¸è¶³ï¼Œæ— æ³•é€šè¿‡
        }
    }
}
```

## ğŸ”§ å®æ–½æµç¨‹

### 1. å®Œæ•´æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    ææ¡ˆå‘èµ·     â”‚
â”‚  â€¢ æ£€æŸ¥èµ„æ ¼     â”‚
â”‚  â€¢ ç¼´çº³æŠ¼é‡‘     â”‚
â”‚  â€¢ ä¸Šä¼ è¯¦æƒ…     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ææ¡ˆé¢„å®¡      â”‚
â”‚ â€¢ æŠ€æœ¯å§”å‘˜ä¼š    â”‚
â”‚ â€¢ åˆè§„æ€§æ£€æŸ¥    â”‚
â”‚ â€¢ 7å¤©è®¨è®ºæœŸ     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
    â”Œâ”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”
    â”‚           â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”€â”
â”‚å¾®è°ƒææ¡ˆâ”‚   â”‚é‡å¤§ææ¡ˆâ”‚
â”‚å§”å‘˜ä¼š  â”‚   â”‚å…¨æ°‘å…¬æŠ•â”‚
â”‚æŠ•ç¥¨    â”‚   â”‚æŠ•ç¥¨    â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”€â”¬â”€â”€â”€â”˜
    â”‚           â”‚
    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç»“æœæ‰§è¡Œ      â”‚
â”‚ â€¢ è‡ªåŠ¨ç”Ÿæ•ˆ      â”‚
â”‚ â€¢ äº‹ä»¶è®°å½•      â”‚
â”‚ â€¢ æŠ¼é‡‘è¿”è¿˜      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. ææ¡ˆå‘èµ·

```rust
/// å‘èµ·åˆ†æˆæ¯”ä¾‹è°ƒæ•´ææ¡ˆ
#[pallet::call_index(50)]
#[pallet::weight(10_000)]
pub fn propose_percentage_adjustment(
    origin: OriginFor<T>,
    new_percentages: LevelPercents,
    title_cid: BoundedVec<u8, ConstU32<64>>,
    description_cid: BoundedVec<u8, ConstU32<64>>,
    rationale_cid: BoundedVec<u8, ConstU32<64>>,
) -> DispatchResult {
    let who = ensure_signed(origin)?;

    // éªŒè¯ææ¡ˆæƒé™
    Self::ensure_proposal_authority(&who)?;

    // éªŒè¯æ–°æ¯”ä¾‹æœ‰æ•ˆæ€§
    Self::validate_percentages(&new_percentages)?;

    // è®¡ç®—å˜åŒ–å¹…åº¦
    let current_percentages = InstantLevelPercents::<T>::get();
    let change_magnitude = Self::calculate_change_magnitude(&current_percentages, &new_percentages);

    // ç¼´çº³ææ¡ˆæŠ¼é‡‘
    let deposit_amount = Self::calculate_proposal_deposit(&change_magnitude);
    T::Currency::reserve(&who, deposit_amount)?;

    // åˆ›å»ºææ¡ˆ
    let proposal_id = NextProposalId::<T>::get();
    let proposal = PercentageAdjustmentProposal {
        proposal_id,
        title_cid,
        description_cid,
        new_percentages: new_percentages.clone(),
        effective_block: frame_system::Pallet::<T>::block_number() + T::EnactmentDelay::get(),
        rationale_cid,
        impact_analysis_cid: Default::default(),
    };

    // ç¡®å®šæŠ•ç¥¨ç±»å‹
    if change_magnitude <= Self::minor_change_threshold() {
        // å¾®è°ƒææ¡ˆ â†’ æŠ€æœ¯å§”å‘˜ä¼š
        Self::submit_to_council(proposal_id, proposal)?;
    } else {
        // é‡å¤§ææ¡ˆ â†’ å…¨æ°‘å…¬æŠ•
        Self::submit_to_referendum(proposal_id, proposal)?;
    }

    // æ›´æ–°çŠ¶æ€
    ProposalDeposits::<T>::insert(&proposal_id, (&who, deposit_amount));
    NextProposalId::<T>::set(proposal_id + 1);

    // å‘å°„äº‹ä»¶
    Self::deposit_event(Event::PercentageAdjustmentProposed {
        proposal_id,
        proposer: who,
        change_magnitude,
        is_major: change_magnitude > Self::minor_change_threshold(),
    });

    Ok(())
}
```

### 3. æŠ•ç¥¨æ‰§è¡Œ

```rust
/// å¯¹åˆ†æˆæ¯”ä¾‹ææ¡ˆæŠ•ç¥¨
#[pallet::call_index(51)]
#[pallet::weight(10_000)]
pub fn vote_on_percentage_proposal(
    origin: OriginFor<T>,
    proposal_id: u64,
    vote: Vote,
    conviction: Conviction,
) -> DispatchResult {
    let who = ensure_signed(origin)?;

    // éªŒè¯ææ¡ˆå­˜åœ¨ä¸”åœ¨æŠ•ç¥¨æœŸ
    let proposal = ActiveProposals::<T>::get(&proposal_id).ok_or(Error::<T>::ProposalNotFound)?;
    ensure!(Self::is_voting_active(&proposal_id)?, Error::<T>::VotingNotActive);

    // è®¡ç®—æŠ•ç¥¨æƒé‡
    let base_weight = Self::calculate_total_voting_power(&who);
    let conviction_multiplier = conviction.multiplier();
    let final_weight = base_weight.saturating_mul(conviction_multiplier);

    // é”å®šæŠ•ç¥¨èµ„é‡‘ï¼ˆå¦‚æœæœ‰ä¿¡å¿µæŠ•ç¥¨ï¼‰
    if conviction != Conviction::None {
        let lock_amount = Self::calculate_lock_amount(&who, &conviction);
        T::Currency::set_lock(CONVICTION_VOTING_ID, &who, lock_amount, WithdrawReasons::TRANSFER)?;
    }

    // è®°å½•æŠ•ç¥¨
    let vote_record = VoteRecord {
        voter: who.clone(),
        vote: vote.clone(),
        conviction,
        weight: final_weight,
        timestamp: frame_system::Pallet::<T>::block_number(),
    };

    ProposalVotes::<T>::insert(&proposal_id, &who, &vote_record);

    // æ›´æ–°ç»Ÿè®¡
    Self::update_vote_tally(&proposal_id, &vote, final_weight)?;

    // å‘å°„äº‹ä»¶
    Self::deposit_event(Event::VoteCast {
        proposal_id,
        voter: who,
        vote,
        weight: final_weight,
    });

    Ok(())
}
```

### 4. è‡ªåŠ¨æ‰§è¡Œ

```rust
/// åœ¨æ¯ä¸ªåŒºå—æ‰§è¡Œæ—¶è‡ªåŠ¨æ£€æŸ¥å’Œæ‰§è¡Œå·²é€šè¿‡çš„ææ¡ˆ
impl<T: Config> pallet::Hooks<T::BlockNumber> for Pallet<T> {
    fn on_finalize(block_number: T::BlockNumber) {
        // æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æ‰§è¡Œçš„ææ¡ˆ
        for (proposal_id, proposal) in ReadyForExecution::<T>::iter() {
            if proposal.effective_block <= block_number {
                if let Err(e) = Self::execute_percentage_change(&proposal_id, &proposal) {
                    log::error!("Failed to execute proposal {}: {:?}", proposal_id, e);
                } else {
                    // æ‰§è¡ŒæˆåŠŸï¼Œæ¸…ç†çŠ¶æ€
                    ReadyForExecution::<T>::remove(&proposal_id);
                    Self::return_proposal_deposit(&proposal_id);

                    Self::deposit_event(Event::PercentageAdjustmentExecuted {
                        proposal_id,
                        new_percentages: proposal.new_percentages,
                        effective_block: block_number,
                    });
                }
            }
        }
    }
}

/// æ‰§è¡Œæ¯”ä¾‹è°ƒæ•´
fn execute_percentage_change(
    proposal_id: &u64,
    proposal: &PercentageAdjustmentProposal<T>,
) -> DispatchResult {
    // éªŒè¯æ–°æ¯”ä¾‹ä»ç„¶æœ‰æ•ˆ
    Self::validate_percentages(&proposal.new_percentages)?;

    // æ›´æ–°åˆ†æˆæ¯”ä¾‹
    InstantLevelPercents::<T>::set(&proposal.new_percentages);

    // è®°å½•å†å²
    let change_record = PercentageChangeRecord {
        proposal_id: *proposal_id,
        old_percentages: InstantLevelPercents::<T>::get(),
        new_percentages: proposal.new_percentages.clone(),
        executed_at: frame_system::Pallet::<T>::block_number(),
        executed_by: "Governance".into(),
    };

    PercentageHistory::<T>::insert(proposal_id, &change_record);

    Ok(())
}
```

## ğŸ›¡ï¸ å®‰å…¨ä¿éšœ

### 1. ææ¡ˆéªŒè¯

```rust
/// éªŒè¯æ–°åˆ†æˆæ¯”ä¾‹çš„æœ‰æ•ˆæ€§
fn validate_percentages(percentages: &LevelPercents) -> DispatchResult {
    // 1. æ£€æŸ¥é•¿åº¦
    ensure!(percentages.len() == 15, Error::<T>::InvalidPercentageLength);

    // 2. æ£€æŸ¥å•ä¸ªæ¯”ä¾‹èŒƒå›´
    for (index, &percentage) in percentages.iter().enumerate() {
        ensure!(percentage <= 100, Error::<T>::PercentageTooHigh);

        // å‰3å±‚ä¸èƒ½ä¸º0
        if index < 3 {
            ensure!(percentage > 0, Error::<T>::CriticalLayerZero);
        }
    }

    // 3. æ£€æŸ¥æ€»å’Œåˆç†æ€§
    let total: u32 = percentages.iter().map(|&x| x as u32).sum();
    ensure!(total >= 50, Error::<T>::TotalPercentageTooLow);  // æœ€å°‘50%
    ensure!(total <= 99, Error::<T>::TotalPercentageTooHigh); // æœ€å¤š99%

    // 4. æ£€æŸ¥é€’å‡åˆç†æ€§ï¼ˆå‰5å±‚åº”è¯¥é€’å‡ï¼‰
    for i in 1..5 {
        ensure!(
            percentages[i] <= percentages[i-1],
            Error::<T>::NonDecreasingPercentage
        );
    }

    // 5. æ£€æŸ¥æå€¼ï¼ˆé˜²æ­¢å¯¡å¤´å„æ–­ï¼‰
    ensure!(percentages[0] <= 50, Error::<T>::FirstLayerTooHigh); // L1æœ€å¤š50%

    Ok(())
}
```

### 2. æ¶æ„æ”»å‡»é˜²æŠ¤

```rust
/// é˜²æ­¢ææ¡ˆè½°ç‚¸æ”»å‡»
pub struct AntiSpamMeasures<T: Config> {
    /// æ¯ä¸ªè´¦æˆ·æœ€å¤šåŒæ—¶å‘èµ·çš„ææ¡ˆæ•°
    pub max_concurrent_proposals_per_account: u32,  // 3ä¸ª

    /// ææ¡ˆä¹‹é—´çš„æœ€å°é—´éš”
    pub min_proposal_interval: T::BlockNumber,      // 7å¤©

    /// å¤±è´¥ææ¡ˆçš„æƒ©ç½šå†·å´æœŸ
    pub failure_cooldown: T::BlockNumber,           // 30å¤©

    /// æŠ¼é‡‘é€’å¢æœºåˆ¶
    pub deposit_escalation: Perbill,                // æ¯æ¬¡å¤±è´¥ææ¡ˆï¼ŒæŠ¼é‡‘å¢åŠ 20%
}

/// æ£€æŸ¥ææ¡ˆé¢‘ç‡é™åˆ¶
fn check_proposal_spam(proposer: &T::AccountId) -> DispatchResult {
    // æ£€æŸ¥åŒæ—¶å‘èµ·çš„ææ¡ˆæ•°
    let active_proposals = ActiveProposalsByAccount::<T>::get(proposer);
    ensure!(
        active_proposals.len() <= 3,
        Error::<T>::TooManyActiveProposals
    );

    // æ£€æŸ¥æœ€è¿‘ææ¡ˆé—´éš”
    if let Some(last_proposal_block) = LastProposalBlock::<T>::get(proposer) {
        let blocks_since = frame_system::Pallet::<T>::block_number() - last_proposal_block;
        ensure!(
            blocks_since >= T::MinProposalInterval::get(),
            Error::<T>::ProposalTooFrequent
        );
    }

    // æ£€æŸ¥å¤±è´¥å†·å´æœŸ
    if let Some(cooldown_until) = ProposalCooldown::<T>::get(proposer) {
        ensure!(
            frame_system::Pallet::<T>::block_number() > cooldown_until,
            Error::<T>::InCooldownPeriod
        );
    }

    Ok(())
}
```

### 3. ç´§æ€¥å®‰å…¨æœºåˆ¶

```rust
/// ç´§æ€¥æš‚åœæœºåˆ¶
#[pallet::call_index(60)]
#[pallet::weight(10_000)]
pub fn emergency_pause_governance(
    origin: OriginFor<T>,
    reason_cid: BoundedVec<u8, ConstU32<64>>,
) -> DispatchResult {
    // åªæœ‰æŠ€æœ¯å§”å‘˜ä¼šè¶…çº§å¤šæ•°ï¼ˆ5/7ï¼‰å¯ä»¥è§¦å‘
    T::TechnicalCommittee::ensure_proportion_at_least(origin, 5, 7)?;

    // æš‚åœæ‰€æœ‰è¿›è¡Œä¸­çš„æŠ•ç¥¨
    GovernancePaused::<T>::put(true);

    // è®°å½•æš‚åœåŸå› 
    PauseReason::<T>::put(reason_cid.clone());

    Self::deposit_event(Event::GovernanceEmergencyPaused { reason_cid });

    Ok(())
}

/// æ¢å¤æ²»ç†æœºåˆ¶
#[pallet::call_index(61)]
#[pallet::weight(10_000)]
pub fn resume_governance(
    origin: OriginFor<T>,
) -> DispatchResult {
    // åªæœ‰Rootæˆ–æŠ€æœ¯å§”å‘˜ä¼šå…¨ç¥¨é€šè¿‡å¯ä»¥æ¢å¤
    let origin_type = ensure_root_or_council_unanimous(origin)?;

    GovernancePaused::<T>::kill();
    PauseReason::<T>::kill();

    Self::deposit_event(Event::GovernanceResumed { by: origin_type });

    Ok(())
}
```

## ğŸ“Š å‚ä¸æ¿€åŠ±

### 1. æŠ•ç¥¨å¥–åŠ±

```rust
/// æŠ•ç¥¨å‚ä¸å¥–åŠ±
pub struct VotingRewards<T: Config> {
    /// æ¯æ¬¡æŠ•ç¥¨åŸºç¡€å¥–åŠ±
    pub base_voting_reward: BalanceOf<T>,    // 10 DUST

    /// è¿ç»­å‚ä¸å¥–åŠ±å€æ•°
    pub consecutive_bonus: Vec<Perbill>,     // [1x, 1.2x, 1.5x, 2x, 3x]

    /// æ—©æœŸæŠ•ç¥¨å¥–åŠ±ï¼ˆæŠ•ç¥¨æœŸå‰50%ï¼‰
    pub early_voting_bonus: Perbill,        // é¢å¤–20%

    /// å°‘æ•°æ´¾æ­£ç¡®é¢„æµ‹å¥–åŠ±ï¼ˆäº‹åè¯æ˜å°‘æ•°æ´¾æ˜¯å¯¹çš„ï¼‰
    pub minority_correct_bonus: BalanceOf<T>, // 50 DUST
}
```

### 2. ææ¡ˆå¥–åŠ±

```rust
/// ä¼˜è´¨ææ¡ˆå¥–åŠ±
pub struct ProposalRewards<T: Config> {
    /// é€šè¿‡ææ¡ˆå¥–åŠ±
    pub passed_proposal_reward: BalanceOf<T>,    // 1000 DUST

    /// é«˜å‚ä¸ç‡ææ¡ˆé¢å¤–å¥–åŠ±ï¼ˆå‚ä¸ç‡>50%ï¼‰
    pub high_turnout_bonus: BalanceOf<T>,        // 500 DUST

    /// å»ºè®¾æ€§ææ¡ˆå¥–åŠ±ï¼ˆæ”¹å–„ç³»ç»ŸæŒ‡æ ‡ï¼‰
    pub constructive_bonus: BalanceOf<T>,        // 2000 DUST
}
```

### 3. å§”å‘˜ä¼šå¥–åŠ±

```rust
/// æŠ€æœ¯å§”å‘˜ä¼šæˆå‘˜å¥–åŠ±
pub struct CouncilRewards<T: Config> {
    /// æœˆåº¦åŸºç¡€è–ªé…¬
    pub monthly_salary: BalanceOf<T>,            // 10,000 DUST

    /// å®¡è®®ææ¡ˆå·¥ä½œé‡å¥–åŠ±
    pub proposal_review_fee: BalanceOf<T>,       // 100 DUST/ææ¡ˆ

    /// å‡ºå¸­ç‡å¥–åŠ±ï¼ˆå‡ºå¸­ç‡>90%ï¼‰
    pub attendance_bonus: BalanceOf<T>,          // 2,000 DUST/æœˆ
}
```

## ğŸ” ç›‘æ§å’Œå®¡è®¡

### 1. é€æ˜åº¦æŠ¥å‘Š

```rust
/// æ²»ç†é€æ˜åº¦æ•°æ®
pub struct GovernanceMetrics<T: Config> {
    /// æ€»ææ¡ˆæ•°
    pub total_proposals: u64,

    /// é€šè¿‡ç‡
    pub pass_rate: Perbill,

    /// å¹³å‡å‚ä¸ç‡
    pub average_turnout: Perbill,

    /// æ´»è·ƒæŠ•ç¥¨è€…æ•°é‡
    pub active_voters: u32,

    /// å§”å‘˜ä¼šæ´»è·ƒåº¦
    pub council_activity: Perbill,
}

/// ç”Ÿæˆæœˆåº¦æ²»ç†æŠ¥å‘Š
#[pallet::call_index(70)]
#[pallet::weight(10_000)]
pub fn generate_governance_report(
    origin: OriginFor<T>,
    month: u32,
) -> DispatchResult {
    ensure_root(origin)?;

    let metrics = Self::calculate_governance_metrics(month);
    let report_cid = Self::upload_report_to_ipfs(&metrics)?;

    MonthlyReports::<T>::insert(month, report_cid.clone());

    Self::deposit_event(Event::GovernanceReportGenerated {
        month,
        report_cid,
        metrics,
    });

    Ok(())
}
```

### 2. å®æ—¶ç›‘æ§

```rust
/// æ²»ç†å¥åº·æŒ‡æ ‡
impl<T: Config> Pallet<T> {
    /// æ£€æŸ¥æ²»ç†ç³»ç»Ÿå¥åº·çŠ¶æ€
    pub fn governance_health_check() -> GovernanceHealth {
        GovernanceHealth {
            // å‚ä¸ç‡å¥åº·åº¦
            participation_health: Self::check_participation_health(),

            // ææ¡ˆè´¨é‡å¥åº·åº¦
            proposal_quality_health: Self::check_proposal_quality(),

            // å§”å‘˜ä¼šæ´»è·ƒåº¦å¥åº·åº¦
            council_activity_health: Self::check_council_activity(),

            // æŠ•ç¥¨åˆ†å¸ƒå¥åº·åº¦ï¼ˆé¿å…æåŒ–ï¼‰
            vote_distribution_health: Self::check_vote_distribution(),
        }
    }

    /// æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨å¹²é¢„
    pub fn check_auto_intervention() -> Option<InterventionType> {
        let health = Self::governance_health_check();

        // å‚ä¸ç‡è¿‡ä½ï¼ˆ<5%è¿ç»­3æ¬¡ï¼‰
        if health.participation_health == HealthStatus::Critical {
            return Some(InterventionType::BoostIncentives);
        }

        // æŠ•ç¥¨è¿‡åº¦æåŒ–ï¼ˆ90%+åŒä¸€æ–¹å‘è¿ç»­5æ¬¡ï¼‰
        if health.vote_distribution_health == HealthStatus::Critical {
            return Some(InterventionType::EncourageDebate);
        }

        // å§”å‘˜ä¼šä¸æ´»è·ƒ
        if health.council_activity_health == HealthStatus::Critical {
            return Some(InterventionType::ElectNewCouncil);
        }

        None
    }
}
```

## ğŸ“± å‰ç«¯é›†æˆ

### 1. æ²»ç†ç•Œé¢

```typescript
// æ²»ç†ä¸»é¡µç»„ä»¶
export const GovernanceDashboard: React.FC = () => {
  const [proposals, setProposals] = useState<Proposal[]>([]);
  const [userVotingPower, setUserVotingPower] = useState<VotingPower>();
  const [governanceMetrics, setGovernanceMetrics] = useState<GovernanceMetrics>();

  return (
    <div className="governance-dashboard">
      <VotingPowerCard power={userVotingPower} />
      <ActiveProposals proposals={proposals} />
      <ProposalHistory />
      <GovernanceMetrics metrics={governanceMetrics} />
      <CreateProposalButton />
    </div>
  );
};

// ææ¡ˆè¯¦æƒ…ç»„ä»¶
export const ProposalDetail: React.FC<{proposalId: number}> = ({proposalId}) => {
  return (
    <div className="proposal-detail">
      <ProposalHeader proposal={proposal} />
      <PercentageComparison
        current={currentPercentages}
        proposed={proposedPercentages}
      />
      <ImpactAnalysis proposal={proposal} />
      <VotingSection proposalId={proposalId} />
      <DiscussionSection proposalId={proposalId} />
    </div>
  );
};
```

### 2. æŠ•ç¥¨ç•Œé¢

```typescript
// æŠ•ç¥¨ç»„ä»¶
export const VotingInterface: React.FC<{proposal: Proposal}> = ({proposal}) => {
  const [vote, setVote] = useState<Vote>();
  const [conviction, setConviction] = useState<Conviction>();
  const [lockAmount, setLockAmount] = useState<string>();

  const handleVote = async () => {
    const tx = api.tx.affiliate.voteOnPercentageProposal(
      proposal.id,
      vote,
      conviction
    );

    await tx.signAndSend(userAccount, {
      nonce: -1
    });
  };

  return (
    <div className="voting-interface">
      <VoteOptions vote={vote} onChange={setVote} />
      <ConvictionSlider
        conviction={conviction}
        onChange={setConviction}
        onLockAmountChange={setLockAmount}
      />
      <VotingPowerDisplay
        basePower={basePower}
        finalPower={basePower * conviction.multiplier}
      />
      <VoteButton onClick={handleVote} />
    </div>
  );
};
```

## ğŸ¯ å®æ–½è®¡åˆ’

### Phase 1: åŸºç¡€æ²»ç†æ¡†æ¶ï¼ˆ4å‘¨ï¼‰

#### Week 1-2: æ ¸å¿ƒæ¨¡å—å¼€å‘
- [ ] æ‰©å±• `pallet-affiliate` æ·»åŠ æ²»ç†åŠŸèƒ½
- [ ] å®ç°ææ¡ˆåˆ›å»ºå’ŒéªŒè¯é€»è¾‘
- [ ] é›†æˆ `pallet-democracy` å’Œ `pallet-collective`

#### Week 3-4: æŠ•ç¥¨æœºåˆ¶
- [ ] å®ç°æƒé‡è®¡ç®—é€»è¾‘
- [ ] å¼€å‘ä¿¡å¿µæŠ•ç¥¨åŠŸèƒ½
- [ ] æ·»åŠ è‡ªåŠ¨æ‰§è¡Œæœºåˆ¶

### Phase 2: å®‰å…¨æœºåˆ¶ï¼ˆ3å‘¨ï¼‰

#### Week 5-6: å®‰å…¨é˜²æŠ¤
- [ ] å®ç°ååƒåœ¾ææ¡ˆæœºåˆ¶
- [ ] å¼€å‘ç´§æ€¥æš‚åœåŠŸèƒ½
- [ ] æ·»åŠ å‚æ•°éªŒè¯é€»è¾‘

#### Week 7: æµ‹è¯•å’Œä¼˜åŒ–
- [ ] å•å…ƒæµ‹è¯•ç¼–å†™
- [ ] å®‰å…¨å®¡è®¡
- [ ] æ€§èƒ½ä¼˜åŒ–

### Phase 3: å‰ç«¯ç•Œé¢ï¼ˆ3å‘¨ï¼‰

#### Week 8-9: æ ¸å¿ƒç•Œé¢
- [ ] æ²»ç†ä¸»é¡µå¼€å‘
- [ ] ææ¡ˆåˆ›å»ºç•Œé¢
- [ ] æŠ•ç¥¨ç•Œé¢

#### Week 10: å®Œå–„å’Œæµ‹è¯•
- [ ] ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- [ ] é›†æˆæµ‹è¯•
- [ ] æ–‡æ¡£å®Œå–„

### Phase 4: éƒ¨ç½²å’Œè¿è¥ï¼ˆ2å‘¨ï¼‰

#### Week 11: æµ‹è¯•ç½‘éƒ¨ç½²
- [ ] æµ‹è¯•ç½‘éƒ¨ç½²
- [ ] ç¤¾åŒºæµ‹è¯•
- [ ] Bugä¿®å¤

#### Week 12: ä¸»ç½‘å¯åŠ¨
- [ ] ä¸»ç½‘éƒ¨ç½²
- [ ] æ²»ç†å¯åŠ¨ä»ªå¼
- [ ] ç›‘æ§å’Œç»´æŠ¤

## ğŸ“ˆ æˆåŠŸæŒ‡æ ‡

### æŠ€æœ¯æŒ‡æ ‡
- [ ] ç³»ç»Ÿç¨³å®šæ€§ï¼š99.9%+åœ¨çº¿æ—¶é—´
- [ ] æŠ•ç¥¨å¤„ç†æ€§èƒ½ï¼š<5ç§’ç¡®è®¤æ—¶é—´
- [ ] å®‰å…¨æ€§ï¼š0ä¸ªé‡å¤§å®‰å…¨äº‹ä»¶

### ç¤¾åŒºæŒ‡æ ‡
- [ ] å‚ä¸ç‡ï¼šâ‰¥15%å¹³å‡æŠ•ç¥¨å‚ä¸ç‡
- [ ] ææ¡ˆè´¨é‡ï¼šâ‰¥70%ææ¡ˆé€šè¿‡ç‡
- [ ] ç”¨æˆ·æ»¡æ„åº¦ï¼šâ‰¥4.0/5.0è¯„åˆ†

### æ²»ç†æ•ˆæœ
- [ ] å†³ç­–æ•ˆç‡ï¼šå¹³å‡14å¤©ææ¡ˆå‘¨æœŸ
- [ ] ç¤¾åŒºå…±è¯†ï¼šâ‰¥60%æ”¯æŒç‡é€šè¿‡çš„ææ¡ˆ
- [ ] åˆ›æ–°é©±åŠ¨ï¼šæ¯æœˆâ‰¥1ä¸ªæœ‰æ•ˆæ”¹è¿›ææ¡ˆ

## ğŸ“ æ€»ç»“

æœ¬æ–¹æ¡ˆè®¾è®¡äº†ä¸€å¥—å®Œæ•´çš„å³æ—¶åˆ†æˆæ¯”ä¾‹å…¨æ°‘æŠ•ç¥¨æ²»ç†ç³»ç»Ÿï¼Œå…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹ï¼š

âœ… **æ°‘ä¸»é€æ˜**ï¼šå…¨æ°‘å‚ä¸ï¼Œæƒé‡å…¬å¹³
âœ… **å®‰å…¨å¯é **ï¼šå¤šå±‚é˜²æŠ¤ï¼Œç´§æ€¥æœºåˆ¶
âœ… **é«˜æ•ˆä¾¿æ°‘**ï¼šè‡ªåŠ¨æ‰§è¡Œï¼Œæ¿€åŠ±å‚ä¸
âœ… **æŒç»­ä¼˜åŒ–**ï¼šç›‘æ§å®¡è®¡ï¼Œè¿­ä»£æ”¹è¿›

é€šè¿‡è¿™å¥—æ²»ç†æœºåˆ¶ï¼Œç¤¾åŒºå°†èƒ½å¤Ÿæ°‘ä¸»åœ°è°ƒæ•´è”ç›Ÿè®¡é…¬æ¯”ä¾‹ï¼Œç¡®ä¿ç³»ç»Ÿçš„é•¿æœŸå¥åº·å‘å±•ã€‚

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*
*åˆ›å»ºæ—¥æœŸ: 2025-11-12*
*ç»´æŠ¤è€…: Stardustæ²»ç†å·¥ä½œç»„*