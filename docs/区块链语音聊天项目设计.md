# Stardust 区块链语音聊天项目设计文档

## 1. 背景与目标
- **业务背景**：Stardust 是基于 Substrate 的纪念公园链，已具备去中心化聊天（`pallet-chat`）与媒体/IPFS 能力，同时在 `/home/xiaodong/文档/xuanxue/yuyin` 中已经沉淀了多种语音聊天/RTC 方案（ARChatRoom、go-chat、JuggleIM SDK、StarRTC iOS & Server）。
- **建设目标**：在保留链上隐私、可审计与治理优势的前提下，引入实时语音聊天室、语音留言与语音社交玩法，形成“链上身份 + 声纹交互 + 数字纪念资产”的一体化体验。
- **落地策略**：复用成熟 RTC/IM 能力作为实时媒体层，链上记录房间状态、使用权限、资费结算与回放索引，结合 IPFS 与 `stardust-media-common` 完成语音存证。

## 2. 参考项目洞察
### 2.1 能力对比
| 项目 | 关键亮点 | 设计借鉴 |
| --- | --- | --- |
| ARChatRoom (`ARChatRoom/README.md`) | 快速上麦、场控（闭麦/抱麦/踢人）、音乐/音效、礼物、IM + RTC 双通道 | 房间/麦位状态机、礼物事件、主持人权限模型 |
| go-chat (`go-chat/README.md`) | Go + WebSocket + Kafka 分布式、语音/视频/屏幕共享、ProtoBuf 协议、WebRTC p2p | 信令/消息统一协议、流式文件传输、可水平扩展的信令层 |
| JuggleIM (`imsdka/README.md`) | 高性能 Android IM SDK，支持单聊/群聊/直播聊天室，多媒体消息 | 移动端 SDK 封装、弱网重连、离线消息缓存 |
| StarRTC iOS Demo (`starrtc-ios-demo/README.md`) | 跨端 IM + 语音直播间 + P2P 直连 + IoT 场景 | 端到端互通 Demo、轻量 Web 测试入口、纯语音直播 UI 模式 |
| StarRTC Server (`starrtc-server/README.md`) | 完整 C 语言服务端（voip/chatRoom/liveSrc/liveVdn/录制/推送等） | 自建 RTC 集群、录制/拉流、系统消息推送、可插拔部署脚本 |

### 2.2 关键结论
1. **房间/麦位/礼物是语音产品的核心元模型**（来源 ARChatRoom）。
2. **信令层需要与实时音视频解耦**，才能兼顾链上共识（参考 go-chat 的 WebSocket+Kafka）。
3. **移动端 SDK 要求弱网稳定与简易集成**（参考 JuggleIM）。
4. **大规模语音直播需要完整的服务端组件**（StarRTC Server 的 chatRoom/liveVdn 组合）。
5. **链上价值**在于鉴权、结算、审计，不直接承载实时媒体，而是记录状态、索引和经济活动。

## 3. 业务定位与用户旅程
- **角色**：普通访客、主持人/房主、纪念馆管理者、治理委员会、录音鉴定人、听众+支持者。
- **核心场景**
  1. 纪念馆语音聊天室：主持人发起，以链上逝者 ID 和凭证/门票作为准入条件。
  2. 亲友“抱麦”发言：链上投票或主持人授权发言权，语音片段记录到 IPFS 形成可验证留声。
  3. 语音留言：访客录制语音，链上保存元数据 + IPFS CID，供家属审核/收藏/NFT 化。
  4. 语音礼物/打赏：礼物模板+兑换率链上配置，实时礼物事件通知 RTC 房间，结算写入链上。
  5. 语音直播纪要：主持人可将整场语音流录制，生成与逝者档案绑定的永续回放链接。

## 4. 总体架构
```
┌─────────────────────────────────────────────────────────┐
│ Client 层：Web (React) / iOS / Android / IoT 门禁               │
│  ├─ 语音 UI（上麦、礼物、聊天室列表）                          │
│  ├─ chat-crypto / chat-cache / voice-ui 组件                   │
│  └─ 本地加密 + IndexedDB/SQLite 缓存                           │
├─────────────────────────────────────────────────────────┤
│ 实时媒体层：StarRTC Server 集群 + anyRTC/Go-RTC 服务           │
│  ├─ voipServer / chatRoomServer / liveVdnServer / videoRec     │
│  ├─ Kafka / Redis 信令（go-chat 风格）                          │
│  └─ SDK：JuggleIM(Android)、ARChatRoom(iOS/Android)            │
├─────────────────────────────────────────────────────────┤
│ 链上 & 中间层：Stardust Runtime + pallet-chat + 新 pallet-voice │
│  ├─ Pallet VoiceRoom：房间/麦位/权限/礼物账本                   │
│  ├─ Pallet Chat 复用文本/语音留言逻辑                           │
│  ├─ Pallet Stardust IPFS + media-common：CID 验证 & 元数据      │
│  └─ Off-chain Worker：房间心跳、录制校验、速率统计              │
├─────────────────────────────────────────────────────────┤
│ 存储层：IPFS Cluster + S3 归档 + 链上状态                      │
│  ├─ 实时流录制切片（StarRTC videoRec → IPFS/S3）              │
│  ├─ 语音留言文件 (AudioValidator 验证)                         │
│  └─ 链上记录：房间、礼物、权限、审计日志                        │
└─────────────────────────────────────────────────────────┘
```

## 5. 模块设计
### 5.1 客户端层
- **Web**：在 `stardust-dapp` 中新增 `features/voice-room`，复用聊天组件（`chat.ts`, `chat-crypto.ts`）并扩充为语音房间管理 UI。
- **移动端**：借用 ARChatRoom 与 JuggleIM 的 SDK 结构，分别封装 `VoiceSDK.swift`、`VoiceSDK.kt`，支持快速上麦、音效、礼物动画。
- **IoT / 门禁**：复用 StarRTC iOS Demo 中的门禁对讲 UI，允许线下纪念馆硬件接入并通过链上权限验证。

### 5.2 实时媒体 & 信令层
- **RTC 媒体**：部署 `starrtc-server` 的 `chatRoomServer + liveVdnServer + voipServer`，提供实时语音和录制；必要时接入 anyRTC 云（ARChatRoom 同源）。
- **信令总线**：借用 `go-chat` 中 Kafka + WebSocket 模式，将房间事件（上/下麦、礼物、点名）写入 Kafka；链上监听 Off-chain Worker 订阅 Kafka Topic 做稽核。
- **SDK 封装**：JuggleIM 负责移动端会话/重连；go-chat 的 ProtoBuf 消息体作为统一信令结构，新增 `contentType = 8 (VoiceRoomEvent)`。

### 5.3 链上 Pallet VoiceRoom（新增）
- **核心存储**
  - `VoiceRooms`: `RoomId -> VoiceRoomInfo`（场景、主持、容量、门票策略、录制配置）。
  - `RoomMembers`: `(RoomId, AccountId) -> MemberState`（角色、押金、麦位状态、发言次数）。
  - `RoomGifts`: `RoomId -> BoundedVec<GiftRecord>`（链上礼物账本，引用 `pallet-offering` 代币）。
  - `RoomRecordings`: `RoomId -> Vec<RecordMetadata>`（录制片段 CID、校验哈希、存储位置）。
- **主要 Extrinsic**
  1. `create_room(origin, room_params)`：创建房间并押注保证金，自动生成 off-chain room token。
  2. `update_stage(origin, room_id, action)`：主持人发起上/下麦、闭麦、踢人等操作，链上记录状态机。
  3. `submit_voice_gift(origin, room_id, gift_id, amount, metadata_cid)`：礼物结算 + 触发 Event。
  4. `recording_proof(origin, room_id, slice_id, cid, hash)`：录制完成后提交存证，关联 StarRTC videoRec 输出。
  5. `voice_message(origin, room_id, attachment_cid, duration)`：链上语音留言（复用 `pallet-chat` Voice 消息类型）。
  6. `settle_room(origin, room_id)`：关闭房间、释放押金、分配收益（主持/平台/治理）。
- **与现有 Pallet 集成**
  - `pallet-chat`: 复用消息/会话结构，voice room 聊天区即 `SessionType::VoiceRoom(room_id)`。
   - `pallet-stardust-ipfs` + `stardust-media-common`: 验证语音/录音 CID、元数据（采样率、比特率、时长、MIME）。
  - `pallet-offering`/`pallet-credit`: 用于礼物兑换、信用风控。

### 5.4 媒体存储与验证
- **实时录制**：StarRTC `videoRecServer` 输出 TS 切片 → OCW 监听 HTTP Hook → 计算 `content_hash` → 上传 IPFS/S3 → 链上 `RoomRecordings` 存证。
- **语音留言**：前端本地录制 → 使用 `stardust-media-common::AudioValidator` 验证 → 上传 IPFS → `pallet-chat` 写入 Voice 消息 → `pallet-voice-room` 建立索引。
- **媒体治理**：沿用 `docs/公共音视频媒体库…` 的治理策略，通过链上举报/冻结录音。

### 5.5 运维 & 监控
- **监控指标**：房间数量、上麦队列长度、Kafka 延迟、StarRTC CPU、链上事件延迟、IPFS 固定成功率。
- **自动化**：`scripts/` 增加 `deploy-voice-room.sh`，一键启动 RTC 集群 + Kafka + OCW。
- **告警**：链上 Off-chain Worker 检测房间超时未心跳 → 触发治理告警，避免僵尸房间占用资源。

## 6. 核心流程
### 6.1 房间创建与准入
1. **房主**：通过 DApp 选择纪念馆/逝者 ID、设置收费/免费策略、礼物分成比例 → `create_room` extrinsic。
2. **链上回执**：生成 `RoomId`、押金冻结、记录配置；同时产生 `RoomCreated` 事件。
3. **RTC 服务**：OCW 监听事件，调用 `chatRoomServer` API 创建实际房间，返回 `room_token`。
4. **准入**：用户使用链上身份签名 + 房主设置的门票（NFT、会员、一次性门票）验证后，获取 RTC token。

### 6.2 上麦/抱麦/闭麦
1. 听众在客户端发送 `request_stage`（go-chat 信令）；主持人确认后调用 `update_stage`。
2. 链上记录 `StageAction::GrantMic { slot, ttl }` 并发出事件；OCW 将事件推送至 Kafka → RTC 服务更新麦位。
3. TTL 到期或主持人闭麦，再次调用 `update_stage` 同步状态。

### 6.3 礼物与结算
1. 客户端选择礼物（参考 ARChatRoom 礼物系统），发起 `submit_voice_gift`。
2. 链上扣除用户余额/积分，写入 `RoomGifts`，Event 通知前端播放礼物动画。
3. 房间结束后 `settle_room`：根据礼物账本 + 平台抽成计算收益，写入 `pallet-finance`。

### 6.4 录制 & 回放
1. 主持人启用录制，StarRTC `videoRecServer` 生成 TS；OCW 监听 webhook。
2. 每个切片计算哈希、上传 IPFS/S3，调用 `recording_proof`，链上记录 `RecordMetadata`。
3. 前端根据链上记录拼接回放列表，尊重权限（如仅亲友可听）。

### 6.5 语音留言
1. 用户在房间外录制留言→前端调用 `AudioValidator` → 上传 IPFS。
2. 通过 `voice_message` 将留言与房间/逝者关联，链上校验 CID、采样率、长度限制。
3. 管理者审核后可 NFT 化或展示在纪念页。

## 7. 数据与合约设计
| 结构 | 字段要点 |
| --- | --- |
| `VoiceRoomInfo` | `room_id`, `deceased_id`, `owner`, `max_slots`, `entry_rule`, `pricing`, `recording_policy`, `gift_ratio`, `room_status`, `last_heartbeat` |
| `MemberState` | `role (Host/Speaker/Listener)`, `mic_slot`, `state`, `join_block`, `deposit`, `cooldown_until`, `speaking_seconds`, `infractions` |
| `GiftTemplate` | `gift_id`, `price`, `rarity`, `effects`（动画/音效），`payout_split (host/platform/charity)` |
| `GiftRecord` | `room_id`, `tx_id`, `giver`, `receiver`, `gift_id`, `amount`, `timestamp`, `memo_cid` |
| `RecordMetadata` | `room_id`, `slice_id`, `cid`, `content_hash`, `duration`, `format`, `storage_uri`, `review_state` |
| `VoiceRoomEvent` (Kafka/ProtoBuf) | `event_type`, `room_id`, `user_id`, `payload (serde_json)`，contentType=8 |

## 8. 经济与治理机制
- **费用类型**：房间押金、门票（NFT/一次性/会员）、礼物、语音留言费用、录制存储费、举报保证金。
- **激励**：
  - 房主按照礼物/门票收益获取分成。
  - 聆听者完成实名认证 + 治理任务可领取声纹徽章。
  - 录制审核员（链上角色）对 `RecordMetadata` 进行审核可获得补贴。
- **治理钩子**：
  - Pallet 设置上限（`MaxRoomsPerDeceased`, `MaxSpeakersPerRoom`, `MaxRecordingSize`）。
  - 委员会可冻结房间或强制终止。
  - 举报机制将语音片段送审，参考 `公共音视频媒体库` 治理规则。

## 9. 安全、隐私与合规
- **链上**：所有语音内容只存 CID+哈希，确保隐私；权限由链上多签/委员会审核。
- **实时服务**：StarRTC Server + go-chat 信令采用 TLS + Token；JuggleIM SDK 负责弱网重连、密钥轮换。
- **加密**：沿用 `chat-crypto.ts` E2E 模型，升级为 ECDH + KDF，语音离线文件同样加密后再上传。
- **风控**：
  - 频率限制：房间内语音留言/礼物调用同 `pallet-chat` RateLimit。
  - 反垃圾：OCW 统计麦位切换频率，异常时自动冷却。
  - 录制防篡改：`content_hash` + `IpfsHelper::validate_cid` + 多副本 Pin。
- **合规**：保留房间操作日志、上麦记录，满足取证需求；可按需开放司法访问接口。

## 10. 实施路线
1. **Phase 0 - 基线搭建（1 周）**：部署 StarRTC Server (voip/chatRoom/liveVdn/videoRec) + Kafka + IPFS Cluster；在 devnet 验证。
2. **Phase 1 - Pallet VoiceRoom（2 周）**：完成存储/Extrinsic/事件，链上单元测试≥80%，实现礼物/房间状态机。
3. **Phase 2 - 实时集成（2 周）**：
   - 前端 & 移动端集成 ARChatRoom UI、go-chat 信令、JuggleIM SDK。
   - OCW/Kafka 桥接，完成房间创建/上麦/礼物同步。
4. **Phase 3 - 媒体存证（1 周）**：接入 `stardust-media-common` 验证、录制上传与 `recording_proof`，实现回放页。
5. **Phase 4 - 经济与治理（1.5 周）**：门票/押金/分成、举报/冻结、治理面板与仪表盘。
6. **Phase 5 - 迭代优化（持续）**：输入状态、实时字幕、AI 语音摘要、声音 NFT、对 IoT 门禁的扩展。

---
**文档维护者**：区块链语音聊天专项小组  
**最后更新**：$(date +%Y-%m-%d)
