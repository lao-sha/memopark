# 委员会提案 - 更新日志

## v1.1.0 (2025-10-02) 🔥

### 🐛 Bug 修复

#### 修复重复提案错误（DuplicateProposal）

**问题**：
用户尝试提交提案时遇到 `council.DuplicateProposal` 错误，系统没有提前检查提案是否已存在。

**影响**：
- 用户体验差，需要等待交易确认后才知道提案重复
- 浪费用户时间和交易费用
- 错误提示不够友好

**修复方案**：
1. ✅ **提交前检查**：在提交提案前，自动查询链上是否已存在相同提案
2. ✅ **友好提示**：如果提案已存在，显示提案哈希并引导用户前往提案列表
3. ✅ **改进错误处理**：增强错误提示的可读性

**代码变更**：

```typescript
// 文件: CreateProposalForm.tsx

// ✅ 新增：提交前检查
const proposalHash = innerCall.method.hash.toHex()
const existingProposal = await api.query.council.proposalOf(proposalHash)

if (existingProposal.isSome) {
  // 提案已存在，显示友好提示
  Modal.warning({
    title: '提案已存在',
    content: '针对做市商 #X 的提案已存在，请前往提案列表查看并投票。'
  })
  return
}

// ✅ 改进：错误提示
catch (e: any) {
  let errorMsg = e?.message || ''
  if (errorMsg.includes('DuplicateProposal')) {
    errorMsg = '提案已存在，请勿重复提交。前往"提案列表"查看现有提案。'
  } else if (errorMsg.includes('BadOrigin')) {
    errorMsg = '权限不足，您不是委员会成员。'
  } else if (errorMsg.includes('TooManyProposals')) {
    errorMsg = '提案数量已达上限，请等待现有提案执行完毕。'
  }
  message.error('提交失败：' + errorMsg)
}
```

**改进效果**：
- ⚡ **即时反馈**：提交前就能知道提案是否重复
- 💰 **节省费用**：避免提交无效交易
- 😊 **用户友好**：清晰的错误提示和操作指引
- 🔍 **透明度**：显示提案哈希，方便用户查询

**测试场景**：
```bash
# 场景 1: 提交新提案（成功）
提交提案: 批准做市商 #5
→ 检查提案是否存在: ❌ 不存在
→ 提交交易
→ ✅ 提案已提交！

# 场景 2: 提交重复提案（阻止）
提交提案: 批准做市商 #5（已存在）
→ 检查提案是否存在: ✅ 已存在
→ ⚠️ 显示提示：提案已存在
→ ❌ 阻止提交

# 场景 3: 权限不足（友好提示）
提交提案: 批准做市商 #5（非委员会成员）
→ 提交交易
→ ❌ 权限不足，您不是委员会成员
```

---

### 📚 新增文档

#### 委员会提案常见问题.md

**内容**：
- ✅ DuplicateProposal 错误排查
- ✅ BadOrigin 错误解决
- ✅ 投票未更新问题
- ✅ 执行提案失败原因
- ✅ 调试技巧和日志分析

**路径**：`docs/委员会提案常见问题.md`

---

### 🎯 改进细节

#### 1. 提案唯一性检查

**实现**：
```typescript
// 计算提案哈希
const proposalHash = innerCall.method.hash.toHex()

// 查询是否已存在
const existingProposal = await api.query.council.proposalOf(proposalHash)

if (existingProposal.isSome) {
  // 提案已存在
}
```

**说明**：
- 提案哈希由调用内容决定（pallet.method + args）
- 相同的 `marketMaker.approve(5)` 只能存在一个提案
- 不同的参数（如 `approve(6)`）可以共存

#### 2. 错误信息优化

**改进前**：
```
提交失败：council.DuplicateProposal: Duplicate proposals not allowed
```

**改进后**：
```
提交失败：提案已存在，请勿重复提交。前往"提案列表"查看现有提案。
```

**支持的错误类型**：
- `DuplicateProposal` → "提案已存在..."
- `BadOrigin` → "权限不足，您不是委员会成员"
- `TooManyProposals` → "提案数量已达上限..."

#### 3. 用户引导

**改进**：
- 显示提案哈希（可复制）
- 提供操作建议（前往提案列表）
- 清晰的错误原因说明

**示例提示**：
```
⚠️ 提案已存在

针对做市商 #5 的批准提案已存在。

提案哈希: 0xabcd1234567890...

请前往"提案列表"查看并投票，无需重复提交。
```

---

## v1.0.0 (2025-10-02)

### ✨ 初始发布

#### 核心功能

1. **提案管理页面** (`#/gov/council-proposals`)
   - ✅ 提交提案（批准/驳回做市商）
   - ✅ 提案列表（实时投票进度）
   - ✅ 投票操作（赞成/反对）
   - ✅ 执行提案（达到阈值后）
   - ✅ 我的投票记录

2. **做市商审核页面** (`#/gov/mm-review`)
   - ✅ 待审核申请列表
   - ✅ 已批准做市商列表
   - ✅ 申请详情查看
   - ✅ 链接到委员会提案管理

3. **治理流程**
   - ✅ 提交提案 → 投票 → 执行
   - ✅ 2/3 多数决策机制
   - ✅ Root 紧急通道

#### 技术特性

- ✅ React 18 + TypeScript
- ✅ Ant Design 5
- ✅ Polkadot.js API
- ✅ 全局链上直连
- ✅ 本地钱包签名
- ✅ 移动端优先设计
- ✅ 组件化架构

#### 文档

- ✅ 委员会提案使用指南
- ✅ 委员会提案快速开始
- ✅ 委员会提案实现说明
- ✅ 委员会提案总结

---

## 升级指南

### 从 v1.0.0 升级到 v1.1.0

**步骤**：
1. 拉取最新代码
2. 无需数据库迁移
3. 无需配置更改
4. 前端自动生效

**变更**：
- ✅ 向后兼容
- ✅ 无破坏性更改
- ✅ 自动检查机制

**测试**：
```bash
# 1. 尝试提交新提案（应该成功）
#/gov/council-proposals → 提交提案 → 选择新申请

# 2. 尝试提交重复提案（应该被阻止）
#/gov/council-proposals → 提交提案 → 选择已有提案的申请
→ 应显示"提案已存在"提示
```

---

## 已知问题

### 无（v1.1.0）

所有已知问题已修复。

---

## 路线图

### v1.2.0 (计划中)

**通知系统**：
- [ ] 新提案通知
- [ ] 投票达到阈值通知
- [ ] 提案执行结果通知

**批量操作**：
- [ ] 批量批准多个申请
- [ ] 批量投票

**历史记录**：
- [ ] 已执行提案列表
- [ ] 委员会投票统计
- [ ] 做市商审批历史

### v2.0.0 (计划中)

**集成 Subsquid**：
- [ ] 索引提案数据
- [ ] 高级搜索和筛选
- [ ] 实时事件推送

**治理增强**：
- [ ] 投票期限设置
- [ ] 提案撤销机制
- [ ] 委员会成员权重
- [ ] 多阶段审批流程

---

## 贡献者

- **开发者**: Claude (AI Assistant)
- **审核者**: 项目团队
- **测试者**: 委员会成员

---

## 相关链接

- [委员会提案使用指南](./委员会提案使用指南.md)
- [委员会提案快速开始](./委员会提案快速开始.md)
- [委员会提案实现说明](./委员会提案实现说明.md)
- [委员会提案常见问题](./委员会提案常见问题.md)

---

**维护者**: Memopark 团队  
**最后更新**: 2025-10-02  
**当前版本**: v1.1.0

