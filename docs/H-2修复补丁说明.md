# H-2: otc-order è‡ªåŠ¨æ¸…ç†é€»è¾‘ä¿®å¤

## é—®é¢˜æè¿°

å½“å‰æ¸…ç†é€»è¾‘åŸºäº `created_at`ï¼Œå¯èƒ½è¯¯åˆ é•¿æœŸäº‰è®®ååˆšè§£å†³çš„è®¢å•ã€‚

## ä¿®å¤æ–¹æ¡ˆ

### 1. æ·»åŠ  `completed_at` å­—æ®µï¼ˆå·²å®Œæˆï¼‰

```rust
pub struct Order<AccountId, Balance, Moment> {
    // ... ç°æœ‰å­—æ®µ
    
    /// ğŸ†• H-2ä¿®å¤ï¼šè®¢å•å®Œæˆæ—¶é—´ï¼ˆUnixæ—¶é—´æˆ³ï¼Œæ¯«ç§’ï¼‰
    pub completed_at: Option<Moment>,
}
```

### 2. åœ¨çŠ¶æ€å˜æ›´ä¸ºç»ˆæ€æ—¶è®¾ç½® `completed_at`

éœ€è¦åœ¨ä»¥ä¸‹ä½ç½®æ·»åŠ ï¼š

#### ä½ç½®1: `release_memo` - é‡Šæ”¾ DUSTï¼ˆçŠ¶æ€ -> Releasedï¼‰
```rust
// æ–‡ä»¶ï¼špallets/otc-order/src/lib.rs
// æœç´¢ï¼šstate: OrderState::Released
// æ·»åŠ ï¼š
ord.completed_at = Some(<pallet_timestamp::Pallet<T>>::get());
```

#### ä½ç½®2: `refund_buyer` - é€€æ¬¾ï¼ˆçŠ¶æ€ -> Refundedï¼‰
```rust
// æœç´¢ï¼šstate: OrderState::Refunded  
// æ·»åŠ ï¼š
ord.completed_at = Some(<pallet_timestamp::Pallet<T>>::get());
```

#### ä½ç½®3: `cancel_order` - å–æ¶ˆï¼ˆçŠ¶æ€ -> Canceledï¼‰
```rust
// æœç´¢ï¼šstate: OrderState::Canceled
// æ·»åŠ ï¼š
ord.completed_at = Some(<pallet_timestamp::Pallet<T>>::get());
```

#### ä½ç½®4: `on_finalize` - åˆ°æœŸå¤„ç†ï¼ˆçŠ¶æ€ -> Closedï¼‰
```rust
// æœç´¢ï¼šstate: OrderState::Closed
// æ·»åŠ ï¼š
ord.completed_at = Some(<pallet_timestamp::Pallet<T>>::get());
```

### 3. ä¿®æ”¹æ¸…ç†é€»è¾‘

```rust
// æ–‡ä»¶ï¼špallets/otc-order/src/lib.rs
// on_finalize ä¸­çš„æ¸…ç†é€»è¾‘

// âŒ æ—§ç‰ˆæœ¬ï¼ˆåŸºäº created_atï¼‰
let age_ms = now.saturating_sub(order.created_at);

// âœ… æ–°ç‰ˆæœ¬ï¼ˆåŸºäº completed_atï¼‰
if let Some(completed_at) = order.completed_at {
    let age_ms = now.saturating_sub(completed_at);
    let threshold_ms = config.threshold_days as u64 * 24 * 3600 * 1000;
    let grace_ms = config.grace_period_days as u64 * 24 * 3600 * 1000;
    
    // ç»ˆæ€ + è¶…è¿‡é˜ˆå€¼ + è¶…è¿‡å®½é™æœŸ
    if Self::is_terminal_state(&order.state) && 
       age_ms > threshold_ms + grace_ms {
        Orders::<T>::remove(order_id);
        cleaned = cleaned.saturating_add(1);
    }
} else {
    // æœªå®Œæˆçš„è®¢å•ä¸æ¸…ç†
    continue;
}

// è¾…åŠ©å‡½æ•°
fn is_terminal_state(state: &OrderState) -> bool {
    matches!(state, 
        OrderState::Released | 
        OrderState::Refunded | 
        OrderState::Canceled | 
        OrderState::Closed
    )
}
```

### 4. æ·»åŠ é…ç½®é¡¹

```rust
// runtime/src/configs/mod.rs

// æ·»åŠ å®½é™æœŸé…ç½®ï¼ˆä»completed_atç®—èµ·ï¼‰
parameter_types! {
    pub const ArchiveGracePeriodDays: u32 = 30;  // å®Œæˆå30å¤©å®½é™æœŸ
}

impl pallet_otc_order::Config for Runtime {
    // ... ç°æœ‰é…ç½®
    type ArchiveGracePeriodDays = ArchiveGracePeriodDays;
}
```

## æ‰§è¡Œæ­¥éª¤

1. âœ… æ·»åŠ  `completed_at` å­—æ®µåˆ° `Order` ç»“æ„
2. â³ åœ¨æ‰€æœ‰çŠ¶æ€å˜æ›´ä¸ºç»ˆæ€çš„åœ°æ–¹è®¾ç½® `completed_at`ï¼ˆéœ€è¦æ‰‹åŠ¨æŸ¥æ‰¾æ‰€æœ‰ä½ç½®ï¼‰
3. â³ ä¿®æ”¹æ¸…ç†é€»è¾‘åŸºäº `completed_at`
4. â³ æ·»åŠ å®½é™æœŸé…ç½®
5. â³ è¿è¡Œæµ‹è¯•éªŒè¯

## æ³¨æ„äº‹é¡¹

- **ç ´åæ€§å˜æ›´**ï¼šç”±äº `Order` ç»“æ„å˜æ›´ï¼Œéœ€è¦æ•°æ®è¿ç§»
- **ä¸»ç½‘æœªä¸Šçº¿**ï¼šå¯ä»¥ç›´æ¥ä¿®æ”¹ï¼Œæ— éœ€è¿ç§»é€»è¾‘
- **æµ‹è¯•è¦ç‚¹**ï¼š
  - é•¿æœŸäº‰è®®è®¢å•ä¸åº”è¢«è¯¯åˆ 
  - æ­£å¸¸å®Œæˆè®¢å•åœ¨å®½é™æœŸåæ­£ç¡®æ¸…ç†
  - æœªå®Œæˆè®¢å•æ°¸ä¸æ¸…ç†

## çŠ¶æ€

- [x] å­—æ®µæ·»åŠ 
- [ ] çŠ¶æ€å˜æ›´ç‚¹ä¿®æ”¹ï¼ˆéœ€è¦äººå·¥å®¡æŸ¥ä»£ç ï¼‰
- [ ] æ¸…ç†é€»è¾‘ä¿®æ”¹
- [ ] æµ‹è¯•éªŒè¯

**ç”±äº otc-order pallet ä»£ç è¶…è¿‡1700è¡Œï¼Œå»ºè®®äººå·¥å®¡æŸ¥æ‰€æœ‰çŠ¶æ€å˜æ›´ç‚¹ç¡®ä¿å®Œæ•´æ€§ã€‚**

