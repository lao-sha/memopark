# 链上数据面板功能实现说明

## 功能概述

在"我的钱包"页面的菜单项中,在"系统消息"上方插入了"链上数据面板"入口,用户点击后可以查看实时的链上数据信息。

## 实现位置

- **文件**: `/home/xiaodong/文档/memopark/memopark-dapp/src/features/profile/MyWalletPage.tsx`
- **功能**: 链上数据查询和展示

## 功能特性

### 1. 菜单入口
- 在"我的钱包"页面的菜单列表中,位于"公告"和"系统消息"之间
- 使用 `DashboardOutlined` 图标
- 点击后弹出链上数据面板弹窗

### 2. 链上数据面板
面板分为四个主要部分:

#### (1) 链信息
- 链名称 (Chain Name)
- 链版本 (Chain Version / Spec Version)
- 代币符号 (Token Symbol)
- 代币精度 (Token Decimals)

#### (2) 区块信息
- 当前区块高度 (Block Number)
- 当前区块哈希 (Block Hash,缩略显示)

#### (3) 节点信息
- 节点名称 (Node Name)
- 节点版本 (Node Version)

#### (4) 当前账户信息
- 账户地址 (完整地址)
- 可用余额 (Free Balance)
- 保留余额 (Reserved Balance)
- 交易计数 (Nonce)

### 3. 交互功能
- **自动加载**: 打开弹窗时自动加载链上数据
- **手动刷新**: 弹窗标题栏右侧有"刷新"按钮,可以手动更新数据
- **加载状态**: 显示加载动画和提示文字
- **错误处理**: 加载失败时显示错误提示

## 实现细节

### 状态管理
```typescript
const [chainDataModalVisible, setChainDataModalVisible] = useState<boolean>(false);
const [chainDataLoading, setChainDataLoading] = useState<boolean>(false);
const [chainData, setChainData] = useState<any>(null);
```

### 核心函数

#### 1. `handleShowChainData()`
- 打开链上数据面板弹窗
- 触发数据加载

#### 2. `loadChainData()`
- 通过 `getApi()` 获取 Polkadot API 实例
- 查询链基本信息:
  - `api.runtimeChain` - 链名称
  - `api.runtimeVersion.specVersion` - 链版本
  - `api.registry.chainTokens[0]` - 代币符号
  - `api.registry.chainDecimals[0]` - 代币精度
- 查询区块信息:
  - `api.rpc.chain.getHeader()` - 获取当前区块头
- 查询节点信息:
  - `api.rpc.system.name()` - 节点名称
  - `api.rpc.system.version()` - 节点版本
- 查询账户信息:
  - `api.query.system.account(address)` - 账户数据
  - 解析 `free`, `reserved`, `nonce` 字段
  - 使用 `BigInt` 进行余额转换

#### 3. `handleCloseChainData()`
- 关闭链上数据面板弹窗

### UI 设计

#### 布局结构
- **弹窗宽度**: 680px
- **居中显示**: `centered={true}`
- **无底部按钮**: `footer={null}`
- **分区展示**: 每个数据区块使用独立的卡片样式

#### 样式设计
- **链信息**: 紫色渐变背景 (`linear-gradient(135deg, #667eea15 0%, #764ba215 100%)`)
- **区块/节点信息**: 浅灰色背景 (`#f9f9f9`)
- **账户信息**: 浅紫色渐变背景 (`linear-gradient(135deg, #667eea10 0%, #764ba210 100%)`)
- **可用余额**: 紫色高亮显示 (`color: #667eea`)
- **地址和哈希**: 使用等宽字体 (`fontFamily: 'monospace'`)

#### 交互反馈
- **加载状态**: `Spin` 组件 + "加载链上数据中..." 提示
- **空数据**: "暂无数据" 提示
- **提示信息**: 蓝色背景的使用提示框

## 使用 Ant Design 组件

- `Modal` - 弹窗容器
- `Button` - 刷新按钮
- `Spin` - 加载动画
- `Descriptions` - 描述列表,用于展示键值对数据
- `Text` - 文本组件
- `DashboardOutlined` - 仪表盘图标
- `ReloadOutlined` - 刷新图标

## 数据精度处理

对于账户余额数据,使用 `BigInt` 进行精确计算:

```typescript
const free = account?.data?.free?.toString() || '0';
const chainDecimals = api.registry.chainDecimals?.[0] || 12;

// 转换为可读的代币数量
const freeBalance = (BigInt(free) / BigInt(10 ** chainDecimals)).toString();
```

## 错误处理

- 使用 `try-catch` 捕获异常
- 失败时通过 `message.error()` 显示用户友好的错误提示
- 控制台输出详细错误信息便于调试

## UI 风格一致性

- 与"我的钱包"页面的整体风格保持一致
- 使用相同的紫色渐变主题 (`#667eea` 到 `#764ba2`)
- 圆角、边框、间距等细节统一
- 响应式布局,适配移动端和桌面端

## 可扩展性

当前实现的链上数据面板可以轻松扩展以支持更多数据:

1. **添加更多链数据**:
   - 总发行量 (Total Issuance)
   - 质押信息 (Staking Info)
   - 治理提案数量 (Governance Proposals)

2. **添加账户详细信息**:
   - 质押余额 (Staked Balance)
   - 锁定余额 (Locked Balance)
   - 身份信息 (Identity)

3. **实时更新**:
   - 可以添加自动刷新功能
   - 使用 WebSocket 订阅链上事件

4. **图表展示**:
   - 集成图表库展示历史数据
   - 余额变化趋势
   - 交易活动统计

## 注意事项

1. **API 兼容性**: 确保 Polkadot API 已正确初始化和连接
2. **性能考虑**: 链上查询可能耗时,使用加载状态提升用户体验
3. **错误处理**: 网络问题或节点不可用时提供友好的错误提示
4. **数据精度**: 使用 `BigInt` 避免大数计算精度丢失

## 测试建议

1. **功能测试**:
   - 点击"链上数据面板"菜单项是否正确打开弹窗
   - 数据加载是否正常显示
   - 刷新按钮是否工作正常
   - 关闭弹窗是否正常

2. **边界测试**:
   - 节点断开连接时的错误处理
   - 账户未登录时的显示
   - 大数值的正确显示

3. **UI 测试**:
   - 不同屏幕尺寸下的布局
   - 加载状态的动画效果
   - 文字缩略是否正确(如区块哈希)

## 总结

链上数据面板功能为用户提供了一个便捷的方式查看实时的链上信息,包括链的基本信息、区块信息、节点信息和当前账户的详细数据。该功能实现了:

- ✅ 完整的链上数据查询
- ✅ 清晰的数据分类展示
- ✅ 友好的交互体验
- ✅ 统一的 UI 设计风格
- ✅ 良好的错误处理
- ✅ 可扩展的架构设计

该功能已成功构建并集成到"我的钱包"页面中,用户可以随时查看链的实时状态。

