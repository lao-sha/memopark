# æŠ•è¯‰ç”³è¯‰æ²»ç† - å•å…ƒæµ‹è¯•å¿«é€Ÿå¼€å§‹

> **å¿«é€Ÿå¯åŠ¨å•å…ƒæµ‹è¯•çš„å®ç”¨æŒ‡å—**

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1ï¸âƒ£ è¿è¡Œæ‰€æœ‰æµ‹è¯•

```bash
# é¡¹ç›®æ ¹ç›®å½•
cd /home/xiaodong/æ–‡æ¡£/stardust

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
cargo test --all

# ä»…è¿è¡ŒæŠ•è¯‰ç”³è¯‰ç›¸å…³æµ‹è¯•
cargo test -p pallet-stardust-appeals
```

---

### 2ï¸âƒ£ è¿è¡ŒRuntimeé…ç½®æµ‹è¯•

```bash
# è¿›å…¥runtimeç›®å½•
cd runtime

# è¿è¡Œæµ‹è¯•ï¼ˆéœ€è¦runtime-benchmarksç‰¹æ€§ï¼‰
cargo test --features runtime-benchmarks

# ä»…è¿è¡Œé…ç½®æµ‹è¯•
cargo test --features runtime-benchmarks mod_tests
```

**é¢„æœŸè¾“å‡º**:
```
running 13 tests
test configs::mod_tests::test_dynamic_deposit_basic ... ok
test configs::mod_tests::test_deposit_multiplier_1x ... ok
test configs::mod_tests::test_deposit_multiplier_1_5x ... ok
test configs::mod_tests::test_deposit_multiplier_2x ... ok
test configs::mod_tests::test_deposit_unsupported_domain ... ok
test configs::mod_tests::test_deposit_minimum_limit ... ok
test configs::mod_tests::test_deposit_maximum_limit ... ok
test configs::mod_tests::test_last_active_deceased_domain ... ok
test configs::mod_tests::test_last_active_unsupported_domain ... ok
test configs::mod_tests::test_router_otc_domain ... ok
test configs::mod_tests::test_router_bridge_domain ... ok
test configs::mod_tests::test_deposit_calculation_consistency ... ok
test configs::mod_tests::test_different_actions_different_deposits ... ok

test result: ok. 13 passed; 0 failed
```

---

### 3ï¸âƒ£ è¿è¡ŒåŠ¨æ€æŠ¼é‡‘æµ‹è¯•

```bash
# è¿›å…¥stardust-appeals palletç›®å½•
cd pallets/stardust-appeals

# è¿è¡ŒåŠ¨æ€æŠ¼é‡‘æµ‹è¯•
cargo test tests_deposit

# è¿è¡Œç‰¹å®šæµ‹è¯•
cargo test test_submit_appeal_with_dynamic_deposit
```

**é¢„æœŸè¾“å‡º**:
```
running 5 tests
test tests_deposit::test_submit_appeal_with_fallback_deposit ... ok
test tests_deposit::test_submit_appeal_with_dynamic_deposit ... ok
test tests_deposit::test_deposit_multiplier_affects_amount ... ok
test tests_deposit::test_submit_appeal_insufficient_balance ... ok
test tests_deposit::test_withdraw_appeal_slash_deposit ... ok

test result: ok. 5 passed; 0 failed
```

---

### 4ï¸âƒ£ è¿è¡Œåº”ç­”å¦å†³æµ‹è¯•

```bash
# åœ¨stardust-appeals palletç›®å½•
cd pallets/stardust-appeals

# è¿è¡Œåº”ç­”å¦å†³æµ‹è¯•
cargo test tests_last_active

# è¿è¡Œç‰¹å®šæµ‹è¯•
cargo test test_auto_dismiss_with_owner_response
```

**é¢„æœŸè¾“å‡º**:
```
running 4 tests
test tests_last_active::test_auto_dismiss_with_owner_response ... ok
test tests_last_active::test_no_auto_dismiss_for_unsupported_domain ... ok
test tests_last_active::test_no_auto_dismiss_if_active_before_approval ... ok
test tests_last_active::test_no_auto_dismiss_if_active_after_execution ... ok

test result: ok. 4 passed; 0 failed
```

---

## ğŸ” æµ‹è¯•è¯¦ç»†è¾“å‡º

### æŸ¥çœ‹è¯¦ç»†æ—¥å¿—

```bash
# æ˜¾ç¤ºæµ‹è¯•è¾“å‡ºï¼ˆåŒ…æ‹¬println!ï¼‰
cargo test -- --nocapture

# æ˜¾ç¤ºè¯¦ç»†æµ‹è¯•åç§°
cargo test -- --show-output

# è¿è¡Œå•ä¸ªæµ‹è¯•å¹¶æŸ¥çœ‹è¯¦ç»†è¾“å‡º
cargo test test_dynamic_deposit_basic -- --nocapture --show-output
```

### ç¤ºä¾‹è¾“å‡º

```
test result: ok
æŠ¼é‡‘è®¡ç®—è¯¦æƒ…ï¼š
  Domain: 3 (deceased-text)
  Action: 22 (ç¼–è¾‘æ–‡æœ¬)
  Multiplier: 1x
  Base USD: $10
  DUST Price: $0.001
  Calculated Deposit: 10,000 DUST
  After Limits: 10,000 DUST (åœ¨[1, 100,000]èŒƒå›´å†…)
```

---

## ğŸ“Š æµ‹è¯•è¦†ç›–ç‡

### å®‰è£…Tarpaulin

```bash
cargo install cargo-tarpaulin
```

### ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š

```bash
# é¡¹ç›®æ ¹ç›®å½•
cd /home/xiaodong/æ–‡æ¡£/stardust

# ç”ŸæˆHTMLè¦†ç›–ç‡æŠ¥å‘Š
cargo tarpaulin --out Html --output-dir ./coverage

# ç”Ÿæˆæ§åˆ¶å°è¦†ç›–ç‡æŠ¥å‘Š
cargo tarpaulin

# ä»…æµ‹è¯•ç‰¹å®šåŒ…
cargo tarpaulin -p pallet-stardust-appeals --out Html
```

### æŸ¥çœ‹æŠ¥å‘Š

```bash
# æ‰“å¼€HTMLæŠ¥å‘Š
xdg-open ./coverage/index.html

# æˆ–ä½¿ç”¨æµè§ˆå™¨
firefox ./coverage/index.html
```

**é¢„æœŸè¦†ç›–ç‡**:
```
|| Tested/Total Lines:
|| pallets/stardust-appeals/src/lib.rs: 245/280 (87.5%)
|| runtime/src/configs/mod.rs: 180/210 (85.7%)
|| 
|| Total Coverage: 84.2%
```

---

## ğŸ› è°ƒè¯•æµ‹è¯•

### è¿è¡Œå¤±è´¥çš„æµ‹è¯•

```bash
# ä»…è¿è¡Œå¤±è´¥çš„æµ‹è¯•
cargo test -- --test-threads=1

# æ˜¾ç¤ºbacktrace
RUST_BACKTRACE=1 cargo test
RUST_BACKTRACE=full cargo test

# ç»„åˆä½¿ç”¨
RUST_BACKTRACE=1 cargo test test_submit_appeal_with_dynamic_deposit -- --nocapture
```

### æµ‹è¯•ç‰¹å®šåœºæ™¯

```rust
// åœ¨æµ‹è¯•æ–‡ä»¶ä¸­æ·»åŠ è°ƒè¯•ä»£ç 
#[test]
fn test_debug_deposit() {
    new_test_ext().execute_with(|| {
        let deposit = ContentAppealDepositPolicy::calc_deposit(&who, 3, 1, 22);
        println!("è®¡ç®—çš„æŠ¼é‡‘: {:?}", deposit);
        
        // æ·»åŠ æ–­ç‚¹
        dbg!(deposit);
        
        assert!(deposit.is_some());
    });
}
```

---

## ğŸ¯ å¸¸è§é—®é¢˜æ’æŸ¥

### Q1: ç¼–è¯‘é”™è¯¯ - "cannot find value `UNIT`"

**è§£å†³æ–¹æ¡ˆ**:
```rust
// ç¡®ä¿åœ¨æµ‹è¯•æ–‡ä»¶é¡¶éƒ¨å¯¼å…¥
use crate::mock::*;

// æˆ–ç›´æ¥å®šä¹‰
const UNIT: u128 = 1_000_000_000_000; // 12ä½å°æ•°
```

---

### Q2: æµ‹è¯•å¤±è´¥ - "assertion failed"

**è§£å†³æ–¹æ¡ˆ**:
```bash
# æŸ¥çœ‹è¯¦ç»†è¾“å‡º
cargo test test_name -- --nocapture

# æ£€æŸ¥æµ‹è¯•æ—¥å¿—
cargo test 2>&1 | tee test.log
```

---

### Q3: Runtimeæµ‹è¯•æ‰¾ä¸åˆ°ç‰¹æ€§

**è§£å†³æ–¹æ¡ˆ**:
```bash
# ç¡®ä¿å¯ç”¨runtime-benchmarksç‰¹æ€§
cargo test --features runtime-benchmarks

# æˆ–åœ¨Cargo.tomlä¸­æ·»åŠ 
[dev-dependencies]
# ... ä¾èµ–
```

---

### Q4: æµ‹è¯•è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å¢åŠ è¶…æ—¶æ—¶é—´
cargo test -- --test-threads=1 --nocapture

# æˆ–å‡å°‘æµ‹è¯•æ•°æ®é‡
```

---

## ğŸ“ æ·»åŠ æ–°æµ‹è¯•ç”¨ä¾‹

### æ¨¡æ¿ä»£ç 

```rust
#[test]
fn test_your_feature() {
    new_test_ext().execute_with(|| {
        // 1. è®¾ç½®æµ‹è¯•ç¯å¢ƒ
        System::set_block_number(1);
        let who = account(1);
        let _ = Balances::deposit_creating(&who, 1000 * UNIT);
        
        // 2. æ‰§è¡Œæ“ä½œ
        assert_ok!(YourPallet::your_function(
            RuntimeOrigin::signed(who),
            // ... å‚æ•°
        ));
        
        // 3. éªŒè¯ç»“æœ
        let result = YourStorage::<Test>::get(key).unwrap();
        assert_eq!(result.field, expected_value);
        
        // 4. éªŒè¯äº‹ä»¶
        System::assert_has_event(
            Event::YourEvent { ... }.into()
        );
    });
}
```

---

## ğŸ”„ æŒç»­é›†æˆ

### GitHub Actionsé…ç½®

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          
      - name: Run tests
        run: cargo test --all --features runtime-benchmarks
        
      - name: Generate coverage
        run: |
          cargo install cargo-tarpaulin
          cargo tarpaulin --out Xml
          
      - name: Upload coverage
        uses: codecov/codecov-action@v3
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Phase 1.5 å•å…ƒæµ‹è¯•å®ŒæˆæŠ¥å‘Š](./æŠ•è¯‰ç”³è¯‰æ²»ç†-Phase1.5å•å…ƒæµ‹è¯•å®ŒæˆæŠ¥å‘Š.md)
- [æ•´ä½“æ–¹æ¡ˆè®¾è®¡](./æŠ•è¯‰ç”³è¯‰æ²»ç†-æ•´ä½“æ–¹æ¡ˆè®¾è®¡.md)
- [å¿«é€Ÿå®æ–½æŒ‡å—](./æŠ•è¯‰ç”³è¯‰æ²»ç†-å¿«é€Ÿå®æ–½æŒ‡å—.md)

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

è¿è¡Œæµ‹è¯•å‰ï¼Œè¯·ç¡®ä¿ï¼š

- [ ] å·²å®‰è£…Rustå·¥å…·é“¾ï¼ˆæ¨ènightlyï¼‰
- [ ] å·²ç¼–è¯‘é€šè¿‡é¡¹ç›®ï¼ˆ`cargo build`ï¼‰
- [ ] å·²å®‰è£…æµ‹è¯•ä¾èµ–ï¼ˆ`cargo test --help`å¯è¿è¡Œï¼‰
- [ ] Runtimeæµ‹è¯•å¯ç”¨äº†`runtime-benchmarks`ç‰¹æ€§
- [ ] æœ‰è¶³å¤Ÿçš„ç£ç›˜ç©ºé—´ï¼ˆæµ‹è¯•ä¼šç”Ÿæˆä¸´æ—¶æ–‡ä»¶ï¼‰

è¿è¡Œæµ‹è¯•åï¼Œè¯·éªŒè¯ï¼š

- [ ] æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ˆ0 failedï¼‰
- [ ] è¦†ç›–ç‡è¾¾æ ‡ï¼ˆ>80%ï¼‰
- [ ] æ— linterè­¦å‘Š
- [ ] æ–‡æ¡£åŒæ­¥æ›´æ–°

---

**Happy Testing! ğŸ‰**

