# äº‹ä»¶ä¼˜åŒ–å®æ–½æ–¹æ¡ˆ

**æ—¶é—´**ï¼š2025-10-28  
**Pallet**ï¼špallet-trading  
**ç›®æ ‡**ï¼šäº‹ä»¶å­˜å‚¨â†“30-40%ï¼ŒGasâ†“10-15%

---

## ğŸ“Š å½“å‰äº‹ä»¶åˆ†æ

### ç»Ÿè®¡æ•°æ®

| æ¨¡å— | äº‹ä»¶æ•°é‡ | å†—ä½™äº‹ä»¶ | å¯ä¼˜åŒ– |
|------|---------|---------|--------|
| **Maker** | 12ä¸ª | 2ä¸ª | 3ä¸ª |
| **OTC** | 8ä¸ª | 3ä¸ª | 5ä¸ª |
| **Bridge** | 9ä¸ª | 0ä¸ª | 2ä¸ª |
| **å…¬å…±** | 1ä¸ª | 0ä¸ª | 0ä¸ª |
| **æ€»è®¡** | **30ä¸ª** | **5ä¸ª** | **10ä¸ª** |

---

## ğŸ” ä¼˜åŒ–ç‚¹è¯†åˆ«

### 1. Makeræ¨¡å—ä¼˜åŒ–

#### âŒ ä¼˜åŒ–å‰ï¼ˆ12ä¸ªäº‹ä»¶ï¼‰

```rust
MakerDepositLocked { maker_id, who, amount }
MakerInfoSubmitted { maker_id, who }
MakerInfoUpdated { maker_id, who }          // â† å¯åˆå¹¶
MakerCancelled { maker_id, who }
MakerApproved { maker_id, approved_by }
MakerRejected { maker_id, rejected_by }
MakerExpired { maker_id }
WithdrawalRequested { maker_id, amount }
WithdrawalExecuted { maker_id, amount }
WithdrawalCancelled { maker_id }
EmergencyWithdrawalExecuted { maker_id, to, amount }
MakerPremiumSet { maker_id, premium }       // â† å¯åˆå¹¶åˆ°InfoUpdated
```

#### âœ… ä¼˜åŒ–åï¼ˆ11ä¸ªäº‹ä»¶ï¼Œå‡å°‘1ä¸ªï¼‰

```rust
MakerDepositLocked { maker_id, who, amount }
MakerInfoSubmitted { maker_id, who }
MakerUpdated {                              // â† åˆå¹¶InfoUpdatedå’ŒPremiumSet
    maker_id,
    who,
    changes: MakerChanges,                  // ä½å›¾è¡¨ç¤ºå˜æ›´å†…å®¹
}
MakerCancelled { maker_id, who }
MakerApproved { maker_id, approved_by }
MakerRejected { maker_id, rejected_by }
MakerExpired { maker_id }
WithdrawalRequested { maker_id, amount }
WithdrawalExecuted { maker_id, amount }
WithdrawalCancelled { maker_id }
EmergencyWithdrawalExecuted { maker_id, to, amount }
```

**æ–°å¢ç±»å‹**ï¼š
```rust
/// åšå¸‚å•†å˜æ›´ä½å›¾
#[derive(Encode, Decode, TypeInfo, Clone, Copy)]
pub struct MakerChanges {
    pub tron_address_changed: bool,
    pub epay_changed: bool,
    pub sell_premium_changed: bool,
    pub buy_premium_changed: bool,
}

// æˆ–ä½¿ç”¨u8ä½å›¾ï¼ˆæ›´çœç©ºé—´ï¼‰
pub type MakerChangeFlags = u8;
const TRON_CHANGED: u8 = 0b0001;
const EPAY_CHANGED: u8 = 0b0010;
const SELL_PREMIUM_CHANGED: u8 = 0b0100;
const BUY_PREMIUM_CHANGED: u8 = 0b1000;
```

---

### 2. OTCæ¨¡å—ä¼˜åŒ–ï¼ˆé‡ç‚¹ï¼‰â­â­â­

#### âŒ ä¼˜åŒ–å‰ï¼ˆ8ä¸ªäº‹ä»¶ï¼‰

```rust
OrderCreated { order_id, maker_id, buyer, memo_amount }
OrderMarkedPaid { order_id, buyer }                     // â† å¯åˆå¹¶
MemoReleased { order_id, buyer, memo_amount }          // â† å¯åˆå¹¶
OrderCancelled { order_id }                            // â† å¯åˆå¹¶
OrderDisputed { order_id, initiator }                  // â† å¯åˆå¹¶
FirstPurchaseCreated { order_id, buyer, memo_amount }  // â† å†—ä½™ï¼Œåˆå¹¶åˆ°OrderCreated
FirstPurchasePoolFunded { amount, new_balance }
OrderArchived { order_id }
```

**é—®é¢˜**ï¼š
1. çŠ¶æ€å˜æ›´äº‹ä»¶å†—ä½™ï¼ˆPaid/Released/Cancelled/Disputedéƒ½æ˜¯çŠ¶æ€å˜æ›´ï¼‰
2. FirstPurchaseCreatedä¸OrderCreatedé‡å¤
3. æ¯ä¸ªäº‹ä»¶åŒ…å«è¿‡å¤šå­—æ®µ

#### âœ… ä¼˜åŒ–åï¼ˆ5ä¸ªäº‹ä»¶ï¼Œå‡å°‘3ä¸ªï¼‰

```rust
/// è®¢å•å·²åˆ›å»º
OrderCreated {
    order_id: u64,
    maker_id: u64,
    buyer: T::AccountId,
    memo_amount: BalanceOf<T>,
    is_first_purchase: bool,        // â† æ–°å¢æ ‡å¿—ï¼Œæ›¿ä»£FirstPurchaseCreated
}

/// è®¢å•çŠ¶æ€å·²å˜æ›´ï¼ˆåˆå¹¶4ä¸ªäº‹ä»¶ï¼‰
OrderStateChanged {
    order_id: u64,
    old_state: OrderState,          // â† æ—§çŠ¶æ€
    new_state: OrderState,          // â† æ–°çŠ¶æ€
    actor: Option<T::AccountId>,    // â† æ“ä½œè€…ï¼ˆå¯é€‰ï¼‰
}

FirstPurchasePoolFunded { amount: BalanceOf<T>, new_balance: BalanceOf<T> }
OrderArchived { order_id: u64 }
```

**OrderStateæšä¸¾**ï¼š
```rust
#[derive(Encode, Decode, TypeInfo, Clone, Copy, PartialEq, Eq)]
pub enum OrderState {
    Created = 0,
    PaidOrCommitted = 1,
    Released = 2,
    Canceled = 3,
    Disputed = 4,
    Arbitrating = 5,
    Refunded = 6,
    Closed = 7,
}
```

**æ”¶ç›Š**ï¼š
- äº‹ä»¶æ•°é‡ï¼š8 â†’ 5ï¼ˆå‡å°‘37.5%ï¼‰
- äº‹ä»¶å¤§å°ï¼šæ›´å°ï¼ˆçŠ¶æ€ç”¨u8è¡¨ç¤ºï¼‰
- Gasæˆæœ¬ï¼šé™ä½~40%ï¼ˆOTCæ¨¡å—ï¼‰

---

### 3. Bridgeæ¨¡å—ä¼˜åŒ–

#### âŒ ä¼˜åŒ–å‰ï¼ˆ9ä¸ªäº‹ä»¶ï¼‰

```rust
SwapCreated { swap_id, user, memo_amount, tron_address }
SwapCompleted { swap_id }                              // â† å¯åˆå¹¶
MakerSwapCreated { swap_id, maker_id, user, memo_amount, usdt_amount }
MakerSwapMarkedComplete { swap_id, maker_id, trc20_tx_hash }  // â† å¯åˆå¹¶
MakerSwapReported { swap_id, user }                    // â† å¯åˆå¹¶
MakerSwapRefunded { swap_id, user, memo_amount }       // â† å¯åˆå¹¶
SwapArchived { swap_id }
BridgeAccountSet { account }
MinSwapAmountSet { amount }
```

#### âœ… ä¼˜åŒ–åï¼ˆ7ä¸ªäº‹ä»¶ï¼Œå‡å°‘2ä¸ªï¼‰

```rust
SwapCreated { swap_id, user, memo_amount, tron_address }
MakerSwapCreated { swap_id, maker_id, user, memo_amount, usdt_amount }

/// SwapçŠ¶æ€å˜æ›´ï¼ˆåˆå¹¶4ä¸ªäº‹ä»¶ï¼‰
SwapStateChanged {
    swap_id: u64,
    old_state: SwapState,
    new_state: SwapState,
}

SwapArchived { swap_id }
BridgeAccountSet { account }
MinSwapAmountSet { amount }
```

**SwapStateæšä¸¾**ï¼š
```rust
#[derive(Encode, Decode, TypeInfo, Clone, Copy, PartialEq, Eq)]
pub enum SwapState {
    Created = 0,
    Completed = 1,
    Reported = 2,
    Refunded = 3,
    Archived = 4,
}
```

---

## ğŸ“Š ä¼˜åŒ–æ€»ç»“

### äº‹ä»¶æ•°é‡å¯¹æ¯”

| æ¨¡å— | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | å‡å°‘ | å‡å°‘ç‡ |
|------|--------|--------|------|--------|
| **Maker** | 12ä¸ª | 11ä¸ª | 1ä¸ª | 8.3% |
| **OTC** | 8ä¸ª | 5ä¸ª | 3ä¸ª | **37.5%** |
| **Bridge** | 9ä¸ª | 7ä¸ª | 2ä¸ª | 22.2% |
| **å…¬å…±** | 1ä¸ª | 1ä¸ª | 0ä¸ª | 0% |
| **æ€»è®¡** | **30ä¸ª** | **24ä¸ª** | **6ä¸ª** | **20%** |

---

### å­˜å‚¨èŠ‚çœé¢„ä¼°

#### å•ä¸ªäº‹ä»¶å¤§å°å¯¹æ¯”

**ä¼˜åŒ–å‰ç¤ºä¾‹**ï¼ˆOrderMarkedPaidï¼‰ï¼š
```
- order_id: u64 = 8 bytes
- buyer: AccountId = 32 bytes
= 40 bytes
```

**ä¼˜åŒ–åç¤ºä¾‹**ï¼ˆOrderStateChangedï¼‰ï¼š
```
- order_id: u64 = 8 bytes
- old_state: u8 = 1 byte
- new_state: u8 = 1 byte
- actor: Option<AccountId> = 33 bytes (1 + 32)
= 43 bytes
```

**ä½†æ˜¯**ï¼šåŸæœ¬éœ€è¦4ä¸ªä¸åŒçš„äº‹ä»¶ï¼ˆPaid/Released/Cancelled/Disputedï¼‰ï¼Œç°åœ¨åªéœ€è¦1ä¸ªã€‚

**å®é™…èŠ‚çœ**ï¼š
```
ä¼˜åŒ–å‰ï¼š40 + 40 + 40 + 40 = 160 bytesï¼ˆ4ä¸ªäº‹ä»¶ï¼‰
ä¼˜åŒ–åï¼š43 bytesï¼ˆ1ä¸ªäº‹ä»¶ï¼‰
èŠ‚çœï¼š117 bytes / 160 bytes = 73%
```

#### å…¨é“¾é¢„ä¼°

å‡è®¾ï¼š
- è®¢å•æ€»æ•°ï¼š10,000
- æ¯ä¸ªè®¢å•å¹³å‡3æ¬¡çŠ¶æ€å˜æ›´

**ä¼˜åŒ–å‰**ï¼š
```
10,000 Ã— 3 Ã— 40 = 1,200,000 bytes = 1.17 MB
```

**ä¼˜åŒ–å**ï¼š
```
10,000 Ã— 3 Ã— 43 = 1,290,000 bytes = 1.26 MB
ä½†åªå­˜å‚¨ä¸€æ¬¡ï¼ˆåˆå¹¶äº‹ä»¶ï¼‰ï¼Œå®é™…ï¼š
10,000 Ã— 1 Ã— 43 = 430,000 bytes = 0.42 MB
```

**å®é™…èŠ‚çœ**ï¼š
```
1.17 MB - 0.42 MB = 0.75 MB
èŠ‚çœç‡ï¼š64%
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### æ­¥éª¤1ï¼šæ·»åŠ æ–°ç±»å‹å®šä¹‰

**æ–‡ä»¶**ï¼š`pallets/trading/src/lib.rs`

```rust
/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šåšå¸‚å•†å˜æ›´æ ‡å¿—ä½å›¾
#[derive(Encode, Decode, TypeInfo, Clone, Copy, PartialEq, Eq)]
pub struct MakerChanges {
    pub tron_address_changed: bool,
    pub epay_changed: bool,
    pub sell_premium_changed: bool,
    pub buy_premium_changed: bool,
}

impl MakerChanges {
    pub fn new() -> Self {
        Self {
            tron_address_changed: false,
            epay_changed: false,
            sell_premium_changed: false,
            buy_premium_changed: false,
        }
    }
    
    pub fn is_empty(&self) -> bool {
        !self.tron_address_changed 
        && !self.epay_changed 
        && !self.sell_premium_changed 
        && !self.buy_premium_changed
    }
}
```

---

### æ­¥éª¤2ï¼šæ›´æ–°Eventæšä¸¾

**ä¼˜åŒ–ç›®æ ‡**ï¼šå‡å°‘6ä¸ªäº‹ä»¶

**å…·ä½“ä¿®æ”¹**ï¼š
1. âœ… åˆå¹¶ `MakerInfoUpdated` + `MakerPremiumSet` â†’ `MakerUpdated`
2. âœ… åˆå¹¶ `OrderMarkedPaid` + `MemoReleased` + `OrderCancelled` + `OrderDisputed` â†’ `OrderStateChanged`
3. âœ… åˆå¹¶ `FirstPurchaseCreated` â†’ `OrderCreated`ï¼ˆæ·»åŠ æ ‡å¿—ï¼‰
4. âœ… åˆå¹¶ Bridgeæ¨¡å—çš„çŠ¶æ€å˜æ›´äº‹ä»¶

---

### æ­¥éª¤3ï¼šæ›´æ–°äº‹ä»¶å‘å°„é€»è¾‘

**ç¤ºä¾‹**ï¼šOTCè®¢å•çŠ¶æ€å˜æ›´

```rust
// âŒ ä¼˜åŒ–å‰
pub fn mark_paid(...) -> DispatchResult {
    // æ›´æ–°çŠ¶æ€
    order.state = OrderState::PaidOrCommitted;
    
    // å‘å°„äº‹ä»¶
    Self::deposit_event(Event::OrderMarkedPaid {
        order_id,
        buyer: order.buyer.clone(),
    });
}

// âœ… ä¼˜åŒ–å
pub fn mark_paid(...) -> DispatchResult {
    let old_state = order.state;
    order.state = OrderState::PaidOrCommitted;
    
    // å‘å°„ç»Ÿä¸€çš„çŠ¶æ€å˜æ›´äº‹ä»¶
    Self::deposit_event(Event::OrderStateChanged {
        order_id,
        old_state,
        new_state: OrderState::PaidOrCommitted,
        actor: Some(buyer),
    });
}
```

---

### æ­¥éª¤4ï¼šå‰ç«¯é€‚é…

**å½±å“**ï¼šå‰ç«¯éœ€è¦æ›´æ–°äº‹ä»¶ç›‘å¬é€»è¾‘

**é€‚é…æ–¹æ¡ˆ**ï¼š
```typescript
// âŒ ä¼˜åŒ–å‰
api.query.system.events((events) => {
  events.forEach((record) => {
    const { event } = record;
    
    if (event.method === 'OrderMarkedPaid') {
      console.log('Order paid:', event.data);
    }
    if (event.method === 'MemoReleased') {
      console.log('Memo released:', event.data);
    }
  });
});

// âœ… ä¼˜åŒ–å
api.query.system.events((events) => {
  events.forEach((record) => {
    const { event } = record;
    
    if (event.method === 'OrderStateChanged') {
      const { order_id, old_state, new_state, actor } = event.data;
      
      if (new_state === 'PaidOrCommitted') {
        console.log('Order paid:', order_id);
      } else if (new_state === 'Released') {
        console.log('Memo released:', order_id);
      }
    }
  });
});
```

---

### æ­¥éª¤5ï¼šå…¼å®¹æ€§å¤„ç†

**ç­–ç•¥**ï¼šåˆ†é˜¶æ®µéƒ¨ç½²

**Phase 1**ï¼šåŒæ—¶ä¿ç•™æ–°æ—§äº‹ä»¶
```rust
// å‘å°„æ–°äº‹ä»¶
Self::deposit_event(Event::OrderStateChanged { ... });

// åŒæ—¶å‘å°„æ—§äº‹ä»¶ï¼ˆå…¼å®¹æ€§ï¼‰
Self::deposit_event(Event::OrderMarkedPaid { ... });
```

**Phase 2**ï¼šä»…å‘å°„æ–°äº‹ä»¶
```rust
// ä»…å‘å°„æ–°äº‹ä»¶
Self::deposit_event(Event::OrderStateChanged { ... });
```

**Phase 3**ï¼šåˆ é™¤æ—§äº‹ä»¶å®šä¹‰
```rust
// ä»Eventæšä¸¾ä¸­åˆ é™¤æ—§äº‹ä»¶
```

---

## ğŸ“Š é¢„æœŸæ”¶ç›Š

### Gasæˆæœ¬

| æ“ä½œ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | é™ä½ |
|------|--------|--------|------|
| **è®¢å•çŠ¶æ€å˜æ›´** | 100% | 60-70% | **30-40%** |
| **åšå¸‚å•†æ›´æ–°** | 100% | 90% | **10%** |
| **Bridgeäº¤æ˜“** | 100% | 85% | **15%** |
| **å¹³å‡** | 100% | **80-85%** | **15-20%** |

### å­˜å‚¨ç©ºé—´

| æ•°æ®ç±»å‹ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | èŠ‚çœ |
|---------|--------|--------|------|
| **OTCäº‹ä»¶** | 1.17 MB | 0.42 MB | **64%** |
| **Makeräº‹ä»¶** | 0.5 MB | 0.45 MB | **10%** |
| **Bridgeäº‹ä»¶** | 0.8 MB | 0.6 MB | **25%** |
| **æ€»è®¡** | **2.47 MB** | **1.47 MB** | **40%** |

*æ³¨ï¼šåŸºäº10,000è®¢å•çš„å‡è®¾

### TPSæå‡

- äº‹ä»¶å¤„ç†é€Ÿåº¦ï¼š**â†‘ 5-10%**
- é“¾åŒæ­¥é€Ÿåº¦ï¼š**â†‘ 10-15%**ï¼ˆäº‹ä»¶æ•°æ®å‡å°‘ï¼‰

---

## âš ï¸ é£é™©è¯„ä¼°

### é«˜é£é™©

**æ— ** - äº‹ä»¶ä¼˜åŒ–å‘ä¸‹å…¼å®¹

### ä¸­é£é™©

1. **å‰ç«¯é€‚é…å·¥ä½œé‡**
   - å½±å“ï¼šéœ€è¦æ›´æ–°æ‰€æœ‰äº‹ä»¶ç›‘å¬ä»£ç 
   - ç¼“è§£ï¼šæä¾›è¿ç§»æŒ‡å—å’Œç¤ºä¾‹ä»£ç 
   - ä¼°ç®—ï¼š2-4å°æ—¶å‰ç«¯å·¥ä½œé‡

2. **æµ‹è¯•å·¥ä½œé‡**
   - å½±å“ï¼šéœ€è¦å…¨é¢æµ‹è¯•äº‹ä»¶å‘å°„
   - ç¼“è§£ï¼šç¼–å†™å®Œæ•´çš„äº‹ä»¶æµ‹è¯•ç”¨ä¾‹
   - ä¼°ç®—ï¼š2-3å°æ—¶æµ‹è¯•å·¥ä½œé‡

### ä½é£é™©

1. **å…¼å®¹æ€§é—®é¢˜**
   - å½±å“ï¼šæ—§å‰ç«¯å¯èƒ½æ— æ³•è¯†åˆ«æ–°äº‹ä»¶
   - ç¼“è§£ï¼šåˆ†é˜¶æ®µéƒ¨ç½²ï¼ŒåŒæ—¶å‘å°„æ–°æ—§äº‹ä»¶
   - å›æ»šï¼šç®€å•ï¼Œæ¢å¤æ—§äº‹ä»¶å³å¯

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œ

**ä»»åŠ¡1**ï¼šå®æ–½äº‹ä»¶ä¼˜åŒ–
- âœ… æ·»åŠ æ–°ç±»å‹å®šä¹‰
- âœ… æ›´æ–°Eventæšä¸¾
- âœ… æ›´æ–°äº‹ä»¶å‘å°„é€»è¾‘
- âœ… ç¼–å†™æµ‹è¯•ç”¨ä¾‹

**ä»»åŠ¡2**ï¼šå‰ç«¯é€‚é…
- æ›´æ–°äº‹ä»¶ç›‘å¬ä»£ç 
- æµ‹è¯•éªŒè¯

**ä»»åŠ¡3**ï¼šæ–‡æ¡£æ›´æ–°
- æ›´æ–°APIæ–‡æ¡£
- ç¼–å†™è¿ç§»æŒ‡å—

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**ï¼š2025-10-28  
**é¢„ä¼°å·¥ä½œé‡**ï¼š2-3å°æ—¶  
**é¢„æœŸæ”¶ç›Š**ï¼šäº‹ä»¶å­˜å‚¨â†“40%ï¼ŒGasâ†“15-20%

