# 技术债清单

> 生成时间：2025-11-03  
> 版本：v1.0  
> 检查范围：pallet-maker, pallet-otc-order, pallet-bridge, runtime

---

## 📊 概览

| 类别 | 数量 | 优先级分布 |
|------|------|-----------|
| **高优先级** | 3 | P0×1, P1×2 |
| **中优先级** | 4 | P2×4 |
| **低优先级** | 2 | P3×2 |
| **总计** | 9 | - |

---

## 🔴 高优先级（P0-P1）

### 1. Pricing Provider 使用临时固定价格 ⚠️

**位置**：
- `runtime/src/configs/mod.rs:1590-1592`
- `pallets/bridge/src/lib.rs:495, 630`

**问题描述**：
```rust
// runtime/src/configs/mod.rs
impl pallet_otc_order::PricingProvider<Balance> for PricingProviderImpl {
    fn get_dust_to_usd_rate() -> Option<Balance> {
        // TODO: 从 pallet-pricing 获取 DUST/USD 汇率
        // 暂时返回测试值：1 DUST = 0.01 USD（精度 10^6）
        Some(10_000)  // ⚠️ 固定值！
    }
}
```

**影响**：
- ❌ OTC 订单使用错误的汇率计算
- ❌ 首购订单 DUST 数量不准确
- ❌ 桥接兑换 USDT 金额错误

**优先级**：**P0（最高）**

**解决方案**：
1. 检查 `pallet-pricing` 是否有 `get_dust_to_usd_price()` 方法
2. 如果有，直接调用：
   ```rust
   fn get_dust_to_usd_rate() -> Option<Balance> {
       pallet_pricing::Pallet::<Runtime>::get_dust_to_usd_price()
   }
   ```
3. 如果没有，需要先实现 `pallet-pricing` 的价格获取功能

**预估工作量**：1-2小时

---

### 2. Credit 接口未完全实现 ⚠️

**位置**：
- `runtime/src/configs/mod.rs:1596-1620`
- `pallets/otc-order/src/lib.rs:924`

**问题描述**：
```rust
// Runtime 中使用临时 wrapper
pub struct CreditWrapper;
impl pallet_credit::BuyerCreditInterface<AccountId> for CreditWrapper {
    fn get_buyer_credit_score(_buyer: &AccountId) -> u16 {
        500  // ⚠️ 固定返回 500
    }
    
    fn update_buyer_credit_score(_buyer: &AccountId, _delta: i16) -> Result<(), DispatchError> {
        Ok(())  // ⚠️ 什么都不做
    }
}

// pallet-otc-order 中注释掉的代码
// TODO: 等待 pallet-credit 实现完整的接口
// T::Credit::record_successful_trade(&order.taker);  // ⚠️ 被注释
```

**影响**：
- ❌ 买家信用分不会更新
- ❌ 无法根据信用分进行风控
- ❌ 信用激励机制失效

**优先级**：**P1（高）**

**解决方案**：
1. 检查 `pallet-credit` 是否实现了 `BuyerCreditInterface`
2. 如果实现了，移除 `CreditWrapper`，直接使用：
   ```rust
   type Credit = pallet_credit::Pallet<Runtime>;
   ```
3. 取消注释 `record_successful_trade` 调用
4. 如果未实现，需要先完善 `pallet-credit`

**预估工作量**：2-3小时

---

### 3. ArbitrationRouter 返回临时占位值 ⚠️

**位置**：
- `runtime/src/configs/mod.rs:1908-1937`

**问题描述**：
```rust
fn can_dispute(domain: [u8; 8], _who: &AccountId, _id: u64) -> bool {
    if domain == OtcOrderNsBytes::get() {
        // TODO: 实现 ArbitrationHook trait
        false  // ⚠️ 暂时返回 false，待实现
    } else if domain == SimpleBridgeNsBytes::get() {
        // TODO - 待 pallet-trading 实现ArbitrationHook trait
        false  // ⚠️ 暂时返回false
    }
    // ...
}
```

**影响**：
- ❌ OTC 订单无法发起仲裁
- ❌ 桥接兑换无法举报
- ❌ 用户权益无法保护

**优先级**：**P1（高）**

**解决方案**：
1. 在 `pallet-otc-order` 中实现 `ArbitrationHook` trait
2. 在 `pallet-bridge` 中实现 `ArbitrationHook` trait
3. 更新 `ArbitrationRouter` 调用新的钩子函数：
   ```rust
   fn can_dispute(domain: [u8; 8], who: &AccountId, id: u64) -> bool {
       if domain == OtcOrderNsBytes::get() {
           pallet_otc_order::Pallet::<Runtime>::can_dispute(who, id)
       } else if domain == SimpleBridgeNsBytes::get() {
           pallet_bridge::Pallet::<Runtime>::can_dispute(who, id)
       }
       // ...
   }
   ```

**预估工作量**：3-4小时

---

## 🟡 中优先级（P2）

### 4. Escrow 销毁函数缺失

**位置**：
- `pallets/bridge/src/lib.rs:567`

**问题描述**：
```rust
// 注意：这里应该调用 Escrow 的销毁函数，暂时使用 release_all 到桥接账户
let bridge_account = BridgeAccount::<T>::get()
    .ok_or(Error::<T>::BridgeAccountNotSet)?;

T::Escrow::release_all(swap_id, &bridge_account)?;  // ⚠️ 应该销毁而非释放
```

**影响**：
- ⚠️ 桥接的 DUST 没有真正销毁，而是转给桥接账户
- ⚠️ 可能导致代币供应量不准确

**优先级**：**P2（中）**

**解决方案**：
1. 在 `pallet-escrow` 中添加 `burn()` 方法
2. 或者在 `pallet-bridge` 中手动销毁：
   ```rust
   T::Currency::withdraw(
       &escrow_account,
       amount,
       WithdrawReasons::all(),
       ExistenceRequirement::AllowDeath,
   )?;
   ```

**预估工作量**：1-2小时

---

### 5. OCW 验证逻辑未实现

**位置**：
- `pallets/bridge/src/lib.rs` （整个 OCW 部分）

**问题描述**：
- OCW 超时检测未实现
- TRON 链交易验证未实现
- 自动退款机制未实现

**影响**：
- ⚠️ 桥接需要人工处理
- ⚠️ 超时订单无法自动退款
- ⚠️ 做市商作恶无法自动检测

**优先级**：**P2（中）**

**解决方案**：
参考 "选项 A1：实现 OCW 验证逻辑"（4-6小时）

**预估工作量**：4-6小时

---

### 6. 治理功能未完善

**位置**：
- `runtime/src/configs/mod.rs` （Council, Democracy等）

**问题描述**：
- Democracy/Referenda 未集成
- 投票参数未优化
- 治理 Runtime API 缺失

**影响**：
- ⚠️ 无法通过治理投票调整参数
- ⚠️ 社区参与度低

**优先级**：**P2（中）**

**解决方案**：
参考 "选项 A2：完善治理功能"（3-4小时）

**预估工作量**：3-4小时

---

### 7. 首购订单数量边界检查

**位置**：
- `pallets/otc-order/src/lib.rs` （首购逻辑）

**问题描述**：
虽然有 `MinFirstPurchaseDustAmount` 和 `MaxFirstPurchaseDustAmount` 参数，但在极端汇率情况下可能仍有风险。

**影响**：
- ⚠️ 极端汇率下首购可能超出预期范围

**优先级**：**P2（中）**

**解决方案**：
添加更严格的边界检查和异常处理。

**预估工作量**：1小时

---

## 🟢 低优先级（P3）

### 8. Weight 配置全部使用占位值

**位置**：
- 所有新 pallet 的 `type WeightInfo = ();`

**问题描述**：
```rust
impl pallet_maker::Config for Runtime {
    // ...
    type WeightInfo = ();  // ⚠️ 占位
}
```

**影响**：
- 📊 Gas 费用不准确
- 📊 性能优化受限

**优先级**：**P3（低）**

**解决方案**：
运行 benchmarking 生成实际 weights

**预估工作量**：2-3小时（per pallet）

---

### 9. 单元测试和集成测试缺失

**位置**：
- `pallets/maker/src/tests.rs` （空）
- `pallets/otc-order/src/tests.rs` （空）
- `pallets/bridge/src/tests.rs` （空）

**问题描述**：
新 pallet 缺少单元测试和集成测试

**影响**：
- 📊 代码质量无法保证
- 📊 重构风险高

**优先级**：**P3（低）**

**解决方案**：
编写完整的测试套件

**预估工作量**：8-10小时（all pallets）

---

## 📊 技术债统计

### 按优先级

```
P0 (关键)  ████████ 1 项  (11%)
P1 (高)    ████████████████ 2 项  (22%)
P2 (中)    ████████████████████████████ 4 项  (44%)
P3 (低)    ████████████ 2 项  (22%)
```

### 按类别

| 类别 | 数量 | 占比 |
|------|------|------|
| **接口缺失** | 3 | 33% |
| **临时实现** | 2 | 22% |
| **功能未完成** | 2 | 22% |
| **优化需求** | 2 | 22% |

---

## 🎯 推荐处理顺序

### 第一阶段（立即处理）- P0/P1

1. **修复 Pricing Provider**（1-2小时）
   - 接入真实的 pallet-pricing
   - 影响所有订单和桥接

2. **完善 Credit 接口**（2-3小时）
   - 实现信用记录功能
   - 取消注释相关代码

3. **实现 ArbitrationRouter**（3-4小时）
   - 添加 ArbitrationHook trait
   - 启用仲裁功能

**总计**：6-9小时

---

### 第二阶段（近期处理）- P2

1. **实现 OCW 验证逻辑**（4-6小时）
2. **完善治理功能**（3-4小时）
3. **修复 Escrow 销毁**（1-2小时）
4. **加强首购边界检查**（1小时）

**总计**：9-13小时

---

### 第三阶段（长期优化）- P3

1. **运行 Benchmarking**（6-9小时）
2. **编写测试套件**（8-10小时）

**总计**：14-19小时

---

## 🔍 检测结果

```
✅ 编译状态：通过（0 错误, 0 警告）
⚠️  技术债：9 项（1×P0, 2×P1, 4×P2, 2×P3）
📝 TODO标记：15+ 处
🚧 临时实现：6 处
```

---

## 📝 建议

1. **优先处理 P0/P1**：这些问题影响核心功能，建议尽快解决
2. **P2 可分阶段处理**：根据实际需求和资源安排
3. **P3 可长期规划**：在系统稳定后逐步优化

---

## 📄 相关文档

- [Runtime参数优化方案.md](./Runtime参数优化方案.md)
- [pallet-trading重构方案.md](./pallet-trading重构方案.md)
- [前端迁移指南-pallet-trading重构.md](./前端迁移指南-pallet-trading重构.md)

---

*此文档由系统检查工具自动生成于 2025-11-03*

