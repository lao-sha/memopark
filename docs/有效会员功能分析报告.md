# Stardust æœ‰æ•ˆä¼šå‘˜åŠŸèƒ½åˆ†ææŠ¥å‘Š

**ç‰ˆæœ¬**: v1.0
**æ—¥æœŸ**: 2025-11-10
**ä½œè€…**: Claude Code Analysis

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æœ‰æ•ˆä¼šå‘˜çš„åˆ¤æ–­æ ‡å‡†](#ä¸€æœ‰æ•ˆä¼šå‘˜çš„åˆ¤æ–­æ ‡å‡†)
3. [æœ‰æ•ˆä¼šå‘˜åœ¨15çº§è¿”ä½£ä¸­çš„ä½œç”¨](#äºŒæœ‰æ•ˆä¼šå‘˜åœ¨15çº§è¿”ä½£ä¸­çš„ä½œç”¨)
4. [ç›´æ¨æ•°éªŒè¯æœºåˆ¶](#ä¸‰ç›´æ¨æ•°éªŒè¯æœºåˆ¶)
5. [å®Œæ•´ä¸šåŠ¡æµç¨‹](#å››å®Œæ•´ä¸šåŠ¡æµç¨‹)
6. [å…³é”®ä»£ç ä½ç½®ç´¢å¼•](#äº”å…³é”®ä»£ç ä½ç½®ç´¢å¼•)
7. [å‘ç°çš„é—®é¢˜ä¸å»ºè®®](#å…­å‘ç°çš„é—®é¢˜ä¸å»ºè®®)
8. [æ€»ç»“](#ä¸ƒæ€»ç»“)

---

## æ¦‚è¿°

æœ¬æŠ¥å‘Šå…¨é¢åˆ†æäº† Stardust åŒºå—é“¾é¡¹ç›®ä¸­**æœ‰æ•ˆä¼šå‘˜åŠŸèƒ½**çš„å®ç°æœºåˆ¶ï¼ŒåŒ…æ‹¬ï¼š

- æœ‰æ•ˆä¼šå‘˜çš„åˆ¤æ–­æ ‡å‡†
- åœ¨15çº§è”ç›Ÿè¿”ä½£ç³»ç»Ÿä¸­çš„éªŒè¯é€»è¾‘
- æ´»è·ƒæœŸç®¡ç†æœºåˆ¶
- ç›´æ¨æ•°ç»Ÿè®¡ä¸éªŒè¯ç°çŠ¶
- å®Œæ•´çš„ä¸šåŠ¡æµç¨‹åˆ†æ

**æ ¸å¿ƒå‘ç°**ï¼šæœ‰æ•ˆä¼šå‘˜æ˜¯è”ç›Ÿè¿”ä½£ç³»ç»Ÿçš„å‡†å…¥é—¨æ§›ï¼Œä¸æ˜¯æœ‰æ•ˆä¼šå‘˜åˆ™æ— æ³•è·å¾—ä»»ä½•è¿”ä½£ã€‚ä½†æ–‡æ¡£æè¿°çš„"15çº§å‹ç¼©ç®—æ³•"ï¼ˆéœ€è¦ â‰¥3Ã—level ç›´æ¨ï¼‰åœ¨å½“å‰ä»£ç ä¸­å°šæœªå®ç°ã€‚

---

## ä¸€ã€æœ‰æ•ˆä¼šå‘˜çš„åˆ¤æ–­æ ‡å‡†

### 1.1 æ ¸å¿ƒå®šä¹‰

**ä½ç½®**: `pallets/membership/src/lib.rs:704-711`

```rust
pub fn is_member_valid(who: &T::AccountId) -> bool {
    if let Some(membership) = Memberships::<T>::get(who) {
        let current_block = <frame_system::Pallet<T>>::block_number();
        current_block <= membership.valid_until  // å…³é”®åˆ¤æ–­
    } else {
        false
    }
}
```

**åˆ¤æ–­æ¡ä»¶**ï¼š
- âœ… è´¦æˆ·åœ¨ `Memberships<T>` å­˜å‚¨ä¸­å­˜åœ¨
- âœ… å½“å‰åŒºå—å· â‰¤ ä¼šå‘˜æœ‰æ•ˆæœŸæˆªæ­¢åŒºå—å·ï¼ˆ`valid_until`ï¼‰

### 1.2 ä¼šå‘˜ç­‰çº§ä½“ç³»

| ç­‰çº§ | ä»·æ ¼ (DUST) | æœ‰æ•ˆæœŸ | åŸºç¡€ä»£æ•° | æœ€ç»ˆä»£æ•°ä¸Šé™ | å¤‡æ³¨ |
|-----|------------|--------|---------|------------|------|
| **Year1** | 400 | 1å¹´ | 6ä»£ | 15ä»£ | å…¥é—¨çº§ |
| **Year3** | 800 | 3å¹´ | 9ä»£ | 15ä»£ | è¿›é˜¶çº§ |
| **Year5** | 1600 | 5å¹´ | 12ä»£ | 15ä»£ | é«˜çº§ |
| **Year10** | 2000 | 10å¹´ | 15ä»£ | 15ä»£ | æœ€é«˜çº§ï¼ˆæ— å¢é•¿ç©ºé—´ï¼‰ |

### 1.3 ä»£æ•°å¢é•¿è§„åˆ™

**ä½ç½®**: `pallets/membership/src/lib.rs:808-821`

```rust
fn increase_referrer_generation(referrer: &T::AccountId) -> DispatchResult {
    Memberships::<T>::try_mutate(referrer, |maybe_membership| -> DispatchResult {
        if let Some(ref mut membership) = maybe_membership {
            // æ¯æ¨èä¸€ä¸ªæ–°ä¼šå‘˜ï¼Œå¥–åŠ±ä»£æ•°+1
            membership.bonus_generations = membership.bonus_generations.saturating_add(1);

            // é‡æ–°è®¡ç®—æ€»ä»£æ•°ï¼ˆæœ€å¤š15ä»£ï¼‰
            membership.total_generations = 15u8.min(
                membership.base_generations.saturating_add(membership.bonus_generations),
            );

            // å¢åŠ æ¨èè®¡æ•°
            membership.referral_count = membership.referral_count.saturating_add(1);

            Self::deposit_event(Event::GenerationIncreased {
                who: referrer.clone(),
                bonus: membership.bonus_generations,
                total: membership.total_generations,
            });
        }
        Ok(())
    })
}
```

**è§„åˆ™æ€»ç»“**ï¼š
- æ¯æˆåŠŸæ¨èä¸€ä¸ªæ–°ä¼šå‘˜ â†’ å¥–åŠ±ä»£æ•° +1
- æ€»ä»£æ•° = åŸºç¡€ä»£æ•° + å¥–åŠ±ä»£æ•°ï¼ˆä¸Šé™15ä»£ï¼‰
- Year10 ä¼šå‘˜åˆå§‹å³ä¸º 15 ä»£ï¼Œæ— å¢é•¿ç©ºé—´

---

## äºŒã€æœ‰æ•ˆä¼šå‘˜åœ¨15çº§è¿”ä½£ä¸­çš„ä½œç”¨

### 2.1 å³æ—¶åˆ†æˆæ¨¡å¼ï¼ˆInstantï¼‰

**ä½ç½®**: `pallets/affiliate/src/instant.rs:105-118`

```rust
fn is_valid_referrer(referrer: &T::AccountId, level: u8) -> bool {
    // éªŒè¯1: æ˜¯å¦ä¸ºæœ‰æ•ˆä¼šå‘˜
    if !T::MembershipProvider::is_valid_member(referrer) {
        return false;  // âŒ ä¸æ˜¯æœ‰æ•ˆä¼šå‘˜ï¼Œç›´æ¥æ‹’ç»
    }

    // éªŒè¯2: å±‚çº§ä¸è¶…è¿‡15ä»£
    if level > 15 {
        return false;
    }

    true
}
```

#### åˆ†é…æµç¨‹

**ä½ç½®**: `pallets/affiliate/src/instant.rs:24-92`

```
ç”¨æˆ·ä¾›å¥‰ â†’ è®¡ç®—å¯åˆ†é…é‡‘é¢
    â†“
éå†æ¨èé“¾ï¼ˆæœ€å¤š15å±‚ï¼‰
    â†“
foreach æ¨èäºº {
    1. æ£€æŸ¥æ˜¯å¦æœ‰æ•ˆä¼šå‘˜ â† âš ï¸ å…³é”®éªŒè¯ç‚¹
    2. é€šè¿‡ â†’ è®¡ç®—åˆ†æˆé‡‘é¢
    3. å¤±è´¥ â†’ è·³è¿‡è¯¥å±‚ï¼Œä»½é¢å½’å›½åº“
    4. ç«‹å³è½¬è´¦åˆ°æ¨èäººè´¦æˆ·
}
    â†“
æ›´æ–°ç»Ÿè®¡ TotalInstantDistributed
```

**å…³é”®ä»£ç **ï¼ˆinstant.rs:51-74ï¼‰ï¼š

```rust
// éªŒè¯æ¨èäººèµ„æ ¼
if !Self::is_valid_referrer(referrer, index as u8 + 1) {
    // æ— æ•ˆæ¨èäººï¼Œä»½é¢å¹¶å…¥å›½åº“
    continue;
}

// è®¡ç®—åˆ†æˆé‡‘é¢
let share = Self::calculate_share(distributable_amount, percent);

if share.is_zero() {
    continue;
}

// ç«‹å³è½¬è´¦
if let Err(_) = T::Currency::transfer(
    &T::EscrowPalletId::get().into_account_truncating(),
    referrer,
    share,
    ExistenceRequirement::KeepAlive,
) {
    // è½¬è´¦å¤±è´¥ï¼Œç»§ç»­ä¸‹ä¸€å±‚
    continue;
}
```

**å…³é”®ç‚¹**ï¼š
- âŒ **ä¸æ˜¯æœ‰æ•ˆä¼šå‘˜ = æ— æ³•è·å¾—ä»»ä½•è¿”ä½£**
- æ— æ•ˆå±‚çº§çš„èµ„é‡‘ä¸ä¼šä¸‹æ²‰ï¼Œç›´æ¥å¹¶å…¥å›½åº“
- è½¬è´¦å¤±è´¥ä¸ä¼šä¸­æ–­æ•´ä¸ªæµç¨‹ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€å±‚

### 2.2 å‘¨ç»“ç®—æ¨¡å¼ï¼ˆWeeklyï¼‰

**ä½ç½®**: `pallets/affiliate/src/weekly.rs:67-76`

```rust
// ç®€åŒ–éªŒè¯ï¼šæ´»è·ƒæœŸ + æœ‰æ•ˆä¼šå‘˜
let active_until = ActiveUntilWeek::<T>::get(referrer);
if active_until < current_cycle {
    continue;  // âŒ æœªæ¿€æ´»ï¼Œè·³è¿‡
}

// éªŒè¯ï¼šæ˜¯å¦ä¸ºæœ‰æ•ˆä¼šå‘˜
if !T::MembershipProvider::is_valid_member(referrer) {
    continue;  // âŒ ä¸æ˜¯æœ‰æ•ˆä¼šå‘˜ï¼Œè·³è¿‡
}
```

#### åŒé‡éªŒè¯æœºåˆ¶

**1. æ´»è·ƒæœŸéªŒè¯**

- **å­˜å‚¨**: `ActiveUntilWeek<T>`ï¼ˆè´¦æˆ· â†’ æ´»è·ƒæˆªæ­¢å‘¨ï¼‰
- **æ›´æ–°æ—¶æœº**: ä¾›å¥‰å…·æœ‰æ—¶é•¿å±æ€§æ—¶ï¼ˆduration_weeks > 0ï¼‰
- **è®¡ç®—å…¬å¼**: `current_cycle + duration_weeks`

**2. ä¼šå‘˜æœ‰æ•ˆæ€§éªŒè¯**

- **è°ƒç”¨**: `MembershipProvider::is_valid_member()`
- **éªŒè¯**: ä¼šå‘˜æœªè¿‡æœŸï¼ˆåŒºå—é«˜åº¦éªŒè¯ï¼‰

#### æ´»è·ƒæœŸæ›´æ–°æœºåˆ¶

**ä½ç½®**: `pallets/affiliate/src/weekly.rs:97-116`

```rust
// å¦‚æœæ˜¯ç¬¬ä¸€å±‚ï¼Œä¸”æœ‰æ—¶é•¿ï¼Œæ›´æ–°ç›´æ¨æ´»è·ƒæ•°
if index == 0 {
    if let Some(weeks) = duration_weeks {
        if weeks > 0 {
            // æ›´æ–°è´­ä¹°è€…çš„æ´»è·ƒæœŸ
            let new_active_until = current_cycle.saturating_add(weeks);
            let old_active_until = ActiveUntilWeek::<T>::get(buyer);

            if new_active_until > old_active_until {
                ActiveUntilWeek::<T>::insert(buyer, new_active_until);

                // âš ï¸ å…³é”®ï¼šä»…åœ¨é¦–æ¬¡æ¿€æ´»æ—¶å¢åŠ ç›´æ¨è®¡æ•°
                if old_active_until < current_cycle {
                    DirectActiveCount::<T>::mutate(referrer, |count| {
                        *count = count.saturating_add(1);
                    });
                }
            }
        }
    }
}
```

**è§¦å‘æ¡ä»¶**ï¼š
- âœ… æ˜¯ç¬¬ä¸€å±‚æ¨èäºº
- âœ… ä¾›å¥‰å…·æœ‰æ—¶é•¿å±æ€§ï¼ˆduration_weeks > 0ï¼‰
- âœ… ç”¨æˆ·ä»æœªæ¿€æ´»çŠ¶æ€ â†’ æ¿€æ´»çŠ¶æ€ï¼ˆé¦–æ¬¡æ¿€æ´»ï¼‰

**å¢é•¿è§„åˆ™**ï¼š
```rust
// ä»…åœ¨é¦–æ¬¡æ¿€æ´»æ—¶å¢é•¿
if old_active_until < current_cycle {  // ä¹‹å‰æœªæ¿€æ´»
    DirectActiveCount::<T>::mutate(referrer, |count| {
        *count += 1;  // â† ç›´æ¨æ´»è·ƒæ•°+1
    });
}
```

---

## ä¸‰ã€ç›´æ¨æ•°éªŒè¯æœºåˆ¶

### 3.1 å­˜å‚¨ç»“æ„

**ä½ç½®**: `pallets/affiliate/src/lib.rs:206-214`

```rust
/// ç›´æ¨æ´»è·ƒæ•°ï¼šè´¦æˆ· â†’ æ´»è·ƒç›´æ¨æ•°é‡
#[pallet::storage]
pub type DirectActiveCount<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    T::AccountId,
    u32,  // ç›´æ¨æ•°é‡
    ValueQuery,
>;
```

### 3.2 è®¡æ•°æ›´æ–°é€»è¾‘

**è§¦å‘æ¡ä»¶**ï¼š
- âœ… ä¸‹çº§ç”¨æˆ·è¿›è¡Œå…·æœ‰æ—¶é•¿çš„ä¾›å¥‰ï¼ˆduration_weeks > 0ï¼‰
- âœ… è¯¥ç”¨æˆ·ä»æœªæ¿€æ´»çŠ¶æ€ â†’ æ¿€æ´»çŠ¶æ€ï¼ˆé¦–æ¬¡æ¿€æ´»ï¼‰
- âœ… ä»…å¢åŠ **ç¬¬ä¸€å±‚æ¨èäºº**çš„ç›´æ¨è®¡æ•°

**ä»£ç å®ç°**ï¼ˆweekly.rs:108-112ï¼‰ï¼š
```rust
// å¦‚æœæ˜¯æ–°æ¿€æ´»ï¼Œå¢åŠ æ¨èäººçš„ç›´æ¨è®¡æ•°
if old_active_until < current_cycle {
    DirectActiveCount::<T>::mutate(referrer, |count| {
        *count = count.saturating_add(1);
    });
}
```

### 3.3 éªŒè¯é€»è¾‘ç°çŠ¶

âš ï¸ **é‡è¦å‘ç°**ï¼šä»£ç ä¸­**æ²¡æœ‰æ˜¾å¼éªŒè¯** "å¿…é¡»æœ‰ â‰¥3Ã—level ç›´æ¨" çš„æ¡ä»¶ã€‚

**å½“å‰å®ç°**ï¼š
- âœ… ç›´æ¨æ•°å·²è¢«è®°å½•ï¼ˆ`DirectActiveCount`ï¼‰
- âŒ ä½†åœ¨åˆ†é…ç¯èŠ‚**æœªè¿›è¡ŒéªŒè¯**
- ğŸ“‹ å¯èƒ½æ˜¯é¢„ç•™çš„æ‰©å±•æ¥å£ï¼Œæœªåœ¨å½“å‰ç‰ˆæœ¬ä¸­å¯ç”¨

**æ–‡æ¡£æè¿°** (CLAUDE.md)ï¼š
> 15-level compression finds up to 15 qualified uplines (must have â‰¥3Ã—level direct referrals during valid period)

**å®é™…ä»£ç è¡Œä¸º**ï¼š
- æœªéªŒè¯ç›´æ¨æ•°è¦æ±‚
- æœªå®ç°å‹ç¼©ç®—æ³•
- æ‰€æœ‰æœ‰æ•ˆä¼šå‘˜éƒ½å¯è·å¾—ç›¸åº”å±‚çº§çš„è¿”ä½£

---

## å››ã€å®Œæ•´ä¸šåŠ¡æµç¨‹

### 4.1 ä¼šå‘˜è´­ä¹°ä¸ç»‘å®šæµç¨‹

```
ç”¨æˆ· Alice è´­ä¹°ä¼šå‘˜
    â†“
1. è°ƒç”¨ purchase_membership(level=Year1, referral_code="ABC123")
    â†“
2. éªŒè¯æ¨èç ï¼ˆMembership Palletï¼‰
   - find_account_by_code("ABC123") â†’ è¿”å› Bob è´¦æˆ·
   - is_member_valid(Bob) â†’ å¿…é¡»ä¸ºæœ‰æ•ˆä¼šå‘˜
    â†“
3. è½¬è´¦åˆ°è”ç›Ÿæ‰˜ç®¡è´¦æˆ·
   - Alice â†’ AffiliatePalletIdè´¦æˆ·: 400 DUST
    â†“
4. ç»‘å®šæ¨èå…³ç³»ï¼ˆAffiliate Palletï¼‰
   - Sponsors::insert(Alice, Bob)
    â†“
5. åˆ›å»ºä¼šå‘˜ä¿¡æ¯
   - è®¡ç®—æœ‰æ•ˆæœŸ: current_block + 1å¹´åŒºå—æ•°
   - ä¿å­˜ Memberships(Alice) = { level: Year1, valid_until, ... }
    â†“
6. å¢åŠ æ¨èäººå¥–åŠ±ä»£æ•°
   - Bob.bonus_generations += 1
   - Bob.total_generations = min(15, base + bonus)
    â†“
7. è‡ªåŠ¨åˆ†é…æ¨èç ï¼ˆå¯é€‰ï¼Œå½“å‰ç‰ˆæœ¬éœ€æ‰‹åŠ¨ claim_codeï¼‰
```

**å…³é”®ä»£ç **ï¼ˆmembership/src/lib.rs:307-399ï¼‰

### 4.2 å³æ—¶åˆ†æˆæµç¨‹

```
ç”¨æˆ· Alice ä¾›å¥‰ 1000 DUSTï¼ˆå³æ—¶åˆ†æˆæ¨¡å¼ï¼‰
    â†“
1. è®¡ç®—å¯åˆ†é…é‡‘é¢
   - æ‰£é™¤ç³»ç»Ÿè´¹ç”¨ï¼ˆé”€æ¯10%ã€å›½åº“15%ã€å­˜å‚¨è´¹ç­‰ï¼‰
   - å‰©ä½™ 750 DUST å¯åˆ†é…
    â†“
2. è·å–æ¨èé“¾
   - get_referral_chain(Alice) â†’ [Bob, Charlie, David, ...]
    â†“
3. é€å±‚åˆ†é…ï¼ˆæœ€å¤š15å±‚ï¼‰
    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç¬¬1å±‚: Bob                          â”‚
    â”‚ - is_valid_member(Bob)? â†’ âœ… æ˜¯     â”‚
    â”‚ - åˆ†æˆæ¯”ä¾‹: 5%                       â”‚
    â”‚ - è®¡ç®—é‡‘é¢: 750 * 5% = 37.5 DUST   â”‚
    â”‚ - ç«‹å³è½¬è´¦: EscrowAccount â†’ Bob     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç¬¬2å±‚: Charlie                      â”‚
    â”‚ - is_valid_member(Charlie)? â†’ âŒ å¦ â”‚
    â”‚ - è·³è¿‡ï¼Œä»½é¢å½’å›½åº“                   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç¬¬3å±‚: David                        â”‚
    â”‚ - is_valid_member(David)? â†’ âœ… æ˜¯   â”‚
    â”‚ - åˆ†æˆæ¯”ä¾‹: 5%                       â”‚
    â”‚ - è®¡ç®—é‡‘é¢: 750 * 5% = 37.5 DUST   â”‚
    â”‚ - ç«‹å³è½¬è´¦: EscrowAccount â†’ David   â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    ... ç»§ç»­åˆ°ç¬¬15å±‚
    â†“
4. æ›´æ–°ç»Ÿè®¡
   - TotalInstantDistributed += å®é™…åˆ†é…æ€»é¢
```

### 4.3 å‘¨ç»“ç®—æµç¨‹

```
ç”¨æˆ· Alice ä¾›å¥‰ 1000 DUSTï¼Œæ—¶é•¿ 4 å‘¨ï¼ˆå‘¨ç»“ç®—æ¨¡å¼ï¼‰
    â†“
1. è°ƒç”¨ do_report_consumption(Alice, 750 DUST, duration_weeks=4)
    â†“
2. è®¡ç®—å½“å‰å‘¨ç¼–å·
   - current_cycle = block_number / blocks_per_week
   - ä¾‹å¦‚: å½“å‰ç¬¬ 100 å‘¨
    â†“
3. è·å–æ¨èé“¾
   - [Bob, Charlie, David, ...]
    â†“
4. é€å±‚ç´¯è®¡åº”å¾—ï¼ˆæœ€å¤š15å±‚ï¼‰
    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç¬¬1å±‚: Bob                              â”‚
    â”‚ - ActiveUntilWeek(Bob) = 105 â‰¥ 100? âœ…  â”‚
    â”‚ - is_valid_member(Bob)? âœ…              â”‚
    â”‚ - åˆ†æˆ: 750 * 5% = 37.5 DUST           â”‚
    â”‚ - Entitlement(100, Bob) += 37.5        â”‚
    â”‚                                         â”‚
    â”‚ - ç‰¹æ®Šå¤„ç†: Alice æ˜¯ Bob çš„ç›´æ¨         â”‚
    â”‚   - æ›´æ–° Alice æ´»è·ƒæœŸ: 100 + 4 = 104   â”‚
    â”‚   - æ£€æŸ¥é¦–æ¬¡æ¿€æ´»?                        â”‚
    â”‚     - old_active = 95 < 100 â†’ âœ… é¦–æ¬¡   â”‚
    â”‚     - DirectActiveCount(Bob) += 1       â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ç¬¬2å±‚: Charlie                          â”‚
    â”‚ - ActiveUntilWeek(Charlie) = 98 < 100? âŒâ”‚
    â”‚ - è·³è¿‡ï¼ˆæœªæ¿€æ´»ï¼‰                         â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    ... ç»§ç»­åˆ°ç¬¬15å±‚
    â†“
5. å‘¨æœŸç»“ç®—ï¼ˆè°ƒç”¨ settle_cycle(100, max_accounts=50)ï¼‰
   - æ‰¹é‡è½¬è´¦ Entitlement(100) ä¸­çš„æ‰€æœ‰åº”å¾—
   - EscrowAccount â†’ Bob: 37.5 DUST
   - EscrowAccount â†’ David: 37.5 DUST
   - ...
   - æ¸…ç†å·²ç»“ç®—è®°å½•
   - æ›´æ–°ç»Ÿè®¡ TotalWeeklyDistributed
```

---

## äº”ã€å…³é”®ä»£ç ä½ç½®ç´¢å¼•

| åŠŸèƒ½æ¨¡å— | æ–‡ä»¶è·¯å¾„ | å…³é”®å‡½æ•°/è¡Œå· | è¯´æ˜ |
|---------|---------|--------------|------|
| **æœ‰æ•ˆä¼šå‘˜åˆ¤æ–­** | `pallets/membership/src/lib.rs` | `is_member_valid()` (704-711) | æ ¸å¿ƒéªŒè¯é€»è¾‘ |
| **ä¼šå‘˜è´­ä¹°** | `pallets/membership/src/lib.rs` | `purchase_membership()` (307-399) | è´­ä¹°ä¼šå‘˜å®Œæ•´æµç¨‹ |
| **ä»£æ•°å¢é•¿** | `pallets/membership/src/lib.rs` | `increase_referrer_generation()` (808-821) | æ¨èå¥–åŠ±ä»£æ•°+1 |
| **æ¨èäººéªŒè¯** | `pallets/affiliate/src/instant.rs` | `is_valid_referrer()` (105-118) | å³æ—¶åˆ†æˆéªŒè¯ |
| **å³æ—¶åˆ†æˆ** | `pallets/affiliate/src/instant.rs` | `do_instant_distribute()` (24-92) | å®æ—¶è½¬è´¦åˆ†é… |
| **å‘¨ç»“ç®—ä¸ŠæŠ¥** | `pallets/affiliate/src/weekly.rs` | `do_report_consumption()` (34-118) | æ¶ˆè´¹ä¸ŠæŠ¥ç´¯è®¡ |
| **æ´»è·ƒæœŸæ›´æ–°** | `pallets/affiliate/src/weekly.rs` | æ›´æ–°é€»è¾‘ (97-116) | å»¶é•¿æ´»è·ƒæœŸ |
| **ç›´æ¨è®¡æ•°** | `pallets/affiliate/src/lib.rs` | å­˜å‚¨å®šä¹‰ (206-214) | DirectActiveCount |
| **å‘¨æœŸç»“ç®—** | `pallets/affiliate/src/weekly.rs` | `do_settle_cycle()` (120-205) | æ‰¹é‡è½¬è´¦ç»“ç®— |
| **æ¨èé“¾æŸ¥è¯¢** | `pallets/affiliate/src/referral.rs` | `get_referral_chain()` (24-38) | è·å–15å±‚é“¾ |
| **æ¨èå…³ç³»ç»‘å®š** | `pallets/affiliate/src/referral.rs` | `do_bind_sponsor()` (148-192) | ç»‘å®šæ¨èäºº |
| **æ¨èç è®¤é¢†** | `pallets/affiliate/src/referral.rs` | `do_claim_code()` (204-248) | è®¤é¢†æ¨èç  |

---

## å…­ã€å‘ç°çš„é—®é¢˜ä¸å»ºè®®

### 6.1 æœªå®ç°çš„åŠŸèƒ½ï¼š15çº§å‹ç¼©ç®—æ³•

**é—®é¢˜æè¿°**ï¼š

é¡¹ç›®æ–‡æ¡£ï¼ˆCLAUDE.mdï¼‰æåˆ°ï¼š
> 15-level compression finds up to 15 qualified uplines (must have â‰¥3Ã—level direct referrals during valid period)

ä½†ä»£ç ä¸­**æ²¡æœ‰éªŒè¯ç›´æ¨æ•°è¦æ±‚**ã€‚

**ç°çŠ¶åˆ†æ**ï¼š

| é¡¹ç›® | å®ç°çŠ¶æ€ | ä»£ç ä½ç½® |
|-----|---------|---------|
| ç›´æ¨æ•°ç»Ÿè®¡ | âœ… å·²å®ç° | `DirectActiveCount<T>` |
| ç›´æ¨æ•°å¢é•¿ | âœ… å·²å®ç° | weekly.rs:108-112 |
| ç›´æ¨æ•°éªŒè¯ | âŒ **æœªå®ç°** | - |
| å‹ç¼©ç®—æ³• | âŒ **æœªå®ç°** | - |

**å½±å“**ï¼š
- å½“å‰å®ç°æ˜¯**å…¨å‘˜åˆ†é…**ï¼Œè€Œé**å‹ç¼©åˆ†é…**
- å¯èƒ½å¯¼è‡´è¿”ä½£æˆæœ¬é«˜äºé¢„æœŸ
- ä¸æ–‡æ¡£æè¿°ä¸ä¸€è‡´

**å»ºè®®å®ç°**ï¼š

åœ¨éªŒè¯å‡½æ•°ä¸­å¢åŠ ç›´æ¨æ•°æ£€æŸ¥ï¼š

```rust
// åœ¨ instant.rs:105 å’Œ weekly.rs:73 å¢åŠ éªŒè¯
fn is_valid_referrer(referrer: &T::AccountId, level: u8) -> bool {
    // ç°æœ‰éªŒè¯ï¼šä¼šå‘˜æœ‰æ•ˆæ€§
    if !T::MembershipProvider::is_valid_member(referrer) {
        return false;
    }

    // ğŸ†• å¢åŠ ç›´æ¨æ•°éªŒè¯ï¼ˆå‹ç¼©ç®—æ³•ï¼‰
    let direct_count = DirectActiveCount::<T>::get(referrer);
    let required_count = (level as u32) * 3;  // level Ã— 3
    if direct_count < required_count {
        return false;  // âŒ ç›´æ¨æ•°ä¸è¶³ï¼Œæ— æ³•æ‹¿è¯¥å±‚
    }

    // å±‚çº§éªŒè¯
    if level > 15 {
        return false;
    }

    true
}
```

**ç¤ºä¾‹**ï¼š
- ç¬¬1å±‚ï¼šéœ€è¦ â‰¥3 ä¸ªç›´æ¨
- ç¬¬2å±‚ï¼šéœ€è¦ â‰¥6 ä¸ªç›´æ¨
- ç¬¬3å±‚ï¼šéœ€è¦ â‰¥9 ä¸ªç›´æ¨
- ...
- ç¬¬15å±‚ï¼šéœ€è¦ â‰¥45 ä¸ªç›´æ¨

### 6.2 æ´»è·ƒæœŸè®¾è®¡ä¸ä¸€è‡´

**é—®é¢˜æè¿°**ï¼š

- **å³æ—¶åˆ†æˆæ¨¡å¼**ï¼šä»…éªŒè¯ä¼šå‘˜æœ‰æ•ˆæ€§
- **å‘¨ç»“ç®—æ¨¡å¼**ï¼šéªŒè¯æ´»è·ƒæœŸ + ä¼šå‘˜æœ‰æ•ˆæ€§

**å»ºè®®**ï¼š
1. åœ¨æ–‡æ¡£ä¸­æ˜ç¡®è¯´æ˜ä¸¤ç§æ¨¡å¼çš„å·®å¼‚åŸå› 
2. æˆ–ç»Ÿä¸€éªŒè¯é€»è¾‘ï¼Œä¿æŒä¸€è‡´æ€§

### 6.3 ä¼šå‘˜ä»£æ•°éªŒè¯ç¼ºå¤±

**é—®é¢˜æè¿°**ï¼š

å½“å‰ä»£ç ä¸­ï¼š
- âœ… ä¼šå‘˜æœ‰ `total_generations` å­—æ®µï¼ˆå¯æ‹¿ä»£æ•°ï¼‰
- âŒ ä½†åœ¨åˆ†é…æ—¶**æœªéªŒè¯**è¯¥å­—æ®µ

**å½“å‰é€»è¾‘**ï¼ˆinstant.rs:105-118ï¼‰ï¼š
```rust
fn is_valid_referrer(referrer: &T::AccountId, level: u8) -> bool {
    // ä»…éªŒè¯ä¼šå‘˜æœ‰æ•ˆæ€§ï¼ŒæœªéªŒè¯ total_generations
    if !T::MembershipProvider::is_valid_member(referrer) {
        return false;
    }

    // ä»…éªŒè¯å±‚çº§ä¸è¶…è¿‡15
    if level > 15 {
        return false;
    }

    true
}
```

**å»ºè®®å¢åŠ **ï¼š

```rust
fn is_valid_referrer(referrer: &T::AccountId, level: u8) -> bool {
    // éªŒè¯1: ä¼šå‘˜æœ‰æ•ˆæ€§
    if !T::MembershipProvider::is_valid_member(referrer) {
        return false;
    }

    // éªŒè¯2: å¯æ‹¿ä»£æ•°
    if let Some(generations) = T::MembershipProvider::get_member_generations(referrer) {
        if level > generations {
            return false;  // âŒ è¶…å‡ºå¯æ‹¿ä»£æ•°
        }
    } else {
        return false;
    }

    // éªŒè¯3: å±‚çº§ä¸Šé™
    if level > 15 {
        return false;
    }

    true
}
```

**å½±å“**ï¼š
- Year1 ä¼šå‘˜ï¼ˆ6ä»£ï¼‰å¯èƒ½é”™è¯¯è·å¾—ç¬¬7-15å±‚çš„è¿”ä½£
- Year3 ä¼šå‘˜ï¼ˆ9ä»£ï¼‰å¯èƒ½é”™è¯¯è·å¾—ç¬¬10-15å±‚çš„è¿”ä½£

### 6.4 æ‰˜ç®¡è´¦æˆ·ä½™é¢é£é™©

**é—®é¢˜æè¿°**ï¼š

- ä¼šå‘˜è´­ä¹°è´¹ç”¨è¿›å…¥è”ç›Ÿæ‰˜ç®¡è´¦æˆ·ï¼ˆAffiliatePalletIdï¼‰
- ä½†ä»£ç ä¸­**æœªæ‰¾åˆ°**åˆ†é…ä¼šå‘˜è´­ä¹°è´¹ç”¨çš„é€»è¾‘

**ä½ç½®**ï¼ˆmembership/src/lib.rs:344-353ï¼‰ï¼š
```rust
// è®¡ç®—ä»·æ ¼å¹¶è½¬è´¦åˆ°è”ç›Ÿæ‰˜ç®¡è´¦æˆ·
let price = Self::get_membership_price(level);
let affiliate_account = T::AffiliatePalletId::get().into_account_truncating();

T::Currency::transfer(
    &who,
    &affiliate_account,  // âœ… æ”¹ä¸ºè”ç›Ÿæ‰˜ç®¡è´¦æˆ·
    price,
    ExistenceRequirement::KeepAlive,
)?;
```

**æ³¨é‡Š**ï¼ˆmembership/src/lib.rs:382-388ï¼‰ï¼š
```rust
// 8. âœ… è§¦å‘è”ç›Ÿè®¡é…¬åˆ†é…ï¼ˆ100%æ¨èé“¾ï¼‰
// ğŸ†• 2025-10-28 æ›´æ–°ï¼šè°ƒç”¨ pallet-affiliate çš„ä¼šå‘˜ä¸“ç”¨åˆ†é…
// TODO: pallet-affiliate éœ€è¦å®ç° distribute_membership_rewards å…¬å¼€æ–¹æ³•
// æš‚æ—¶è·³è¿‡ï¼Œåç»­è¡¥å……å®ç°
```

**å»ºè®®**ï¼š
1. å®ç° `distribute_membership_rewards()` å‡½æ•°
2. åœ¨ä¼šå‘˜è´­ä¹°æ—¶è§¦å‘åˆ†é…
3. æˆ–é€šè¿‡æ²»ç†æ˜ç¡®ä¼šå‘˜è´¹ç”¨çš„ç”¨é€”ï¼ˆå›½åº“/é”€æ¯/åˆ†é…ï¼‰

---

## ä¸ƒã€æ€»ç»“

### 7.1 æœ‰æ•ˆä¼šå‘˜çš„æ ¸å¿ƒä½œç”¨

| ä½œç”¨ | è¯´æ˜ | å½±å“ |
|-----|------|------|
| **å‡†å…¥é—¨æ§›** | ä¸æ˜¯æœ‰æ•ˆä¼šå‘˜ = æ— æ³•è·å¾—ä»»ä½•è¿”ä½£ | ğŸ”´ å¼ºåˆ¶æ€§ |
| **æœ‰æ•ˆæœŸé™åˆ¶** | ä¼šå‘˜è¿‡æœŸåè‡ªåŠ¨å¤±å»è¿”ä½£èµ„æ ¼ | ğŸ”´ å¼ºåˆ¶æ€§ |
| **ä»£æ•°å¢é•¿æ¿€åŠ±** | æ¨èè¶Šå¤šï¼Œå¯æ‹¿ä»£æ•°è¶Šå¤šï¼ˆæœ€å¤š15ä»£ï¼‰ | ğŸŸ¡ æ¿€åŠ±æ€§ |

### 7.2 å½“å‰å®ç°ç‰¹ç‚¹

| åŠŸèƒ½æ¨¡å— | å®ç°çŠ¶æ€ | è¯´æ˜ |
|---------|---------|------|
| **ä¼šå‘˜æœ‰æ•ˆæ€§éªŒè¯** | âœ… å·²å®Œæ•´å®ç° | is_member_valid() |
| **æ´»è·ƒæœŸç®¡ç†** | âœ… å‘¨ç»“ç®—æ¨¡å¼å·²å®ç° | ActiveUntilWeek |
| **ç›´æ¨æ•°ç»Ÿè®¡** | âœ… å­˜å‚¨ç»“æ„å·²å‡†å¤‡ | DirectActiveCount |
| **ç›´æ¨æ•°éªŒè¯** | âŒ æœªå®ç° | ä¸æ–‡æ¡£ä¸ç¬¦ |
| **å‹ç¼©ç®—æ³•** | âŒ æœªå®ç° | ä¸æ–‡æ¡£ä¸ç¬¦ |
| **å¯æ‹¿ä»£æ•°éªŒè¯** | âš ï¸ æœªéªŒè¯ | å¯èƒ½äº§ç”Ÿè¶…é¢è¿”ä½£ |

### 7.3 ä¸šåŠ¡é€»è¾‘æ€»æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¼šå‘˜è´­ä¹°ä¸ç»‘å®š                            â”‚
â”‚                                                               â”‚
â”‚  ç”¨æˆ· â†’ purchase_membership(level, referral_code)           â”‚
â”‚    â†“                                                          â”‚
â”‚  éªŒè¯æ¨èç  â†’ æ¨èäººå¿…é¡»æ˜¯æœ‰æ•ˆä¼šå‘˜                             â”‚
â”‚    â†“                                                          â”‚
â”‚  è½¬è´¦åˆ°è”ç›Ÿæ‰˜ç®¡è´¦æˆ·                                            â”‚
â”‚    â†“                                                          â”‚
â”‚  ç»‘å®šæ¨èå…³ç³»ï¼ˆSponsors å­˜å‚¨ï¼‰                                 â”‚
â”‚    â†“                                                          â”‚
â”‚  åˆ›å»ºä¼šå‘˜ä¿¡æ¯ï¼ˆè®¡ç®—æœ‰æ•ˆæœŸï¼‰                                     â”‚
â”‚    â†“                                                          â”‚
â”‚  æ¨èäººå¥–åŠ±ä»£æ•° +1                                             â”‚
â”‚    â†“                                                          â”‚
â”‚  ã€å¯é€‰ã€‘è®¤é¢†æ¨èç ï¼ˆclaim_codeï¼‰                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·æ¶ˆè´¹è§¦å‘åˆ†é…                          â”‚
â”‚                                                               â”‚
â”‚  ç”¨æˆ·ä¾›å¥‰/äº¤æ˜“ â†’ æ‰£é™¤ç³»ç»Ÿè´¹ç”¨ â†’ è®¡ç®—å¯åˆ†é…é‡‘é¢                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å³æ—¶åˆ†æˆæ¨¡å¼   â”‚                          â”‚  å‘¨ç»“ç®—æ¨¡å¼     â”‚
â”‚                â”‚                          â”‚                â”‚
â”‚  éªŒè¯æ¨èé“¾ï¼š   â”‚                          â”‚  éªŒè¯æ¨èé“¾ï¼š   â”‚
â”‚  1. æœ‰æ•ˆä¼šå‘˜?  â”‚                          â”‚  1. æ´»è·ƒæœŸ?    â”‚
â”‚  2. ç«‹å³è½¬è´¦   â”‚                          â”‚  2. æœ‰æ•ˆä¼šå‘˜?  â”‚
â”‚                â”‚                          â”‚  3. ç´¯è®¡åº”å¾—   â”‚
â”‚  æ— æ•ˆ â†’ å›½åº“   â”‚                          â”‚  æ— æ•ˆ â†’ è·³è¿‡   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                            â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                                            â”‚  å‘¨æœŸç»“ç®—       â”‚
                                            â”‚                â”‚
                                            â”‚  settle_cycle  â”‚
                                            â”‚  æ‰¹é‡è½¬è´¦      â”‚
                                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.4 ä¼˜åŒ–å»ºè®®ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | å»ºè®®äº‹é¡¹ | å½±å“ | å·¥ä½œé‡ |
|-------|---------|------|-------|
| ğŸ”´ **P0** | å®ç°ç›´æ¨æ•°éªŒè¯ï¼ˆå‹ç¼©ç®—æ³•ï¼‰ | é«˜ï¼ˆæˆæœ¬æ§åˆ¶ï¼‰ | ä¸­ |
| ğŸŸ  **P1** | å®ç°å¯æ‹¿ä»£æ•°éªŒè¯ | ä¸­ï¼ˆé˜²è¶…é¢è¿”ä½£ï¼‰ | å° |
| ğŸŸ¡ **P2** | å®ç°ä¼šå‘˜è´¹ç”¨åˆ†é…é€»è¾‘ | ä¸­ï¼ˆç»æµæ¨¡å‹å®Œæ•´æ€§ï¼‰ | ä¸­ |
| ğŸŸ¢ **P3** | ç»Ÿä¸€å³æ—¶/å‘¨ç»“ç®—éªŒè¯é€»è¾‘ | ä½ï¼ˆä¸€è‡´æ€§ï¼‰ | å° |

---

## é™„å½•ï¼šå­˜å‚¨ç»“æ„é€ŸæŸ¥

### A.1 ä¼šå‘˜ç³»ç»Ÿå­˜å‚¨ï¼ˆpallet-membershipï¼‰

```rust
// ä¼šå‘˜ä¿¡æ¯
Memberships<T>: StorageMap<AccountId, MembershipInfo>

// ä¼šå‘˜ä¿¡æ¯ç»“æ„
pub struct MembershipInfo {
    level: MembershipLevel,           // ä¼šå‘˜ç­‰çº§
    purchased_at: BlockNumber,        // è´­ä¹°æ—¶åŒºå—é«˜åº¦
    valid_until: BlockNumber,         // æœ‰æ•ˆæœŸè‡³
    base_generations: u8,             // åŸºç¡€ä»£æ•° (6/9/12/15)
    bonus_generations: u8,            // å¥–åŠ±ä»£æ•°
    total_generations: u8,            // æ€»ä»£æ•°ï¼ˆæœ€å¤š15ï¼‰
    referrer: Option<AccountId>,      // æ¨èäºº
    referral_count: u32,              // æ¨èäººæ•°
}
```

### A.2 è”ç›Ÿè®¡é…¬å­˜å‚¨ï¼ˆpallet-affiliateï¼‰

```rust
// æ¨èå…³ç³»
Sponsors<T>: StorageMap<AccountId, AccountId>

// æ¨èç 
AccountByCode<T>: StorageMap<BoundedVec<u8>, AccountId>
CodeByAccount<T>: StorageMap<AccountId, BoundedVec<u8>>

// å‘¨ç»“ç®—
Entitlement<T>: StorageDoubleMap<Cycle, AccountId, Balance>
ActiveUntilWeek<T>: StorageMap<AccountId, WeekNumber>
DirectActiveCount<T>: StorageMap<AccountId, u32>

// é…ç½®
SettlementMode<T>: StorageValue<SettlementMode>
InstantLevelPercents<T>: StorageValue<LevelPercents>
WeeklyLevelPercents<T>: StorageValue<LevelPercents>
```

---

**æŠ¥å‘Šç»“æŸ**

å¦‚æœ‰ç–‘é—®æˆ–éœ€è¦è¿›ä¸€æ­¥åˆ†æï¼Œè¯·å‚è€ƒä»£ç ä½ç½®ç´¢å¼•ç« èŠ‚ä¸­çš„å…·ä½“æ–‡ä»¶è·¯å¾„ã€‚
