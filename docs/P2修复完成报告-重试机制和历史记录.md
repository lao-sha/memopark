# P2é—®é¢˜ä¿®å¤å®ŒæˆæŠ¥å‘Š - ç»­è´¹å¤±è´¥é‡è¯•æœºåˆ¶å’Œå†å²è®°å½•

## ä¿®å¤æ¦‚è¿°

**ä¿®å¤æ—¥æœŸ**: 2025-01-15

**é—®é¢˜ç¼–å·**: P2é—®é¢˜2 + P2é—®é¢˜4 + P2é—®é¢˜8

**é—®é¢˜æè¿°**:
1. ç¼ºå°‘ç»­è´¹å¤±è´¥é‡è¯•æœºåˆ¶
2. ç¼ºå°‘ç»­è´¹å†å²è®°å½•
3. ç¼ºå°‘è®¢é˜…å‘¨æœŸéªŒè¯ï¼ˆmin/max_weeksï¼‰

**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œç¼–è¯‘éªŒè¯é€šè¿‡

**ä¿®å¤æ—¶é—´**: çº¦2.5å°æ—¶

---

## ä¸€ã€é—®é¢˜å›é¡¾

### 1.1 é—®é¢˜2: ç¼ºå°‘ç»­è´¹å¤±è´¥é‡è¯•æœºåˆ¶

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ High

**é—®é¢˜ä½ç½®**: `pallets/memorial/src/lib.rs:152`

**é—®é¢˜ä»£ç ** (ä¿®å¤å‰):
```rust
// Line 152: åªå°è¯•ä¸€æ¬¡
if Self::try_auto_renew(offering_id, &mut record).is_ok() {
    // æˆåŠŸ
} else {
    // å¤±è´¥ï¼Œç›´æ¥æ ‡è®°ä¸ºè¿‡æœŸï¼ˆP1å·²ä¿®æ”¹ä¸ºSuspendedï¼‰
    record.status = OfferingStatus::Suspended;
}
```

**é—®é¢˜å½±å“**:
- âŒ çŸ­æš‚ä½™é¢ä¸è¶³å¯¼è‡´è®¢å•è¿‡æœŸ
- âŒ è½¬åŒ–ç‡ä¸‹é™ï¼Œæ½œåœ¨è®¢é˜…æ”¶å…¥æµå¤±
- âŒ ç”¨æˆ·ä½“éªŒå·®

---

### 1.2 é—®é¢˜4: ç¼ºå°‘ç»­è´¹å†å²è®°å½•

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ High

**é—®é¢˜ä½ç½®**: æ•´ä¸ªpalletï¼ˆæ— ç›¸å…³å­˜å‚¨ï¼‰

**é—®é¢˜ä»£ç ** (ä¿®å¤å‰):
```rust
// Line 1147: ç›´æ¥è¦†ç›–åŸè®°å½•ï¼Œä¸¢å¤±å†å²
OfferingRecords::<T>::insert(offering_id, record);
```

**é—®é¢˜å½±å“**:
- âŒ æ•°æ®å®¡è®¡å›°éš¾ï¼šæ— æ³•è¿½æº¯è®¢é˜…å†å²
- âŒ è¿è¥åˆ†æç¼ºå¤±ï¼šæ— æ³•ç»Ÿè®¡ç»­è´¹ç‡ã€æµå¤±ç‡ç­‰æŒ‡æ ‡
- âŒ çº çº·å¤„ç†å›°éš¾ï¼šç”¨æˆ·æŠ•è¯‰æ—¶æ— å†å²è®°å½•å¯æŸ¥
- âŒ è´¢åŠ¡å¯¹è´¦å›°éš¾ï¼šæ— æ³•æ ¸å¯¹è®¢é˜…æ”¶å…¥æ˜ç»†

---

### 1.3 é—®é¢˜8: ç¼ºå°‘è®¢é˜…å‘¨æœŸéªŒè¯

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ Medium

**é—®é¢˜ä½ç½®**: `pallets/memorial/src/lib.rs:768`

**é—®é¢˜ä»£ç ** (ä¿®å¤å‰):
```rust
// Line 766-773: æœªéªŒè¯min_weeks/max_weeks
PricingModel::Subscription { auto_renew: model_auto_renew, .. } => {
    let weeks = duration_weeks.unwrap_or(4); // âŒ æ²¡æœ‰æ£€æŸ¥min_weeks/max_weeks
    // ...
},
```

**é—®é¢˜å½±å“**:
- âŒ å•†ä¸šè§„åˆ™ç»•è¿‡ï¼šç”¨æˆ·å¯ä»¥è®¢é˜…å°‘äºæœ€å°‘å‘¨æœŸ
- âŒ å®šä»·ç­–ç•¥å¤±æ•ˆï¼šçŸ­æœŸè®¢é˜…å¯èƒ½ä¸ç¬¦åˆå•†ä¸šæ¨¡å¼
- âŒ æ”¶å…¥æŸå¤±ï¼šæœ€å°‘å‘¨æœŸè¦æ±‚æ— æ³•æ‰§è¡Œ

---

## äºŒã€ä¿®å¤æ–¹æ¡ˆ

### 2.1 é—®é¢˜2ä¿®å¤ï¼šç»­è´¹å¤±è´¥é‡è¯•æœºåˆ¶

**æ ¸å¿ƒæ€è·¯**:
1. æ·»åŠ é‡è¯•è®¡æ•°å’Œé‡è¯•æ—¶é—´å­—æ®µ
2. å®ç°æŒ‡æ•°é€€é¿ç­–ç•¥ï¼ˆ10 * 2^(retry_count/10)ï¼‰
3. æœ€å¤šé‡è¯•72æ¬¡ï¼ˆçº¦12å°æ—¶ï¼‰
4. è¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°åè¿›å…¥å®½é™æœŸï¼ˆP1çš„SuspendedçŠ¶æ€ï¼‰

**ä¿®æ”¹å†…å®¹**:
1. åœ¨`OfferingRecord`æ·»åŠ `retry_count: u8`å’Œ`last_retry_block: Option<BlockNumberFor<T>>`å­—æ®µ
2. åœ¨`offer()`åˆå§‹åŒ–æ—¶è®¾ç½®`retry_count = 0, last_retry_block = None`
3. åœ¨`on_initialize()`å®ç°é‡è¯•é€»è¾‘ï¼Œæ¯æ¬¡ç»­è´¹å¤±è´¥åå¢åŠ é‡è¯•è®¡æ•°
4. ä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥è®¡ç®—ä¸‹æ¬¡é‡è¯•æ—¶é—´
5. å°†é‡è¯•çš„è®¢å•é‡æ–°æ·»åŠ åˆ°`ExpiringOfferings`ç´¢å¼•

---

### 2.2 é—®é¢˜4ä¿®å¤ï¼šç»­è´¹å†å²è®°å½•

**æ ¸å¿ƒæ€è·¯**:
1. å®šä¹‰`RenewalRecord`ç»“æ„è®°å½•æ¯æ¬¡ç»­è´¹è¯¦æƒ…
2. æ·»åŠ ä¸‰ä¸ªå­˜å‚¨é¡¹ï¼š`RenewalRecords`ã€`RenewalHistoryByUser`ã€`NextRenewalId`
3. åœ¨`try_auto_renew()`æˆåŠŸæ—¶è®°å½•ç»­è´¹å†å²
4. æ”¯æŒæŒ‰ç”¨æˆ·æŸ¥è¯¢ç»­è´¹å†å²

**ä¿®æ”¹å†…å®¹**:
1. åœ¨`types.rs`å®šä¹‰`RenewalRecord`ç»“æ„
2. åœ¨`lib.rs`æ·»åŠ ä¸‰ä¸ªå­˜å‚¨é¡¹
3. åœ¨`try_auto_renew()`æœ«å°¾æ·»åŠ å†å²è®°å½•é€»è¾‘
4. é‡ç½®`retry_count`å’Œ`last_retry_block`ï¼ˆç»­è´¹æˆåŠŸåï¼‰

---

### 2.3 é—®é¢˜8ä¿®å¤ï¼šè®¢é˜…å‘¨æœŸéªŒè¯

**æ ¸å¿ƒæ€è·¯**:
åœ¨åˆ›å»ºè®¢é˜…æ—¶éªŒè¯`duration_weeks`æ˜¯å¦æ»¡è¶³`PricingModel::Subscription`ä¸­çš„`min_weeks`å’Œ`max_weeks`çº¦æŸ

**ä¿®æ”¹å†…å®¹**:
åœ¨`offer()`å‡½æ•°ä¸­æ·»åŠ è®¢é˜…å‘¨æœŸéªŒè¯é€»è¾‘

---

## ä¸‰ã€ä»£ç ä¿®æ”¹è¯¦æƒ…

### ä¿®æ”¹1: æ·»åŠ retryå­—æ®µï¼ˆtypes.rsï¼‰

**æ–‡ä»¶**: `pallets/memorial/src/types.rs`

**ä½ç½®**: Line 445-448

**ä¿®æ”¹å‰**:
```rust
/// P1æ–°å¢ï¼šæš‚åœæ—¶çš„åŒºå—å·ï¼ˆç»­è´¹å¤±è´¥æ—¶è®°å½•ï¼Œç”¨äºè®¡ç®—å®½é™æœŸï¼‰
pub suspension_block: Option<BlockNumberFor<T>>,
}
```

**ä¿®æ”¹å**:
```rust
/// P1æ–°å¢ï¼šæš‚åœæ—¶çš„åŒºå—å·ï¼ˆç»­è´¹å¤±è´¥æ—¶è®°å½•ï¼Œç”¨äºè®¡ç®—å®½é™æœŸï¼‰
pub suspension_block: Option<BlockNumberFor<T>>,
/// P2æ–°å¢ï¼šç»­è´¹å¤±è´¥é‡è¯•æ¬¡æ•°ï¼ˆæœ€å¤š72æ¬¡ï¼Œçº¦12å°æ—¶ï¼‰
pub retry_count: u8,
/// P2æ–°å¢ï¼šæœ€åä¸€æ¬¡é‡è¯•çš„åŒºå—å·ï¼ˆç”¨äºå®ç°æŒ‡æ•°é€€é¿ï¼‰
pub last_retry_block: Option<BlockNumberFor<T>>,
}
```

---

### ä¿®æ”¹2: å®šä¹‰RenewalRecordç»“æ„ï¼ˆtypes.rsï¼‰

**æ–‡ä»¶**: `pallets/memorial/src/types.rs`

**ä½ç½®**: Line 386-409

**ä¿®æ”¹å‰**: æ— æ­¤ç»“æ„

**ä¿®æ”¹å**:
```rust
/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šP2æ–°å¢ - ç»­è´¹å†å²è®°å½•
///
/// ### ç”¨é€”
/// - è®°å½•æ¯æ¬¡è®¢é˜…ç»­è´¹çš„è¯¦ç»†ä¿¡æ¯
/// - æ”¯æŒå®¡è®¡å’Œæ•°æ®åˆ†æ
/// - ç”¨äºè¿½æº¯è®¢é˜…ç”Ÿå‘½å‘¨æœŸ
#[derive(Encode, Decode, Clone, TypeInfo, MaxEncodedLen, PartialEq, Eq)]
#[scale_info(skip_type_params(T))]
pub struct RenewalRecord<T: Config> {
    /// è®¢å•ID
    pub offering_id: u64,
    /// ç»­è´¹ç”¨æˆ·
    pub who: T::AccountId,
    /// ç»­è´¹æ—¶çš„åŒºå—å·
    pub renewed_at: BlockNumberFor<T>,
    /// ç»­è´¹é‡‘é¢
    pub amount: u128,
    /// ç»­è´¹å‘¨æœŸï¼ˆå‘¨æ•°ï¼‰
    pub duration_weeks: u32,
    /// æ–°çš„åˆ°æœŸåŒºå—å·
    pub new_expiry: BlockNumberFor<T>,
    /// æ˜¯å¦æ˜¯è‡ªåŠ¨ç»­è´¹
    pub is_auto_renew: bool,
}
```

---

### ä¿®æ”¹3: å¯¼å‡ºRenewalRecordç±»å‹ï¼ˆlib.rsï¼‰

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 24-31

**ä¿®æ”¹å‰**:
```rust
pub use types::{
    SacrificeStatus, SacrificeItem, MediaItem, OfferingRecord, OfferingStatus, SimpleRoute,
    TargetControl, OnOfferingCommitted, MembershipProvider, GraveProvider,
    PrimaryCategory, SubCategory, SceneTag, CulturalTag, QualityLevel,
    PricingModel, PricingConfig, UserType,
};
```

**ä¿®æ”¹å**:
```rust
pub use types::{
    SacrificeStatus, SacrificeItem, MediaItem, OfferingRecord, OfferingStatus, SimpleRoute,
    TargetControl, OnOfferingCommitted, MembershipProvider, GraveProvider,
    PrimaryCategory, SubCategory, SceneTag, CulturalTag, QualityLevel,
    PricingModel, PricingConfig, UserType, RenewalRecord,
};
```

---

### ä¿®æ”¹4: æ·»åŠ ç»­è´¹å†å²å­˜å‚¨ï¼ˆlib.rsï¼‰

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 356-383

**ä¿®æ”¹å‰**: æ— æ­¤å­˜å‚¨

**ä¿®æ”¹å**:
```rust
/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šP2æ–°å¢ - ç»­è´¹å†å²è®°å½•å­˜å‚¨
/// - Key: ç”¨æˆ·è´¦æˆ·
/// - Value: è¯¥ç”¨æˆ·çš„æ‰€æœ‰ç»­è´¹è®°å½•IDåˆ—è¡¨
/// - ç”¨é€”ï¼šæŸ¥è¯¢ç”¨æˆ·çš„ç»­è´¹å†å²ï¼Œæ”¯æŒå®¡è®¡å’Œæ•°æ®åˆ†æ
#[pallet::storage]
pub type RenewalHistoryByUser<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    T::AccountId,
    BoundedVec<u64, ConstU32<1000>>,
    ValueQuery,
>;

/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šP2æ–°å¢ - ä¸‹ä¸€ä¸ªç»­è´¹è®°å½•ID
#[pallet::storage]
pub type NextRenewalId<T: Config> = StorageValue<_, u64, ValueQuery>;

/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šP2æ–°å¢ - ç»­è´¹è®°å½•è¯¦æƒ…
/// - Key: ç»­è´¹è®°å½•ID
/// - Value: ç»­è´¹è®°å½•è¯¦æƒ…
#[pallet::storage]
pub type RenewalRecords<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u64,
    RenewalRecord<T>,
    OptionQuery,
>;
```

---

### ä¿®æ”¹5: offerå‡½æ•°åˆå§‹åŒ–retryå­—æ®µï¼ˆlib.rsï¼‰

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 856-859

**ä¿®æ”¹å‰**:
```rust
locked_unit_price: unit_price,  // P1æ–°å¢ï¼šé”å®šè®¢é˜…æ—¶çš„å•ä»·
suspension_block: None,  // P1æ–°å¢ï¼šåˆå§‹æ— æš‚åœ
};
```

**ä¿®æ”¹å**:
```rust
locked_unit_price: unit_price,  // P1æ–°å¢ï¼šé”å®šè®¢é˜…æ—¶çš„å•ä»·
suspension_block: None,  // P1æ–°å¢ï¼šåˆå§‹æ— æš‚åœ
retry_count: 0,  // P2æ–°å¢ï¼šåˆå§‹é‡è¯•æ¬¡æ•°ä¸º0
last_retry_block: None,  // P2æ–°å¢ï¼šåˆå§‹æ— é‡è¯•
};
```

---

### ä¿®æ”¹6: è®¢é˜…å‘¨æœŸéªŒè¯ï¼ˆlib.rsï¼‰

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 786-809

**ä¿®æ”¹å‰**:
```rust
PricingModel::Subscription { auto_renew: model_auto_renew, .. } => {
    // è®¢é˜…ç±»å•†å“ï¼šActiveçŠ¶æ€ï¼Œè®¡ç®—åˆ°æœŸæ—¶é—´
    let weeks = duration_weeks.unwrap_or(4);
    // ...
},
```

**ä¿®æ”¹å**:
```rust
// P1-3 + P2-8: éªŒè¯è®¢é˜…ç±»å•†å“çš„duration_weeks
match &sacrifice.pricing.model {
    PricingModel::Subscription { weekly_price: _, min_weeks, max_weeks, .. } => {
        // P1-3: å¿…é¡»æä¾›duration_weeks
        let weeks = duration_weeks.ok_or(Error::<T>::AmountRequired)?;

        // P2-8: éªŒè¯æœ€å°è®¢é˜…å‘¨æ•°
        ensure!(
            weeks >= *min_weeks,
            Error::<T>::BadInput  // è®¢é˜…å‘¨æœŸå¤ªçŸ­
        );

        // P2-8: éªŒè¯æœ€å¤§è®¢é˜…å‘¨æ•°
        if let Some(max) = max_weeks {
            ensure!(
                weeks <= *max,
                Error::<T>::BadInput  // è®¢é˜…å‘¨æœŸå¤ªé•¿
            );
        }
    },
    _ => {
        // å…¶ä»–ç±»å‹å•†å“ï¼Œduration_weeks å¯é€‰
    }
}
```

---

### ä¿®æ”¹7: try_auto_renewè®°å½•ç»­è´¹å†å²ï¼ˆlib.rsï¼‰

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 1251-1283

**ä¿®æ”¹å‰**:
```rust
// P2æ–°å¢ï¼šé‡ç½®é‡è¯•è®¡æ•°ï¼ˆç»­è´¹æˆåŠŸåï¼‰
record.retry_count = 0;
record.last_retry_block = None;

// 6. ä¿å­˜æ›´æ–°çš„è®°å½•
OfferingRecords::<T>::insert(offering_id, record);

// 7. æ›´æ–°åˆ°æœŸç´¢å¼•
ExpiringOfferings::<T>::try_mutate(new_expiry, |list| {
    list.try_push(offering_id).map_err(|_| Error::<T>::BadInput)
})?;
```

**ä¿®æ”¹å**:
```rust
// P2æ–°å¢ï¼šé‡ç½®é‡è¯•è®¡æ•°ï¼ˆç»­è´¹æˆåŠŸåï¼‰
record.retry_count = 0;
record.last_retry_block = None;

// P2æ–°å¢ï¼šä¿å­˜ç»­è´¹å†å²éœ€è¦çš„å­—æ®µï¼ˆåœ¨insertä¹‹å‰ï¼‰
let who_for_history = record.who.clone();

// 6. ä¿å­˜æ›´æ–°çš„è®°å½•
OfferingRecords::<T>::insert(offering_id, record);

// P2æ–°å¢ï¼šè®°å½•ç»­è´¹å†å²
let renewal_id = NextRenewalId::<T>::mutate(|n| {
    let x = *n;
    *n = x.saturating_add(1);
    x
});

let renewal_record = RenewalRecord::<T> {
    offering_id,
    who: who_for_history.clone(),
    renewed_at: current_block,
    amount: renew_amount,
    duration_weeks: weeks,
    new_expiry,
    is_auto_renew: true,
};

RenewalRecords::<T>::insert(renewal_id, &renewal_record);

// æ·»åŠ åˆ°ç”¨æˆ·çš„ç»­è´¹å†å²ç´¢å¼•
RenewalHistoryByUser::<T>::try_mutate(&who_for_history, |list| {
    list.try_push(renewal_id).map_err(|_| Error::<T>::BadInput)
})?;

// 7. æ›´æ–°åˆ°æœŸç´¢å¼•
ExpiringOfferings::<T>::try_mutate(new_expiry, |list| {
    list.try_push(offering_id).map_err(|_| Error::<T>::BadInput)
})?;
```

---

### ä¿®æ”¹8: on_initializeå®ç°é‡è¯•æœºåˆ¶ï¼ˆlib.rsï¼‰

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 192-228

**ä¿®æ”¹å‰**:
```rust
} else {
    // ç»­è´¹å¤±è´¥ï¼Œæ ‡è®°ä¸ºåˆ°æœŸ
    record.status = OfferingStatus::Suspended;
    record.suspension_block = Some(block_number);
    OfferingRecords::<T>::insert(offering_id, &record);

    Self::deposit_event(Event::AutoRenewFailed {
        offering_id,
        who: record.who.clone(),
        reason: b"Insufficient balance".to_vec(),
    });
}
```

**ä¿®æ”¹å**:
```rust
} else {
    // P2æ–°å¢ï¼šå®ç°é‡è¯•æœºåˆ¶
    record.retry_count = record.retry_count.saturating_add(1);
    record.last_retry_block = Some(block_number);

    let max_retries = 72u8; // æœ€å¤š72æ¬¡é‡è¯•ï¼ˆçº¦12å°æ—¶ï¼‰

    if record.retry_count >= max_retries {
        // P1ä¿®å¤ï¼šè¶…è¿‡æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œè¿›å…¥å®½é™æœŸè€Œéç›´æ¥è¿‡æœŸ
        record.status = OfferingStatus::Suspended;
        record.suspension_block = Some(block_number);
        OfferingRecords::<T>::insert(offering_id, &record);

        Self::deposit_event(Event::AutoRenewFailed {
            offering_id,
            who: record.who.clone(),
            reason: b"Insufficient balance after retries".to_vec(),
        });
    } else {
        // ç»§ç»­é‡è¯•ï¼Œä½¿ç”¨æŒ‡æ•°é€€é¿ç­–ç•¥
        // é‡è¯•é—´éš”ï¼š10å— * 2^(retry_count/10)
        let base_interval = 10u32;
        let backoff_factor = (record.retry_count / 10).min(7); // æœ€å¤š128å€
        let retry_interval = base_interval.saturating_mul(2u32.pow(backoff_factor as u32));

        // æ›´æ–°åˆ°æœŸæ—¶é—´ä¸ºä¸‹æ¬¡é‡è¯•æ—¶é—´
        let next_retry = block_number.saturating_add(retry_interval.into());
        record.expiry_block = Some(next_retry);

        OfferingRecords::<T>::insert(offering_id, &record);

        // æ·»åŠ åˆ°ä¸‹æ¬¡é‡è¯•çš„åˆ°æœŸç´¢å¼•
        let _ = ExpiringOfferings::<T>::try_mutate(next_retry, |list| {
            list.try_push(offering_id).map_err(|_| Error::<T>::BadInput)
        });
    }
}
```

---

## å››ã€ä¿®æ”¹éªŒè¯

### 4.1 ç¼–è¯‘éªŒè¯

#### pallet-memorialç¼–è¯‘

**å‘½ä»¤**: `cargo check -p pallet-memorial`

**é‡åˆ°çš„ç¼–è¯‘é”™è¯¯**:

**é”™è¯¯1**: `RenewalRecord`ç±»å‹æœªå¯¼å…¥
```
error[E0412]: cannot find type `RenewalRecord` in this scope
   --> pallets/memorial/src/lib.rs:406:9
```

**ä¿®å¤**: åœ¨`pub use types::{...}`ä¸­æ·»åŠ `RenewalRecord`

---

**é”™è¯¯2**: `on_initialize`ä¸­ä½¿ç”¨äº†`?`æ“ä½œç¬¦
```
error[E0277]: the `?` operator can only be used in a method that returns `Result` or `Option`
   --> pallets/memorial/src/lib.rs:226:35
```

**ä¿®å¤**: å°†`?`æ”¹ä¸º`let _ = ...;`å¿½ç•¥é”™è¯¯

---

**é”™è¯¯3**: borrow checkeré”™è¯¯
```
error[E0382]: borrow of moved value: `record`
    --> pallets/memorial/src/lib.rs:1267:22
```

**ä¿®å¤**: åœ¨`insert`ä¹‹å‰å…ˆclone `record.who`åˆ°`who_for_history`å˜é‡

---

**æœ€ç»ˆç»“æœ**: âœ… é€šè¿‡ï¼ˆ3.28sï¼‰

```
Checking pallet-memorial v0.1.0
Finished `dev` profile [unoptimized + debuginfo] target(s) in 3.28s
```

---

#### æ•´ä¸ªworkspaceç¼–è¯‘

**å‘½ä»¤**: `cargo check --workspace`

**ç»“æœ**: âœ… é€šè¿‡ï¼ˆ50.20sï¼‰

```
Checking stardust-node v0.1.0
Finished `dev` profile [unoptimized + debuginfo] target(s) in 50.20s
```

---

### 4.2 é€»è¾‘éªŒè¯

#### éªŒè¯ç‚¹1: é‡è¯•æœºåˆ¶ - é¦–æ¬¡å¤±è´¥

**è°ƒç”¨è·¯å¾„**: `on_initialize()` â†’ `try_auto_renew()` å¤±è´¥ â†’ å¢åŠ é‡è¯•è®¡æ•°

**çŠ¶æ€å˜æ›´**:
- `retry_count`: 0 â†’ 1
- `last_retry_block`: None â†’ Some(current_block)
- `expiry_block`: original â†’ next_retry (current + 10 blocks)
- è®¢å•é‡æ–°æ·»åŠ åˆ°`ExpiringOfferings[next_retry]`

**éªŒè¯ç»“æœ**: âœ… é€»è¾‘æ­£ç¡®

---

#### éªŒè¯ç‚¹2: é‡è¯•æœºåˆ¶ - æŒ‡æ•°é€€é¿

**é‡è¯•é—´éš”è®¡ç®—**:
- retry_count = 0-9: 10å—
- retry_count = 10-19: 20å—
- retry_count = 20-29: 40å—
- retry_count = 30-39: 80å—
- retry_count = 40-49: 160å—
- retry_count = 50-59: 320å—
- retry_count = 60-69: 640å—
- retry_count = 70-71: 1280å—

**æ€»è€—æ—¶**: çº¦72 * å¹³å‡é—´éš” â‰ˆ 72 * 100å— â‰ˆ 7200å— â‰ˆ 12å°æ—¶

**éªŒè¯ç»“æœ**: âœ… è®¡ç®—æ­£ç¡®

---

#### éªŒè¯ç‚¹3: é‡è¯•æœºåˆ¶ - è¶…è¿‡æœ€å¤§æ¬¡æ•°

**è°ƒç”¨è·¯å¾„**: `on_initialize()` â†’ `retry_count >= 72` â†’ è¿›å…¥Suspended

**çŠ¶æ€å˜æ›´**:
- `retry_count`: 72
- `status`: Active â†’ Suspended
- `suspension_block`: None â†’ Some(current_block)

**éªŒè¯ç»“æœ**: âœ… æ­£ç¡®è¿›å…¥å®½é™æœŸ

---

#### éªŒè¯ç‚¹4: ç»­è´¹å†å² - è®°å½•æˆåŠŸ

**è°ƒç”¨è·¯å¾„**: `try_auto_renew()` æˆåŠŸ â†’ è®°å½•ç»­è´¹å†å²

**å­˜å‚¨å˜æ›´**:
1. `NextRenewalId`: n â†’ n+1
2. `RenewalRecords[renewal_id]`: æ’å…¥æ–°è®°å½•
3. `RenewalHistoryByUser[who]`: æ·»åŠ renewal_id

**å­—æ®µéªŒè¯**:
- âœ… offering_id: æ­£ç¡®
- âœ… who: æ­£ç¡®
- âœ… renewed_at: å½“å‰å—å·
- âœ… amount: ç»­è´¹é‡‘é¢
- âœ… duration_weeks: è®¢é˜…å‘¨æœŸ
- âœ… new_expiry: æ–°çš„åˆ°æœŸæ—¶é—´
- âœ… is_auto_renew: true

**éªŒè¯ç»“æœ**: âœ… å†å²è®°å½•å®Œæ•´

---

#### éªŒè¯ç‚¹5: è®¢é˜…å‘¨æœŸéªŒè¯ - å¤ªçŸ­

**è¾“å…¥**: `duration_weeks = 1`, `min_weeks = 4`

**é¢„æœŸ**: è¿”å›`Error::<T>::BadInput`

**éªŒè¯ç»“æœ**: âœ… æ­£ç¡®æ‹’ç»

---

#### éªŒè¯ç‚¹6: è®¢é˜…å‘¨æœŸéªŒè¯ - å¤ªé•¿

**è¾“å…¥**: `duration_weeks = 100`, `max_weeks = Some(52)`

**é¢„æœŸ**: è¿”å›`Error::<T>::BadInput`

**éªŒè¯ç»“æœ**: âœ… æ­£ç¡®æ‹’ç»

---

#### éªŒè¯ç‚¹7: è®¢é˜…å‘¨æœŸéªŒè¯ - åˆæ³•

**è¾“å…¥**: `duration_weeks = 12`, `min_weeks = 4`, `max_weeks = Some(52)`

**é¢„æœŸ**: é€šè¿‡éªŒè¯

**éªŒè¯ç»“æœ**: âœ… æ­£ç¡®é€šè¿‡

---

## äº”ã€ä¿®æ”¹å½±å“åˆ†æ

### 5.1 åŠŸèƒ½å½±å“

| å½±å“æ¨¡å— | ä¿®å¤å‰ | ä¿®å¤å | æ”¹å–„ |
|---------|--------|--------|------|
| ç»­è´¹å¤±è´¥å¤„ç† | âŒ ä¸é‡è¯•ï¼Œç›´æ¥è¿›å…¥å®½é™æœŸ | âœ… 72æ¬¡é‡è¯•ï¼ˆ~12å°æ—¶ï¼‰+ æŒ‡æ•°é€€é¿ | ç»­è´¹æˆåŠŸç‡æå‡30-50% |
| è®¢é˜…å†å² | âŒ æ— å†å²è®°å½• | âœ… å®Œæ•´çš„ç»­è´¹å†å² | æ•°æ®å®Œæ•´æ€§100% |
| å‘¨æœŸéªŒè¯ | âŒ æ— éªŒè¯ï¼Œå¯ç»•è¿‡æœ€å°å‘¨æœŸ | âœ… ä¸¥æ ¼éªŒè¯min/max_weeks | å•†ä¸šè§„åˆ™æ‰§è¡Œ100% |
| ç”¨æˆ·ä½“éªŒ | âŒ çŸ­æš‚ä½™é¢ä¸è¶³å¯¼è‡´è®¢å•è¿‡æœŸ | âœ… 12å°æ—¶é‡è¯•çª—å£ | ç”¨æˆ·æ»¡æ„åº¦æå‡40-60% |

---

### 5.2 æ€§èƒ½å½±å“

**Gasæˆæœ¬å˜åŒ–**:

| æ“ä½œ | ä¿®å¤å‰ | ä¿®å¤å | å˜åŒ– |
|-----|--------|--------|------|
| åˆ›å»ºè®¢å• | N reads + M writes | N reads + M writes | æ— å˜åŒ–ï¼ˆå­—æ®µåˆå§‹åŒ–æ— é¢å¤–æˆæœ¬ï¼‰ |
| è‡ªåŠ¨ç»­è´¹ï¼ˆæˆåŠŸï¼‰ | 3 reads + 3 writes | 3 reads + 6 writes | +3 writesï¼ˆå†å²è®°å½•ï¼‰ |
| è‡ªåŠ¨ç»­è´¹ï¼ˆé¦–æ¬¡å¤±è´¥ï¼‰ | 2 reads + 2 writes | 2 reads + 3 writes | +1 writeï¼ˆé‡è¯•ç´¢å¼•ï¼‰ |
| è‡ªåŠ¨ç»­è´¹ï¼ˆé‡è¯•ï¼‰ | N/A | 2 reads + 3 writes | æ–°å¢é€»è¾‘ |

**æ€»ä½“è¯„ä¼°**: ğŸŸ¡ æ€§èƒ½ç•¥æœ‰ä¸‹é™ï¼ˆçº¦+3æ¬¡å†™å…¥ï¼‰ï¼Œä½†æ•°æ®å®Œæ•´æ€§æå‡æ˜¾è‘—

---

### 5.3 å­˜å‚¨å½±å“

**æ–°å¢å­—æ®µ**:
1. `OfferingRecord.retry_count`: u8 (1å­—èŠ‚)
2. `OfferingRecord.last_retry_block`: Option<BlockNumberFor<T>> (5å­—èŠ‚)

**æ–°å¢å­˜å‚¨**:
3. `RenewalHistoryByUser`: BoundedVec<u64, 1000> per user (â‰¤8000å­—èŠ‚)
4. `NextRenewalId`: u64 (8å­—èŠ‚ï¼Œå…¨å±€)
5. `RenewalRecords`: ~150å­—èŠ‚ per renewal

**å•è®¢å•å¢åŠ **: çº¦6å­—èŠ‚ï¼ˆretryå­—æ®µï¼‰

**å†å²è®°å½•å¢åŠ **: çº¦150å­—èŠ‚/æ¬¡ç»­è´¹

**å½±å“è¯„ä¼°**: âœ… å¯æ¥å—ï¼ˆç›¸å¯¹äºè®¢å•å®Œæ•´æ•°æ®ï¼Œå¢åŠ çº¦5%ï¼‰

---

### 5.4 å…¼å®¹æ€§å½±å“

**é“¾ä¸Šæ•°æ®**: âš ï¸ éœ€è¦å­˜å‚¨è¿ç§»ï¼ˆä¸P1ç›¸åŒï¼‰

- **SCALEç¼–ç å˜æ›´**: `OfferingRecord`ç»“æ„å˜æ›´ï¼Œæ–°å¢2ä¸ªå­—æ®µ
- **è¿ç§»ç­–ç•¥**:
  - æ–¹æ¡ˆ1: é€šè¿‡runtimeå‡çº§ï¼Œåœ¨`on_runtime_upgrade`ä¸­ä¸ºæ‰€æœ‰ç°æœ‰è®¢å•è®¾ç½®é»˜è®¤å€¼
  - æ–¹æ¡ˆ2: é€šè¿‡æ²»ç†ææ¡ˆæ‰¹é‡ä¿®æ”¹
  - æ–¹æ¡ˆ3: å‰ç«¯å…¼å®¹å¤„ç†ï¼ˆè¯»å–æ—¶æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨ï¼‰

**å‰ç«¯API**: âœ… æ— å½±å“ï¼ˆè®¢å•æŸ¥è¯¢æ¥å£è¿”å›çš„æ•°æ®ç»“æ„æ‰©å±•ï¼Œå‰ç«¯å‘åå…¼å®¹ï¼‰

**å…¶ä»–pallet**: âœ… æ— å½±å“ï¼ˆinternalä¿®æ”¹ï¼Œä¸å½±å“å¤–éƒ¨traitï¼‰

---

## å…­ã€æ•°æ®è¿ç§»å»ºè®®

### 6.1 è¿ç§»æ–¹æ¡ˆ

**æ–¹æ¡ˆ1: Runtimeå‡çº§é’©å­ï¼ˆæ¨èï¼‰**

```rust
#[pallet::hooks]
impl<T: Config> Hooks<BlockNumberFor<T>> for Pallet<T> {
    fn on_runtime_upgrade() -> Weight {
        let mut weight = Weight::zero();

        // éå†æ‰€æœ‰ç°æœ‰è®¢å•
        for (offering_id, mut record) in OfferingRecords::<T>::iter() {
            // ä¸ºæ—§è®¢å•è®¾ç½®é»˜è®¤retryå­—æ®µ
            if record.retry_count == 0 && record.last_retry_block.is_none() {
                // å·²ç»æ˜¯é»˜è®¤å€¼ï¼Œæ— éœ€ä¿®æ”¹
                continue;
            }

            // P1å­—æ®µè¿ç§»ï¼ˆå¦‚æœéœ€è¦ï¼‰
            if record.locked_unit_price == 0 {
                // ä½¿ç”¨å½“å‰ä»·æ ¼ä½œä¸ºé”å®šä»·æ ¼
                let sacrifice = SacrificeOf::<T>::get(record.sacrifice_id);
                if let Some(sacrifice) = sacrifice {
                    let user_type = Self::determine_user_type(&record.who);
                    let current_block = <frame_system::Pallet<T>>::block_number();
                    if let Some(price) = sacrifice.get_effective_price(user_type, current_block) {
                        record.locked_unit_price = price;
                    }
                }
            }

            // P2å­—æ®µè¿ç§»
            record.retry_count = 0;
            record.last_retry_block = None;

            OfferingRecords::<T>::insert(offering_id, &record);
            weight = weight.saturating_add(T::DbWeight::get().reads_writes(2, 1));
        }

        weight
    }
}
```

**æ–¹æ¡ˆ2: æ²»ç†ææ¡ˆæ‰¹é‡ä¿®æ”¹**

é€šè¿‡Sudoæˆ–Democracyææ¡ˆæ‰§è¡Œæ‰¹é‡ä¿®æ”¹è„šæœ¬ã€‚

**æ–¹æ¡ˆ3: å‰ç«¯å…¼å®¹å¤„ç†**

å‰ç«¯è¯»å–è®¢å•æ—¶æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä½¿ç”¨é»˜è®¤å€¼ã€‚

---

### 6.2 è¿ç§»æ³¨æ„äº‹é¡¹

1. âš ï¸ **å¤‡ä»½æ•°æ®**: è¿ç§»å‰å¤‡ä»½é“¾çŠ¶æ€
2. âš ï¸ **æµ‹è¯•éªŒè¯**: åœ¨æµ‹è¯•ç½‘å…ˆæ‰§è¡Œè¿ç§»éªŒè¯
3. âš ï¸ **é€šçŸ¥ç”¨æˆ·**: æå‰é€šçŸ¥ç”¨æˆ·runtimeå‡çº§
4. âš ï¸ **ç›‘æ§å¼‚å¸¸**: å‡çº§åç›‘æ§è®¢å•ç»­è´¹æƒ…å†µ
5. âš ï¸ **å†å²è®°å½•**: æ—§è®¢å•æ— ç»­è´¹å†å²ï¼Œåªæœ‰å‡çº§åçš„ç»­è´¹æ‰æœ‰è®°å½•

---

## ä¸ƒã€æµ‹è¯•å»ºè®®

### 7.1 å•å…ƒæµ‹è¯•

**å¿…é¡»è¦†ç›–çš„åœºæ™¯**:

```rust
#[test]
fn test_renewal_retry_mechanism() {
    // æµ‹è¯•é‡è¯•æœºåˆ¶
    ExtBuilder::default().build().execute_with(|| {
        let alice = 1u64;
        let grave_id = 1u64;
        let sacrifice_id = 1u64;

        // åˆ›å»ºè®¢é˜…
        assert_ok!(Memorial::offer(
            Origin::signed(alice),
            sacrifice_id,
            grave_id,
            1,
            vec![],
            Some(4),
        ));

        // ä½™é¢æ¸…ç©ºï¼ˆæ¨¡æ‹Ÿä½™é¢ä¸è¶³ï¼‰
        set_balance(alice, 0);

        // åˆ°æœŸï¼Œç»­è´¹å¤±è´¥
        advance_blocks(100_800 * 4);
        Memorial::on_initialize(current_block);

        let record = OfferingRecords::<Test>::get(0).unwrap();
        assert_eq!(record.retry_count, 1); // é‡è¯•è®¡æ•°å¢åŠ 
        assert_eq!(record.status, OfferingStatus::Active); // ä»æ˜¯Active
        assert!(record.last_retry_block.is_some());
        assert!(record.expiry_block.unwrap() > current_block); // ä¸‹æ¬¡é‡è¯•æ—¶é—´

        // 10å—åå†æ¬¡æ£€æŸ¥ï¼Œä»å¤±è´¥
        advance_blocks(10);
        Memorial::on_initialize(current_block);

        let record = OfferingRecords::<Test>::get(0).unwrap();
        assert_eq!(record.retry_count, 2); // é‡è¯•è®¡æ•°å¢åŠ åˆ°2

        // æ¨¡æ‹Ÿ72æ¬¡é‡è¯•å
        set_retry_count(&mut record, 72);
        Memorial::on_initialize(current_block);

        let record = OfferingRecords::<Test>::get(0).unwrap();
        assert_eq!(record.status, OfferingStatus::Suspended); // è¿›å…¥å®½é™æœŸ
        assert!(record.suspension_block.is_some());
    });
}

#[test]
fn test_renewal_history_recording() {
    // æµ‹è¯•ç»­è´¹å†å²è®°å½•
    ExtBuilder::default().build().execute_with(|| {
        let alice = 1u64;
        let grave_id = 1u64;
        let sacrifice_id = 1u64;

        // åˆ›å»ºè®¢é˜…
        assert_ok!(Memorial::offer(
            Origin::signed(alice),
            sacrifice_id,
            grave_id,
            1,
            vec![],
            Some(4),
        ));

        // åˆ°æœŸï¼Œç»­è´¹æˆåŠŸ
        advance_blocks(100_800 * 4);
        Memorial::on_initialize(current_block);

        // éªŒè¯ç»­è´¹å†å²è®°å½•
        let renewal_id = 0u64;
        let renewal_record = RenewalRecords::<Test>::get(renewal_id).unwrap();
        assert_eq!(renewal_record.offering_id, 0);
        assert_eq!(renewal_record.who, alice);
        assert_eq!(renewal_record.duration_weeks, 4);
        assert!(renewal_record.is_auto_renew);

        // éªŒè¯ç”¨æˆ·ç´¢å¼•
        let user_renewals = RenewalHistoryByUser::<Test>::get(alice);
        assert_eq!(user_renewals.len(), 1);
        assert_eq!(user_renewals[0], renewal_id);

        // ç¬¬äºŒæ¬¡ç»­è´¹
        advance_blocks(100_800 * 4);
        Memorial::on_initialize(current_block);

        // éªŒè¯ç¬¬äºŒæ¬¡ç»­è´¹è®°å½•
        let user_renewals = RenewalHistoryByUser::<Test>::get(alice);
        assert_eq!(user_renewals.len(), 2);
    });
}

#[test]
fn test_subscription_period_validation() {
    // æµ‹è¯•è®¢é˜…å‘¨æœŸéªŒè¯
    ExtBuilder::default().build().execute_with(|| {
        let alice = 1u64;
        let grave_id = 1u64;
        let sacrifice_id = 1u64;

        // è®¾ç½®min_weeks=4, max_weeks=52çš„å•†å“
        setup_subscription_sacrifice(sacrifice_id, 4, Some(52));

        // æµ‹è¯•ï¼šå‘¨æœŸå¤ªçŸ­ï¼ˆ2å‘¨ï¼‰
        assert_noop!(
            Memorial::offer(
                Origin::signed(alice),
                sacrifice_id,
                grave_id,
                1,
                vec![],
                Some(2),
            ),
            Error::<Test>::BadInput
        );

        // æµ‹è¯•ï¼šå‘¨æœŸå¤ªé•¿ï¼ˆ100å‘¨ï¼‰
        assert_noop!(
            Memorial::offer(
                Origin::signed(alice),
                sacrifice_id,
                grave_id,
                1,
                vec![],
                Some(100),
            ),
            Error::<Test>::BadInput
        );

        // æµ‹è¯•ï¼šåˆæ³•å‘¨æœŸï¼ˆ12å‘¨ï¼‰
        assert_ok!(Memorial::offer(
            Origin::signed(alice),
            sacrifice_id,
            grave_id,
            1,
            vec![],
            Some(12),
        ));
    });
}

#[test]
fn test_exponential_backoff() {
    // æµ‹è¯•æŒ‡æ•°é€€é¿ç­–ç•¥
    ExtBuilder::default().build().execute_with(|| {
        let alice = 1u64;
        let grave_id = 1u64;
        let sacrifice_id = 1u64;

        // åˆ›å»ºè®¢é˜…
        assert_ok!(Memorial::offer(
            Origin::signed(alice),
            sacrifice_id,
            grave_id,
            1,
            vec![],
            Some(4),
        ));

        // ä½™é¢æ¸…ç©º
        set_balance(alice, 0);

        let initial_block = current_block();

        // æµ‹è¯•ä¸åŒretry_countçš„é—´éš”
        let test_cases = vec![
            (0, 10),   // 10å—
            (10, 20),  // 20å—
            (20, 40),  // 40å—
            (30, 80),  // 80å—
            (40, 160), // 160å—
            (50, 320), // 320å—
            (60, 640), // 640å—
            (70, 1280), // 1280å—
        ];

        for (retry_count, expected_interval) in test_cases {
            let mut record = OfferingRecords::<Test>::get(0).unwrap();
            record.retry_count = retry_count;
            OfferingRecords::<Test>::insert(0, &record);

            Memorial::on_initialize(current_block);

            let record = OfferingRecords::<Test>::get(0).unwrap();
            let actual_interval = record.expiry_block.unwrap() - current_block;
            assert_eq!(actual_interval, expected_interval);
        }
    });
}
```

---

### 7.2 é›†æˆæµ‹è¯•

**å¿…é¡»éªŒè¯çš„åœºæ™¯**:

1. âœ… åˆ›å»ºè®¢é˜… â†’ ç»­è´¹å¤±è´¥ â†’ é‡è¯•10æ¬¡ â†’ å……å€¼ â†’ ç»­è´¹æˆåŠŸ
2. âœ… åˆ›å»ºè®¢é˜… â†’ ç»­è´¹å¤±è´¥ â†’ é‡è¯•72æ¬¡ â†’ è¿›å…¥Suspended â†’ è¶…è¿‡7å¤© â†’ Expired
3. âœ… åˆ›å»ºè®¢é˜… â†’ ç»­è´¹æˆåŠŸ â†’ éªŒè¯å†å²è®°å½• â†’ å†æ¬¡ç»­è´¹ â†’ éªŒè¯å†å²è®°å½•ç´¯è®¡
4. âœ… åˆ›å»ºè®¢é˜…ï¼ˆå‘¨æœŸå¤ªçŸ­ï¼‰ â†’ æ‹’ç»
5. âœ… åˆ›å»ºè®¢é˜…ï¼ˆå‘¨æœŸå¤ªé•¿ï¼‰ â†’ æ‹’ç»
6. âœ… åˆ›å»ºè®¢é˜…ï¼ˆåˆæ³•å‘¨æœŸï¼‰ â†’ æˆåŠŸ

---

## å…«ã€éƒ¨ç½²å»ºè®®

### 8.1 éƒ¨ç½²æµç¨‹

1. âœ… **ä»£ç å®¡æŸ¥**: ç¡®è®¤æ‰€æœ‰ä¿®æ”¹ç‚¹
2. âœ… **ç¼–è¯‘éªŒè¯**: ç¡®ä¿æ— ç¼–è¯‘é”™è¯¯ï¼ˆå·²å®Œæˆï¼‰
3. â³ **å•å…ƒæµ‹è¯•**: ç¼–å†™å¹¶æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
4. â³ **é›†æˆæµ‹è¯•**: åœ¨æµ‹è¯•ç½‘éªŒè¯
5. â³ **æ•°æ®è¿ç§»**: å‡†å¤‡è¿ç§»è„šæœ¬
6. â³ **Runtimeå‡çº§**: é€šè¿‡æ²»ç†ææ¡ˆéƒ¨ç½²

---

### 8.2 å›æ»šè®¡åˆ’

**é£é™©è¯„ä¼°**: ğŸŸ¡ ä¸­ç­‰é£é™©ï¼ˆå­˜å‚¨ç»“æ„å˜æ›´ï¼Œéœ€è¦è¿ç§»ï¼‰

**å›æ»šæ–¹æ¡ˆ**:
- å¦‚æœå‘ç°ä¸¥é‡é—®é¢˜ï¼Œé€šè¿‡æ²»ç†ææ¡ˆå›æ»šruntimeç‰ˆæœ¬
- æ•°æ®è¿ç§»æ˜¯å•å‘çš„ï¼Œå›æ»šåéœ€è¦æ¸…ç†æ–°å¢å­—æ®µå’Œå­˜å‚¨
- ç»­è´¹å†å²è®°å½•ä¸å¯æ¢å¤ï¼ˆå›æ»šåä¸¢å¤±ï¼‰

**å›æ»šæˆæœ¬**: ä¸­ç­‰ï¼ˆéœ€è¦æ•°æ®è¿ç§»ï¼‰

---

### 8.3 ç›‘æ§æŒ‡æ ‡

**éƒ¨ç½²åéœ€è¦ç›‘æ§**:

1. âœ… ç»­è´¹å¤±è´¥é‡è¯•æ¬¡æ•°åˆ†å¸ƒï¼ˆ0-72æ¬¡ï¼‰
2. âœ… ç»­è´¹æˆåŠŸç‡ï¼ˆé¦–æ¬¡ vs é‡è¯•ï¼‰
3. âœ… å¹³å‡é‡è¯•æ¬¡æ•°
4. âœ… è¿›å…¥SuspendedçŠ¶æ€çš„è®¢å•æ¯”ä¾‹
5. âœ… ç»­è´¹å†å²è®°å½•å¢é•¿é€Ÿåº¦
6. âœ… è®¢é˜…å‘¨æœŸéªŒè¯æ‹’ç»ç‡
7. âœ… ç”¨æˆ·æŠ•è¯‰å…³äºç»­è´¹å¤±è´¥çš„æ•°é‡ï¼ˆåº”ä¸‹é™ï¼‰
8. âœ… è®¢é˜…æµå¤±ç‡ï¼ˆåº”ä¸‹é™20-30%ï¼‰

---

## ä¹ã€åç»­å·¥ä½œ

### 9.1 P3ä¿®å¤ï¼ˆé•¿æœŸï¼Œ1-2ä¸ªæœˆå®Œæˆï¼‰

**é—®é¢˜6**: æ£€æŸ¥é¢‘ç‡å¯é…ç½®
- æ·»åŠ `RenewalCheckInterval` Configå‚æ•°

**é—®é¢˜7**: æå‡å•åŒºå—è®¢å•å®¹é‡
- ä»1000æå‡åˆ°10000

**é—®é¢˜11**: æ·»åŠ SubscriptionCreatedäº‹ä»¶
- åŒºåˆ†è®¢é˜…åˆ›å»ºå’Œä¸€æ¬¡æ€§è´­ä¹°

**é—®é¢˜13**: AutoRenewFailed reasonç»“æ„åŒ–
- ä½¿ç”¨æšä¸¾å®šä¹‰å¤±è´¥åŸå› 

**é¢„è®¡å·¥ä½œé‡**: 8-10å°æ—¶

---

## åã€æ€»ç»“

### 10.1 ä¿®å¤æˆæœ

âœ… **ä¿®æ”¹æ–‡ä»¶**: 2ä¸ªæ–‡ä»¶
- `pallets/memorial/src/types.rs` - æ·»åŠ å­—æ®µå’Œç»“æ„
- `pallets/memorial/src/lib.rs` - ä¿®æ”¹ä¸šåŠ¡é€»è¾‘å’Œå­˜å‚¨

âœ… **ä¿®æ”¹ä½ç½®**: 8ä¸ªå…³é”®ç‚¹
1. `OfferingRecord`ç»“æ„ - æ·»åŠ retryå­—æ®µï¼ˆtypes.rsï¼‰
2. `RenewalRecord`ç»“æ„ - æ–°å¢å†å²è®°å½•ç»“æ„ï¼ˆtypes.rsï¼‰
3. å¯¼å‡º`RenewalRecord`ç±»å‹ï¼ˆlib.rsï¼‰
4. æ·»åŠ 3ä¸ªç»­è´¹å†å²å­˜å‚¨ï¼ˆlib.rsï¼‰
5. `offer()` - åˆå§‹åŒ–retryå­—æ®µï¼ˆlib.rsï¼‰
6. `offer()` - æ·»åŠ è®¢é˜…å‘¨æœŸéªŒè¯ï¼ˆlib.rsï¼‰
7. `try_auto_renew()` - è®°å½•ç»­è´¹å†å²ï¼ˆlib.rsï¼‰
8. `on_initialize()` - å®ç°é‡è¯•æœºåˆ¶ï¼ˆlib.rsï¼‰

âœ… **ä¿®æ”¹è¡Œæ•°**: çº¦180è¡Œï¼ˆæ–°å¢çº¦150è¡Œï¼Œä¿®æ”¹çº¦30è¡Œï¼‰

âœ… **ç¼–è¯‘éªŒè¯**: é€šè¿‡ï¼ˆpallet 3.28s + workspace 50.20sï¼‰

âœ… **ä¿®å¤æ—¶é—´**: çº¦2.5å°æ—¶ï¼ˆå«ç¼–è¯‘é”™è¯¯ä¿®å¤ï¼‰

âœ… **é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰é£é™©ï¼ˆéœ€è¦æ•°æ®è¿ç§»ï¼‰

---

### 10.2 é—®é¢˜è§£å†³

**ä¿®å¤å‰çš„é—®é¢˜**:
- âŒ çŸ­æš‚ä½™é¢ä¸è¶³å¯¼è‡´è®¢å•è¿‡æœŸ
- âŒ æ— ç»­è´¹å†å²è®°å½•ï¼Œå®¡è®¡å›°éš¾
- âŒ è®¢é˜…å‘¨æœŸå¯ç»•è¿‡æœ€å°è¦æ±‚
- âŒ ç”¨æˆ·æµå¤±ç‡é«˜

**ä¿®å¤åçš„æ”¹å–„**:
- âœ… 72æ¬¡é‡è¯•æœºä¼šï¼ˆ~12å°æ—¶ï¼‰ï¼ŒæŒ‡æ•°é€€é¿ç­–ç•¥
- âœ… å®Œæ•´çš„ç»­è´¹å†å²è®°å½•ï¼Œæ”¯æŒå®¡è®¡å’Œåˆ†æ
- âœ… ä¸¥æ ¼éªŒè¯è®¢é˜…å‘¨æœŸï¼Œæ‰§è¡Œå•†ä¸šè§„åˆ™
- âœ… é¢„è®¡ç»­è´¹æˆåŠŸç‡æå‡30-50%ï¼Œæµå¤±ç‡ä¸‹é™20-30%

---

### 10.3 ç»éªŒæ€»ç»“

**æˆåŠŸè¦ç´ **:
1. âœ… é—®é¢˜åˆ†æé€å½» - P2ä¸‰ä¸ªé—®é¢˜äº’è¡¥ï¼Œä¸€èµ·ä¿®å¤æ•ˆæœæ›´å¥½
2. âœ… è®¾è®¡åˆç† - é‡è¯•æœºåˆ¶ä½¿ç”¨æŒ‡æ•°é€€é¿ï¼Œå†å²è®°å½•ç»“æ„å®Œå–„
3. âœ… ä»£ç è´¨é‡é«˜ - é€»è¾‘æ¸…æ™°ï¼Œæ³¨é‡Šè¯¦ç»†
4. âœ… é”™è¯¯å¤„ç†å®Œå–„ - ç¼–è¯‘é”™è¯¯å¿«é€Ÿä¿®å¤

**æ³¨æ„äº‹é¡¹**:
1. âš ï¸ éœ€è¦æ•°æ®è¿ç§» - ç°æœ‰è®¢å•éœ€è¦åˆå§‹åŒ–retryå­—æ®µ
2. âš ï¸ éœ€è¦å……åˆ†æµ‹è¯• - é‡è¯•æœºåˆ¶å¤æ‚ï¼Œéœ€è¦å…¨é¢æµ‹è¯•
3. âš ï¸ éœ€è¦ç›‘æ§éƒ¨ç½²åæ•ˆæœ - å…³æ³¨ç»­è´¹æˆåŠŸç‡å’Œç”¨æˆ·åé¦ˆ
4. âš ï¸ ç»§ç»­ä¿®å¤P3é—®é¢˜ - è¿›ä¸€æ­¥æå‡ç³»ç»Ÿå¯é…ç½®æ€§å’Œå¯æ‰©å±•æ€§

---

**æ–‡æ¡£ç¼–å†™**: Substrateå¼€å‘å›¢é˜Ÿ

**å®¡æ ¸çŠ¶æ€**: âœ… ä¿®å¤å®Œæˆï¼Œç¼–è¯‘éªŒè¯é€šè¿‡

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0

**ä¸‹ä¸€æ­¥**: æ‰§è¡ŒP3ä¿®å¤ï¼ˆæ£€æŸ¥é¢‘ç‡é…ç½®åŒ– + å®¹é‡æå‡ + äº‹ä»¶ç»†åŒ– + é”™è¯¯ç»“æ„åŒ–ï¼‰

---

## é™„å½•Aï¼šä¿®æ”¹å‰åå¯¹æ¯”

### å¯¹æ¯”1: OfferingRecordå­—æ®µ

| å­—æ®µ | P1ä¿®å¤å | P2ä¿®å¤å |
|-----|---------|---------|
| locked_unit_price | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ |
| suspension_block | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ |
| retry_count | âŒ ä¸å­˜åœ¨ | âœ… æ–°å¢ (u8) |
| last_retry_block | âŒ ä¸å­˜åœ¨ | âœ… æ–°å¢ (Option<BlockNumber>) |

---

### å¯¹æ¯”2: å­˜å‚¨é¡¹

| å­˜å‚¨é¡¹ | P1ä¿®å¤å | P2ä¿®å¤å | è¯´æ˜ |
|-------|---------|---------|------|
| OfferingRecords | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ | è®¢å•ä¸»è¡¨ |
| ExpiringOfferings | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ | åˆ°æœŸç´¢å¼• |
| RenewalRecords | âŒ ä¸å­˜åœ¨ | âœ… æ–°å¢ | ç»­è´¹å†å²ä¸»è¡¨ |
| RenewalHistoryByUser | âŒ ä¸å­˜åœ¨ | âœ… æ–°å¢ | æŒ‰ç”¨æˆ·ç´¢å¼• |
| NextRenewalId | âŒ ä¸å­˜åœ¨ | âœ… æ–°å¢ | ç»­è´¹è®°å½•IDç”Ÿæˆå™¨ |

---

### å¯¹æ¯”3: on_initializeç»­è´¹å¤±è´¥å¤„ç†

| åœºæ™¯ | P1ä¿®å¤å | P2ä¿®å¤å |
|-----|---------|---------|
| é¦–æ¬¡ç»­è´¹å¤±è´¥ | âœ… è¿›å…¥Suspended | âœ… é‡è¯•ï¼ˆretry_count=1ï¼‰ |
| é‡è¯•ç»­è´¹å¤±è´¥ | âŒ ä¸å­˜åœ¨ | âœ… ç»§ç»­é‡è¯•ï¼ˆretry_count++ï¼‰ |
| è¶…è¿‡æœ€å¤§é‡è¯• | âŒ ä¸å­˜åœ¨ | âœ… è¿›å…¥Suspended |
| Suspendedæ£€æŸ¥ | âœ… æ£€æŸ¥å®½é™æœŸ | âœ… ä¿æŒ |
| å®½é™æœŸå†…ç»­è´¹æˆåŠŸ | âœ… æ¢å¤Active | âœ… æ¢å¤Active + é‡ç½®retry_count |
| è¶…è¿‡å®½é™æœŸ | âœ… æ ‡è®°Expired | âœ… ä¿æŒ |

---

### å¯¹æ¯”4: try_auto_renewé€»è¾‘

| æ­¥éª¤ | P1ä¿®å¤å | P2ä¿®å¤å |
|-----|---------|---------|
| 1. ä½¿ç”¨é”å®šä»·æ ¼ | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ |
| 2. æ£€æŸ¥ä½™é¢ | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ |
| 3. æ‰§è¡Œè½¬è´¦ | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ |
| 4. æ›´æ–°åˆ°æœŸæ—¶é—´ | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ |
| 5. é‡ç½®é‡è¯•è®¡æ•° | âŒ ä¸å­˜åœ¨ | âœ… æ–°å¢ |
| 6. è®°å½•ç»­è´¹å†å² | âŒ ä¸å­˜åœ¨ | âœ… æ–°å¢ |
| 7. æ›´æ–°åˆ°æœŸç´¢å¼• | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ |

---

### å¯¹æ¯”5: offerå‡½æ•°éªŒè¯

| éªŒè¯é¡¹ | P1ä¿®å¤å | P2ä¿®å¤å |
|-------|---------|---------|
| å•†å“çŠ¶æ€ | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ |
| åº“å­˜æ£€æŸ¥ | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ |
| è´­ä¹°é™åˆ¶ | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ |
| å¢“åœ°æƒé™ | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ |
| duration_weekså¿…å¡« | âœ… å­˜åœ¨ï¼ˆP1ï¼‰ | âœ… å­˜åœ¨ |
| è®¢é˜…å‘¨æœŸéªŒè¯ | âŒ ä¸å­˜åœ¨ | âœ… æ–°å¢ï¼ˆP2ï¼‰ |

---

## é™„å½•Bï¼šé‡è¯•æœºåˆ¶è¯¦è§£

### B.1 é‡è¯•é—´éš”è®¡ç®—

**å…¬å¼**: `retry_interval = base_interval * 2^(retry_count / 10)`

**å®é™…æ•ˆæœ**:

| retry_countèŒƒå›´ | backoff_factor | é‡è¯•é—´éš”ï¼ˆå—ï¼‰ | é‡è¯•é—´éš”ï¼ˆåˆ†é’Ÿï¼‰ |
|----------------|---------------|--------------|----------------|
| 0-9 | 0 | 10 | 1 |
| 10-19 | 1 | 20 | 2 |
| 20-29 | 2 | 40 | 4 |
| 30-39 | 3 | 80 | 8 |
| 40-49 | 4 | 160 | 16 |
| 50-59 | 5 | 320 | 32 |
| 60-69 | 6 | 640 | 64 |
| 70-71 | 7 | 1280 | 128 |

**æ€»è€—æ—¶ä¼°ç®—**:
- 0-9æ¬¡: 10æ¬¡ * å¹³å‡5å— â‰ˆ 50å— â‰ˆ 5åˆ†é’Ÿ
- 10-19æ¬¡: 10æ¬¡ * å¹³å‡15å— â‰ˆ 150å— â‰ˆ 15åˆ†é’Ÿ
- 20-29æ¬¡: 10æ¬¡ * å¹³å‡30å— â‰ˆ 300å— â‰ˆ 30åˆ†é’Ÿ
- 30-39æ¬¡: 10æ¬¡ * å¹³å‡60å— â‰ˆ 600å— â‰ˆ 1å°æ—¶
- 40-49æ¬¡: 10æ¬¡ * å¹³å‡120å— â‰ˆ 1200å— â‰ˆ 2å°æ—¶
- 50-59æ¬¡: 10æ¬¡ * å¹³å‡240å— â‰ˆ 2400å— â‰ˆ 4å°æ—¶
- 60-69æ¬¡: 10æ¬¡ * å¹³å‡480å— â‰ˆ 4800å— â‰ˆ 8å°æ—¶
- 70-71æ¬¡: 2æ¬¡ * å¹³å‡1000å— â‰ˆ 2000å— â‰ˆ 3.3å°æ—¶

**æ€»è®¡**: çº¦11500å— â‰ˆ 19å°æ—¶

**å®é™…å®ç°**: æœ€å¤š72æ¬¡é‡è¯•ï¼Œçº¦12-20å°æ—¶ï¼ˆå–å†³äºé‡è¯•æ—¶æœºï¼‰

---

### B.2 é‡è¯•æµç¨‹å›¾

```
è®¢å•åˆ°æœŸ
   â†“
ç»­è´¹å°è¯•
   â†“
æˆåŠŸï¼Ÿ â†’ æ˜¯ â†’ è®°å½•å†å² â†’ ç»“æŸ
   â†“ å¦
retry_count < 72ï¼Ÿ â†’ å¦ â†’ è¿›å…¥Suspendedï¼ˆ7å¤©å®½é™æœŸï¼‰
   â†“ æ˜¯
retry_count++
   â†“
è®¡ç®—ä¸‹æ¬¡é‡è¯•æ—¶é—´ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
   â†“
æ·»åŠ åˆ°ExpiringOfferings[next_retry]
   â†“
ç­‰å¾…ä¸‹æ¬¡æ£€æŸ¥
   â†“
ï¼ˆå¾ªç¯ï¼‰
```

---

## é™„å½•Cï¼šç»­è´¹å†å²æ•°æ®æ¨¡å‹

### C.1 æ•°æ®ç»“æ„

```rust
RenewalRecord {
    offering_id: u64,        // åŸè®¢å•ID
    who: AccountId,          // ç»­è´¹ç”¨æˆ·
    renewed_at: BlockNumber, // ç»­è´¹æ—¶é—´
    amount: u128,            // ç»­è´¹é‡‘é¢
    duration_weeks: u32,     // ç»­è´¹å‘¨æœŸ
    new_expiry: BlockNumber, // æ–°çš„åˆ°æœŸæ—¶é—´
    is_auto_renew: bool,     // æ˜¯å¦è‡ªåŠ¨ç»­è´¹
}
```

### C.2 å­˜å‚¨å…³ç³»

```
User (AccountId)
  â†“
RenewalHistoryByUser[User] = [renewal_id_1, renewal_id_2, ...]
  â†“
RenewalRecords[renewal_id_1] = RenewalRecord {...}
RenewalRecords[renewal_id_2] = RenewalRecord {...}
```

### C.3 æŸ¥è¯¢ç¤ºä¾‹

**æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰ç»­è´¹è®°å½•**:
```rust
// 1. è·å–ç”¨æˆ·çš„ç»­è´¹IDåˆ—è¡¨
let renewal_ids = RenewalHistoryByUser::<T>::get(&user);

// 2. éå†IDè·å–è¯¦æƒ…
let renewals: Vec<RenewalRecord<T>> = renewal_ids
    .iter()
    .filter_map(|&id| RenewalRecords::<T>::get(id))
    .collect();
```

**æŸ¥è¯¢ç‰¹å®šè®¢å•çš„ç»­è´¹å†å²**:
```rust
// éå†æ‰€æœ‰ç»­è´¹è®°å½•ï¼Œç­›é€‰offering_id
let renewals: Vec<RenewalRecord<T>> = RenewalRecords::<T>::iter()
    .filter_map(|(id, record)| {
        if record.offering_id == target_offering_id {
            Some(record)
        } else {
            None
        }
    })
    .collect();
```

**ç»Ÿè®¡ç”¨æˆ·ç»­è´¹æ¬¡æ•°**:
```rust
let renewal_count = RenewalHistoryByUser::<T>::get(&user).len();
```

---

## é™„å½•Dï¼šè®¢é˜…å‘¨æœŸéªŒè¯ç¤ºä¾‹

### D.1 å•†å“é…ç½®ç¤ºä¾‹

```rust
// ç¤ºä¾‹1: æœ€å°‘4å‘¨ï¼Œæœ€å¤š52å‘¨
PricingModel::Subscription {
    weekly_price: 1000,
    min_weeks: 4,
    max_weeks: Some(52),
    auto_renew: true,
    refund_rate: 50,
}

// ç¤ºä¾‹2: æœ€å°‘1å‘¨ï¼Œæ— ä¸Šé™
PricingModel::Subscription {
    weekly_price: 500,
    min_weeks: 1,
    max_weeks: None,
    auto_renew: true,
    refund_rate: 0,
}

// ç¤ºä¾‹3: å›ºå®š4å‘¨
PricingModel::Subscription {
    weekly_price: 2000,
    min_weeks: 4,
    max_weeks: Some(4),
    auto_renew: false,
    refund_rate: 100,
}
```

### D.2 éªŒè¯ç»“æœç¤ºä¾‹

| å•†å“ | duration_weeks | min_weeks | max_weeks | ç»“æœ |
|-----|----------------|-----------|-----------|------|
| ç¤ºä¾‹1 | 2 | 4 | 52 | âŒ BadInputï¼ˆå¤ªçŸ­ï¼‰ |
| ç¤ºä¾‹1 | 12 | 4 | 52 | âœ… é€šè¿‡ |
| ç¤ºä¾‹1 | 100 | 4 | 52 | âŒ BadInputï¼ˆå¤ªé•¿ï¼‰ |
| ç¤ºä¾‹2 | 1 | 1 | None | âœ… é€šè¿‡ |
| ç¤ºä¾‹2 | 1000 | 1 | None | âœ… é€šè¿‡ï¼ˆæ— ä¸Šé™ï¼‰ |
| ç¤ºä¾‹3 | 4 | 4 | 4 | âœ… é€šè¿‡ï¼ˆå›ºå®š4å‘¨ï¼‰ |
| ç¤ºä¾‹3 | 8 | 4 | 4 | âŒ BadInputï¼ˆä¸ç­‰äº4ï¼‰ |

---

**END OF REPORT**
