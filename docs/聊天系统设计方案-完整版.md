# Substrate åŒºå—é“¾èŠå¤©ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ æ–‡æ¡£æ¦‚è¿°

æœ¬æ–¹æ¡ˆè¯¦ç»†è®¾è®¡åŸºäº Substrate åŒºå—é“¾çš„å®Œæ•´èŠå¤©ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š
- âœ… **ä¸€å¯¹ä¸€ç§èŠ**ï¼ˆå·²å®ç°ï¼Œç«¯åˆ°ç«¯åŠ å¯†ï¼‰
- ğŸ†• **ç¾¤èŠåŠŸèƒ½**ï¼ˆå¾…å®ç°ï¼Œæ”¯æŒåŠ å¯†ç¾¤å’ŒéåŠ å¯†ç¾¤ï¼‰
- ğŸ” **ç«¯åˆ°ç«¯åŠ å¯†**ï¼ˆç§èŠåŠåŠ å¯†ç¾¤ï¼‰
- ğŸŒ **å…¬å¼€ç¾¤èŠ**ï¼ˆéåŠ å¯†ç¾¤ï¼Œæ¶ˆæ¯å…¬å¼€å¯è¯»ï¼‰
- ğŸ“¦ **IPFS æ··åˆå­˜å‚¨**
- ğŸ›¡ï¸ **å®‰å…¨ä¸éšç§ä¿æŠ¤**
- ğŸ”‘ **çµæ´»çš„åŠ å¯†ç­–ç•¥**ï¼ˆç”¨æˆ·å¯é€‰æ‹©åˆ›å»ºåŠ å¯†ç¾¤æˆ–éåŠ å¯†ç¾¤ï¼‰

---

## ğŸ”‘ åŠ å¯†ç¾¤ vs éåŠ å¯†ç¾¤å¿«é€Ÿå¯¹æ¯”

| ç»´åº¦ | åŠ å¯†ç¾¤ | éåŠ å¯†ç¾¤ |
|------|--------|---------|
| **åŠ å¯†æ¨¡å¼** | `EncryptionMode::Encrypted` | `EncryptionMode::Unencrypted` |
| **æ¶ˆæ¯å­˜å‚¨** | IPFSåŠ å¯†æ•°æ® | IPFSæ˜æ–‡æ•°æ® |
| **éšç§ä¿æŠ¤** | âœ… ç«¯åˆ°ç«¯åŠ å¯† | âŒ æ— åŠ å¯† |
| **ç¾¤å¯†é’¥** | å¿…é¡»ï¼ˆ`group_key_cid`ï¼‰ | ä¸éœ€è¦ï¼ˆ`None`ï¼‰ |
| **æˆå‘˜è®¿é—®** | ä»…æˆå‘˜å¯è¯» | æˆå‘˜å¯è¯»ï¼Œå¯é…ç½®å…¬å¼€ |
| **éæˆå‘˜è®¿é—®** | âŒ ç¦æ­¢ | âœ… å¯é€‰å…è®¸ |
| **æ€§èƒ½** | ç¨æ…¢ï¼ˆåŠ è§£å¯†å¼€é”€ï¼‰ | å¿«ï¼ˆæ— åŠ å¯†ï¼‰ |
| **CIDéªŒè¯** | å¿…é¡»åŠ å¯† | å…è®¸æ˜æ–‡ |
| **é€‚ç”¨åœºæ™¯** | ç§å¯†è®¨è®ºã€å•†ä¸šæœºå¯† | å…¬å‘Šã€å…¬å¼€è®¨è®ºã€DAO |
| **æˆå‘˜å˜æ›´** | éœ€æ›´æ–°å¯†é’¥ | æ— éœ€ç‰¹æ®Šå¤„ç† |
| **æ¶ˆæ¯å®¡è®¡** | âŒ ä¸å¯å®¡è®¡ | âœ… å…¬å¼€å¯å®¡è®¡ |
| **æœç´¢å¼•æ“** | âŒ ä¸å¯ç´¢å¼• | âœ… å¯ç´¢å¼•ï¼ˆå¦‚å…¬å¼€ï¼‰ |

---

## ğŸ“ æ€»ä½“æ¶æ„

### 1. æ··åˆå­˜å‚¨æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å‰ç«¯åº”ç”¨å±‚                                â”‚
â”‚  (React DApp - æ¶ˆæ¯åŠ å¯†/è§£å¯† + UIäº¤äº’)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  åŒºå—é“¾å±‚ (Substrate)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  pallet-chat (ä¸€å¯¹ä¸€ç§èŠ - å·²å®ç°)                    â”‚   â”‚
â”‚  â”‚  - æ¶ˆæ¯å…ƒæ•°æ®å­˜å‚¨                                     â”‚   â”‚
â”‚  â”‚  - ä¼šè¯ç®¡ç†                                           â”‚   â”‚
â”‚  â”‚  - å·²è¯»/æœªè¯»çŠ¶æ€                                      â”‚   â”‚
â”‚  â”‚  - é»‘åå•ç®¡ç†                                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  pallet-group-chat (ç¾¤èŠ - å¾…å®ç°)                   â”‚   â”‚
â”‚  â”‚  - ç¾¤ç»„ç®¡ç†                                           â”‚   â”‚
â”‚  â”‚  - æˆå‘˜æƒé™                                           â”‚   â”‚
â”‚  â”‚  - ç¾¤æ¶ˆæ¯å…ƒæ•°æ®                                       â”‚   â”‚
â”‚  â”‚  - å…¬å‘Š/ç½®é¡¶                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 IPFS å­˜å‚¨å±‚                                   â”‚
â”‚  - åŠ å¯†çš„æ¶ˆæ¯å†…å®¹ (æ–‡æœ¬/å›¾ç‰‡/æ–‡ä»¶)                            â”‚
â”‚  - ç¾¤æ–‡ä»¶å…±äº«                                                â”‚
â”‚  - åª’ä½“æ–‡ä»¶                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æ•°æ®æµè®¾è®¡

#### å‘é€æ¶ˆæ¯æµç¨‹
```text
ç”¨æˆ·A â†’ å‰ç«¯åŠ å¯†æ¶ˆæ¯ â†’ ä¸Šä¼ åˆ°IPFS â†’ è·å–CID
  â†’ è°ƒç”¨é“¾ä¸Šextrinsic â†’ å­˜å‚¨å…ƒæ•°æ®åˆ°åŒºå—é“¾ â†’ è§¦å‘äº‹ä»¶
  â†’ ç”¨æˆ·Bç›‘å¬äº‹ä»¶ â†’ ä»é“¾ä¸Šè·å–å…ƒæ•°æ® â†’ ä»IPFSä¸‹è½½ â†’ å‰ç«¯è§£å¯† â†’ æ˜¾ç¤º
```

#### å­˜å‚¨åˆ†å±‚ç­–ç•¥
| å­˜å‚¨å±‚ | å­˜å‚¨å†…å®¹ | ä¼˜åŠ¿ |
|--------|---------|------|
| **é“¾ä¸Š** | æ¶ˆæ¯å…ƒæ•°æ®ï¼ˆå‘é€è€…ã€æ¥æ”¶è€…ã€CIDã€æ—¶é—´æˆ³ã€ç±»å‹ã€çŠ¶æ€ï¼‰ | ä¸å¯ç¯¡æ”¹ã€å¯éªŒè¯ã€å¯æŸ¥è¯¢ |
| **IPFS** | åŠ å¯†çš„æ¶ˆæ¯å†…å®¹ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ã€æ–‡ä»¶ï¼‰ | å»ä¸­å¿ƒåŒ–ã€èŠ‚çœé“¾ä¸Šç©ºé—´ã€å¤§æ–‡ä»¶æ”¯æŒ |
| **å‰ç«¯** | å¯†é’¥ç®¡ç†ã€åŠ å¯†/è§£å¯†é€»è¾‘ã€æœ¬åœ°ç¼“å­˜ | ç«¯åˆ°ç«¯åŠ å¯†ã€ç”¨æˆ·éšç§ |

---

## ğŸ” ä¸€å¯¹ä¸€ç§èŠï¼ˆpallet-chatï¼‰

### å½“å‰å®ç°çŠ¶æ€

âœ… **å·²å®ç°åŠŸèƒ½**ï¼ˆåŸºäº `/pallets/chat/src/lib.rs`ï¼‰ï¼š

1. **æ¶ˆæ¯ç®¡ç†**
   - å‘é€æ¶ˆæ¯ `send_message()`
   - æ ‡è®°å·²è¯» `mark_as_read()`
   - è½¯åˆ é™¤ `delete_message()`
   - æ‰¹é‡æ ‡è®°å·²è¯» `mark_batch_as_read()`

2. **ä¼šè¯ç®¡ç†**
   - è‡ªåŠ¨åˆ›å»ºä¼šè¯ `create_session()`
   - ä¼šè¯å½’æ¡£ `archive_session()`
   - ä¼šè¯æ ‡è®°å·²è¯» `mark_session_as_read()`

3. **å®‰å…¨ä¸éšç§**
   - é»‘åå• `block_user()` / `unblock_user()`
   - é¢‘ç‡é™åˆ¶ï¼ˆé˜²åƒåœ¾æ¶ˆæ¯ï¼‰
   - CID åŠ å¯†éªŒè¯
   - è½¯åˆ é™¤ï¼ˆåŒæ–¹ç‹¬ç«‹åˆ é™¤ï¼‰

4. **æŸ¥è¯¢åŠŸèƒ½**
   - åˆ†é¡µæŸ¥è¯¢æ¶ˆæ¯ `list_messages_by_session()`
   - æŸ¥è¯¢ç”¨æˆ·ä¼šè¯åˆ—è¡¨ `list_sessions()`
   - æœªè¯»æ¶ˆæ¯ç»Ÿè®¡ `get_unread_count()`

### æ•°æ®ç»“æ„

#### æ¶ˆæ¯å…ƒæ•°æ®ï¼ˆMessageMetaï¼‰
```rust
pub struct MessageMeta<T: Config> {
    pub sender: T::AccountId,              // å‘é€æ–¹
    pub receiver: T::AccountId,            // æ¥æ”¶æ–¹
    pub content_cid: BoundedVec<u8, _>,   // IPFS CIDï¼ˆåŠ å¯†å†…å®¹ï¼‰
    pub session_id: T::Hash,               // ä¼šè¯ID
    pub msg_type: MessageType,             // æ¶ˆæ¯ç±»å‹
    pub sent_at: BlockNumberFor<T>,        // å‘é€æ—¶é—´
    pub is_read: bool,                     // æ˜¯å¦å·²è¯»
    pub is_deleted_by_sender: bool,        // å‘é€æ–¹å·²åˆ é™¤
    pub is_deleted_by_receiver: bool,      // æ¥æ”¶æ–¹å·²åˆ é™¤
}
```

#### ä¼šè¯ä¿¡æ¯ï¼ˆSessionï¼‰
```rust
pub struct Session<T: Config> {
    pub id: T::Hash,                                // ä¼šè¯ID
    pub participants: BoundedVec<T::AccountId, 2>, // å‚ä¸è€…ï¼ˆå›ºå®š2äººï¼‰
    pub last_message_id: u64,                       // æœ€åä¸€æ¡æ¶ˆæ¯ID
    pub last_active: BlockNumberFor<T>,             // æœ€åæ´»è·ƒæ—¶é—´
    pub created_at: BlockNumberFor<T>,              // åˆ›å»ºæ—¶é—´
    pub is_archived: bool,                          // æ˜¯å¦å½’æ¡£
}
```

### å­˜å‚¨æ˜ å°„

| Storage | Key | Value | è¯´æ˜ |
|---------|-----|-------|------|
| `Messages` | u64 | MessageMeta | æ¶ˆæ¯å…ƒæ•°æ® |
| `Sessions` | Hash | Session | ä¼šè¯ä¿¡æ¯ |
| `UserSessions` | (AccountId, Hash) | () | ç”¨æˆ·ä¼šè¯ç´¢å¼• |
| `SessionMessages` | (Hash, u64) | () | ä¼šè¯æ¶ˆæ¯ç´¢å¼• |
| `UnreadCount` | (AccountId, Hash) | u32 | æœªè¯»æ¶ˆæ¯è®¡æ•° |
| `Blacklist` | (AccountId, AccountId) | () | é»‘åå• |
| `MessageRateLimit` | AccountId | (BlockNumber, u32) | é¢‘ç‡é™åˆ¶ |

### äº‹ä»¶ï¼ˆEventsï¼‰

```rust
MessageSent { msg_id, session_id, sender, receiver }
MessageRead { msg_id, reader }
MessageDeleted { msg_id, deleter }
SessionCreated { session_id, participants }
SessionMarkedAsRead { session_id, user }
SessionArchived { session_id, operator }
UserBlocked { blocker, blocked }
UserUnblocked { unblocker, unblocked }
OldMessagesCleanedUp { operator, count }
```

### æƒé‡é…ç½®

| å‡½æ•° | è¯»æ“ä½œ | å†™æ“ä½œ | æƒé‡ä¼°ç®— |
|------|--------|--------|---------|
| `send_message` | 5æ¬¡ | 4æ¬¡ | 525M |
| `mark_as_read` | 2æ¬¡ | 2æ¬¡ | 250M |
| `delete_message` | 1æ¬¡ | 1æ¬¡ | 125M |
| `mark_batch_as_read` | næ¬¡ | næ¬¡ | 125M Ã— n |

---

## ğŸ‘¥ ç¾¤èŠåŠŸèƒ½ï¼ˆpallet-group-chatï¼‰

### è®¾è®¡ç›®æ ‡

- æ”¯æŒå¤šäººç¾¤èŠï¼ˆ2-500äººå¯é…ç½®ï¼‰
- ç¾¤ç»„æƒé™ç®¡ç†ï¼ˆç¾¤ä¸»ã€ç®¡ç†å‘˜ã€æˆå‘˜ï¼‰
- ç¾¤å…¬å‘Šã€ç¾¤æ–‡ä»¶ã€ç¾¤æŠ•ç¥¨
- æˆå‘˜ç®¡ç†ï¼ˆé‚€è¯·ã€ç§»é™¤ã€ç¦è¨€ï¼‰
- ç¾¤æ¶ˆæ¯åˆ†é¡µæŸ¥è¯¢
- ç¾¤èŠä¸ç§èŠæ¶æ„ä¸€è‡´

### æ ¸å¿ƒæ•°æ®ç»“æ„

#### 1. ç¾¤ç»„ä¿¡æ¯ï¼ˆGroupInfoï¼‰
```rust
#[derive(Encode, Decode, Clone, PartialEq, Eq, RuntimeDebug, TypeInfo, MaxEncodedLen)]
#[scale_info(skip_type_params(T))]
pub struct GroupInfo<T: Config> {
    /// ç¾¤ç»„ID
    pub id: T::Hash,
    /// ç¾¤åç§°
    pub name: BoundedVec<u8, T::MaxGroupNameLen>,
    /// ç¾¤å¤´åƒCIDï¼ˆå¯é€‰ï¼‰
    pub avatar_cid: Option<BoundedVec<u8, T::MaxCidLen>>,
    /// ç¾¤ä»‹ç»
    pub description: BoundedVec<u8, T::MaxGroupDescLen>,
    /// ç¾¤ä¸»
    pub owner: T::AccountId,
    /// åˆ›å»ºæ—¶é—´
    pub created_at: BlockNumberFor<T>,
    /// æˆå‘˜æ•°é‡
    pub member_count: u32,
    /// ç¾¤ç»„ç±»å‹
    pub group_type: GroupType,
    /// åŠ å¯†æ¨¡å¼ï¼ˆåˆ›å»ºåä¸å¯æ›´æ”¹ï¼‰
    pub encryption_mode: EncryptionMode,
    /// ç¾¤å¯†é’¥ä¿¡æ¯CIDï¼ˆä»…åŠ å¯†ç¾¤ä½¿ç”¨ï¼Œå­˜å‚¨æ‰€æœ‰æˆå‘˜çš„åŠ å¯†ç¾¤å¯†é’¥ï¼‰
    pub group_key_cid: Option<BoundedVec<u8, T::MaxCidLen>>,
    /// æ˜¯å¦éœ€è¦å®¡æ‰¹åŠ å…¥
    pub join_approval_required: bool,
    /// å…¨å‘˜ç¦è¨€
    pub mute_all: bool,
    /// æœ€å¤§æˆå‘˜æ•°
    pub max_members: u32,
    /// æ˜¯å¦å…¬å¼€å¯è§ï¼ˆéåŠ å¯†ç¾¤ä¸“ç”¨ï¼Œæ§åˆ¶æ˜¯å¦å…è®¸éæˆå‘˜æŸ¥çœ‹æ¶ˆæ¯ï¼‰
    pub is_public_readable: bool,
}

/// ç¾¤ç»„ç±»å‹
#[derive(Encode, Decode, Clone, Copy, PartialEq, Eq, TypeInfo, MaxEncodedLen, RuntimeDebug)]
pub enum GroupType {
    /// æ™®é€šç¾¤ï¼ˆä»»ä½•äººå¯åˆ›å»ºï¼‰
    Normal,
    /// ä¼šå‘˜ç¾¤ï¼ˆéœ€è¦ä¼šå‘˜èµ„æ ¼ï¼‰
    Premium,
    /// å®˜æ–¹ç¾¤ï¼ˆéœ€è¦æ²»ç†æ‰¹å‡†ï¼‰
    Official,
}

/// ç¾¤ç»„åŠ å¯†æ¨¡å¼
#[derive(Encode, Decode, Clone, Copy, PartialEq, Eq, TypeInfo, MaxEncodedLen, RuntimeDebug)]
pub enum EncryptionMode {
    /// åŠ å¯†ç¾¤ï¼šæ¶ˆæ¯ç«¯åˆ°ç«¯åŠ å¯†ï¼Œåªæœ‰æˆå‘˜å¯è¯»
    Encrypted,
    /// éåŠ å¯†ç¾¤ï¼šæ¶ˆæ¯æ˜æ–‡å­˜å‚¨åœ¨IPFSï¼Œä»»ä½•äººå¯è¯»ï¼ˆå…¬å¼€ç¾¤ï¼‰
    Unencrypted,
}
```

#### 2. ç¾¤æˆå‘˜ä¿¡æ¯ï¼ˆGroupMemberï¼‰
```rust
#[derive(Encode, Decode, Clone, PartialEq, Eq, RuntimeDebug, TypeInfo, MaxEncodedLen)]
#[scale_info(skip_type_params(T))]
pub struct GroupMember<T: Config> {
    /// æˆå‘˜è´¦æˆ·
    pub account: T::AccountId,
    /// æˆå‘˜è§’è‰²
    pub role: MemberRole,
    /// åŠ å…¥æ—¶é—´
    pub joined_at: BlockNumberFor<T>,
    /// ç¾¤æ˜µç§°
    pub nickname: Option<BoundedVec<u8, T::MaxNicknameLen>>,
    /// æ˜¯å¦è¢«ç¦è¨€
    pub is_muted: bool,
    /// ç¦è¨€åˆ°æœŸæ—¶é—´ï¼ˆNoneè¡¨ç¤ºæ°¸ä¹…ç¦è¨€ï¼‰
    pub mute_until: Option<BlockNumberFor<T>>,
    /// æœ€åå‘è¨€æ—¶é—´
    pub last_message_at: BlockNumberFor<T>,
}

/// æˆå‘˜è§’è‰²
#[derive(Encode, Decode, Clone, Copy, PartialEq, Eq, TypeInfo, MaxEncodedLen, RuntimeDebug)]
pub enum MemberRole {
    /// ç¾¤ä¸»ï¼ˆæ‹¥æœ‰æ‰€æœ‰æƒé™ï¼‰
    Owner = 0,
    /// ç®¡ç†å‘˜ï¼ˆå¯ç®¡ç†æˆå‘˜ã€æ¶ˆæ¯ï¼‰
    Admin = 1,
    /// æ™®é€šæˆå‘˜
    Member = 2,
}
```

#### 3. ç¾¤æ¶ˆæ¯å…ƒæ•°æ®ï¼ˆGroupMessageMetaï¼‰
```rust
#[derive(Encode, Decode, Clone, PartialEq, Eq, RuntimeDebug, TypeInfo, MaxEncodedLen)]
#[scale_info(skip_type_params(T))]
pub struct GroupMessageMeta<T: Config> {
    /// æ¶ˆæ¯ID
    pub id: u64,
    /// ç¾¤ç»„ID
    pub group_id: T::Hash,
    /// å‘é€æ–¹
    pub sender: T::AccountId,
    /// æ¶ˆæ¯å†…å®¹CIDï¼ˆåŠ å¯†ï¼‰
    pub content_cid: BoundedVec<u8, T::MaxCidLen>,
    /// æ¶ˆæ¯ç±»å‹
    pub msg_type: GroupMessageType,
    /// å‘é€æ—¶é—´
    pub sent_at: BlockNumberFor<T>,
    /// æ˜¯å¦è¢«æ’¤å›
    pub is_recalled: bool,
    /// æ’¤å›æ—¶é—´
    pub recalled_at: Option<BlockNumberFor<T>>,
    /// æ˜¯å¦ç½®é¡¶
    pub is_pinned: bool,
    /// å¼•ç”¨çš„æ¶ˆæ¯IDï¼ˆå›å¤åŠŸèƒ½ï¼‰
    pub reply_to: Option<u64>,
}

/// ç¾¤æ¶ˆæ¯ç±»å‹
#[derive(Encode, Decode, Clone, Copy, PartialEq, Eq, TypeInfo, MaxEncodedLen, RuntimeDebug)]
pub enum GroupMessageType {
    /// æ–‡æœ¬æ¶ˆæ¯
    Text,
    /// å›¾ç‰‡æ¶ˆæ¯
    Image,
    /// æ–‡ä»¶æ¶ˆæ¯
    File,
    /// è¯­éŸ³æ¶ˆæ¯
    Voice,
    /// è§†é¢‘æ¶ˆæ¯
    Video,
    /// ç³»ç»Ÿæ¶ˆæ¯ï¼ˆæˆå‘˜åŠ å…¥/é€€å‡ºç­‰ï¼‰
    System,
    /// å…¬å‘Šæ¶ˆæ¯
    Announcement,
}
```

#### 4. ç¾¤å…¬å‘Šï¼ˆGroupAnnouncementï¼‰
```rust
#[derive(Encode, Decode, Clone, PartialEq, Eq, RuntimeDebug, TypeInfo, MaxEncodedLen)]
#[scale_info(skip_type_params(T))]
pub struct GroupAnnouncement<T: Config> {
    /// å…¬å‘ŠID
    pub id: u32,
    /// ç¾¤ç»„ID
    pub group_id: T::Hash,
    /// å…¬å‘Šå†…å®¹CID
    pub content_cid: BoundedVec<u8, T::MaxCidLen>,
    /// å‘å¸ƒè€…
    pub publisher: T::AccountId,
    /// å‘å¸ƒæ—¶é—´
    pub published_at: BlockNumberFor<T>,
    /// æ˜¯å¦ç½®é¡¶
    pub is_pinned: bool,
}
```

### å­˜å‚¨æ˜ å°„è®¾è®¡

| Storage | Type | Key | Value | è¯´æ˜ |
|---------|------|-----|-------|------|
| `Groups` | StorageMap | T::Hash | GroupInfo | ç¾¤ç»„ä¿¡æ¯ |
| `GroupMembers` | StorageDoubleMap | (T::Hash, T::AccountId) | GroupMember | ç¾¤æˆå‘˜ä¿¡æ¯ |
| `GroupMessages` | StorageMap | u64 | GroupMessageMeta | ç¾¤æ¶ˆæ¯å…ƒæ•°æ® |
| `GroupMessageList` | StorageDoubleMap | (T::Hash, u64) | () | ç¾¤æ¶ˆæ¯ç´¢å¼• |
| `UserGroups` | StorageDoubleMap | (T::AccountId, T::Hash) | () | ç”¨æˆ·ç¾¤ç»„ç´¢å¼• |
| `GroupAnnouncements` | StorageDoubleMap | (T::Hash, u32) | GroupAnnouncement | ç¾¤å…¬å‘Š |
| `GroupInvitations` | StorageDoubleMap | (T::Hash, T::AccountId) | InvitationStatus | ç¾¤é‚€è¯·çŠ¶æ€ |
| `MemberReadStatus` | StorageDoubleMap | (T::Hash, T::AccountId) | u64 | æˆå‘˜å·²è¯»æ¶ˆæ¯ID |
| `NextGroupMessageId` | StorageValue | _ | u64 | ä¸‹ä¸€ä¸ªç¾¤æ¶ˆæ¯ID |
| `NextAnnouncementId` | StorageMap | T::Hash | u32 | ä¸‹ä¸€ä¸ªå…¬å‘ŠID |

### å¯è°ƒç”¨å‡½æ•°ï¼ˆExtrinsicsï¼‰

#### ç¾¤ç»„ç®¡ç†

```rust
/// 1. åˆ›å»ºç¾¤ç»„
#[pallet::call_index(0)]
pub fn create_group(
    origin: OriginFor<T>,
    name: Vec<u8>,
    description: Vec<u8>,
    avatar_cid: Option<Vec<u8>>,
    group_type: GroupType,
    encryption_mode: EncryptionMode,  // ğŸ†• é€‰æ‹©åŠ å¯†æ¨¡å¼
    group_key_cid: Option<Vec<u8>>,   // ğŸ†• åŠ å¯†ç¾¤çš„ç¾¤å¯†é’¥CID
    max_members: u32,
    is_public_readable: bool,          // ğŸ†• éåŠ å¯†ç¾¤æ˜¯å¦å…¬å¼€å¯è¯»
) -> DispatchResult

/// 2. è§£æ•£ç¾¤ç»„ï¼ˆä»…ç¾¤ä¸»ï¼‰
#[pallet::call_index(1)]
pub fn disband_group(
    origin: OriginFor<T>,
    group_id: T::Hash,
) -> DispatchResult

/// 3. è½¬è®©ç¾¤ä¸»ï¼ˆä»…ç¾¤ä¸»ï¼‰
#[pallet::call_index(2)]
pub fn transfer_ownership(
    origin: OriginFor<T>,
    group_id: T::Hash,
    new_owner: T::AccountId,
) -> DispatchResult

/// 4. æ›´æ–°ç¾¤ä¿¡æ¯ï¼ˆä»…ç¾¤ä¸»/ç®¡ç†å‘˜ï¼‰
#[pallet::call_index(3)]
pub fn update_group_info(
    origin: OriginFor<T>,
    group_id: T::Hash,
    name: Option<Vec<u8>>,
    description: Option<Vec<u8>>,
    avatar_cid: Option<Vec<u8>>,
) -> DispatchResult

/// 5. è®¾ç½®å…¨å‘˜ç¦è¨€ï¼ˆä»…ç¾¤ä¸»/ç®¡ç†å‘˜ï¼‰
#[pallet::call_index(4)]
pub fn set_mute_all(
    origin: OriginFor<T>,
    group_id: T::Hash,
    mute: bool,
) -> DispatchResult
```

#### æˆå‘˜ç®¡ç†

```rust
/// 6. é‚€è¯·æˆå‘˜ï¼ˆç¾¤ä¸»/ç®¡ç†å‘˜/æˆå‘˜ï¼‰
#[pallet::call_index(5)]
pub fn invite_member(
    origin: OriginFor<T>,
    group_id: T::Hash,
    invitee: T::AccountId,
) -> DispatchResult

/// 7. æ¥å—é‚€è¯·
#[pallet::call_index(6)]
pub fn accept_invitation(
    origin: OriginFor<T>,
    group_id: T::Hash,
) -> DispatchResult

/// 8. æ‹’ç»é‚€è¯·
#[pallet::call_index(7)]
pub fn reject_invitation(
    origin: OriginFor<T>,
    group_id: T::Hash,
) -> DispatchResult

/// 9. ä¸»åŠ¨åŠ å…¥ç¾¤ï¼ˆæ— éœ€å®¡æ‰¹ï¼‰
#[pallet::call_index(8)]
pub fn join_group(
    origin: OriginFor<T>,
    group_id: T::Hash,
) -> DispatchResult

/// 10. é€€å‡ºç¾¤ç»„
#[pallet::call_index(9)]
pub fn leave_group(
    origin: OriginFor<T>,
    group_id: T::Hash,
) -> DispatchResult

/// 11. ç§»é™¤æˆå‘˜ï¼ˆä»…ç¾¤ä¸»/ç®¡ç†å‘˜ï¼‰
#[pallet::call_index(10)]
pub fn remove_member(
    origin: OriginFor<T>,
    group_id: T::Hash,
    member: T::AccountId,
) -> DispatchResult

/// 12. è®¾ç½®ç®¡ç†å‘˜ï¼ˆä»…ç¾¤ä¸»ï¼‰
#[pallet::call_index(11)]
pub fn set_admin(
    origin: OriginFor<T>,
    group_id: T::Hash,
    member: T::AccountId,
    is_admin: bool,
) -> DispatchResult

/// 13. ç¦è¨€æˆå‘˜ï¼ˆä»…ç¾¤ä¸»/ç®¡ç†å‘˜ï¼‰
#[pallet::call_index(12)]
pub fn mute_member(
    origin: OriginFor<T>,
    group_id: T::Hash,
    member: T::AccountId,
    duration: Option<BlockNumberFor<T>>,
) -> DispatchResult

/// 14. è§£é™¤ç¦è¨€ï¼ˆä»…ç¾¤ä¸»/ç®¡ç†å‘˜ï¼‰
#[pallet::call_index(13)]
pub fn unmute_member(
    origin: OriginFor<T>,
    group_id: T::Hash,
    member: T::AccountId,
) -> DispatchResult

/// 15. è®¾ç½®ç¾¤æ˜µç§°
#[pallet::call_index(14)]
pub fn set_nickname(
    origin: OriginFor<T>,
    group_id: T::Hash,
    nickname: Vec<u8>,
) -> DispatchResult
```

#### æ¶ˆæ¯ç®¡ç†

```rust
/// 16. å‘é€ç¾¤æ¶ˆæ¯
#[pallet::call_index(15)]
pub fn send_group_message(
    origin: OriginFor<T>,
    group_id: T::Hash,
    content_cid: Vec<u8>,
    msg_type_code: u8,
    reply_to: Option<u64>,
) -> DispatchResult

/// 17. æ’¤å›æ¶ˆæ¯ï¼ˆ2åˆ†é’Ÿå†…ï¼Œä»…è‡ªå·±çš„æ¶ˆæ¯ï¼‰
#[pallet::call_index(16)]
pub fn recall_message(
    origin: OriginFor<T>,
    message_id: u64,
) -> DispatchResult

/// 18. åˆ é™¤æ¶ˆæ¯ï¼ˆä»…ç¾¤ä¸»/ç®¡ç†å‘˜ï¼Œå¯åˆ é™¤ä»»ä½•æ¶ˆæ¯ï¼‰
#[pallet::call_index(17)]
pub fn delete_message(
    origin: OriginFor<T>,
    message_id: u64,
) -> DispatchResult

/// 19. ç½®é¡¶æ¶ˆæ¯ï¼ˆä»…ç¾¤ä¸»/ç®¡ç†å‘˜ï¼‰
#[pallet::call_index(18)]
pub fn pin_message(
    origin: OriginFor<T>,
    message_id: u64,
    pin: bool,
) -> DispatchResult

/// 20. æ ‡è®°å·²è¯»ï¼ˆæ›´æ–°æˆå‘˜çš„å·²è¯»ä½ç½®ï¼‰
#[pallet::call_index(19)]
pub fn mark_as_read(
    origin: OriginFor<T>,
    group_id: T::Hash,
    last_read_message_id: u64,
) -> DispatchResult
```

#### å…¬å‘Šç®¡ç†

```rust
/// 21. å‘å¸ƒå…¬å‘Šï¼ˆä»…ç¾¤ä¸»/ç®¡ç†å‘˜ï¼‰
#[pallet::call_index(20)]
pub fn publish_announcement(
    origin: OriginFor<T>,
    group_id: T::Hash,
    content_cid: Vec<u8>,
) -> DispatchResult

/// 22. åˆ é™¤å…¬å‘Šï¼ˆä»…ç¾¤ä¸»/ç®¡ç†å‘˜ï¼‰
#[pallet::call_index(21)]
pub fn delete_announcement(
    origin: OriginFor<T>,
    group_id: T::Hash,
    announcement_id: u32,
) -> DispatchResult

/// 23. ç½®é¡¶å…¬å‘Šï¼ˆä»…ç¾¤ä¸»/ç®¡ç†å‘˜ï¼‰
#[pallet::call_index(22)]
pub fn pin_announcement(
    origin: OriginFor<T>,
    group_id: T::Hash,
    announcement_id: u32,
    pin: bool,
) -> DispatchResult
```

### äº‹ä»¶ï¼ˆEventsï¼‰

```rust
pub enum Event<T: Config> {
    /// ç¾¤ç»„å·²åˆ›å»º [group_id, owner]
    GroupCreated { group_id: T::Hash, owner: T::AccountId },

    /// ç¾¤ç»„å·²è§£æ•£ [group_id, operator]
    GroupDisbanded { group_id: T::Hash, operator: T::AccountId },

    /// ç¾¤ä¸»å·²è½¬è®© [group_id, old_owner, new_owner]
    OwnershipTransferred { group_id: T::Hash, old_owner: T::AccountId, new_owner: T::AccountId },

    /// ç¾¤ä¿¡æ¯å·²æ›´æ–° [group_id, operator]
    GroupInfoUpdated { group_id: T::Hash, operator: T::AccountId },

    /// æˆå‘˜å·²åŠ å…¥ [group_id, member]
    MemberJoined { group_id: T::Hash, member: T::AccountId },

    /// æˆå‘˜å·²ç¦»å¼€ [group_id, member]
    MemberLeft { group_id: T::Hash, member: T::AccountId },

    /// æˆå‘˜å·²è¢«ç§»é™¤ [group_id, member, operator]
    MemberRemoved { group_id: T::Hash, member: T::AccountId, operator: T::AccountId },

    /// æˆå‘˜å·²è¢«é‚€è¯· [group_id, inviter, invitee]
    MemberInvited { group_id: T::Hash, inviter: T::AccountId, invitee: T::AccountId },

    /// ç®¡ç†å‘˜å·²è®¾ç½® [group_id, member, is_admin]
    AdminSet { group_id: T::Hash, member: T::AccountId, is_admin: bool },

    /// æˆå‘˜å·²è¢«ç¦è¨€ [group_id, member, operator, until]
    MemberMuted { group_id: T::Hash, member: T::AccountId, operator: T::AccountId, until: Option<BlockNumberFor<T>> },

    /// æˆå‘˜å·²è§£é™¤ç¦è¨€ [group_id, member, operator]
    MemberUnmuted { group_id: T::Hash, member: T::AccountId, operator: T::AccountId },

    /// ç¾¤æ¶ˆæ¯å·²å‘é€ [message_id, group_id, sender]
    GroupMessageSent { message_id: u64, group_id: T::Hash, sender: T::AccountId },

    /// æ¶ˆæ¯å·²æ’¤å› [message_id, operator]
    MessageRecalled { message_id: u64, operator: T::AccountId },

    /// æ¶ˆæ¯å·²åˆ é™¤ [message_id, operator]
    MessageDeleted { message_id: u64, operator: T::AccountId },

    /// æ¶ˆæ¯å·²ç½®é¡¶ [message_id, operator, pinned]
    MessagePinned { message_id: u64, operator: T::AccountId, pinned: bool },

    /// å…¬å‘Šå·²å‘å¸ƒ [group_id, announcement_id, publisher]
    AnnouncementPublished { group_id: T::Hash, announcement_id: u32, publisher: T::AccountId },

    /// å…¬å‘Šå·²åˆ é™¤ [group_id, announcement_id, operator]
    AnnouncementDeleted { group_id: T::Hash, announcement_id: u32, operator: T::AccountId },

    /// å…¨å‘˜ç¦è¨€çŠ¶æ€å·²æ”¹å˜ [group_id, mute_all]
    MuteAllChanged { group_id: T::Hash, mute_all: bool },
}
```

### é”™è¯¯ï¼ˆErrorsï¼‰

```rust
pub enum Error<T> {
    /// ç¾¤ç»„ä¸å­˜åœ¨
    GroupNotFound,
    /// ç¾¤ç»„å·²å­˜åœ¨
    GroupAlreadyExists,
    /// ä¸æ˜¯ç¾¤æˆå‘˜
    NotGroupMember,
    /// ä¸æ˜¯ç¾¤ä¸»
    NotGroupOwner,
    /// æƒé™ä¸è¶³ï¼ˆä¸æ˜¯ç¾¤ä¸»æˆ–ç®¡ç†å‘˜ï¼‰
    InsufficientPermission,
    /// ç¾¤ç»„å·²æ»¡
    GroupFull,
    /// ç¾¤åç§°å¤ªé•¿
    GroupNameTooLong,
    /// ç¾¤ä»‹ç»å¤ªé•¿
    GroupDescriptionTooLong,
    /// æ˜µç§°å¤ªé•¿
    NicknameTooLong,
    /// CIDå¤ªé•¿
    CidTooLong,
    /// CIDæœªåŠ å¯†
    CidNotEncrypted,
    /// æ¶ˆæ¯ä¸å­˜åœ¨
    MessageNotFound,
    /// ä¸æ˜¯æ¶ˆæ¯å‘é€è€…
    NotMessageSender,
    /// æ’¤å›æ—¶é—´å·²è¿‡ï¼ˆè¶…è¿‡2åˆ†é’Ÿï¼‰
    RecallTimeExpired,
    /// æˆå‘˜å·²è¢«ç¦è¨€
    MemberMuted,
    /// å…¨å‘˜ç¦è¨€ä¸­
    AllMuted,
    /// å…¬å‘Šä¸å­˜åœ¨
    AnnouncementNotFound,
    /// é‚€è¯·ä¸å­˜åœ¨
    InvitationNotFound,
    /// å·²ç»æ˜¯æˆå‘˜
    AlreadyMember,
    /// ä¸èƒ½å¯¹ç¾¤ä¸»æ‰§è¡Œæ­¤æ“ä½œ
    CannotOperateOnOwner,
    /// ç®¡ç†å‘˜ä¸èƒ½ç§»é™¤å…¶ä»–ç®¡ç†å‘˜
    CannotRemoveAdmin,
    /// é¢‘ç‡é™åˆ¶è¶…å‡º
    RateLimitExceeded,
    /// æ— æ•ˆçš„æ¶ˆæ¯ç±»å‹
    InvalidMessageType,
    /// å›å¤çš„æ¶ˆæ¯ä¸å­˜åœ¨
    ReplyMessageNotFound,
}
```

### é…ç½®ï¼ˆConfigï¼‰

```rust
#[pallet::config]
pub trait Config: frame_system::Config {
    type RuntimeEvent: From<Event<Self>> + IsType<<Self as frame_system::Config>::RuntimeEvent>;
    type WeightInfo: WeightInfo;

    /// IPFS CIDæœ€å¤§é•¿åº¦
    #[pallet::constant]
    type MaxCidLen: Get<u32>;

    /// ç¾¤åç§°æœ€å¤§é•¿åº¦ï¼ˆå»ºè®®ï¼š50å­—ç¬¦ï¼‰
    #[pallet::constant]
    type MaxGroupNameLen: Get<u32>;

    /// ç¾¤ä»‹ç»æœ€å¤§é•¿åº¦ï¼ˆå»ºè®®ï¼š500å­—ç¬¦ï¼‰
    #[pallet::constant]
    type MaxGroupDescLen: Get<u32>;

    /// ç¾¤æ˜µç§°æœ€å¤§é•¿åº¦ï¼ˆå»ºè®®ï¼š30å­—ç¬¦ï¼‰
    #[pallet::constant]
    type MaxNicknameLen: Get<u32>;

    /// æ¯ä¸ªç¾¤æœ€å¤§æˆå‘˜æ•°ï¼ˆå»ºè®®ï¼š500ï¼‰
    #[pallet::constant]
    type DefaultMaxMembers: Get<u32>;

    /// æ¶ˆæ¯æ’¤å›æ—¶é—´é™åˆ¶ï¼ˆåŒºå—æ•°ï¼Œå»ºè®®ï¼š20åŒºå— â‰ˆ 2åˆ†é’Ÿï¼‰
    #[pallet::constant]
    type MessageRecallWindow: Get<BlockNumberFor<Self>>;

    /// é¢‘ç‡é™åˆ¶ï¼šæ—¶é—´çª—å£ï¼ˆåŒºå—æ•°ï¼‰
    #[pallet::constant]
    type RateLimitWindow: Get<BlockNumberFor<Self>>;

    /// é¢‘ç‡é™åˆ¶ï¼šæ—¶é—´çª—å£å†…æœ€å¤§æ¶ˆæ¯æ•°
    #[pallet::constant]
    type MaxMessagesPerWindow: Get<u32>;

    /// ç¾¤ç»„è¿‡æœŸæ—¶é—´ï¼ˆé•¿æœŸæ— æ´»åŠ¨çš„ç¾¤å¯è¢«æ¸…ç†ï¼‰
    #[pallet::constant]
    type GroupExpirationTime: Get<BlockNumberFor<Self>>;
}
```

### æŸ¥è¯¢å‡½æ•°ï¼ˆRPCå¯ç”¨ï¼‰

```rust
impl<T: Config> Pallet<T> {
    /// æŸ¥è¯¢ç¾¤ç»„ä¿¡æ¯
    pub fn get_group(group_id: T::Hash) -> Option<GroupInfo<T>>

    /// æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰ç¾¤ç»„
    pub fn list_user_groups(user: T::AccountId) -> Vec<T::Hash>

    /// åˆ†é¡µæŸ¥è¯¢ç¾¤æˆå‘˜åˆ—è¡¨
    pub fn list_group_members(group_id: T::Hash, offset: u32, limit: u32) -> Vec<GroupMember<T>>

    /// æŸ¥è¯¢æˆå‘˜ä¿¡æ¯
    pub fn get_member(group_id: T::Hash, account: T::AccountId) -> Option<GroupMember<T>>

    /// åˆ†é¡µæŸ¥è¯¢ç¾¤æ¶ˆæ¯
    pub fn list_group_messages(group_id: T::Hash, offset: u32, limit: u32) -> Vec<u64>

    /// æŸ¥è¯¢å•æ¡ç¾¤æ¶ˆæ¯
    pub fn get_group_message(message_id: u64) -> Option<GroupMessageMeta<T>>

    /// æŸ¥è¯¢ç¾¤å…¬å‘Šåˆ—è¡¨
    pub fn list_announcements(group_id: T::Hash) -> Vec<GroupAnnouncement<T>>

    /// æŸ¥è¯¢æˆå‘˜æœªè¯»æ¶ˆæ¯æ•°
    pub fn get_unread_count(group_id: T::Hash, member: T::AccountId) -> u32

    /// æ£€æŸ¥æˆå‘˜æƒé™
    pub fn check_permission(group_id: T::Hash, member: T::AccountId, required_role: MemberRole) -> bool
}
```

---

## ğŸ” åŠ å¯†ä¸å®‰å…¨è®¾è®¡

### 1. ç«¯åˆ°ç«¯åŠ å¯†æ–¹æ¡ˆ

#### ä¸€å¯¹ä¸€ç§èŠåŠ å¯†
```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å‰ç«¯åŠ å¯†æµç¨‹ï¼ˆç”¨æˆ·Aå‘é€ç»™ç”¨æˆ·Bï¼‰            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ç”¨æˆ·Aè¾“å…¥æ˜æ–‡æ¶ˆæ¯: "Hello Bob"

2. ç”Ÿæˆå¯¹ç§°å¯†é’¥ (AES-256-GCM):
   sessionKey = generateRandomKey(256bit)

3. ä½¿ç”¨å¯¹ç§°å¯†é’¥åŠ å¯†æ¶ˆæ¯:
   encryptedMessage = AES-GCM.encrypt(sessionKey, "Hello Bob")

4. ä½¿ç”¨æ¥æ”¶æ–¹å…¬é’¥åŠ å¯†ä¼šè¯å¯†é’¥:
   encryptedSessionKey_B = RSA-OAEP.encrypt(publicKey_B, sessionKey)

5. æ‹¼æ¥åŠ å¯†æ•°æ®:
   payload = {
       encryptedMessage,
       encryptedSessionKey_B,
       iv,  // åˆå§‹åŒ–å‘é‡
       authTag  // è®¤è¯æ ‡ç­¾
   }

6. ä¸Šä¼ åˆ°IPFS:
   cid = ipfs.add(payload)

7. è°ƒç”¨é“¾ä¸Šå‡½æ•°:
   send_message(receiver=B, content_cid=cid, ...)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 å‰ç«¯è§£å¯†æµç¨‹ï¼ˆç”¨æˆ·Bæ¥æ”¶ï¼‰                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. ç”¨æˆ·Bç›‘å¬äº‹ä»¶ï¼Œè·å–CID

2. ä»IPFSä¸‹è½½åŠ å¯†æ•°æ®:
   payload = ipfs.cat(cid)

3. ä½¿ç”¨è‡ªå·±çš„ç§é’¥è§£å¯†ä¼šè¯å¯†é’¥:
   sessionKey = RSA-OAEP.decrypt(privateKey_B, encryptedSessionKey_B)

4. ä½¿ç”¨ä¼šè¯å¯†é’¥è§£å¯†æ¶ˆæ¯:
   message = AES-GCM.decrypt(sessionKey, encryptedMessage)

5. æ˜¾ç¤ºæ˜æ–‡æ¶ˆæ¯: "Hello Bob"
```

#### ç¾¤èŠåŠ å¯†æ–¹æ¡ˆ

**æ–¹æ¡ˆAï¼šå¯¹ç§°ç¾¤å¯†é’¥ï¼ˆæ¨èï¼‰**
```text
1. åˆ›å»ºç¾¤æ—¶ç”Ÿæˆç¾¤å¯†é’¥ (Group Symmetric Key):
   groupKey = generateRandomKey(256bit)

2. ä½¿ç”¨æ¯ä¸ªæˆå‘˜çš„å…¬é’¥åŠ å¯†ç¾¤å¯†é’¥:
   encryptedGroupKey_Member1 = RSA-OAEP.encrypt(publicKey_Member1, groupKey)
   encryptedGroupKey_Member2 = RSA-OAEP.encrypt(publicKey_Member2, groupKey)
   ...

3. å°†åŠ å¯†çš„ç¾¤å¯†é’¥å­˜å‚¨åœ¨IPFSï¼ˆæˆ–é“¾ä¸‹æ•°æ®åº“ï¼‰:
   groupKeysCid = ipfs.add({
       member1: encryptedGroupKey_Member1,
       member2: encryptedGroupKey_Member2,
       ...
   })

4. ç¾¤ä¸»å‘é€æ¶ˆæ¯æ—¶:
   encryptedMessage = AES-GCM.encrypt(groupKey, "Hello Group")
   cid = ipfs.add(encryptedMessage)
   send_group_message(group_id, cid, ...)

5. æˆå‘˜æ¥æ”¶æ¶ˆæ¯æ—¶:
   - å…ˆè§£å¯†è‡ªå·±çš„ç¾¤å¯†é’¥: groupKey = RSA-OAEP.decrypt(privateKey, encryptedGroupKey)
   - å†è§£å¯†æ¶ˆæ¯: message = AES-GCM.decrypt(groupKey, encryptedMessage)

6. æˆå‘˜å˜æ›´æ—¶:
   - æ·»åŠ æˆå‘˜ï¼šç”Ÿæˆæ–°æˆå‘˜çš„åŠ å¯†ç¾¤å¯†é’¥
   - ç§»é™¤æˆå‘˜ï¼šè½®æ¢ç¾¤å¯†é’¥ï¼ˆå¯é€‰ï¼Œå–å†³äºå®‰å…¨éœ€æ±‚ï¼‰
```

**æ–¹æ¡ˆBï¼šSignal Protocolï¼ˆé«˜çº§å®‰å…¨ï¼‰**
- ä½¿ç”¨ Double Ratchet Algorithm
- æ¯æ¡æ¶ˆæ¯ä½¿ç”¨ä¸åŒçš„å¯†é’¥
- æä¾›å‰å‘å®‰å…¨æ€§å’Œåå‘å®‰å…¨æ€§
- å®ç°å¤æ‚åº¦é«˜ï¼Œé€‚åˆå®‰å…¨è¦æ±‚æé«˜çš„åœºæ™¯

#### éåŠ å¯†ç¾¤æ–¹æ¡ˆ

**å…¬å¼€ç¾¤èŠè®¾è®¡ï¼ˆUnencrypted Modeï¼‰**
```text
1. åˆ›å»ºå…¬å¼€ç¾¤æ—¶ä¸ç”Ÿæˆç¾¤å¯†é’¥:
   - encryption_mode = EncryptionMode::Unencrypted
   - group_key_cid = None
   - is_public_readable = true  // å…è®¸ä»»ä½•äººè¯»å–

2. å‘é€æ¶ˆæ¯æ—¶:
   message = "å…¬å¼€çš„ç¾¤æ¶ˆæ¯å†…å®¹"  // æ˜æ–‡
   cid = ipfs.add(message)       // ç›´æ¥ä¸Šä¼ æ˜æ–‡åˆ°IPFS
   send_group_message(group_id, cid, ...)

3. ä»»ä½•äººå¯ä»¥è¯»å–æ¶ˆæ¯:
   - æˆå‘˜ï¼šé€šè¿‡é“¾ä¸ŠæŸ¥è¯¢ + IPFSè·å–å†…å®¹
   - éæˆå‘˜ï¼šå¦‚æœ is_public_readable=trueï¼Œä¹Ÿå¯ä»¥é€šè¿‡IPFSç›´æ¥è®¿é—®

4. é€‚ç”¨åœºæ™¯:
   - å…¬å‘Šé¢‘é“ï¼ˆå®˜æ–¹é€šçŸ¥ï¼‰
   - å…¬å¼€è®¨è®ºç»„ï¼ˆæŠ€æœ¯äº¤æµã€ç¤¾åŒºè®¨è®ºï¼‰
   - ç›´æ’­èŠå¤©å®¤
   - é€æ˜åº¦è¦æ±‚é«˜çš„åœºæ™¯ï¼ˆDAOæŠ•ç¥¨è®¨è®ºï¼‰
```

### 2. åŠ å¯†ç¾¤ vs éåŠ å¯†ç¾¤å¯¹æ¯”

| ç‰¹æ€§ | åŠ å¯†ç¾¤ (Encrypted) | éåŠ å¯†ç¾¤ (Unencrypted) |
|------|-------------------|----------------------|
| **æ¶ˆæ¯åŠ å¯†** | âœ… ç«¯åˆ°ç«¯åŠ å¯† | âŒ æ˜æ–‡å­˜å‚¨ |
| **å¯†é’¥ç®¡ç†** | éœ€è¦ç¾¤å¯†é’¥ + æˆå‘˜å…¬é’¥åŠ å¯† | æ— éœ€å¯†é’¥ |
| **éšç§æ€§** | ğŸ”’ åªæœ‰æˆå‘˜å¯è¯» | ğŸŒ å…¬å¼€å¯è¯»ï¼ˆå¯é…ç½®ï¼‰ |
| **æ€§èƒ½** | ç¨æ…¢ï¼ˆåŠ å¯†/è§£å¯†å¼€é”€ï¼‰ | å¿«é€Ÿï¼ˆæ— åŠ å¯†å¼€é”€ï¼‰ |
| **å­˜å‚¨** | IPFSå­˜å‚¨åŠ å¯†æ•°æ® | IPFSå­˜å‚¨æ˜æ–‡æ•°æ® |
| **é€‚ç”¨åœºæ™¯** | ç§å¯†è®¨è®ºã€å•†ä¸šæœºå¯† | å…¬å‘Šã€å…¬å¼€è®¨è®º |
| **æˆå‘˜å˜æ›´** | éœ€æ›´æ–°ç¾¤å¯†é’¥ï¼ˆå¯é€‰ï¼‰ | æ— éœ€ç‰¹æ®Šå¤„ç† |
| **éæˆå‘˜è®¿é—®** | âŒ æ— æ³•è®¿é—® | âœ… å¯é…ç½®å…è®¸è®¿é—® |
| **æ¶ˆæ¯å®¡è®¡** | âŒ åŠ å¯†ä¸å¯å®¡è®¡ | âœ… å¯å…¬å¼€å®¡è®¡ |
| **CIDéªŒè¯** | å¿…é¡»åŠ å¯† | å¯ä»¥æ˜æ–‡ |

### 3. ç¾¤å¯†é’¥ç®¡ç†è¯¦è§£ï¼ˆä»…åŠ å¯†ç¾¤ï¼‰

#### ç¾¤å¯†é’¥ç”Ÿæˆä¸åˆ†å‘

```typescript
// å‰ç«¯ï¼šåˆ›å»ºåŠ å¯†ç¾¤
async function createEncryptedGroup(
  groupName: string,
  description: string,
  initialMembers: string[]  // æˆå‘˜å…¬é’¥åˆ—è¡¨
) {
  // 1. ç”Ÿæˆç¾¤å¯¹ç§°å¯†é’¥
  const groupKey = crypto.randomBytes(32);  // AES-256
  
  // 2. ä¸ºæ¯ä¸ªåˆå§‹æˆå‘˜åŠ å¯†ç¾¤å¯†é’¥
  const encryptedKeys: Record<string, string> = {};
  for (const memberPublicKey of initialMembers) {
    const encryptedGroupKey = await encryptWithPublicKey(
      groupKey,
      memberPublicKey
    );
    encryptedKeys[memberPublicKey] = encryptedGroupKey;
  }
  
  // 3. ä¸Šä¼ åŠ å¯†å¯†é’¥æ˜ å°„åˆ°IPFS
  const groupKeysData = JSON.stringify(encryptedKeys);
  const groupKeysCid = await ipfs.add(groupKeysData);
  
  // 4. è°ƒç”¨é“¾ä¸Šå‡½æ•°åˆ›å»ºç¾¤
  await api.tx.groupChat.createGroup(
    groupName,
    description,
    null,  // avatar_cid
    GroupType.Normal,
    EncryptionMode.Encrypted,  // ğŸ” åŠ å¯†æ¨¡å¼
    groupKeysCid,              // ç¾¤å¯†é’¥CID
    500,                       // max_members
    false                      // is_public_readable (åŠ å¯†ç¾¤å›ºå®šä¸ºfalse)
  ).signAndSend(account);
}
```

#### æ·»åŠ æ–°æˆå‘˜æ—¶æ›´æ–°ç¾¤å¯†é’¥

```typescript
// å‰ç«¯ï¼šé‚€è¯·æ–°æˆå‘˜åŠ å…¥åŠ å¯†ç¾¤
async function inviteMemberToEncryptedGroup(
  groupId: string,
  newMemberPublicKey: string
) {
  // 1. è·å–å½“å‰ç¾¤å¯†é’¥CID
  const groupInfo = await api.query.groupChat.groups(groupId);
  const currentGroupKeysCid = groupInfo.groupKeyCid;
  
  // 2. ä»IPFSä¸‹è½½å½“å‰å¯†é’¥æ˜ å°„
  const keysData = await ipfs.cat(currentGroupKeysCid);
  const encryptedKeys = JSON.parse(keysData);
  
  // 3. è§£å¯†ç¾¤å¯†é’¥ï¼ˆä½¿ç”¨è‡ªå·±çš„ç§é’¥ï¼‰
  const myPublicKey = getMyPublicKey();
  const encryptedGroupKey = encryptedKeys[myPublicKey];
  const groupKey = await decryptWithPrivateKey(
    encryptedGroupKey,
    myPrivateKey
  );
  
  // 4. ç”¨æ–°æˆå‘˜å…¬é’¥åŠ å¯†ç¾¤å¯†é’¥
  const newMemberEncryptedKey = await encryptWithPublicKey(
    groupKey,
    newMemberPublicKey
  );
  
  // 5. æ›´æ–°å¯†é’¥æ˜ å°„
  encryptedKeys[newMemberPublicKey] = newMemberEncryptedKey;
  
  // 6. ä¸Šä¼ æ–°çš„å¯†é’¥æ˜ å°„åˆ°IPFS
  const newGroupKeysData = JSON.stringify(encryptedKeys);
  const newGroupKeysCid = await ipfs.add(newGroupKeysData);
  
  // 7. è°ƒç”¨é“¾ä¸Šå‡½æ•°é‚€è¯·æˆå‘˜å¹¶æ›´æ–°å¯†é’¥CID
  await api.tx.groupChat.inviteMemberAndUpdateKeys(
    groupId,
    newMemberPublicKey,
    newGroupKeysCid
  ).signAndSend(account);
}
```

#### ç§»é™¤æˆå‘˜æ—¶çš„å®‰å…¨è€ƒè™‘

```typescript
// æ–¹æ¡ˆAï¼šä¸è½®æ¢ç¾¤å¯†é’¥ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰
// - è¢«ç§»é™¤çš„æˆå‘˜ä»å¯è§£å¯†ä¹‹å‰çš„å†å²æ¶ˆæ¯
// - æ— æ³•è§£å¯†ä¹‹åçš„æ¶ˆæ¯ï¼ˆå› ä¸ºè¢«ç§»é™¤åæ— æ³•è·å–æ–°æ¶ˆæ¯çš„CIDï¼‰
// - é€‚ç”¨äºå¯¹å†å²æ¶ˆæ¯å®‰å…¨æ€§è¦æ±‚ä¸é«˜çš„åœºæ™¯

// æ–¹æ¡ˆBï¼šè½®æ¢ç¾¤å¯†é’¥ï¼ˆå®‰å…¨ä¼˜å…ˆï¼‰
async function removeMemberAndRotateKey(
  groupId: string,
  removedMemberPublicKey: string
) {
  // 1. ç”Ÿæˆæ–°çš„ç¾¤å¯†é’¥
  const newGroupKey = crypto.randomBytes(32);
  
  // 2. è·å–å½“å‰æ‰€æœ‰æˆå‘˜ï¼ˆæ’é™¤è¢«ç§»é™¤çš„æˆå‘˜ï¼‰
  const members = await api.query.groupChat.groupMembers.entries(groupId);
  const remainingMembers = members.filter(
    ([_, member]) => member.account !== removedMemberPublicKey
  );
  
  // 3. ä¸ºå‰©ä½™æˆå‘˜åŠ å¯†æ–°ç¾¤å¯†é’¥
  const newEncryptedKeys: Record<string, string> = {};
  for (const member of remainingMembers) {
    const encryptedKey = await encryptWithPublicKey(
      newGroupKey,
      member.publicKey
    );
    newEncryptedKeys[member.publicKey] = encryptedKey;
  }
  
  // 4. ä¸Šä¼ æ–°å¯†é’¥æ˜ å°„
  const newGroupKeysCid = await ipfs.add(JSON.stringify(newEncryptedKeys));
  
  // 5. è°ƒç”¨é“¾ä¸Šå‡½æ•°ç§»é™¤æˆå‘˜å¹¶æ›´æ–°å¯†é’¥
  await api.tx.groupChat.removeMemberAndRotateKeys(
    groupId,
    removedMemberPublicKey,
    newGroupKeysCid
  ).signAndSend(account);
}
```

### 4. CID åŠ å¯†éªŒè¯ï¼ˆé’ˆå¯¹ä¸åŒç¾¤ç±»å‹ï¼‰

é“¾ä¸ŠéªŒè¯ CID æ˜¯å¦åŠ å¯†ï¼Œæ ¹æ®ç¾¤ç±»å‹è¿›è¡Œä¸åŒéªŒè¯ï¼š

```rust
/// æ£€æŸ¥CIDæ˜¯å¦åŠ å¯†ï¼ˆé’ˆå¯¹ç¾¤ç±»å‹ï¼‰
pub fn validate_message_cid(
    cid: &[u8],
    encryption_mode: EncryptionMode
) -> Result<(), Error<T>> {
    match encryption_mode {
        EncryptionMode::Encrypted => {
            // åŠ å¯†ç¾¤ï¼šCIDå¿…é¡»æ˜¯åŠ å¯†çš„
            if is_standard_ipfs_cid(cid) {
                return Err(Error::<T>::CidNotEncrypted);
            }
            Ok(())
        },
        EncryptionMode::Unencrypted => {
            // éåŠ å¯†ç¾¤ï¼šå…è®¸æ ‡å‡†IPFS CID
            // ä¸å¼ºåˆ¶è¦æ±‚åŠ å¯†ï¼Œä½†ä»ç„¶æ¥å—åŠ å¯†çš„CID
            Ok(())
        }
    }
}

/// æ£€æŸ¥æ˜¯å¦æ˜¯æ ‡å‡†IPFS CIDï¼ˆæœªåŠ å¯†ï¼‰
fn is_standard_ipfs_cid(cid: &[u8]) -> bool {
    // CIDv0: 46å­—èŠ‚ï¼Œä»¥"Qm"å¼€å¤´
    if cid.len() == 46 && cid.starts_with(b"Qm") {
        return true;
    }
    // CIDv1: å¯èƒ½ä»¥"bafy"ç­‰å¼€å¤´ï¼Œä½†è¿™é‡Œç®€åŒ–å¤„ç†
    false
}
```

**éªŒè¯è§„åˆ™**ï¼š
- **ç§èŠå’ŒåŠ å¯†ç¾¤**ï¼š`content_cid` å¿…é¡»åŠ å¯†ï¼Œå¦åˆ™äº¤æ˜“å¤±è´¥
- **éåŠ å¯†ç¾¤**ï¼šå…è®¸æ˜æ–‡CIDï¼Œä¹Ÿå…è®¸åŠ å¯†CIDï¼ˆå…¼å®¹æ€§ï¼‰

### 5. å¯†é’¥ç®¡ç†ç­–ç•¥

| å¯†é’¥ç±»å‹ | å­˜å‚¨ä½ç½® | ç”Ÿæˆæ–¹å¼ | å¤‡ä»½ç­–ç•¥ |
|---------|---------|---------|---------|
| **ç”¨æˆ·ç§é’¥** | å‰ç«¯æœ¬åœ°å­˜å‚¨ï¼ˆåŠ å¯†ï¼‰ | åˆ›å»ºè´¦æˆ·æ—¶ç”Ÿæˆ | åŠ©è®°è¯å¤‡ä»½ |
| **ç”¨æˆ·å…¬é’¥** | é“¾ä¸Šï¼ˆæˆ–é“¾ä¸‹ç´¢å¼•ï¼‰ | ä»ç§é’¥æ´¾ç”Ÿ | æ— éœ€å¤‡ä»½ |
| **ä¼šè¯å¯†é’¥** | å†…å­˜ï¼ˆä¸´æ—¶ï¼‰ | æ¯æ¬¡ä¼šè¯éšæœºç”Ÿæˆ | ä¸å¤‡ä»½ |
| **ç¾¤å¯†é’¥** | IPFSï¼ˆåŠ å¯†å­˜å‚¨ï¼‰ | åˆ›å»ºç¾¤æ—¶ç”Ÿæˆ | åŠ å¯†åä¸Šä¼ IPFS |

### 4. å®‰å…¨æªæ–½

#### é˜²åƒåœ¾æ¶ˆæ¯
- **é¢‘ç‡é™åˆ¶**ï¼šæ¯ä¸ªç”¨æˆ·åœ¨æ—¶é—´çª—å£å†…æœ€å¤šå‘é€Næ¡æ¶ˆæ¯
- **é»‘åå•æœºåˆ¶**ï¼šç”¨æˆ·å¯æ‹‰é»‘å…¶ä»–ç”¨æˆ·
- **æƒé™æ§åˆ¶**ï¼šç¾¤ä¸»/ç®¡ç†å‘˜å¯ç¦è¨€æˆå‘˜

#### é˜²æ¶æ„å†…å®¹
- **å†…å®¹åŠ å¯†**ï¼šæ‰€æœ‰æ¶ˆæ¯ç«¯åˆ°ç«¯åŠ å¯†ï¼Œé“¾ä¸Šä¸å¯è§æ˜æ–‡
- **ä¸¾æŠ¥æœºåˆ¶**ï¼šé›†æˆ `pallet-evidence` å’Œ `pallet-arbitration` å¤„ç†äº‰è®®
- **æ¶ˆæ¯æ’¤å›**ï¼šå‘é€è€…å¯åœ¨2åˆ†é’Ÿå†…æ’¤å›æ¶ˆæ¯

#### éšç§ä¿æŠ¤
- **è½¯åˆ é™¤**ï¼šç”¨æˆ·åˆ é™¤æ¶ˆæ¯åªå¯¹è‡ªå·±éšè—
- **ä¼šè¯å½’æ¡£**ï¼šç”¨æˆ·å¯å½’æ¡£ä¼šè¯ï¼Œä¸å½±å“å¯¹æ–¹
- **CIDåŠ å¯†**ï¼šå¼ºåˆ¶åŠ å¯†ï¼Œé˜²æ­¢IPFSç½‘å…³ç›´æ¥è®¿é—®å†…å®¹

---

## ğŸ“Š æ€§èƒ½ä¸æ‰©å±•æ€§

### 1. å­˜å‚¨ä¼˜åŒ–

| ä¼˜åŒ–ç­–ç•¥ | å®ç°æ–¹å¼ | æ•ˆæœ |
|---------|---------|------|
| **é“¾ä¸Šå­˜å‚¨å…ƒæ•°æ®** | åªå­˜å‚¨å‘é€è€…ã€æ¥æ”¶è€…ã€CIDã€æ—¶é—´æˆ³ç­‰ | èŠ‚çœ80%+é“¾ä¸Šç©ºé—´ |
| **IPFSå­˜å‚¨å†…å®¹** | åŠ å¯†çš„æ¶ˆæ¯æ­£æ–‡å­˜å‚¨åœ¨IPFS | æ”¯æŒå¤§æ–‡ä»¶ã€å›¾ç‰‡ã€è§†é¢‘ |
| **DoubleMapç´¢å¼•** | ä½¿ç”¨ `SessionMessages`ã€`GroupMessageList` | é«˜æ•ˆåˆ†é¡µæŸ¥è¯¢ |
| **æ¶ˆæ¯è¿‡æœŸæ¸…ç†** | å®šæœŸæ¸…ç†è¢«åŒæ–¹åˆ é™¤ä¸”è¿‡æœŸçš„æ¶ˆæ¯ | é¿å…æ— é™å¢é•¿ |

### 2. æŸ¥è¯¢ä¼˜åŒ–

#### å‰ç«¯ç¼“å­˜ç­–ç•¥
```typescript
// æ¶ˆæ¯åˆ—è¡¨ç¼“å­˜ï¼ˆReact Queryï¼‰
const { data: messages } = useQuery({
  queryKey: ['group-messages', groupId, page],
  queryFn: () => fetchGroupMessages(groupId, page * 50, 50),
  staleTime: 30_000, // 30ç§’å†…ä¸é‡æ–°è¯·æ±‚
  cacheTime: 300_000, // 5åˆ†é’Ÿç¼“å­˜
});

// IPFSå†…å®¹ç¼“å­˜ï¼ˆIndexedDBï¼‰
const getCachedMessage = async (cid: string) => {
  const cached = await idbKeyval.get(`msg:${cid}`);
  if (cached) return cached;

  const content = await ipfs.cat(cid);
  await idbKeyval.set(`msg:${cid}`, content);
  return content;
};
```

#### Subsquid ETL é›†æˆ
```graphql
# é€šè¿‡SubsquidæŸ¥è¯¢æ¶ˆæ¯å†å²ï¼ˆæ€§èƒ½æ›´ä¼˜ï¼‰
query GetGroupMessages($groupId: String!, $limit: Int!, $offset: Int!) {
  groupMessages(
    where: { groupId: $groupId }
    orderBy: sentAt_DESC
    limit: $limit
    offset: $offset
  ) {
    id
    sender
    contentCid
    msgType
    sentAt
    isRecalled
  }
}
```

### 3. æƒé‡é…ç½®

| å‡½æ•° | å¤æ‚åº¦ | ä¼°ç®—æƒé‡ | å¤‡æ³¨ |
|------|--------|---------|------|
| `create_group` | O(1) | 300M | 3è¯» + 3å†™ |
| `send_group_message` | O(1) | 500M | 5è¯» + 4å†™ |
| `invite_member` | O(1) | 250M | 2è¯» + 2å†™ |
| `list_group_members` | O(n) | 50M Ã— n | RPCè°ƒç”¨ï¼Œä¸æ¶ˆè€—é“¾ä¸Šgas |
| `list_group_messages` | O(n) | 50M Ã— n | RPCè°ƒç”¨ï¼Œå»ºè®®é€šè¿‡Subsquid |

### 4. æ‰©å±•æ€§è€ƒè™‘

#### åˆ†ç‰‡ç­–ç•¥ï¼ˆæœªæ¥ï¼‰
```rust
// æŒ‰ç¾¤ç»„åˆ†ç‰‡å­˜å‚¨ï¼ˆå¦‚æœç¾¤æ•°é‡è¶…è¿‡ç™¾ä¸‡çº§ï¼‰
pub type GroupShard<T> = StorageMap<
    _,
    Blake2_128Concat,
    u32,  // shard_id = group_id.hash() % SHARD_COUNT
    Vec<T::Hash>,  // group_ids in this shard
>;
```

#### é“¾ä¸‹å·¥ä½œæœºï¼ˆOCWï¼‰æ¸…ç†
```rust
// å®šæœŸæ¸…ç†è¿‡æœŸç¾¤ç»„å’Œæ¶ˆæ¯
fn offchain_worker(block_number: BlockNumberFor<T>) {
    if block_number % 1000 == 0 {  // æ¯1000ä¸ªåŒºå—æ‰§è¡Œä¸€æ¬¡
        Self::cleanup_expired_groups();
        Self::cleanup_old_messages();
    }
}
```

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•ï¼ˆpallets/*/src/tests.rsï¼‰

```rust
#[test]
fn test_create_group() {
    new_test_ext().execute_with(|| {
        let alice = 1;
        let name = b"Test Group".to_vec();
        let desc = b"Description".to_vec();

        assert_ok!(GroupChat::create_group(
            RuntimeOrigin::signed(alice),
            name.clone(),
            desc.clone(),
            None,
            GroupType::Normal,
            100,
        ));

        // éªŒè¯ç¾¤ç»„åˆ›å»ºæˆåŠŸ
        let groups = GroupChat::list_user_groups(alice);
        assert_eq!(groups.len(), 1);
    });
}

#[test]
fn test_send_message_with_mute() {
    new_test_ext().execute_with(|| {
        let alice = 1;
        let bob = 2;
        let group_id = create_test_group(alice);

        // é‚€è¯·BobåŠ å…¥
        assert_ok!(GroupChat::invite_member(RuntimeOrigin::signed(alice), group_id, bob));
        assert_ok!(GroupChat::accept_invitation(RuntimeOrigin::signed(bob), group_id));

        // ç¦è¨€Bob
        assert_ok!(GroupChat::mute_member(RuntimeOrigin::signed(alice), group_id, bob, None));

        // Bobå‘é€æ¶ˆæ¯åº”è¯¥å¤±è´¥
        assert_noop!(
            GroupChat::send_group_message(
                RuntimeOrigin::signed(bob),
                group_id,
                b"test".to_vec(),
                0,
                None,
            ),
            Error::<Test>::MemberMuted
        );
    });
}
```

### 2. é›†æˆæµ‹è¯•ï¼ˆtests/integration/ï¼‰

```javascript
// test-group-chat.js
const { ApiPromise, WsProvider, Keyring } = require('@polkadot/api');
const { create } = require('ipfs-http-client');

describe('Group Chat Integration Tests', () => {
  let api, alice, bob, charlie, ipfs;

  before(async () => {
    api = await ApiPromise.create({ provider: new WsProvider('ws://localhost:9944') });
    const keyring = new Keyring({ type: 'sr25519' });
    alice = keyring.addFromUri('//Alice');
    bob = keyring.addFromUri('//Bob');
    charlie = keyring.addFromUri('//Charlie');
    ipfs = create({ url: 'http://localhost:5001' });
  });

  it('should create a group and send encrypted message', async () => {
    // 1. åˆ›å»ºç¾¤ç»„
    const createTx = api.tx.groupChat.createGroup(
      'Test Group',
      'Integration Test',
      null,
      { Normal: null },
      100
    );
    await createTx.signAndSend(alice);

    // 2. è·å–ç¾¤ç»„IDï¼ˆç›‘å¬äº‹ä»¶ï¼‰
    const groupId = await getGroupIdFromEvent();

    // 3. é‚€è¯·æˆå‘˜
    await api.tx.groupChat.inviteMember(groupId, bob.address).signAndSend(alice);
    await api.tx.groupChat.acceptInvitation(groupId).signAndSend(bob);

    // 4. åŠ å¯†å¹¶å‘é€æ¶ˆæ¯
    const message = 'Hello Group!';
    const groupKey = await getGroupKey(groupId, alice);
    const encryptedMessage = await encryptWithGroupKey(groupKey, message);
    const { cid } = await ipfs.add(encryptedMessage);

    await api.tx.groupChat.sendGroupMessage(groupId, cid.toString(), 0, null).signAndSend(alice);

    // 5. Bobæ¥æ”¶å¹¶è§£å¯†æ¶ˆæ¯
    const messageId = await getLastMessageId(groupId);
    const messageMeta = await api.query.groupChat.groupMessages(messageId);
    const encryptedContent = await ipfs.cat(messageMeta.contentCid);
    const decryptedMessage = await decryptWithGroupKey(groupKey, encryptedContent);

    assert.equal(decryptedMessage, message);
  });
});
```

### 3. å‰ç«¯E2Eæµ‹è¯•ï¼ˆPlaywrightï¼‰

```typescript
// e2e/group-chat.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Group Chat UI', () => {
  test('should create group and send message', async ({ page, context }) => {
    // æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨ä¸Šä¸‹æ–‡ï¼ˆæ¨¡æ‹Ÿä¸¤ä¸ªç”¨æˆ·ï¼‰
    const alicePage = await context.newPage();
    const bobPage = await context.newPage();

    // Aliceåˆ›å»ºç¾¤ç»„
    await alicePage.goto('http://localhost:5173/groups/create');
    await alicePage.fill('input[name="groupName"]', 'E2E Test Group');
    await alicePage.click('button[type="submit"]');
    await alicePage.waitForSelector('.group-created-success');

    // Aliceé‚€è¯·Bob
    const groupId = await alicePage.locator('.group-id').textContent();
    await alicePage.click('.invite-member-btn');
    await alicePage.fill('input[name="invitee"]', BOB_ADDRESS);
    await alicePage.click('.send-invitation-btn');

    // Bobæ¥å—é‚€è¯·
    await bobPage.goto(`http://localhost:5173/groups/${groupId}`);
    await bobPage.click('.accept-invitation-btn');

    // Aliceå‘é€æ¶ˆæ¯
    await alicePage.fill('.message-input', 'Hello Bob!');
    await alicePage.press('.message-input', 'Enter');

    // Bobåº”è¯¥èƒ½çœ‹åˆ°æ¶ˆæ¯
    await bobPage.waitForSelector('.message-item:has-text("Hello Bob!")');
    const message = await bobPage.locator('.message-item').last();
    expect(await message.textContent()).toContain('Hello Bob!');
  });
});
```

---

## ğŸš€ éƒ¨ç½²ä¸é…ç½®

### 1. Runtime é…ç½®

```rust
// runtime/src/configs/mod.rs

parameter_types! {
    // pallet-chat é…ç½®
    pub const MaxCidLen: u32 = 128;
    pub const MaxSessionsPerUser: u32 = 1000;
    pub const MaxMessagesPerSession: u32 = 10000;
    pub const ChatRateLimitWindow: BlockNumber = 100;  // 10åˆ†é’Ÿ
    pub const MaxChatMessagesPerWindow: u32 = 50;
    pub const MessageExpirationTime: BlockNumber = 2_592_000;  // 180å¤©
}

impl pallet_chat::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type WeightInfo = pallet_chat::weights::SubstrateWeight<Runtime>;
    type MaxCidLen = MaxCidLen;
    type MaxSessionsPerUser = MaxSessionsPerUser;
    type MaxMessagesPerSession = MaxMessagesPerSession;
    type RateLimitWindow = ChatRateLimitWindow;
    type MaxMessagesPerWindow = MaxChatMessagesPerWindow;
    type MessageExpirationTime = MessageExpirationTime;
}

parameter_types! {
    // pallet-group-chat é…ç½®
    pub const MaxGroupNameLen: u32 = 50;
    pub const MaxGroupDescLen: u32 = 500;
    pub const MaxNicknameLen: u32 = 30;
    pub const DefaultMaxMembers: u32 = 500;
    pub const MessageRecallWindow: BlockNumber = 20;  // 2åˆ†é’Ÿ
    pub const GroupChatRateLimitWindow: BlockNumber = 100;
    pub const MaxGroupMessagesPerWindow: u32 = 100;
    pub const GroupExpirationTime: BlockNumber = 5_184_000;  // 360å¤©æ— æ´»åŠ¨
}

impl pallet_group_chat::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type WeightInfo = pallet_group_chat::weights::SubstrateWeight<Runtime>;
    type MaxCidLen = MaxCidLen;
    type MaxGroupNameLen = MaxGroupNameLen;
    type MaxGroupDescLen = MaxGroupDescLen;
    type MaxNicknameLen = MaxNicknameLen;
    type DefaultMaxMembers = DefaultMaxMembers;
    type MessageRecallWindow = MessageRecallWindow;
    type RateLimitWindow = GroupChatRateLimitWindow;
    type MaxMessagesPerWindow = MaxGroupMessagesPerWindow;
    type GroupExpirationTime = GroupExpirationTime;
}
```

### 2. å‰ç«¯é…ç½®

```typescript
// stardust-dapp/src/config/chat.ts
export const CHAT_CONFIG = {
  // ä¸€å¯¹ä¸€ç§èŠ
  privateChat: {
    maxMessageLength: 5000,  // å­—ç¬¦
    maxFileSize: 10 * 1024 * 1024,  // 10MB
    supportedFileTypes: ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'],
    messagesPerPage: 50,
    enableVoiceMessage: true,
    enableVideoCall: false,  // æœªæ¥åŠŸèƒ½
  },

  // ç¾¤èŠ
  groupChat: {
    maxMembersPerGroup: 500,
    maxGroupNameLength: 50,
    maxGroupDescLength: 500,
    maxNicknameLength: 30,
    messageRecallWindow: 120,  // ç§’
    messagesPerPage: 50,
    enableFileShare: true,
    enableAnnouncement: true,
    enableGroupCall: false,  // æœªæ¥åŠŸèƒ½
  },

  // åŠ å¯†
  encryption: {
    algorithm: 'AES-GCM',
    keySize: 256,
    rsaKeySize: 2048,
    enableE2E: true,
  },

  // IPFS
  ipfs: {
    gateway: 'http://localhost:5001',
    timeout: 30000,  // 30ç§’
    retries: 3,
  },
};
```

### 3. IPFS éƒ¨ç½²

```bash
# å®‰è£…IPFSèŠ‚ç‚¹
wget https://dist.ipfs.io/go-ipfs/v0.17.0/go-ipfs_v0.17.0_linux-amd64.tar.gz
tar -xvzf go-ipfs_v0.17.0_linux-amd64.tar.gz
cd go-ipfs
sudo bash install.sh

# åˆå§‹åŒ–IPFSèŠ‚ç‚¹
ipfs init

# é…ç½®CORSï¼ˆå…è®¸å‰ç«¯è®¿é—®ï¼‰
ipfs config --json API.HTTPHeaders.Access-Control-Allow-Origin '["http://localhost:5173", "http://localhost:3000"]'
ipfs config --json API.HTTPHeaders.Access-Control-Allow-Methods '["PUT", "POST", "GET"]'

# å¯åŠ¨IPFSå®ˆæŠ¤è¿›ç¨‹
ipfs daemon

# å¯é€‰ï¼šä½¿ç”¨Pinataæˆ–Infuraç­‰IPFSç½‘å…³æœåŠ¡
# export IPFS_GATEWAY=https://gateway.pinata.cloud
```

---

## ğŸ“± å‰ç«¯é›†æˆç¤ºä¾‹

### 1. ä¸€å¯¹ä¸€ç§èŠç»„ä»¶

```typescript
// stardust-dapp/src/features/chat/PrivateChatPage.tsx
import React, { useState, useEffect } from 'react';
import { useApi } from '@/hooks/useApi';
import { useIPFS } from '@/hooks/useIPFS';
import { encryptMessage, decryptMessage } from '@/utils/encryption';

export const PrivateChatPage: React.FC = () => {
  const { api, account } = useApi();
  const { uploadToIPFS, fetchFromIPFS } = useIPFS();
  const [messages, setMessages] = useState<Message[]>([]);
  const [inputText, setInputText] = useState('');
  const [receiver, setReceiver] = useState<string>('');

  // ç›‘å¬æ–°æ¶ˆæ¯äº‹ä»¶
  useEffect(() => {
    if (!api || !account) return;

    const unsubscribe = api.query.system.events((events) => {
      events.forEach((record) => {
        const { event } = record;
        if (event.section === 'chat' && event.method === 'MessageSent') {
          const [msgId, sessionId, sender, receiver] = event.data;
          if (receiver.toString() === account.address) {
            // æ¥æ”¶åˆ°æ–°æ¶ˆæ¯ï¼ŒåŠ è½½å¹¶è§£å¯†
            loadMessage(msgId.toNumber());
          }
        }
      });
    });

    return () => {
      unsubscribe.then((unsub) => unsub());
    };
  }, [api, account]);

  // åŠ è½½å¹¶è§£å¯†æ¶ˆæ¯
  const loadMessage = async (msgId: number) => {
    const messageMeta = await api.query.chat.messages(msgId);
    if (!messageMeta) return;

    const encryptedContent = await fetchFromIPFS(messageMeta.contentCid.toString());
    const decrypted = await decryptMessage(encryptedContent, account.privateKey);

    setMessages((prev) => [...prev, {
      id: msgId,
      sender: messageMeta.sender.toString(),
      content: decrypted,
      timestamp: messageMeta.sentAt.toNumber(),
      isRead: messageMeta.isRead,
    }]);
  };

  // å‘é€æ¶ˆæ¯
  const sendMessage = async () => {
    if (!inputText.trim() || !receiver) return;

    try {
      // 1. åŠ å¯†æ¶ˆæ¯
      const encrypted = await encryptMessage(inputText, receiver);

      // 2. ä¸Šä¼ åˆ°IPFS
      const cid = await uploadToIPFS(encrypted);

      // 3. è°ƒç”¨é“¾ä¸Šå‡½æ•°
      const tx = api.tx.chat.sendMessage(
        receiver,
        cid,
        0,  // Text type
        null  // è‡ªåŠ¨åˆ›å»ºä¼šè¯
      );

      await tx.signAndSend(account, ({ status }) => {
        if (status.isInBlock) {
          console.log(`æ¶ˆæ¯å·²ä¸Šé“¾: ${status.asInBlock}`);
          setInputText('');
        }
      });
    } catch (error) {
      console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
    }
  };

  return (
    <div className="chat-container">
      <div className="chat-header">
        <input
          type="text"
          placeholder="æ¥æ”¶æ–¹åœ°å€"
          value={receiver}
          onChange={(e) => setReceiver(e.target.value)}
        />
      </div>

      <div className="message-list">
        {messages.map((msg) => (
          <div key={msg.id} className={`message ${msg.sender === account.address ? 'sent' : 'received'}`}>
            <div className="message-content">{msg.content}</div>
            <div className="message-time">{new Date(msg.timestamp * 1000).toLocaleTimeString()}</div>
          </div>
        ))}
      </div>

      <div className="chat-input">
        <input
          type="text"
          value={inputText}
          onChange={(e) => setInputText(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
          placeholder="è¾“å…¥æ¶ˆæ¯..."
        />
        <button onClick={sendMessage}>å‘é€</button>
      </div>
    </div>
  );
};
```

### 2. åˆ›å»ºç¾¤ç»„ç»„ä»¶ï¼ˆæ”¯æŒåŠ å¯†/éåŠ å¯†é€‰æ‹©ï¼‰

```typescript
// stardust-dapp/src/features/chat/CreateGroupPage.tsx
import React, { useState } from 'react';
import { useApi } from '@/hooks/useApi';
import { useIPFS } from '@/hooks/useIPFS';

export const CreateGroupPage: React.FC = () => {
  const { api, account } = useApi();
  const { uploadToIPFS } = useIPFS();
  const [groupName, setGroupName] = useState('');
  const [description, setDescription] = useState('');
  const [encryptionMode, setEncryptionMode] = useState<'encrypted' | 'unencrypted'>('encrypted');
  const [isPublicReadable, setIsPublicReadable] = useState(false);
  const [maxMembers, setMaxMembers] = useState(500);

  const createGroup = async () => {
    try {
      let groupKeyCid = null;

      // å¦‚æœæ˜¯åŠ å¯†ç¾¤ï¼Œç”Ÿæˆå¹¶ä¸Šä¼ ç¾¤å¯†é’¥
      if (encryptionMode === 'encrypted') {
        // 1. ç”Ÿæˆç¾¤å¯¹ç§°å¯†é’¥
        const groupKey = crypto.randomBytes(32);

        // 2. ç”¨åˆ›å»ºè€…çš„å…¬é’¥åŠ å¯†ç¾¤å¯†é’¥
        const myPublicKey = await getMyPublicKey();
        const encryptedGroupKey = await encryptWithPublicKey(groupKey, myPublicKey);

        // 3. ä¸Šä¼ åŠ å¯†çš„ç¾¤å¯†é’¥æ˜ å°„åˆ°IPFS
        const groupKeysData = JSON.stringify({
          [myPublicKey]: encryptedGroupKey,
        });
        const { cid } = await uploadToIPFS(groupKeysData);
        groupKeyCid = cid.toString();
      }

      // è°ƒç”¨é“¾ä¸Šå‡½æ•°åˆ›å»ºç¾¤ç»„
      const tx = api.tx.groupChat.createGroup(
        groupName,
        description,
        null, // avatar_cid
        { Normal: null }, // GroupType
        encryptionMode === 'encrypted' 
          ? { Encrypted: null } 
          : { Unencrypted: null }, // EncryptionMode
        groupKeyCid, // åŠ å¯†ç¾¤çš„å¯†é’¥CIDï¼ŒéåŠ å¯†ç¾¤ä¸ºnull
        maxMembers,
        isPublicReadable && encryptionMode === 'unencrypted' // åªæœ‰éåŠ å¯†ç¾¤æ‰èƒ½å…¬å¼€å¯è¯»
      );

      await tx.signAndSend(account, ({ status, events }) => {
        if (status.isInBlock) {
          console.log('ç¾¤ç»„åˆ›å»ºæˆåŠŸ');
          // è·³è½¬åˆ°ç¾¤ç»„é¡µé¢
          const groupId = events.find(
            e => e.event.section === 'groupChat' && e.event.method === 'GroupCreated'
          )?.event.data[0];
          if (groupId) {
            navigate(`/groups/${groupId.toString()}`);
          }
        }
      });
    } catch (error) {
      console.error('åˆ›å»ºç¾¤ç»„å¤±è´¥:', error);
    }
  };

  return (
    <div className="create-group-page">
      <h1>åˆ›å»ºç¾¤ç»„</h1>

      <div className="form-group">
        <label>ç¾¤åç§°</label>
        <input
          type="text"
          value={groupName}
          onChange={(e) => setGroupName(e.target.value)}
          placeholder="è¾“å…¥ç¾¤åç§°"
          maxLength={50}
        />
      </div>

      <div className="form-group">
        <label>ç¾¤ä»‹ç»</label>
        <textarea
          value={description}
          onChange={(e) => setDescription(e.target.value)}
          placeholder="è¾“å…¥ç¾¤ä»‹ç»"
          maxLength={500}
        />
      </div>

      <div className="form-group">
        <label>åŠ å¯†æ¨¡å¼</label>
        <div className="encryption-mode-selector">
          <div 
            className={`mode-option ${encryptionMode === 'encrypted' ? 'selected' : ''}`}
            onClick={() => setEncryptionMode('encrypted')}
          >
            <h3>ğŸ” åŠ å¯†ç¾¤</h3>
            <p>æ¶ˆæ¯ç«¯åˆ°ç«¯åŠ å¯†ï¼Œåªæœ‰æˆå‘˜å¯è¯»</p>
            <ul>
              <li>âœ… é«˜åº¦éšç§ä¿æŠ¤</li>
              <li>âœ… é€‚åˆç§å¯†è®¨è®º</li>
              <li>âŒ æ€§èƒ½ç¨æ…¢</li>
            </ul>
          </div>

          <div 
            className={`mode-option ${encryptionMode === 'unencrypted' ? 'selected' : ''}`}
            onClick={() => setEncryptionMode('unencrypted')}
          >
            <h3>ğŸŒ å…¬å¼€ç¾¤</h3>
            <p>æ¶ˆæ¯æ˜æ–‡å­˜å‚¨ï¼Œå…¬å¼€é€æ˜</p>
            <ul>
              <li>âœ… æ€§èƒ½å¿«é€Ÿ</li>
              <li>âœ… é€‚åˆå…¬å¼€è®¨è®º</li>
              <li>âœ… ä¾¿äºæœç´¢å’Œå®¡è®¡</li>
            </ul>
          </div>
        </div>
      </div>

      {encryptionMode === 'unencrypted' && (
        <div className="form-group">
          <label>
            <input
              type="checkbox"
              checked={isPublicReadable}
              onChange={(e) => setIsPublicReadable(e.target.checked)}
            />
            å…è®¸éæˆå‘˜æŸ¥çœ‹æ¶ˆæ¯
          </label>
          <p className="hint">
            å¦‚æœå‹¾é€‰ï¼Œä»»ä½•äººéƒ½å¯ä»¥é€šè¿‡IPFSæŸ¥çœ‹ç¾¤æ¶ˆæ¯ï¼ˆå³ä½¿ä¸æ˜¯ç¾¤æˆå‘˜ï¼‰
          </p>
        </div>
      )}

      <div className="form-group">
        <label>æœ€å¤§æˆå‘˜æ•°</label>
        <input
          type="number"
          value={maxMembers}
          onChange={(e) => setMaxMembers(Number(e.target.value))}
          min={2}
          max={1000}
        />
      </div>

      <button onClick={createGroup} className="create-btn">
        åˆ›å»ºç¾¤ç»„
      </button>
    </div>
  );
};
```

### 3. ç¾¤èŠæ¶ˆæ¯ç»„ä»¶ï¼ˆæ”¯æŒåŠ å¯†/éåŠ å¯†æ¶ˆæ¯ï¼‰

```typescript
// stardust-dapp/src/features/chat/GroupChatPage.tsx
import React, { useState, useEffect } from 'react';
import { useParams } from 'react-router-dom';
import { useApi } from '@/hooks/useApi';
import { useIPFS } from '@/hooks/useIPFS';
import { encryptGroupMessage, decryptGroupMessage } from '@/utils/groupEncryption';

export const GroupChatPage: React.FC = () => {
  const { groupId } = useParams<{ groupId: string }>();
  const { api, account } = useApi();
  const { uploadToIPFS, fetchFromIPFS } = useIPFS();
  const [groupInfo, setGroupInfo] = useState<GroupInfo | null>(null);
  const [messages, setMessages] = useState<GroupMessage[]>([]);
  const [members, setMembers] = useState<GroupMember[]>([]);
  const [inputText, setInputText] = useState('');

  // åŠ è½½ç¾¤ç»„ä¿¡æ¯
  useEffect(() => {
    loadGroupInfo();
    loadMembers();
    loadMessages();
  }, [groupId]);

  const loadGroupInfo = async () => {
    const info = await api.query.groupChat.groups(groupId);
    setGroupInfo(info.toJSON());
  };

  const loadMembers = async () => {
    const memberList = await api.query.groupChat.groupMembers.entries(groupId);
    const parsed = memberList.map(([key, value]) => value.toJSON());
    setMembers(parsed);
  };

  const loadMessages = async (page = 0) => {
    const messageIds = await api.rpc.groupChat.listGroupMessages(groupId, page * 50, 50);

    const messagesData = await Promise.all(
      messageIds.map(async (id) => {
        const meta = await api.query.groupChat.groupMessages(id);
        const contentFromIPFS = await fetchFromIPFS(meta.contentCid.toString());
        
        // æ ¹æ®ç¾¤ç»„åŠ å¯†æ¨¡å¼å¤„ç†æ¶ˆæ¯
        let content: string;
        if (groupInfo?.encryptionMode?.Encrypted) {
          // åŠ å¯†ç¾¤ï¼šéœ€è¦è§£å¯†
          const groupKey = await getGroupKey(groupId);
          content = await decryptGroupMessage(contentFromIPFS, groupKey);
        } else {
          // éåŠ å¯†ç¾¤ï¼šç›´æ¥æ˜¾ç¤ºæ˜æ–‡
          content = contentFromIPFS.toString();
        }

        return {
          id: id.toNumber(),
          sender: meta.sender.toString(),
          content,
          timestamp: meta.sentAt.toNumber(),
          isRecalled: meta.isRecalled,
        };
      })
    );

    setMessages(messagesData);
  };

  const sendMessage = async () => {
    if (!inputText.trim()) return;

    try {
      let cid: string;

      // æ ¹æ®ç¾¤ç»„åŠ å¯†æ¨¡å¼å¤„ç†æ¶ˆæ¯
      if (groupInfo?.encryptionMode?.Encrypted) {
        // åŠ å¯†ç¾¤ï¼šåŠ å¯†åä¸Šä¼ 
        const groupKey = await getGroupKey(groupId);
        const encrypted = await encryptGroupMessage(inputText, groupKey);
        cid = await uploadToIPFS(encrypted);
      } else {
        // éåŠ å¯†ç¾¤ï¼šæ˜æ–‡ä¸Šä¼ 
        cid = await uploadToIPFS(inputText);
      }

      const tx = api.tx.groupChat.sendGroupMessage(
        groupId,
        cid,
        0,  // Text
        null  // ä¸å›å¤
      );

      await tx.signAndSend(account, ({ status }) => {
        if (status.isInBlock) {
          setInputText('');
          loadMessages();  // åˆ·æ–°æ¶ˆæ¯åˆ—è¡¨
        }
      });
    } catch (error) {
      console.error('å‘é€ç¾¤æ¶ˆæ¯å¤±è´¥:', error);
    }
  };

  const inviteMember = async (invitee: string) => {
    const tx = api.tx.groupChat.inviteMember(groupId, invitee);
    await tx.signAndSend(account);
  };

  const muteMember = async (member: string, duration?: number) => {
    const tx = api.tx.groupChat.muteMember(groupId, member, duration || null);
    await tx.signAndSend(account);
  };

  return (
    <div className="group-chat-container">
      <div className="group-header">
        <h2>{groupInfo?.name}</h2>
        <div className="member-count">{groupInfo?.memberCount} æˆå‘˜</div>
        <button onClick={() => setShowMemberList(true)}>æˆå‘˜åˆ—è¡¨</button>
      </div>

      <div className="message-list">
        {messages.map((msg) => (
          <div key={msg.id} className={`message ${msg.sender === account.address ? 'sent' : 'received'}`}>
            <div className="message-sender">{getMemberNickname(msg.sender)}</div>
            <div className="message-content">
              {msg.isRecalled ? 'æ¶ˆæ¯å·²æ’¤å›' : msg.content}
            </div>
            <div className="message-time">{formatTime(msg.timestamp)}</div>
          </div>
        ))}
      </div>

      <div className="chat-input">
        <input
          type="text"
          value={inputText}
          onChange={(e) => setInputText(e.target.value)}
          onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
          placeholder="è¾“å…¥æ¶ˆæ¯..."
        />
        <button onClick={sendMessage}>å‘é€</button>
      </div>
    </div>
  );
};
```

---

## ğŸ¯ å®æ–½è·¯çº¿å›¾

### Phase 1: ä¸€å¯¹ä¸€ç§èŠå®Œå–„ï¼ˆå·²å®Œæˆ âœ…ï¼‰
- âœ… åŸºç¡€æ¶ˆæ¯å‘é€ä¸æ¥æ”¶
- âœ… ä¼šè¯ç®¡ç†
- âœ… å·²è¯»/æœªè¯»çŠ¶æ€
- âœ… é»‘åå•åŠŸèƒ½
- âœ… é¢‘ç‡é™åˆ¶
- âœ… CIDåŠ å¯†éªŒè¯

### Phase 2: å‰ç«¯é›†æˆç§èŠï¼ˆå½“å‰è¿›è¡Œä¸­ï¼‰
- ğŸ”¨ å®ç°åŠ å¯†/è§£å¯†å·¥å…·å‡½æ•°
- ğŸ”¨ å¼€å‘ç§èŠUIç»„ä»¶
- ğŸ”¨ é›†æˆIPFSä¸Šä¼ /ä¸‹è½½
- ğŸ”¨ å®ç°æ¶ˆæ¯ç¼“å­˜ç­–ç•¥
- ğŸ”¨ æ·»åŠ å›¾ç‰‡/æ–‡ä»¶æ”¯æŒ

### Phase 3: ç¾¤èŠåŠŸèƒ½å¼€å‘ï¼ˆå»ºè®®Q2 2025ï¼‰
- ğŸ“… **3.1 åŠ å¯†ç¾¤å®ç°**
  - ğŸ“… å®ç° `pallet-group-chat` æ ¸å¿ƒé€»è¾‘
  - ğŸ“… æ”¯æŒ `EncryptionMode::Encrypted`
  - ğŸ“… ç¾¤å¯†é’¥ç”Ÿæˆã€åŠ å¯†ã€åˆ†å‘æœºåˆ¶
  - ğŸ“… æˆå‘˜å˜æ›´æ—¶çš„å¯†é’¥ç®¡ç†
  - ğŸ“… ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
- ğŸ“… **3.2 éåŠ å¯†ç¾¤å®ç°**
  - ğŸ“… æ”¯æŒ `EncryptionMode::Unencrypted`
  - ğŸ“… å…¬å¼€å¯è¯»ç¾¤ç»„ï¼ˆ`is_public_readable`ï¼‰
  - ğŸ“… æ˜æ–‡æ¶ˆæ¯å­˜å‚¨åˆ°IPFS
  - ğŸ“… éæˆå‘˜æŸ¥çœ‹æƒé™æ§åˆ¶
- ğŸ“… **3.3 å‰ç«¯é›†æˆ**
  - ğŸ“… åˆ›å»ºç¾¤ç»„UIï¼ˆé€‰æ‹©åŠ å¯†æ¨¡å¼ï¼‰
  - ğŸ“… åŠ å¯†ç¾¤æ¶ˆæ¯åŠ å¯†/è§£å¯†
  - ğŸ“… éåŠ å¯†ç¾¤æ˜æ–‡æ˜¾ç¤º
  - ğŸ“… æˆå‘˜ç®¡ç†ç•Œé¢
- ğŸ“… **3.4 Runtimeé…ç½®å’Œéƒ¨ç½²**
  - ğŸ“… æƒé‡è®¡ç®—å’ŒBenchmark
  - ğŸ“… æµ‹è¯•ç½‘éƒ¨ç½²éªŒè¯

### Phase 4: é«˜çº§åŠŸèƒ½ï¼ˆå»ºè®®Q3 2025ï¼‰
- ğŸ“… **4.1 æ¶ˆæ¯åŠŸèƒ½å¢å¼º**
  - ğŸ“… æ¶ˆæ¯æœç´¢ï¼ˆå…¨æ–‡æœç´¢ï¼‰
  - ğŸ“… æ¶ˆæ¯è½¬å‘
  - ğŸ“… å¯Œæ–‡æœ¬æ¶ˆæ¯
  - ğŸ“… æ¶ˆæ¯ç¿»è¯‘
- ğŸ“… **4.2 ç¾¤ç»„é«˜çº§åŠŸèƒ½**
  - ğŸ“… ç¾¤æŠ•ç¥¨åŠŸèƒ½
  - ğŸ“… ç¾¤æ–‡ä»¶ç®¡ç†
  - ğŸ“… å­ç¾¤ç»„ï¼ˆé¢‘é“ï¼‰
  - ğŸ“… ç¾¤æœºå™¨äºº
- ğŸ“… **4.3 å®æ—¶é€šè®¯**
  - ğŸ“… è¯­éŸ³/è§†é¢‘é€šè¯ï¼ˆWebRTCï¼‰
  - ğŸ“… å±å¹•å…±äº«
  - ğŸ“… å®æ—¶åä½œ

### Phase 5: å®‰å…¨ä¸æ€§èƒ½ä¼˜åŒ–ï¼ˆå»ºè®®Q4 2025ï¼‰
- ğŸ“… Signal Protocolé›†æˆ
- ğŸ“… Subsquid ETLä¼˜åŒ–
- ğŸ“… é“¾ä¸‹å·¥ä½œæœºæ¸…ç†ä»»åŠ¡
- ğŸ“… å®‰å…¨å®¡è®¡
- ğŸ“… å‹åŠ›æµ‹è¯•

---

## ğŸ“š å‚è€ƒèµ„æ–™

### æŠ€æœ¯æ–‡æ¡£
1. **Substrateæ–‡æ¡£**: https://docs.substrate.io
2. **Polkadot-JS API**: https://polkadot.js.org/docs/
3. **IPFSæ–‡æ¡£**: https://docs.ipfs.tech
4. **Signal Protocol**: https://signal.org/docs/

### åŠ å¯†åº“æ¨è
- **å‰ç«¯**: `crypto-js`, `tweetnacl`, `elliptic`
- **Rust**: `sp-core::crypto`, `aes-gcm`, `rsa`

### ç›¸å…³é¡¹ç›®å‚è€ƒ
- **Status.im**: å»ä¸­å¿ƒåŒ–ç§»åŠ¨æ¶ˆæ¯åº”ç”¨
- **Matrix Protocol**: å»ä¸­å¿ƒåŒ–é€šä¿¡åè®®
- **Session**: åŸºäºåŒºå—é“¾çš„ç§å¯†é€šä¿¡åº”ç”¨

---

## ğŸ“ æ€»ç»“

æœ¬æ–¹æ¡ˆæä¾›äº†å®Œæ•´çš„ Substrate åŒºå—é“¾èŠå¤©ç³»ç»Ÿè®¾è®¡ï¼Œæ ¸å¿ƒç‰¹ç‚¹ï¼š

1. **æ··åˆå­˜å‚¨æ¶æ„**ï¼šé“¾ä¸Šå­˜å‚¨å…ƒæ•°æ®ï¼ŒIPFSå­˜å‚¨å†…å®¹ï¼Œå…¼é¡¾æ€§èƒ½ä¸å»ä¸­å¿ƒåŒ–
2. **çµæ´»çš„åŠ å¯†ç­–ç•¥**ï¼š
   - ğŸ” **ç§èŠ**ï¼šå¼ºåˆ¶ç«¯åˆ°ç«¯åŠ å¯†
   - ğŸ” **åŠ å¯†ç¾¤**ï¼šç¾¤å¯†é’¥åŠ å¯†ï¼Œåªæœ‰æˆå‘˜å¯è¯»
   - ğŸŒ **éåŠ å¯†ç¾¤**ï¼šæ˜æ–‡å­˜å‚¨ï¼Œå…¬å¼€é€æ˜ï¼ˆå¯é…ç½®å…¬å¼€å¯è¯»ï¼‰
3. **åŒæ¨¡å¼ç¾¤èŠè®¾è®¡**ï¼š
   - ç”¨æˆ·å¯è‡ªç”±é€‰æ‹©åˆ›å»ºåŠ å¯†ç¾¤æˆ–éåŠ å¯†ç¾¤
   - åŠ å¯†ç¾¤é€‚ç”¨äºç§å¯†è®¨è®ºã€å•†ä¸šæœºå¯†
   - éåŠ å¯†ç¾¤é€‚ç”¨äºå…¬å‘Šé¢‘é“ã€å…¬å¼€è®¨è®ºã€DAOæ²»ç†
4. **æ¨¡å—åŒ–è®¾è®¡**ï¼šä¸€å¯¹ä¸€ç§èŠå’Œç¾¤èŠåˆ†ç¦»ä¸ºç‹¬ç«‹palletï¼Œä½è€¦åˆ
5. **å®Œå–„çš„æƒé™ç®¡ç†**ï¼šç¾¤ä¸»/ç®¡ç†å‘˜/æˆå‘˜ä¸‰çº§æƒé™
6. **å®‰å…¨é˜²æŠ¤**ï¼šé¢‘ç‡é™åˆ¶ã€é»‘åå•ã€CIDåŠ å¯†éªŒè¯ï¼ˆé’ˆå¯¹ä¸åŒç¾¤ç±»å‹ï¼‰ã€æ¶ˆæ¯æ’¤å›
7. **å¯æ‰©å±•æ€§**ï¼šæ”¯æŒæœªæ¥é›†æˆè¯­éŸ³/è§†é¢‘é€šè¯ã€æ–‡ä»¶å…±äº«ã€æ¶ˆæ¯æœç´¢ç­‰é«˜çº§åŠŸèƒ½

**åŠ å¯†ç¾¤ vs éåŠ å¯†ç¾¤ä½¿ç”¨åœºæ™¯**ï¼š

| åœºæ™¯ | æ¨èæ¨¡å¼ | åŸå›  |
|------|---------|------|
| å•†ä¸šè°ˆåˆ¤ã€æœºå¯†è®¨è®º | åŠ å¯†ç¾¤ | éœ€è¦ç«¯åˆ°ç«¯åŠ å¯†ä¿æŠ¤éšç§ |
| é¡¹ç›®å›¢é˜Ÿå†…éƒ¨æ²Ÿé€š | åŠ å¯†ç¾¤ | å›¢é˜Ÿç§å¯†ä¿¡æ¯ä¸å¯¹å¤–å…¬å¼€ |
| å®˜æ–¹å…¬å‘Šé¢‘é“ | éåŠ å¯†ç¾¤ | é€æ˜åº¦é«˜ï¼Œä»»ä½•äººå¯æŸ¥çœ‹ |
| æŠ€æœ¯ç¤¾åŒºè®¨è®º | éåŠ å¯†ç¾¤ | å…¬å¼€äº¤æµï¼Œä¾¿äºæœç´¢å’Œç´¢å¼• |
| DAOææ¡ˆè®¨è®º | éåŠ å¯†ç¾¤ | æ²»ç†éœ€è¦é€æ˜ï¼Œå…¬å¼€è®¨è®ºè®°å½• |
| ç›´æ’­èŠå¤©å®¤ | éåŠ å¯†ç¾¤ | å®æ—¶æ€§è¦æ±‚é«˜ï¼Œæ€§èƒ½ä¼˜å…ˆ |

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®**ï¼š
1. å®Œæˆ Phase 2 å‰ç«¯é›†æˆç§èŠåŠŸèƒ½
2. åœ¨æµ‹è¯•ç½‘éƒ¨ç½²å¹¶è¿›è¡Œå……åˆ†æµ‹è¯•
3. å¯åŠ¨ Phase 3.1 å®ç°åŠ å¯†ç¾¤åŠŸèƒ½
4. å¯åŠ¨ Phase 3.2 å®ç°éåŠ å¯†ç¾¤åŠŸèƒ½
5. ç¤¾åŒºåé¦ˆå’Œè¿­ä»£ä¼˜åŒ–

å¦‚éœ€è¿›ä¸€æ­¥çš„æŠ€æœ¯æ”¯æŒæˆ–ä»£ç ç¤ºä¾‹ï¼Œè¯·å‚è€ƒé¡¹ç›®æ–‡æ¡£æˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v2.0ï¼ˆå¢åŠ åŠ å¯†ç¾¤å’ŒéåŠ å¯†ç¾¤æ”¯æŒï¼‰
**æœ€åæ›´æ–°**: 2025-11-20
**ä½œè€…**: Stardust Development Team
**è®¸å¯**: Apache 2.0

---

## ğŸ†• v2.0 æ›´æ–°æ—¥å¿—

### ä¸»è¦å˜æ›´
1. **æ–°å¢åŠ å¯†æ¨¡å¼è®¾è®¡**
   - æ·»åŠ  `EncryptionMode` æšä¸¾ï¼ˆEncrypted / Unencryptedï¼‰
   - ç¾¤ç»„åˆ›å»ºæ—¶å¯é€‰æ‹©åŠ å¯†æ¨¡å¼
   - åŠ å¯†æ¨¡å¼ä¸€ç»åˆ›å»ºä¸å¯æ›´æ”¹

2. **åŠ å¯†ç¾¤åŠŸèƒ½**
   - ç¾¤å¯†é’¥ç”Ÿæˆä¸ç®¡ç†
   - æˆå‘˜å…¬é’¥åŠ å¯†ç¾¤å¯†é’¥
   - æ”¯æŒæˆå‘˜å˜æ›´æ—¶çš„å¯†é’¥æ›´æ–°
   - å¯é€‰çš„å¯†é’¥è½®æ¢æœºåˆ¶

3. **éåŠ å¯†ç¾¤åŠŸèƒ½**
   - æ˜æ–‡æ¶ˆæ¯å­˜å‚¨
   - å¯é…ç½®å…¬å¼€å¯è¯»ï¼ˆ`is_public_readable`ï¼‰
   - éæˆå‘˜è®¿é—®æ§åˆ¶
   - æ€§èƒ½ä¼˜åŒ–ï¼ˆæ— åŠ å¯†å¼€é”€ï¼‰

4. **CIDéªŒè¯ä¼˜åŒ–**
   - é’ˆå¯¹ä¸åŒåŠ å¯†æ¨¡å¼çš„éªŒè¯ç­–ç•¥
   - åŠ å¯†ç¾¤å¼ºåˆ¶åŠ å¯†CID
   - éåŠ å¯†ç¾¤å…è®¸æ˜æ–‡CID

5. **å‰ç«¯å®ç°ç¤ºä¾‹**
   - åˆ›å»ºç¾¤ç»„UIï¼ˆåŠ å¯†æ¨¡å¼é€‰æ‹©å™¨ï¼‰
   - è‡ªé€‚åº”åŠ å¯†/è§£å¯†é€»è¾‘
   - ç¾¤å¯†é’¥ç®¡ç†å·¥å…·å‡½æ•°

6. **å®æ–½è·¯çº¿å›¾æ›´æ–°**
   - Phase 3 æ‹†åˆ†ä¸ºåŠ å¯†ç¾¤å’ŒéåŠ å¯†ç¾¤å®ç°
   - å¢åŠ ä½¿ç”¨åœºæ™¯è¯´æ˜
   - æ›´æ–°ä¸‹ä¸€æ­¥è¡ŒåŠ¨å»ºè®®
