# ç”¨æˆ·æ“ä½œé€»è¾‘ç¼ºé™·åˆ†ææŠ¥å‘Š

> **åˆ†æç›®æ ‡**ï¼šå…¨é¢è¯„ä¼° Stardust é¡¹ç›®ç”¨æˆ·æ“ä½œé€»è¾‘ï¼Œè¯†åˆ«æ½œåœ¨ç¼ºé™·ï¼Œæå‡ºä¼˜åŒ–å»ºè®®

---

## ğŸ“‹ ç›®å½•

1. [æ“ä½œé€»è¾‘æ¦‚è§ˆ](#1-æ“ä½œé€»è¾‘æ¦‚è§ˆ)
2. [å·²è¯†åˆ«çš„æ“ä½œé€»è¾‘ç¼ºé™·](#2-å·²è¯†åˆ«çš„æ“ä½œé€»è¾‘ç¼ºé™·)
3. [æƒé™æ£€æŸ¥é—®é¢˜](#3-æƒé™æ£€æŸ¥é—®é¢˜)
4. [çŠ¶æ€è½¬æ¢é—®é¢˜](#4-çŠ¶æ€è½¬æ¢é—®é¢˜)
5. [æ“ä½œæµç¨‹é—®é¢˜](#5-æ“ä½œæµç¨‹é—®é¢˜)
6. [è¾¹ç•Œæƒ…å†µå¤„ç†](#6-è¾¹ç•Œæƒ…å†µå¤„ç†)
7. [ç”¨æˆ·ä½“éªŒé—®é¢˜](#7-ç”¨æˆ·ä½“éªŒé—®é¢˜)
8. [ä¼˜åŒ–å»ºè®®](#8-ä¼˜åŒ–å»ºè®®)

---

## 1. æ“ä½œé€»è¾‘æ¦‚è§ˆ

### 1.1 æ ¸å¿ƒç”¨æˆ·æ“ä½œ

| æ“ä½œç±»å‹ | ä¸»è¦æ¥å£ | æƒé™è¦æ±‚ | çŠ¶æ€å½±å“ |
|---------|---------|---------|---------|
| **åˆ›å»ºé€è€…** | `create_deceased` | å¢“ä¸»æƒé™ | åˆ›å»ºè®°å½• + é”å®šæŠ¼é‡‘ |
| **æ›´æ–°é€è€…** | `update_deceased` | é€è€…owner | æ›´æ–°è®°å½• + ç‰ˆæœ¬å†å² |
| **åˆ é™¤é€è€…** | `remove_deceased` | é€è€…owner | åˆ é™¤è®°å½• |
| **è¿ç§»é€è€…** | `transfer_deceased` | é€è€…owner | å˜æ›´å¢“ä½ + åŒæ­¥è®°å½• |
| **è½¬è®©æ‹¥æœ‰æƒ** | `transfer_owner` | é€è€…owner | å˜æ›´owner |
| **åˆ›å»ºå¢“ä½** | `create_grave` | ä»»æ„ç”¨æˆ· | åˆ›å»ºè®°å½• + æ”¯ä»˜è´¹ç”¨ |
| **æ›´æ–°å¢“ä½** | `update_grave` | å¢“ä¸»/ç®¡ç†å‘˜ | æ›´æ–°è®°å½• |
| **ä¾›å¥‰** | `offer_by_sacrifice` | ä»»æ„ç”¨æˆ· | åˆ›å»ºè®¢å• + æ”¯ä»˜è´¹ç”¨ |
| **OTCäº¤æ˜“** | `create_order` | é€šè¿‡KYC | åˆ›å»ºè®¢å• + é”å®šèµ„é‡‘ |

---

## 2. å·²è¯†åˆ«çš„æ“ä½œé€»è¾‘ç¼ºé™·

### 2.1 ç¼ºé™·ä¸€ï¼šæƒé™æ£€æŸ¥ä¸ä¸€è‡´ âš ï¸âš ï¸

#### é—®é¢˜æè¿°

**ä¸åŒæ“ä½œä½¿ç”¨ä¸åŒçš„æƒé™æ£€æŸ¥æ–¹å¼ï¼Œå®¹æ˜“å¯¼è‡´æƒé™æ¼æ´**

**é—®é¢˜ç¤ºä¾‹1ï¼š`pallet-stardust-grave/src/lib.rs` - `add_admin` å‡½æ•°**

```rust
pub fn add_admin(origin: OriginFor<T>, id: u64, who: T::AccountId) -> DispatchResult {
    if let Some(g) = Graves::<T>::get(id) {
        let o = origin.clone();
        if let Ok(sender) = ensure_signed(o) {
            if sender != g.owner {
                if let Some(pid) = g.park_id {
                    T::ParkAdmin::ensure(pid, origin)?;
                } else {
                    return Err(Error::<T>::NotAdmin.into());
                }
            }
        }
    } else {
        return Err(Error::<T>::NotFound.into());
    }
    // ...
}
```

**é—®é¢˜**ï¼š
- æƒé™æ£€æŸ¥é€»è¾‘å¤æ‚ï¼ŒåµŒå¥—å¤šå±‚ `if`
- å¦‚æœ `ensure_signed` å¤±è´¥ï¼Œæ²¡æœ‰æ˜ç¡®å¤„ç†
- å¦‚æœå¢“ä½ä¸å­˜åœ¨ï¼Œå…ˆæ£€æŸ¥æƒé™å†è¿”å›é”™è¯¯ï¼ˆé€»è¾‘é¡ºåºä¸åˆç†ï¼‰

**é—®é¢˜ç¤ºä¾‹2ï¼š`pallet-deceased/src/lib.rs` - æƒé™æ£€æŸ¥ä¸ç»Ÿä¸€**

```rust
// æ–¹å¼1ï¼šç›´æ¥æ£€æŸ¥
ensure!(d.owner == who, Error::<T>::NotAuthorized);

// æ–¹å¼2ï¼šä½¿ç”¨è¾…åŠ©å‡½æ•°
ensure!(Self::is_owner(id, &who), Error::<T>::NotAuthorized);

// æ–¹å¼3ï¼šä½¿ç”¨trait
T::GraveProvider::can_attach(&who, grave_id)
```

**é—®é¢˜**ï¼š
- æƒé™æ£€æŸ¥æ–¹å¼ä¸ç»Ÿä¸€
- é”™è¯¯ç±»å‹ä¸ä¸€è‡´ï¼ˆ`NotAuthorized` vs `NotDeceasedOwner`ï¼‰
- å®¹æ˜“é—æ¼æƒé™æ£€æŸ¥

#### å½±å“ç¨‹åº¦ï¼šâ­â­â­â­ï¼ˆè¾ƒé«˜ï¼‰

**å½±å“**ï¼š
- å¯èƒ½å¯¼è‡´æƒé™æ¼æ´
- ä»£ç å¯ç»´æŠ¤æ€§å·®
- å®¹æ˜“å¼•å…¥å®‰å…¨é£é™©

#### è§£å†³æ–¹æ¡ˆ

**ç»Ÿä¸€æƒé™æ£€æŸ¥æœºåˆ¶**

```rust
// ç»Ÿä¸€çš„æƒé™æ£€æŸ¥trait
pub trait PermissionChecker<T: Config> {
    fn can_update_deceased(who: &T::AccountId, id: DeceasedId) -> bool;
    fn can_delete_deceased(who: &T::AccountId, id: DeceasedId) -> bool;
    fn can_transfer_deceased(who: &T::AccountId, id: DeceasedId) -> bool;
}

// ç»Ÿä¸€ä½¿ç”¨
ensure!(
    Self::can_update_deceased(&who, id),
    Error::<T>::NotAuthorized
);
```

### 2.2 ç¼ºé™·äºŒï¼šçŠ¶æ€è½¬æ¢ç¼ºå°‘éªŒè¯ âš ï¸âš ï¸

#### é—®é¢˜æè¿°

**æŸäº›çŠ¶æ€è½¬æ¢ç¼ºå°‘å‰ç½®æ¡ä»¶æ£€æŸ¥ï¼Œå¯èƒ½å¯¼è‡´éæ³•çŠ¶æ€**

**é—®é¢˜ç¤ºä¾‹1ï¼š`pallet-otc-order` - è®¢å•çŠ¶æ€è½¬æ¢**

```rust
pub fn mark_paid(origin: OriginFor<T>, order_id: u64) -> DispatchResult {
    let who = ensure_signed(origin)?;
    Orders::<T>::try_mutate(order_id, |order| -> DispatchResult {
        let o = order.as_mut().ok_or(Error::<T>::OrderNotFound)?;
        ensure!(o.taker == who, Error::<T>::NotAuthorized);
        // âš ï¸ é—®é¢˜ï¼šæ²¡æœ‰æ£€æŸ¥å½“å‰çŠ¶æ€æ˜¯å¦ä¸º Created
        o.state = OrderState::PaidOrCommitted;
        Ok(())
    })
}
```

**é—®é¢˜**ï¼š
- æ²¡æœ‰æ£€æŸ¥è®¢å•å½“å‰çŠ¶æ€
- å¯èƒ½ä»ä»»æ„çŠ¶æ€è½¬æ¢åˆ° `PaidOrCommitted`
- å¯èƒ½å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´

**é—®é¢˜ç¤ºä¾‹2ï¼š`pallet-memorial` - ä¾›å¥‰çŠ¶æ€è½¬æ¢**

```rust
// è‡ªåŠ¨ç»­è´¹é€»è¾‘
if Self::try_auto_renew(offering_id, &mut record).is_ok() {
    record.status = OfferingStatus::Active;
    // âš ï¸ é—®é¢˜ï¼šæ²¡æœ‰æ£€æŸ¥å½“å‰çŠ¶æ€
}
```

**é—®é¢˜**ï¼š
- çŠ¶æ€è½¬æ¢ç¼ºå°‘å‰ç½®æ¡ä»¶æ£€æŸ¥
- å¯èƒ½ä»éæ³•çŠ¶æ€è½¬æ¢

#### å½±å“ç¨‹åº¦ï¼šâ­â­â­â­ï¼ˆè¾ƒé«˜ï¼‰

**å½±å“**ï¼š
- å¯èƒ½å¯¼è‡´çŠ¶æ€ä¸ä¸€è‡´
- å¯èƒ½å½±å“ä¸šåŠ¡é€»è¾‘æ­£ç¡®æ€§
- å¯èƒ½è¢«æ¶æ„åˆ©ç”¨

#### è§£å†³æ–¹æ¡ˆ

**çŠ¶æ€æœºéªŒè¯**

```rust
// å®šä¹‰åˆæ³•çš„çŠ¶æ€è½¬æ¢
pub enum StateTransition {
    CreatedToPaid,
    PaidToReleased,
    // ...
}

// éªŒè¯çŠ¶æ€è½¬æ¢
fn validate_transition(
    from: OrderState,
    to: OrderState,
) -> Result<(), Error<T>> {
    match (from, to) {
        (OrderState::Created, OrderState::PaidOrCommitted) => Ok(()),
        (OrderState::PaidOrCommitted, OrderState::Released) => Ok(()),
        _ => Err(Error::<T>::InvalidStateTransition),
    }
}
```

### 2.3 ç¼ºé™·ä¸‰ï¼šæ“ä½œåŸå­æ€§ä¸è¶³ âš ï¸âš ï¸âš ï¸

#### é—®é¢˜æè¿°

**æŸäº›æ“ä½œæ¶‰åŠå¤šä¸ªå­˜å‚¨æ›´æ–°ï¼Œä½†ç¼ºå°‘åŸå­æ€§ä¿è¯**

**é—®é¢˜ç¤ºä¾‹1ï¼š`pallet-deceased/src/lib.rs` - `transfer_deceased`**

```rust
pub fn transfer_deceased(...) -> DispatchResult {
    // 1. æ›´æ–° DeceasedOf
    DeceasedOf::<T>::try_mutate(id, |d| {
        d.grave_id = new_grave;
    })?;
    
    // 2. æ›´æ–° DeceasedByGraveï¼ˆæ–°å¢“ä½ï¼‰
    DeceasedByGrave::<T>::mutate(new_grave, |list| {
        list.push(id);
    });
    
    // 3. æ›´æ–° DeceasedByGraveï¼ˆæ—§å¢“ä½ï¼‰
    DeceasedByGrave::<T>::mutate(old_grave, |list| {
        list.swap_remove(pos);
    });
    
    // 4. åŒæ­¥ Interments
    T::GraveProvider::record_exhumation(old_grave, deceased_id_u64)?;
    T::GraveProvider::record_interment(new_grave, deceased_id_u64, None, None)?;
}
```

**é—®é¢˜**ï¼š
- æ¶‰åŠå¤šä¸ªå­˜å‚¨æ›´æ–°
- å¦‚æœä¸­é—´æ­¥éª¤å¤±è´¥ï¼Œå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- è™½ç„¶ä½¿ç”¨äº† `try_mutate`ï¼Œä½†å¤šä¸ªæ“ä½œä¹‹é—´æ²¡æœ‰äº‹åŠ¡ä¿è¯

**é—®é¢˜ç¤ºä¾‹2ï¼š`pallet-memorial` - ä¾›å¥‰åˆ†è´¦**

```rust
// 1. æ‰£é™¤ç”¨æˆ·ä½™é¢
T::Currency::transfer(&who, &platform_account, platform_share, ExistenceRequirement::KeepAlive)?;

// 2. åˆ†é…ç»™ç›®æ ‡è´¦æˆ·
T::Currency::transfer(&platform_account, &target_account, target_share, ExistenceRequirement::KeepAlive)?;

// 3. åˆ†é…ç»™æ¨èäºº
T::Affiliate::distribute(...)?;
```

**é—®é¢˜**ï¼š
- æ¶‰åŠå¤šä¸ªè½¬è´¦æ“ä½œ
- å¦‚æœä¸­é—´æ­¥éª¤å¤±è´¥ï¼Œå¯èƒ½å¯¼è‡´èµ„é‡‘ä¸ä¸€è‡´
- æ²¡æœ‰å›æ»šæœºåˆ¶

#### å½±å“ç¨‹åº¦ï¼šâ­â­â­â­â­ï¼ˆä¸¥é‡ï¼‰

**å½±å“**ï¼š
- å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´
- å¯èƒ½å¯¼è‡´èµ„é‡‘æŸå¤±
- å¯èƒ½å½±å“ä¸šåŠ¡é€»è¾‘æ­£ç¡®æ€§

#### è§£å†³æ–¹æ¡ˆ

**ä½¿ç”¨äº‹åŠ¡æˆ–æ‰¹é‡æ“ä½œ**

```rust
// æ–¹æ¡ˆ1ï¼šä½¿ç”¨ try_mutate ç¡®ä¿åŸå­æ€§
DeceasedOf::<T>::try_mutate(id, |d| -> DispatchResult {
    // æ‰€æœ‰æ›´æ–°éƒ½åœ¨ä¸€ä¸ª try_mutate ä¸­
    d.grave_id = new_grave;
    // æ›´æ–°ç´¢å¼•
    DeceasedByGrave::<T>::mutate(new_grave, |list| list.push(id));
    DeceasedByGrave::<T>::mutate(old_grave, |list| list.swap_remove(pos));
    // åŒæ­¥ Interments
    T::GraveProvider::record_exhumation(old_grave, deceased_id_u64)?;
    T::GraveProvider::record_interment(new_grave, deceased_id_u64, None, None)?;
    Ok(())
})?;
```

### 2.4 ç¼ºé™·å››ï¼šç¼ºå°‘æ“ä½œå‰ç½®æ¡ä»¶æ£€æŸ¥ âš ï¸âš ï¸

#### é—®é¢˜æè¿°

**æŸäº›æ“ä½œç¼ºå°‘å¿…è¦çš„å‰ç½®æ¡ä»¶æ£€æŸ¥**

**é—®é¢˜ç¤ºä¾‹1ï¼š`pallet-deceased/src/lib.rs` - `create_deceased`**

```rust
pub fn create_deceased(...) -> DispatchResult {
    let who = ensure_signed(origin)?;
    ensure!(T::GraveProvider::grave_exists(grave_id), Error::<T>::GraveNotFound);
    ensure!(T::GraveProvider::can_attach(&who, grave_id), Error::<T>::NotAuthorized);
    
    // âš ï¸ é—®é¢˜ï¼šæ²¡æœ‰æ£€æŸ¥å¢“ä½æ˜¯å¦å·²æ¿€æ´»
    // âš ï¸ é—®é¢˜ï¼šæ²¡æœ‰æ£€æŸ¥å¢“ä½å®¹é‡ï¼ˆè™½ç„¶ç”±BoundedVecç®¡ç†ï¼Œä½†åº”è¯¥æå‰æ£€æŸ¥ï¼‰
    
    // è®¡ç®—æŠ¼é‡‘
    let deposit_dust = governance::ExchangeRateHelper::<T>::convert_usdt_to_dust(deposit_usdt)?;
    
    // âš ï¸ é—®é¢˜ï¼šæ²¡æœ‰æ£€æŸ¥ç”¨æˆ·ä½™é¢æ˜¯å¦å……è¶³ï¼ˆè™½ç„¶holdä¼šå¤±è´¥ï¼Œä½†åº”è¯¥æå‰æ£€æŸ¥ï¼‰
    T::Fungible::hold(...)?;
}
```

**é—®é¢˜**ï¼š
- ç¼ºå°‘å¢“ä½çŠ¶æ€æ£€æŸ¥ï¼ˆæ˜¯å¦æ¿€æ´»ï¼‰
- ç¼ºå°‘ä½™é¢é¢„æ£€æŸ¥
- é”™è¯¯ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†

**é—®é¢˜ç¤ºä¾‹2ï¼š`pallet-memorial` - `offer_by_sacrifice`**

```rust
pub fn offer_by_sacrifice(...) -> DispatchResult {
    // âš ï¸ é—®é¢˜ï¼šæ²¡æœ‰æ£€æŸ¥ç›®æ ‡æ˜¯å¦å­˜åœ¨
    // âš ï¸ é—®é¢˜ï¼šæ²¡æœ‰æ£€æŸ¥ç›®æ ‡æ˜¯å¦å…è®¸ä¾›å¥‰
    // âš ï¸ é—®é¢˜ï¼šæ²¡æœ‰æ£€æŸ¥ç¥­ç¥€å“æ˜¯å¦å¯ç”¨
}
```

#### å½±å“ç¨‹åº¦ï¼šâ­â­â­ï¼ˆä¸­ç­‰ï¼‰

**å½±å“**ï¼š
- ç”¨æˆ·ä½“éªŒå·®ï¼ˆæ“ä½œå¤±è´¥æ—¶æ‰çŸ¥é“åŸå› ï¼‰
- å¯èƒ½æµªè´¹Gasè´¹ç”¨
- é”™è¯¯ä¿¡æ¯ä¸å¤Ÿå‹å¥½

#### è§£å†³æ–¹æ¡ˆ

**å®Œå–„å‰ç½®æ¡ä»¶æ£€æŸ¥**

```rust
pub fn create_deceased(...) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    // 1. æ£€æŸ¥å¢“ä½å­˜åœ¨
    ensure!(T::GraveProvider::grave_exists(grave_id), Error::<T>::GraveNotFound);
    
    // 2. æ£€æŸ¥å¢“ä½çŠ¶æ€
    ensure!(T::GraveProvider::is_active(grave_id), Error::<T>::GraveInactive);
    
    // 3. æ£€æŸ¥æƒé™
    ensure!(T::GraveProvider::can_attach(&who, grave_id), Error::<T>::NotAuthorized);
    
    // 4. æ£€æŸ¥å®¹é‡ï¼ˆæå‰æ£€æŸ¥ï¼Œé¿å…åç»­å¤±è´¥ï¼‰
    let current_count = T::GraveProvider::deceased_count(grave_id);
    ensure!(current_count < 6, Error::<T>::GraveFull);
    
    // 5. è®¡ç®—æŠ¼é‡‘å¹¶æ£€æŸ¥ä½™é¢
    let deposit_dust = governance::ExchangeRateHelper::<T>::convert_usdt_to_dust(deposit_usdt)?;
    ensure!(
        T::Fungible::balance(&who) >= deposit_dust,
        Error::<T>::InsufficientBalance
    );
    
    // 6. æ‰§è¡Œæ“ä½œ
    // ...
}
```

### 2.5 ç¼ºé™·äº”ï¼šæ“ä½œåçŠ¶æ€éªŒè¯ä¸è¶³ âš ï¸

#### é—®é¢˜æè¿°

**æŸäº›æ“ä½œæ‰§è¡Œåæ²¡æœ‰éªŒè¯æœ€ç»ˆçŠ¶æ€æ˜¯å¦æ­£ç¡®**

**é—®é¢˜ç¤ºä¾‹1ï¼š`pallet-deceased/src/lib.rs` - `update_deceased`**

```rust
pub fn update_deceased(...) -> DispatchResult {
    DeceasedOf::<T>::try_mutate(id, |d| -> DispatchResult {
        // æ›´æ–°å­—æ®µ
        if let Some(n) = name {
            d.name = BoundedVec::try_from(n)?;
        }
        // ...
        
        // âš ï¸ é—®é¢˜ï¼šæ›´æ–°åæ²¡æœ‰éªŒè¯æœ€ç»ˆçŠ¶æ€
        // ä¾‹å¦‚ï¼šname æ˜¯å¦ä¸ºç©ºï¼Ÿtoken æ˜¯å¦å”¯ä¸€ï¼Ÿ
        
        Ok(())
    })?;
}
```

**é—®é¢˜**ï¼š
- æ“ä½œåæ²¡æœ‰éªŒè¯æœ€ç»ˆçŠ¶æ€
- å¯èƒ½äº§ç”Ÿæ— æ•ˆæ•°æ®

#### å½±å“ç¨‹åº¦ï¼šâ­â­ï¼ˆè¾ƒä½ï¼‰

**å½±å“**ï¼š
- å¯èƒ½äº§ç”Ÿæ— æ•ˆæ•°æ®
- å¯èƒ½å½±å“åç»­æ“ä½œ

#### è§£å†³æ–¹æ¡ˆ

**æ“ä½œåçŠ¶æ€éªŒè¯**

```rust
pub fn update_deceased(...) -> DispatchResult {
    DeceasedOf::<T>::try_mutate(id, |d| -> DispatchResult {
        // æ›´æ–°å­—æ®µ
        // ...
        
        // éªŒè¯æœ€ç»ˆçŠ¶æ€
        ensure!(!d.name.is_empty(), Error::<T>::InvalidName);
        ensure!(
            DeceasedIdByToken::<T>::get(&d.deceased_token).map_or(true, |existing_id| existing_id == id),
            Error::<T>::DeceasedTokenExists
        );
        
        Ok(())
    })?;
}
```

### 2.6 ç¼ºé™·å…­ï¼šé”™è¯¯å¤„ç†ä¸å®Œå–„ âš ï¸âš ï¸

#### é—®é¢˜æè¿°

**æŸäº›æ“ä½œçš„é”™è¯¯å¤„ç†ä¸å¤Ÿå®Œå–„ï¼Œé”™è¯¯ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†**

**é—®é¢˜ç¤ºä¾‹1ï¼š`pallet-deceased/src/lib.rs` - æŠ¼é‡‘é”å®šå¤±è´¥**

```rust
// é”å®šæŠ¼é‡‘
T::Fungible::hold(
    &T::RuntimeHoldReason::from(crate::HoldReason::DeceasedOwnerDeposit),
    &who,
    deposit_dust,
)?;  // âš ï¸ é—®é¢˜ï¼šå¦‚æœå¤±è´¥ï¼Œåªè¿”å›é€šç”¨é”™è¯¯ï¼Œä¸çŸ¥é“å…·ä½“åŸå› 
```

**é—®é¢˜**ï¼š
- é”™è¯¯ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†
- ç”¨æˆ·ä¸çŸ¥é“å¤±è´¥çš„å…·ä½“åŸå› ï¼ˆä½™é¢ä¸è¶³ï¼Ÿæƒé™ä¸è¶³ï¼Ÿï¼‰

**é—®é¢˜ç¤ºä¾‹2ï¼š`pallet-memorial` - åˆ†è´¦å¤±è´¥**

```rust
// åˆ†è´¦æ“ä½œ
T::Currency::transfer(&who, &platform_account, platform_share, ...)?;
T::Currency::transfer(&platform_account, &target_account, target_share, ...)?;
// âš ï¸ é—®é¢˜ï¼šå¦‚æœç¬¬äºŒä¸ªè½¬è´¦å¤±è´¥ï¼Œç¬¬ä¸€ä¸ªå·²ç»å®Œæˆï¼Œæ²¡æœ‰å›æ»š
```

**é—®é¢˜**ï¼š
- éƒ¨åˆ†æ“ä½œå¤±è´¥æ—¶æ²¡æœ‰å›æ»š
- å¯èƒ½å¯¼è‡´èµ„é‡‘ä¸ä¸€è‡´

#### å½±å“ç¨‹åº¦ï¼šâ­â­â­ï¼ˆä¸­ç­‰ï¼‰

**å½±å“**ï¼š
- ç”¨æˆ·ä½“éªŒå·®
- å¯èƒ½äº§ç”Ÿä¸ä¸€è‡´çŠ¶æ€
- éš¾ä»¥æ’æŸ¥é—®é¢˜

#### è§£å†³æ–¹æ¡ˆ

**å®Œå–„é”™è¯¯å¤„ç†å’Œå›æ»šæœºåˆ¶**

```rust
// æ–¹æ¡ˆ1ï¼šè¯¦ç»†é”™è¯¯ä¿¡æ¯
match T::Fungible::hold(...) {
    Ok(_) => {},
    Err(e) => {
        // æ£€æŸ¥å…·ä½“åŸå› 
        if T::Fungible::balance(&who) < deposit_dust {
            return Err(Error::<T>::InsufficientBalance.into());
        }
        // å…¶ä»–åŸå› 
        return Err(Error::<T>::DepositLockFailed.into());
    }
}

// æ–¹æ¡ˆ2ï¼šäº‹åŠ¡æ€§æ“ä½œ
let result = (|| -> DispatchResult {
    T::Currency::transfer(&who, &platform_account, platform_share, ...)?;
    T::Currency::transfer(&platform_account, &target_account, target_share, ...)?;
    T::Affiliate::distribute(...)?;
    Ok(())
})();

if result.is_err() {
    // å›æ»šå·²å®Œæˆçš„è½¬è´¦
    // ...
}
```

---

## 3. æƒé™æ£€æŸ¥é—®é¢˜

### 3.1 é—®é¢˜ä¸€ï¼šæƒé™æ£€æŸ¥æ–¹å¼ä¸ç»Ÿä¸€

#### å½“å‰å®ç°

**æ–¹å¼1ï¼šç›´æ¥æ¯”è¾ƒ**
```rust
ensure!(d.owner == who, Error::<T>::NotAuthorized);
```

**æ–¹å¼2ï¼šä½¿ç”¨è¾…åŠ©å‡½æ•°**
```rust
ensure!(Self::is_owner(id, &who), Error::<T>::NotAuthorized);
```

**æ–¹å¼3ï¼šä½¿ç”¨trait**
```rust
ensure!(T::GraveProvider::can_attach(&who, grave_id), Error::<T>::NotAuthorized);
```

#### é—®é¢˜

- æƒé™æ£€æŸ¥æ–¹å¼ä¸ç»Ÿä¸€
- é”™è¯¯ç±»å‹ä¸ä¸€è‡´
- å®¹æ˜“é—æ¼æƒé™æ£€æŸ¥

#### è§£å†³æ–¹æ¡ˆ

**ç»Ÿä¸€æƒé™æ£€æŸ¥æœºåˆ¶**

```rust
// ç»Ÿä¸€çš„æƒé™æ£€æŸ¥trait
pub trait PermissionChecker<T: Config> {
    fn can_update_deceased(who: &T::AccountId, id: DeceasedId) -> bool;
    fn can_delete_deceased(who: &T::AccountId, id: DeceasedId) -> bool;
    fn can_transfer_deceased(who: &T::AccountId, id: DeceasedId) -> bool;
    fn can_transfer_owner(who: &T::AccountId, id: DeceasedId) -> bool;
}

// ç»Ÿä¸€ä½¿ç”¨
ensure!(
    Self::can_update_deceased(&who, id),
    Error::<T>::NotAuthorized
);
```

### 3.2 é—®é¢˜äºŒï¼šæƒé™æ£€æŸ¥é€»è¾‘å¤æ‚

#### å½“å‰å®ç°

**`pallet-stardust-grave/src/lib.rs` - `add_admin`**

```rust
pub fn add_admin(origin: OriginFor<T>, id: u64, who: T::AccountId) -> DispatchResult {
    if let Some(g) = Graves::<T>::get(id) {
        let o = origin.clone();
        if let Ok(sender) = ensure_signed(o) {
            if sender != g.owner {
                if let Some(pid) = g.park_id {
                    T::ParkAdmin::ensure(pid, origin)?;
                } else {
                    return Err(Error::<T>::NotAdmin.into());
                }
            }
        }
    } else {
        return Err(Error::<T>::NotFound.into());
    }
    // ...
}
```

#### é—®é¢˜

- æƒé™æ£€æŸ¥é€»è¾‘å¤æ‚ï¼ŒåµŒå¥—å¤šå±‚ `if`
- å¦‚æœ `ensure_signed` å¤±è´¥ï¼Œæ²¡æœ‰æ˜ç¡®å¤„ç†
- é€»è¾‘é¡ºåºä¸åˆç†ï¼ˆå…ˆæ£€æŸ¥æƒé™ï¼Œå†æ£€æŸ¥å­˜åœ¨æ€§ï¼‰

#### è§£å†³æ–¹æ¡ˆ

**ç®€åŒ–æƒé™æ£€æŸ¥é€»è¾‘**

```rust
pub fn add_admin(origin: OriginFor<T>, id: u64, who: T::AccountId) -> DispatchResult {
    let sender = ensure_signed(origin)?;
    let g = Graves::<T>::get(id).ok_or(Error::<T>::NotFound)?;
    
    // ç»Ÿä¸€æƒé™æ£€æŸ¥
    ensure!(
        sender == g.owner || g.park_id.map_or(false, |pid| {
            T::ParkAdmin::ensure(pid, origin).is_ok()
        }),
        Error::<T>::NotAdmin
    );
    
    // æ‰§è¡Œæ“ä½œ
    // ...
}
```

### 3.3 é—®é¢˜ä¸‰ï¼šæƒé™æ£€æŸ¥å¯èƒ½è¢«ç»•è¿‡

#### é—®é¢˜æè¿°

**æŸäº›æ“ä½œå¯èƒ½é€šè¿‡ç‰¹æ®Šè·¯å¾„ç»•è¿‡æƒé™æ£€æŸ¥**

**é—®é¢˜ç¤ºä¾‹ï¼š`pallet-deceased/src/lib.rs` - `transfer_deceased`**

```rust
pub fn transfer_deceased(...) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    // æ£€æŸ¥ç›®æ ‡å¢“ä½å­˜åœ¨
    ensure!(T::GraveProvider::grave_exists(new_grave), Error::<T>::GraveNotFound);
    
    // å‡†å…¥ç­–ç•¥æ£€æŸ¥
    T::GraveProvider::check_admission_policy(&who, new_grave)?;
    
    // âš ï¸ é—®é¢˜ï¼šå¦‚æœå‡†å…¥ç­–ç•¥æ˜¯ Publicï¼Œä»»ä½•äººéƒ½å¯ä»¥è¿ç§»
    // ä½†è¿™é‡Œåªæ£€æŸ¥äº†å‡†å…¥ç­–ç•¥ï¼Œæ²¡æœ‰æ£€æŸ¥é€è€…owneræƒé™
    
    DeceasedOf::<T>::try_mutate(id, |d| -> DispatchResult {
        ensure!(d.owner == who, Error::<T>::NotDeceasedOwner);
        // ...
    })
}
```

**é—®é¢˜**ï¼š
- è™½ç„¶æœ€ç»ˆæ£€æŸ¥äº†owneræƒé™ï¼Œä½†å‡†å…¥ç­–ç•¥æ£€æŸ¥åœ¨å‰
- å¦‚æœå‡†å…¥ç­–ç•¥æ£€æŸ¥å¤±è´¥ï¼Œç”¨æˆ·å¯èƒ½ä¸çŸ¥é“å…·ä½“åŸå› 

#### è§£å†³æ–¹æ¡ˆ

**ä¼˜åŒ–æƒé™æ£€æŸ¥é¡ºåº**

```rust
pub fn transfer_deceased(...) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    // 1. å…ˆæ£€æŸ¥é€è€…owneræƒé™ï¼ˆæœ€ä¸¥æ ¼çš„æ£€æŸ¥ï¼‰
    let deceased = DeceasedOf::<T>::get(id).ok_or(Error::<T>::DeceasedNotFound)?;
    ensure!(deceased.owner == who, Error::<T>::NotDeceasedOwner);
    
    // 2. æ£€æŸ¥ç›®æ ‡å¢“ä½å­˜åœ¨
    ensure!(T::GraveProvider::grave_exists(new_grave), Error::<T>::GraveNotFound);
    
    // 3. æ£€æŸ¥å‡†å…¥ç­–ç•¥
    T::GraveProvider::check_admission_policy(&who, new_grave)?;
    
    // 4. æ‰§è¡Œè¿ç§»
    // ...
}
```

---

## 4. çŠ¶æ€è½¬æ¢é—®é¢˜

### 4.1 é—®é¢˜ä¸€ï¼šçŠ¶æ€è½¬æ¢ç¼ºå°‘éªŒè¯

#### é—®é¢˜æè¿°

**è®¢å•/ä¾›å¥‰çŠ¶æ€è½¬æ¢ç¼ºå°‘å‰ç½®æ¡ä»¶æ£€æŸ¥**

**é—®é¢˜ç¤ºä¾‹ï¼š`pallet-otc-order` - è®¢å•çŠ¶æ€è½¬æ¢**

```rust
pub fn mark_paid(origin: OriginFor<T>, order_id: u64) -> DispatchResult {
    Orders::<T>::try_mutate(order_id, |order| -> DispatchResult {
        let o = order.as_mut().ok_or(Error::<T>::OrderNotFound)?;
        // âš ï¸ é—®é¢˜ï¼šæ²¡æœ‰æ£€æŸ¥å½“å‰çŠ¶æ€
        o.state = OrderState::PaidOrCommitted;
        Ok(())
    })
}
```

#### è§£å†³æ–¹æ¡ˆ

**çŠ¶æ€æœºéªŒè¯**

```rust
// å®šä¹‰åˆæ³•çš„çŠ¶æ€è½¬æ¢
fn validate_state_transition(
    from: OrderState,
    to: OrderState,
) -> Result<(), Error<T>> {
    match (from, to) {
        (OrderState::Created, OrderState::PaidOrCommitted) => Ok(()),
        (OrderState::PaidOrCommitted, OrderState::Released) => Ok(()),
        (OrderState::Created, OrderState::Canceled) => Ok(()),
        (OrderState::Created, OrderState::Expired) => Ok(()),
        _ => Err(Error::<T>::InvalidStateTransition),
    }
}

pub fn mark_paid(origin: OriginFor<T>, order_id: u64) -> DispatchResult {
    Orders::<T>::try_mutate(order_id, |order| -> DispatchResult {
        let o = order.as_mut().ok_or(Error::<T>::OrderNotFound)?;
        
        // éªŒè¯çŠ¶æ€è½¬æ¢
        validate_state_transition(o.state, OrderState::PaidOrCommitted)?;
        
        o.state = OrderState::PaidOrCommitted;
        Ok(())
    })
}
```

### 4.2 é—®é¢˜äºŒï¼šçŠ¶æ€è½¬æ¢å¯èƒ½äº§ç”Ÿç«æ€

#### é—®é¢˜æè¿°

**å¹¶å‘æ“ä½œå¯èƒ½å¯¼è‡´çŠ¶æ€è½¬æ¢ç«æ€**

**é—®é¢˜ç¤ºä¾‹ï¼š`pallet-memorial` - è‡ªåŠ¨ç»­è´¹**

```rust
// å¤šä¸ªå—å¯èƒ½åŒæ—¶å¤„ç†åŒä¸€ä¸ªè®¢å•
if Self::try_auto_renew(offering_id, &mut record).is_ok() {
    record.status = OfferingStatus::Active;
    // âš ï¸ é—®é¢˜ï¼šå¦‚æœå¤šä¸ªå—åŒæ—¶å¤„ç†ï¼Œå¯èƒ½äº§ç”Ÿç«æ€
}
```

#### è§£å†³æ–¹æ¡ˆ

**ä½¿ç”¨åŸå­æ“ä½œæˆ–é”æœºåˆ¶**

```rust
// ä½¿ç”¨ try_mutate ç¡®ä¿åŸå­æ€§
OfferingRecords::<T>::try_mutate(offering_id, |record| -> DispatchResult {
    let r = record.as_mut().ok_or(Error::<T>::OfferingNotFound)?;
    
    // æ£€æŸ¥çŠ¶æ€ï¼ˆé˜²æ­¢å¹¶å‘ä¿®æ”¹ï¼‰
    ensure!(r.status == OfferingStatus::Suspended, Error::<T>::InvalidStatus);
    
    // å°è¯•ç»­è´¹
    if Self::try_auto_renew_internal(offering_id, r).is_ok() {
        r.status = OfferingStatus::Active;
    }
    
    Ok(())
})?;
```

---

## 5. æ“ä½œæµç¨‹é—®é¢˜

### 5.1 é—®é¢˜ä¸€ï¼šæ“ä½œæ­¥éª¤é¡ºåºä¸åˆç†

#### é—®é¢˜æè¿°

**æŸäº›æ“ä½œçš„æ­¥éª¤é¡ºåºä¸åˆç†ï¼Œå¯èƒ½å¯¼è‡´ä¸å¿…è¦çš„å¤±è´¥**

**é—®é¢˜ç¤ºä¾‹ï¼š`pallet-deceased/src/lib.rs` - `create_deceased`**

```rust
pub fn create_deceased(...) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    // 1. æ£€æŸ¥å¢“ä½å­˜åœ¨
    ensure!(T::GraveProvider::grave_exists(grave_id), Error::<T>::GraveNotFound);
    
    // 2. æ£€æŸ¥æƒé™
    ensure!(T::GraveProvider::can_attach(&who, grave_id), Error::<T>::NotAuthorized);
    
    // 3. éªŒè¯å­—æ®µï¼ˆå¯èƒ½è€—æ—¶ï¼‰
    // ...
    
    // 4. è®¡ç®—æŠ¼é‡‘ï¼ˆå¯èƒ½å¤±è´¥ï¼‰
    let deposit_dust = governance::ExchangeRateHelper::<T>::convert_usdt_to_dust(deposit_usdt)?;
    
    // 5. é”å®šæŠ¼é‡‘ï¼ˆå¯èƒ½å¤±è´¥ï¼‰
    T::Fungible::hold(...)?;
    
    // 6. åˆ›å»ºè®°å½•
    // ...
}
```

#### é—®é¢˜

- å¦‚æœæ­¥éª¤4æˆ–5å¤±è´¥ï¼Œå‰é¢çš„éªŒè¯éƒ½ç™½åšäº†
- ç”¨æˆ·æµªè´¹äº†Gasè´¹ç”¨
- åº”è¯¥å…ˆæ£€æŸ¥å¯èƒ½å¤±è´¥çš„æ“ä½œï¼ˆå¦‚ä½™é¢ã€æ±‡ç‡ï¼‰

#### è§£å†³æ–¹æ¡ˆ

**ä¼˜åŒ–æ“ä½œé¡ºåº**

```rust
pub fn create_deceased(...) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    // 1. å¿«é€Ÿæ£€æŸ¥ï¼šå¢“ä½å­˜åœ¨
    ensure!(T::GraveProvider::grave_exists(grave_id), Error::<T>::GraveNotFound);
    
    // 2. å¿«é€Ÿæ£€æŸ¥ï¼šæƒé™
    ensure!(T::GraveProvider::can_attach(&who, grave_id), Error::<T>::NotAuthorized);
    
    // 3. æå‰æ£€æŸ¥ï¼šè®¡ç®—æŠ¼é‡‘å¹¶æ£€æŸ¥ä½™é¢ï¼ˆå¯èƒ½å¤±è´¥çš„æ“ä½œæå‰æ£€æŸ¥ï¼‰
    let deposit_dust = governance::ExchangeRateHelper::<T>::convert_usdt_to_dust(deposit_usdt)?;
    ensure!(
        T::Fungible::balance(&who) >= deposit_dust,
        Error::<T>::InsufficientBalance
    );
    
    // 4. éªŒè¯å­—æ®µï¼ˆç›¸å¯¹å¿«é€Ÿï¼‰
    // ...
    
    // 5. é”å®šæŠ¼é‡‘ï¼ˆæ­¤æ—¶åº”è¯¥æˆåŠŸï¼‰
    T::Fungible::hold(...)?;
    
    // 6. åˆ›å»ºè®°å½•
    // ...
}
```

### 5.2 é—®é¢˜äºŒï¼šæ“ä½œç¼ºå°‘å›æ»šæœºåˆ¶

#### é—®é¢˜æè¿°

**æŸäº›æ“ä½œæ¶‰åŠå¤šä¸ªæ­¥éª¤ï¼Œå¦‚æœä¸­é—´å¤±è´¥ï¼Œæ²¡æœ‰å›æ»šæœºåˆ¶**

**é—®é¢˜ç¤ºä¾‹ï¼š`pallet-memorial` - ä¾›å¥‰åˆ†è´¦**

```rust
// 1. æ‰£é™¤ç”¨æˆ·ä½™é¢
T::Currency::transfer(&who, &platform_account, platform_share, ...)?;

// 2. åˆ†é…ç»™ç›®æ ‡è´¦æˆ·
T::Currency::transfer(&platform_account, &target_account, target_share, ...)?;

// 3. åˆ†é…ç»™æ¨èäºº
T::Affiliate::distribute(...)?;

// âš ï¸ é—®é¢˜ï¼šå¦‚æœæ­¥éª¤2æˆ–3å¤±è´¥ï¼Œæ­¥éª¤1å·²ç»å®Œæˆï¼Œæ²¡æœ‰å›æ»š
```

#### è§£å†³æ–¹æ¡ˆ

**ä½¿ç”¨äº‹åŠ¡æˆ–æ‰¹é‡æ“ä½œ**

```rust
// æ–¹æ¡ˆ1ï¼šä½¿ç”¨ escrow æ‰˜ç®¡
let escrow_id = generate_escrow_id();
T::Escrow::lock(escrow_id, &who, total_amount)?;

// æ‰§è¡Œæ‰€æœ‰åˆ†è´¦
T::Currency::transfer(&escrow_account, &target_account, target_share, ...)?;
T::Affiliate::distribute(...)?;

// å¦‚æœéƒ½æˆåŠŸï¼Œé‡Šæ”¾æ‰˜ç®¡
T::Escrow::release(escrow_id)?;

// æ–¹æ¡ˆ2ï¼šå…ˆæ”¶é›†æ‰€æœ‰æ“ä½œï¼Œæœ€åç»Ÿä¸€æ‰§è¡Œ
let mut operations = Vec::new();
operations.push(Transfer { from: who, to: target_account, amount: target_share });
operations.push(Distribute { ... });

// ç»Ÿä¸€æ‰§è¡Œï¼ˆå¦‚æœä»»ä½•æ“ä½œå¤±è´¥ï¼Œå…¨éƒ¨å›æ»šï¼‰
execute_batch_transfers(operations)?;
```

---

## 6. è¾¹ç•Œæƒ…å†µå¤„ç†

### 6.1 é—®é¢˜ä¸€ï¼šå®¹é‡æ£€æŸ¥ä¸å®Œå–„

#### é—®é¢˜æè¿°

**æŸäº›æ“ä½œæ²¡æœ‰æå‰æ£€æŸ¥å®¹é‡ï¼Œä¾èµ–BoundedVecè‡ªåŠ¨é™åˆ¶**

**é—®é¢˜ç¤ºä¾‹ï¼š`pallet-deceased/src/lib.rs` - `create_deceased`**

```rust
// åˆ é™¤å†—ä½™æ£€æŸ¥ï¼šå®¹é‡ä¸Šé™ç”± BoundedVec::try_push è‡ªåŠ¨ç®¡ç†ï¼ˆç¡¬ä¸Šé™6ï¼‰
// ä¸å†éœ€è¦æ‰‹åŠ¨æ£€æŸ¥è½¯ä¸Šé™å’Œç¼“å­˜æ ¡éªŒ

DeceasedByGrave::<T>::mutate(grave_id, |maybe_list| {
    if let Some(list) = maybe_list {
        list.push(id);  // âš ï¸ å¦‚æœå®¹é‡å·²æ»¡ï¼Œè¿™é‡Œä¼španicæˆ–è¿”å›é”™è¯¯
    } else {
        *maybe_list = Some(vec![id]);
    }
});
```

#### é—®é¢˜

- ä¾èµ–BoundedVecè‡ªåŠ¨é™åˆ¶ï¼Œä½†é”™è¯¯ä¿¡æ¯ä¸å¤Ÿå‹å¥½
- ç”¨æˆ·ä¸çŸ¥é“å®¹é‡é™åˆ¶ï¼Œæ“ä½œå¤±è´¥æ—¶æ‰çŸ¥é“åŸå› 
- åº”è¯¥æå‰æ£€æŸ¥å¹¶ç»™å‡ºæ˜ç¡®é”™è¯¯ä¿¡æ¯

#### è§£å†³æ–¹æ¡ˆ

**æå‰æ£€æŸ¥å®¹é‡**

```rust
// æå‰æ£€æŸ¥å®¹é‡
let current_count = DeceasedByGrave::<T>::get(grave_id)
    .map(|list| list.len())
    .unwrap_or(0);
ensure!(current_count < 6, Error::<T>::GraveFull);

// ç„¶åå†æ‰§è¡Œæ“ä½œ
DeceasedByGrave::<T>::mutate(grave_id, |maybe_list| {
    if let Some(list) = maybe_list {
        list.push(id);
    } else {
        *maybe_list = Some(vec![id]);
    }
});
```

### 6.2 é—®é¢˜äºŒï¼šå¹¶å‘æ“ä½œå¤„ç†ä¸è¶³

#### é—®é¢˜æè¿°

**æŸäº›æ“ä½œå¯èƒ½è¢«å¹¶å‘è°ƒç”¨ï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´**

**é—®é¢˜ç¤ºä¾‹ï¼š`pallet-stardust-grave` - `add_admin`**

```rust
pub fn add_admin(origin: OriginFor<T>, id: u64, who: T::AccountId) -> DispatchResult {
    // æ£€æŸ¥æƒé™
    // ...
    
    GraveAdmins::<T>::try_mutate(id, |list| -> Result<(), Error<T>> {
        if !list.iter().any(|x| x == &who) {
            list.try_push(who.clone())  // âš ï¸ å¦‚æœå¹¶å‘è°ƒç”¨ï¼Œå¯èƒ½åŒæ—¶æ·»åŠ 
                .map_err(|_| Error::<T>::CapacityExceeded)?;
        }
        Ok(())
    })?;
}
```

#### é—®é¢˜

- è™½ç„¶ä½¿ç”¨äº† `try_mutate`ï¼Œä½†æ£€æŸ¥"æ˜¯å¦å·²å­˜åœ¨"å’Œ"æ·»åŠ "ä¹‹é—´å¯èƒ½æœ‰ç«æ€
- å¦‚æœä¸¤ä¸ªç”¨æˆ·åŒæ—¶æ·»åŠ åŒä¸€ä¸ªç®¡ç†å‘˜ï¼Œå¯èƒ½éƒ½æˆåŠŸ

#### è§£å†³æ–¹æ¡ˆ

**ä½¿ç”¨åŸå­æ“ä½œ**

```rust
pub fn add_admin(origin: OriginFor<T>, id: u64, who: T::AccountId) -> DispatchResult {
    // æ£€æŸ¥æƒé™
    // ...
    
    GraveAdmins::<T>::try_mutate(id, |list| -> Result<(), Error<T>> {
        // åŸå­æ“ä½œï¼šæ£€æŸ¥å¹¶æ·»åŠ 
        if list.iter().any(|x| x == &who) {
            return Err(Error::<T>::AlreadyAdmin);
        }
        list.try_push(who.clone())
            .map_err(|_| Error::<T>::CapacityExceeded)?;
        Ok(())
    })?;
}
```

---

## 7. ç”¨æˆ·ä½“éªŒé—®é¢˜

### 7.1 é—®é¢˜ä¸€ï¼šé”™è¯¯ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†

#### é—®é¢˜æè¿°

**æŸäº›æ“ä½œçš„é”™è¯¯ä¿¡æ¯ä¸å¤Ÿè¯¦ç»†ï¼Œç”¨æˆ·ä¸çŸ¥é“å¤±è´¥åŸå› **

**é—®é¢˜ç¤ºä¾‹ï¼š`pallet-deceased/src/lib.rs` - æŠ¼é‡‘é”å®šå¤±è´¥**

```rust
T::Fungible::hold(...)?;  // å¦‚æœå¤±è´¥ï¼Œåªè¿”å›é€šç”¨é”™è¯¯
```

#### è§£å†³æ–¹æ¡ˆ

**è¯¦ç»†é”™è¯¯ä¿¡æ¯**

```rust
match T::Fungible::hold(...) {
    Ok(_) => {},
    Err(e) => {
        // æ£€æŸ¥å…·ä½“åŸå› 
        if T::Fungible::balance(&who) < deposit_dust {
            return Err(Error::<T>::InsufficientBalance.into());
        }
        if T::Fungible::reducible_balance(&who, ...) < deposit_dust {
            return Err(Error::<T>::BalanceLocked.into());
        }
        return Err(Error::<T>::DepositLockFailed.into());
    }
}
```

### 7.2 é—®é¢˜äºŒï¼šæ“ä½œç¼ºå°‘å‰ç½®éªŒè¯

#### é—®é¢˜æè¿°

**æŸäº›æ“ä½œç¼ºå°‘å‰ç½®éªŒè¯ï¼Œç”¨æˆ·æ“ä½œå¤±è´¥æ—¶æ‰çŸ¥é“åŸå› **

**é—®é¢˜ç¤ºä¾‹ï¼š`pallet-memorial` - `offer_by_sacrifice`**

```rust
pub fn offer_by_sacrifice(...) -> DispatchResult {
    // âš ï¸ é—®é¢˜ï¼šæ²¡æœ‰æå‰æ£€æŸ¥
    // - ç›®æ ‡æ˜¯å¦å­˜åœ¨
    // - ç›®æ ‡æ˜¯å¦å…è®¸ä¾›å¥‰
    // - ç¥­ç¥€å“æ˜¯å¦å¯ç”¨
    // - ç”¨æˆ·ä½™é¢æ˜¯å¦å……è¶³
    
    // ç›´æ¥æ‰§è¡Œæ“ä½œï¼Œå¯èƒ½å¤±è´¥
}
```

#### è§£å†³æ–¹æ¡ˆ

**å®Œå–„å‰ç½®éªŒè¯**

```rust
pub fn offer_by_sacrifice(...) -> DispatchResult {
    // 1. æ£€æŸ¥ç›®æ ‡å­˜åœ¨
    ensure!(T::TargetControl::target_exists(domain, target_id), Error::<T>::TargetNotFound);
    
    // 2. æ£€æŸ¥ç›®æ ‡æ˜¯å¦å…è®¸ä¾›å¥‰
    ensure!(T::TargetControl::can_offer(domain, target_id), Error::<T>::OfferingNotAllowed);
    
    // 3. æ£€æŸ¥ç¥­ç¥€å“å¯ç”¨
    let sacrifice = SacrificeOf::<T>::get(sacrifice_id).ok_or(Error::<T>::SacrificeNotFound)?;
    ensure!(sacrifice.status == SacrificeStatus::Enabled, Error::<T>::SacrificeNotEnabled);
    
    // 4. è®¡ç®—è´¹ç”¨å¹¶æ£€æŸ¥ä½™é¢
    let total_cost = calculate_total_cost(...)?;
    ensure!(T::Currency::free_balance(&who) >= total_cost, Error::<T>::InsufficientBalance);
    
    // 5. æ‰§è¡Œæ“ä½œ
    // ...
}
```

---

## 8. ä¼˜åŒ–å»ºè®®

### 8.1 çŸ­æœŸä¼˜åŒ–ï¼ˆ1-3ä¸ªæœˆï¼‰

#### ä¼˜å…ˆçº§1ï¼šç»Ÿä¸€æƒé™æ£€æŸ¥æœºåˆ¶ âš ï¸âš ï¸

**ä»»åŠ¡**ï¼š
1. åˆ›å»ºç»Ÿä¸€çš„æƒé™æ£€æŸ¥trait
2. ç»Ÿä¸€æ‰€æœ‰æ“ä½œçš„æƒé™æ£€æŸ¥æ–¹å¼
3. ç»Ÿä¸€é”™è¯¯ç±»å‹

**é¢„è®¡æ—¶é—´**ï¼š2-3å‘¨

#### ä¼˜å…ˆçº§2ï¼šå®Œå–„çŠ¶æ€è½¬æ¢éªŒè¯ âš ï¸âš ï¸

**ä»»åŠ¡**ï¼š
1. å®šä¹‰çŠ¶æ€æœº
2. æ·»åŠ çŠ¶æ€è½¬æ¢éªŒè¯
3. é˜²æ­¢éæ³•çŠ¶æ€è½¬æ¢

**é¢„è®¡æ—¶é—´**ï¼š2-3å‘¨

#### ä¼˜å…ˆçº§3ï¼šä¼˜åŒ–æ“ä½œåŸå­æ€§ âš ï¸âš ï¸âš ï¸

**ä»»åŠ¡**ï¼š
1. ä½¿ç”¨try_mutateç¡®ä¿åŸå­æ€§
2. æ·»åŠ å›æ»šæœºåˆ¶
3. ä½¿ç”¨escrowæ‰˜ç®¡èµ„é‡‘

**é¢„è®¡æ—¶é—´**ï¼š3-4å‘¨

### 8.2 ä¸­æœŸä¼˜åŒ–ï¼ˆ3-6ä¸ªæœˆï¼‰

#### ä¼˜å…ˆçº§1ï¼šå®Œå–„å‰ç½®æ¡ä»¶æ£€æŸ¥ âš ï¸

**ä»»åŠ¡**ï¼š
1. æ·»åŠ æ‰€æœ‰å¿…è¦çš„å‰ç½®æ¡ä»¶æ£€æŸ¥
2. ä¼˜åŒ–æ“ä½œé¡ºåº
3. æå‰æ£€æŸ¥å¯èƒ½å¤±è´¥çš„æ“ä½œ

**é¢„è®¡æ—¶é—´**ï¼š2-3å‘¨

#### ä¼˜å…ˆçº§2ï¼šå®Œå–„é”™è¯¯å¤„ç† âš ï¸

**ä»»åŠ¡**ï¼š
1. è¯¦ç»†é”™è¯¯ä¿¡æ¯
2. é”™è¯¯åˆ†ç±»
3. é”™è¯¯ç æ˜ å°„

**é¢„è®¡æ—¶é—´**ï¼š2-3å‘¨

#### ä¼˜å…ˆçº§3ï¼šä¼˜åŒ–ç”¨æˆ·ä½“éªŒ âš ï¸

**ä»»åŠ¡**ï¼š
1. å®Œå–„å‰ç½®éªŒè¯
2. ä¼˜åŒ–é”™è¯¯æç¤º
3. æ·»åŠ æ“ä½œé¢„è§ˆ

**é¢„è®¡æ—¶é—´**ï¼š2-3å‘¨

---

## 9. æ€»ç»“

### 9.1 æ ¸å¿ƒç¼ºé™·

1. **æƒé™æ£€æŸ¥ä¸ä¸€è‡´**ï¼šâ­â­â­â­ï¼ˆè¾ƒé«˜ï¼‰
2. **çŠ¶æ€è½¬æ¢ç¼ºå°‘éªŒè¯**ï¼šâ­â­â­â­ï¼ˆè¾ƒé«˜ï¼‰
3. **æ“ä½œåŸå­æ€§ä¸è¶³**ï¼šâ­â­â­â­â­ï¼ˆä¸¥é‡ï¼‰
4. **ç¼ºå°‘å‰ç½®æ¡ä»¶æ£€æŸ¥**ï¼šâ­â­â­ï¼ˆä¸­ç­‰ï¼‰
5. **é”™è¯¯å¤„ç†ä¸å®Œå–„**ï¼šâ­â­â­ï¼ˆä¸­ç­‰ï¼‰

### 9.2 ä¼˜åŒ–å»ºè®®

1. **çŸ­æœŸ**ï¼šç»Ÿä¸€æƒé™æ£€æŸ¥ã€å®Œå–„çŠ¶æ€è½¬æ¢éªŒè¯ã€ä¼˜åŒ–æ“ä½œåŸå­æ€§
2. **ä¸­æœŸ**ï¼šå®Œå–„å‰ç½®æ¡ä»¶æ£€æŸ¥ã€å®Œå–„é”™è¯¯å¤„ç†ã€ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

### 9.3 é£é™©è¯„ä¼°

- **é«˜é£é™©**ï¼šæ“ä½œåŸå­æ€§ä¸è¶³ã€æƒé™æ£€æŸ¥ä¸ä¸€è‡´
- **ä¸­é£é™©**ï¼šçŠ¶æ€è½¬æ¢ç¼ºå°‘éªŒè¯ã€ç¼ºå°‘å‰ç½®æ¡ä»¶æ£€æŸ¥
- **ä½é£é™©**ï¼šé”™è¯¯å¤„ç†ä¸å®Œå–„ã€ç”¨æˆ·ä½“éªŒé—®é¢˜

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0.0  
**æœ€åæ›´æ–°**ï¼š2025-01-XX  
**ç»´æŠ¤è€…**ï¼šStardust å¼€å‘å›¢é˜Ÿ

