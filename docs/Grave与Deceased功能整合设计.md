# Grave ä¸ Deceased åŠŸèƒ½æ•´åˆè®¾è®¡æ–¹æ¡ˆ

> **ç‰ˆæœ¬**: v1.0
> **æ—¥æœŸ**: 2025-11-09
> **ç›®æ ‡**: æ˜ç¡® `pallet-stardust-grave` ä¸ `pallet-deceased` çš„èŒè´£è¾¹ç•Œï¼Œé¿å…åŠŸèƒ½é‡å ï¼Œç¡®ä¿ç³»ç»Ÿæ¶æ„æ¸…æ™°

---

## ä¸€ã€æ ¸å¿ƒæ¦‚å¿µå¯¹æ¯”

### 1.1 è®¾è®¡å®šä½

| ç»´åº¦ | **pallet-stardust-grave** | **pallet-deceased** |
|------|------------------------|---------------------|
| **æ ¸å¿ƒæ¦‚å¿µ** | å¢“ä½ï¼ˆç‰©ç†ç©ºé—´å®¹å™¨ï¼‰ | é€è€…ï¼ˆäººçš„æ•°å­—æ¡£æ¡ˆï¼‰ |
| **ä¸šåŠ¡ç±»æ¯”** | æˆ¿äº§/åœ°äº§ | å±…æ°‘æ¡£æ¡ˆ |
| **ç”Ÿå‘½å‘¨æœŸ** | æ°¸ä¹…å­˜åœ¨ï¼Œå¯è½¬è®©ã€å¯åœç”¨ | æ°¸ä¹…å­˜åœ¨ï¼Œå¯è¿ç§» |
| **1å¯¹å¤šå…³ç³»** | 1ä¸ªå¢“ä½ï¼šæœ€å¤š6ä¸ªé€è€… | 1ä¸ªé€è€…ï¼šä»…å±äº1ä¸ªå¢“ä½ |
| **æ‰€æœ‰æƒ** | å¢“ä¸»ï¼ˆownerï¼‰+ ç®¡ç†å‘˜åˆ—è¡¨ | é€è€…ç®¡ç†äººï¼ˆownerï¼‰ |
| **æ ¸å¿ƒæ ‡è¯†** | `GraveId`ï¼ˆæ•°å­—IDï¼‰+ `Slug`ï¼ˆäººç±»å¯è¯»IDï¼‰ | `DeceasedId`ï¼ˆæ•°å­—IDï¼‰+ `deceased_token`ï¼ˆå”¯ä¸€èº«ä»½ç ï¼‰ |

---

### 1.2 èŒè´£åˆ’åˆ†åŸåˆ™

#### ğŸ›ï¸ **pallet-stardust-graveï¼ˆå¢“ä½palletï¼‰**

**æ ¸å¿ƒèŒè´£**ï¼šç®¡ç†"ç©ºé—´å®¹å™¨"çš„å±æ€§å’Œå‡†å…¥è§„åˆ™

- âœ… å¢“ä½åˆ›å»ºã€è½¬è®©ã€åœç”¨
- âœ… å¢“ä½å…ƒæ•°æ®ï¼ˆåç§°ã€åˆ†ç±»ã€å®—æ•™ä¿¡ä»°ï¼‰
- âœ… å¢“ä½ç¾åŒ–ï¼ˆå°é¢ã€èƒŒæ™¯éŸ³ä¹ã€æ’­æ”¾åˆ—è¡¨ï¼‰
- âœ… å¢“ä½ç¤¾äº¤ï¼ˆå…³æ³¨ç³»ç»Ÿã€æˆå‘˜ç”³è¯·ã€ç®¡ç†å‘˜ç®¡ç†ï¼‰
- âœ… å‡†å…¥ç­–ç•¥ï¼ˆOwnerOnly/Public/Whitelistï¼‰
- âœ… å®‰è‘¬è®°å½•ç®¡ç†ï¼ˆ`Interments` å­˜å‚¨ï¼‰
- âœ… è½®æ’­å›¾ç®¡ç†ï¼ˆé¦–é¡µå±•ç¤ºï¼‰

#### ğŸ‘¤ **pallet-deceasedï¼ˆé€è€…palletï¼‰**

**æ ¸å¿ƒèŒè´£**ï¼šç®¡ç†"äººçš„æ•°å­—èº«ä»½"åŠå…¶å†…å®¹

- âœ… é€è€…æ¡£æ¡ˆåˆ›å»ºã€æ›´æ–°ã€è¿ç§»
- âœ… é€è€…åŸºæœ¬ä¿¡æ¯ï¼ˆå§“åã€æ€§åˆ«ã€ç”Ÿå’æ—¥æœŸã€ä¸»å›¾ï¼‰
- âœ… é€è€…å…³ç³»ç®¡ç†ï¼ˆé…å¶ã€çˆ¶æ¯ã€å­å¥³ã€å…„å¼Ÿå§å¦¹ã€æœ‹å‹ï¼‰
- âœ… é€è€…å†…å®¹ç®¡ç†ï¼š
  - **æ–‡æœ¬å†…å®¹**ï¼ˆtext.rsï¼‰ï¼šç”Ÿå¹³ã€ç•™è¨€ã€æ‚¼è¯
  - **åª’ä½“å†…å®¹**ï¼ˆmedia.rsï¼‰ï¼šç›¸å†Œã€ç…§ç‰‡ã€è§†é¢‘ã€éŸ³é¢‘
- âœ… äº²å‹ç®¡ç†ï¼ˆç”³è¯·ã€æ‰¹å‡†ã€ç§»é™¤ï¼‰
- âœ… å¯è§æ€§æ§åˆ¶ï¼ˆå…¬å¼€/ç§å¯†ï¼‰

---

## äºŒã€åŠŸèƒ½é‡å åˆ†æä¸æ•´åˆæ–¹æ¡ˆ

### 2.1 å®‰è‘¬ç®¡ç†ï¼ˆIntermentï¼‰

#### ğŸ“ **å½“å‰çŠ¶æ€**

- **Grave**: ç»´æŠ¤ `Interments<GraveId, Vec<IntermentRecord>>` å­˜å‚¨
- **Deceased**: ç»´æŠ¤ `DeceasedByGrave<GraveId, Vec<DeceasedId>>` å­˜å‚¨
- **é—®é¢˜**: ä¸¤ä¸ªå­˜å‚¨å®¹æ˜“ä¸åŒæ­¥

#### âœ… **æ•´åˆæ–¹æ¡ˆï¼ˆPhase 1.5å·²å®ç°ï¼‰**

```
èŒè´£åˆ’åˆ†ï¼š
â”œâ”€â”€ Grave pallet
â”‚   â”œâ”€â”€ Interments å­˜å‚¨ï¼ˆä¸»æ•°æ®æºï¼‰
â”‚   â”œâ”€â”€ inter() / exhume() æ¥å£ï¼ˆå¢“ä¸»/ç®¡ç†å‘˜è°ƒç”¨ï¼‰
â”‚   â””â”€â”€ record_interment() / record_exhumation()ï¼ˆåŒæ­¥æ¥å£ï¼Œä¾›deceasedè°ƒç”¨ï¼‰
â”‚
â””â”€â”€ Deceased pallet
    â”œâ”€â”€ DeceasedByGrave å­˜å‚¨ï¼ˆè¾…åŠ©ç´¢å¼•ï¼‰
    â”œâ”€â”€ create_deceased()ï¼šåˆ›å»ºåè‡ªåŠ¨è°ƒç”¨ GraveInspector::record_interment()
    â””â”€â”€ transfer_deceased()ï¼šè¿ç§»æ—¶è‡ªåŠ¨è°ƒç”¨ record_exhumation() + record_interment()
```

**è§„åˆ™**ï¼š
1. âœ… Grave ä½œä¸ºå®‰è‘¬è®°å½•çš„**ä¸»å­˜å‚¨**ï¼ŒDeceased ä½œä¸º**è¾…åŠ©ç´¢å¼•**
2. âœ… å®‰è‘¬æ“ä½œç”± Grave çš„ `inter()` å‘èµ·ï¼ŒDeceased è¢«åŠ¨åŒæ­¥
3. âœ… è¿ç§»æ“ä½œç”± Deceased çš„ `transfer_deceased()` å‘èµ·ï¼Œè‡ªåŠ¨è°ƒç”¨ Grave çš„åŒæ­¥æ¥å£
4. âœ… åŒå‘åŒæ­¥é€šè¿‡ `GraveInspector` trait è§£è€¦

---

### 2.2 å‡†å…¥ç­–ç•¥ï¼ˆAdmission Policyï¼‰

#### ğŸ“ **é—®é¢˜**

- å¦‚ä½•é˜²æ­¢é€è€…è¢«å¼ºè¡Œè¿å…¥ç§äººå¢“ä½ï¼Ÿ

#### âœ… **æ•´åˆæ–¹æ¡ˆï¼ˆPhase 1.5å·²å®ç°ï¼‰**

```
èŒè´£ï¼š
â”œâ”€â”€ Grave pallet
â”‚   â”œâ”€â”€ å®šä¹‰å‡†å…¥ç­–ç•¥ï¼ˆOwnerOnly / Public / Whitelistï¼‰
â”‚   â”œâ”€â”€ set_admission_policy()ï¼šè®¾ç½®ç­–ç•¥
â”‚   â”œâ”€â”€ add/remove_admission_whitelist()ï¼šç»´æŠ¤ç™½åå•
â”‚   â””â”€â”€ check_admission_policy()ï¼šæ ¡éªŒæ¥å£
â”‚
â””â”€â”€ Deceased pallet
    â””â”€â”€ transfer_deceased()ï¼šè¿ç§»å‰è°ƒç”¨ GraveInspector::check_admission_policy()
```

**è§„åˆ™**ï¼š
- âœ… å‡†å…¥ç­–ç•¥ç”± **Grave pallet ç‹¬å ç®¡ç†**
- âœ… Deceased pallet åœ¨åˆ›å»º/è¿ç§»æ—¶**å¿…é¡»æ ¡éªŒ**å‡†å…¥ç­–ç•¥
- âœ… å¢“ä¸»å§‹ç»ˆå¯ä»¥è¿å…¥ï¼ˆä¸å—ç­–ç•¥é™åˆ¶ï¼‰

---

### 2.3 å¯è§æ€§æ§åˆ¶ï¼ˆVisibilityï¼‰

#### ğŸ“ **å½“å‰çŠ¶æ€**

- **Grave**: `is_public: bool`ï¼ˆå¢“ä½çº§å¯è§æ€§ï¼‰
- **Deceased**: `VisibilityOf<DeceasedId, bool>`ï¼ˆé€è€…çº§å¯è§æ€§ï¼‰

#### âœ… **æ•´åˆæ–¹æ¡ˆ**

```
åŒå±‚å¯è§æ€§æœºåˆ¶ï¼š
â”œâ”€â”€ ç¬¬ä¸€å±‚ï¼šGrave.is_publicï¼ˆå¢“ä½çº§ï¼‰
â”‚   â”œâ”€â”€ true â†’ å¢“ä½åœ¨é¦–é¡µ/åˆ—è¡¨ä¸­å±•ç¤º
â”‚   â””â”€â”€ false â†’ å¢“ä½éšè—ï¼Œä»…ç›´æ¥è®¿é—®å¯è§
â”‚
â””â”€â”€ ç¬¬äºŒå±‚ï¼šVisibilityOf[deceased_id]ï¼ˆé€è€…çº§ï¼‰
    â”œâ”€â”€ true â†’ é€è€…æ¡£æ¡ˆå…¬å¼€å¯è§
    â””â”€â”€ false â†’ é€è€…æ¡£æ¡ˆä»… owner/ç®¡ç†å‘˜å¯è§
```

**å‰ç«¯å±•ç¤ºè§„åˆ™**ï¼š
```
ç”¨æˆ·èƒ½å¦çœ‹åˆ°é€è€…æ¡£æ¡ˆï¼Ÿ
â”œâ”€â”€ Step 1: æ£€æŸ¥ Grave.is_public
â”‚   â””â”€â”€ false â†’ ä»…å¢“ä¸»/ç®¡ç†å‘˜å¯è®¿é—®å¢“ä½
â”‚
â””â”€â”€ Step 2: æ£€æŸ¥ VisibilityOf[deceased_id]
    â””â”€â”€ false â†’ ä»…é€è€… owner å¯è®¿é—®æ¡£æ¡ˆ
```

**èŒè´£åˆ’åˆ†**ï¼š
- âœ… Grave æ§åˆ¶**å¢“ä½çš„ç¤¾äº¤å¯è§æ€§**ï¼ˆæ˜¯å¦åœ¨é¦–é¡µå±•ç¤ºã€æ˜¯å¦å¯æœç´¢ï¼‰
- âœ… Deceased æ§åˆ¶**é€è€…æ¡£æ¡ˆçš„éšç§æ€§**ï¼ˆæ¡£æ¡ˆå†…å®¹æ˜¯å¦å…¬å¼€ï¼‰

---

## ä¸‰ã€äº¤äº’æ€§åŠŸèƒ½åˆ†é…

### 3.1 ä¾›å¥‰ï¼ˆOfferingsï¼‰

#### ğŸ“Œ **ç»Ÿä¸€è®¾è®¡ï¼ˆpallet-memorialï¼‰**

```
ä¾›å¥‰ç›®æ ‡æŠ½è±¡ï¼š
â”œâ”€â”€ Domain 0: Graveï¼ˆå¢“ä½ï¼‰
â”œâ”€â”€ Domain 1: Petï¼ˆå® ç‰©ï¼Œå¾…å®ç°ï¼‰
â”œâ”€â”€ Domain 2: Parkï¼ˆé™µå›­ï¼‰
â””â”€â”€ Domain 3: Memorialï¼ˆçºªå¿µé¦†ï¼‰
```

#### âœ… **é›†æˆæ–¹æ¡ˆ**

**ä¸ä¿®æ”¹ Grave/Deceased**ï¼Œåœ¨ Memorial pallet ä¸­å®ç°ï¼š

```rust
// ä¾›å¥‰æ¥å£ï¼ˆé€šç”¨ï¼‰
offer(
    origin,
    domain: u8,          // 0=Grave, 1=Pet, 2=Park, 3=Memorial
    target_id: u64,      // GraveId / PetId / ParkId / MemorialId
    kind_code: u8,       // ä¾›å¥‰å“ç±»å‹
    media: Vec<...>,     // åª’ä½“èµ„æ–™
    duration: Option<u32>, // æ—¶é•¿ï¼ˆå‘¨æ•°ï¼‰
)

// ä¾›å¥‰ç¥­ç¥€å“æ¥å£
offer_by_sacrifice(
    origin,
    domain: u8,
    target_id: u64,
    sacrifice_id: u64,   // ç¥­ç¥€å“ç›®å½•ID
    duration: Option<u32>,
)
```

**ä¾›å¥‰è®°å½•å…³è”**ï¼š
```
OfferingsByTarget<(domain, target_id), Vec<OfferingId>>
â”œâ”€â”€ (0, grave_id) â†’ è¯¥å¢“ä½çš„æ‰€æœ‰ä¾›å¥‰è®°å½•
â””â”€â”€ (1, pet_id) â†’ è¯¥å® ç‰©çš„æ‰€æœ‰ä¾›å¥‰è®°å½•
```

**è§„åˆ™**ï¼š
- âœ… **ä¸åŒºåˆ†** Grave å’Œ Deceasedï¼Œç»Ÿä¸€ä¾›å¥‰åˆ° **Grave**ï¼ˆå¢“ä½ï¼‰
- âœ… å‰ç«¯å¯ä»¥æ ¹æ® `DeceasedByGrave` ç´¢å¼•ï¼Œåœ¨é€è€…è¯¦æƒ…é¡µå±•ç¤ºä¾›å¥‰è®°å½•
- âœ… èµ„é‡‘åˆ†è´¦é€šè¿‡ `OnOfferingCommitted` é’©å­è§¦å‘ `pallet-memo-affiliate`

**ç†ç”±**ï¼š
1. é€è€…æ˜¯å¢“ä½çš„é™„å±å®ä½“ï¼Œä¾›å¥‰åˆ°å¢“ä½ç¬¦åˆç°å®é€»è¾‘
2. ç®€åŒ–ä¾›å¥‰ç³»ç»Ÿè®¾è®¡ï¼Œé¿å…é‡å¤å®ç°
3. èµ„é‡‘åˆ†è´¦ç»Ÿä¸€è·¯ç”±åˆ°å¢“ä¸»/å¹³å°ï¼Œé€»è¾‘æ¸…æ™°

---

### 3.2 ç•™è¨€ï¼ˆMessagesï¼‰

#### ğŸ“Œ **ç»Ÿä¸€æ–¹æ¡ˆï¼ˆpallet-deceased â†’ text.rsï¼‰**

```rust
// åœ¨ pallet-deceased/src/text.rs ä¸­å·²å®ç°
pub struct TextRecord<T: Config> {
    pub deceased_id: DeceasedId,  // å…³è”é€è€…
    pub author: AccountId,         // ç•™è¨€è€…
    pub kind: TextKind,            // Article / Message
    pub cid: Vec<u8>,              // ç•™è¨€å†…å®¹CID
    pub created: BlockNumber,      // åˆ›å»ºæ—¶é—´
}

// ç•™è¨€æ¥å£
create_message(
    origin,
    deceased_id: u64,
    cid: Vec<u8>,
    title: Option<Vec<u8>>,
)
```

**è§„åˆ™**ï¼š
- âœ… ç•™è¨€**ä»…é’ˆå¯¹é€è€…**ï¼Œä¸é’ˆå¯¹å¢“ä½
- âœ… å­˜å‚¨åœ¨ `pallet-deceased` çš„ `text` æ¨¡å—
- âœ… ç•™è¨€éœ€è¦æŠ¼é‡‘ï¼ˆé˜²æ»¥ç”¨ï¼‰
- âœ… å¢“ä½è¯¦æƒ…é¡µå¯ä»¥èšåˆæ˜¾ç¤ºæ‰€æœ‰é€è€…çš„ç•™è¨€

**å‰ç«¯å±•ç¤º**ï¼š
```
å¢“ä½è¯¦æƒ…é¡µ
â”œâ”€â”€ é€è€…åˆ—è¡¨
â”‚   â”œâ”€â”€ é€è€…A
â”‚   â”‚   â”œâ”€â”€ ç”Ÿå¹³
â”‚   â”‚   â”œâ”€â”€ ç›¸å†Œ
â”‚   â”‚   â””â”€â”€ ç•™è¨€ï¼ˆ10æ¡ï¼‰
â”‚   â””â”€â”€ é€è€…B
â”‚       â””â”€â”€ ç•™è¨€ï¼ˆ5æ¡ï¼‰
â””â”€â”€ å¢“ä½ç•™è¨€æ¿ï¼ˆå¯é€‰èšåˆè§†å›¾ï¼Œæ˜¾ç¤ºæ‰€æœ‰é€è€…çš„ç•™è¨€ï¼‰
```

---

### 3.3 ç‚¹ç¯ï¼ˆLighting / Candlesï¼‰

#### ğŸ“Œ **ç»Ÿä¸€æ–¹æ¡ˆï¼ˆpallet-memorial â†’ ä¾›å¥‰å“ç±»å‹ï¼‰**

**å®ç°æ–¹å¼**ï¼š

```rust
// ç‚¹ç¯ä½œä¸ºç‰¹æ®Šçš„ä¾›å¥‰å“ç±»å‹
SacrificeItem {
    id: 1,
    name: "ç¥ˆç¦èœ¡çƒ›",
    category: Candle,          // ç±»ç›®ï¼šèœ¡çƒ›
    scene: Grave,              // åœºæ™¯ï¼šå¢“ç¢‘
    fixed_price: Some(10_000), // å›ºå®šä»·æ ¼ï¼š0.01 DUST
    unit_price_per_week: None, // éè®¡æ—¶å•†å“
    is_vip_exclusive: false,
    resource_url: "ipfs://Qm...",
    status: Enabled,
}

// ç‚¹ç¯æ¥å£ï¼ˆå¤ç”¨ä¾›å¥‰æ¥å£ï¼‰
offer_by_sacrifice(
    origin,
    domain: 0,          // Grave
    target_id: grave_id,
    sacrifice_id: 1,    // ç¥ˆç¦èœ¡çƒ›
    duration: None,     // å³æ—¶å‹ï¼Œæ— æ—¶é•¿
)
```

**å‰ç«¯ç‰¹æ•ˆ**ï¼š
- ç‚¹ç¯ååœ¨å¢“ä½è¯¦æƒ…é¡µæ˜¾ç¤º"èœ¡çƒ›æ•ˆæœ"åŠ¨ç”»
- é€šè¿‡ `OfferingsByTarget[(0, grave_id)]` æŸ¥è¯¢ç‚¹ç¯è®°å½•

**è§„åˆ™**ï¼š
- âœ… ç‚¹ç¯æ˜¯**å¢“ä½çº§æ“ä½œ**ï¼Œä¸åŒºåˆ†é€è€…
- âœ… é€šè¿‡ Memorial pallet çš„ä¾›å¥‰æ¥å£å®ç°
- âœ… å‰ç«¯æ ¹æ®ä¾›å¥‰è®°å½•æ¸²æŸ“è§†è§‰æ•ˆæœ

---

### 3.4 æ‚¼è¯ï¼ˆEulogyï¼‰

#### ğŸ“Œ **ç»Ÿä¸€æ–¹æ¡ˆï¼ˆpallet-deceased â†’ text.rsï¼‰**

```rust
// åœ¨ pallet-deceased/src/text.rs ä¸­å·²æœ‰å­˜å‚¨
pub struct TextRecord<T: Config> {
    pub deceased_id: DeceasedId,
    pub kind: TextKind::Eulogy,  // æ‚¼è¯ç±»å‹
    pub cid: Vec<u8>,
    pub author: AccountId,
}

// æ‚¼è¯æ¥å£
create_eulogy(
    origin,
    deceased_id: u64,
    cid: Vec<u8>,
)
```

**è§„åˆ™**ï¼š
- âœ… æ‚¼è¯**ä»…é’ˆå¯¹é€è€…**ï¼Œä¸é’ˆå¯¹å¢“ä½
- âœ… æ¯ä¸ªé€è€…æœ€å¤š `MaxEulogiesPerDeceased` æ¡æ‚¼è¯
- âœ… éœ€è¦æŠ¼é‡‘ï¼ˆå¯é€€è¿˜ï¼‰

---

### 3.5 èƒŒæ™¯éŸ³ä¹ï¼ˆAudioï¼‰

#### ğŸ“Œ **èŒè´£å½’å±ï¼špallet-stardust-grave**

```rust
// å¢“ä½çº§èƒŒæ™¯éŸ³ä¹
AudioOf<GraveId, Vec<u8>>              // å•é¦–éŸ³ä¹CID
AudioPlaylistOf<GraveId, Vec<Vec<u8>>> // æ’­æ”¾åˆ—è¡¨

// æ¥å£
set_audio(origin, grave_id, cid)
set_audio_playlist(origin, grave_id, cids)
```

**è§„åˆ™**ï¼š
- âœ… èƒŒæ™¯éŸ³ä¹æ˜¯**å¢“ä½çº§åŠŸèƒ½**ï¼Œä¸å±äºé€è€…æ¡£æ¡ˆ
- âœ… æ‰€æœ‰é€è€…å…±äº«å¢“ä½çš„èƒŒæ™¯éŸ³ä¹
- âœ… è‡ªåŠ¨ IPFS Pin

---

### 3.6 ç›¸å†Œä¸åª’ä½“ï¼ˆPhotos / Videos / Albumsï¼‰

#### ğŸ“Œ **èŒè´£å½’å±ï¼špallet-deceased â†’ media.rs**

```rust
// åœ¨ pallet-deceased/src/media.rs ä¸­å·²å®ç°
pub struct Album<T: Config> {
    pub deceased_id: DeceasedId,  // å…³è”é€è€…
    pub owner: AccountId,
    pub name: Vec<u8>,
    pub cover_cid: Option<Vec<u8>>,
}

pub struct Photo<T: Config> {
    pub album_id: AlbumId,
    pub cid: Vec<u8>,
    pub thumbnail_cid: Option<Vec<u8>>,
    pub tags: Vec<Vec<u8>>,
}
```

**è§„åˆ™**ï¼š
- âœ… ç›¸å†Œã€ç…§ç‰‡ã€è§†é¢‘**ä»…å±äºé€è€…**
- âœ… æ¯ä¸ªé€è€…å¯ä»¥æœ‰å¤šä¸ªç›¸å†Œ
- âœ… æ”¯æŒæ ‡ç­¾ã€æ’åºã€ç¼©ç•¥å›¾

---

## å››ã€æ•°æ®æµå‘å›¾

### 4.1 åˆ›å»ºé€è€…æ¡£æ¡ˆ

```
ç”¨æˆ·æ“ä½œï¼šcreate_deceased(grave_id, name, gender, ...)
â”‚
â”œâ”€> Deceased pallet
â”‚   â”œâ”€> 1. ç”Ÿæˆ deceased_tokenï¼ˆå”¯ä¸€èº«ä»½ç ï¼‰
â”‚   â”œâ”€> 2. åˆ›å»º Deceased è®°å½•
â”‚   â”œâ”€> 3. æ›´æ–° DeceasedByGrave[grave_id]
â”‚   â”œâ”€> 4. IPFS Pinï¼ˆname_full_cid, main_image_cidï¼‰
â”‚   â””â”€> 5. è°ƒç”¨ GraveInspector::record_interment()
â”‚
â””â”€> Grave palletï¼ˆè¢«åŠ¨å“åº”ï¼‰
    â”œâ”€> 1. éªŒè¯ grave_id å­˜åœ¨
    â”œâ”€> 2. æ›´æ–° Interments[grave_id]
    â””â”€> 3. æ›´æ–° Grave.deceased_tokensï¼ˆä»¤ç‰Œåˆ—è¡¨ï¼‰
```

---

### 4.2 ä¾›å¥‰æµç¨‹

```
ç”¨æˆ·æ“ä½œï¼šoffer_by_sacrifice(domain=0, grave_id, sacrifice_id, ...)
â”‚
â”œâ”€> Memorial pallet
â”‚   â”œâ”€> 1. éªŒè¯å¢“ä½å­˜åœ¨ï¼ˆé€šè¿‡ GraveInspectorï¼‰
â”‚   â”œâ”€> 2. æ£€æŸ¥ç¥­ç¥€å“ç›®å½•
â”‚   â”œâ”€> 3. è®¡ç®—ä»·æ ¼ï¼ˆå«ä¼šå‘˜æŠ˜æ‰£ï¼‰
â”‚   â”œâ”€> 4. æ‰£è´¹ + åˆ†è´¦ï¼ˆ80%å¢“ä¸», 20%å¹³å°ï¼‰
â”‚   â”œâ”€> 5. åˆ›å»º OfferingRecord
â”‚   â”œâ”€> 6. è°ƒç”¨ OnOfferingCommittedï¼ˆè§¦å‘è”ç›Ÿè¥é”€åˆ†è´¦ï¼‰
â”‚   â””â”€> 7. å‘å‡ºäº‹ä»¶ OfferingCommittedBySacrifice
â”‚
â””â”€> Memo-Affiliate palletï¼ˆåå°ä»»åŠ¡ï¼‰
    â””â”€> å‘¨åº¦ç»“ç®—ï¼šåˆ†é…è”ç›Ÿè¥é”€ä½£é‡‘ï¼ˆ15å±‚å‹ç¼©ï¼‰
```

---

### 4.3 ç•™è¨€æµç¨‹

```
ç”¨æˆ·æ“ä½œï¼šcreate_message(deceased_id, cid, title)
â”‚
â””â”€> Deceased pallet (text.rs)
    â”œâ”€> 1. éªŒè¯ deceased_id å­˜åœ¨
    â”œâ”€> 2. æ£€æŸ¥ç•™è¨€æ•°é‡é™åˆ¶
    â”œâ”€> 3. æ‰£é™¤æŠ¼é‡‘ï¼ˆReservableCurrencyï¼‰
    â”œâ”€> 4. åˆ›å»º TextRecordï¼ˆkind=Messageï¼‰
    â”œâ”€> 5. IPFS Pinï¼ˆcidï¼‰
    â””â”€> 6. å‘å‡ºäº‹ä»¶ MessageCreated
```

---

## äº”ã€æœ€ä½³å®è·µå»ºè®®

### 5.1 å‰ç«¯è®¾è®¡å»ºè®®

#### å¢“ä½è¯¦æƒ…é¡µç»“æ„

```
ğŸ“„ å¢“ä½è¯¦æƒ…é¡µ (/grave/:grave_id)
â”œâ”€â”€ ğŸ›ï¸ å¢“ä½ä¿¡æ¯
â”‚   â”œâ”€â”€ åç§°ã€å°é¢ã€èƒŒæ™¯éŸ³ä¹
â”‚   â”œâ”€â”€ å…³æ³¨æ•°ã€æˆå‘˜æ•°
â”‚   â””â”€â”€ å‡†å…¥ç­–ç•¥ã€åŠ å…¥ç­–ç•¥
â”‚
â”œâ”€â”€ ğŸ‘¥ é€è€…åˆ—è¡¨ï¼ˆæ¥è‡ª DeceasedByGraveï¼‰
â”‚   â”œâ”€â”€ é€è€…A
â”‚   â”‚   â”œâ”€â”€ åŸºæœ¬ä¿¡æ¯ï¼ˆå§“åã€æ€§åˆ«ã€ç”Ÿå’æ—¥æœŸã€ä¸»å›¾ï¼‰
â”‚   â”‚   â”œâ”€â”€ [æŸ¥çœ‹è¯¦æƒ…] â†’ è·³è½¬åˆ°é€è€…æ¡£æ¡ˆé¡µ
â”‚   â”‚   â””â”€â”€ [ä¾›å¥‰] / [ç•™è¨€] å¿«æ·å…¥å£
â”‚   â””â”€â”€ é€è€…B ...
â”‚
â”œâ”€â”€ ğŸ ä¾›å¥‰è®°å½•ï¼ˆæ¥è‡ª Memorial::OfferingsByTargetï¼‰
â”‚   â”œâ”€â”€ æŒ‰æ—¶é—´å€’åº
â”‚   â””â”€â”€ æ˜¾ç¤ºä¾›å¥‰è€…ã€ä¾›å¥‰å“ã€æ—¶é—´
â”‚
â””â”€â”€ ğŸ’¬ ç•™è¨€å¢™ï¼ˆå¯é€‰èšåˆè§†å›¾ï¼‰
    â””â”€â”€ æ˜¾ç¤ºæ‰€æœ‰é€è€…çš„æœ€æ–°ç•™è¨€
```

#### é€è€…æ¡£æ¡ˆé¡µç»“æ„

```
ğŸ“„ é€è€…æ¡£æ¡ˆé¡µ (/deceased/:deceased_id)
â”œâ”€â”€ ğŸ‘¤ åŸºæœ¬ä¿¡æ¯
â”‚   â”œâ”€â”€ ä¸»å›¾ã€å§“åã€æ€§åˆ«ã€ç”Ÿå’æ—¥æœŸ
â”‚   â”œâ”€â”€ æ‰€å±å¢“ä½é“¾æ¥
â”‚   â””â”€â”€ å…³ç³»ç½‘ç»œï¼ˆé…å¶ã€çˆ¶æ¯ã€å­å¥³...ï¼‰
â”‚
â”œâ”€â”€ ğŸ“– ç”Ÿå¹³ï¼ˆLifeï¼‰
â”œâ”€â”€ ğŸ“· ç›¸å†Œï¼ˆAlbumsï¼‰
â”œâ”€â”€ ğŸ¥ è§†é¢‘ï¼ˆVideosï¼‰
â”œâ”€â”€ ğŸµ éŸ³é¢‘ï¼ˆAudiosï¼‰
â”œâ”€â”€ ğŸ’¬ ç•™è¨€ï¼ˆMessagesï¼‰
â””â”€â”€ ğŸ“œ æ‚¼è¯ï¼ˆEulogiesï¼‰
```

---

### 5.2 API è°ƒç”¨å»ºè®®

#### åˆ›å»ºé€è€…æ—¶çš„æœ€ä½³å®è·µ

```typescript
// âŒ é”™è¯¯ï¼šåˆ†ä¸¤æ­¥åˆ›å»ºï¼ˆå…ˆåˆ›å»ºå¢“ä½ï¼Œå†åˆ›å»ºé€è€…ï¼‰
// å¯èƒ½å¯¼è‡´ Interments å’Œ DeceasedByGrave ä¸åŒæ­¥

// âœ… æ­£ç¡®ï¼šä¸€æ­¥åˆ°ä½
await api.tx.deceased.createDeceased(
  graveId,
  "å¼ ä¸‰",
  Gender.M,
  "19800101",
  "20250101",
  null,        // name_full_cid
  mainImageCid,
  []           // links
).signAndSend(graveOwner);
```

#### ä¾›å¥‰æœ€ä½³å®è·µ

```typescript
// ä¼˜å…ˆä½¿ç”¨ç¥­ç¥€å“ç›®å½•ï¼ˆç®€åŒ–ï¼‰
await api.tx.memorial.offerBySacrifice(
  0,           // domain=0 (Grave)
  graveId,
  sacrificeId, // ä¾‹å¦‚ï¼š1=ç¥ˆç¦èœ¡çƒ›
  null         // durationï¼ˆå³æ—¶å‹æ— éœ€æ—¶é•¿ï¼‰
).signAndSend(user);

// å¦‚æœéœ€è¦è‡ªå®šä¹‰åª’ä½“ï¼Œä½¿ç”¨ä¾›å¥‰å“è§„æ ¼
await api.tx.memorial.offer(
  0,           // domain=0 (Grave)
  graveId,
  kindCode,    // ä¾›å¥‰å“ç±»å‹
  [{ cid: customMediaCid }],
  null
).signAndSend(user);
```

---

### 5.3 æƒé™æ£€æŸ¥å»ºè®®

#### è°å¯ä»¥ä¾›å¥‰ï¼Ÿ

```
ä»»ä½•è´¦æˆ·éƒ½å¯ä»¥ä¾›å¥‰ï¼ˆé™é¢‘æ§åˆ¶é˜²æ­¢æ»¥ç”¨ï¼‰
```

#### è°å¯ä»¥ç•™è¨€ï¼Ÿ

```
è§„åˆ™ï¼ˆæ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©ï¼‰ï¼š
â”œâ”€â”€ Option 1: ä»»ä½•è´¦æˆ·ï¼ˆé»˜è®¤ï¼‰
â”œâ”€â”€ Option 2: ä»…å¢“ä½æˆå‘˜
â””â”€â”€ Option 3: ä»…é€è€…äº²å‹
```

#### è°å¯ä»¥ç¼–è¾‘é€è€…æ¡£æ¡ˆï¼Ÿ

```
ä»…é€è€… ownerï¼ˆé€è€…ç®¡ç†äººï¼‰
```

#### è°å¯ä»¥æ·»åŠ ç›¸å†Œ/ç…§ç‰‡ï¼Ÿ

```
é€è€… owner + æˆæƒçš„äº²å‹
```

---

## å…­ã€æŠ€æœ¯å®ç°æ¸…å•

### 6.1 å·²å®Œæˆï¼ˆPhase 1.5ï¼‰

- [x] Grave ä¸ Deceased çš„å‡†å…¥ç­–ç•¥æœºåˆ¶
- [x] `GraveInspector` trait è§£è€¦è®¾è®¡
- [x] åŒå‘åŒæ­¥æ¥å£ï¼ˆrecord_interment / record_exhumationï¼‰
- [x] deceased_token æœºåˆ¶ï¼ˆå…¨UTF-8ç¼–ç ï¼‰
- [x] ç•™è¨€/æ‚¼è¯åŠŸèƒ½ï¼ˆtext.rsï¼‰
- [x] ç›¸å†Œ/è§†é¢‘åŠŸèƒ½ï¼ˆmedia.rsï¼‰
- [x] ä¾›å¥‰ç³»ç»Ÿï¼ˆMemorial palletï¼‰

### 6.2 å¾…ä¼˜åŒ–

- [ ] å‰ç«¯èšåˆè§†å›¾ï¼ˆå¢“ä½ç•™è¨€å¢™ï¼‰
- [ ] ä¾›å¥‰è®°å½•çš„å‰ç«¯åŠ¨æ•ˆï¼ˆç‚¹ç¯ç‰¹æ•ˆï¼‰
- [ ] é€è€…å…³ç³»ç½‘ç»œå¯è§†åŒ–
- [ ] ç›¸å†Œæ‰¹é‡ä¸Šä¼ ä¼˜åŒ–

---

## ä¸ƒã€å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### Q1: ä¾›å¥‰åº”è¯¥è®°å½•åœ¨ Grave è¿˜æ˜¯ Deceasedï¼Ÿ

**A**: **ç»Ÿä¸€è®°å½•åœ¨ Grave**ã€‚

ç†ç”±ï¼š
1. ç°å®é€»è¾‘ï¼šä¾›å¥‰æ˜¯å‘å¢“ä½çŒ®ç¥­ï¼Œè€Œéå‘æŸä¸ªé€è€…
2. ç®€åŒ–è®¾è®¡ï¼šé¿å…é‡å¤å®ç°ä¾›å¥‰ç³»ç»Ÿ
3. èµ„é‡‘è·¯ç”±æ¸…æ™°ï¼šåˆ†è´¦åˆ°å¢“ä¸»ï¼ˆè€Œéé€è€…ownerï¼‰

å‰ç«¯å¤„ç†ï¼š
- åœ¨é€è€…è¯¦æƒ…é¡µï¼Œé€šè¿‡ `DeceasedByGrave` ç´¢å¼•æ˜¾ç¤ºè¯¥å¢“ä½çš„ä¾›å¥‰è®°å½•
- å¯ä»¥åœ¨ UI ä¸Šæ·»åŠ "ä¸º XX ä¾›å¥‰"çš„è¯­ä¹‰æ ‡æ³¨

---

### Q2: ç•™è¨€åº”è¯¥è®°å½•åœ¨ Grave è¿˜æ˜¯ Deceasedï¼Ÿ

**A**: **è®°å½•åœ¨ Deceased**ã€‚

ç†ç”±ï¼š
1. è¯­ä¹‰å‡†ç¡®ï¼šç•™è¨€æ˜¯å¯¹é€è€…çš„è¿½æ€ï¼Œä¸æ˜¯å¯¹å¢“ä½çš„è¯„è®º
2. å…³ç³»ç½‘ç»œï¼šé€è€…æ¡£æ¡ˆéœ€è¦å®Œæ•´è®°å½•æ‰€æœ‰äº’åŠ¨
3. è¿ç§»å‹å¥½ï¼šé€è€…è¿ç§»æ—¶ï¼Œç•™è¨€éšæ¡£æ¡ˆè¿ç§»

å‰ç«¯å¤„ç†ï¼š
- å¢“ä½è¯¦æƒ…é¡µå¯ä»¥èšåˆæ˜¾ç¤ºæ‰€æœ‰é€è€…çš„ç•™è¨€ï¼ˆè”åˆæŸ¥è¯¢ï¼‰

---

### Q3: å¦‚ä½•é˜²æ­¢é€è€…è¢«å¼ºè¡Œè¿å…¥ç§äººå¢“ä½ï¼Ÿ

**A**: **å‡†å…¥ç­–ç•¥ï¼ˆPhase 1.5å·²å®ç°ï¼‰**ã€‚

```rust
// å¢“ä¸»è®¾ç½®å‡†å…¥ç­–ç•¥
set_admission_policy(grave_id, OwnerOnly);

// é€è€…è¿ç§»æ—¶è‡ªåŠ¨æ ¡éªŒ
transfer_deceased(deceased_id, new_grave_id, new_owner)
  â””â”€> check_admission_policy() // å¦‚æœè¿åç­–ç•¥ï¼Œäº¤æ˜“å¤±è´¥
```

---

### Q4: å¢“ä½å¯ä»¥æœ‰å¤šä¸ªé€è€…ï¼Œä¾›å¥‰å¦‚ä½•åˆ†é…ï¼Ÿ

**A**: **ä¾›å¥‰é‡‘é¢åˆ†é…åˆ°å¢“ä¸»ï¼Œä¸åŒºåˆ†é€è€…**ã€‚

åŸå› ï¼š
1. å¢“ä½æ˜¯èµ„äº§å•ä½ï¼Œå¢“ä¸»æ˜¯èµ„äº§æ‰€æœ‰è€…
2. é¿å…å¤æ‚çš„å¤šè´¦æˆ·åˆ†è´¦é€»è¾‘
3. ç¬¦åˆç°å®é€»è¾‘ï¼ˆé™µå›­æ”¶è´¹æ˜¯å¢“ä½çº§åˆ«ï¼Œä¸æ˜¯æŒ‰äººå¤´ï¼‰

å¦‚éœ€æŒ‰é€è€…åˆ†è´¦ï¼Œå¯åœ¨é“¾ä¸‹åº”ç”¨å±‚å®ç°ã€‚

---

### Q5: èƒŒæ™¯éŸ³ä¹ä¸ºä»€ä¹ˆä¸åœ¨ Deceased è€Œåœ¨ Graveï¼Ÿ

**A**: **èƒŒæ™¯éŸ³ä¹æ˜¯å¢“ä½çš„æ°›å›´åŠŸèƒ½ï¼Œä¸å±äºé€è€…æ¡£æ¡ˆ**ã€‚

ç†ç”±ï¼š
1. éŸ³ä¹æ˜¯ç¯å¢ƒå±æ€§ï¼ˆç±»ä¼¼å°é¢ã€ç¯å…‰ï¼‰ï¼Œå±äºå¢“ä½ç¾åŒ–
2. æ‰€æœ‰é€è€…å…±äº«å¢“ä½çš„èƒŒæ™¯éŸ³ä¹ï¼Œé¿å…å†²çª
3. é€è€…æ¡£æ¡ˆåº”ä¸“æ³¨äº"äººçš„ä¿¡æ¯"ï¼ˆç›¸å†Œã€ç”Ÿå¹³ã€å…³ç³»ï¼‰

å¦‚éœ€ä¸ºé€è€…å•ç‹¬é…éŸ³ä¹ï¼Œå¯åœ¨ deceased::media.rs ä¸­æ·»åŠ  `audio` å­—æ®µã€‚

---

## å…«ã€æ€»ç»“

### æ ¸å¿ƒåŸåˆ™

```
ğŸ›ï¸ Graveï¼ˆå¢“ä½ï¼‰
â”œâ”€â”€ ç®¡ç†"ç©ºé—´"å’Œ"å‡†å…¥è§„åˆ™"
â”œâ”€â”€ æä¾›ç¤¾äº¤åŠŸèƒ½ï¼ˆå…³æ³¨ã€æˆå‘˜ï¼‰
â””â”€â”€ æ‰¿è½½ç¾åŒ–åŠŸèƒ½ï¼ˆå°é¢ã€éŸ³ä¹ã€è½®æ’­å›¾ï¼‰

ğŸ‘¤ Deceasedï¼ˆé€è€…ï¼‰
â”œâ”€â”€ ç®¡ç†"äººçš„æ•°å­—èº«ä»½"
â”œâ”€â”€ æä¾›å†…å®¹åŠŸèƒ½ï¼ˆç”Ÿå¹³ã€ç•™è¨€ã€ç›¸å†Œï¼‰
â””â”€â”€ ç»´æŠ¤å…³ç³»ç½‘ç»œï¼ˆå®¶æ—ã€äº²å‹ï¼‰

ğŸ Memorialï¼ˆçºªå¿µæœåŠ¡ï¼‰
â”œâ”€â”€ ç»Ÿä¸€ä¾›å¥‰/ç¥­ç¥€å…¥å£
â”œâ”€â”€ æŠ½è±¡å¤šåŸŸç›®æ ‡ï¼ˆGrave/Pet/Park/Memorialï¼‰
â””â”€â”€ è§¦å‘èµ„é‡‘åˆ†è´¦ï¼ˆè”ç›Ÿè¥é”€ï¼‰
```

### è®¾è®¡ä¼˜åŠ¿

1. âœ… **èŒè´£æ¸…æ™°**ï¼šGrave ç®¡å¢“ä½ï¼ŒDeceased ç®¡æ¡£æ¡ˆï¼ŒMemorial ç®¡ä¾›å¥‰
2. âœ… **ä½è€¦åˆ**ï¼šé€šè¿‡ trait è§£è€¦ï¼Œæ˜“äºæ‰©å±•
3. âœ… **æ•°æ®ä¸€è‡´æ€§**ï¼šåŒå‘åŒæ­¥æœºåˆ¶ç¡®ä¿å­˜å‚¨åŒæ­¥
4. âœ… **å‰ç«¯å‹å¥½**ï¼šæ¸…æ™°çš„æ•°æ®æµå‘ï¼Œæ˜“äºæ„å»º UI
5. âœ… **å¯æ‰©å±•æ€§**ï¼šä¾›å¥‰ç³»ç»Ÿæ”¯æŒå¤šåŸŸæ‰©å±•ï¼ˆPet/Park/Memorialï¼‰

---

**æ–‡æ¡£ç»´æŠ¤**: å¦‚æœ‰ç–‘é—®æˆ–éœ€è¦è¡¥å……ï¼Œè¯·æ›´æ–°æœ¬æ–‡æ¡£å¹¶åŒæ­¥å›¢é˜Ÿã€‚
