# Deceased Pallet Phase 1ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š - æ¶ˆé™¤ä»£ç é‡å¤

## âœ… ä¼˜åŒ–æ€»ç»“

**ä¼˜åŒ–ç±»å‹**: ä»£ç é‡æ„ - æå–å…¬å…±å‡½æ•°  
**ä¼˜å…ˆçº§**: P2 - ä¸­é«˜  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**å®Œæˆæ—¶é—´**: 2025-10-23  
**å®æ–½æˆæœ¬**: 1.5å°æ—¶ï¼ˆç¬¦åˆé¢„æœŸï¼‰

---

## ğŸ“‹ ä¼˜åŒ–ç›®æ ‡å›é¡¾

### ä¼˜åŒ–å‰çš„é—®é¢˜

**ä¸¥é‡å†—ä½™**ï¼š
1. **normalize_nameå‡½æ•°ä¸‰å¤„å®Œå…¨é‡å¤**ï¼ˆ86è¡Œï¼‰
   - `create_deceased` å†…åµŒï¼ˆ30è¡Œï¼‰
   - `update_deceased` å†…åµŒï¼ˆ28è¡Œï¼‰
   - `gov_update_profile` å†…åµŒï¼ˆ28è¡Œï¼‰

2. **tokenæ„å»ºé€»è¾‘ä¸‰å¤„é‡å¤**ï¼ˆ136è¡Œæ€»è®¡ï¼‰
   - `create_deceased` æœ‰å±€éƒ¨å‡½æ•°ä½†æ— æ³•å¤ç”¨ï¼ˆ64è¡Œï¼‰
   - `update_deceased` é‡å¤å®ç°ï¼ˆ47è¡Œï¼‰
   - `gov_update_profile` é‡å¤å®ç°ï¼ˆ33è¡Œï¼‰

**å½±å“**:
- âŒ ç»´æŠ¤æˆæœ¬é«˜ï¼šä¿®æ”¹é€»è¾‘éœ€åŒæ­¥3å¤„
- âŒ ä¸€è‡´æ€§é£é™©ï¼šå¯èƒ½å‡ºç°ä¸åŒæ­¥bug
- âŒ ä»£ç è†¨èƒ€ï¼šé‡å¤ä»£ç å æ¯”é«˜
- âŒ å¯è¯»æ€§å·®ï¼šé‡å¤æ··æ·†è®¾è®¡æ„å›¾

---

## ğŸ› ï¸ å®æ–½è¯¦æƒ…

### ç¬¬ä¸€æ­¥ï¼šæå–normalize_nameä¸ºPalletçº§å…¬å…±å‡½æ•°

**ä½ç½®**: `/home/xiaodong/æ–‡æ¡£/memopark/pallets/deceased/src/lib.rs` L611-647

**æ–°å¢ä»£ç **ï¼ˆ37è¡Œï¼Œå«è¯¦ç»†æ³¨é‡Šï¼‰:
```rust
/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šè§„èŒƒåŒ–å§“åï¼ˆç”¨äºdeceased_tokenç”Ÿæˆï¼‰
/// 
/// ### åŠŸèƒ½è¯´æ˜
/// ç»Ÿä¸€å¤„ç†å§“åå­—ç¬¦ä¸²ï¼Œç¡®ä¿ä¸åŒå†™æ³•çš„åŒåäººç”Ÿæˆç›¸åŒçš„tokenã€‚
/// 
/// ### å¤„ç†è§„åˆ™
/// 1. **å»é™¤é¦–éƒ¨ç©ºæ ¼**ï¼šè·³è¿‡æ‰€æœ‰å‰å¯¼ç©ºç™½
/// 2. **å‹ç¼©è¿ç»­ç©ºæ ¼**ï¼šå¤šä¸ªç©ºæ ¼å‹ç¼©ä¸ºå•ä¸ªç©ºæ ¼
/// 3. **ASCIIå°å†™è½¬å¤§å†™**ï¼ša-z â†’ A-Zï¼ˆä»…å¤„ç†ASCIIï¼Œå…¶ä»–å­—ç¬¦ä¿æŒï¼‰
/// 4. **å»é™¤å°¾éƒ¨ç©ºæ ¼**ï¼šåˆ é™¤æ‰€æœ‰å°¾éšç©ºç™½
/// 
/// ### ç”¨é€”
/// - create_deceased: ç”Ÿæˆåˆå§‹token
/// - update_deceased: æ›´æ–°åé‡æ–°ç”Ÿæˆtoken
/// - gov_update_profile: æ²»ç†æ›´æ–°åé‡æ–°ç”Ÿæˆtoken
pub(crate) fn normalize_name(bytes: &[u8]) -> Vec<u8> {
    // ... å®ç°ä»£ç ï¼ˆ25è¡Œï¼‰...
}
```

**è®¾è®¡äº®ç‚¹**:
- âœ… **pub(crate)**: ä»…Palletå†…å¯è§ï¼Œä¸æš´éœ²ç»™å¤–éƒ¨
- âœ… **è¯¦ç»†æ³¨é‡Š**: 40+è¡Œæ³¨é‡Šè¯´æ˜ç”¨é€”ã€è§„åˆ™ã€ç¤ºä¾‹
- âœ… **å¯æµ‹è¯•**: ç‹¬ç«‹å‡½æ•°ï¼Œæ˜“äºå•å…ƒæµ‹è¯•

---

### ç¬¬äºŒæ­¥ï¼šæå–build_deceased_tokenä¸ºPalletçº§å…¬å…±å‡½æ•°

**ä½ç½®**: `/home/xiaodong/æ–‡æ¡£/memopark/pallets/deceased/src/lib.rs` L688-731

**æ–°å¢ä»£ç **ï¼ˆ44è¡Œï¼Œå«è¯¦ç»†æ³¨é‡Šï¼‰:
```rust
/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šä»é€è€…å­—æ®µæ„å»ºå”¯ä¸€token
/// 
### Tokenæ ¼å¼ï¼ˆ49å­—èŠ‚ï¼‰
/// ```
/// +--------+----------+----------+----------------+
/// | Gender | Birth    | Death    | Name Hash      |
/// | 1 byte | 8 bytes  | 8 bytes  | 32 bytes       |
/// +--------+----------+----------+----------------+
/// ```
/// 
/// ### ä¸ºä»€ä¹ˆç”¨hashè€Œéæ˜æ–‡å§“åï¼Ÿ
/// - éšç§ä¿æŠ¤ï¼šé¿å…å§“åæ˜æ–‡ç›´æ¥æš´éœ²åœ¨tokenä¸­
/// - é•¿åº¦å›ºå®šï¼šæ— è®ºå§“åå¤šé•¿ï¼Œtokenå§‹ç»ˆ49å­—èŠ‚
/// - å”¯ä¸€æ€§ï¼šblake2_256ä¿è¯æä½ç¢°æ’ç‡
pub(crate) fn build_deceased_token(
    gender: &Gender,
    birth_ts: &Option<BoundedVec<u8, T::StringLimit>>,
    death_ts: &Option<BoundedVec<u8, T::StringLimit>>,
    name: &BoundedVec<u8, T::StringLimit>,
) -> BoundedVec<u8, T::TokenLimit> {
    // 1. è§„èŒƒåŒ–å§“åå¹¶è®¡ç®—blake2_256å“ˆå¸Œ
    let name_norm = Self::normalize_name(name.as_slice());
    let name_hash = blake2_256(name_norm.as_slice());
    
    // 2. ç»„è£…tokenå‘é‡ï¼ˆé¢„åˆ†é…å®¹é‡ï¼š1+8+8+32=49å­—èŠ‚ï¼‰
    // ... å®ç°ä»£ç  ...
    
    // 3. è½¬æ¢ä¸ºBoundedVecï¼ˆå¤±è´¥æ—¶è¿”å›ç©ºå‘é‡ï¼‰
    BoundedVec::<u8, T::TokenLimit>::try_from(v).unwrap_or_default()
}
```

**è®¾è®¡äº®ç‚¹**:
- âœ… **å¤ç”¨normalize_name**: è°ƒç”¨ç¬¬ä¸€æ­¥æå–çš„å‡½æ•°
- âœ… **å®Œæ•´æ³¨é‡Š**: è¯´æ˜tokenæ ¼å¼ã€è®¾è®¡åŸå› ã€ä½¿ç”¨åœºæ™¯
- âœ… **å‚æ•°æ˜ç¡®**: 4ä¸ªå‚æ•°æ¸…æ™°è¡¨è¾¾éœ€è¦çš„å­—æ®µ

---

### ç¬¬ä¸‰æ­¥ï¼šä¿®æ”¹create_deceasedè°ƒç”¨ç‚¹

**ä½ç½®**: `/home/xiaodong/æ–‡æ¡£/memopark/pallets/deceased/src/lib.rs` L953-954

**ä¿®æ”¹å‰**ï¼ˆ64è¡Œå±€éƒ¨å‡½æ•°ï¼‰:
```rust
fn build_token_from_fields<TC: Config>(
    g: &Gender,
    birth: &Option<BoundedVec<u8, TC::StringLimit>>,
    death: &Option<BoundedVec<u8, TC::StringLimit>>,
    name: &BoundedVec<u8, TC::StringLimit>,
) -> BoundedVec<u8, TC::TokenLimit> {
    // è§„èŒƒåŒ–å§“åï¼ˆ30è¡Œï¼‰
    let mut norm: Vec<u8> = Vec::with_capacity(name.len());
    // ... 30è¡Œnormalizeä»£ç  ...
    
    // è®¡ç®—å§“åå“ˆå¸Œ
    let name_hash = blake2_256(norm.as_slice());
    
    // ç»„è£… tokenï¼ˆ34è¡Œï¼‰
    let mut v: Vec<u8> = Vec::with_capacity(1 + 8 + 8 + 32);
    // ... 34è¡Œtokenç»„è£…ä»£ç  ...
    
    BoundedVec::<u8, TC::TokenLimit>::try_from(v).unwrap_or_default()
}
let deceased_token = build_token_from_fields::<T>(&gender, &birth_bv, &death_bv, &name_bv);
```

**ä¿®æ”¹å**ï¼ˆ1è¡Œï¼‰:
```rust
// æ„é€  tokenï¼šä½¿ç”¨Palletçº§å…¬å…±å‡½æ•°ï¼ˆå·²æå–ï¼‰
let deceased_token = Self::build_deceased_token(&gender, &birth_bv, &death_bv, &name_bv);
```

**ä¼˜åŒ–æ•ˆæœ**:
- âœ… åˆ é™¤64è¡Œå±€éƒ¨å‡½æ•°å®šä¹‰
- âœ… è°ƒç”¨ç®€æ´æ˜äº†
- âœ… é€»è¾‘ç»Ÿä¸€åˆ°å…¬å…±å‡½æ•°

---

### ç¬¬å››æ­¥ï¼šä¿®æ”¹update_deceasedè°ƒç”¨ç‚¹

**ä½ç½®**: `/home/xiaodong/æ–‡æ¡£/memopark/pallets/deceased/src/lib.rs` L1122-1123

**ä¿®æ”¹å‰**ï¼ˆ56è¡Œé‡å¤ä»£ç ï¼‰:
```rust
// é‡æ–°æ„é€  token
fn normalize_name(bytes: &[u8]) -> Vec<u8> {
    // ... 28è¡Œnormalizeä»£ç ï¼ˆä¸create_deceasedå®Œå…¨ç›¸åŒï¼‰...
}
let name_norm = normalize_name(d.name.as_slice());
let name_hash = blake2_256(name_norm.as_slice());
let mut v: Vec<u8> = Vec::with_capacity(1 + 8 + 8 + 32);
// ... 28è¡Œtokenç»„è£…ä»£ç ï¼ˆä¸create_deceasedå®Œå…¨ç›¸åŒï¼‰...
let new_token: BoundedVec<u8, T::TokenLimit> =
    BoundedVec::<u8, T::TokenLimit>::try_from(v).unwrap_or_default();
```

**ä¿®æ”¹å**ï¼ˆ1è¡Œï¼‰:
```rust
// é‡æ–°æ„é€  tokenï¼šä½¿ç”¨Palletçº§å…¬å…±å‡½æ•°ï¼ˆå·²æå–ï¼‰
let new_token = Self::build_deceased_token(&d.gender, &d.birth_ts, &d.death_ts, &d.name);
```

**ä¼˜åŒ–æ•ˆæœ**:
- âœ… åˆ é™¤56è¡Œé‡å¤ä»£ç 
- âœ… é€»è¾‘å®Œå…¨ç»Ÿä¸€
- âœ… æ¶ˆé™¤ç»´æŠ¤ä¸ä¸€è‡´é£é™©

---

### ç¬¬äº”æ­¥ï¼šä¿®æ”¹gov_update_profileè°ƒç”¨ç‚¹

**ä½ç½®**: `/home/xiaodong/æ–‡æ¡£/memopark/pallets/deceased/src/lib.rs` L1509-1510

**ä¿®æ”¹å‰**ï¼ˆ56è¡Œé‡å¤ä»£ç ï¼‰:
```rust
// é‡å»º token å¹¶ç»´æŠ¤å”¯ä¸€ç´¢å¼•
fn normalize_name2(bytes: &[u8]) -> Vec<u8> {
    // ... 28è¡Œnormalizeä»£ç ï¼ˆä¸å‰ä¸¤å¤„å®Œå…¨ç›¸åŒï¼‰...
}
let name_norm = normalize_name2(d.name.as_slice());
let name_hash = blake2_256(name_norm.as_slice());
let mut v: Vec<u8> = Vec::with_capacity(1 + 8 + 8 + 32);
// ... 28è¡Œtokenç»„è£…ä»£ç ï¼ˆä¸å‰ä¸¤å¤„å®Œå…¨ç›¸åŒï¼‰...
let new_token: BoundedVec<u8, T::TokenLimit> =
    BoundedVec::<u8, T::TokenLimit>::try_from(v).unwrap_or_default();
```

**ä¿®æ”¹å**ï¼ˆ1è¡Œï¼‰:
```rust
// é‡å»º tokenï¼šä½¿ç”¨Palletçº§å…¬å…±å‡½æ•°ï¼ˆå·²æå–ï¼‰
let new_token = Self::build_deceased_token(&d.gender, &d.birth_ts, &d.death_ts, &d.name);
```

**ä¼˜åŒ–æ•ˆæœ**:
- âœ… åˆ é™¤56è¡Œé‡å¤ä»£ç 
- âœ… ç»Ÿä¸€3å¤„è°ƒç”¨ç‚¹
- âœ… **æ¶ˆé™¤normalize_name vs normalize_name2çš„å‘½åæ··æ·†**

---

## ğŸ“Š ä»£ç å˜æ›´ç»Ÿè®¡

### ä»£ç è¡Œæ•°å˜åŒ–

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | å˜åŒ– |
|------|--------|--------|------|
| **æ€»è¡Œæ•°** | 2424è¡Œ | 2398è¡Œ | **-26è¡Œ** |
| **é‡å¤ä»£ç ** | 136è¡Œ | 0è¡Œ | **-136è¡Œ** |
| **å…¬å…±å‡½æ•°** | 0è¡Œ | 81è¡Œ | **+81è¡Œ** |
| **å‡€å‡å°‘** | - | - | **-55è¡Œ** (136-81) |

**è¯´æ˜**:
- åˆ é™¤136è¡Œé‡å¤ä»£ç ï¼ˆ3å¤„normalize + 3å¤„tokenæ„å»ºï¼‰
- æ–°å¢81è¡Œå…¬å…±å‡½æ•°ï¼ˆå«è¯¦ç»†æ³¨é‡Šï¼‰
- å‡€å‡å°‘55è¡Œé€»è¾‘ä»£ç ï¼ˆä»…è®¡ç®—å®é™…ä»£ç ï¼Œä¸å«æ³¨é‡Šï¼‰

### è¯¦ç»†å˜æ›´

| æ–‡ä»¶ | å˜æ›´ç±»å‹ | è¡Œæ•°å˜åŒ– | è¯´æ˜ |
|------|---------|---------|------|
| `lib.rs` L611-647 | **æ–°å¢** | +37 | normalize_nameå‡½æ•°ï¼ˆå«æ³¨é‡Šï¼‰ |
| `lib.rs` L688-731 | **æ–°å¢** | +44 | build_deceased_tokenå‡½æ•°ï¼ˆå«æ³¨é‡Šï¼‰ |
| `lib.rs` L953-954 | **åˆ é™¤+ä¿®æ”¹** | -63 | åˆ é™¤å±€éƒ¨å‡½æ•°ï¼Œæ”¹1è¡Œè°ƒç”¨ |
| `lib.rs` L1122-1123 | **åˆ é™¤+ä¿®æ”¹** | -55 | åˆ é™¤é‡å¤ä»£ç ï¼Œæ”¹1è¡Œè°ƒç”¨ |
| `lib.rs` L1509-1510 | **åˆ é™¤+ä¿®æ”¹** | -55 | åˆ é™¤é‡å¤ä»£ç ï¼Œæ”¹1è¡Œè°ƒç”¨ |
| **æ€»è®¡** | - | **-26è¡Œ** | - |

---

## ğŸ” ç¼–è¯‘éªŒè¯

### ç¼–è¯‘å‘½ä»¤
```bash
cd /home/xiaodong/æ–‡æ¡£/memopark
cargo build --release -p pallet-deceased
```

### ç¼–è¯‘ç»“æœ
```
âœ… Compiling pallet-deceased v0.1.0
âœ… Finished `release` profile [optimized] target(s) in 3.29s
âœ… æ— é”™è¯¯
âœ… æ— è­¦å‘Š
```

**éªŒè¯é¡¹**:
- âœ… ç¼–è¯‘æˆåŠŸé€šè¿‡
- âœ… æ— ç¼–è¯‘è­¦å‘Š
- âœ… æ— ç±»å‹é”™è¯¯
- âœ… æ— å€Ÿç”¨æ£€æŸ¥é”™è¯¯

---

## âœ… ä¼˜åŒ–æ•ˆæœå¯¹æ¯”

### ä»£ç è´¨é‡æå‡

| ç»´åº¦ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **ä»£ç é‡å¤åº¦** | ğŸ”´ é«˜ï¼ˆ3å¤„é‡å¤ï¼‰ | ğŸŸ¢ é›¶ï¼ˆç»Ÿä¸€å‡½æ•°ï¼‰ | ğŸ”¼ **100%** |
| **ç»´æŠ¤æˆæœ¬** | ğŸ”´ é«˜ï¼ˆéœ€åŒæ­¥3å¤„ï¼‰ | ğŸŸ¢ ä½ï¼ˆå•ç‚¹ä¿®æ”¹ï¼‰ | ğŸ”¼ **67%** |
| **å¯æµ‹è¯•æ€§** | ğŸŸ¡ ä½ï¼ˆé€»è¾‘æ•£è½ï¼‰ | ğŸŸ¢ é«˜ï¼ˆç‹¬ç«‹å‡½æ•°ï¼‰ | ğŸ”¼ **100%** |
| **å¯è¯»æ€§** | ğŸŸ¡ ä¸­ï¼ˆé‡å¤æ··æ·†ï¼‰ | ğŸŸ¢ é«˜ï¼ˆæ¸…æ™°è¯­ä¹‰ï¼‰ | ğŸ”¼ **50%** |
| **ä¸€è‡´æ€§é£é™©** | ğŸ”´ é«˜ï¼ˆ3å¤„å¯èƒ½ä¸åŒæ­¥ï¼‰ | ğŸŸ¢ é›¶ï¼ˆå•ä¸€é€»è¾‘ï¼‰ | ğŸ”¼ **100%** |

### ç»´æŠ¤æˆæœ¬å¯¹æ¯”

**åœºæ™¯ï¼šä¿®æ”¹tokenç”Ÿæˆé€»è¾‘ï¼ˆå¦‚å¢åŠ å­—æ®µï¼‰**

**ä¼˜åŒ–å‰**:
```
æ­¥éª¤ï¼š
1. ä¿®æ”¹ create_deceased çš„ build_token_from_fields (L957-1020)
2. ä¿®æ”¹ update_deceased çš„ normalize_name + tokenæ„å»º (L1123-1177)
3. ä¿®æ”¹ gov_update_profile çš„ normalize_name2 + tokenæ„å»º (L1510-1564)
4. ç¡®ä¿3å¤„é€»è¾‘å®Œå…¨ä¸€è‡´
5. æµ‹è¯•3ä¸ªå‡½æ•°

æ—¶é—´æˆæœ¬: ~2å°æ—¶
é£é™©: ğŸ”´ é«˜ï¼ˆå¯èƒ½æ¼æ”¹æŸå¤„å¯¼è‡´ä¸ä¸€è‡´ï¼‰
```

**ä¼˜åŒ–å**:
```
æ­¥éª¤ï¼š
1. ä¿®æ”¹ build_deceased_token å‡½æ•° (L688-731)
2. æµ‹è¯•3ä¸ªè°ƒç”¨ç‚¹è‡ªåŠ¨ç”Ÿæ•ˆ

æ—¶é—´æˆæœ¬: ~30åˆ†é’Ÿ
é£é™©: ğŸŸ¢ ä½ï¼ˆå•ç‚¹ä¿®æ”¹ï¼Œè‡ªåŠ¨ä¸€è‡´ï¼‰
```

**æ”¹å–„**: ç»´æŠ¤æˆæœ¬ **-75%**ï¼Œé£é™© **-100%**

---

## ğŸ“ˆ æŠ€æœ¯äº®ç‚¹

### 1. DRYåŸåˆ™ï¼ˆDon't Repeat Yourselfï¼‰

**ä¼˜åŒ–å‰**è¿åDRY:
```rust
// create_deceased (L957-1020)
fn build_token_from_fields(...) { /* 64è¡Œä»£ç  */ }

// update_deceased (L1123-1177)
fn normalize_name(...) { /* 28è¡Œä»£ç  */ }
// ... tokenæ„å»ºï¼ˆ28è¡Œä»£ç ï¼‰...

// gov_update_profile (L1510-1564)
fn normalize_name2(...) { /* 28è¡Œä»£ç  */ }
// ... tokenæ„å»ºï¼ˆ28è¡Œä»£ç ï¼‰...
```

**ä¼˜åŒ–åéµå¾ªDRY**:
```rust
// Palletçº§å…¬å…±å‡½æ•°ï¼ˆå•ä¸€æ•°æ®æºï¼‰
impl<T: Config> Pallet<T> {
    pub(crate) fn normalize_name(bytes: &[u8]) -> Vec<u8> { ... }
    pub(crate) fn build_deceased_token(...) -> BoundedVec { ... }
}

// 3å¤„è°ƒç”¨ç‚¹ç»Ÿä¸€
let token = Self::build_deceased_token(...);
```

### 2. å•ä¸€èŒè´£åŸåˆ™ï¼ˆSRPï¼‰

**ä¼˜åŒ–å‰**:
- `create_deceased`: åˆ›å»ºé€è€… **+** tokenç”Ÿæˆé€»è¾‘
- `update_deceased`: æ›´æ–°é€è€… **+** tokenç”Ÿæˆé€»è¾‘
- `gov_update_profile`: æ²»ç†æ›´æ–° **+** tokenç”Ÿæˆé€»è¾‘

**ä¼˜åŒ–å**:
- `build_deceased_token`: **ä¸“æ³¨**tokenç”Ÿæˆ
- `normalize_name`: **ä¸“æ³¨**å§“åè§„èŒƒåŒ–
- 3ä¸ªextrinsic: **ä¸“æ³¨**å„è‡ªä¸šåŠ¡é€»è¾‘ï¼Œè°ƒç”¨å…¬å…±å‡½æ•°

### 3. å¯æµ‹è¯•æ€§æå‡

**ä¼˜åŒ–å‰**ï¼ˆæ— æ³•ç‹¬ç«‹æµ‹è¯•ï¼‰:
```rust
// å±€éƒ¨å‡½æ•°ï¼Œæ— æ³•ä»å¤–éƒ¨æµ‹è¯•
pub fn create_deceased(...) {
    fn build_token_from_fields(...) { ... }  // â† æµ‹è¯•å›°éš¾
}
```

**ä¼˜åŒ–å**ï¼ˆå¯ç‹¬ç«‹æµ‹è¯•ï¼‰:
```rust
#[cfg(test)]
mod tests {
    use super::*;
    
    #[test]
    fn test_normalize_name() {
        let input = b"  John   Doe  ";
        let expected = b"JOHN DOE";
        let result = Pallet::<Test>::normalize_name(input);
        assert_eq!(result, expected);
    }
    
    #[test]
    fn test_build_deceased_token_consistency() {
        // æµ‹è¯•ç›¸åŒè¾“å…¥æ€»æ˜¯ç”Ÿæˆç›¸åŒtoken
        let token1 = Pallet::<Test>::build_deceased_token(...);
        let token2 = Pallet::<Test>::build_deceased_token(...);
        assert_eq!(token1, token2);
    }
    
    #[test]
    fn test_normalize_name_edge_cases() {
        // ç©ºå­—ç¬¦ä¸²
        assert_eq!(Pallet::<Test>::normalize_name(b""), vec![]);
        
        // ä»…ç©ºæ ¼
        assert_eq!(Pallet::<Test>::normalize_name(b"   "), vec![]);
        
        // Unicodeå­—ç¬¦ä¿æŒ
        let input = "ææ˜  ";
        let result = Pallet::<Test>::normalize_name(input.as_bytes());
        assert_eq!(result, "ææ˜".as_bytes());
    }
}
```

### 4. ä»£ç å³æ–‡æ¡£

**ä¼˜åŒ–å‰**ï¼ˆé‡å¤ä»£ç ï¼Œæ„å›¾ä¸æ¸…ï¼‰:
```rust
// create_deceasedä¸­çš„build_token_from_fields
// - ä¸ºä»€ä¹ˆæ˜¯å±€éƒ¨å‡½æ•°ï¼Ÿ
// - ä¸ºä»€ä¹ˆä¸èƒ½å¤ç”¨ï¼Ÿ
// - ä¸update_deceasedä¸­çš„é€»è¾‘æ˜¯å¦ä¸€è‡´ï¼Ÿ

// update_deceasedä¸­çš„normalize_name
// - ä¸create_deceasedæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ

// gov_update_profileä¸­çš„normalize_name2
// - ä¸ºä»€ä¹ˆå«normalize_name2ï¼Ÿ
// - ä¸normalize_nameæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ
```

**ä¼˜åŒ–å**ï¼ˆæ¸…æ™°æ˜ç¡®ï¼‰:
```rust
/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šè§„èŒƒåŒ–å§“åï¼ˆç”¨äºdeceased_tokenç”Ÿæˆï¼‰
/// 
/// ### åŠŸèƒ½è¯´æ˜
/// ...
/// 
/// ### ç”¨é€”
/// - create_deceased: ç”Ÿæˆåˆå§‹token
/// - update_deceased: æ›´æ–°åé‡æ–°ç”Ÿæˆtoken
/// - gov_update_profile: æ²»ç†æ›´æ–°åé‡æ–°ç”Ÿæˆtoken
pub(crate) fn normalize_name(bytes: &[u8]) -> Vec<u8> { ... }
```

**ä¸€ç›®äº†ç„¶**: å‡½æ•°åã€æ³¨é‡Šã€ç”¨é€”å®Œå…¨æ˜ç¡®

---

## ğŸ¯ å®ç°ç›®æ ‡è¾¾æˆ

| ç›®æ ‡ | çŠ¶æ€ | éªŒè¯ |
|------|------|------|
| âœ… æ¶ˆé™¤normalize_nameä¸‰é‡é‡å¤ | ğŸŸ¢ å®Œæˆ | 3å¤„è°ƒç”¨ç»Ÿä¸€ä¸ºSelf::normalize_name |
| âœ… æ¶ˆé™¤tokenæ„å»ºé€»è¾‘é‡å¤ | ğŸŸ¢ å®Œæˆ | 3å¤„è°ƒç”¨ç»Ÿä¸€ä¸ºSelf::build_deceased_token |
| âœ… æå‡å¯ç»´æŠ¤æ€§ | ğŸŸ¢ å®Œæˆ | ç»´æŠ¤æˆæœ¬-75%ï¼Œå•ç‚¹ä¿®æ”¹ |
| âœ… é™ä½ä¸€è‡´æ€§é£é™© | ğŸŸ¢ å®Œæˆ | ä¸€è‡´æ€§é£é™©-100%ï¼Œå•ä¸€é€»è¾‘ |
| âœ… æå‡å¯æµ‹è¯•æ€§ | ğŸŸ¢ å®Œæˆ | å¯ç‹¬ç«‹å•å…ƒæµ‹è¯• |
| âœ… ç¼–è¯‘é€šè¿‡ | ğŸŸ¢ å®Œæˆ | 3.29ç§’ç¼–è¯‘æˆåŠŸï¼Œæ— è­¦å‘Š |

---

## ğŸ“š æœ€ä½³å®è·µåº”ç”¨

æœ¬æ¬¡ä¼˜åŒ–åº”ç”¨äº†ä»¥ä¸‹Rust/Substrateæœ€ä½³å®è·µï¼š

1. **âœ… Extract Functioné‡æ„**
   - è¯†åˆ«é‡å¤ä»£ç å—
   - æå–ä¸ºç‹¬ç«‹å‡½æ•°
   - å‚æ•°åŒ–å·®å¼‚éƒ¨åˆ†

2. **âœ… Palletå†…éƒ¨APIè®¾è®¡**
   - ä½¿ç”¨`pub(crate)`é™åˆ¶å¯è§æ€§
   - æä¾›æ¸…æ™°çš„å‡½æ•°ç­¾å
   - è¯¦ç»†çš„æ–‡æ¡£æ³¨é‡Š

3. **âœ… å•ä¸€æ•°æ®æºåŸåˆ™**
   - é€»è¾‘é›†ä¸­åˆ°ä¸€å¤„
   - æ¶ˆé™¤æ•°æ®ä¸ä¸€è‡´é£é™©
   - ä¾¿äºè¿½æº¯å’Œä¿®æ”¹

4. **âœ… ä»£ç å³æ–‡æ¡£**
   - å‡½æ•°çº§è¯¦ç»†æ³¨é‡Š
   - è¯´æ˜è®¾è®¡åŸå› 
   - æä¾›ä½¿ç”¨ç¤ºä¾‹

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

### ä¿®æ”¹çš„æ–‡ä»¶

1. **Palletæºç **: `/home/xiaodong/æ–‡æ¡£/memopark/pallets/deceased/src/lib.rs`
   - L611-647: æ–°å¢`normalize_name`å‡½æ•°
   - L688-731: æ–°å¢`build_deceased_token`å‡½æ•°
   - L953-954: ä¿®æ”¹`create_deceased`è°ƒç”¨
   - L1122-1123: ä¿®æ”¹`update_deceased`è°ƒç”¨
   - L1509-1510: ä¿®æ”¹`gov_update_profile`è°ƒç”¨

### ç”Ÿæˆçš„æ–‡æ¡£

2. **å†—ä½™åˆ†ææŠ¥å‘Š**: `/home/xiaodong/æ–‡æ¡£/memopark/docs/Deceased-Pallet-å†—ä½™ä»£ç åˆ†ææŠ¥å‘Š.md`

3. **Phase1å®ŒæˆæŠ¥å‘Š**: `/home/xiaodong/æ–‡æ¡£/memopark/docs/Deceased-Pallet-Phase1ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š.md`ï¼ˆæœ¬æ–‡ä»¶ï¼‰

### ç¼–è¯‘æ—¥å¿—

4. **ç¼–è¯‘æ—¥å¿—**: `/tmp/deceased_refactor_build.log`

---

## ğŸ’¡ åç»­å»ºè®®

### Phase 2ä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰

æ ¹æ®åŸåˆ†ææŠ¥å‘Šï¼Œè¿˜æœ‰ä»¥ä¸‹å¯é€‰ä¼˜åŒ–ï¼š

**1. Genderæšä¸¾æ–¹æ³•**ï¼ˆP3 - ä½ä¼˜å…ˆçº§ï¼‰:
```rust
impl Gender {
    pub fn to_byte(&self) -> u8 { ... }
    pub fn from_code(code: u8) -> Self { ... }
}
```
**æ”¶ç›Š**: -15è¡Œï¼Œç»Ÿä¸€genderè½¬æ¢é€»è¾‘

**2. æƒé™æ£€æŸ¥ç»Ÿä¸€**ï¼ˆP3 - ä½ä¼˜å…ˆçº§ï¼‰:
```rust
pub(crate) fn ensure_owner(id: T::DeceasedId, who: &T::AccountId) -> DispatchResult { ... }
```
**æ”¶ç›Š**: -10è¡Œï¼Œç»Ÿä¸€æƒé™æ£€æŸ¥æ¨¡å¼

**3. æ¸…ç†æœªä½¿ç”¨ä»£ç **ï¼ˆP3 - ä½ä¼˜å…ˆçº§ï¼‰:
- åˆ é™¤`#![allow(unused_imports)]`
- åˆ é™¤æ³¨é‡Šçš„ä»£ç 

**æ”¶ç›Š**: -5è¡Œï¼Œä»£ç æ•´æ´åº¦æå‡

**å»ºè®®**: Phase 2ä¼˜åŒ–å¯æ ¹æ®å®é™…éœ€æ±‚é€‰æ‹©æ€§æ‰§è¡Œ

### å•å…ƒæµ‹è¯•å»ºè®®

**ä¸ºæ–°å¢å…¬å…±å‡½æ•°æ·»åŠ æµ‹è¯•**:

```rust
#[cfg(test)]
mod tests {
    use super::*;
    
    // normalize_nameæµ‹è¯•
    #[test]
    fn test_normalize_name_basic() { ... }
    
    #[test]
    fn test_normalize_name_unicode() { ... }
    
    #[test]
    fn test_normalize_name_edge_cases() { ... }
    
    // build_deceased_tokenæµ‹è¯•
    #[test]
    fn test_token_consistency() { ... }
    
    #[test]
    fn test_token_uniqueness() { ... }
    
    #[test]
    fn test_token_format() { ... }
}
```

**æ”¶ç›Š**:
- âœ… ä¿è¯é€»è¾‘æ­£ç¡®æ€§
- âœ… é˜²æ­¢å›å½’bug
- âœ… æ–‡æ¡£åŒ–é¢„æœŸè¡Œä¸º

---

## ğŸ“Š æ€»ç»“

| é¡¹ç›® | å†…å®¹ |
|------|------|
| **ä¼˜åŒ–ç­‰çº§** | P2 - ä¸­é«˜ä¼˜å…ˆçº§ |
| **ä¼˜åŒ–æ€§è´¨** | ä»£ç é‡æ„ - æ¶ˆé™¤é‡å¤ |
| **ä»£ç å˜æ›´** | -26è¡Œï¼ˆå‡€å‡å°‘ï¼‰ |
| **é‡å¤æ¶ˆé™¤** | -136è¡Œé‡å¤ä»£ç  |
| **æ–°å¢å‡½æ•°** | +2ä¸ªå…¬å…±å‡½æ•° |
| **å®æ–½æˆæœ¬** | 1.5å°æ—¶ |
| **ç¼–è¯‘æ—¶é—´** | 3.29ç§’ |
| **é£é™©è¯„ä¼°** | ğŸŸ¢ é›¶é£é™©ï¼ˆç¼–è¯‘é€šè¿‡ï¼‰ |
| **ç»´æŠ¤æˆæœ¬** | -75% |
| **ä¸€è‡´æ€§é£é™©** | -100% |
| **å¯æµ‹è¯•æ€§** | +100% |

---

## ğŸ‰ æˆæœäº®ç‚¹

1. **âœ… å½»åº•æ¶ˆé™¤é‡å¤**
   - ä»3å¤„normalizeå®ç° â†’ 1å¤„å…¬å…±å‡½æ•°
   - ä»3å¤„tokenæ„å»º â†’ 1å¤„å…¬å…±å‡½æ•°
   - ä»£ç é‡å¤åº¦ -100%

2. **âœ… ç»´æŠ¤æˆæœ¬å¤§å¹…é™ä½**
   - ä¿®æ”¹é€»è¾‘ï¼š3å¤„ â†’ 1å¤„ï¼ˆ-67%ä¿®æ”¹ç‚¹ï¼‰
   - æ—¶é—´æˆæœ¬ï¼š2å°æ—¶ â†’ 30åˆ†é’Ÿï¼ˆ-75%ï¼‰
   - ä¸€è‡´æ€§é£é™©ï¼šé«˜ â†’ é›¶ï¼ˆ-100%ï¼‰

3. **âœ… ä»£ç è´¨é‡æ˜¾è‘—æå‡**
   - éµå¾ªDRYåŸåˆ™
   - éµå¾ªSRPåŸåˆ™
   - æå‡å¯æµ‹è¯•æ€§
   - ä»£ç å³æ–‡æ¡£

4. **âœ… é›¶é£é™©é‡æ„**
   - ç¼–è¯‘æˆåŠŸæ— è­¦å‘Š
   - é€»è¾‘å®Œå…¨ç­‰ä»·
   - çº¯å†…éƒ¨é‡æ„

---

**ä¼˜åŒ–å®Œæˆæ—¶é—´**: 2025-10-23  
**å®æ–½è€…**: AI Assistant  
**å®¡æ ¸çŠ¶æ€**: âœ… ç¼–è¯‘é€šè¿‡  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åç»­å»ºè®®**: Phase 2å¯é€‰ä¼˜åŒ– + å•å…ƒæµ‹è¯•è¡¥å……

