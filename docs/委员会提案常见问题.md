# 委员会提案常见问题

## 问题 1: DuplicateProposal 错误

### 错误信息
```
council.DuplicateProposal: Duplicate proposals not allowed
```

### 原因
相同的提案已经存在于活跃提案列表中。提案的唯一性由**提案哈希**决定：
- 调用的 pallet 和方法（如 `marketMaker.approve`）
- 调用的参数（如 `mmId: 0`）

例如：批准做市商 #0 的提案，只能存在一个。

### 解决方案

#### ✅ 已修复（v1.1.0）

最新代码已添加提交前检查，会自动检测重复提案并提示用户。

**修复内容**：
1. 提交前自动检查提案是否已存在
2. 如果存在，显示提案哈希并提示前往提案列表投票
3. 改进错误提示，提供友好的错误信息

#### 临时解决方法

如果你使用的是旧版本代码：

1. **查看现有提案**：
   ```
   访问 #/gov/council-proposals → 提案列表
   ```

2. **查找是否已有相同提案**：
   - 检查是否有针对同一个 mmId 的提案
   - 如果有，直接投票即可，无需重复提交

3. **提交不同的提案**：
   - 选择其他申请编号（不同的 mmId）
   - 或者选择不同的提案类型（批准 vs 驳回）

### 预防措施

1. **提交前查看提案列表**：
   确保没有相同的提案正在进行中

2. **使用提案哈希追踪**：
   每次提交提案后记录提案哈希，避免重复提交

3. **等待现有提案完成**：
   如果提案已存在，等待投票和执行完成后再提交新提案

---

## 问题 2: BadOrigin 错误

### 错误信息
```
council.BadOrigin: Bad origin
```

### 原因
当前账户不是委员会成员，没有权限提交提案或投票。

### 解决方案

1. **检查委员会成员列表**：
   ```typescript
   const api = await getApi()
   const members = await api.query.council.members()
   console.log('委员会成员:', members.toJSON())
   ```

2. **确认当前账户**：
   ```typescript
   const currentUser = getCurrentAddress()
   console.log('当前账户:', currentUser)
   console.log('是否是成员:', members.includes(currentUser))
   ```

3. **添加到委员会**（需要 Sudo 权限）：
   ```typescript
   await api.tx.sudo.sudo(
     api.tx.council.setMembers(
       [...existingMembers, newMember],
       null,
       existingMembers.length
     )
   ).signAndSend(sudoAccount)
   ```

---

## 问题 3: 投票后列表未更新

### 原因
投票交易需要等待区块确认（约 6 秒），前端可能在确认前查询了状态。

### 解决方案

1. **手动刷新**：
   点击"刷新提案列表"按钮

2. **等待确认**：
   投票后等待 6 秒，再查看进度

3. **代码已优化**：
   `signAndSendLocalFromKeystore` 函数会等待交易 Finalized 后才返回

---

## 问题 4: 执行提案失败

### 错误信息
```
council.TooEarly: The close call was made too early
```

### 原因
提案尚未达到投票阈值，或投票期未结束。

### 解决方案

1. **检查投票进度**：
   ```
   赞成票 >= 阈值 才能执行
   例如：阈值=2，需要至少 2 票赞成
   ```

2. **等待更多投票**：
   提醒其他委员会成员投票

3. **查看提案状态**：
   提案列表会显示"可执行"标签，只有显示该标签时才能执行

---

## 问题 5: WrongProposalWeight 错误

### 错误信息
```
council.WrongProposalWeight: The given weight bound for the proposal was too low
```

### 原因
执行提案时提供的 weight bound 不足。

### 解决方案

在 `ProposalList.tsx` 中增加 weight bound：

```typescript
const weightBound = {
  refTime: 10_000_000_000,  // 增加 10 倍
  proofSize: 10000           // 增加 10 倍
}
```

---

## 问题 6: 提案列表为空

### 原因
1. 确实没有活跃提案
2. API 连接失败
3. 查询错误

### 解决方案

1. **检查 API 连接**：
   ```typescript
   const api = await getApi()
   console.log('API 已连接:', api.isConnected)
   ```

2. **手动查询**：
   ```typescript
   const proposals = await api.query.council.proposals()
   console.log('提案数量:', proposals.length)
   ```

3. **提交新提案**：
   如果确实没有提案，可以提交新的提案

---

## 问题 7: 申请列表加载失败

### 错误信息
```
MarketMaker pallet 未注册
```

### 原因
链上未部署 `pallet-market-maker` 或 pallet 名称不匹配。

### 解决方案

1. **检查 Runtime 配置**：
   确保 `pallet-market-maker` 已添加到 Runtime

2. **检查 pallet 名称**：
   ```typescript
   // 检查 pallet 是否存在
   console.log('MarketMaker pallet:', api.query.marketMaker)
   ```

3. **重启节点**：
   如果刚部署了 pallet，需要重启节点

---

## 问题 8: 权限不足无法批准

### 原因
`marketMaker.approve` 和 `reject` 需要 `GovernanceOrigin` 权限（Root 或委员会 2/3 多数）。

### 解决方案

**正确流程**：
1. ❌ 不能直接调用 `marketMaker.approve(mmId)`
2. ✅ 通过委员会提案：
   ```
   提交提案 → 投票 → 执行提案 → 自动调用 approve
   ```

**紧急通道**（仅限 Root）：
```typescript
await api.tx.sudo.sudo(
  api.tx.marketMaker.approve(mmId)
).signAndSend(sudoAccount)
```

---

## 调试技巧

### 1. 查看链上事件

```typescript
// 监听所有事件
api.query.system.events((events) => {
  events.forEach((record) => {
    const { event } = record
    console.log(`${event.section}.${event.method}:`, event.data.toHuman())
  })
})
```

### 2. 查看交易详情

```typescript
// 查看交易状态
const txInfo = await api.query.system.account(address)
console.log('账户信息:', txInfo.toHuman())
```

### 3. 查看提案详情

```typescript
// 查询特定提案
const proposalHash = '0x...'
const proposal = await api.query.council.proposalOf(proposalHash)
const voting = await api.query.council.voting(proposalHash)

console.log('提案内容:', proposal.toHuman())
console.log('投票信息:', voting.toHuman())
```

### 4. 查看委员会状态

```typescript
// 查看委员会成员
const members = await api.query.council.members()
console.log('成员列表:', members.toJSON())

// 查看 Prime 成员
const prime = await api.query.council.prime()
console.log('Prime 成员:', prime.toHuman())

// 查看所有提案
const proposals = await api.query.council.proposals()
console.log('提案数量:', proposals.length)
console.log('提案列表:', proposals.toJSON())
```

---

## 日志分析

### 正常提交流程

```
[提案] 类型: approve
[提案] mmId: 0
[提案] threshold: 2
[提案] length: 11
[提案] hash: 0xabcd1234...
[交易状态] council.propose: Ready
[交易状态] council.propose: InBlock
✓ 交易已打包进区块: 0x3cfc...
[交易状态] council.propose: Finalized
✓ 交易已最终确认: 0x3cfc...
```

### 重复提案错误

```
[提案] 类型: approve
[提案] mmId: 0
[提案] threshold: 2
[提案] length: 11
[交易状态] council.propose: Ready
[交易状态] council.propose: InBlock
✓ 交易已打包进区块: 0x3cfc...
[交易状态] council.propose: Finalized
✓ 交易已最终确认: 0x3cfc...
❌ 本地签名发送失败: Error: council.DuplicateProposal
```

**分析**：交易虽然被打包和确认，但执行失败（链上返回错误）

### 权限不足错误

```
[提案] 类型: approve
[提案] mmId: 0
[提案] threshold: 2
[提案] length: 11
[交易状态] council.propose: Ready
❌ 本地签名发送失败: Error: council.BadOrigin
```

**分析**：交易在提交阶段就被拒绝（权限检查失败）

---

## 更新日志

### v1.1.0 (2025-10-02)
- ✅ 添加提交前重复提案检查
- ✅ 改进错误提示信息
- ✅ 添加提案哈希显示
- ✅ 优化用户体验

### v1.0.0 (2025-10-02)
- ✅ 初始版本
- ✅ 提交提案、投票、执行功能
- ✅ 提案列表和投票记录

---

## 获取帮助

如果以上方案无法解决问题：

1. **查看完整日志**：
   打开浏览器控制台，查看详细错误信息

2. **查看链上状态**：
   使用 Polkadot.js Apps 查看链上数据

3. **检查 Runtime 版本**：
   确保前端和链端版本匹配

4. **联系开发者**：
   提供错误日志和操作步骤

---

**最后更新**: 2025-10-02  
**适用版本**: v1.1.0

