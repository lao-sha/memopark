# Membership Pallet - æœ‰æ•ˆä¼šå‘˜é€»è¾‘è¯¦è§£

**ç‰ˆæœ¬**: v1.0
**æ—¥æœŸ**: 2025-11-10
**æ¨¡å—**: `pallet-membership`
**ä½œè€…**: Claude Code Analysis

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æœ‰æ•ˆä¼šå‘˜çš„æ ¸å¿ƒå®šä¹‰](#ä¸€æœ‰æ•ˆä¼šå‘˜çš„æ ¸å¿ƒå®šä¹‰)
3. [ä¼šå‘˜ç­‰çº§ä½“ç³»](#äºŒä¼šå‘˜ç­‰çº§ä½“ç³»)
4. [ä¼šå‘˜è´­ä¹°æµç¨‹è¯¦è§£](#ä¸‰ä¼šå‘˜è´­ä¹°æµç¨‹è¯¦è§£)
5. [æœ‰æ•ˆä¼šå‘˜éªŒè¯æœºåˆ¶](#å››æœ‰æ•ˆä¼šå‘˜éªŒè¯æœºåˆ¶)
6. [ä¼šå‘˜å‡çº§æœºåˆ¶](#äº”ä¼šå‘˜å‡çº§æœºåˆ¶)
7. [åŠ¨æ€ä»£æ•°å¢é•¿æœºåˆ¶](#å…­åŠ¨æ€ä»£æ•°å¢é•¿æœºåˆ¶)
8. [ä¼šå‘˜æŠ˜æ‰£æœºåˆ¶](#ä¸ƒä¼šå‘˜æŠ˜æ‰£æœºåˆ¶)
9. [ä¸è”ç›Ÿè®¡é…¬ç³»ç»Ÿçš„é›†æˆ](#å…«ä¸è”ç›Ÿè®¡é…¬ç³»ç»Ÿçš„é›†æˆ)
10. [å®Œæ•´ä»£ç åˆ†æ](#ä¹å®Œæ•´ä»£ç åˆ†æ)
11. [å­˜å‚¨ç»“æ„ä¸æ•°æ®æµ](#åå­˜å‚¨ç»“æ„ä¸æ•°æ®æµ)
12. [è¾¹ç•Œæƒ…å†µä¸é”™è¯¯å¤„ç†](#åä¸€è¾¹ç•Œæƒ…å†µä¸é”™è¯¯å¤„ç†)
13. [æ€»ç»“ä¸æœ€ä½³å®è·µ](#åäºŒæ€»ç»“ä¸æœ€ä½³å®è·µ)

---

## æ¦‚è¿°

`pallet-membership` æ˜¯ Stardust åŒºå—é“¾çš„å¹´è´¹ä¼šå‘˜ç³»ç»Ÿï¼Œå®ç°äº†å®Œæ•´çš„ä¼šå‘˜ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚**æœ‰æ•ˆä¼šå‘˜**æ˜¯æ•´ä¸ªè”ç›Ÿè¿”ä½£ä½“ç³»çš„å‡†å…¥é—¨æ§›ï¼Œåªæœ‰æœ‰æ•ˆä¼šå‘˜æ‰èƒ½è·å¾—æ¨èè¿”ä½£ã€‚

### æ ¸å¿ƒç‰¹æ€§

- âœ… **4çº§ä¼šå‘˜ä½“ç³»**ï¼šYear1/Year3/Year5/Year10ï¼Œä»·æ ¼å’Œæƒç›Šé€’å¢
- âœ… **åŠ¨æ€ä»£æ•°å¢é•¿**ï¼šæ¨èè¶Šå¤šï¼Œå¯æ‹¿ä»£æ•°è¶Šå¤šï¼ˆæœ€å¤š15ä»£ï¼‰
- âœ… **æ—¶é—´æœ‰æ•ˆæ€§éªŒè¯**ï¼šåŸºäºåŒºå—é«˜åº¦çš„æœ‰æ•ˆæœŸç®¡ç†
- âœ… **ğŸ†• æŒå¸é—¨æ§›éªŒè¯**ï¼šæŒå¸ä»·å€¼ â‰¥ $100 USDï¼ˆåŸºäºå¸‚åœºä»·æ ¼åŠ¨æ€è®¡ç®—ï¼‰
- âœ… **æ¨èå…³ç³»ç»‘å®š**ï¼šä¸ `pallet-affiliate` æ— ç¼é›†æˆ
- âœ… **ä¼šå‘˜æŠ˜æ‰£**ï¼šé»˜è®¤äº«å—20%æŠ˜æ‰£ï¼ˆ2æŠ˜ï¼‰

---

## ä¸€ã€æœ‰æ•ˆä¼šå‘˜çš„æ ¸å¿ƒå®šä¹‰

### 1.1 åˆ¤æ–­æ ‡å‡†

**æ ¸å¿ƒå‡½æ•°**: `pallets/membership/src/lib.rs:720-733`

**ğŸ†• 2025-11-10 æ›´æ–°**ï¼šæ–°å¢æŒå¸é—¨æ§›éªŒè¯

```rust
/// æ£€æŸ¥è´¦æˆ·æ˜¯å¦æ˜¯æœ‰æ•ˆä¼šå‘˜
///
/// # å‚æ•°
/// - `who`: è¦æ£€æŸ¥çš„è´¦æˆ·
///
/// # è¿”å›
/// - `true`: æ˜¯æœ‰æ•ˆä¼šå‘˜ï¼ˆå·²è´­ä¹°ä¸”æœªè¿‡æœŸä¸”æŒå¸ä»·å€¼â‰¥100ç¾å…ƒï¼‰
/// - `false`: ä¸æ˜¯ä¼šå‘˜ã€å·²è¿‡æœŸæˆ–æŒå¸ä»·å€¼ä¸è¶³
///
/// # ğŸ†• 2025-11-10 å˜æ›´ï¼šå¢åŠ æŒå¸é—¨æ§›éªŒè¯
/// - éªŒè¯1ï¼šä¼šå‘˜å­˜åœ¨æ€§å’Œæ—¶æ•ˆæ€§ï¼ˆåŸæœ‰é€»è¾‘ï¼‰
/// - éªŒè¯2ï¼šæŒå¸ä»·å€¼ â‰¥ 100ç¾å…ƒï¼ˆæ–°å¢é€»è¾‘ï¼‰
/// - ä»·æ ¼æ¥æºï¼špallet-pricing çš„åŠ æƒå¹³å‡ä»·æ ¼
/// - è®¡ç®—å…¬å¼ï¼šæŒå¸ä»·å€¼(USD) = ä½™é¢(DUST) Ã— DUSTä»·æ ¼(USDT/DUST)
pub fn is_member_valid(who: &T::AccountId) -> bool {
    if let Some(membership) = Memberships::<T>::get(who) {
        // éªŒè¯1ï¼šä¼šå‘˜æœªè¿‡æœŸ
        let current_block = <frame_system::Pallet<T>>::block_number();
        if current_block > membership.valid_until {
            return false;
        }

        // éªŒè¯2ï¼šæŒå¸ä»·å€¼ â‰¥ 100ç¾å…ƒ
        Self::check_holding_value(who)
    } else {
        false
    }
}
```

**åˆ¤æ–­é€»è¾‘**ï¼š

1. **å­˜åœ¨æ€§æ£€æŸ¥**ï¼šè´¦æˆ·åœ¨ `Memberships<T>` å­˜å‚¨ä¸­å­˜åœ¨
2. **æ—¶æ•ˆæ€§æ£€æŸ¥**ï¼šå½“å‰åŒºå—å· â‰¤ ä¼šå‘˜æœ‰æ•ˆæœŸæˆªæ­¢åŒºå—å·
3. **ğŸ†• æŒå¸ä»·å€¼æ£€æŸ¥**ï¼šè´¦æˆ·æŒå¸ä»·å€¼ â‰¥ $100 USDï¼ˆåŠ¨æ€è®¡ç®—ï¼‰

### 1.2 æœ‰æ•ˆæœŸè®¡ç®—

**è®¡ç®—å…¬å¼**ï¼š

```rust
valid_until = current_block + (blocks_per_year Ã— years)
```

**ç¤ºä¾‹**ï¼ˆå‡è®¾ `blocks_per_year = 5,256,000`ï¼‰ï¼š

| ä¼šå‘˜ç­‰çº§ | æœ‰æ•ˆæœŸï¼ˆå¹´ï¼‰ | æœ‰æ•ˆæœŸï¼ˆåŒºå—ï¼‰ | è®¡ç®—å…¬å¼ |
|---------|------------|--------------|---------|
| Year1 | 1å¹´ | 5,256,000 | current + 5,256,000 |
| Year3 | 3å¹´ | 15,768,000 | current + 15,768,000 |
| Year5 | 5å¹´ | 26,280,000 | current + 26,280,000 |
| Year10 | 10å¹´ | 52,560,000 | current + 52,560,000 |

**ä»£ç å®ç°**ï¼ˆlib.rs:774-776ï¼‰ï¼š

```rust
let blocks_per_year = T::BlocksPerYear::get();
let valid_until = current_block
    .saturating_add(blocks_per_year.saturating_mul(level.years().into()));
```

### 1.3 æœ‰æ•ˆä¼šå‘˜çš„éªŒè¯ç»´åº¦

**ğŸ†• 2025-11-10 æ›´æ–°**ï¼šæ–°å¢æŒå¸ä»·å€¼éªŒè¯ç»´åº¦

| ç»´åº¦ | éªŒè¯æ–¹å¼ | ä»£ç ä½ç½® | è¯´æ˜ |
|-----|---------|---------|------|
| **å­˜åœ¨æ€§** | `Memberships::<T>::contains_key(who)` | lib.rs:334, 681 | ä¼šå‘˜è®°å½•æ˜¯å¦å­˜åœ¨ |
| **æ—¶æ•ˆæ€§** | `current_block <= valid_until` | lib.rs:724-726 | ä¼šå‘˜æ˜¯å¦æœªè¿‡æœŸ |
| **ğŸ†• æŒå¸ä»·å€¼** | `check_holding_value(who)` | lib.rs:754-779 | æŒå¸ä»·å€¼ â‰¥ $100 USD |
| **å¯ç”¨æ€§** | `is_member_valid(who)` | lib.rs:720-733 | ä¸‰ä¸ªç»´åº¦ç»¼åˆéªŒè¯ |

### 1.4 ğŸ†• æŒå¸ä»·å€¼éªŒè¯æœºåˆ¶

**æ–°å¢å‡½æ•°**: `check_holding_value()` (lib.rs:754-779)

**è®¡ç®—é€»è¾‘**ï¼š

```rust
fn check_holding_value(who: &T::AccountId) -> bool {
    // 1. è·å–è´¦æˆ·ä½™é¢ï¼ˆç²¾åº¦ 10^12ï¼‰
    let balance = T::Currency::free_balance(who);
    let balance_u128: u128 = balance.saturated_into();

    // 2. è·å– DUST å¸‚åœºä»·æ ¼ï¼ˆUSDT/DUSTï¼Œç²¾åº¦ 10^6ï¼‰
    let dust_price_usdt = pallet_pricing::Pallet::<T::PricingConfig>::get_dust_market_price_weighted();

    // 3. è®¡ç®—æŒå¸ä»·å€¼ï¼ˆç¾åˆ†ï¼‰
    // æŒå¸ä»·å€¼ = (ä½™é¢ Ã— ä»·æ ¼ Ã— 100) / (10^12 Ã— 10^6)
    let holding_value_cents = balance_u128
        .saturating_mul(dust_price_usdt as u128)
        .saturating_mul(100) // è½¬æ¢ä¸ºç¾åˆ†
        .checked_div(1_000_000_000_000_000_000) // é™¤ä»¥ 10^18
        .unwrap_or(0);

    // 4. ä¸é—¨æ§›æ¯”è¾ƒï¼ˆ100ç¾å…ƒ = 10000ç¾åˆ†ï¼‰
    let min_value_cents = T::MinHoldingValueCents::get();
    holding_value_cents >= min_value_cents as u128
}
```

**è®¡ç®—ç¤ºä¾‹**ï¼š

| åœºæ™¯ | ä½™é¢ï¼ˆDUSTï¼‰ | DUSTä»·æ ¼ï¼ˆUSDTï¼‰ | æŒå¸ä»·å€¼ï¼ˆUSDï¼‰ | æ˜¯å¦é€šè¿‡ |
|------|------------|-----------------|----------------|---------|
| åœºæ™¯1 | 1,000,000 | 0.0001 | $100.00 | âœ… é€šè¿‡ï¼ˆåˆšå¥½ï¼‰ |
| åœºæ™¯2 | 500,000 | 0.0001 | $50.00 | âŒ ä¸é€šè¿‡ |
| åœºæ™¯3 | 500,000 | 0.0002 | $100.00 | âœ… é€šè¿‡ï¼ˆä»·æ ¼ç¿»å€ï¼‰ |

**æ–°å¢æŸ¥è¯¢å‡½æ•°**: `get_holding_value_usd()` (lib.rs:792-809)

```rust
pub fn get_holding_value_usd(who: &T::AccountId) -> (u64, u32) {
    // è¿”å› (dollars, cents)ï¼Œä¾‹å¦‚ (123, 45) è¡¨ç¤º $123.45
}
```

---

## äºŒã€ä¼šå‘˜ç­‰çº§ä½“ç³»

### 2.1 ç­‰çº§æšä¸¾å®šä¹‰

**ä½ç½®**: `pallets/membership/src/types.rs:14-23`

```rust
#[derive(Encode, Decode, Clone, Copy, PartialEq, Eq, RuntimeDebug, TypeInfo, MaxEncodedLen)]
pub enum MembershipLevel {
    /// å¹´è´¹ä¼šå‘˜ï¼š400 DUSTï¼ŒåŸºç¡€6ä»£ï¼Œæœ‰æ•ˆæœŸ1å¹´
    Year1,
    /// 3å¹´ä¼šå‘˜ï¼š800 DUSTï¼ŒåŸºç¡€9ä»£ï¼Œæœ‰æ•ˆæœŸ3å¹´
    Year3,
    /// 5å¹´ä¼šå‘˜ï¼š1600 DUSTï¼ŒåŸºç¡€12ä»£ï¼Œæœ‰æ•ˆæœŸ5å¹´
    Year5,
    /// 10å¹´ä¼šå‘˜ï¼š2000 DUSTï¼ŒåŸºç¡€15ä»£ï¼Œæœ‰æ•ˆæœŸ10å¹´
    Year10,
}
```

### 2.2 ç­‰çº§å‚æ•°å¯¹ç…§è¡¨

| å‚æ•° | Year1 | Year3 | Year5 | Year10 | ä»£ç æ–¹æ³• |
|-----|-------|-------|-------|--------|---------|
| **ID** | 0 | 1 | 2 | 3 | `to_id()` |
| **ä»·æ ¼ï¼ˆDUSTï¼‰** | 400 | 800 | 1600 | 2000 | `price_in_units()` |
| **åŸºç¡€ä»£æ•°** | 6 | 9 | 12 | 15 | `base_generations()` |
| **æœ‰æ•ˆæœŸï¼ˆå¹´ï¼‰** | 1 | 3 | 5 | 10 | `years()` |
| **å‡çº§è´¹ç”¨** | 1800 | 1500 | 1000 | - | `upgrade_to_year10_price()` |

### 2.3 ç­‰çº§æ–¹æ³•å®ç°

**ä½ç½®**: `pallets/membership/src/types.rs:25-76`

```rust
impl MembershipLevel {
    /// å°†ä¼šå‘˜ç­‰çº§è½¬ä¸º ID
    pub fn to_id(&self) -> u8 {
        match self {
            Self::Year1 => 0,
            Self::Year3 => 1,
            Self::Year5 => 2,
            Self::Year10 => 3,
        }
    }

    /// è·å–ä¼šå‘˜ä»·æ ¼ï¼ˆå•ä½ï¼šDUSTï¼Œéœ€ä¹˜ä»¥ UNITSï¼‰
    pub fn price_in_units(&self) -> u128 {
        match self {
            Self::Year1 => 400,
            Self::Year3 => 800,
            Self::Year5 => 1600,
            Self::Year10 => 2000,
        }
    }

    /// è·å–åŸºç¡€æ¨èä»£æ•°
    pub fn base_generations(&self) -> u8 {
        match self {
            Self::Year1 => 6,
            Self::Year3 => 9,
            Self::Year5 => 12,
            Self::Year10 => 15,
        }
    }

    /// è·å–æœ‰æ•ˆæœŸï¼ˆå¹´ï¼‰
    pub fn years(&self) -> u32 {
        match self {
            Self::Year1 => 1,
            Self::Year3 => 3,
            Self::Year5 => 5,
            Self::Year10 => 10,
        }
    }

    /// è¡¥å‡çº§åˆ°10å¹´ä¼šå‘˜æ‰€éœ€è´¹ç”¨ï¼ˆå•ä½ï¼šDUSTï¼‰
    pub fn upgrade_to_year10_price(&self) -> Option<u128> {
        match self {
            Self::Year1 => Some(1800),   // 400 + 1800 = 2200
            Self::Year3 => Some(1500),   // 800 + 1500 = 2300
            Self::Year5 => Some(1000),   // 1600 + 1000 = 2600
            Self::Year10 => None,        // å·²ç»æ˜¯10å¹´ä¼šå‘˜
        }
    }
}
```

---

## ä¸‰ã€ä¼šå‘˜è´­ä¹°æµç¨‹è¯¦è§£

### 3.1 è´­ä¹°æ¥å£

**å‡½æ•°ç­¾å**ï¼ˆlib.rs:307-399ï¼‰ï¼š

```rust
#[pallet::call_index(0)]
#[pallet::weight(T::WeightInfo::purchase_membership())]
pub fn purchase_membership(
    origin: OriginFor<T>,
    level_id: u8,           // 0=Year1, 1=Year3, 2=Year5, 3=Year10
    referral_code: Vec<u8>, // æ¨èç ï¼ˆå¿…å¡«ï¼‰
) -> DispatchResult
```

### 3.2 å®Œæ•´æµç¨‹ï¼ˆ9æ­¥ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 0: è§£æä¼šå‘˜ç­‰çº§                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ level_id â†’ MembershipLevel                                     â”‚
â”‚ 0 â†’ Year1, 1 â†’ Year3, 2 â†’ Year5, 3 â†’ Year10                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 1: éªŒè¯ä¸èƒ½é‡å¤è´­ä¹°                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ensure!(!Memberships::<T>::contains_key(&who), AlreadyMember); â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 2: éªŒè¯æ¨èç                                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è½¬æ¢ä¸º BoundedVec                                            â”‚
â”‚ 2. è°ƒç”¨ pallet_affiliate::find_account_by_code()               â”‚
â”‚ 3. éªŒè¯æ¨èäººæ˜¯æœ‰æ•ˆä¼šå‘˜ï¼šis_member_valid(æ¨èäºº)                 â”‚
â”‚    â†’ ä¸æ˜¯æœ‰æ•ˆä¼šå‘˜åˆ™è¿”å›é”™è¯¯ ReferrerNotValid                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 3: è®¡ç®—ä»·æ ¼å¹¶è½¬è´¦åˆ°è”ç›Ÿæ‰˜ç®¡è´¦æˆ·                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. è·å–ä¼šå‘˜ä»·æ ¼ï¼šget_membership_price(level)                    â”‚
â”‚ 2. è·å–æ‰˜ç®¡è´¦æˆ·ï¼šT::AffiliatePalletId::get().into_account()    â”‚
â”‚ 3. è½¬è´¦ï¼šwho â†’ affiliate_account                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 4: ç»‘å®šæ¨èå…³ç³»                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ pallet_affiliate::bind_sponsor_internal(&who, &referrer)       â”‚
â”‚ â†’ Sponsors::<T>::insert(who, referrer)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 5: åˆ›å»ºä¼šå‘˜ä¿¡æ¯                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ create_membership_internal(who, level, referrer, current_block)â”‚
â”‚ â†’ è®¡ç®— valid_until                                             â”‚
â”‚ â†’ åˆ›å»º MembershipInfo ç»“æ„                                      â”‚
â”‚ â†’ ä¿å­˜åˆ° Memberships::<T>                                       â”‚
â”‚ â†’ æ›´æ–° TotalMembers ç»Ÿè®¡                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 6: è‡ªåŠ¨åˆ†é…æ¨èç ï¼ˆå¯é€‰ï¼‰                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å½“å‰ç‰ˆæœ¬ï¼šéœ€è¦ç”¨æˆ·æ‰‹åŠ¨è°ƒç”¨ pallet_affiliate::claim_code()        â”‚
â”‚ ï¼ˆå·²æ³¨é‡Šæ‰è‡ªåŠ¨åˆ†é…é€»è¾‘ï¼‰                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 7: å¢åŠ æ¨èäººçš„å¥–åŠ±ä»£æ•°                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ increase_referrer_generation(referrer)                         â”‚
â”‚ â†’ bonus_generations += 1                                       â”‚
â”‚ â†’ total_generations = min(15, base + bonus)                   â”‚
â”‚ â†’ referral_count += 1                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 8: è§¦å‘è”ç›Ÿè®¡é…¬åˆ†é…                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TODO: å¾…å®ç° distribute_membership_rewards()                    â”‚
â”‚ å½“å‰ç‰ˆæœ¬ï¼šæš‚æ—¶è·³è¿‡ï¼Œåç»­è¡¥å……å®ç°                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 9: å‘å‡ºäº‹ä»¶                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Event::MembershipPurchased {                                   â”‚
â”‚     who, level_id, valid_until, referrer                       â”‚
â”‚ }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 å…³é”®ä»£ç ç‰‡æ®µ

#### æ­¥éª¤ 2: éªŒè¯æ¨èç ï¼ˆlib.rs:326-342ï¼‰

```rust
// ğŸ†• 2025-10-28 æ›´æ–°ï¼šé€šè¿‡ AffiliateConfig å…³è”ç±»å‹è°ƒç”¨ pallet-affiliate
let referrer_account = {
    use frame_support::BoundedVec;
    let code_bounded = BoundedVec::try_from(referral_code.clone())
        .map_err(|_| Error::<T>::InvalidReferralCode)?;
    pallet_affiliate::Pallet::<T::AffiliateConfig>::find_account_by_code(&code_bounded)
        .ok_or(Error::<T>::InvalidReferralCode)?
};

// âš ï¸ å…³é”®éªŒè¯ï¼šæ¨èäººå¿…é¡»æ˜¯æœ‰æ•ˆä¼šå‘˜
ensure!(
    Self::is_member_valid(&referrer_account),
    Error::<T>::ReferrerNotValid
);
```

#### æ­¥éª¤ 3: è½¬è´¦åˆ°æ‰˜ç®¡è´¦æˆ·ï¼ˆlib.rs:344-353ï¼‰

```rust
// âœ… è®¡ç®—ä»·æ ¼å¹¶è½¬è´¦åˆ°è”ç›Ÿæ‰˜ç®¡è´¦æˆ·
let price = Self::get_membership_price(level);
let affiliate_account = T::AffiliatePalletId::get().into_account_truncating();

T::Currency::transfer(
    &who,
    &affiliate_account,  // âœ… è”ç›Ÿæ‰˜ç®¡è´¦æˆ·
    price,
    ExistenceRequirement::KeepAlive,
)?;
```

#### æ­¥éª¤ 5: åˆ›å»ºä¼šå‘˜ä¿¡æ¯ï¼ˆlib.rs:767-795ï¼‰

```rust
fn create_membership_internal(
    who: T::AccountId,
    level: MembershipLevel,
    referrer: Option<T::AccountId>,
    current_block: BlockNumberFor<T>,
) -> Result<BlockNumberFor<T>, DispatchError> {
    // 1. è®¡ç®—æœ‰æ•ˆæœŸ
    let blocks_per_year = T::BlocksPerYear::get();
    let valid_until = current_block
        .saturating_add(blocks_per_year.saturating_mul(level.years().into()));

    // 2. åˆ›å»ºä¼šå‘˜ä¿¡æ¯
    let base_generations = level.base_generations();
    let membership = MembershipInfo {
        level,
        purchased_at: current_block,
        valid_until,
        base_generations,
        bonus_generations: 0,
        total_generations: base_generations,
        referrer,
        referral_count: 0,
    };

    // 3. ä¿å­˜ä¼šå‘˜ä¿¡æ¯
    Memberships::<T>::insert(&who, membership);
    TotalMembers::<T>::mutate(&level, |count| *count = count.saturating_add(1));

    Ok(valid_until)
}
```

---

## å››ã€æœ‰æ•ˆä¼šå‘˜éªŒè¯æœºåˆ¶

**ğŸ†• 2025-11-10 æ›´æ–°**ï¼šæ–°å¢æŒå¸ä»·å€¼éªŒè¯åœºæ™¯

### 4.1 éªŒè¯åœºæ™¯æ±‡æ€»

| éªŒè¯åœºæ™¯ | è°ƒç”¨ä½ç½® | ä»£ç ä½ç½® | éªŒè¯ç›®çš„ |
|---------|---------|---------|---------|
| **è´­ä¹°ä¼šå‘˜æ—¶** | éªŒè¯æ¨èäºº | lib.rs:347-350 | ç¡®ä¿æ¨èäººæœ‰æ•ˆ |
| **å³æ—¶åˆ†æˆæ—¶** | éªŒè¯æ¨èé“¾ | affiliate/src/instant.rs:107 | ç¡®ä¿æ¨èäººå¯æ‹¿è¿”ä½£ |
| **å‘¨ç»“ç®—æ—¶** | éªŒè¯æ¨èé“¾ | affiliate/src/weekly.rs:73-76 | ç¡®ä¿æ¨èäººå¯ç´¯è®¡åº”å¾— |
| **è®¤é¢†æ¨èç æ—¶** | éªŒè¯ä¼šå‘˜èµ„æ ¼ | affiliate/src/referral.rs:209-211 | ä»…ä¼šå‘˜å¯è®¤é¢† |

**âš ï¸ é‡è¦å˜æ›´**ï¼šä»¥ä¸Šæ‰€æœ‰éªŒè¯åœºæ™¯ç°åœ¨éƒ½åŒ…å«æŒå¸ä»·å€¼æ£€æŸ¥ï¼ˆâ‰¥$100 USDï¼‰

### 4.2 éªŒè¯æµç¨‹å¯è§†åŒ–

**ğŸ†• 2025-11-10 æ›´æ–°**ï¼šå¢åŠ æŒå¸ä»·å€¼éªŒè¯æ­¥éª¤

```mermaid
graph TD
    A[éªŒè¯è¯·æ±‚] --> B{Membershipså­˜åœ¨?}
    B -->|å¦| C[è¿”å› false]
    B -->|æ˜¯| D[è·å– membership]
    D --> E[è·å– current_block]
    D --> F[è·å– valid_until]
    E --> G{current_block <= valid_until?}
    F --> G
    G -->|å¦| I[è¿”å› false - å·²è¿‡æœŸ]
    G -->|æ˜¯| H[ğŸ†• æ£€æŸ¥æŒå¸ä»·å€¼]
    H --> J{æŒå¸ä»·å€¼ >= $100 USD?}
    J -->|æ˜¯| K[è¿”å› true - æœ‰æ•ˆä¼šå‘˜]
    J -->|å¦| L[è¿”å› false - æŒå¸ä¸è¶³]
```

### 4.3 ç›¸å…³è¾…åŠ©å‡½æ•°

#### 4.3.1 è·å–ä¼šå‘˜å¯æ‹¿ä»£æ•°ï¼ˆlib.rs:721-728ï¼‰

```rust
/// è·å–ä¼šå‘˜å¯æ‹¿ä»£æ•°
///
/// # å‚æ•°
/// - `who`: è¦æŸ¥è¯¢çš„è´¦æˆ·
///
/// # è¿”å›
/// - `Some(ä»£æ•°)`: æœ‰æ•ˆä¼šå‘˜çš„å¯æ‹¿ä»£æ•°
/// - `None`: ä¸æ˜¯ä¼šå‘˜æˆ–å·²è¿‡æœŸ
pub fn get_member_generations(who: &T::AccountId) -> Option<u8> {
    if let Some(membership) = Memberships::<T>::get(who) {
        if Self::is_member_valid(who) {
            return Some(membership.total_generations)
        }
    }
    None
}
```

#### 4.3.2 è·å–ä¼šå‘˜ä»·æ ¼ï¼ˆlib.rs:745-752ï¼‰

```rust
/// è·å–ä¼šå‘˜ç­‰çº§ä»·æ ¼ï¼ˆæœ€å°å•ä½ï¼‰
///
/// # å‚æ•°
/// - `level`: ä¼šå‘˜ç­‰çº§
///
/// # è¿”å›
/// ä»·æ ¼ï¼ˆæœ€å°å•ä½ï¼‰ï¼Œå¦‚æœå­˜å‚¨ä¸­æœ‰è®¾ç½®åˆ™è¿”å›å­˜å‚¨ä»·æ ¼ï¼Œå¦åˆ™è¿”å›é»˜è®¤ä»·æ ¼
pub fn get_membership_price(level: MembershipLevel) -> BalanceOf<T> {
    MembershipPrices::<T>::get(level).unwrap_or_else(|| {
        // å¦‚æœå­˜å‚¨ä¸­æ²¡æœ‰è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤ä»·æ ¼
        let units: u128 = T::Units::get().saturated_into();
        let price_u128 = level.price_in_units().saturating_mul(units);
        price_u128.saturated_into()
    })
}
```

---

## äº”ã€ä¼šå‘˜å‡çº§æœºåˆ¶

### 5.1 å‡çº§æ¥å£

**å‡½æ•°ç­¾å**ï¼ˆlib.rs:421-485ï¼‰ï¼š

```rust
#[pallet::call_index(1)]
#[pallet::weight(T::WeightInfo::upgrade_to_year10())]
pub fn upgrade_to_year10(origin: OriginFor<T>) -> DispatchResult
```

### 5.2 å‡çº§æµç¨‹ï¼ˆ8æ­¥ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 1: è·å–å½“å‰ä¼šå‘˜ä¿¡æ¯                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Memberships::<T>::get(&who).ok_or(NotMember)?                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 2: éªŒè¯ä¸æ˜¯å·²ç»æ˜¯10å¹´ä¼šå‘˜                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ensure!(membership.level != Year10, AlreadyYear10);            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 3: è®¡ç®—å‡çº§è´¹ç”¨                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ upgrade_to_year10_price() Ã— units                              â”‚
â”‚ Year1 â†’ 1800 DUST, Year3 â†’ 1500 DUST, Year5 â†’ 1000 DUST       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 4: æ‰£è´¹åˆ°å›½åº“è´¦æˆ·                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ T::Currency::transfer(who â†’ treasury, upgrade_price, KeepAlive)â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 5: æ›´æ–°ä¼šå‘˜ä¿¡æ¯                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ - level = Year10                                               â”‚
â”‚ - base_generations = 15                                        â”‚
â”‚ - total_generations = 15ï¼ˆä¸å†å—bonuså½±å“ï¼‰                     â”‚
â”‚ - valid_until = current_block + (blocks_per_year Ã— 10)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 6: ä¿å­˜æ›´æ–°åçš„ä¼šå‘˜ä¿¡æ¯                                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Memberships::<T>::insert(&who, membership);                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 7: æ›´æ–°ç»Ÿè®¡æ•°æ®                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ TotalMembers(old_level) -= 1                                   â”‚
â”‚ TotalMembers(Year10) += 1                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥éª¤ 8: å‘å‡ºäº‹ä»¶                                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Event::MembershipUpgraded {                                    â”‚
â”‚     who, from_id, to_id, new_valid_until                       â”‚
â”‚ }                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 å‡çº§è´¹ç”¨å¯¹ç…§è¡¨

| åŸç­‰çº§ | åŸä»·æ ¼ | å‡çº§è´¹ç”¨ | æ€»æ”¯å‡º | å¤šæ”¯å‡º | å¤‡æ³¨ |
|-------|-------|---------|-------|-------|------|
| Year1 | 400 | 1800 | 2200 | +200 | å«è¡¥å·®è´¹ |
| Year3 | 800 | 1500 | 2300 | +300 | å«è¡¥å·®è´¹ |
| Year5 | 1600 | 1000 | 2600 | +600 | å«è¡¥å·®è´¹ |
| Year10 | 2000 | - | 2000 | 0 | æ— æ³•å‡çº§ |

âš ï¸ **æ³¨æ„**ï¼šå‡çº§è´¹ç”¨ > ç›´æ¥å·®ä»·ï¼Œæ˜¯å› ä¸ºåŒ…å«äº†**å‡çº§æœåŠ¡è´¹**ã€‚

### 5.4 å‡çº§æ•ˆæœå¯¹æ¯”

| æ•ˆæœç»´åº¦ | å‡çº§å‰ï¼ˆYear1ç¤ºä¾‹ï¼‰ | å‡çº§åï¼ˆYear10ï¼‰ | å˜åŒ– |
|---------|-------------------|-----------------|------|
| **æœ‰æ•ˆæœŸ** | å‰©ä½™Xå¤© | é‡æ–°è®¡ç®—10å¹´ | âœ… é‡ç½® |
| **åŸºç¡€ä»£æ•°** | 6 | 15 | âœ… +9 |
| **æ€»ä»£æ•°** | 6 + bonus | 15 | âœ… é”å®š15 |
| **ä»£æ•°å¢é•¿** | å¯ç»§ç»­å¢é•¿ | ä¸å†å¢é•¿ | âŒ å¤±å» |

---

## å…­ã€åŠ¨æ€ä»£æ•°å¢é•¿æœºåˆ¶

### 6.1 å¢é•¿è§„åˆ™

**æ ¸å¿ƒå…¬å¼**ï¼š

```
total_generations = min(15, base_generations + bonus_generations)
```

**è§¦å‘æ—¶æœº**ï¼š
- æ¯å½“ç”¨æˆ·æˆåŠŸæ¨èä¸€ä¸ªæ–°ä¼šå‘˜è´­ä¹°ä¼šå‘˜æ—¶
- è°ƒç”¨ `increase_referrer_generation(referrer)`

### 6.2 å¢é•¿å‡½æ•°å®ç°ï¼ˆlib.rs:808-832ï¼‰

```rust
/// å¢åŠ æ¨èäººçš„å¥–åŠ±ä»£æ•°
///
/// # å‚æ•°
/// - `referrer`: æ¨èäººè´¦æˆ·
///
/// # é€»è¾‘
/// - æ¯æ¨èä¸€ä¸ªä¼šå‘˜ï¼Œå¥–åŠ±ä»£æ•°+1
/// - æ€»ä»£æ•° = åŸºç¡€ä»£æ•° + å¥–åŠ±ä»£æ•°
/// - æ€»ä»£æ•°ä¸Šé™ä¸º15
/// - 10å¹´ä¼šå‘˜åˆå§‹å³15ä»£ï¼Œä¸å†å¢é•¿
fn increase_referrer_generation(referrer: &T::AccountId) -> DispatchResult {
    Memberships::<T>::try_mutate(referrer, |maybe_membership| -> DispatchResult {
        if let Some(ref mut membership) = maybe_membership {
            // æ¯æ¨èä¸€ä¸ªä¼šå‘˜ï¼Œå¢åŠ 1ä»£
            membership.bonus_generations = membership.bonus_generations.saturating_add(1);

            // é‡æ–°è®¡ç®—æ€»ä»£æ•°ï¼ˆæœ€å¤š15ä»£ï¼‰
            membership.total_generations = 15u8.min(
                membership.base_generations.saturating_add(membership.bonus_generations),
            );

            // å¢åŠ æ¨èè®¡æ•°
            membership.referral_count = membership.referral_count.saturating_add(1);

            // å‘å‡ºäº‹ä»¶
            Self::deposit_event(Event::GenerationIncreased {
                who: referrer.clone(),
                bonus: membership.bonus_generations,
                total: membership.total_generations,
            });
        }
        Ok(())
    })
}
```

### 6.3 å¢é•¿ç¤ºä¾‹

#### ç¤ºä¾‹ 1: Year1 ä¼šå‘˜ï¼ˆåŸºç¡€6ä»£ï¼‰

| æ¨èäººæ•° | å¥–åŠ±ä»£æ•° | æ€»ä»£æ•° | è®¡ç®—è¿‡ç¨‹ |
|---------|---------|--------|---------|
| 0 | 0 | 6 | 6 + 0 = 6 |
| 1 | 1 | 7 | 6 + 1 = 7 |
| 5 | 5 | 11 | 6 + 5 = 11 |
| 9 | 9 | 15 | min(15, 6+9) = 15 |
| 10 | 10 | 15 | min(15, 6+10) = 15 âš ï¸ è¾¾åˆ°ä¸Šé™ |
| 20 | 20 | 15 | min(15, 6+20) = 15 âš ï¸ ä¿æŒä¸Šé™ |

#### ç¤ºä¾‹ 2: Year5 ä¼šå‘˜ï¼ˆåŸºç¡€12ä»£ï¼‰

| æ¨èäººæ•° | å¥–åŠ±ä»£æ•° | æ€»ä»£æ•° | è®¡ç®—è¿‡ç¨‹ |
|---------|---------|--------|---------|
| 0 | 0 | 12 | 12 + 0 = 12 |
| 1 | 1 | 13 | 12 + 1 = 13 |
| 3 | 3 | 15 | min(15, 12+3) = 15 |
| 5 | 5 | 15 | min(15, 12+5) = 15 âš ï¸ ä¿æŒä¸Šé™ |

#### ç¤ºä¾‹ 3: Year10 ä¼šå‘˜ï¼ˆåŸºç¡€15ä»£ï¼‰

| æ¨èäººæ•° | å¥–åŠ±ä»£æ•° | æ€»ä»£æ•° | è¯´æ˜ |
|---------|---------|--------|------|
| 0 | 0 | 15 | åˆå§‹å³æ»¡çº§ |
| 10 | 10 | 15 | min(15, 15+10) = 15 âš ï¸ æ— å¢é•¿ç©ºé—´ |

---

## ä¸ƒã€ä¼šå‘˜æŠ˜æ‰£æœºåˆ¶

### 7.1 æŠ˜æ‰£å­˜å‚¨

**å­˜å‚¨å®šä¹‰**ï¼ˆlib.rs:169-170ï¼‰ï¼š

```rust
/// ä¼šå‘˜æŠ˜æ‰£æ¯”ä¾‹ï¼ˆ0-100ï¼‰
/// é»˜è®¤å€¼ï¼š20ï¼Œè¡¨ç¤º20%ï¼Œå³2æŠ˜
#[pallet::storage]
#[pallet::getter(fn member_discount)]
pub type MemberDiscount<T: Config> = StorageValue<_, DiscountPercent, ValueQuery>;
```

### 7.2 è®¾ç½®æŠ˜æ‰£ï¼ˆRootæƒé™ï¼‰

**å‡½æ•°ç­¾å**ï¼ˆlib.rs:500-512ï¼‰ï¼š

```rust
/// è®¾ç½®ä¼šå‘˜æŠ˜æ‰£ï¼ˆRootæƒé™ï¼‰
///
/// # å‚æ•°
/// - `origin`: Rootæ¥æº
/// - `discount`: æŠ˜æ‰£æ¯”ä¾‹ï¼ˆ0-100ï¼Œä¾‹å¦‚20è¡¨ç¤º20%å³2æŠ˜ï¼‰
#[pallet::call_index(2)]
#[pallet::weight(T::WeightInfo::set_member_discount())]
pub fn set_member_discount(
    origin: OriginFor<T>,
    discount: DiscountPercent,
) -> DispatchResult {
    ensure_root(origin)?;

    // éªŒè¯æŠ˜æ‰£èŒƒå›´ï¼ˆ0-100ï¼‰
    ensure!(discount <= 100, Error::<T>::InvalidDiscount);

    MemberDiscount::<T>::put(discount);
    Self::deposit_event(Event::DiscountUpdated { discount });
    Ok(())
}
```

### 7.3 è·å–æŠ˜æ‰£

**å‡½æ•°å®ç°**ï¼ˆlib.rs:734-736ï¼‰ï¼š

```rust
/// è·å–ä¼šå‘˜æŠ˜æ‰£æ¯”ä¾‹
///
/// # è¿”å›
/// æŠ˜æ‰£æ¯”ä¾‹ï¼ˆ0-100ï¼‰
pub fn get_discount() -> DiscountPercent {
    MemberDiscount::<T>::get()
}
```

### 7.4 æŠ˜æ‰£åº”ç”¨åœºæ™¯

| åœºæ™¯ | åº”ç”¨æ–¹å¼ | è¯´æ˜ |
|-----|---------|------|
| **ä¾›å¥‰æ¶ˆè´¹** | `pallet-memorial` è°ƒç”¨ `get_discount()` | ä¼šå‘˜äº«å—ä¾›å¥‰æŠ˜æ‰£ |
| **OTCäº¤æ˜“** | `pallet-otc-order` è°ƒç”¨ `get_discount()` | ä¼šå‘˜äº«å—äº¤æ˜“è´¹æŠ˜æ‰£ |
| **å…¶ä»–æ¶ˆè´¹** | é€šè¿‡ `MembershipProvider` trait | ç»Ÿä¸€æŠ˜æ‰£æ¥å£ |

---

## å…«ã€ä¸è”ç›Ÿè®¡é…¬ç³»ç»Ÿçš„é›†æˆ

### 8.1 é›†æˆæ–¹å¼

é€šè¿‡**å…³è”ç±»å‹**ï¼ˆAssociated Typeï¼‰è¿æ¥ä¸¤ä¸ª palletï¼Œé¿å… Currency ç±»å‹å†²çªï¼š

**é…ç½®å®šä¹‰**ï¼ˆlib.rs:119-120ï¼‰ï¼š

```rust
/// è”ç›Ÿè®¡é…¬ç³»ç»Ÿç±»å‹ï¼ˆæŒ‡å‘ Runtimeï¼Œå®ç°äº† pallet_affiliate::Configï¼‰
type AffiliateConfig: pallet_affiliate::Config<AccountId = Self::AccountId>;
```

### 8.2 è°ƒç”¨æ–¹å¼

#### 8.2.1 æŸ¥è¯¢æ¨èç ï¼ˆlib.rs:332ï¼‰

```rust
pallet_affiliate::Pallet::<T::AffiliateConfig>::find_account_by_code(&code_bounded)
```

#### 8.2.2 ç»‘å®šæ¨èå…³ç³»ï¼ˆlib.rs:358ï¼‰

```rust
pallet_affiliate::Pallet::<T::AffiliateConfig>::bind_sponsor_internal(&who, referrer_account);
```

### 8.3 é›†æˆç‚¹æ±‡æ€»

| é›†æˆç‚¹ | åŠŸèƒ½ | Membership â†’ Affiliate |
|-------|------|----------------------|
| **æ¨èç éªŒè¯** | éªŒè¯æ¨èç æ˜¯å¦å­˜åœ¨ | `find_account_by_code()` |
| **æ¨èå…³ç³»ç»‘å®š** | ç»‘å®šæ–°ä¼šå‘˜ä¸æ¨èäºº | `bind_sponsor_internal()` |
| **ä¼šå‘˜èµ„é‡‘æ‰˜ç®¡** | ä¼šå‘˜è´¹ç”¨è¿›å…¥æ‰˜ç®¡è´¦æˆ· | è½¬è´¦åˆ° `AffiliatePalletId` è´¦æˆ· |
| **ä¼šå‘˜è´¹ç”¨åˆ†é…** | TODO: åˆ†é…ä¼šå‘˜è´¹ç”¨ | `distribute_membership_rewards()` å¾…å®ç° |

### 8.4 åŒè´¦æˆ·ä½“ç³»

| è´¦æˆ·ç±»å‹ | PalletId | ç”¨é€” | ä»£ç ä½ç½® |
|---------|---------|------|---------|
| **è”ç›Ÿæ‰˜ç®¡è´¦æˆ·** | `AffiliatePalletId` | ä¼šå‘˜è´­ä¹°è´¹ç”¨ | lib.rs:346 |
| **ä¼šå‘˜å›½åº“è´¦æˆ·** | `PalletId` | ä¼šå‘˜å‡çº§è´¹ç”¨ | lib.rs:444 |

```rust
// è”ç›Ÿæ‰˜ç®¡è´¦æˆ·
let affiliate_account = T::AffiliatePalletId::get().into_account_truncating();

// ä¼šå‘˜å›½åº“è´¦æˆ·
pub fn treasury_account() -> T::AccountId {
    T::PalletId::get().into_account_truncating()
}
```

---

## ä¹ã€å®Œæ•´ä»£ç åˆ†æ

### 9.1 MembershipInfo ç»“æ„ï¼ˆtypes.rs:85-102ï¼‰

```rust
/// ä¼šå‘˜ä¿¡æ¯ç»“æ„ä½“
#[derive(Encode, Decode, Clone, PartialEq, Eq, RuntimeDebug, TypeInfo, MaxEncodedLen)]
pub struct MembershipInfo<AccountId, BlockNumber> {
    /// ä¼šå‘˜ç­‰çº§
    pub level: MembershipLevel,
    /// è´­ä¹°æ—¶é—´ï¼ˆåŒºå—é«˜åº¦ï¼‰
    pub purchased_at: BlockNumber,
    /// æœ‰æ•ˆæœŸè‡³ï¼ˆåŒºå—é«˜åº¦ï¼‰
    pub valid_until: BlockNumber,
    /// åŸºç¡€ä»£æ•°ï¼ˆæ ¹æ®ç­‰çº§å›ºå®šï¼‰
    pub base_generations: u8,
    /// å¥–åŠ±ä»£æ•°ï¼ˆé€šè¿‡æ¨èè·å¾—ï¼‰
    pub bonus_generations: u8,
    /// æ€»ä»£æ•°ï¼ˆbase + bonusï¼Œæœ€å¤š15ï¼‰
    pub total_generations: u8,
    /// æ¨èäººè´¦æˆ·ï¼ˆå¯é€‰ï¼Œåˆ›å§‹ä¼šå‘˜æ— æ¨èäººï¼‰
    pub referrer: Option<AccountId>,
    /// å·²æ¨èä¼šå‘˜æ•°é‡
    pub referral_count: u32,
}
```

**å­—æ®µè¯´æ˜**ï¼š

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | å¯å˜æ€§ |
|-----|------|-----|-------|
| `level` | `MembershipLevel` | ä¼šå‘˜ç­‰çº§ | å¯å‡çº§ï¼ˆä»…â†’Year10ï¼‰ |
| `purchased_at` | `BlockNumber` | è´­ä¹°æ—¶åŒºå—é«˜åº¦ | ä¸å˜ |
| `valid_until` | `BlockNumber` | æœ‰æ•ˆæœŸæˆªæ­¢åŒºå— | å‡çº§æ—¶æ›´æ–° |
| `base_generations` | `u8` | åŸºç¡€ä»£æ•° | å‡çº§æ—¶æ›´æ–° |
| `bonus_generations` | `u8` | å¥–åŠ±ä»£æ•° | æ¨èæ—¶å¢é•¿ |
| `total_generations` | `u8` | æ€»ä»£æ•° | åŠ¨æ€è®¡ç®— |
| `referrer` | `Option<AccountId>` | æ¨èäºº | ä¸å˜ |
| `referral_count` | `u32` | æ¨èäººæ•° | æ¨èæ—¶å¢é•¿ |

### 9.2 å­˜å‚¨é¡¹æ±‡æ€»

| å­˜å‚¨é¡¹ | ç±»å‹ | æè¿° | Getter |
|-------|------|-----|--------|
| `Memberships` | `StorageMap<AccountId, MembershipInfo>` | ä¼šå‘˜ä¿¡æ¯ | `memberships()` |
| `TotalMembers` | `StorageMap<MembershipLevel, u32>` | æ€»ä¼šå‘˜æ•°ç»Ÿè®¡ | `total_members()` |
| `MemberDiscount` | `StorageValue<u8>` | ä¼šå‘˜æŠ˜æ‰£æ¯”ä¾‹ | `member_discount()` |
| `MembershipPrices` | `StorageMap<MembershipLevel, Balance>` | ä¼šå‘˜ä»·æ ¼ | `membership_price()` |

### 9.3 äº‹ä»¶æ±‡æ€»

| äº‹ä»¶ | å‚æ•° | è§¦å‘æ—¶æœº |
|-----|------|---------|
| `MembershipPurchased` | who, level_id, valid_until, referrer | è´­ä¹°ä¼šå‘˜æˆåŠŸ |
| `MembershipUpgraded` | who, from_id, to_id, new_valid_until | ä¼šå‘˜å‡çº§æˆåŠŸ |
| `GenerationIncreased` | who, bonus, total | æ¨èä»£æ•°å¢åŠ  |
| `DiscountUpdated` | discount | ä¼šå‘˜æŠ˜æ‰£æ›´æ–° |
| `MembershipPriceUpdated` | level_id, price | ä¼šå‘˜ä»·æ ¼æ›´æ–° |
| `BatchPricesUpdated` | count | æ‰¹é‡ä»·æ ¼æ›´æ–° |
| `SeedMemberAdded` | who, level_id | ç§å­ä¼šå‘˜å·²æ·»åŠ  |

### 9.4 é”™è¯¯ç æ±‡æ€»

| é”™è¯¯ | è¯´æ˜ | è§¦å‘åœºæ™¯ |
|-----|------|---------|
| `AlreadyMember` | å·²ç»æ˜¯ä¼šå‘˜ | é‡å¤è´­ä¹° |
| `NotMember` | ä¸æ˜¯ä¼šå‘˜ | æŸ¥è¯¢æˆ–å‡çº§æ—¶ä¸å­˜åœ¨ |
| `InvalidReferralCode` | æ— æ•ˆçš„æ¨èç  | æ¨èç ä¸å­˜åœ¨ |
| `ReferralCodeTooLong` | æ¨èç å¤ªé•¿ | è¶…è¿‡é™åˆ¶ |
| `ReferrerNotValid` | æ¨èäººæ— æ•ˆ | æ¨èäººä¸æ˜¯æœ‰æ•ˆä¼šå‘˜ |
| `AlreadyYear10` | å·²ç»æ˜¯10å¹´ä¼šå‘˜ | å°è¯•å‡çº§Year10 |
| `CannotUpgrade` | æ— æ³•å‡çº§ | éæ³•å‡çº§æ“ä½œ |
| `MembershipExpired` | ä¼šå‘˜å·²è¿‡æœŸ | è¿‡æœŸä¼šå‘˜æ“ä½œ |
| `InvalidDiscount` | æŠ˜æ‰£æ— æ•ˆ | æŠ˜æ‰£ä¸åœ¨0-100èŒƒå›´ |
| `ReferralCodeExists` | æ¨èç å·²å­˜åœ¨ | æ¨èç å†²çª |
| `PriceOutOfRange` | ä»·æ ¼è¶…å‡ºèŒƒå›´ | ä»·æ ¼è¿‡ä½æˆ–è¿‡é«˜ |
| `PriceNotSet` | ä»·æ ¼æœªè®¾ç½® | æ²»ç†æœªåˆå§‹åŒ–ä»·æ ¼ |

---

## åã€å­˜å‚¨ç»“æ„ä¸æ•°æ®æµ

### 10.1 å­˜å‚¨å±‚æ¬¡ç»“æ„

```
Memberships (StorageMap)
â”œâ”€â”€ AccountId â†’ MembershipInfo
â”‚   â”œâ”€â”€ level: MembershipLevel
â”‚   â”œâ”€â”€ purchased_at: BlockNumber
â”‚   â”œâ”€â”€ valid_until: BlockNumber
â”‚   â”œâ”€â”€ base_generations: u8
â”‚   â”œâ”€â”€ bonus_generations: u8
â”‚   â”œâ”€â”€ total_generations: u8
â”‚   â”œâ”€â”€ referrer: Option<AccountId>
â”‚   â””â”€â”€ referral_count: u32

TotalMembers (StorageMap)
â”œâ”€â”€ Year1 â†’ count: u32
â”œâ”€â”€ Year3 â†’ count: u32
â”œâ”€â”€ Year5 â†’ count: u32
â””â”€â”€ Year10 â†’ count: u32

MemberDiscount (StorageValue)
â””â”€â”€ discount: u8 (0-100)

MembershipPrices (StorageMap)
â”œâ”€â”€ Year1 â†’ price: Balance
â”œâ”€â”€ Year3 â†’ price: Balance
â”œâ”€â”€ Year5 â†’ price: Balance
â””â”€â”€ Year10 â†’ price: Balance
```

### 10.2 æ•°æ®æµå›¾

```mermaid
graph LR
    A[ç”¨æˆ·è´­ä¹°ä¼šå‘˜] --> B[éªŒè¯æ¨èç ]
    B --> C{æ¨èäººæœ‰æ•ˆ?}
    C -->|å¦| D[è¿”å›é”™è¯¯]
    C -->|æ˜¯| E[è½¬è´¦åˆ°æ‰˜ç®¡è´¦æˆ·]
    E --> F[ç»‘å®šæ¨èå…³ç³»]
    F --> G[åˆ›å»ºä¼šå‘˜ä¿¡æ¯]
    G --> H[å¢åŠ æ¨èäººä»£æ•°]
    H --> I[è§¦å‘è”ç›Ÿåˆ†é…]
    I --> J[å‘å‡ºäº‹ä»¶]

    G --> K[(Memberships)]
    G --> L[(TotalMembers)]
    H --> M[(æ¨èäººMembershipInfo)]
```

---

## åä¸€ã€è¾¹ç•Œæƒ…å†µä¸é”™è¯¯å¤„ç†

### 11.1 é‡å¤è´­ä¹°

**åœºæ™¯**ï¼šç”¨æˆ·å·²æ˜¯ä¼šå‘˜ï¼Œå†æ¬¡è°ƒç”¨ `purchase_membership()`

**éªŒè¯**ï¼ˆlib.rs:324ï¼‰ï¼š
```rust
ensure!(!Memberships::<T>::contains_key(&who), Error::<T>::AlreadyMember);
```

**ç»“æœ**ï¼šè¿”å›é”™è¯¯ `AlreadyMember`

### 11.2 æ¨èäººæ— æ•ˆ

**åœºæ™¯ 1**ï¼šæ¨èç ä¸å­˜åœ¨

**éªŒè¯**ï¼ˆlib.rs:332-334ï¼‰ï¼š
```rust
pallet_affiliate::Pallet::<T::AffiliateConfig>::find_account_by_code(&code_bounded)
    .ok_or(Error::<T>::InvalidReferralCode)?
```

**ç»“æœ**ï¼šè¿”å›é”™è¯¯ `InvalidReferralCode`

**åœºæ™¯ 2**ï¼šæ¨èäººä¸æ˜¯æœ‰æ•ˆä¼šå‘˜

**éªŒè¯**ï¼ˆlib.rs:337-340ï¼‰ï¼š
```rust
ensure!(
    Self::is_member_valid(&referrer_account),
    Error::<T>::ReferrerNotValid
);
```

**ç»“æœ**ï¼šè¿”å›é”™è¯¯ `ReferrerNotValid`

### 11.3 ä¼šå‘˜è¿‡æœŸ

**åœºæ™¯**ï¼šä¼šå‘˜æœ‰æ•ˆæœŸå·²è¿‡ï¼Œä»å°è¯•ä½¿ç”¨ä¼šå‘˜æƒç›Š

**éªŒè¯**ï¼š
```rust
if current_block > membership.valid_until {
    // ä¼šå‘˜å·²è¿‡æœŸ
    return false;
}
```

**å½±å“**ï¼š
- âŒ æ— æ³•è·å¾—è”ç›Ÿè¿”ä½£
- âŒ æ— æ³•äº«å—ä¼šå‘˜æŠ˜æ‰£
- âŒ æ— æ³•è¢«ä»–äººè®¾ä¸ºæ¨èäºº
- âœ… ä»å¯æŸ¥çœ‹å†å²ä¼šå‘˜ä¿¡æ¯

### 11.4 ä»£æ•°å¢é•¿ä¸Šé™

**åœºæ™¯**ï¼šä¼šå‘˜æ¨èäººæ•°è¶…è¿‡9äººï¼ˆYear1ä¼šå‘˜ï¼‰

**å¤„ç†**ï¼ˆlib.rs:816-818ï¼‰ï¼š
```rust
membership.total_generations = 15u8.min(
    membership.base_generations.saturating_add(membership.bonus_generations),
);
```

**ç»“æœ**ï¼šæ€»ä»£æ•°é”å®šåœ¨15ï¼Œä¸ä¼šè¶…è¿‡

### 11.5 ä»·æ ¼æœªè®¾ç½®

**åœºæ™¯**ï¼šæ²»ç†æœªåˆå§‹åŒ–ä¼šå‘˜ä»·æ ¼

**å¤„ç†**ï¼ˆlib.rs:746-751ï¼‰ï¼š
```rust
MembershipPrices::<T>::get(level).unwrap_or_else(|| {
    // å¦‚æœå­˜å‚¨ä¸­æ²¡æœ‰è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤ä»·æ ¼
    let units: u128 = T::Units::get().saturated_into();
    let price_u128 = level.price_in_units().saturating_mul(units);
    price_u128.saturated_into()
})
```

**ç»“æœ**ï¼šä½¿ç”¨ç¡¬ç¼–ç çš„é»˜è®¤ä»·æ ¼

---

## åäºŒã€æ€»ç»“ä¸æœ€ä½³å®è·µ

### 12.1 æœ‰æ•ˆä¼šå‘˜çš„æ ¸å¿ƒè¦ç‚¹

**ğŸ†• 2025-11-10 æ›´æ–°**ï¼šå¢åŠ æŒå¸ä»·å€¼éªŒè¯ç»´åº¦

| ç»´åº¦ | æ ¸å¿ƒé€»è¾‘ | å®ç°ä½ç½® |
|-----|---------|---------|
| **åˆ¤æ–­æ ‡å‡†** | å­˜åœ¨æ€§ + æ—¶æ•ˆæ€§ + **ğŸ†• æŒå¸ä»·å€¼** | `is_member_valid()` |
| **æœ‰æ•ˆæœŸç®¡ç†** | åŒºå—é«˜åº¦éªŒè¯ | `current_block <= valid_until` |
| **ğŸ†• æŒå¸é—¨æ§›** | ä»·å€¼ â‰¥ $100 USDï¼ˆåŠ¨æ€è®¡ç®—ï¼‰ | `check_holding_value()` |
| **ä»£æ•°å¢é•¿** | æ¨èæ¿€åŠ±æœºåˆ¶ | `increase_referrer_generation()` |
| **ç­‰çº§ä½“ç³»** | 4çº§é€’è¿›å¼ | `MembershipLevel` enum |
| **ç³»ç»Ÿé›†æˆ** | ä¸ pallet-affiliate æ·±åº¦é›†æˆ | å…³è”ç±»å‹ `AffiliateConfig` |
| **ä»·æ ¼é›†æˆ** | ä¸ pallet-pricing å®æ—¶è”åŠ¨ | å…³è”ç±»å‹ `PricingConfig` |

### 12.2 æœ€ä½³å®è·µ

#### 12.2.1 è´­ä¹°ä¼šå‘˜

âœ… **æ¨èåšæ³•**ï¼š
- å…ˆéªŒè¯æ¨èç æœ‰æ•ˆæ€§
- ç¡®ä¿è´¦æˆ·ä½™é¢å……è¶³ï¼ˆ**ğŸ†• æŒå¸ä»·å€¼â‰¥$100 USD**ï¼‰
- é€‰æ‹©åˆé€‚çš„ä¼šå‘˜ç­‰çº§
- ä¿å­˜äº¤æ˜“å“ˆå¸Œç”¨äºæŸ¥è¯¢
- **ğŸ†• è€ƒè™‘DUSTä»·æ ¼æ³¢åŠ¨**ï¼šå»ºè®®æŒå¸1,000,000+ DUSTä»¥åº”å¯¹ä»·æ ¼ä¸‹è·Œ

âŒ **é¿å…åšæ³•**ï¼š
- ä¸æ£€æŸ¥æ˜¯å¦å·²æ˜¯ä¼šå‘˜
- ä½¿ç”¨æ— æ•ˆçš„æ¨èç 
- é‡å¤æäº¤äº¤æ˜“
- **ğŸ†• å¿½ç•¥æŒå¸é—¨æ§›**ï¼šä»…è´­ä¹°ä¼šå‘˜ä½†ä½™é¢ä¸è¶³$100ä»·å€¼

#### 12.2.2 å‡çº§ä¼šå‘˜

âœ… **æ¨èåšæ³•**ï¼š
- Year1/Year3 ç”¨æˆ·å°½æ—©å‡çº§åˆ° Year10
- å‡çº§å‰è®¡ç®—æ€»æ”¯å‡ºï¼ˆåŸä»·æ ¼ + å‡çº§è´¹ç”¨ï¼‰
- ç†è§£å‡çº§åä»£æ•°å¢é•¿æœºåˆ¶å¤±æ•ˆ

âŒ **é¿å…åšæ³•**ï¼š
- é¢‘ç¹å‡çº§ï¼ˆä¸€æ¬¡æ€§åˆ°ä½æ›´åˆ’ç®—ï¼‰
- æœªç†è§£å‡çº§ä»·æ ¼ä½“ç³»
- å¿½ç•¥æœ‰æ•ˆæœŸé‡ç½®çš„æ”¶ç›Š

#### 12.2.3 æ¨èä»–äºº

âœ… **æ¨èåšæ³•**ï¼š
- ç¡®ä¿è‡ªå·±æ˜¯æœ‰æ•ˆä¼šå‘˜ï¼ˆ**ğŸ†• åŒ…æ‹¬æŒå¸ä»·å€¼â‰¥$100**ï¼‰
- å…ˆè®¤é¢†æ¨èç ï¼ˆ`claim_code()`ï¼‰
- æä¾›æ¸…æ™°çš„æ¨èç ç»™ä¸‹çº§
- è·Ÿè¸ªæ¨èäººæ•°å’Œä»£æ•°å¢é•¿
- **ğŸ†• æŒç»­ç›‘æ§æŒå¸ä»·å€¼**ï¼šé¿å…å› ä½™é¢ä¸è¶³å¤±å»æ¨èèµ„æ ¼

âŒ **é¿å…åšæ³•**ï¼š
- æœªè®¤é¢†æ¨èç å°±æ¨èä»–äºº
- æ¨èç åˆ†äº«ä¸æ˜ç¡®
- å¿½ç•¥ä»£æ•°å¢é•¿ä¸Šé™
- **ğŸ†• å¿½ç•¥æŒå¸çŠ¶æ€**ï¼šä½™é¢ä¸è¶³$100ä»·å€¼æ—¶ä»ç„¶æ¨èä»–äºº

#### ğŸ†• 12.2.4 æŒå¸ç®¡ç†ï¼ˆ2025-11-10 æ–°å¢ï¼‰

âœ… **æ¨èåšæ³•**ï¼š
- **ä¿æŒå®‰å…¨è¾¹é™…**ï¼šæŒå¸ä»·å€¼è¿œè¶…$100ï¼ˆå»ºè®®â‰¥$200ï¼‰
- **å®šæœŸæŸ¥è¯¢ä»·å€¼**ï¼šä½¿ç”¨`get_holding_value_usd()`ç›‘æ§
- **ä»·æ ¼ä¸‹è·Œæ—¶å……å€¼**ï¼šåŠæ—¶è¡¥å……DUSTä»¥ç»´æŒé—¨æ§›
- **å¤šä½™é¢è´¦æˆ·**ï¼šåˆ†æ•£é£é™©ï¼Œä¸æŠŠæ‰€æœ‰DUSTæ”¾åœ¨ä¸€ä¸ªè´¦æˆ·

âŒ **é¿å…åšæ³•**ï¼š
- **ä¸´ç•Œä½™é¢**ï¼šåˆšå¥½$100ä»·å€¼ï¼Œæ— å®‰å…¨è¾¹é™…
- **å¿½ç•¥ä»·æ ¼æ³¢åŠ¨**ï¼šDUSTä»·æ ¼ä¸‹è·Œåä¸è¡¥å……
- **é¢‘ç¹æç°**ï¼šå¯¼è‡´æŒå¸ä»·å€¼ä½äºé—¨æ§›
- **é›¶ä½™é¢ç­‰å¾…**ï¼šç­‰åˆ°å¤±å»æƒç›Šæ‰å……å€¼

### 12.3 å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

#### Q1: ä¼šå‘˜è¿‡æœŸåï¼Œæ¨èçš„ä¸‹çº§è¿˜å­˜åœ¨å—ï¼Ÿ

**A**: å­˜åœ¨ã€‚æ¨èå…³ç³»ç”± `pallet-affiliate` ç®¡ç†ï¼Œä¸å—æ¨èäººä¼šå‘˜çŠ¶æ€å½±å“ã€‚ä½†æ¨èäººè¿‡æœŸåï¼Œ**æ— æ³•è·å¾—ä¸‹çº§çš„è¿”ä½£**ã€‚

#### Q2: å‡çº§åˆ° Year10 åï¼Œè¿˜èƒ½ç»§ç»­æ¨èå—ï¼Ÿ

**A**: å¯ä»¥æ¨èï¼Œä½†ä¸ä¼šå¢åŠ å¥–åŠ±ä»£æ•°ï¼ˆå·²é”å®š15ä»£ï¼‰ã€‚æ¨èä»ç„¶æœ‰ä»·å€¼ï¼Œå› ä¸ºï¼š
- ä¸‹çº§æ¶ˆè´¹æ—¶ï¼Œä»å¯è·å¾—è¿”ä½£
- `referral_count` ä¼šç»§ç»­å¢é•¿

#### Q3: ä¼šå‘˜è´¹ç”¨å¦‚ä½•åˆ†é…ï¼Ÿ

**A**: å½“å‰ç‰ˆæœ¬ä¸­ï¼Œä¼šå‘˜è´¹ç”¨è¿›å…¥è”ç›Ÿæ‰˜ç®¡è´¦æˆ·ï¼Œä½†**åˆ†é…é€»è¾‘æœªå®ç°**ï¼ˆè§ lib.rs:382-388 çš„ TODO æ³¨é‡Šï¼‰ã€‚åç»­ç‰ˆæœ¬å°†å®ç° 100% æ¨èé“¾åˆ†é…ã€‚

#### Q4: å¯ä»¥ä» Year3 å‡çº§åˆ° Year5 å—ï¼Ÿ

**A**: ä¸å¯ä»¥ã€‚å½“å‰ä»…æ”¯æŒå‡çº§åˆ° Year10ï¼ˆ`upgrade_to_year10()`ï¼‰ã€‚

#### Q5: æ¨èç å¯ä»¥ä¿®æ”¹å—ï¼Ÿ

**A**: ä¸å¯ä»¥ã€‚æ¨èç è®¤é¢†åä¸å¯ä¿®æ”¹ï¼ˆ`AlreadyHasCode` é”™è¯¯ï¼‰ã€‚

#### ğŸ†• Q6: æŒå¸ä»·å€¼å¦‚ä½•è®¡ç®—ï¼Ÿï¼ˆ2025-11-10 æ–°å¢ï¼‰

**A**: æŒå¸ä»·å€¼ = è´¦æˆ·ä½™é¢ï¼ˆDUSTï¼‰Ã— DUSTå¸‚åœºä»·æ ¼ï¼ˆUSDT/DUSTï¼‰

**ç¤ºä¾‹**ï¼š
- ä½™é¢ï¼š1,000,000 DUST
- DUSTä»·æ ¼ï¼š0.0001 USDT/DUSTï¼ˆæ¥è‡ª pallet-pricingï¼‰
- æŒå¸ä»·å€¼ï¼š1,000,000 Ã— 0.0001 = **$100 USD** âœ…

**æŸ¥è¯¢æ–¹å¼**ï¼š
```rust
let (dollars, cents) = Membership::get_holding_value_usd(&who);
// è¿”å› (100, 0) è¡¨ç¤º $100.00
```

#### ğŸ†• Q7: DUSTä»·æ ¼ä¸‹è·Œåï¼Œæˆ‘ä¼šå¤±å»ä¼šå‘˜æƒç›Šå—ï¼Ÿï¼ˆ2025-11-10 æ–°å¢ï¼‰

**A**: æ˜¯çš„ã€‚å¦‚æœDUSTä»·æ ¼ä¸‹è·Œå¯¼è‡´æŒå¸ä»·å€¼ < $100 USDï¼Œä½ ä¼š**æš‚æ—¶å¤±å»**ä¼šå‘˜æƒç›Šï¼ŒåŒ…æ‹¬ï¼š
- âŒ æ— æ³•è·å¾—æ¨èè¿”ä½£
- âŒ æ— æ³•äº«å—ä¼šå‘˜æŠ˜æ‰£
- âŒ æ— æ³•è¢«ä»–äººè®¾ä¸ºæ¨èäºº

**è§£å†³æ–¹æ³•**ï¼š
1. å……å€¼DUSTï¼Œä½¿æŒå¸ä»·å€¼ â‰¥ $100
2. æƒç›Šä¼š**è‡ªåŠ¨æ¢å¤**ï¼ˆæ— éœ€é‡æ–°è´­ä¹°ä¼šå‘˜ï¼‰

**é˜²èŒƒæªæ–½**ï¼š
- å»ºè®®æŒå¸ä»·å€¼ â‰¥ $200ï¼ˆ100%å®‰å…¨è¾¹é™…ï¼‰
- å®šæœŸæŸ¥è¯¢æŒå¸ä»·å€¼ï¼ŒåŠæ—¶è¡¥å……

#### ğŸ†• Q8: ä¸ºä»€ä¹ˆæ˜¯ä»·å€¼é—¨æ§›è€Œä¸æ˜¯æ•°é‡é—¨æ§›ï¼Ÿï¼ˆ2025-11-10 æ–°å¢ï¼‰

**A**: ä»·å€¼é—¨æ§›æ›´åŠ å…¬å¹³å’Œç»æµåˆç†ï¼š

**ä»·å€¼é—¨æ§›ä¼˜åŠ¿**ï¼š
- âœ… **ä»·æ ¼æ³¢åŠ¨è‡ªé€‚åº”**ï¼šDUSTä»·æ ¼ä¸Šæ¶¨æ—¶æ‰€éœ€æ•°é‡å‡å°‘
- âœ… **å…¬å¹³æ€§**ï¼šæ‰€æœ‰ä¼šå‘˜æ ‡å‡†ç»Ÿä¸€ï¼ˆæ— è®ºåŠ å…¥æ—¶é—´ï¼‰
- âœ… **ç»æµåˆç†**ï¼šé—¨æ§›å§‹ç»ˆç­‰ä»·äº$100è´­ä¹°åŠ›

**æ•°é‡é—¨æ§›ç¼ºé™·**ï¼š
- âŒ **ä¸å…¬å¹³**ï¼šæ—©æœŸä¾¿å®œæ—¶åŠ å…¥çš„ç”¨æˆ·å ä¾¿å®œ
- âŒ **åƒµåŒ–**ï¼šæ— æ³•é€‚åº”å¸‚åœºå˜åŒ–
- âŒ **é€šèƒ€é£é™©**ï¼šDUSTè´¬å€¼åé—¨æ§›å¤±å»æ„ä¹‰

**å¯¹æ¯”ç¤ºä¾‹**ï¼š

| DUSTä»·æ ¼ | ä»·å€¼é—¨æ§›ï¼ˆçµæ´»ï¼‰ | æ•°é‡é—¨æ§›ï¼ˆå›ºå®š1M DUSTï¼‰ |
|---------|----------------|----------------------|
| 0.0001 USDT | éœ€è¦ 1,000,000 DUST | éœ€è¦ 1,000,000 DUST |
| 0.0002 USDT | éœ€è¦ 500,000 DUST âœ… | éœ€è¦ 1,000,000 DUST âŒ |
| 0.00005 USDT | éœ€è¦ 2,000,000 DUST âœ… | éœ€è¦ 1,000,000 DUST âŒï¼ˆä»·å€¼ä»…$50ï¼‰ |

#### ğŸ†• Q9: æŒå¸ä»·å€¼ä¸è¶³æ—¶ï¼Œå·²æœ‰çš„æ¨èå…³ç³»ä¼šæ¶ˆå¤±å—ï¼Ÿï¼ˆ2025-11-10 æ–°å¢ï¼‰

**A**: ä¸ä¼šæ¶ˆå¤±ã€‚æ¨èå…³ç³»ç”± `pallet-affiliate` ç®¡ç†ï¼Œ**æ°¸ä¹…ä¿ç•™**ã€‚

**å½±å“èŒƒå›´**ï¼š
- âœ… æ¨èå…³ç³»ä»ç„¶å­˜åœ¨
- âœ… æ¨èæ ‘ç»“æ„å®Œæ•´
- âœ… `referral_count` ä¸å—å½±å“
- âŒ **æš‚æ—¶æ— æ³•è·å¾—è¿”ä½£**ï¼ˆç›´åˆ°æŒå¸ä»·å€¼æ¢å¤â‰¥$100ï¼‰

**æ¢å¤æ–¹æ³•**ï¼š
1. å……å€¼DUSTä½¿æŒå¸ä»·å€¼â‰¥$100
2. æƒç›Šè‡ªåŠ¨æ¢å¤ï¼Œå¼€å§‹è®¡ç®—è¿”ä½£
3. æ— éœ€é‡æ–°ç»‘å®šæ¨èå…³ç³»

### 12.4 æœªæ¥ä¼˜åŒ–æ–¹å‘

**ğŸ†• 2025-11-10 æ›´æ–°**ï¼šæŒå¸é—¨æ§›æœºåˆ¶å·²å®æ–½

| ä¼˜åŒ–é¡¹ | ä¼˜å…ˆçº§ | é¢„æœŸæ”¶ç›Š | çŠ¶æ€ |
|-------|-------|---------|------|
| **âœ… æŒå¸ä»·å€¼é—¨æ§›** | ğŸ”´ P0 | å¢å¼ºå‡†å…¥æ§åˆ¶ | å·²å®Œæˆ |
| **å®ç°ä¼šå‘˜è´¹ç”¨åˆ†é…** | ğŸ”´ P0 | å®Œå–„ç»æµæ¨¡å‹ | å¾…å®æ–½ |
| **æ”¯æŒæ¸è¿›å¼å‡çº§** | ğŸŸ  P1 | æå‡ç”¨æˆ·ä½“éªŒ | å¾…è¯„ä¼° |
| **ä¼šå‘˜ç»­è´¹åŠŸèƒ½** | ğŸŸ¡ P2 | é™ä½ç”¨æˆ·æµå¤± | å¾…è¯„ä¼° |
| **æŒå¸ä»·å€¼é¢„è­¦** | ğŸŸ¡ P2 | æå‡ç”¨æˆ·ä½“éªŒ | å¾…å®æ–½ |
| **ä¼šå‘˜NFTå¾½ç« ** | ğŸŸ¢ P3 | å¢å¼ºä¼šå‘˜è£èª‰æ„Ÿ | å¾…è¯„ä¼° |
| **æ¨èæ’è¡Œæ¦œ** | ğŸŸ¢ P3 | æ¿€åŠ±æ¨å¹¿ | å¾…è¯„ä¼° |

**æ–°å¢ä¼˜åŒ–æ–¹å‘**ï¼ˆåŸºäºæŒå¸é—¨æ§›æœºåˆ¶ï¼‰ï¼š

1. **æŒå¸ä»·å€¼é¢„è­¦ç³»ç»Ÿ** (P2)
   - é“¾ä¸Šç›‘æ§æŒå¸ä»·å€¼
   - ä½äº$110æ—¶å‘é€é¢„è­¦
   - å‰ç«¯çº¢è‰²è­¦å‘Šæç¤º

2. **ä»·æ ¼æ³¢åŠ¨ç¼“å†²** (P2)
   - æ²»ç†å¯è°ƒæ•´é—¨æ§›ï¼ˆå¦‚é™è‡³$80ï¼‰
   - åº”å¯¹æç«¯å¸‚åœºæ³¢åŠ¨
   - ä¿æŠ¤ä¼šå‘˜æƒç›Š

3. **åˆ†çº§æŒå¸é—¨æ§›** (P1)
   - Year1: $50 USD
   - Year3: $75 USD
   - Year5: $90 USD
   - Year10: $100 USD
   - æ¿€åŠ±ä¼šå‘˜å‡çº§

---

## é™„å½•ï¼šRuntime é…ç½®ç¤ºä¾‹

**ğŸ†• 2025-11-10 æ›´æ–°**ï¼šå¢åŠ æŒå¸é—¨æ§›ç›¸å…³é…ç½®

```rust
impl pallet_membership::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type Currency = Balances;
    type PalletId = MembershipPalletId;
    type BlocksPerYear = BlocksPerYear;
    type Units = Units;
    type AffiliateConfig = Self; // Runtime å®ç°äº† pallet_affiliate::Config

    // ğŸ†• 2025-11-10ï¼šä»·æ ¼æŸ¥è¯¢ç³»ç»Ÿé…ç½®
    type PricingConfig = Runtime; // Runtime å®ç°äº† pallet_pricing::Config

    // ğŸ†• 2025-11-10ï¼šæœ€ä½æŒå¸ä»·å€¼ï¼ˆç¾åˆ†ï¼‰
    type MinHoldingValueCents = MinHoldingValueCents; // 10000 = $100 USD

    type GovernanceOrigin = EnsureRootOrHalfCouncil;
    type MinMembershipPrice = MinMembershipPrice;
    type MaxMembershipPrice = MaxMembershipPrice;
    type AffiliatePalletId = AffiliatePalletId;
    type WeightInfo = pallet_membership::weights::SubstrateWeight<Runtime>;
}

// å‚æ•°é…ç½®
parameter_types! {
    pub const MembershipPalletId: PalletId = PalletId(*b"py/mbshp");
    pub const AffiliatePalletId: PalletId = PalletId(*b"py/affil");
    pub const BlocksPerYear: BlockNumber = 5_256_000; // 6ç§’å‡ºå—
    pub const Units: Balance = 1_000_000_000_000; // 1 DUST = 10^12
    pub const MinMembershipPrice: Balance = 100_000_000_000_000; // 100 DUST
    pub const MaxMembershipPrice: Balance = 10_000_000_000_000_000; // 10,000 DUST

    // ğŸ†• 2025-11-10ï¼šæœ€ä½æŒå¸ä»·å€¼ï¼ˆç¾åˆ†ï¼‰
    // 10000ç¾åˆ† = 100ç¾å…ƒ
    pub const MinHoldingValueCents: u64 = 10000;
}
```

**é…ç½®è¯´æ˜**ï¼š

| é…ç½®é¡¹ | ç±»å‹ | å€¼ | è¯´æ˜ |
|-------|------|----|----|
| `PricingConfig` | Runtime | `Runtime` | **ğŸ†•** è¿æ¥ pallet-pricingï¼Œè·å–å¸‚åœºä»·æ ¼ |
| `MinHoldingValueCents` | u64 | `10000` | **ğŸ†•** æœ€ä½æŒå¸ä»·å€¼ï¼ˆ100ç¾å…ƒ = 10000ç¾åˆ†ï¼‰ |
| `Currency` | Currency | `Balances` | DUSTä»£å¸ç³»ç»Ÿ |
| `PalletId` | PalletId | `py/mbshp` | Membershipæ¨¡å—è´¦æˆ·ID |
| `BlocksPerYear` | BlockNumber | `5,256,000` | æ¯å¹´åŒºå—æ•°ï¼ˆ6ç§’/å—ï¼‰ |
| `Units` | Balance | `10^12` | DUSTç²¾åº¦ï¼ˆ1 DUST = 10^12ï¼‰ |
| `AffiliateConfig` | Runtime | `Runtime` | è¿æ¥è”ç›Ÿè®¡é…¬ç³»ç»Ÿ |

**ä»·æ ¼ç²¾åº¦è¯´æ˜**ï¼š

- **DUSTä½™é¢ç²¾åº¦**ï¼š10^12ï¼ˆ1 DUST = 1,000,000,000,000ï¼‰
- **USDTä»·æ ¼ç²¾åº¦**ï¼š10^6ï¼ˆ1 USDT = 1,000,000ï¼‰
- **USDé‡‘é¢ç²¾åº¦**ï¼š100ï¼ˆ1 USD = 100 centsï¼‰

**è®¡ç®—ç¤ºä¾‹**ï¼š

```rust
// 1. è·å–è´¦æˆ·ä½™é¢ï¼ˆç²¾åº¦ 10^12ï¼‰
let balance: u128 = 1_000_000_000_000_000_000; // 1,000,000 DUST

// 2. è·å– DUST å¸‚åœºä»·æ ¼ï¼ˆç²¾åº¦ 10^6ï¼‰
let dust_price_usdt: u64 = 100; // 0.0001 USDT/DUST

// 3. è®¡ç®—æŒå¸ä»·å€¼ï¼ˆç¾åˆ†ï¼‰
let holding_value_cents = (balance * dust_price_usdt * 100) / 10^18
                        = (1,000,000 * 10^12 * 100 * 100) / 10^18
                        = 10,000 ç¾åˆ†
                        = $100.00 USD âœ…

// 4. éªŒè¯é—¨æ§›
holding_value_cents >= MinHoldingValueCents::get() // 10000 >= 10000 âœ…
```

---

**æ–‡æ¡£ç»“æŸ**

å¦‚æœ‰ç–‘é—®ï¼Œè¯·å‚è€ƒä»£ç æ³¨é‡Šæˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚
