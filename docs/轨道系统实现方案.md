# 轨道系统（Tracks）实现方案

## 概述

轨道系统是OpenGov（Governance v2）的核心概念，不同类型的治理提案使用不同的轨道，每个轨道有独立的参数配置。

---

## 一、轨道系统原理

### 1.1 什么是轨道？

```
轨道（Track）= 一组治理参数配置

每个轨道包含：
  - 名称（Root、Treasury、Content等）
  - 决策押金（Decision Deposit）
  - 准备期（Prepare Period）
  - 决策期（Decision Period）
  - 确认期（Confirm Period）
  - 最小批准曲线（Min Approval）
  - 最小支持曲线（Min Support）
  - 最大同时决策数（Max Deciding）
```

### 1.2 为什么需要轨道？

```
不同治理事项风险不同：

Root轨道（系统升级）:
  风险：⭐⭐⭐⭐⭐ 极高
  参数：严格（高押金、长时间、高阈值）
  
财库轨道（资金支出）:
  风险：⭐⭐⭐⭐ 高
  参数：中等（中押金、中时间、中阈值）
  
内容轨道（内容治理）:
  风险：⭐⭐ 低
  参数：宽松（低押金、短时间、低阈值）

好处：
  - 降低无关紧要提案的门槛
  - 提高重要提案的安全性
  - 提升治理效率
```

### 1.3 Memopark的轨道配置

**建议的轨道**：

| ID | 名称 | 用途 | 押金 | 决策期 | 确认期 |
|----|----|------|------|--------|--------|
| 0 | Root | 系统升级、危险调用 | 1000 MEMO | 28天 | 24小时 |
| 1 | Whitelisted | 白名单调用 | 500 MEMO | 14天 | 12小时 |
| 2 | Treasury | 财库支出 | 100 MEMO | 14天 | 12小时 |
| 3 | Medium Spender | 中等支出(1K-10K) | 200 MEMO | 14天 | 12小时 |
| 4 | Big Spender | 大额支出(>10K) | 500 MEMO | 21天 | 24小时 |
| 10 | Market Maker | 做市商治理 | 50 MEMO | 7天 | 6小时 |
| 11 | Arbitration | 仲裁裁决 | 50 MEMO | 7天 | 6小时 |
| 20 | Content | 内容治理 | 10 MEMO | 3天 | 3小时 |
| 21 | Park | 陵园治理 | 20 MEMO | 7天 | 6小时 |

---

## 二、技术实现方案

### 2.1 轨道服务层

```typescript
// src/services/blockchain/tracks.ts

import type { ApiPromise } from '@polkadot/api'

/**
 * 轨道信息接口
 */
export interface TrackInfo {
  id: number
  name: string
  maxDeciding: number
  decisionDeposit: string
  preparePeriod: number
  decisionPeriod: number
  confirmPeriod: number
  minEnactmentPeriod: number
  minApproval: any
  minSupport: any
}

/**
 * 获取所有轨道配置
 */
export async function getTracks(api: ApiPromise): Promise<TrackInfo[]> {
  try {
    // 从链上常量获取轨道配置
    const tracksConst: any = await api.consts.referenda.tracks
    const tracksData = tracksConst.toJSON() as any[]
    
    return tracksData.map(([id, config]: any) => ({
      id,
      name: getTrackName(id),
      maxDeciding: config.maxDeciding,
      decisionDeposit: config.decisionDeposit,
      preparePeriod: config.preparePeriod,
      decisionPeriod: config.decisionPeriod,
      confirmPeriod: config.confirmPeriod,
      minEnactmentPeriod: config.minEnactmentPeriod,
      minApproval: config.minApproval,
      minSupport: config.minSupport
    }))
  } catch (e) {
    console.error('[Tracks] 获取轨道失败:', e)
    throw e
  }
}

/**
 * 获取轨道名称
 */
export function getTrackName(trackId: number): string {
  const names: Record<number, string> = {
    0: 'Root',
    1: 'Whitelisted Caller',
    2: 'Treasurer',
    3: 'Medium Spender',
    4: 'Big Spender',
    10: 'Market Maker',
    11: 'Arbitration',
    20: 'Content',
    21: 'Park'
  }
  return names[trackId] || `Track ${trackId}`
}

/**
 * 获取轨道颜色
 */
export function getTrackColor(trackId: number): string {
  const colors: Record<number, string> = {
    0: 'red',         // Root - 红色（危险）
    1: 'orange',      // Whitelisted - 橙色
    2: 'green',       // Treasury - 绿色（财务）
    3: 'cyan',        // Medium Spender
    4: 'blue',        // Big Spender
    10: 'purple',     // Market Maker - 紫色
    11: 'magenta',    // Arbitration - 品红
    20: 'gold',       // Content - 金色
    21: 'lime'        // Park - 青柠
  }
  return colors[trackId] || 'default'
}
```

### 2.2 轨道Hook

```typescript
// src/hooks/useTracks.ts

import { useState, useEffect } from 'react'
import { useApi } from '@/contexts/Api'
import { getTracks, type TrackInfo } from '@/services/blockchain/tracks'

export function useTracks() {
  const { api, isReady } = useApi()
  const [tracks, setTracks] = useState<TrackInfo[]>([])
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<Error | null>(null)

  useEffect(() => {
    if (!isReady || !api) return

    const loadTracks = async () => {
      setLoading(true)
      try {
        const data = await getTracks(api)
        setTracks(data)
      } catch (e) {
        setError(e as Error)
      } finally {
        setLoading(false)
      }
    }

    loadTracks()
  }, [api, isReady])

  return { tracks, loading, error }
}
```

### 2.3 轨道选择器组件

```typescript
// src/components/TrackSelector/index.tsx

import { Card, Space, Tag, Typography, Descriptions } from 'antd'
import { useTracks } from '@/hooks/useTracks'
import { formatBalance } from '@/utils/format'
import { getTrackColor } from '@/services/blockchain/tracks'

interface Props {
  value?: number
  onChange?: (trackId: number) => void
}

export function TrackSelector({ value, onChange }: Props) {
  const { tracks, loading } = useTracks()

  if (loading) return <div>加载轨道...</div>

  return (
    <div>
      <Typography.Title level={5}>选择治理轨道</Typography.Title>
      <Space direction="vertical" style={{ width: '100%' }} size={12}>
        {tracks.map((track) => (
          <Card
            key={track.id}
            size="small"
            hoverable
            onClick={() => onChange?.(track.id)}
            style={{
              border:
                value === track.id
                  ? '2px solid #1890ff'
                  : '1px solid #d9d9d9',
              background: value === track.id ? '#e6f4ff' : '#fff'
            }}
          >
            <Space direction="vertical" style={{ width: '100%' }}>
              <Space>
                <Tag color={getTrackColor(track.id)}>{track.name}</Tag>
                {value === track.id && <Tag color="blue">已选择</Tag>}
              </Space>

              <Descriptions size="small" column={2}>
                <Descriptions.Item label="决策押金">
                  {formatBalance(track.decisionDeposit)} MEMO
                </Descriptions.Item>
                <Descriptions.Item label="最大并发">
                  {track.maxDeciding}
                </Descriptions.Item>
                <Descriptions.Item label="准备期">
                  {track.preparePeriod} 区块
                </Descriptions.Item>
                <Descriptions.Item label="决策期">
                  {track.decisionPeriod} 区块
                </Descriptions.Item>
                <Descriptions.Item label="确认期">
                  {track.confirmPeriod} 区块
                </Descriptions.Item>
                <Descriptions.Item label="最小延迟">
                  {track.minEnactmentPeriod} 区块
                </Descriptions.Item>
              </Descriptions>
            </Space>
          </Card>
        ))}
      </Space>
    </div>
  )
}
```

### 2.4 公投列表（按轨道分类）

```typescript
// src/pages/Referenda/List/index.tsx

export default function ReferendaList() {
  const [selectedTrack, setSelectedTrack] = useState<number | undefined>()
  const { tracks } = useTracks()
  const { referenda, loading } = useReferenda(selectedTrack)

  return (
    <div>
      <Row gutter={24}>
        {/* 左侧：轨道筛选 */}
        <Col span={6}>
          <Card title="按轨道筛选">
            <Menu
              selectedKeys={selectedTrack ? [String(selectedTrack)] : []}
              onClick={({ key }) => setSelectedTrack(Number(key))}
            >
              <Menu.Item key="all">全部轨道</Menu.Item>
              {tracks.map((track) => (
                <Menu.Item key={track.id}>
                  <Space>
                    <Tag color={getTrackColor(track.id)}>{track.name}</Tag>
                    <span>({getReferendaCountByTrack(track.id)})</span>
                  </Space>
                </Menu.Item>
              ))}
            </Menu>
          </Card>
        </Col>

        {/* 右侧：公投列表 */}
        <Col span={18}>
          <Card
            title={
              <Space>
                <span>公投列表</span>
                {selectedTrack && (
                  <Tag color={getTrackColor(selectedTrack)}>
                    {tracks.find((t) => t.id === selectedTrack)?.name}
                  </Tag>
                )}
              </Space>
            }
          >
            <Table
              columns={columns}
              dataSource={referenda}
              loading={loading}
            />
          </Card>
        </Col>
      </Row>
    </div>
  )
}
```

---

## 三、多委员会支持方案

### 3.1 当前问题

```
当前只支持 Council（主委员会）

但Memopark有多个委员会：
  - Council（Instance1） - 主委员会
  - Technical Committee（Instance2） - 技术委员会
  - Content Committee（Instance3） - 内容委员会

问题：
  ❌ 无法切换委员会
  ❌ 无法查看其他委员会的提案
  ❌ 权限检查不完整
```

### 3.2 实现方案

```typescript
// src/types/committee.ts

export type CommitteeType = 'council' | 'technicalCommittee' | 'contentCommittee'

export interface CommitteeConfig {
  key: CommitteeType
  name: string
  icon: React.ReactNode
  pallet: string
  description: string
}

export const COMMITTEES: CommitteeConfig[] = [
  {
    key: 'council',
    name: '主委员会',
    icon: <TeamOutlined />,
    pallet: 'council',
    description: '负责整体治理决策'
  },
  {
    key: 'technicalCommittee',
    name: '技术委员会',
    icon: <CodeOutlined />,
    pallet: 'technicalCommittee',
    description: '负责技术升级和紧急修复'
  },
  {
    key: 'contentCommittee',
    name: '内容委员会',
    icon: <SafetyOutlined />,
    pallet: 'contentCommittee',
    description: '负责内容审核和申诉处理'
  }
]
```

```typescript
// src/hooks/useCommittee.ts

export function useCommittee(committeeType: CommitteeType) {
  const { api, isReady } = useApi()
  const [proposals, setProposals] = useState([])
  const [members, setMembers] = useState([])
  
  useEffect(() => {
    if (!isReady || !api) return
    
    const loadData = async () => {
      // 根据委员会类型选择pallet
      const pallet = (api.query as any)[committeeType]
      
      // 查询提案
      const proposalHashes = await pallet.proposals()
      
      // 查询成员
      const memberList = await pallet.members()
      
      setProposals(/* ... */)
      setMembers(memberList.toJSON())
    }
    
    loadData()
  }, [api, isReady, committeeType])
  
  return { proposals, members }
}
```

```typescript
// src/components/CommitteeSwitch/index.tsx

export function CommitteeSwitch({ value, onChange }: Props) {
  return (
    <Segmented
      value={value}
      onChange={onChange}
      options={COMMITTEES.map((c) => ({
        label: (
          <Space>
            {c.icon}
            {c.name}
          </Space>
        ),
        value: c.key
      }))}
      block
    />
  )
}
```

**页面集成**：

```typescript
// src/pages/Committees/index.tsx

export default function CommitteesPage() {
  const [currentCommittee, setCurrentCommittee] = useState<CommitteeType>('council')
  const { proposals, members } = useCommittee(currentCommittee)
  
  return (
    <div>
      {/* 委员会切换器 */}
      <CommitteeSwitch
        value={currentCommittee}
        onChange={setCurrentCommittee}
      />
      
      {/* 通用的提案列表 */}
      <ProposalList proposals={proposals} />
      
      {/* 通用的成员列表 */}
      <MemberList members={members} />
    </div>
  )
}
```

---

## 四、UI完善详细方案

### 4.1 仪表盘增强

**当前**: 基础统计卡片  
**完善**: 多维度数据展示

```typescript
// 增加的内容:

1. 按轨道分类统计
   ┌──────────┬──────────┬──────────┐
   │ Root轨道 │ 财库轨道  │ 内容轨道  │
   │ 2个提案  │ 5个提案   │ 8个提案   │
   └──────────┴──────────┴──────────┘

2. 按委员会分类
   ┌──────────┬──────────┬──────────┐
   │ 主委员会 │ 技术委员会│ 内容委员会│
   │ 3个提案  │ 1个提案   │ 4个提案   │
   └──────────┴──────────┴──────────┘

3. 待办事项列表
   - 需要我投票的提案（5个）
   - 可以执行的提案（2个）
   - 待审核的申请（8个）
   - 待处理的申诉（12个）

4. 最近活动时间线
   - 10:30 - Bob投票赞成提案#5
   - 10:15 - Alice批准了申诉#45
   - 10:00 - Charlie创建了提案#6
```

### 4.2 提案列表增强

**当前**: 单一列表  
**完善**: 多维度展示

```typescript
// 增加的功能:

1. 轨道标签显示
   提案#5 | [财库轨道] 支出提案 | 进度...

2. 委员会来源显示
   提案#5 | [主委员会] | [财库轨道] | ...

3. 多条件筛选
   - 轨道筛选
   - 委员会筛选
   - 状态筛选
   - 时间筛选
   - 金额筛选

4. 高级排序
   - 按优先级排序
   - 按金额排序
   - 按截止时间排序
   - 按投票进度排序
```

### 4.3 数据分析增强

**当前**: 基础饼图和柱状图  
**完善**: 多维度分析

```typescript
// 增加的图表:

1. 轨道使用分析
   - 各轨道提案数量（饼图）
   - 各轨道通过率（柱状图）
   - 轨道趋势（折线图）

2. 时间趋势分析
   - 月度提案数量（折线图）
   - 月度通过率（折线图）
   - 季度资金支出（柱状图）

3. 对比分析
   - 委员会对比（雷达图）
   - 轨道对比（平行坐标图）
   - 成员对比（热力图）

4. 实时监控
   - 关键指标监控
   - 异常预警
   - 趋势预测
```

---

## 五、具体UI设计

### 5.1 轨道选择页面

```
┌─────────────────────────────────────────────┐
│ 选择治理轨道                                 │
├─────────────────────────────────────────────┤
│                                             │
│ ┌───────────────────────────────────────┐   │
│ │ [Root轨道] ← 已选择                    │   │
│ │ 系统升级、危险调用                      │   │
│ │ ┌─────────┬─────────┬─────────────┐   │   │
│ │ │押金     │决策期    │确认期        │   │   │
│ │ │1000MEMO │28天     │24小时        │   │   │
│ │ └─────────┴─────────┴─────────────┘   │   │
│ │ ⚠️ 风险等级：极高                      │   │
│ └───────────────────────────────────────┘   │
│                                             │
│ ┌───────────────────────────────────────┐   │
│ │ [财库轨道]                              │   │
│ │ 资金支出、预算分配                      │   │
│ │ ┌─────────┬─────────┬─────────────┐   │   │
│ │ │押金     │决策期    │确认期        │   │   │
│ │ │100MEMO  │14天     │12小时        │   │   │
│ │ └─────────┴─────────┴─────────────┘   │   │
│ │ ⚠️ 风险等级：中等                      │   │
│ └───────────────────────────────────────┘   │
│                                             │
│ ┌───────────────────────────────────────┐   │
│ │ [内容轨道]                              │   │
│ │ 内容治理、申诉处理                      │   │
│ │ ┌─────────┬─────────┬─────────────┐   │   │
│ │ │押金     │决策期    │确认期        │   │   │
│ │ │10MEMO   │3天      │3小时         │   │   │
│ │ └─────────┴─────────┴─────────────┘   │   │
│ │ ⚠️ 风险等级：低                        │   │
│ └───────────────────────────────────────┘   │
│                                             │
│ [继续] [返回]                                │
└─────────────────────────────────────────────┘
```

### 5.2 公投列表（按轨道）

```
┌─────────────────────────────────────────────┐
│ 公投管理                        [刷新]       │
├─────────────────────────────────────────────┤
│ 轨道筛选                                     │
│ [全部] [Root(2)] [财库(5)] [内容(8)]        │
├─────────────────────────────────────────────┤
│ ID | 轨道 | 提案 | 进度 | Aye | Nay | 状态  │
│ #8 | 内容 | 删除XX | ████░ 78% | 1.2M | 0.3M│
│ #7 | 财库 | 支出YY | ███░░ 65% | 850K | 200K│
│ #6 | Root | 升级ZZ | ██████100%| 2.5M | 100K│
└─────────────────────────────────────────────┘

点击查看详情 →

┌─────────────────────────────────────────────┐
│ 公投 #8 详情                                 │
├─────────────────────────────────────────────┤
│ 轨道: [内容] Content                        │
│ 标题: 删除违规内容XX                        │
│ 提案人: 0x1234...5678                       │
│ 押金: 10 MEMO                              │
│                                             │
│ 投票进度:                                    │
│ Aye: ████████████░░ 78% (1,234,567 MEMO)  │
│ Nay: ███░░░░░░░░░░ 22% (345,678 MEMO)    │
│                                             │
│ 决策期: 还剩 2天 5小时                      │
│ 确认期: 未开始                              │
│                                             │
│ Preimage: 0xabcd1234...                    │
│ [查看Preimage内容]                          │
│                                             │
│ 管理操作（仅管理员）:                        │
│ [取消公投] [强制通过] [延长投票期]          │
└─────────────────────────────────────────────┘
```

---

## 六、实施计划

### Phase 4A: 轨道系统（2周）

**Week 1: 轨道基础**
```
创建文件：
  - src/services/blockchain/tracks.ts
  - src/hooks/useTracks.ts
  - src/components/TrackSelector/

功能：
  - 查询轨道配置
  - 轨道Hook
  - 轨道选择器组件
  - 轨道标签和颜色

测试：
  - 查询所有轨道
  - 显示轨道参数
  - 选择轨道
```

**Week 2: 公投管理**
```
创建文件：
  - src/pages/Referenda/List/
  - src/pages/Referenda/Detail/
  - src/services/blockchain/referenda.ts

功能：
  - 按轨道展示公投
  - 公投详情
  - 投票数据展示
  - Preimage查看
  - 管理员操作

测试：
  - 查看不同轨道的公投
  - 筛选和排序
  - 查看投票进度
```

### Phase 4B: 多委员会（1周）

**Week 3: 通用化改造**
```
修改文件：
  - src/pages/Committees/（新建通用页面）
  - src/hooks/useCommittee.ts（通用Hook）
  - src/components/CommitteeSwitch/（切换器）

功能：
  - 支持3个委员会
  - 通用的提案列表
  - 委员会切换
  - 权限适配

测试：
  - 切换委员会查看提案
  - 不同委员会的权限
  - 跨委员会数据对比
```

---

## 七、数据结构设计

### 7.1 轨道配置

```rust
// Runtime配置示例

pub struct TrackInfo {
    name: &'static str,
    max_deciding: u32,
    decision_deposit: Balance,
    prepare_period: BlockNumber,
    decision_period: BlockNumber,
    confirm_period: BlockNumber,
    min_enactment_period: BlockNumber,
    min_approval: Curve,
    min_support: Curve,
}

// 轨道列表
pub const TRACKS: [(u16, TrackInfo); 9] = [
    (0, TrackInfo {
        name: "root",
        max_deciding: 1,
        decision_deposit: 1_000 * MEMO,
        prepare_period: 7 * DAYS,
        decision_period: 28 * DAYS,
        confirm_period: 24 * HOURS,
        // ...
    }),
    (2, TrackInfo {
        name: "treasurer",
        max_deciding: 10,
        decision_deposit: 100 * MEMO,
        prepare_period: 2 * DAYS,
        decision_period: 14 * DAYS,
        confirm_period: 12 * HOURS,
        // ...
    }),
    (20, TrackInfo {
        name: "content",
        max_deciding: 20,
        decision_deposit: 10 * MEMO,
        prepare_period: 1 * DAYS,
        decision_period: 3 * DAYS,
        confirm_period: 3 * HOURS,
        // ...
    }),
    // ...
];
```

---

## 八、优先级建议

### 立即实施（Phase 4）⭐⭐⭐⭐⭐

1. **轨道系统基础**（2周）
   - 查询轨道配置
   - 轨道选择器
   - 轨道标签显示

2. **多委员会支持**（1周）
   - 委员会切换
   - 通用化组件
   - 权限适配

### 近期实施（Phase 5）⭐⭐⭐⭐

3. **公投管理**（2周）
   - 公投列表（按轨道）
   - 公投详情
   - Preimage管理

4. **财库管理**（2周）
   - 财库余额
   - 支出审批
   - 财务报表

### 可选实施（Phase 6）⭐⭐⭐

5. **通知系统**（1周）
6. **导出功能**（1周）
7. **高级筛选**（1周）
8. **性能优化**（1周）

---

## 总结

### ✅ 您的观察完全正确

**关键缺失**：
1. ⏳ 轨道系统（OpenGov核心）
2. ⏳ 多委员会支持
3. ⏳ 公投管理（审核侧）

**建议**：
- **优先实现轨道系统**（OpenGov基础）
- **支持多委员会**（项目实际需求）
- **添加公投管理**（完整治理）

**预计工时**：
- Phase 4: 3周（轨道+多委员会）
- Phase 5: 4周（公投+财库）
- Phase 6: 4周（优化扩展）

**总计**: 11周达到100%完成度

---

**下一步建议**: 实施Phase 4（轨道系统+多委员会支持）

**优先级**: ⭐⭐⭐⭐⭐ 最高

