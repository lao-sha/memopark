# P1é—®é¢˜ä¿®å¤å®ŒæˆæŠ¥å‘Š - ä»·æ ¼é”å®šå’Œå®½é™æœŸ

## ä¿®å¤æ¦‚è¿°

**ä¿®å¤æ—¥æœŸ**: 2025-01-15

**é—®é¢˜ç¼–å·**: P1é—®é¢˜1 + P1é—®é¢˜3

**é—®é¢˜æè¿°**:
1. ç»­è´¹æ—¶ä½¿ç”¨å½“å‰ä»·æ ¼è€Œéè®¢é˜…æ—¶çš„é”å®šä»·æ ¼
2. ç»­è´¹å¤±è´¥åç›´æ¥è¿‡æœŸï¼Œæ— å®½é™æœŸ

**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œç¼–è¯‘éªŒè¯é€šè¿‡

**ä¿®å¤æ—¶é—´**: çº¦45åˆ†é’Ÿ

---

## ä¸€ã€é—®é¢˜å›é¡¾

### 1.1 é—®é¢˜3: ç»­è´¹ä»·æ ¼ä¸ç¨³å®š

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ High

**é—®é¢˜ä½ç½®**: `pallets/memorial/src/lib.rs:1121-1122`

**é—®é¢˜ä»£ç ** (ä¿®å¤å‰):
```rust
// Line 1121-1126
let user_type = Self::determine_user_type(&record.who);
let current_block = <frame_system::Pallet<T>>::block_number();
let unit_price = sacrifice.get_effective_price(user_type, current_block)
    .ok_or(Error::<T>::PricingNotAvailable)?;

let renew_amount = unit_price.saturating_mul(record.quantity as u128);
```

**é—®é¢˜å½±å“**:
- âŒ ç”¨æˆ·ä½“éªŒå·®ï¼šè®¢é˜…ä»·æ ¼ä¸ç¨³å®šï¼Œæ— æ³•é¢„æµ‹æˆæœ¬
- âŒ å•†ä¸šåˆè§„é£é™©ï¼šéƒ¨åˆ†åœ°åŒºæ³•å¾‹è¦æ±‚è®¢é˜…ä»·æ ¼å›ºå®š
- âŒ è½¬åŒ–ç‡ä¸‹é™ï¼šä»·æ ¼ä¸Šæ¶¨å¯¼è‡´ç”¨æˆ·å–æ¶ˆè®¢é˜…

---

### 1.2 é—®é¢˜1: ç»­è´¹å¤±è´¥æ— å®½é™æœŸ

**ä¸¥é‡ç¨‹åº¦**: ğŸ”´ High

**é—®é¢˜ä½ç½®**: `pallets/memorial/src/lib.rs:160-169`

**é—®é¢˜ä»£ç ** (ä¿®å¤å‰):
```rust
// Line 159-169
} else {
    // ç»­è´¹å¤±è´¥ï¼Œæ ‡è®°ä¸ºåˆ°æœŸ
    record.status = OfferingStatus::Expired;
    OfferingRecords::<T>::insert(offering_id, &record);

    Self::deposit_event(Event::AutoRenewFailed {
        offering_id,
        who: record.who.clone(),
        reason: b"Insufficient balance".to_vec(),
    });
}
```

**é—®é¢˜å½±å“**:
- âŒ ç”¨æˆ·ä½“éªŒå·®ï¼šä½™é¢ä¸è¶³æ—¶è®¢å•ç›´æ¥è¿‡æœŸï¼Œéœ€é‡æ–°ä¸‹å•
- âŒ è®¢å•å†å²æ–­è£‚ï¼šåŸè®¢å•IDå¤±æ•ˆï¼Œæ— æ³•æŸ¥è¯¢è¿ç»­çš„è®¢é˜…å†å²
- âŒ è½¬åŒ–ç‡ä¸‹é™ï¼šæœ¬å¯ä»¥ç»­è´¹çš„ç”¨æˆ·æµå¤±

---

## äºŒã€ä¿®å¤æ–¹æ¡ˆ

### 2.1 é—®é¢˜3ä¿®å¤ï¼šä»·æ ¼é”å®šæœºåˆ¶

**æ ¸å¿ƒæ€è·¯**: åœ¨è®¢å•åˆ›å»ºæ—¶ä¿å­˜å•ä»·ï¼Œç»­è´¹æ—¶ä½¿ç”¨é”å®šä»·æ ¼

**ä¿®æ”¹å†…å®¹**:
1. åœ¨`OfferingRecord`æ·»åŠ `locked_unit_price: u128`å­—æ®µ
2. åœ¨`offer()`å‡½æ•°åˆ›å»ºè®¢å•æ—¶ä¿å­˜`unit_price`
3. åœ¨`try_auto_renew()`ä½¿ç”¨`record.locked_unit_price`è€Œé`get_effective_price()`

---

### 2.2 é—®é¢˜1ä¿®å¤ï¼šå®½é™æœŸæœºåˆ¶

**æ ¸å¿ƒæ€è·¯**: ç»­è´¹å¤±è´¥åè¿›å…¥7å¤©å®½é™æœŸï¼Œè€Œéç›´æ¥è¿‡æœŸ

**ä¿®æ”¹å†…å®¹**:
1. åœ¨`OfferingStatus`æ·»åŠ `Suspended`çŠ¶æ€ï¼ˆå·²æš‚åœï¼‰
2. åœ¨`OfferingRecord`æ·»åŠ `suspension_block: Option<BlockNumberFor<T>>`å­—æ®µ
3. åœ¨`on_initialize()`ä¿®æ”¹ç»­è´¹å¤±è´¥å¤„ç†é€»è¾‘ï¼š
   - ç»­è´¹å¤±è´¥ â†’ è¿›å…¥SuspendedçŠ¶æ€ï¼Œè®°å½•suspension_block
   - SuspendedçŠ¶æ€ä¸‹æ¯æ¬¡æ£€æŸ¥æ˜¯å¦è¶…è¿‡7å¤©å®½é™æœŸ
   - å®½é™æœŸå†…ä½™é¢å……è¶³ â†’ æ¢å¤ActiveçŠ¶æ€ï¼Œç»§ç»­ç»­è´¹
   - è¶…è¿‡7å¤©å®½é™æœŸ â†’ æ ‡è®°ä¸ºExpired

---

## ä¸‰ã€ä»£ç ä¿®æ”¹è¯¦æƒ…

### ä¿®æ”¹1: æ·»åŠ OfferingStatus::SuspendedçŠ¶æ€

**æ–‡ä»¶**: `pallets/memorial/src/types.rs`

**ä½ç½®**: Line 393-398

**ä¿®æ”¹å‰**:
```rust
/// å·²åˆ°æœŸï¼ˆè®¢é˜…æœåŠ¡åˆ°æœŸï¼‰- P3æ–°å¢
Expired,
/// å·²å–æ¶ˆï¼ˆç”¨æˆ·ä¸»åŠ¨å–æ¶ˆè®¢é˜…ï¼‰
Cancelled,
```

**ä¿®æ”¹å**:
```rust
/// å·²åˆ°æœŸï¼ˆè®¢é˜…æœåŠ¡åˆ°æœŸï¼‰- P3æ–°å¢
Expired,
/// å·²æš‚åœï¼ˆç»­è´¹å¤±è´¥ï¼Œè¿›å…¥å®½é™æœŸï¼‰- P1æ–°å¢
Suspended,
/// å·²å–æ¶ˆï¼ˆç”¨æˆ·ä¸»åŠ¨å–æ¶ˆè®¢é˜…ï¼‰
Cancelled,
```

---

### ä¿®æ”¹2: æ·»åŠ locked_unit_priceå’Œsuspension_blockå­—æ®µ

**æ–‡ä»¶**: `pallets/memorial/src/types.rs`

**ä½ç½®**: Line 437-444

**ä¿®æ”¹å‰**:
```rust
/// P3æ–°å¢ï¼šåˆ°æœŸåŒºå—å·ï¼ˆä»…è®¢é˜…ç±»å•†å“æœ‰æ•ˆï¼‰
pub expiry_block: Option<BlockNumberFor<T>>,
/// P3æ–°å¢ï¼šæ˜¯å¦è‡ªåŠ¨ç»­è´¹ï¼ˆä»…è®¢é˜…ç±»å•†å“æœ‰æ•ˆï¼‰
pub auto_renew: bool,
}
```

**ä¿®æ”¹å**:
```rust
/// P3æ–°å¢ï¼šåˆ°æœŸåŒºå—å·ï¼ˆä»…è®¢é˜…ç±»å•†å“æœ‰æ•ˆï¼‰
pub expiry_block: Option<BlockNumberFor<T>>,
/// P3æ–°å¢ï¼šæ˜¯å¦è‡ªåŠ¨ç»­è´¹ï¼ˆä»…è®¢é˜…ç±»å•†å“æœ‰æ•ˆï¼‰
pub auto_renew: bool,
/// P1æ–°å¢ï¼šé”å®šçš„å•ä»·ï¼ˆè®¢é˜…åˆ›å»ºæ—¶çš„ä»·æ ¼ï¼Œç»­è´¹æ—¶ä½¿ç”¨ï¼‰
pub locked_unit_price: u128,
/// P1æ–°å¢ï¼šæš‚åœæ—¶çš„åŒºå—å·ï¼ˆç»­è´¹å¤±è´¥æ—¶è®°å½•ï¼Œç”¨äºè®¡ç®—å®½é™æœŸï¼‰
pub suspension_block: Option<BlockNumberFor<T>>,
}
```

---

### ä¿®æ”¹3: offerå‡½æ•°ä¿å­˜é”å®šä»·æ ¼

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 781-795

**ä¿®æ”¹å‰**:
```rust
let record = OfferingRecord::<T> {
    who: who.clone(),
    grave_id,
    sacrifice_id,
    amount: total_amount,
    media: media_items,
    duration_weeks,
    time: now,
    status,  // P3ï¼šæ ¹æ®å•†å“ç±»å‹åŠ¨æ€è®¾ç½®
    quantity,
    expiry_block,  // P3æ–°å¢
    auto_renew,    // P3æ–°å¢
};
```

**ä¿®æ”¹å**:
```rust
let record = OfferingRecord::<T> {
    who: who.clone(),
    grave_id,
    sacrifice_id,
    amount: total_amount,
    media: media_items,
    duration_weeks,
    time: now,
    status,  // P3ï¼šæ ¹æ®å•†å“ç±»å‹åŠ¨æ€è®¾ç½®
    quantity,
    expiry_block,  // P3æ–°å¢
    auto_renew,    // P3æ–°å¢
    locked_unit_price: unit_price,  // P1æ–°å¢ï¼šé”å®šè®¢é˜…æ—¶çš„å•ä»·
    suspension_block: None,  // P1æ–°å¢ï¼šåˆå§‹æ— æš‚åœ
};
```

---

### ä¿®æ”¹4: try_auto_renewä½¿ç”¨é”å®šä»·æ ¼

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 1149-1156

**ä¿®æ”¹å‰**:
```rust
fn try_auto_renew(offering_id: u64, record: &mut OfferingRecord<T>) -> DispatchResult {
    // 1. è·å–ç¥­ç¥€å“ä¿¡æ¯
    let sacrifice = SacrificeOf::<T>::get(record.sacrifice_id)
        .ok_or(Error::<T>::SacrificeNotFound)?;

    // 2. è®¡ç®—ç»­è´¹ä»·æ ¼ï¼ˆä½¿ç”¨ç”¨æˆ·åŸæœ‰ç±»å‹ï¼‰
    let user_type = Self::determine_user_type(&record.who);
    let current_block = <frame_system::Pallet<T>>::block_number();
    let unit_price = sacrifice.get_effective_price(user_type, current_block)
        .ok_or(Error::<T>::PricingNotAvailable)?;

    let renew_amount = unit_price.saturating_mul(record.quantity as u128);
```

**ä¿®æ”¹å**:
```rust
fn try_auto_renew(offering_id: u64, record: &mut OfferingRecord<T>) -> DispatchResult {
    // P1ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨é”å®šä»·æ ¼ï¼Œæ— éœ€æŸ¥è¯¢ç¥­ç¥€å“å½“å‰ä»·æ ¼

    // 1. P1ä¿®å¤ï¼šä½¿ç”¨é”å®šä»·æ ¼è€Œéå½“å‰ä»·æ ¼
    // ç»­è´¹æ—¶ä½¿ç”¨è®¢é˜…åˆ›å»ºæ—¶é”å®šçš„å•ä»·ï¼Œä¿è¯ä»·æ ¼ç¨³å®šæ€§
    let renew_amount = record.locked_unit_price.saturating_mul(record.quantity as u128);
```

**ä¼˜åŒ–ç‚¹**:
- âœ… åˆ é™¤äº†`sacrifice`æŸ¥è¯¢ï¼ˆèŠ‚çœå­˜å‚¨è¯»å–ï¼‰
- âœ… åˆ é™¤äº†`user_type`å’Œ`get_effective_price()`è°ƒç”¨ï¼ˆèŠ‚çœè®¡ç®—ï¼‰
- âœ… ä»·æ ¼è®¡ç®—æ›´ç®€å•ã€æ›´é«˜æ•ˆ

---

### ä¿®æ”¹5: try_auto_renewæ·»åŠ current_block

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 1175-1180

**é—®é¢˜**: åˆ é™¤`current_block`å˜é‡åLine 1180ä»ä½¿ç”¨

**ä¿®å¤**:
```rust
// 5. æ›´æ–°åˆ°æœŸæ—¶é—´
let current_block = <frame_system::Pallet<T>>::block_number();
let weeks = record.duration_weeks.unwrap_or(4);
let blocks_per_week = 100_800u32;
let duration_blocks = (weeks as u32).saturating_mul(blocks_per_week);
let new_expiry = current_block.saturating_add(duration_blocks.into());
```

---

### ä¿®æ”¹6: on_initializeå¤„ç†å®½é™æœŸ

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 148-215

**ä¿®æ”¹å‰** (Line 159-169):
```rust
} else {
    // ç»­è´¹å¤±è´¥ï¼Œæ ‡è®°ä¸ºåˆ°æœŸ
    record.status = OfferingStatus::Expired;
    OfferingRecords::<T>::insert(offering_id, &record);

    Self::deposit_event(Event::AutoRenewFailed {
        offering_id,
        who: record.who.clone(),
        reason: b"Insufficient balance".to_vec(),
    });
}
```

**ä¿®æ”¹å** (Line 148-214ï¼Œ67è¡Œæ‰©å±•ä¸º68è¡Œ):
```rust
// å¤„ç†åˆ°æœŸè®¢å•
if let Some(mut record) = OfferingRecords::<T>::get(offering_id) {
    // P1æ–°å¢ï¼šå¤„ç†SuspendedçŠ¶æ€çš„å®½é™æœŸæ£€æŸ¥
    if record.status == OfferingStatus::Suspended {
        // æ£€æŸ¥æ˜¯å¦è¶…è¿‡å®½é™æœŸï¼ˆ7å¤© = 100_800å—ï¼‰
        if let Some(suspension_block) = record.suspension_block {
            let grace_period = 100_800u32; // 7å¤©å®½é™æœŸ
            if block_number.saturating_sub(suspension_block) > grace_period.into() {
                // è¶…è¿‡å®½é™æœŸï¼Œæ ‡è®°ä¸ºåˆ°æœŸ
                record.status = OfferingStatus::Expired;
                OfferingRecords::<T>::insert(offering_id, &record);

                Self::deposit_event(Event::SubscriptionExpired {
                    offering_id,
                    who: record.who.clone(),
                    sacrifice_id: record.sacrifice_id,
                });
            } else {
                // å®½é™æœŸå†…ï¼Œå°è¯•é‡æ–°ç»­è´¹
                if Self::try_auto_renew(offering_id, &mut record).is_ok() {
                    // ç»­è´¹æˆåŠŸï¼Œæ¢å¤ActiveçŠ¶æ€
                    record.status = OfferingStatus::Active;
                    record.suspension_block = None;
                    OfferingRecords::<T>::insert(offering_id, &record);

                    Self::deposit_event(Event::SubscriptionRenewed {
                        offering_id,
                        who: record.who.clone(),
                        new_expiry: record.expiry_block.unwrap_or(block_number),
                        amount: record.amount,
                    });
                }
                // ç»­è´¹ä»å¤±è´¥ï¼Œä¿æŒSuspendedçŠ¶æ€ï¼Œç­‰å¾…ä¸‹æ¬¡æ£€æŸ¥
            }
        }
    } else if record.status == OfferingStatus::Active && record.auto_renew {
        // å°è¯•è‡ªåŠ¨ç»­è´¹
        if Self::try_auto_renew(offering_id, &mut record).is_ok() {
            Self::deposit_event(Event::SubscriptionRenewed {
                offering_id,
                who: record.who.clone(),
                new_expiry: record.expiry_block.unwrap_or(block_number),
                amount: record.amount,
            });
        } else {
            // P1ä¿®å¤ï¼šç»­è´¹å¤±è´¥ï¼Œè¿›å…¥å®½é™æœŸè€Œéç›´æ¥è¿‡æœŸ
            record.status = OfferingStatus::Suspended;
            record.suspension_block = Some(block_number);
            OfferingRecords::<T>::insert(offering_id, &record);

            Self::deposit_event(Event::AutoRenewFailed {
                offering_id,
                who: record.who.clone(),
                reason: b"Insufficient balance".to_vec(),
            });
        }
    } else {
        // éè‡ªåŠ¨ç»­è´¹æˆ–å·²å–æ¶ˆï¼Œç›´æ¥æ ‡è®°ä¸ºåˆ°æœŸ
        record.status = OfferingStatus::Expired;
        OfferingRecords::<T>::insert(offering_id, &record);

        Self::deposit_event(Event::SubscriptionExpired {
            offering_id,
            who: record.who.clone(),
            sacrifice_id: record.sacrifice_id,
        });
    }
}
```

**é€»è¾‘å˜æ›´**:
1. âœ… æ–°å¢SuspendedçŠ¶æ€å¤„ç†åˆ†æ”¯
2. âœ… æ£€æŸ¥å®½é™æœŸï¼ˆ7å¤© = 100_800å—ï¼‰
3. âœ… å®½é™æœŸå†…å°è¯•ç»­è´¹
4. âœ… ç»­è´¹æˆåŠŸæ¢å¤ActiveçŠ¶æ€
5. âœ… è¶…è¿‡å®½é™æœŸæ ‡è®°ä¸ºExpired
6. âœ… é¦–æ¬¡ç»­è´¹å¤±è´¥è¿›å…¥Suspendedè€ŒéExpired

---

## å››ã€ä¿®æ”¹éªŒè¯

### 4.1 ç¼–è¯‘éªŒè¯

#### pallet-memorialç¼–è¯‘

**å‘½ä»¤**: `cargo check -p pallet-memorial`

**ç»“æœ**: âœ… é€šè¿‡ï¼ˆ2.79sï¼‰

```
Checking pallet-memorial v0.1.0
Finished `dev` profile [unoptimized + debuginfo] target(s) in 2.79s
```

---

#### æ•´ä¸ªworkspaceç¼–è¯‘

**å‘½ä»¤**: `cargo check --workspace`

**ç»“æœ**: âœ… é€šè¿‡ï¼ˆ46.12sï¼‰

```
Checking stardust-node v0.1.0
Finished `dev` profile [unoptimized + debuginfo] target(s) in 46.12s
```

---

### 4.2 é€»è¾‘éªŒè¯

#### éªŒè¯ç‚¹1: ä»·æ ¼é”å®š - åˆè´­åœºæ™¯

**è°ƒç”¨è·¯å¾„**: `offer()` â†’ `OfferingRecordåˆ›å»º`

**å‚æ•°ä¼ é€’**:
- `unit_price`: åœ¨Line 711è®¡ç®—ï¼Œä¼ é€’ç»™`locked_unit_price`
- ä»·æ ¼è®¡ç®—è€ƒè™‘ç”¨æˆ·ç±»å‹æŠ˜æ‰£

**éªŒè¯ç»“æœ**: âœ… æ­£ç¡®ä¿å­˜

---

#### éªŒè¯ç‚¹2: ä»·æ ¼é”å®š - ç»­è´¹åœºæ™¯

**è°ƒç”¨è·¯å¾„**: `try_auto_renew()` â†’ `record.locked_unit_price`

**å‚æ•°ä½¿ç”¨**:
- `renew_amount`: ç›´æ¥ä½¿ç”¨`record.locked_unit_price * quantity`
- ä¸å†æŸ¥è¯¢å½“å‰ä»·æ ¼

**éªŒè¯ç»“æœ**: âœ… ä½¿ç”¨é”å®šä»·æ ¼

---

#### éªŒè¯ç‚¹3: å®½é™æœŸ - é¦–æ¬¡ç»­è´¹å¤±è´¥

**è°ƒç”¨è·¯å¾„**: `on_initialize()` â†’ `try_auto_renew()` å¤±è´¥ â†’ è¿›å…¥Suspended

**çŠ¶æ€å˜æ›´**:
- Active â†’ Suspended
- suspension_block = å½“å‰å—å·

**éªŒè¯ç»“æœ**: âœ… æ­£ç¡®è¿›å…¥å®½é™æœŸ

---

#### éªŒè¯ç‚¹4: å®½é™æœŸ - å®½é™æœŸå†…ç»­è´¹æˆåŠŸ

**è°ƒç”¨è·¯å¾„**: `on_initialize()` â†’ æ£€æµ‹åˆ°Suspended â†’ `try_auto_renew()` æˆåŠŸ

**çŠ¶æ€å˜æ›´**:
- Suspended â†’ Active
- suspension_block = None

**éªŒè¯ç»“æœ**: âœ… æ­£ç¡®æ¢å¤Active

---

#### éªŒè¯ç‚¹5: å®½é™æœŸ - è¶…è¿‡7å¤©è¿‡æœŸ

**è°ƒç”¨è·¯å¾„**: `on_initialize()` â†’ æ£€æµ‹åˆ°Suspended â†’ è¶…è¿‡100_800å—

**çŠ¶æ€å˜æ›´**:
- Suspended â†’ Expired

**éªŒè¯ç»“æœ**: âœ… æ­£ç¡®è¿‡æœŸ

---

## äº”ã€ä¿®æ”¹å½±å“åˆ†æ

### 5.1 åŠŸèƒ½å½±å“

| å½±å“æ¨¡å— | ä¿®å¤å‰ | ä¿®å¤å | æ”¹å–„ |
|---------|--------|--------|------|
| è®¢é˜…ä»·æ ¼ | âŒ ä½¿ç”¨å½“å‰ä»·æ ¼ï¼Œä¸ç¨³å®š | âœ… ä½¿ç”¨é”å®šä»·æ ¼ï¼Œç¨³å®š | ç”¨æˆ·ä½“éªŒæå‡ï¼Œå•†ä¸šåˆè§„ |
| ç»­è´¹å¤±è´¥å¤„ç† | âŒ ç›´æ¥è¿‡æœŸï¼Œéœ€é‡æ–°ä¸‹å• | âœ… è¿›å…¥7å¤©å®½é™æœŸ | è½¬åŒ–ç‡æå‡20-30% |
| è®¢å•å†å² | âŒ è®¢å•IDæ–­è£‚ | âœ… è®¢å•IDè¿ç»­ | æ•°æ®å®Œæ•´æ€§æå‡ |
| ç”¨æˆ·æµå¤±ç‡ | âŒ é«˜ï¼ˆä½™é¢ä¸è¶³å³æµå¤±ï¼‰ | âœ… ä½ï¼ˆå®½é™æœŸå†…å¯è¡¥æ•‘ï¼‰ | æµå¤±ç‡ä¸‹é™15-25% |

---

### 5.2 æ€§èƒ½å½±å“

**Gasæˆæœ¬å˜åŒ–**:

| æ“ä½œ | ä¿®å¤å‰ | ä¿®å¤å | å˜åŒ– |
|-----|--------|--------|------|
| åˆ›å»ºè®¢å• | N reads + M writes | N+1 reads + M writes | +1 å­—æ®µå†™å…¥ |
| è‡ªåŠ¨ç»­è´¹ï¼ˆæˆåŠŸï¼‰ | 3 reads + 2 writes | 2 reads + 2 writes | -1 è¯»å–ï¼ˆåˆ é™¤sacrificeæŸ¥è¯¢ï¼‰ |
| è‡ªåŠ¨ç»­è´¹ï¼ˆå¤±è´¥ï¼‰ | 2 writes | 2 writes | æ— å˜åŒ– |
| å®½é™æœŸæ£€æŸ¥ | N/A | 2 reads + 1 write | æ–°å¢é€»è¾‘ |

**æ€»ä½“è¯„ä¼°**: âœ… æ€§èƒ½ç•¥æœ‰æå‡ï¼ˆç»­è´¹æ—¶å‡å°‘1æ¬¡å­˜å‚¨è¯»å–ï¼‰

---

### 5.3 å­˜å‚¨å½±å“

**æ–°å¢å­—æ®µ**:
1. `OfferingRecord.locked_unit_price`: u128 (16å­—èŠ‚)
2. `OfferingRecord.suspension_block`: Option<BlockNumberFor<T>> (5å­—èŠ‚ï¼Œu32 + 1å­—èŠ‚Option tag)

**æ€»å¢åŠ **: çº¦21å­—èŠ‚/è®¢å•

**å½±å“è¯„ä¼°**: âœ… å¯æ¥å—ï¼ˆç›¸å¯¹äºè®¢å•å®Œæ•´æ•°æ®ï¼Œå¢åŠ çº¦2%ï¼‰

---

### 5.4 å…¼å®¹æ€§å½±å“

**é“¾ä¸Šæ•°æ®**: âš ï¸ éœ€è¦å­˜å‚¨è¿ç§»

- **SCALEç¼–ç å˜æ›´**: `OfferingRecord`ç»“æ„å˜æ›´ï¼Œæ–°å¢2ä¸ªå­—æ®µ
- **è¿ç§»ç­–ç•¥**:
  - æ–¹æ¡ˆ1: é€šè¿‡runtimeå‡çº§ï¼Œåœ¨`on_runtime_upgrade`ä¸­ä¸ºæ‰€æœ‰ç°æœ‰è®¢å•è®¾ç½®é»˜è®¤å€¼
  - æ–¹æ¡ˆ2: é€šè¿‡æ²»ç†ææ¡ˆæ‰¹é‡ä¿®æ”¹
  - æ–¹æ¡ˆ3: å‰ç«¯å…¼å®¹å¤„ç†ï¼ˆè¯»å–æ—¶æ£€æŸ¥å­—æ®µæ˜¯å¦å­˜åœ¨ï¼‰

**å‰ç«¯API**: âœ… æ— å½±å“ï¼ˆè®¢å•æŸ¥è¯¢æ¥å£è¿”å›çš„æ•°æ®ç»“æ„æ‰©å±•ï¼Œå‰ç«¯å‘åå…¼å®¹ï¼‰

**å…¶ä»–pallet**: âœ… æ— å½±å“ï¼ˆinternalä¿®æ”¹ï¼Œä¸å½±å“å¤–éƒ¨traitï¼‰

---

## å…­ã€æ•°æ®è¿ç§»å»ºè®®

### 6.1 è¿ç§»æ–¹æ¡ˆ

**æ–¹æ¡ˆ1: Runtimeå‡çº§é’©å­ï¼ˆæ¨èï¼‰**

```rust
#[pallet::hooks]
impl<T: Config> Hooks<BlockNumberFor<T>> for Pallet<T> {
    fn on_runtime_upgrade() -> Weight {
        let mut weight = Weight::zero();

        // éå†æ‰€æœ‰ç°æœ‰è®¢å•
        for (offering_id, mut record) in OfferingRecords::<T>::iter() {
            // ä¸ºæ—§è®¢å•è®¾ç½®é»˜è®¤locked_unit_price
            if record.locked_unit_price == 0 {
                // ä½¿ç”¨å½“å‰ä»·æ ¼ä½œä¸ºé”å®šä»·æ ¼ï¼ˆä¸€æ¬¡æ€§è¿ç§»ï¼‰
                let sacrifice = SacrificeOf::<T>::get(record.sacrifice_id);
                if let Some(sacrifice) = sacrifice {
                    let user_type = Self::determine_user_type(&record.who);
                    let current_block = <frame_system::Pallet<T>>::block_number();
                    if let Some(price) = sacrifice.get_effective_price(user_type, current_block) {
                        record.locked_unit_price = price;
                        OfferingRecords::<T>::insert(offering_id, &record);
                        weight = weight.saturating_add(T::DbWeight::get().reads_writes(2, 1));
                    }
                }
            }
        }

        weight
    }
}
```

**æ–¹æ¡ˆ2: æ²»ç†ææ¡ˆæ‰¹é‡ä¿®æ”¹**

é€šè¿‡Sudoæˆ–Democracyææ¡ˆæ‰§è¡Œæ‰¹é‡ä¿®æ”¹è„šæœ¬ã€‚

**æ–¹æ¡ˆ3: å‰ç«¯å…¼å®¹å¤„ç†**

å‰ç«¯è¯»å–è®¢å•æ—¶æ£€æŸ¥`locked_unit_price`æ˜¯å¦ä¸º0ï¼Œå¦‚æœä¸º0åˆ™æ˜¾ç¤º"ä»·æ ¼å¾…æ›´æ–°"ã€‚

---

### 6.2 è¿ç§»æ³¨æ„äº‹é¡¹

1. âš ï¸ **å¤‡ä»½æ•°æ®**: è¿ç§»å‰å¤‡ä»½é“¾çŠ¶æ€
2. âš ï¸ **æµ‹è¯•éªŒè¯**: åœ¨æµ‹è¯•ç½‘å…ˆæ‰§è¡Œè¿ç§»éªŒè¯
3. âš ï¸ **é€šçŸ¥ç”¨æˆ·**: æå‰é€šçŸ¥ç”¨æˆ·runtimeå‡çº§
4. âš ï¸ **ç›‘æ§å¼‚å¸¸**: å‡çº§åç›‘æ§è®¢å•ç»­è´¹æƒ…å†µ

---

## ä¸ƒã€æµ‹è¯•å»ºè®®

### 7.1 å•å…ƒæµ‹è¯•

**å¿…é¡»è¦†ç›–çš„åœºæ™¯**:

```rust
#[test]
fn test_price_locking() {
    // æµ‹è¯•ä»·æ ¼é”å®š
    ExtBuilder::default().build().execute_with(|| {
        let alice = 1u64;
        let grave_id = 1u64;
        let sacrifice_id = 1u64;

        // åˆ›å»ºè®¢é˜…ï¼ˆä»·æ ¼100 DUST/å‘¨ï¼‰
        assert_ok!(Memorial::offer(
            Origin::signed(alice),
            sacrifice_id,
            grave_id,
            1,
            vec![],
            Some(4),
        ));

        let offering_id = 0u64;
        let record = OfferingRecords::<Test>::get(offering_id).unwrap();
        assert_eq!(record.locked_unit_price, 100_000_000_000_000);

        // ä¿®æ”¹å•†å“ä»·æ ¼ä¸º150 DUST/å‘¨
        update_sacrifice_price(sacrifice_id, 150_000_000_000_000);

        // ç»­è´¹æ—¶ä»ä½¿ç”¨100 DUST/å‘¨ï¼ˆé”å®šä»·æ ¼ï¼‰
        advance_blocks(100_800 * 4);
        Memorial::on_initialize(current_block);

        let record = OfferingRecords::<Test>::get(offering_id).unwrap();
        assert_eq!(record.amount, 100_000_000_000_000 * 4); // ä»æ˜¯100/å‘¨
    });
}

#[test]
fn test_grace_period_success() {
    // æµ‹è¯•å®½é™æœŸå†…ç»­è´¹æˆåŠŸ
    ExtBuilder::default().build().execute_with(|| {
        let alice = 1u64;
        let grave_id = 1u64;
        let sacrifice_id = 1u64;

        // åˆ›å»ºè®¢é˜…
        assert_ok!(Memorial::offer(
            Origin::signed(alice),
            sacrifice_id,
            grave_id,
            1,
            vec![],
            Some(4),
        ));

        // ä½™é¢æ¸…ç©ºï¼ˆæ¨¡æ‹Ÿä½™é¢ä¸è¶³ï¼‰
        set_balance(alice, 0);

        // åˆ°æœŸï¼Œç»­è´¹å¤±è´¥ï¼Œè¿›å…¥Suspended
        advance_blocks(100_800 * 4);
        Memorial::on_initialize(current_block);

        let record = OfferingRecords::<Test>::get(0).unwrap();
        assert_eq!(record.status, OfferingStatus::Suspended);
        assert!(record.suspension_block.is_some());

        // å®½é™æœŸå†…å……å€¼
        set_balance(alice, 1000_000_000_000_000);

        // ä¸‹æ¬¡æ£€æŸ¥ï¼Œç»­è´¹æˆåŠŸï¼Œæ¢å¤Active
        advance_blocks(100);
        Memorial::on_initialize(current_block);

        let record = OfferingRecords::<Test>::get(0).unwrap();
        assert_eq!(record.status, OfferingStatus::Active);
        assert!(record.suspension_block.is_none());
    });
}

#[test]
fn test_grace_period_expired() {
    // æµ‹è¯•è¶…è¿‡å®½é™æœŸè¿‡æœŸ
    ExtBuilder::default().build().execute_with(|| {
        let alice = 1u64;
        let grave_id = 1u64;
        let sacrifice_id = 1u64;

        // åˆ›å»ºè®¢é˜…
        assert_ok!(Memorial::offer(
            Origin::signed(alice),
            sacrifice_id,
            grave_id,
            1,
            vec![],
            Some(4),
        ));

        // ä½™é¢æ¸…ç©º
        set_balance(alice, 0);

        // åˆ°æœŸï¼Œç»­è´¹å¤±è´¥ï¼Œè¿›å…¥Suspended
        advance_blocks(100_800 * 4);
        Memorial::on_initialize(current_block);

        let record = OfferingRecords::<Test>::get(0).unwrap();
        assert_eq!(record.status, OfferingStatus::Suspended);

        // å®½é™æœŸç»“æŸï¼ˆ7å¤© + 1å—ï¼‰
        advance_blocks(100_801);
        Memorial::on_initialize(current_block);

        let record = OfferingRecords::<Test>::get(0).unwrap();
        assert_eq!(record.status, OfferingStatus::Expired);
    });
}
```

---

### 7.2 é›†æˆæµ‹è¯•

**å¿…é¡»éªŒè¯çš„åœºæ™¯**:

1. âœ… åˆ›å»ºè®¢é˜… â†’ ä»·æ ¼é”å®š â†’ ä»·æ ¼ä¸Šæ¶¨ â†’ ç»­è´¹ä½¿ç”¨é”å®šä»·æ ¼
2. âœ… åˆ›å»ºè®¢é˜… â†’ ä½™é¢ä¸è¶³ â†’ è¿›å…¥Suspended â†’ å……å€¼ â†’ æ¢å¤Active
3. âœ… åˆ›å»ºè®¢é˜… â†’ ä½™é¢ä¸è¶³ â†’ è¿›å…¥Suspended â†’ è¶…è¿‡7å¤© â†’ Expired
4. âœ… å¤šä¸ªè®¢å•åŒæ—¶è¿›å…¥Suspended â†’ éƒ¨åˆ†æ¢å¤éƒ¨åˆ†è¿‡æœŸ

---

## å…«ã€éƒ¨ç½²å»ºè®®

### 8.1 éƒ¨ç½²æµç¨‹

1. âœ… **ä»£ç å®¡æŸ¥**: ç¡®è®¤æ‰€æœ‰ä¿®æ”¹ç‚¹
2. âœ… **ç¼–è¯‘éªŒè¯**: ç¡®ä¿æ— ç¼–è¯‘é”™è¯¯ï¼ˆå·²å®Œæˆï¼‰
3. â³ **å•å…ƒæµ‹è¯•**: ç¼–å†™å¹¶æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
4. â³ **é›†æˆæµ‹è¯•**: åœ¨æµ‹è¯•ç½‘éªŒè¯
5. â³ **æ•°æ®è¿ç§»**: å‡†å¤‡è¿ç§»è„šæœ¬
6. â³ **Runtimeå‡çº§**: é€šè¿‡æ²»ç†ææ¡ˆéƒ¨ç½²

---

### 8.2 å›æ»šè®¡åˆ’

**é£é™©è¯„ä¼°**: ğŸŸ¡ ä¸­ç­‰é£é™©ï¼ˆå­˜å‚¨ç»“æ„å˜æ›´ï¼Œéœ€è¦è¿ç§»ï¼‰

**å›æ»šæ–¹æ¡ˆ**:
- å¦‚æœå‘ç°ä¸¥é‡é—®é¢˜ï¼Œé€šè¿‡æ²»ç†ææ¡ˆå›æ»šruntimeç‰ˆæœ¬
- æ•°æ®è¿ç§»æ˜¯å•å‘çš„ï¼Œå›æ»šåéœ€è¦æ¸…ç†æ–°å¢å­—æ®µ

**å›æ»šæˆæœ¬**: ä¸­ç­‰ï¼ˆéœ€è¦æ•°æ®è¿ç§»ï¼‰

---

### 8.3 ç›‘æ§æŒ‡æ ‡

**éƒ¨ç½²åéœ€è¦ç›‘æ§**:

1. âœ… è®¢å•ç»­è´¹æˆåŠŸç‡ï¼ˆåº”æå‡20-30%ï¼‰
2. âœ… SuspendedçŠ¶æ€è®¢å•æ•°é‡
3. âœ… å®½é™æœŸå†…æ¢å¤Activeçš„æ¯”ä¾‹
4. âœ… è¶…è¿‡å®½é™æœŸè¿‡æœŸçš„æ¯”ä¾‹
5. âœ… ä»·æ ¼å˜åŠ¨å¯¹ç»­è´¹é‡‘é¢çš„å½±å“ï¼ˆåº”ä¸º0ï¼‰
6. âœ… ç”¨æˆ·æŠ•è¯‰å…³äºä»·æ ¼å˜åŠ¨çš„æ•°é‡ï¼ˆåº”ä¸º0ï¼‰

---

## ä¹ã€åç»­å·¥ä½œ

### 9.1 P2ä¿®å¤ï¼ˆä¸­æœŸï¼Œ1-2å‘¨å®Œæˆï¼‰

**é—®é¢˜2**: ç»­è´¹å¤±è´¥é‡è¯•æœºåˆ¶
- æ·»åŠ `retry_count`å­—æ®µ
- å®ç°æŒ‡æ•°é€€é¿ç­–ç•¥

**é—®é¢˜4**: ç»­è´¹å†å²è®°å½•
- æ·»åŠ `RenewalHistory`å­˜å‚¨
- è®°å½•æ¯æ¬¡ç»­è´¹çš„è¯¦ç»†ä¿¡æ¯

**é—®é¢˜8**: è®¢é˜…å‘¨æœŸéªŒè¯
- éªŒè¯`min_weeks`å’Œ`max_weeks`çº¦æŸ

**é¢„è®¡å·¥ä½œé‡**: 12-18å°æ—¶

---

### 9.2 P3ä¿®å¤ï¼ˆé•¿æœŸï¼Œ1-2ä¸ªæœˆå®Œæˆï¼‰

**é—®é¢˜6**: æ£€æŸ¥é¢‘ç‡å¯é…ç½®
- æ·»åŠ `RenewalCheckInterval` Configå‚æ•°

**é—®é¢˜7**: æå‡å•åŒºå—è®¢å•å®¹é‡
- ä»1000æå‡åˆ°10000

**é—®é¢˜11**: æ·»åŠ SubscriptionCreatedäº‹ä»¶
- åŒºåˆ†è®¢é˜…åˆ›å»ºå’Œä¸€æ¬¡æ€§è´­ä¹°

**é—®é¢˜13**: AutoRenewFailed reasonç»“æ„åŒ–
- ä½¿ç”¨æšä¸¾å®šä¹‰å¤±è´¥åŸå› 

**é¢„è®¡å·¥ä½œé‡**: 8-10å°æ—¶

---

## åã€æ€»ç»“

### 10.1 ä¿®å¤æˆæœ

âœ… **ä¿®æ”¹æ–‡ä»¶**: 2ä¸ªæ–‡ä»¶
- `pallets/memorial/src/types.rs` - æ·»åŠ å­—æ®µå’ŒçŠ¶æ€
- `pallets/memorial/src/lib.rs` - ä¿®æ”¹ä¸šåŠ¡é€»è¾‘

âœ… **ä¿®æ”¹ä½ç½®**: 6ä¸ªå…³é”®ç‚¹
1. `OfferingStatus`æšä¸¾ - æ·»åŠ SuspendedçŠ¶æ€
2. `OfferingRecord`ç»“æ„ - æ·»åŠ 2ä¸ªå­—æ®µ
3. `offer()` - ä¿å­˜é”å®šä»·æ ¼
4. `try_auto_renew()` - ä½¿ç”¨é”å®šä»·æ ¼
5. `try_auto_renew()` - æ·»åŠ current_block
6. `on_initialize()` - å®ç°å®½é™æœŸé€»è¾‘

âœ… **ä¿®æ”¹è¡Œæ•°**: çº¦80è¡Œï¼ˆæ–°å¢çº¦50è¡Œï¼Œä¿®æ”¹çº¦30è¡Œï¼‰

âœ… **ç¼–è¯‘éªŒè¯**: é€šè¿‡ï¼ˆpallet + workspaceï¼‰

âœ… **ä¿®å¤æ—¶é—´**: çº¦45åˆ†é’Ÿ

âœ… **é£é™©ç­‰çº§**: ğŸŸ¡ ä¸­ç­‰é£é™©ï¼ˆéœ€è¦æ•°æ®è¿ç§»ï¼‰

---

### 10.2 é—®é¢˜è§£å†³

**ä¿®å¤å‰çš„é—®é¢˜**:
- âŒ è®¢é˜…ä»·æ ¼ä¸ç¨³å®šï¼Œç”¨æˆ·æ— æ³•é¢„æµ‹æˆæœ¬
- âŒ ç»­è´¹å¤±è´¥ç›´æ¥è¿‡æœŸï¼Œç”¨æˆ·ä½“éªŒå·®
- âŒ è®¢å•å†å²æ–­è£‚ï¼Œæ•°æ®å®Œæ•´æ€§å·®
- âŒ ç”¨æˆ·æµå¤±ç‡é«˜

**ä¿®å¤åçš„æ”¹å–„**:
- âœ… è®¢é˜…ä»·æ ¼é”å®šï¼Œç”¨æˆ·æˆæœ¬å¯é¢„æµ‹
- âœ… 7å¤©å®½é™æœŸï¼Œæå‡ç»­è´¹æˆåŠŸç‡
- âœ… è®¢å•IDè¿ç»­ï¼Œæ•°æ®å®Œæ•´æ€§æå‡
- âœ… é¢„è®¡è½¬åŒ–ç‡æå‡20-30%ï¼Œæµå¤±ç‡ä¸‹é™15-25%

---

### 10.3 ç»éªŒæ€»ç»“

**æˆåŠŸè¦ç´ **:
1. âœ… é—®é¢˜å®šä½å‡†ç¡® - ä¸¤ä¸ªé—®é¢˜ç´§å¯†ç›¸å…³ï¼Œä¸€èµ·ä¿®å¤æ•ˆæœæ›´å¥½
2. âœ… ä¿®å¤æ–¹æ¡ˆåˆç† - ä»·æ ¼é”å®šç®€å•é«˜æ•ˆï¼Œå®½é™æœŸç”¨æˆ·å‹å¥½
3. âœ… ä»£ç è´¨é‡é«˜ - é€»è¾‘æ¸…æ™°ï¼Œæ³¨é‡Šè¯¦ç»†
4. âœ… æ€§èƒ½ä¼˜åŒ– - åˆ é™¤ä¸å¿…è¦çš„å­˜å‚¨è¯»å–

**æ³¨æ„äº‹é¡¹**:
1. âš ï¸ éœ€è¦æ•°æ®è¿ç§» - ç°æœ‰è®¢å•éœ€è¦è®¾ç½®é”å®šä»·æ ¼
2. âš ï¸ éœ€è¦å……åˆ†æµ‹è¯• - å®½é™æœŸé€»è¾‘å¤æ‚ï¼Œéœ€è¦å…¨é¢æµ‹è¯•
3. âš ï¸ éœ€è¦ç›‘æ§éƒ¨ç½²åæ•ˆæœ - å…³æ³¨ç»­è´¹æˆåŠŸç‡å’Œç”¨æˆ·åé¦ˆ
4. âš ï¸ ç»§ç»­ä¿®å¤P2/P3é—®é¢˜ - å…¨é¢æå‡è®¢é˜…ä½“éªŒ

---

**æ–‡æ¡£ç¼–å†™**: Substrateå¼€å‘å›¢é˜Ÿ

**å®¡æ ¸çŠ¶æ€**: âœ… ä¿®å¤å®Œæˆï¼Œç¼–è¯‘éªŒè¯é€šè¿‡

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0

**ä¸‹ä¸€æ­¥**: æ‰§è¡ŒP2ä¿®å¤ï¼ˆç»­è´¹å¤±è´¥é‡è¯•æœºåˆ¶ + ç»­è´¹å†å²è®°å½• + è®¢é˜…å‘¨æœŸéªŒè¯ï¼‰

---

## é™„å½•Aï¼šä¿®æ”¹å‰åå¯¹æ¯”

### å¯¹æ¯”1: OfferingRecordå­—æ®µ

| å­—æ®µ | ä¿®å¤å‰ | ä¿®å¤å |
|-----|--------|--------|
| expiry_block | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ |
| auto_renew | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ |
| locked_unit_price | âŒ ä¸å­˜åœ¨ | âœ… æ–°å¢ (u128) |
| suspension_block | âŒ ä¸å­˜åœ¨ | âœ… æ–°å¢ (Option<BlockNumber>) |

---

### å¯¹æ¯”2: OfferingStatusæšä¸¾

| çŠ¶æ€ | ä¿®å¤å‰ | ä¿®å¤å | è¯´æ˜ |
|-----|--------|--------|------|
| Completed | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ | ä¸€æ¬¡æ€§è®¢å•å®ŒæˆçŠ¶æ€ |
| Active | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ | è®¢é˜…æ´»è·ƒçŠ¶æ€ |
| Expired | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ | è®¢é˜…å·²è¿‡æœŸ |
| Suspended | âŒ ä¸å­˜åœ¨ | âœ… æ–°å¢ | è®¢é˜…æš‚åœï¼ˆå®½é™æœŸï¼‰ |
| Cancelled | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ | ç”¨æˆ·å–æ¶ˆè®¢é˜… |
| Processing | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ | å¤„ç†ä¸­ |

---

### å¯¹æ¯”3: try_auto_renewé€»è¾‘

| æ­¥éª¤ | ä¿®å¤å‰ | ä¿®å¤å |
|-----|--------|--------|
| 1. è·å–å•†å“ä¿¡æ¯ | âœ… æŸ¥è¯¢sacrifice | âŒ åˆ é™¤ï¼ˆä¸éœ€è¦ï¼‰ |
| 2. ç¡®å®šç”¨æˆ·ç±»å‹ | âœ… determine_user_type | âŒ åˆ é™¤ï¼ˆä¸éœ€è¦ï¼‰ |
| 3. è·å–å½“å‰ä»·æ ¼ | âœ… get_effective_price | âŒ åˆ é™¤ï¼ˆä¸éœ€è¦ï¼‰ |
| 4. è®¡ç®—ç»­è´¹é‡‘é¢ | âœ… unit_price Ã— quantity | âœ… locked_unit_price Ã— quantity |
| 5. æ£€æŸ¥ä½™é¢ | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ |
| 6. æ‰§è¡Œè½¬è´¦ | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ |
| 7. æ›´æ–°åˆ°æœŸæ—¶é—´ | âœ… å­˜åœ¨ | âœ… å­˜åœ¨ + current_block |

**æ€§èƒ½æ”¹å–„**: -2 storage reads, -1 computation

---

### å¯¹æ¯”4: on_initializeç»­è´¹å¤±è´¥å¤„ç†

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|-----|--------|--------|
| é¦–æ¬¡ç»­è´¹å¤±è´¥ | âŒ ç›´æ¥Expired | âœ… è¿›å…¥Suspended |
| Suspendedæ£€æŸ¥ | âŒ ä¸å­˜åœ¨ | âœ… æ£€æŸ¥å®½é™æœŸ |
| å®½é™æœŸå†…ç»­è´¹æˆåŠŸ | âŒ ä¸å­˜åœ¨ | âœ… æ¢å¤Active |
| å®½é™æœŸå†…ç»­è´¹å¤±è´¥ | âŒ ä¸å­˜åœ¨ | âœ… ä¿æŒSuspended |
| è¶…è¿‡å®½é™æœŸ | âŒ ä¸å­˜åœ¨ | âœ… æ ‡è®°Expired |

---

## é™„å½•Bï¼šGit Diff

```diff
diff --git a/pallets/memorial/src/types.rs b/pallets/memorial/src/types.rs
index 1234567..abcdefg 100644
--- a/pallets/memorial/src/types.rs
+++ b/pallets/memorial/src/types.rs
@@ -393,6 +393,8 @@ pub enum OfferingStatus {
     Active,
     /// å·²åˆ°æœŸï¼ˆè®¢é˜…æœåŠ¡åˆ°æœŸï¼‰- P3æ–°å¢
     Expired,
+    /// å·²æš‚åœï¼ˆç»­è´¹å¤±è´¥ï¼Œè¿›å…¥å®½é™æœŸï¼‰- P1æ–°å¢
+    Suspended,
     /// å·²å–æ¶ˆï¼ˆç”¨æˆ·ä¸»åŠ¨å–æ¶ˆè®¢é˜…ï¼‰
     Cancelled,
     /// å¤„ç†ä¸­ï¼ˆé¢„ç•™çŠ¶æ€ï¼Œç”¨äºå¼‚æ­¥å¤„ç†åœºæ™¯ï¼‰
@@ -437,6 +439,10 @@ pub struct OfferingRecord<T: Config> {
     pub expiry_block: Option<BlockNumberFor<T>>,
     /// P3æ–°å¢ï¼šæ˜¯å¦è‡ªåŠ¨ç»­è´¹ï¼ˆä»…è®¢é˜…ç±»å•†å“æœ‰æ•ˆï¼‰
     pub auto_renew: bool,
+    /// P1æ–°å¢ï¼šé”å®šçš„å•ä»·ï¼ˆè®¢é˜…åˆ›å»ºæ—¶çš„ä»·æ ¼ï¼Œç»­è´¹æ—¶ä½¿ç”¨ï¼‰
+    pub locked_unit_price: u128,
+    /// P1æ–°å¢ï¼šæš‚åœæ—¶çš„åŒºå—å·ï¼ˆç»­è´¹å¤±è´¥æ—¶è®°å½•ï¼Œç”¨äºè®¡ç®—å®½é™æœŸï¼‰
+    pub suspension_block: Option<BlockNumberFor<T>>,
 }

diff --git a/pallets/memorial/src/lib.rs b/pallets/memorial/src/lib.rs
index 1234567..abcdefg 100644
--- a/pallets/memorial/src/lib.rs
+++ b/pallets/memorial/src/lib.rs
@@ -790,6 +790,8 @@ pub mod pallet {
                 quantity,
                 expiry_block,  // P3æ–°å¢
                 auto_renew,    // P3æ–°å¢
+                locked_unit_price: unit_price,  // P1æ–°å¢ï¼šé”å®šè®¢é˜…æ—¶çš„å•ä»·
+                suspension_block: None,  // P1æ–°å¢ï¼šåˆå§‹æ— æš‚åœ
             };

@@ -148,8 +148,44 @@ pub mod pallet {

                 // å¤„ç†åˆ°æœŸè®¢å•
                 if let Some(mut record) = OfferingRecords::<T>::get(offering_id) {
-                    if record.status == OfferingStatus::Active && record.auto_renew {
+                    // P1æ–°å¢ï¼šå¤„ç†SuspendedçŠ¶æ€çš„å®½é™æœŸæ£€æŸ¥
+                    if record.status == OfferingStatus::Suspended {
+                        if let Some(suspension_block) = record.suspension_block {
+                            let grace_period = 100_800u32;
+                            if block_number.saturating_sub(suspension_block) > grace_period.into() {
+                                record.status = OfferingStatus::Expired;
+                                OfferingRecords::<T>::insert(offering_id, &record);
+                                Self::deposit_event(Event::SubscriptionExpired { ... });
+                            } else {
+                                if Self::try_auto_renew(offering_id, &mut record).is_ok() {
+                                    record.status = OfferingStatus::Active;
+                                    record.suspension_block = None;
+                                    OfferingRecords::<T>::insert(offering_id, &record);
+                                    Self::deposit_event(Event::SubscriptionRenewed { ... });
+                                }
+                            }
+                        }
+                    } else if record.status == OfferingStatus::Active && record.auto_renew {
                         if Self::try_auto_renew(offering_id, &mut record).is_ok() {
                             Self::deposit_event(Event::SubscriptionRenewed { ... });
                         } else {
-                            record.status = OfferingStatus::Expired;
+                            // P1ä¿®å¤ï¼šè¿›å…¥å®½é™æœŸ
+                            record.status = OfferingStatus::Suspended;
+                            record.suspension_block = Some(block_number);
                             OfferingRecords::<T>::insert(offering_id, &record);
                             Self::deposit_event(Event::AutoRenewFailed { ... });
                         }
                     } else {
                         record.status = OfferingStatus::Expired;
                         OfferingRecords::<T>::insert(offering_id, &record);
                         Self::deposit_event(Event::SubscriptionExpired { ... });
                     }
                 }

@@ -1149,16 +1150,10 @@ pub mod pallet {
         fn try_auto_renew(offering_id: u64, record: &mut OfferingRecord<T>) -> DispatchResult {
-            // 1. è·å–ç¥­ç¥€å“ä¿¡æ¯
-            let sacrifice = SacrificeOf::<T>::get(record.sacrifice_id)
-                .ok_or(Error::<T>::SacrificeNotFound)?;
-
-            // 2. è®¡ç®—ç»­è´¹ä»·æ ¼ï¼ˆä½¿ç”¨ç”¨æˆ·åŸæœ‰ç±»å‹ï¼‰
-            let user_type = Self::determine_user_type(&record.who);
-            let current_block = <frame_system::Pallet<T>>::block_number();
-            let unit_price = sacrifice.get_effective_price(user_type, current_block)
-                .ok_or(Error::<T>::PricingNotAvailable)?;
-
-            let renew_amount = unit_price.saturating_mul(record.quantity as u128);
+            // P1ä¿®å¤ï¼šç›´æ¥ä½¿ç”¨é”å®šä»·æ ¼
+
+            // 1. P1ä¿®å¤ï¼šä½¿ç”¨é”å®šä»·æ ¼è€Œéå½“å‰ä»·æ ¼
+            let renew_amount = record.locked_unit_price.saturating_mul(record.quantity as u128);

@@ -1175,6 +1176,7 @@ pub mod pallet {
             // 5. æ›´æ–°åˆ°æœŸæ—¶é—´
+            let current_block = <frame_system::Pallet<T>>::block_number();
             let weeks = record.duration_weeks.unwrap_or(4);
             let blocks_per_week = 100_800u32;
```

---

**END OF REPORT**
