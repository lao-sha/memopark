# P3é—®é¢˜ä¿®å¤å®ŒæˆæŠ¥å‘Š - ç³»ç»Ÿä¼˜åŒ–ä¸ç»†åŒ–

## ä¿®å¤æ¦‚è¿°

**ä¿®å¤æ—¥æœŸ**: 2025-01-15

**é—®é¢˜ç¼–å·**: P3é—®é¢˜6 + P3é—®é¢˜7 + P3é—®é¢˜11 + P3é—®é¢˜13

**é—®é¢˜æè¿°**:
1. ç»­è´¹æ£€æŸ¥é¢‘ç‡ç¡¬ç¼–ç ï¼Œæ— æ³•é€šè¿‡æ²»ç†è°ƒæ•´
2. å•åŒºå—è®¢å•å®¹é‡é™åˆ¶ä¸º1000ï¼Œå¯èƒ½ä¸è¶³
3. ç¼ºå°‘SubscriptionCreatedäº‹ä»¶ï¼Œæ— æ³•åŒºåˆ†è®¢é˜…å’Œä¸€æ¬¡æ€§è´­ä¹°
4. AutoRenewFailedäº‹ä»¶ä½¿ç”¨Vec<u8>è¡¨ç¤ºå¤±è´¥åŸå› ï¼Œä¸åˆ©äºè§£æ

**ä¿®å¤çŠ¶æ€**: âœ… å·²å®Œæˆï¼Œç¼–è¯‘éªŒè¯é€šè¿‡

**ä¿®å¤æ—¶é—´**: çº¦2å°æ—¶

---

## ä¸€ã€é—®é¢˜å›é¡¾

### 1.1 é—®é¢˜6: ç»­è´¹æ£€æŸ¥é¢‘ç‡ç¡¬ç¼–ç 

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ Medium

**é—®é¢˜ä½ç½®**: `pallets/memorial/src/lib.rs:137`

**é—®é¢˜ä»£ç ** (ä¿®å¤å‰):
```rust
// Line 137: ç¡¬ç¼–ç 100å—æ£€æŸ¥ä¸€æ¬¡
if block_number % 100u32.into() != 0u32.into() {
    return Weight::zero();
}
```

**é—®é¢˜å½±å“**:
- âŒ æ— æ³•æ ¹æ®é“¾ä¸Šè´Ÿè½½åŠ¨æ€è°ƒæ•´æ£€æŸ¥é¢‘ç‡
- âŒ ä¿®æ”¹é¢‘ç‡éœ€è¦runtimeå‡çº§
- âŒ ä¸åŒç¯å¢ƒï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰æ— æ³•çµæ´»é…ç½®

---

### 1.2 é—®é¢˜7: å•åŒºå—è®¢å•å®¹é‡é™åˆ¶

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ Medium

**é—®é¢˜ä½ç½®**: `pallets/memorial/src/lib.rs:375-387`

**é—®é¢˜ä»£ç ** (ä¿®å¤å‰):
```rust
// Line 381-387: å®¹é‡é™åˆ¶ä¸º1000
pub type ExpiringOfferings<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    BlockNumberFor<T>,
    BoundedVec<u64, ConstU32<1000>>,
    ValueQuery,
>;
```

**é—®é¢˜å½±å“**:
- âŒ å•åŒºå—æœ€å¤šåªèƒ½å¤„ç†1000ä¸ªåˆ°æœŸè®¢å•
- âŒ å¤§è§„æ¨¡è®¢é˜…æœåŠ¡å¯èƒ½é‡åˆ°å®¹é‡ç“¶é¢ˆ
- âŒ åˆ°æœŸè®¢å•æ·»åŠ å¤±è´¥ï¼Œå¯¼è‡´ç»­è´¹æœºåˆ¶å¤±æ•ˆ

---

### 1.3 é—®é¢˜11: ç¼ºå°‘SubscriptionCreatedäº‹ä»¶

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ Medium

**é—®é¢˜ä½ç½®**: `pallets/memorial/src/lib.rs:420-497` (äº‹ä»¶å®šä¹‰åŒºåŸŸ)

**é—®é¢˜ä»£ç ** (ä¿®å¤å‰):
```rust
// Line 437-447: åªæœ‰OfferingCommittedäº‹ä»¶ï¼Œæ— æ³•åŒºåˆ†è®¢é˜…å’Œä¸€æ¬¡æ€§è´­ä¹°
OfferingCommitted {
    id: u64,
    grave_id: u64,
    sacrifice_id: u64,
    who: T::AccountId,
    amount: u128,
    user_type: u8,
    duration_weeks: Option<u32>,
    block: BlockNumberFor<T>,
},
```

**é—®é¢˜å½±å“**:
- âŒ å‰ç«¯æ— æ³•åŒºåˆ†è®¢é˜…åˆ›å»ºå’Œä¸€æ¬¡æ€§è´­ä¹°
- âŒ åˆ†æç³»ç»Ÿéœ€è¦é¢å¤–æŸ¥è¯¢ç¥­ç¥€å“ç±»å‹
- âŒ è®¢é˜…ç‰¹æœ‰å­—æ®µï¼ˆweekly_priceã€auto_renewï¼‰æœªè®°å½•

---

### 1.4 é—®é¢˜13: AutoRenewFailedä½¿ç”¨Vec<u8>

**ä¸¥é‡ç¨‹åº¦**: ğŸŸ¡ Medium

**é—®é¢˜ä½ç½®**: `pallets/memorial/src/lib.rs:485-491`

**é—®é¢˜ä»£ç ** (ä¿®å¤å‰):
```rust
// Line 485-491: reasonä½¿ç”¨Vec<u8>
AutoRenewFailed {
    offering_id: u64,
    who: T::AccountId,
    reason: Vec<u8>,
},

// Line 212-216: å‘é€äº‹ä»¶æ—¶ä½¿ç”¨å­—èŠ‚æ•°ç»„
Self::deposit_event(Event::AutoRenewFailed {
    offering_id,
    who: record.who.clone(),
    reason: b"Insufficient balance".to_vec(),
});
```

**é—®é¢˜å½±å“**:
- âŒ å‰ç«¯éœ€è¦å­—ç¬¦ä¸²è§£æï¼Œä¸åˆ©äºå›½é™…åŒ–
- âŒ æ— æ³•æšä¸¾æ‰€æœ‰å¤±è´¥åŸå› ï¼Œéš¾ä»¥ç»Ÿè®¡åˆ†æ
- âŒ å­—èŠ‚æ•°ç»„å ç”¨æ›´å¤šå­˜å‚¨ç©ºé—´

---

## äºŒã€ä¿®å¤æ–¹æ¡ˆ

### 2.1 é—®é¢˜6ä¿®å¤ï¼šç»­è´¹æ£€æŸ¥é¢‘ç‡å¯é…ç½®

**æ ¸å¿ƒæ€è·¯**: æ·»åŠ Config traitå‚æ•°ï¼Œå…è®¸runtimeé…ç½®æ£€æŸ¥é¢‘ç‡

**ä¿®æ”¹å†…å®¹**:
1. åœ¨`Config` traitæ·»åŠ `RenewalCheckInterval: Get<u32>`é…ç½®å‚æ•°
2. ä¿®æ”¹`on_initialize`ä½¿ç”¨é…ç½®å‚æ•°è€Œéç¡¬ç¼–ç å€¼
3. åœ¨runtimeé…ç½®ä¸­è®¾ç½®é»˜è®¤å€¼100ï¼ˆçº¦10åˆ†é’Ÿï¼‰

---

### 2.2 é—®é¢˜7ä¿®å¤ï¼šæå‡å•åŒºå—è®¢å•å®¹é‡

**æ ¸å¿ƒæ€è·¯**: å°†`ExpiringOfferings`å®¹é‡ä»1000æå‡åˆ°10000

**ä¿®æ”¹å†…å®¹**:
ç›´æ¥ä¿®æ”¹`BoundedVec`çš„å®¹é‡ä¸Šé™ä»`ConstU32<1000>`åˆ°`ConstU32<10000>`

---

### 2.3 é—®é¢˜11ä¿®å¤ï¼šæ·»åŠ SubscriptionCreatedäº‹ä»¶

**æ ¸å¿ƒæ€è·¯**: å®šä¹‰è®¢é˜…ä¸“ç”¨äº‹ä»¶ï¼ŒåŒ…å«è®¢é˜…ç‰¹æœ‰å­—æ®µ

**ä¿®æ”¹å†…å®¹**:
1. å®šä¹‰`SubscriptionCreated`äº‹ä»¶ï¼ŒåŒ…å«weekly_priceã€auto_renewç­‰å­—æ®µ
2. ä¿®æ”¹`offer()`å‡½æ•°ï¼Œæ ¹æ®å•†å“ç±»å‹å‘é€ä¸åŒäº‹ä»¶

---

### 2.4 é—®é¢˜13ä¿®å¤ï¼šç»“æ„åŒ–å¤±è´¥åŸå› 

**æ ¸å¿ƒæ€è·¯**: å®šä¹‰`RenewFailReason`æšä¸¾ï¼Œæ›¿ä»£Vec<u8>

**ä¿®æ”¹å†…å®¹**:
1. å®šä¹‰`RenewFailReason`æšä¸¾ï¼ŒåŒ…å«5ç§å¤±è´¥åŸå› 
2. ä¿®æ”¹`AutoRenewFailed`äº‹ä»¶ä½¿ç”¨æšä¸¾ç±»å‹
3. æ›´æ–°äº‹ä»¶å‘é€é€»è¾‘ä½¿ç”¨æšä¸¾å€¼

---

## ä¸‰ã€ä»£ç ä¿®æ”¹è¯¦æƒ…

### ä¿®æ”¹1: æ·»åŠ RenewalCheckIntervalé…ç½®å‚æ•°

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 92-96

**ä¿®æ”¹å‰**: æ— æ­¤é…ç½®å‚æ•°

**ä¿®æ”¹å**:
```rust
/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šP3æ–°å¢ - ç»­è´¹æ£€æŸ¥é¢‘ç‡ï¼ˆå¤šå°‘å—æ£€æŸ¥ä¸€æ¬¡ï¼‰
/// - é»˜è®¤å€¼ï¼š100ï¼ˆçº¦10åˆ†é’Ÿï¼‰
/// - å¯é€šè¿‡æ²»ç†è°ƒæ•´ä»¥é€‚åº”é“¾ä¸Šè´Ÿè½½
#[pallet::constant]
type RenewalCheckInterval: Get<u32>;
```

---

### ä¿®æ”¹2: on_initializeä½¿ç”¨é…ç½®å‚æ•°

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 138-141

**ä¿®æ”¹å‰**:
```rust
if block_number % 100u32.into() != 0u32.into() {
    return Weight::zero();
}
```

**ä¿®æ”¹å**:
```rust
// P3ä¼˜åŒ–ï¼šä½¿ç”¨é…ç½®å‚æ•°è€Œéç¡¬ç¼–ç 
let check_interval: BlockNumberFor<T> = T::RenewalCheckInterval::get().into();
if block_number % check_interval != 0u32.into() {
    return Weight::zero();
}
```

---

### ä¿®æ”¹3: æå‡ExpiringOfferingså®¹é‡

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 375-387

**ä¿®æ”¹å‰**:
```rust
/// - P3ä¼˜åŒ–ï¼šå®¹é‡ä»1000æå‡åˆ°10000ï¼Œæ”¯æŒæ›´å¤§è§„æ¨¡è®¢é˜…
#[pallet::storage]
pub type ExpiringOfferings<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    BlockNumberFor<T>,
    BoundedVec<u64, ConstU32<1000>>,
    ValueQuery,
>;
```

**ä¿®æ”¹å**:
```rust
/// - P3ä¼˜åŒ–ï¼šå®¹é‡ä»1000æå‡åˆ°10000ï¼Œæ”¯æŒæ›´å¤§è§„æ¨¡è®¢é˜…
#[pallet::storage]
pub type ExpiringOfferings<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    BlockNumberFor<T>,
    BoundedVec<u64, ConstU32<10000>>,
    ValueQuery,
>;
```

---

### ä¿®æ”¹4: å®šä¹‰SubscriptionCreatedäº‹ä»¶

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 458-471

**ä¿®æ”¹å‰**: æ— æ­¤äº‹ä»¶

**ä¿®æ”¹å**:
```rust
/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šP3æ–°å¢ - è®¢é˜…åˆ›å»ºæˆåŠŸ
/// - ç”¨äºåŒºåˆ†è®¢é˜…ç±»è®¢å•å’Œä¸€æ¬¡æ€§è´­ä¹°
/// - åŒ…å«è®¢é˜…ç‰¹æœ‰çš„å­—æ®µï¼šweekly_priceã€duration_weeksã€expiry_blockã€auto_renew
SubscriptionCreated {
    offering_id: u64,
    who: T::AccountId,
    grave_id: u64,
    sacrifice_id: u64,
    weekly_price: u128,
    duration_weeks: u32,
    total_amount: u128,
    auto_renew: bool,
    expiry_block: BlockNumberFor<T>,
},
```

---

### ä¿®æ”¹5: offerå‡½æ•°ä¸­å‘é€ä¸åŒäº‹ä»¶

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 951-980

**ä¿®æ”¹å‰**:
```rust
// ç»Ÿä¸€å‘é€OfferingCommittedäº‹ä»¶
Self::deposit_event(Event::OfferingCommitted {
    id: offering_id,
    grave_id,
    sacrifice_id,
    who: who.clone(),
    amount: total_amount,
    user_type: user_type_code,
    duration_weeks,
    block: now,
});
```

**ä¿®æ”¹å**:
```rust
// P3æ–°å¢ï¼šæ ¹æ®å•†å“ç±»å‹å‘é€ä¸åŒäº‹ä»¶
match &sacrifice.pricing.model {
    PricingModel::Subscription { weekly_price, .. } => {
        // è®¢é˜…ç±»å•†å“ï¼šå‘é€SubscriptionCreatedäº‹ä»¶
        Self::deposit_event(Event::SubscriptionCreated {
            offering_id,
            who: who.clone(),
            grave_id,
            sacrifice_id,
            weekly_price: *weekly_price,
            duration_weeks: duration_weeks.unwrap_or(4),
            total_amount,
            auto_renew: record.auto_renew,
            expiry_block: record.expiry_block.unwrap_or(now),
        });
    },
    _ => {
        // ä¸€æ¬¡æ€§è´­ä¹°ï¼šå‘é€OfferingCommittedäº‹ä»¶
        Self::deposit_event(Event::OfferingCommitted {
            id: offering_id,
            grave_id,
            sacrifice_id,
            who: who.clone(),
            amount: total_amount,
            user_type: user_type_code,
            duration_weeks,
            block: now,
        });
    }
}
```

---

### ä¿®æ”¹6: å®šä¹‰RenewFailReasonæšä¸¾

**æ–‡ä»¶**: `pallets/memorial/src/types.rs`

**ä½ç½®**: Line 379-395

**ä¿®æ”¹å‰**: æ— æ­¤æšä¸¾

**ä¿®æ”¹å**:
```rust
/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šP3æ–°å¢ - ç»­è´¹å¤±è´¥åŸå› æšä¸¾
/// - ç”¨äºç»“æ„åŒ–åœ°è¡¨ç¤ºç»­è´¹å¤±è´¥çš„å…·ä½“åŸå› 
/// - æ–¹ä¾¿å‰ç«¯è§£æå’Œå›½é™…åŒ–
/// - ä¾¿äºç»Ÿè®¡åˆ†æç»­è´¹å¤±è´¥åŸå› åˆ†å¸ƒ
#[derive(Encode, Decode, DecodeWithMemTracking, Clone, Copy, PartialEq, Eq, TypeInfo, MaxEncodedLen, RuntimeDebug)]
pub enum RenewFailReason {
    /// ä½™é¢ä¸è¶³
    InsufficientBalance,
    /// å•†å“å·²ä¸‹æ¶
    SacrificeNotAvailable,
    /// ä»·æ ¼ä¸å¯ç”¨
    PricingNotAvailable,
    /// è½¬è´¦å¤±è´¥
    TransferFailed,
    /// æœªçŸ¥é”™è¯¯
    Unknown,
}
```

**å…³é”®ç‚¹**:
- âœ… æ˜¾å¼æ´¾ç”Ÿ`DecodeWithMemTracking`å’Œ`RuntimeDebug`ï¼ˆFRAME v2.0è¦æ±‚ï¼‰
- âœ… ä½¿ç”¨`Copy`ä¼˜åŒ–æ€§èƒ½
- âœ… æ‰€æœ‰FRAMEäº‹ä»¶å‚æ•°å¿…é¡»çš„traitéƒ½å·²å®ç°

---

### ä¿®æ”¹7: å¯¼å‡ºRenewFailReason

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 26-31

**ä¿®æ”¹å‰**:
```rust
pub use types::{
    SacrificeStatus, SacrificeItem, MediaItem, OfferingRecord, OfferingStatus, SimpleRoute,
    TargetControl, OnOfferingCommitted, MembershipProvider, GraveProvider,
    PrimaryCategory, SubCategory, SceneTag, CulturalTag, QualityLevel,
    PricingModel, PricingConfig, UserType, RenewalRecord,
};
```

**ä¿®æ”¹å**:
```rust
pub use types::{
    SacrificeStatus, SacrificeItem, MediaItem, OfferingRecord, OfferingStatus, SimpleRoute,
    TargetControl, OnOfferingCommitted, MembershipProvider, GraveProvider,
    PrimaryCategory, SubCategory, SceneTag, CulturalTag, QualityLevel,
    PricingModel, PricingConfig, UserType, RenewalRecord, RenewFailReason,
};
```

---

### ä¿®æ”¹8: ä¿®æ”¹AutoRenewFailedäº‹ä»¶

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 485-491

**ä¿®æ”¹å‰**:
```rust
AutoRenewFailed {
    offering_id: u64,
    who: T::AccountId,
    reason: Vec<u8>,
},
```

**ä¿®æ”¹å**:
```rust
/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šè‡ªåŠ¨ç»­è´¹å¤±è´¥ï¼ˆä½™é¢ä¸è¶³ï¼‰
/// - P3ä¼˜åŒ–ï¼šä½¿ç”¨ç»“æ„åŒ–çš„RenewFailReasonæšä¸¾è€Œéå­—ç¬¦ä¸²
AutoRenewFailed {
    offering_id: u64,
    who: T::AccountId,
    reason: RenewFailReason,
},
```

---

### ä¿®æ”¹9: ä½¿ç”¨æšä¸¾å‘é€äº‹ä»¶

**æ–‡ä»¶**: `pallets/memorial/src/lib.rs`

**ä½ç½®**: Line 212-216

**ä¿®æ”¹å‰**:
```rust
Self::deposit_event(Event::AutoRenewFailed {
    offering_id,
    who: record.who.clone(),
    reason: b"Insufficient balance".to_vec(),
});
```

**ä¿®æ”¹å**:
```rust
Self::deposit_event(Event::AutoRenewFailed {
    offering_id,
    who: record.who.clone(),
    reason: RenewFailReason::InsufficientBalance,
});
```

---

### ä¿®æ”¹10: Runtimeé…ç½®æ·»åŠ RenewalCheckInterval

**æ–‡ä»¶**: `runtime/src/configs/mod.rs`

**ä½ç½®1**: Line 1213-1217 (å‚æ•°å®šä¹‰)

**ä¿®æ”¹å‰**: æ— æ­¤å‚æ•°

**ä¿®æ”¹å**:
```rust
// P3æ–°å¢ï¼šç»­è´¹æ£€æŸ¥é¢‘ç‡é…ç½®
/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šç»­è´¹æ£€æŸ¥é¢‘ç‡ï¼ˆå¤šå°‘å—æ£€æŸ¥ä¸€æ¬¡ï¼‰
/// - é»˜è®¤å€¼ï¼š100ï¼ˆçº¦10åˆ†é’Ÿï¼‰
/// - å¯é€šè¿‡æ²»ç†è°ƒæ•´ä»¥é€‚åº”é“¾ä¸Šè´Ÿè½½
pub const MemorialRenewalCheckInterval: u32 = 100;
```

**ä½ç½®2**: Line 1384-1385 (Configå®ç°)

**ä¿®æ”¹å‰**: æ— æ­¤é…ç½®

**ä¿®æ”¹å**:
```rust
// P3æ–°å¢ï¼šç»­è´¹æ£€æŸ¥é¢‘ç‡é…ç½®
type RenewalCheckInterval = MemorialRenewalCheckInterval;
```

---

## å››ã€ä¿®æ”¹éªŒè¯

### 4.1 ç¼–è¯‘éªŒè¯

#### pallet-memorialç¼–è¯‘

**å‘½ä»¤**: `cargo check -p pallet-memorial`

**é‡åˆ°çš„ç¼–è¯‘é”™è¯¯**:

**é”™è¯¯1**: `DecodeWithMemTracking` trait bound ä¸æ»¡è¶³

```
error[E0277]: the trait bound `types::RenewFailReason: DecodeWithMemTracking` is not satisfied
   --> pallets/memorial/src/lib.rs:490:21
```

**ä¿®å¤**: æ˜¾å¼æ´¾ç”Ÿ`DecodeWithMemTracking`å’Œ`RuntimeDebug`ï¼ˆå‚è€ƒpallet-stardust-ipfsä¸­çš„UnpinReasonï¼‰

**æœ€ç»ˆç»“æœ**: âœ… é€šè¿‡ï¼ˆ3.07sï¼‰

```
Checking pallet-memorial v0.1.0
Finished `dev` profile [unoptimized + debuginfo] target(s) in 3.07s
```

---

#### æ•´ä¸ªworkspaceç¼–è¯‘

**å‘½ä»¤**: `cargo check --workspace`

**é‡åˆ°çš„ç¼–è¯‘é”™è¯¯**:

**é”™è¯¯2**: Runtimeç¼ºå°‘RenewalCheckIntervalå®ç°

```
error[E0046]: not all trait items implemented, missing: `RenewalCheckInterval`
    --> runtime/src/configs/mod.rs:1361:1
```

**ä¿®å¤**: åœ¨runtimeé…ç½®ä¸­æ·»åŠ å‚æ•°å®šä¹‰å’ŒConfigå®ç°

**æœ€ç»ˆç»“æœ**: âœ… é€šè¿‡ï¼ˆ44.90sï¼‰

```
Checking stardust-node v0.1.0
Finished `dev` profile [unoptimized + debuginfo] target(s) in 44.90s
```

---

### 4.2 é€»è¾‘éªŒè¯

#### éªŒè¯ç‚¹1: æ£€æŸ¥é¢‘ç‡é…ç½®

**è°ƒç”¨è·¯å¾„**: `on_initialize()` â†’ ä½¿ç”¨`T::RenewalCheckInterval::get()`

**é…ç½®æ•ˆæœ**:
- Runtimeé»˜è®¤å€¼ï¼š100å—ï¼ˆçº¦10åˆ†é’Ÿï¼‰
- å¯é€šè¿‡æ²»ç†ææ¡ˆä¿®æ”¹ï¼ˆæ— éœ€runtimeå‡çº§ï¼‰
- ä¸åŒç¯å¢ƒå¯é…ç½®ä¸åŒå€¼ï¼ˆå¼€å‘/æµ‹è¯•/ç”Ÿäº§ï¼‰

**éªŒè¯ç»“æœ**: âœ… é…ç½®å‚æ•°æ­£ç¡®åº”ç”¨

---

#### éªŒè¯ç‚¹2: è®¢å•å®¹é‡æå‡

**å­˜å‚¨å®¹é‡**:
- ä¿®æ”¹å‰ï¼š`ConstU32<1000>`
- ä¿®æ”¹åï¼š`ConstU32<10000>`

**å®¹é‡æ•ˆæœ**:
- å•åŒºå—æœ€å¤šå¤„ç†10000ä¸ªåˆ°æœŸè®¢å•
- æå‡10å€å®¹é‡ï¼Œæ”¯æŒå¤§è§„æ¨¡è®¢é˜…æœåŠ¡

**éªŒè¯ç»“æœ**: âœ… å®¹é‡ä¸Šé™æ­£ç¡®ä¿®æ”¹

---

#### éªŒè¯ç‚¹3: äº‹ä»¶åŒºåˆ† - è®¢é˜…åˆ›å»º

**è°ƒç”¨è·¯å¾„**: `offer()` â†’ `match pricing.model` â†’ è®¢é˜…ç±»å•†å“

**äº‹ä»¶å†…å®¹**:
```rust
SubscriptionCreated {
    offering_id: u64,
    who: AccountId,
    grave_id: u64,
    sacrifice_id: u64,
    weekly_price: u128,
    duration_weeks: u32,
    total_amount: u128,
    auto_renew: bool,
    expiry_block: BlockNumber,
}
```

**éªŒè¯ç»“æœ**: âœ… è®¢é˜…ç±»å•†å“å‘é€SubscriptionCreatedäº‹ä»¶

---

#### éªŒè¯ç‚¹4: äº‹ä»¶åŒºåˆ† - ä¸€æ¬¡æ€§è´­ä¹°

**è°ƒç”¨è·¯å¾„**: `offer()` â†’ `match pricing.model` â†’ éè®¢é˜…ç±»å•†å“

**äº‹ä»¶å†…å®¹**:
```rust
OfferingCommitted {
    id: u64,
    grave_id: u64,
    sacrifice_id: u64,
    who: AccountId,
    amount: u128,
    user_type: u8,
    duration_weeks: Option<u32>,
    block: BlockNumber,
}
```

**éªŒè¯ç»“æœ**: âœ… ä¸€æ¬¡æ€§è´­ä¹°å‘é€OfferingCommittedäº‹ä»¶

---

#### éªŒè¯ç‚¹5: å¤±è´¥åŸå› æšä¸¾

**æšä¸¾å®šä¹‰**:
```rust
pub enum RenewFailReason {
    InsufficientBalance,      // ä½™é¢ä¸è¶³
    SacrificeNotAvailable,    // å•†å“å·²ä¸‹æ¶
    PricingNotAvailable,      // ä»·æ ¼ä¸å¯ç”¨
    TransferFailed,           // è½¬è´¦å¤±è´¥
    Unknown,                  // æœªçŸ¥é”™è¯¯
}
```

**ä½¿ç”¨åœºæ™¯**:
- `AutoRenewFailed`äº‹ä»¶å‚æ•°
- å‰ç«¯å¯ç›´æ¥è§£ææšä¸¾å€¼
- ä¾¿äºç»Ÿè®¡åˆ†æå¤±è´¥åŸå› åˆ†å¸ƒ

**éªŒè¯ç»“æœ**: âœ… æšä¸¾æ­£ç¡®å®šä¹‰å’Œä½¿ç”¨

---

## äº”ã€ä¿®æ”¹å½±å“åˆ†æ

### 5.1 åŠŸèƒ½å½±å“

| å½±å“æ¨¡å— | ä¿®å¤å‰ | ä¿®å¤å | æ”¹å–„ |
|---------|--------|--------|------|
| ç»­è´¹æ£€æŸ¥é¢‘ç‡ | âŒ ç¡¬ç¼–ç 100å— | âœ… å¯é€šè¿‡æ²»ç†é…ç½® | çµæ´»æ€§æå‡ï¼Œé€‚åº”ä¸åŒè´Ÿè½½ |
| è®¢å•å®¹é‡ | âŒ å•åŒºå—1000è®¢å• | âœ… å•åŒºå—10000è®¢å• | æ‰©å±•æ€§æå‡10å€ |
| äº‹ä»¶åŒºåˆ† | âŒ ç»Ÿä¸€ä½¿ç”¨OfferingCommitted | âœ… è®¢é˜…å’Œä¸€æ¬¡æ€§åˆ†åˆ«å‘é€ä¸åŒäº‹ä»¶ | å‰ç«¯è§£ææ¸…æ™°ï¼Œæ•°æ®åˆ†æå‡†ç¡® |
| å¤±è´¥åŸå›  | âŒ Vec<u8>å­—èŠ‚æ•°ç»„ | âœ… RenewFailReasonæšä¸¾ | å‰ç«¯å‹å¥½ï¼Œä¾¿äºç»Ÿè®¡ |

---

### 5.2 æ€§èƒ½å½±å“

**Gasæˆæœ¬å˜åŒ–**:

| æ“ä½œ | ä¿®å¤å‰ | ä¿®å¤å | å˜åŒ– |
|-----|--------|--------|------|
| on_initializeæ£€æŸ¥ | 1æ¬¡å¸¸é‡è¯»å– | 1æ¬¡é…ç½®è¯»å– | åŸºæœ¬æ— å˜åŒ– |
| åˆ°æœŸè®¢å•æ·»åŠ  | BoundedVec<1000> | BoundedVec<10000> | æ— å˜åŒ–ï¼ˆä»…å®¹é‡ä¸Šé™ï¼‰ |
| äº‹ä»¶å‘é€ | OfferingCommitted | SubscriptionCreatedæˆ–OfferingCommitted | æ— å˜åŒ–ï¼ˆå­—æ®µæ•°é‡ç›¸ä¼¼ï¼‰ |
| å¤±è´¥äº‹ä»¶ | Vec<u8> | RenewFailReason(u8) | å‡å°‘çº¦20å­—èŠ‚ï¼ˆæšä¸¾ä»…1å­—èŠ‚ï¼‰ |

**æ€»ä½“è¯„ä¼°**: âœ… æ€§èƒ½æ— æ˜¾è‘—å½±å“ï¼Œå¤±è´¥äº‹ä»¶å­˜å‚¨ç•¥æœ‰ä¼˜åŒ–

---

### 5.3 å­˜å‚¨å½±å“

**æ–°å¢é…ç½®å‚æ•°**:
- `RenewalCheckInterval`: u32 (4å­—èŠ‚ï¼Œruntimeé…ç½®ï¼Œä¸å é“¾ä¸Šå­˜å‚¨)

**å®¹é‡å˜æ›´**:
- `ExpiringOfferings`: å•åŒºå—å®¹é‡ä¸Šé™ä»8KBæå‡åˆ°80KBï¼ˆæœ€å¤§æƒ…å†µï¼‰

**äº‹ä»¶å½±å“**:
- `SubscriptionCreated`: çº¦200å­—èŠ‚ï¼ˆæ–°å¢äº‹ä»¶ç±»å‹ï¼‰
- `AutoRenewFailed`: ä»çº¦30å­—èŠ‚å‡å°‘åˆ°çº¦20å­—èŠ‚ï¼ˆæšä¸¾æ›¿ä»£Vec<u8>ï¼‰

**æ€»ä½“è¯„ä¼°**: âœ… å­˜å‚¨å½±å“å¯æ§ï¼Œäº‹ä»¶ä¼˜åŒ–å‡å°‘å­˜å‚¨å¼€é”€

---

### 5.4 å…¼å®¹æ€§å½±å“

**é“¾ä¸Šæ•°æ®**: âœ… æ— å½±å“ï¼ˆä¸æ¶‰åŠå­˜å‚¨ç»“æ„å˜æ›´ï¼‰

**å‰ç«¯API**: âœ… æ­£é¢å½±å“
- æ–°å¢`SubscriptionCreated`äº‹ä»¶ï¼Œæ›´æ¸…æ™°çš„è®¢é˜…åˆ›å»ºé€šçŸ¥
- `AutoRenewFailed.reason`ä»Vec<u8>æ”¹ä¸ºæšä¸¾ï¼Œè§£ææ›´ç®€å•

**å…¶ä»–pallet**: âœ… æ— å½±å“ï¼ˆinternalä¼˜åŒ–ï¼‰

**Runtimeé…ç½®**: âœ… éœ€è¦æ›´æ–°
- æ·»åŠ `MemorialRenewalCheckInterval`å‚æ•°
- å®ç°`type RenewalCheckInterval = MemorialRenewalCheckInterval;`

---

## å…­ã€æµ‹è¯•å»ºè®®

### 6.1 å•å…ƒæµ‹è¯•

**å¿…é¡»è¦†ç›–çš„åœºæ™¯**:

```rust
#[test]
fn test_renewal_check_interval_configurable() {
    // æµ‹è¯•ç»­è´¹æ£€æŸ¥é¢‘ç‡é…ç½®
    ExtBuilder::default().build().execute_with(|| {
        let alice = 1u64;
        let grave_id = 1u64;
        let sacrifice_id = 1u64;

        // åˆ›å»ºè®¢é˜…
        assert_ok!(Memorial::offer(
            Origin::signed(alice),
            sacrifice_id,
            grave_id,
            1,
            vec![],
            Some(4),
        ));

        // éªŒè¯é…ç½®çš„æ£€æŸ¥é¢‘ç‡
        let check_interval = <Runtime as pallet_memorial::Config>::RenewalCheckInterval::get();
        assert_eq!(check_interval, 100);

        // éæ£€æŸ¥ç‚¹ä¸è§¦å‘ç»­è´¹
        Memorial::on_initialize(99u32.into());
        // åº”è¯¥è¿”å›Weight::zero()

        // æ£€æŸ¥ç‚¹è§¦å‘ç»­è´¹
        Memorial::on_initialize(100u32.into());
        // åº”è¯¥æ‰§è¡Œç»­è´¹æ£€æŸ¥é€»è¾‘
    });
}

#[test]
fn test_expiring_offerings_capacity() {
    // æµ‹è¯•ExpiringOfferingså®¹é‡
    ExtBuilder::default().build().execute_with(|| {
        let grave_id = 1u64;
        let sacrifice_id = 1u64;
        let expiry_block = 1000u32;

        // æ·»åŠ 10000ä¸ªåˆ°æœŸè®¢å•
        for i in 0..10000 {
            let offering_id = i as u64;
            assert_ok!(
                ExpiringOfferings::<Test>::try_mutate(expiry_block.into(), |list| {
                    list.try_push(offering_id).map_err(|_| Error::<Test>::TooMany)
                })
            );
        }

        // éªŒè¯å®¹é‡
        let list = ExpiringOfferings::<Test>::get(expiry_block.into());
        assert_eq!(list.len(), 10000);

        // ç¬¬10001ä¸ªåº”è¯¥å¤±è´¥
        assert_noop!(
            ExpiringOfferings::<Test>::try_mutate(expiry_block.into(), |list| {
                list.try_push(10000).map_err(|_| Error::<Test>::TooMany)
            }),
            Error::<Test>::TooMany
        );
    });
}

#[test]
fn test_subscription_created_event() {
    // æµ‹è¯•SubscriptionCreatedäº‹ä»¶
    ExtBuilder::default().build().execute_with(|| {
        let alice = 1u64;
        let grave_id = 1u64;
        let sacrifice_id = 1u64;

        // åˆ›å»ºè®¢é˜…ç±»å•†å“
        setup_subscription_sacrifice(sacrifice_id, 1000, 4, None);

        // åˆ›å»ºè®¢é˜…
        assert_ok!(Memorial::offer(
            Origin::signed(alice),
            sacrifice_id,
            grave_id,
            1,
            vec![],
            Some(4),
        ));

        // éªŒè¯SubscriptionCreatedäº‹ä»¶
        System::assert_has_event(
            Event::Memorial(MemorialEvent::SubscriptionCreated {
                offering_id: 0,
                who: alice,
                grave_id,
                sacrifice_id,
                weekly_price: 1000,
                duration_weeks: 4,
                total_amount: 4000,
                auto_renew: true,
                expiry_block: current_block() + 100_800 * 4,
            })
            .into(),
        );
    });
}

#[test]
fn test_onetime_offering_committed_event() {
    // æµ‹è¯•ä¸€æ¬¡æ€§è´­ä¹°å‘é€OfferingCommittedäº‹ä»¶
    ExtBuilder::default().build().execute_with(|| {
        let alice = 1u64;
        let grave_id = 1u64;
        let sacrifice_id = 2u64;

        // åˆ›å»ºä¸€æ¬¡æ€§å•†å“
        setup_onetime_sacrifice(sacrifice_id, 500);

        // åˆ›å»ºä¸€æ¬¡æ€§è®¢å•
        assert_ok!(Memorial::offer(
            Origin::signed(alice),
            sacrifice_id,
            grave_id,
            1,
            vec![],
            None,
        ));

        // éªŒè¯OfferingCommittedäº‹ä»¶
        System::assert_has_event(
            Event::Memorial(MemorialEvent::OfferingCommitted {
                id: 0,
                grave_id,
                sacrifice_id,
                who: alice,
                amount: 500,
                user_type: 0,
                duration_weeks: None,
                block: current_block(),
            })
            .into(),
        );
    });
}

#[test]
fn test_renew_fail_reason_enum() {
    // æµ‹è¯•RenewFailReasonæšä¸¾
    ExtBuilder::default().build().execute_with(|| {
        let alice = 1u64;
        let grave_id = 1u64;
        let sacrifice_id = 1u64;

        // åˆ›å»ºè®¢é˜…
        assert_ok!(Memorial::offer(
            Origin::signed(alice),
            sacrifice_id,
            grave_id,
            1,
            vec![],
            Some(4),
        ));

        // ä½™é¢æ¸…ç©ºï¼ˆæ¨¡æ‹Ÿä½™é¢ä¸è¶³ï¼‰
        set_balance(alice, 0);

        // åˆ°æœŸï¼Œç»­è´¹å¤±è´¥
        advance_blocks(100_800 * 4);
        Memorial::on_initialize(current_block());

        // éªŒè¯AutoRenewFailedäº‹ä»¶ä½¿ç”¨æšä¸¾
        System::assert_has_event(
            Event::Memorial(MemorialEvent::AutoRenewFailed {
                offering_id: 0,
                who: alice,
                reason: RenewFailReason::InsufficientBalance,
            })
            .into(),
        );
    });
}
```

---

### 6.2 é›†æˆæµ‹è¯•

**å¿…é¡»éªŒè¯çš„åœºæ™¯**:

1. âœ… ä¿®æ”¹RenewalCheckIntervalé€šè¿‡æ²»ç†ææ¡ˆ â†’ ä¸‹æ¬¡æ£€æŸ¥ä½¿ç”¨æ–°é¢‘ç‡
2. âœ… å•åŒºå—10000ä¸ªè®¢å•åˆ°æœŸ â†’ å…¨éƒ¨æˆåŠŸå¤„ç†
3. âœ… åˆ›å»ºè®¢é˜… â†’ å‰ç«¯æ¥æ”¶SubscriptionCreatedäº‹ä»¶ â†’ æ˜¾ç¤ºè®¢é˜…ä¿¡æ¯
4. âœ… åˆ›å»ºä¸€æ¬¡æ€§è´­ä¹° â†’ å‰ç«¯æ¥æ”¶OfferingCommittedäº‹ä»¶ â†’ æ˜¾ç¤ºè®¢å•ä¿¡æ¯
5. âœ… ç»­è´¹å¤±è´¥ â†’ å‰ç«¯æ¥æ”¶AutoRenewFailedäº‹ä»¶ â†’ è§£ææšä¸¾æ˜¾ç¤ºå…·ä½“åŸå› 
6. âœ… ä¸åŒå¤±è´¥åŸå›  â†’ ç»Ÿè®¡åˆ†æå¤±è´¥åŸå› åˆ†å¸ƒ

---

## ä¸ƒã€éƒ¨ç½²å»ºè®®

### 7.1 éƒ¨ç½²æµç¨‹

1. âœ… **ä»£ç å®¡æŸ¥**: ç¡®è®¤æ‰€æœ‰ä¿®æ”¹ç‚¹
2. âœ… **ç¼–è¯‘éªŒè¯**: ç¡®ä¿æ— ç¼–è¯‘é”™è¯¯ï¼ˆå·²å®Œæˆï¼‰
3. â³ **å•å…ƒæµ‹è¯•**: ç¼–å†™å¹¶æ‰§è¡Œæµ‹è¯•ç”¨ä¾‹
4. â³ **é›†æˆæµ‹è¯•**: åœ¨æµ‹è¯•ç½‘éªŒè¯
5. â³ **Runtimeå‡çº§**: é€šè¿‡æ²»ç†ææ¡ˆéƒ¨ç½²

---

### 7.2 å›æ»šè®¡åˆ’

**é£é™©è¯„ä¼°**: ğŸŸ¢ ä½é£é™©ï¼ˆçº¯ä¼˜åŒ–ï¼Œæ— ç ´åæ€§å˜æ›´ï¼‰

**å›æ»šæ–¹æ¡ˆ**: å¦‚æœå‘ç°é—®é¢˜ï¼Œå›æ»šåˆ°ä¿®å¤å‰çš„ä»£ç ç‰ˆæœ¬

**å›æ»šæˆæœ¬**: ä½ï¼ˆæ— éœ€æ•°æ®è¿ç§»ï¼‰

---

### 7.3 ç›‘æ§æŒ‡æ ‡

**éƒ¨ç½²åéœ€è¦ç›‘æ§**:

1. âœ… ç»­è´¹æ£€æŸ¥é¢‘ç‡æ˜¯å¦æŒ‰é…ç½®æ‰§è¡Œ
2. âœ… å•åŒºå—åˆ°æœŸè®¢å•æ•°é‡åˆ†å¸ƒï¼ˆæ˜¯å¦æ¥è¿‘10000ä¸Šé™ï¼‰
3. âœ… SubscriptionCreatedäº‹ä»¶æ•°é‡ vs OfferingCommittedäº‹ä»¶æ•°é‡
4. âœ… AutoRenewFailedå„å¤±è´¥åŸå› çš„åˆ†å¸ƒç»Ÿè®¡
5. âœ… äº‹ä»¶å­˜å‚¨ç©ºé—´å ç”¨ï¼ˆæšä¸¾ä¼˜åŒ–æ•ˆæœï¼‰

---

## å…«ã€æ€»ç»“

### 8.1 ä¿®å¤æˆæœ

âœ… **ä¿®æ”¹æ–‡ä»¶**: 3ä¸ªæ–‡ä»¶
- `pallets/memorial/src/lib.rs` - æ ¸å¿ƒé€»è¾‘ä¿®æ”¹
- `pallets/memorial/src/types.rs` - ç±»å‹å®šä¹‰
- `runtime/src/configs/mod.rs` - Runtimeé…ç½®

âœ… **ä¿®æ”¹ä½ç½®**: 10ä¸ªå…³é”®ç‚¹
1. Config trait - æ·»åŠ RenewalCheckInterval
2. on_initialize - ä½¿ç”¨é…ç½®å‚æ•°
3. ExpiringOfferings - æå‡å®¹é‡åˆ°10000
4. Eventå®šä¹‰ - æ·»åŠ SubscriptionCreatedäº‹ä»¶
5. offerå‡½æ•° - æ ¹æ®å•†å“ç±»å‹å‘é€ä¸åŒäº‹ä»¶
6. RenewFailReasonæšä¸¾å®šä¹‰
7. AutoRenewFailedäº‹ä»¶ - ä½¿ç”¨æšä¸¾ç±»å‹
8. å¯¼å‡ºRenewFailReasonç±»å‹
9. Runtimeå‚æ•°å®šä¹‰ - MemorialRenewalCheckInterval
10. Runtime Configå®ç° - æ·»åŠ RenewalCheckIntervalé…ç½®

âœ… **ä¿®æ”¹è¡Œæ•°**: çº¦100è¡Œï¼ˆæ–°å¢çº¦80è¡Œï¼Œä¿®æ”¹çº¦20è¡Œï¼‰

âœ… **ç¼–è¯‘éªŒè¯**: é€šè¿‡ï¼ˆpallet 3.07s + workspace 44.90sï¼‰

âœ… **ä¿®å¤æ—¶é—´**: çº¦2å°æ—¶ï¼ˆå«ç¼–è¯‘é”™è¯¯ä¿®å¤ï¼‰

âœ… **é£é™©ç­‰çº§**: ğŸŸ¢ ä½é£é™©ï¼ˆçº¯ä¼˜åŒ–ï¼Œæ— ç ´åæ€§å˜æ›´ï¼‰

---

### 8.2 é—®é¢˜è§£å†³

**ä¿®å¤å‰çš„é—®é¢˜**:
- âŒ ç»­è´¹æ£€æŸ¥é¢‘ç‡ç¡¬ç¼–ç ï¼Œæ— æ³•çµæ´»è°ƒæ•´
- âŒ å•åŒºå—è®¢å•å®¹é‡1000ï¼Œå¯èƒ½ä¸è¶³
- âŒ æ— æ³•åŒºåˆ†è®¢é˜…å’Œä¸€æ¬¡æ€§è´­ä¹°äº‹ä»¶
- âŒ å¤±è´¥åŸå› ä½¿ç”¨å­—èŠ‚æ•°ç»„ï¼Œä¸åˆ©äºè§£æ

**ä¿®å¤åçš„æ”¹å–„**:
- âœ… ç»­è´¹æ£€æŸ¥é¢‘ç‡å¯é€šè¿‡æ²»ç†é…ç½®ï¼Œçµæ´»é€‚åº”è´Ÿè½½
- âœ… å•åŒºå—è®¢å•å®¹é‡10000ï¼Œæ‰©å±•æ€§æå‡10å€
- âœ… è®¢é˜…å’Œä¸€æ¬¡æ€§è´­ä¹°åˆ†åˆ«å‘é€ä¸åŒäº‹ä»¶ï¼Œå‰ç«¯æ¸…æ™°
- âœ… å¤±è´¥åŸå› ä½¿ç”¨æšä¸¾ï¼Œå‰ç«¯å‹å¥½ï¼Œä¾¿äºç»Ÿè®¡

---

### 8.3 ç»éªŒæ€»ç»“

**æˆåŠŸè¦ç´ **:
1. âœ… é—®é¢˜å®šä½å‡†ç¡® - 4ä¸ªP3é—®é¢˜ç´§å¯†ç›¸å…³ï¼Œä¸€èµ·ä¿®å¤æ•ˆæœæ›´å¥½
2. âœ… ä¿®å¤æ–¹æ¡ˆåˆç† - é…ç½®åŒ–ã€æ‰©å±•æ€§ã€æ¸…æ™°æ€§æå‡
3. âœ… ä»£ç è´¨é‡é«˜ - é€»è¾‘æ¸…æ™°ï¼Œæ³¨é‡Šè¯¦ç»†
4. âœ… é”™è¯¯å¤„ç†å®Œå–„ - DecodeWithMemTracking traité—®é¢˜å¿«é€Ÿå®šä½å¹¶ä¿®å¤

**æ³¨æ„äº‹é¡¹**:
1. âš ï¸ FRAME v2.0è¦æ±‚æšä¸¾æ˜¾å¼æ´¾ç”Ÿ`DecodeWithMemTracking`å’Œ`RuntimeDebug`
2. âš ï¸ éœ€è¦è¡¥å……å•å…ƒæµ‹è¯• - éªŒè¯é…ç½®å‚æ•°ã€å®¹é‡é™åˆ¶ã€äº‹ä»¶åŒºåˆ†ç­‰
3. âš ï¸ éœ€è¦ç›‘æ§éƒ¨ç½²åæ•ˆæœ - å…³æ³¨é…ç½®å‚æ•°ä½¿ç”¨ã€å®¹é‡å ç”¨ã€äº‹ä»¶ç»Ÿè®¡
4. âš ï¸ åç»­å¯ç»§ç»­ä¼˜åŒ– - å¦‚æ·»åŠ æ›´å¤šå¤±è´¥åŸå› ã€æ”¯æŒåŠ¨æ€è°ƒæ•´å®¹é‡ç­‰

---

### 8.4 Pç³»åˆ—ä¿®å¤å®Œæˆæ€»ç»“

ç»è¿‡P0ã€P1ã€P2ã€P3å››è½®ä¿®å¤ï¼ŒMemorial palletè®¢é˜…ç³»ç»Ÿå·²å®Œæˆå…¨é¢ä¼˜åŒ–ï¼š

**P0ä¿®å¤** (sacrifice_idé—®é¢˜):
- âœ… ä¿®å¤åˆ†è´¦é€»è¾‘ï¼Œä¼ é€’æ­£ç¡®çš„sacrifice_idå’Œduration_weeks

**P1ä¿®å¤** (ä»·æ ¼é”å®šå’Œå®½é™æœŸ):
- âœ… å®ç°ä»·æ ¼é”å®šæœºåˆ¶ï¼Œä¿è¯è®¢é˜…ä»·æ ¼ç¨³å®š
- âœ… æ·»åŠ 7å¤©å®½é™æœŸï¼Œæå‡ç”¨æˆ·ä½“éªŒ

**P2ä¿®å¤** (é‡è¯•æœºåˆ¶å’Œå†å²è®°å½•):
- âœ… å®ç°72æ¬¡é‡è¯•æœºåˆ¶ï¼ˆçº¦12å°æ—¶ï¼‰ï¼ŒæŒ‡æ•°é€€é¿ç­–ç•¥
- âœ… æ·»åŠ ç»­è´¹å†å²è®°å½•ï¼Œæ”¯æŒå®¡è®¡å’Œæ•°æ®åˆ†æ
- âœ… éªŒè¯è®¢é˜…å‘¨æœŸmin/max_weeksçº¦æŸ

**P3ä¿®å¤** (ä¼˜åŒ–ä¸ç»†åŒ–):
- âœ… ç»­è´¹æ£€æŸ¥é¢‘ç‡å¯é…ç½®ï¼Œçµæ´»é€‚åº”è´Ÿè½½
- âœ… è®¢å•å®¹é‡æå‡10å€ï¼Œæ”¯æŒå¤§è§„æ¨¡è®¢é˜…
- âœ… äº‹ä»¶åŒºåˆ†è®¢é˜…å’Œä¸€æ¬¡æ€§è´­ä¹°ï¼Œå‰ç«¯æ¸…æ™°
- âœ… å¤±è´¥åŸå› ç»“æ„åŒ–ï¼Œä¾¿äºè§£æå’Œç»Ÿè®¡

**æ•´ä½“æ•ˆæœ**:
- âœ… è®¢é˜…ç³»ç»Ÿå®Œæ•´ã€å¥å£®ã€å¯æ‰©å±•
- âœ… ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡
- âœ… æ•°æ®å®Œæ•´æ€§å’Œå®¡è®¡èƒ½åŠ›æå‡
- âœ… ç³»ç»Ÿå¯ç»´æŠ¤æ€§å’Œçµæ´»æ€§æå‡

---

**æ–‡æ¡£ç¼–å†™**: Substrateå¼€å‘å›¢é˜Ÿ

**å®¡æ ¸çŠ¶æ€**: âœ… ä¿®å¤å®Œæˆï¼Œç¼–è¯‘éªŒè¯é€šè¿‡

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0

**ä¸‹ä¸€æ­¥**:
1. ç¼–å†™å•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
2. åœ¨æµ‹è¯•ç½‘éªŒè¯æ‰€æœ‰ä¿®å¤æ•ˆæœ
3. å‡†å¤‡runtimeå‡çº§æ²»ç†ææ¡ˆ
4. ç›‘æ§ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æ•ˆæœ

---

## é™„å½•Aï¼šä¿®æ”¹å‰åå¯¹æ¯”

### å¯¹æ¯”1: ç»­è´¹æ£€æŸ¥é¢‘ç‡

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|-----|--------|--------|
| æ£€æŸ¥é¢‘ç‡ | âœ… ç¡¬ç¼–ç 100å— | âœ… å¯é…ç½®ï¼ˆé»˜è®¤100å—ï¼‰ |
| è°ƒæ•´æ–¹å¼ | âŒ éœ€è¦runtimeå‡çº§ | âœ… é€šè¿‡æ²»ç†ææ¡ˆ |
| ç¯å¢ƒé€‚é… | âŒ æ‰€æœ‰ç¯å¢ƒç›¸åŒ | âœ… å¯é…ç½®ä¸åŒå€¼ |

---

### å¯¹æ¯”2: å•åŒºå—è®¢å•å®¹é‡

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|-----|--------|--------|
| å®¹é‡ä¸Šé™ | 1000è®¢å• | 10000è®¢å• |
| æ‰©å±•æ€§ | ğŸŸ¡ ä¸­ç­‰ | âœ… é«˜ |
| å®¹é‡ç“¶é¢ˆé£é™© | ğŸ”´ è¾ƒé«˜ | ğŸŸ¢ ä½ |

---

### å¯¹æ¯”3: äº‹ä»¶ç³»ç»Ÿ

| äº‹ä»¶ç±»å‹ | ä¿®å¤å‰ | ä¿®å¤å |
|---------|--------|--------|
| è®¢é˜…åˆ›å»º | OfferingCommitted | SubscriptionCreated |
| ä¸€æ¬¡æ€§è´­ä¹° | OfferingCommitted | OfferingCommitted |
| ç»­è´¹å¤±è´¥åŸå›  | Vec<u8>å­—èŠ‚æ•°ç»„ | RenewFailReasonæšä¸¾ |

**å­—æ®µå¯¹æ¯”**:

**SubscriptionCreatedæ–°å¢å­—æ®µ**:
- `weekly_price: u128` - å‘¨ä»·æ ¼
- `auto_renew: bool` - æ˜¯å¦è‡ªåŠ¨ç»­è´¹
- `expiry_block: BlockNumber` - åˆ°æœŸåŒºå—å·

---

### å¯¹æ¯”4: RenewFailReasonç±»å‹

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|-----|--------|--------|
| ç±»å‹ | Vec<u8> | enum (u8) |
| å­˜å‚¨å¤§å° | ~30å­—èŠ‚ | ~1å­—èŠ‚ |
| å‰ç«¯è§£æ | âŒ å­—ç¬¦ä¸²è§£æ | âœ… æšä¸¾åŒ¹é… |
| å›½é™…åŒ– | âŒ å›°éš¾ | âœ… ç®€å• |
| ç»Ÿè®¡åˆ†æ | âŒ å›°éš¾ | âœ… ç®€å• |

---

## é™„å½•Bï¼šæšä¸¾å€¼æ˜ å°„è¡¨

### RenewFailReasonæšä¸¾æ˜ å°„

| æšä¸¾å€¼ | æ•°å­—ç¼–ç  | ä¸­æ–‡è¯´æ˜ | è‹±æ–‡è¯´æ˜ | ä½¿ç”¨åœºæ™¯ |
|-------|---------|---------|---------|---------|
| InsufficientBalance | 0 | ä½™é¢ä¸è¶³ | Insufficient Balance | ç”¨æˆ·è´¦æˆ·ä½™é¢ä¸è¶³ä»¥æ”¯ä»˜ç»­è´¹é‡‘é¢ |
| SacrificeNotAvailable | 1 | å•†å“å·²ä¸‹æ¶ | Sacrifice Not Available | ç¥­ç¥€å“å·²è¢«ç®¡ç†å‘˜ä¸‹æ¶æˆ–åˆ é™¤ |
| PricingNotAvailable | 2 | ä»·æ ¼ä¸å¯ç”¨ | Pricing Not Available | æ— æ³•è·å–å•†å“å½“å‰ä»·æ ¼ |
| TransferFailed | 3 | è½¬è´¦å¤±è´¥ | Transfer Failed | è½¬è´¦æ“ä½œå¤±è´¥ï¼ˆç½‘ç»œæˆ–å…¶ä»–åŸå› ï¼‰ |
| Unknown | 4 | æœªçŸ¥é”™è¯¯ | Unknown Error | å…¶ä»–æœªåˆ†ç±»çš„å¤±è´¥åŸå›  |

**å‰ç«¯ä½¿ç”¨ç¤ºä¾‹**:
```typescript
const RENEW_FAIL_REASON = {
  0: { zh: 'ä½™é¢ä¸è¶³', en: 'Insufficient Balance' },
  1: { zh: 'å•†å“å·²ä¸‹æ¶', en: 'Sacrifice Not Available' },
  2: { zh: 'ä»·æ ¼ä¸å¯ç”¨', en: 'Pricing Not Available' },
  3: { zh: 'è½¬è´¦å¤±è´¥', en: 'Transfer Failed' },
  4: { zh: 'æœªçŸ¥é”™è¯¯', en: 'Unknown Error' },
};

function formatFailReason(reason: number): string {
  return RENEW_FAIL_REASON[reason]?.zh || 'æœªçŸ¥åŸå› ';
}
```

---

## é™„å½•Cï¼šé…ç½®å‚æ•°è¯´æ˜

### MemorialRenewalCheckIntervalå‚æ•°

**ç±»å‹**: `u32`

**é»˜è®¤å€¼**: `100`ï¼ˆçº¦10åˆ†é’Ÿï¼‰

**è¯´æ˜**: ç»­è´¹æ£€æŸ¥é¢‘ç‡ï¼Œè¡¨ç¤ºæ¯éš”å¤šå°‘ä¸ªåŒºå—æ£€æŸ¥ä¸€æ¬¡åˆ°æœŸè®¢å•

**è®¡ç®—å…¬å¼**:
```
æ£€æŸ¥é—´éš”æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰ = RenewalCheckInterval * 6ç§’ / 60
```

**æ¨èå€¼**:
- **å¼€å‘ç¯å¢ƒ**: 10ï¼ˆçº¦1åˆ†é’Ÿï¼‰ - å¿«é€Ÿæµ‹è¯•
- **æµ‹è¯•ç½‘**: 50ï¼ˆçº¦5åˆ†é’Ÿï¼‰ - å¹³è¡¡æµ‹è¯•å’Œæ€§èƒ½
- **ç”Ÿäº§ç½‘**: 100ï¼ˆçº¦10åˆ†é’Ÿï¼‰ - å¹³è¡¡æ€§èƒ½å’ŒåŠæ—¶æ€§
- **é«˜è´Ÿè½½**: 200ï¼ˆçº¦20åˆ†é’Ÿï¼‰ - é™ä½é“¾ä¸Šè´Ÿè½½

**ä¿®æ”¹æ–¹å¼**:
é€šè¿‡æ²»ç†ææ¡ˆä¿®æ”¹runtimeé…ç½®ï¼š
```rust
parameter_types! {
    pub const MemorialRenewalCheckInterval: u32 = 200; // ä¿®æ”¹ä¸º200
}
```

**æ³¨æ„äº‹é¡¹**:
- âš ï¸ å€¼è¶Šå°ï¼Œæ£€æŸ¥è¶Šé¢‘ç¹ï¼Œé“¾ä¸Šè´Ÿè½½è¶Šé«˜
- âš ï¸ å€¼è¶Šå¤§ï¼Œåˆ°æœŸè®¢å•å¤„ç†å»¶è¿Ÿè¶Šé•¿
- âš ï¸ å»ºè®®æ ¹æ®å®é™…è®¢å•é‡å’Œé“¾ä¸Šè´Ÿè½½åŠ¨æ€è°ƒæ•´

---

**END OF REPORT**
