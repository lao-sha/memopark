# 委员会提案使用指南

## 概述

委员会提案流程用于做市商审批等需要集体决策的治理操作。委员会成员通过提案、投票、执行三个步骤完成治理决策。

## 页面路径

### 主要页面
1. **委员会提案管理**: `#/gov/council-proposals`
   - 提案列表：查看所有活跃提案
   - 提交提案：创建新的批准/驳回提案
   - 我的投票：查看个人投票记录

2. **做市商审核**: `#/gov/mm-review`
   - 待审核列表：查看所有待审核的做市商申请
   - 已批准列表：查看已批准的做市商
   - 链接到委员会提案管理

## 完整流程

### 第一步：提交提案（任一委员会成员）

1. 访问 `#/gov/council-proposals` 页面
2. 切换到 **"提交提案"** 标签
3. 填写提案信息：
   - **提案类型**: 选择"批准做市商申请"或"驳回做市商申请"
   - **申请编号**: 从下拉列表选择待审核的申请（自动从链上加载）
   - **扣罚比例**: 如果选择驳回，设置扣罚比例（0-10000 bps，100 bps = 1%）
   - **投票阈值**: 设置通过所需票数（推荐：委员会总人数的 2/3，例如 3 人委员会设置为 2）
4. 点击 **"提交提案"** 按钮
5. 签名确认交易
6. 提案提交成功后，会显示**提案哈希**，复制保存以便分享给其他委员会成员

**示例**：
```typescript
// 批准做市商 #5 的提案
提案类型: 批准做市商申请
申请编号: #5
投票阈值: 2 票

// 提案哈希（示例）
0x1234567890abcdef...
```

### 第二步：成员投票（其他委员会成员）

1. 访问 `#/gov/council-proposals` 页面
2. 在 **"提案列表"** 标签中查看所有活跃提案
3. 找到需要投票的提案（可通过提案哈希或调用内容识别）
4. 查看提案详情：
   - 调用内容（批准/驳回哪个做市商）
   - 当前投票进度（赞成票/反对票/阈值）
   - 提案哈希
5. 点击 **"赞成"** 或 **"反对"** 按钮
6. 确认投票
7. 签名交易
8. 投票成功后，提案列表会更新投票进度

**注意事项**：
- 每个委员会成员每个提案只能投票一次
- 投票后会显示"已投赞成"或"已投反对"标签
- 可以在"我的投票"标签查看个人所有投票记录

### 第三步：执行提案（任何人）

1. 当提案达到投票阈值（赞成票 ≥ 阈值）后，提案会显示 **"可执行"** 标签
2. 点击 **"执行提案"** 按钮
3. 确认执行
4. 签名交易
5. 提案执行成功后，相应的做市商申请会被批准或驳回
6. 提案从活跃列表中移除

**说明**：
- 任何人都可以执行已达阈值的提案，不限于委员会成员
- 执行提案会调用 `council.close` 方法，链上自动判断是否达到阈值
- 执行成功后，市场做市商的 `approve` 或 `reject` 函数会被自动调用

## 页面功能说明

### 1. 提案列表页面

**显示内容**：
- 提案编号
- 调用类型（批准/驳回做市商）
- 提案哈希（可复制）
- 投票进度条
- 赞成票数 / 反对票数 / 阈值
- 当前用户投票状态

**操作按钮**：
- **赞成** / **反对**：对提案投票（未投票时显示）
- **执行提案**：达到阈值后可执行（显示紫色按钮）
- **查看详情**：查看完整提案信息
- **刷新提案列表**：重新从链上加载

### 2. 提交提案页面

**功能**：
- 自动加载待审核的做市商申请列表
- 智能表单验证
- 自动计算提案参数（length）
- 提交后显示提案哈希供分享

**字段说明**：
- **提案类型**: 
  - 批准做市商申请：调用 `marketMaker.approve(mmId)`
  - 驳回做市商申请：调用 `marketMaker.reject(mmId, slashBps)`
- **申请编号**: 自动从链上查询所有 `PendingReview` 状态的申请
- **扣罚比例**: 驳回时扣除的押金比例
  - 范围：0-10000 bps（100 bps = 1%）
  - 例如：1000 bps = 扣除 10% 押金
- **投票阈值**: 通过提案需要的最少赞成票数
  - 推荐设置为委员会总人数的 2/3
  - 例如：3 人委员会 → 设置为 2 票

### 3. 我的投票页面

**显示内容**：
- 投票统计：总投票数、赞成票数、反对票数
- 投票记录列表：
  - 提案编号
  - 调用内容
  - 我的投票（赞成/反对）
  - 当前进度
  - 是否已达阈值
  - 提案哈希

## 技术细节

### 链上调用流程

```typescript
// 1. 提交提案
const approveCall = api.tx.marketMaker.approve(mmId)
await api.tx.council.propose(
  threshold,        // 投票阈值
  approveCall,      // 内部调用
  approveCall.length // 调用长度
).signAndSend(councilMember)

// 2. 投票
const proposalHash = approveCall.method.hash.toHex()
await api.tx.council.vote(
  proposalHash,  // 提案哈希
  proposalIndex, // 提案索引
  true           // true=赞成, false=反对
).signAndSend(councilMember)

// 3. 执行
await api.tx.council.close(
  proposalHash,
  proposalIndex,
  { refTime: 1_000_000_000, proofSize: 1000 }, // weight bound
  1000 // length bound
).signAndSend(anyone)
```

### 权限说明

- **提交提案**: 仅委员会成员
- **投票**: 仅委员会成员
- **执行提案**: 任何人（前提：已达到投票阈值）
- **查看提案**: 任何人

### 数据来源

- 所有数据直接从链上查询（全局链上直连模式）
- 提案列表：`council.proposals()` + `council.voting(hash)` + `council.proposalOf(hash)`
- 待审申请：`marketMaker.applications(id)` 遍历查询
- 投票记录：遍历所有提案，检查当前用户是否在 `ayes` 或 `nays` 列表

## Root 直接批准（紧急通道）

如果需要紧急批准/驳回，Root（Sudo）账户可以直接调用：

```typescript
// Sudo 直接批准
await api.tx.sudo.sudo(
  api.tx.marketMaker.approve(mmId)
).signAndSend(sudoAccount)

// Sudo 直接驳回
await api.tx.sudo.sudo(
  api.tx.marketMaker.reject(mmId, slashBps)
).signAndSend(sudoAccount)
```

**注意**：Root 通道绕过委员会投票，应仅在紧急情况下使用。

## 常见问题

### Q1: 提交提案时提示 "BadOrigin" 错误
**A**: 当前账户不是委员会成员。检查链上委员会成员配置：
```typescript
const members = await api.query.council.members()
console.log('委员会成员:', members.toJSON())
```

### Q2: 投票后提案列表没有立即更新
**A**: 投票交易需要等待区块确认（约 6 秒）。点击"刷新提案列表"按钮重新加载。

### Q3: 执行提案时提示 "TooEarly" 错误
**A**: 提案尚未达到投票阈值或投票期未结束。检查赞成票数是否 ≥ 阈值。

### Q4: 如何查看提案执行结果
**A**: 
1. 执行提案后，查看交易事件：`council.Executed`
2. 访问 `#/gov/mm-review` 页面，刷新查看申请状态是否变为 `Active` 或 `Rejected`

### Q5: 委员会成员如何配置
**A**: 使用 Root 账户调用：
```typescript
await api.tx.sudo.sudo(
  api.tx.council.setMembers(
    [member1, member2, member3], // 新成员列表
    null,                        // prime 成员（可选）
    oldCount                     // 旧成员数量（用于权重计算）
  )
).signAndSend(sudoAccount)
```

## 页面导航

### 从个人资料页访问
`#/profile` → **做市商与OTC交易** 卡片：
- **审核做市商** → 跳转到 `#/gov/mm-review`
- **委员会提案** → 跳转到 `#/gov/council-proposals`

### 从做市商审核页访问
`#/gov/mm-review` → 治理说明 → **委员会提案管理** 链接

## 组件列表

### 页面组件
- `CouncilProposalPage.tsx` - 委员会提案管理主页面
- `GovMarketMakerReviewPage.tsx` - 做市商审核页面

### 子组件
- `CreateProposalForm.tsx` - 提交提案表单
- `ProposalList.tsx` - 提案列表（含投票和执行功能）
- `MyVotes.tsx` - 我的投票记录

### 位置
所有组件位于 `memopark-dapp/src/features/` 目录：
```
features/
├── governance/
│   ├── CouncilProposalPage.tsx
│   └── components/
│       ├── CreateProposalForm.tsx
│       ├── ProposalList.tsx
│       └── MyVotes.tsx
└── otc/
    └── GovMarketMakerReviewPage.tsx
```

## 使用示例

### 场景：批准做市商申请

1. **Alice（委员会成员）提交提案**：
   ```
   访问 #/gov/council-proposals → 提交提案
   类型: 批准做市商申请
   申请编号: #5
   阈值: 2 票
   → 提交 → 获得提案哈希: 0xabcd1234...
   ```

2. **Bob（委员会成员）投赞成票**：
   ```
   访问 #/gov/council-proposals → 提案列表
   找到提案 #0 (批准做市商 #5)
   当前进度: 0/2
   → 点击"赞成" → 确认
   进度更新: 1/2
   ```

3. **Charlie（委员会成员）投赞成票**：
   ```
   访问 #/gov/council-proposals → 提案列表
   找到提案 #0 (批准做市商 #5)
   当前进度: 1/2
   → 点击"赞成" → 确认
   进度更新: 2/2 ✓ 已达阈值
   ```

4. **任何人执行提案**：
   ```
   访问 #/gov/council-proposals → 提案列表
   提案 #0 显示"可执行"标签
   → 点击"执行提案" → 确认
   → 做市商 #5 被批准，状态变为 Active
   ```

5. **验证结果**：
   ```
   访问 #/gov/mm-review → 已审核标签
   → 看到做市商 #5 在列表中，状态为 Active
   ```

## 移动端优化

所有页面均采用移动端优先设计：
- 最大宽度：640px 居中显示
- 按钮使用 `block` 布局，适配小屏幕
- 使用 Ant Design 响应式组件（Card、List、Space）
- 提案哈希可复制，支持长按选择

## 安全注意事项

1. **委员会成员管理**：
   - 定期审查委员会成员列表
   - 移除不活跃或不可信成员
   - 保持奇数成员，避免平票

2. **投票阈值设置**：
   - 推荐：总成员的 2/3
   - 避免设置过低（如 1 票），失去集体决策意义
   - 避免设置过高，导致提案难以通过

3. **提案审查**：
   - 投票前仔细核对提案内容
   - 检查申请编号是否正确
   - 驳回时合理设置扣罚比例

4. **紧急通道**：
   - Root 直接批准仅用于紧急情况
   - 所有 Root 操作应记录并定期审计
   - 长期目标：移除 Root 权限，完全由委员会治理

## 后续优化方向

1. **通知系统**：
   - 新提案通知
   - 投票达到阈值通知
   - 提案执行结果通知

2. **批量操作**：
   - 批量批准多个申请
   - 批量投票

3. **历史记录**：
   - 已执行提案历史
   - 委员会成员投票统计
   - 做市商批准/驳回历史

4. **集成 Subsquid**：
   - 索引提案数据，避免遍历查询
   - 提供高级搜索和筛选
   - 实时事件推送

## 相关文档

- [市场做市商治理机制](../pallets/market-maker/README.md)
- [委员会 Pallet 文档](../pallets/collective/README.md)
- [全局链上直连模式说明](./全局链上直连模式说明.md)

---

**最后更新**: 2025-10-02  
**适用版本**: memopark v0.1.0

