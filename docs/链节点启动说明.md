# 链节点启动说明（--tmp 模式）

## ✅ 修改完成

`start-node.sh` 已更新为 **--tmp 前台模式**，解决 WASM 实例耗尽和数据库损坏问题。

## 🚀 使用方式

### 启动节点

```bash
cd /home/xiaodong/文档/memopark
./start-node.sh
```

**特点**：
- ✅ 实时显示日志（不需要 `tail -f`）
- ✅ 使用 `--tmp` 模式（每次启动清空数据）
- ✅ 优化的 WASM 和连接配置
- ✅ Ctrl+C 停止节点

### 停止节点

**方式 1**：在运行终端按 `Ctrl+C`

**方式 2**：在另一个终端执行
```bash
pkill -9 memopark-node
```

## 📋 配置参数说明

```bash
--dev                      # 开发模式（单节点）
--tmp                      # 临时模式（重启清空数据，避免数据库损坏）
--rpc-external             # 允许外部访问
--rpc-port 9944           # RPC 端口
--rpc-cors=all            # 允许所有跨域请求（开发环境）
--rpc-max-connections 200 # 最大连接数 200
--rpc-max-request-size 15 # 请求大小限制 15MB
--rpc-max-response-size 15 # 响应大小限制 15MB
--wasm-execution compiled  # 编译模式（避免 WASM 实例耗尽）
--runtime-cache-size 8     # Runtime 缓存大小 8
```

## 🔧 为什么使用 --tmp 模式？

**问题**：
- 数据库可能损坏（GRANDPA voter error）
- WASM 实例池耗尽
- 连接数超限

**--tmp 的优点**：
- ✅ 每次启动清空数据库，避免损坏
- ✅ 开发测试更方便（不积累脏数据）
- ✅ 启动更快
- ✅ 资源占用更少

**--tmp 的缺点**：
- ❌ 重启后链上数据清空（测试数据丢失）
- ❌ 不适合生产环境

**开发环境推荐**：使用 --tmp
**生产环境推荐**：使用 --base-path（持久化数据）

## 🎯 测试连接

### 1. Polkadot.js Apps

1. **访问**：https://polkadot.js.org/apps
2. **点击左上角网络选择器**
3. **选择"Development" → "Local Node"**
4. **或手动输入**：`ws://127.0.0.1:9944`
5. **点击"Switch"**

**预期结果**：
- ✅ 左上角显示"本地节点"
- ✅ 显示区块高度
- ✅ 可以查看 Chain state

### 2. 前端 DApp

```bash
cd /home/xiaodong/文档/memopark/memopark-dapp
npm run dev
```

访问：`http://127.0.0.1:5173`

**预期结果**：
- ✅ 不再显示"API 连接失败"
- ✅ 可以查看余额
- ✅ 可以提交交易

### 3. 命令行测试

```bash
# 测试 HTTP RPC
curl -H "Content-Type: application/json" \
  -d '{"id":1,"jsonrpc":"2.0","method":"system_health"}' \
  http://127.0.0.1:9944

# 预期输出：
# {"jsonrpc":"2.0","result":{"peers":0,"isSyncing":false,"shouldHavePeers":false},"id":1}
```

## 📊 日志说明

### 正常日志

```
✓ 链节点启动成功
Running JSON-RPC server: addr=0.0.0.0:9944
🏆 Imported #1
💤 Idle (0 peers), best: #1
```

### 异常日志

```
❌ Ran out of free WASM instances
❌ Database error: IO error
❌ Too many connections
```

**如果看到异常日志**：
1. Ctrl+C 停止节点
2. 等待 3 秒
3. 重新运行 `./start-node.sh`

## 🔄 重启流程

每次修改 runtime 或遇到问题时：

```bash
# 1. 停止节点（在运行终端按 Ctrl+C）

# 2. 等待 2-3 秒

# 3. 重新启动
./start-node.sh
```

## 🆘 故障排查

### 问题 1：端口已被占用

**错误**：`Address already in use`

**解决**：
```bash
pkill -9 memopark-node
sleep 3
./start-node.sh
```

### 问题 2：仍然报 WASM 实例耗尽

**原因**：可能是编译版本问题或系统资源不足

**解决方案 A**：增加系统资源限制
```bash
ulimit -n 65536
ulimit -s unlimited
./start-node.sh
```

**解决方案 B**：重新编译（使用 release 优化）
```bash
cargo clean
cargo build --release
./start-node.sh
```

**解决方案 C**：使用更简化的参数
```bash
./target/release/memopark-node --dev --tmp
```

### 问题 3：Polkadot.js Apps 连不上

**检查清单**：
- [ ] 节点是否运行？`ps aux | grep memopark-node`
- [ ] 端口是否监听？`netstat -tln | grep 9944`
- [ ] 日志是否有错误？查看终端输出
- [ ] 浏览器控制台是否有错误？F12 查看

**常见原因**：
1. 节点未启动或启动失败
2. CORS 配置问题（已配置 `--rpc-cors=all`）
3. 防火墙阻止
4. 浏览器扩展干扰

## 📝 开发工作流

### 日常开发

**终端 1**：运行链节点
```bash
cd /home/xiaodong/文档/memopark
./start-node.sh
# 保持运行，查看日志
```

**终端 2**：运行前端
```bash
cd /home/xiaodong/文档/memopark/memopark-dapp
npm run dev
```

**浏览器**：访问 `http://127.0.0.1:5173`

### 重新编译后

```bash
# 终端 1：停止节点（Ctrl+C）

# 重新编译
cargo build --release

# 重启节点
./start-node.sh
```

## ⚠️ 注意事项

1. **--tmp 模式会清空数据**
   - 每次重启，所有链上数据（墓地、做市商申请等）都会清空
   - 需要重新创建测试数据
   - 适合开发，不适合生产

2. **前台运行意味着**
   - 必须保持终端窗口打开
   - 关闭终端或 Ctrl+C 会停止节点
   - 适合开发调试

3. **生产环境应该**
   - 使用 `--base-path`（持久化数据）
   - 使用 `nohup` 或 `systemd`（后台运行）
   - 配置日志轮转

## 📚 相关文档

- **防止连接超限**：`docs/防止WebSocket连接超限.md`
- **委员会提案 UI**：`docs/委员会提案UI快速开始.md`
- **签名错误排查**：`docs/签名错误排查指南.md`

---

**现在执行**：
```bash
cd /home/xiaodong/文档/memopark
./start-node.sh
```

应该可以看到节点日志实时输出，不再报 WASM 错误，Polkadot.js Apps 和前端都能正常连接！
