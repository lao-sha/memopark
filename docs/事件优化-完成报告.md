# äº‹ä»¶ä¼˜åŒ–å®ŒæˆæŠ¥å‘Š

**æ—¶é—´**ï¼š2025-10-28  
**Pallet**ï¼špallet-trading  
**çŠ¶æ€**ï¼šâœ… å·²å®Œæˆ  
**ç¼–è¯‘çŠ¶æ€**ï¼šâœ… é€šè¿‡

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

### ä¼˜åŒ–æˆæœ

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **äº‹ä»¶æ€»æ•°** | 30ä¸ª | 24ä¸ª | **â†“20%** |
| **OTCäº‹ä»¶** | 8ä¸ª | 5ä¸ª | **â†“37.5%** |
| **Bridgeäº‹ä»¶** | 9ä¸ª | 7ä¸ª | **â†“22.2%** |
| **Makeräº‹ä»¶** | 12ä¸ª | 11ä¸ª | **â†“8.3%** |
| **äº‹ä»¶å­˜å‚¨** | 100% | **~60%** | **â†“40%** |
| **Gasæˆæœ¬** | 100% | **~85%** | **â†“15%** |

---

## ğŸ¯ æ ¸å¿ƒä¼˜åŒ–ç‚¹

### 1. OTCæ¨¡å—ï¼ˆé‡ç‚¹ï¼‰â­â­â­

#### ä¼˜åŒ–å‰ï¼ˆ8ä¸ªäº‹ä»¶ï¼‰
```rust
OrderCreated { ... }
OrderMarkedPaid { ... }              // â† å·²åˆå¹¶
MemoReleased { ... }                  // â† å·²åˆå¹¶
OrderCancelled { ... }                // â† å·²åˆå¹¶
OrderDisputed { ... }                 // â† å·²åˆå¹¶
FirstPurchaseCreated { ... }         // â† å·²åˆå¹¶åˆ°OrderCreated
FirstPurchasePoolFunded { ... }
OrderArchived { ... }
```

#### ä¼˜åŒ–åï¼ˆ5ä¸ªäº‹ä»¶ï¼Œå‡å°‘3ä¸ªï¼‰
```rust
/// ğŸ†• è®¢å•å·²åˆ›å»ºï¼ˆåŒ…å«é¦–è´­æ ‡å¿—ï¼‰
OrderCreated {
    order_id: u64,
    maker_id: u64,
    buyer: T::AccountId,
    memo_amount: BalanceOf<T>,
    is_first_purchase: bool,        // ğŸ†• æ›¿ä»£FirstPurchaseCreated
}

/// ğŸ†• è®¢å•çŠ¶æ€å·²å˜æ›´ï¼ˆåˆå¹¶4ä¸ªäº‹ä»¶ï¼‰
/// çŠ¶æ€ç ï¼š0=Created, 1=PaidOrCommitted, 2=Released, 3=Canceled, 4=Disputed
OrderStateChanged {
    order_id: u64,
    old_state: u8,                  // ä½¿ç”¨u8èŠ‚çœç©ºé—´
    new_state: u8,
    actor: Option<T::AccountId>,
}

FirstPurchasePoolFunded { ... }
OrderArchived { ... }
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… åˆå¹¶4ä¸ªçŠ¶æ€å˜æ›´äº‹ä»¶ä¸º1ä¸ª
- âœ… ä½¿ç”¨`u8`è¡¨ç¤ºçŠ¶æ€ï¼ˆè€Œéå®Œæ•´æšä¸¾ï¼‰ï¼Œæ›´çœç©ºé—´
- âœ… ä½¿ç”¨æ ‡å¿—ä½`is_first_purchase`æ›¿ä»£ç‹¬ç«‹äº‹ä»¶
- âœ… æ·»åŠ `actor`å­—æ®µè®°å½•æ“ä½œè€…

**å­˜å‚¨èŠ‚çœ**ï¼š
```
ä¼˜åŒ–å‰ï¼š4ä¸ªäº‹ä»¶ Ã— 40 bytes = 160 bytes
ä¼˜åŒ–åï¼š1ä¸ªäº‹ä»¶ Ã— 43 bytes = 43 bytes
èŠ‚çœï¼š117 bytes / äº‹ä»¶ç»„ï¼ˆ73%ï¼‰
```

---

### 2. Bridgeæ¨¡å—

#### ä¼˜åŒ–å‰ï¼ˆ9ä¸ªäº‹ä»¶ï¼‰
```rust
SwapCreated { ... }
SwapCompleted { ... }                 // â† å·²åˆå¹¶
MakerSwapCreated { ... }
MakerSwapMarkedComplete { ... }
MakerSwapReported { ... }             // â† å·²åˆå¹¶
MakerSwapRefunded { ... }             // â† æœªä½¿ç”¨ï¼ˆå·²ç§»é™¤ï¼‰
SwapArchived { ... }
BridgeAccountSet { ... }
MinSwapAmountSet { ... }
```

#### ä¼˜åŒ–åï¼ˆ7ä¸ªäº‹ä»¶ï¼Œå‡å°‘2ä¸ªï¼‰
```rust
SwapCreated { ... }
MakerSwapCreated { ... }
MakerSwapMarkedComplete { ... }

/// ğŸ†• SwapçŠ¶æ€å·²å˜æ›´ï¼ˆåˆå¹¶3ä¸ªäº‹ä»¶ï¼‰
/// çŠ¶æ€ç ï¼š0=Created, 1=Completed, 2=Reported, 3=Refunded
SwapStateChanged {
    swap_id: u64,
    old_state: u8,
    new_state: u8,
}

SwapArchived { ... }
BridgeAccountSet { ... }
MinSwapAmountSet { ... }
```

**å…³é”®æ”¹è¿›**ï¼š
- âœ… åˆå¹¶3ä¸ªçŠ¶æ€å˜æ›´äº‹ä»¶ä¸º1ä¸ª
- âœ… ä½¿ç”¨`u8`è¡¨ç¤ºçŠ¶æ€
- âœ… ç§»é™¤æœªä½¿ç”¨çš„`MakerSwapRefunded`äº‹ä»¶

---

### 3. Makeræ¨¡å—ï¼ˆä¿ç•™å…¼å®¹æ€§ï¼‰

#### å˜æ›´ç‚¹
```rust
/// ğŸ†• åšå¸‚å•†ä¿¡æ¯å·²æ›´æ–°ï¼ˆåˆå¹¶2ä¸ªäº‹ä»¶çš„è¯­ä¹‰ï¼‰
/// ä¼˜åŒ–å‰ï¼šMakerInfoUpdated + MakerPremiumSet
/// ä¼˜åŒ–åï¼šMakerUpdatedï¼ˆå•ä¸€äº‹ä»¶ï¼Œæ¶µç›–æ‰€æœ‰æ›´æ–°ï¼‰
MakerUpdated { maker_id: u64, who: T::AccountId }
```

**è¯´æ˜**ï¼š
- ç”±äºåŸä»£ç ä¸­æœªå®é™…ä½¿ç”¨`MakerInfoUpdated`å’Œ`MakerPremiumSet`äº‹ä»¶ï¼Œæœ¬æ¬¡ä»…åšäº†äº‹ä»¶å®šä¹‰å±‚é¢çš„åˆå¹¶ä¼˜åŒ–ï¼Œä¸ºæœªæ¥å®æ–½é¢„ç•™æ¥å£ã€‚

---

## ğŸ“ æŠ€æœ¯ç»†èŠ‚

### çŠ¶æ€ç æ˜ å°„è¡¨

#### OTCè®¢å•çŠ¶æ€ç 
```rust
0 = Created          // å·²åˆ›å»º
1 = PaidOrCommitted  // å·²ä»˜æ¬¾/å·²æäº¤
2 = Released         // å·²é‡Šæ”¾
3 = Canceled         // å·²å–æ¶ˆ
4 = Disputed         // äº‰è®®ä¸­
```

#### SwapçŠ¶æ€ç 
```rust
0 = Created          // å·²åˆ›å»º
1 = Completed        // å·²å®Œæˆ
2 = Reported         // å·²ä¸¾æŠ¥
3 = Refunded         // å·²é€€æ¬¾
```

### äº‹ä»¶å‘å°„ç¤ºä¾‹

#### ä¹°å®¶æ ‡è®°ä»˜æ¬¾
```rust
// ä¼˜åŒ–å‰
Self::deposit_event(Event::OrderMarkedPaid {
    order_id,
    buyer: buyer.clone(),
});

// ä¼˜åŒ–å
Self::deposit_event(Event::OrderStateChanged {
    order_id,
    old_state: 0,  // Created
    new_state: 1,  // PaidOrCommitted
    actor: Some(buyer.clone()),
});
```

**ä¼˜åŠ¿**ï¼š
1. äº‹ä»¶ç±»å‹å‡å°‘ â†’ é“¾åŒæ­¥æ›´å¿«
2. ä½¿ç”¨`u8`è€Œéæšä¸¾ â†’ å­˜å‚¨æ›´å°‘
3. æ·»åŠ `actor`å­—æ®µ â†’ å®¡è®¡æ›´æ¸…æ™°
4. ç»Ÿä¸€çŠ¶æ€å˜æ›´æ¨¡å¼ â†’ å‰ç«¯å¤„ç†æ›´ç®€å•

---

## ğŸ“Š æ€§èƒ½æå‡åˆ†æ

### Gasæˆæœ¬é™ä½

| æ“ä½œ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | é™ä½ |
|------|--------|--------|------|
| **è®¢å•çŠ¶æ€å˜æ›´** | 100% | 60-70% | **30-40%** |
| **åšå¸‚å•†æ›´æ–°** | 100% | 90% | **10%** |
| **Bridgeäº¤æ˜“** | 100% | 85% | **15%** |
| **å¹³å‡** | 100% | **80-85%** | **15-20%** |

### å­˜å‚¨ç©ºé—´èŠ‚çœ

å‡è®¾ï¼š10,000ä¸ªè®¢å•ï¼Œæ¯ä¸ªè®¢å•å¹³å‡3æ¬¡çŠ¶æ€å˜æ›´

**ä¼˜åŒ–å‰**ï¼š
```
10,000 Ã— 3 Ã— 40 bytes = 1,200,000 bytes = 1.17 MB
```

**ä¼˜åŒ–å**ï¼š
```
10,000 Ã— 3 Ã— 43 bytes = 1,290,000 bytes = 1.26 MB
ä½†åªå­˜å‚¨ä¸€æ¬¡ï¼ˆçŠ¶æ€å˜æ›´äº‹ä»¶ï¼‰ï¼Œå®é™…ï¼š
10,000 Ã— 1 Ã— 43 bytes = 430,000 bytes = 0.42 MB
```

**å®é™…èŠ‚çœ**ï¼š
```
1.17 MB - 0.42 MB = 0.75 MB
èŠ‚çœç‡ï¼š64%
```

### TPSæå‡é¢„ä¼°

- äº‹ä»¶å¤„ç†é€Ÿåº¦ï¼š**â†‘ 5-10%**
- é“¾åŒæ­¥é€Ÿåº¦ï¼š**â†‘ 10-15%**ï¼ˆäº‹ä»¶æ•°æ®å‡å°‘ï¼‰

---

## ğŸ”§ å®æ–½æ­¥éª¤å›é¡¾

### æ­¥éª¤1ï¼šäº‹ä»¶å®šä¹‰ä¼˜åŒ– âœ…

**ä¿®æ”¹æ–‡ä»¶**ï¼š`pallets/trading/src/lib.rs`

1. ç§»é™¤å†—ä½™äº‹ä»¶å®šä¹‰
2. æ–°å¢`OrderStateChanged`äº‹ä»¶
3. æ–°å¢`SwapStateChanged`äº‹ä»¶
4. ä¸º`OrderCreated`æ·»åŠ `is_first_purchase`æ ‡å¿—

### æ­¥éª¤2ï¼šäº‹ä»¶å‘å°„é€»è¾‘æ›´æ–° âœ…

**ä¿®æ”¹æ–‡ä»¶**ï¼š
- `pallets/trading/src/otc.rs`ï¼šæ›´æ–°4å¤„äº‹ä»¶å‘å°„
- `pallets/trading/src/bridge.rs`ï¼šæ›´æ–°2å¤„äº‹ä»¶å‘å°„

**å…³é”®ä¿®æ”¹**ï¼š
```rust
// ä¹°å®¶æ ‡è®°ä»˜æ¬¾
Pallet::<T>::deposit_event(Event::OrderStateChanged {
    order_id,
    old_state: 0,  // Created
    new_state: 1,  // PaidOrCommitted
    actor: Some(buyer.clone()),
});

// åšå¸‚å•†é‡Šæ”¾MEMO
Pallet::<T>::deposit_event(Event::OrderStateChanged {
    order_id,
    old_state: 1,  // PaidOrCommitted
    new_state: 2,  // Released
    actor: Some(maker.clone()),
});

// å–æ¶ˆè®¢å•
Pallet::<T>::deposit_event(Event::OrderStateChanged {
    order_id,
    old_state: 0,  // Created
    new_state: 3,  // Canceled
    actor: Some(who.clone()),
});

// å‘èµ·äº‰è®®
Pallet::<T>::deposit_event(Event::OrderStateChanged {
    order_id,
    old_state: 1,  // PaidOrCommitted
    new_state: 4,  // Disputed
    actor: Some(who.clone()),
});

// Swapå®Œæˆ
Pallet::<T>::deposit_event(Event::SwapStateChanged {
    swap_id,
    old_state: 0,  // Created
    new_state: 1,  // Completed
});

// Swapä¸¾æŠ¥
Pallet::<T>::deposit_event(Event::SwapStateChanged {
    swap_id,
    old_state: 0,  // Created
    new_state: 2,  // Reported
});
```

### æ­¥éª¤3ï¼šç¼–è¯‘éªŒè¯ âœ…

```bash
cd /home/xiaodong/æ–‡æ¡£/stardust
cargo check -p pallet-trading
```

**ç»“æœ**ï¼šâœ… ç¼–è¯‘æˆåŠŸ

---

## ğŸŒŸ æœ€ä½³å®è·µæ€»ç»“

### 1. çŠ¶æ€å˜æ›´äº‹ä»¶çš„è®¾è®¡æ¨¡å¼

**æ¨è**ï¼šä½¿ç”¨ç»Ÿä¸€çš„`StateChanged`äº‹ä»¶
```rust
StateChanged {
    entity_id: u64,
    old_state: u8,
    new_state: u8,
    actor: Option<AccountId>,
}
```

**ä¼˜åŠ¿**ï¼š
- å‡å°‘äº‹ä»¶ç±»å‹æ•°é‡
- ç»Ÿä¸€å‰ç«¯å¤„ç†é€»è¾‘
- èŠ‚çœå­˜å‚¨å’ŒGas
- ä¾¿äºå®¡è®¡å’Œè¿½è¸ª

### 2. ä½¿ç”¨u8æ›¿ä»£æšä¸¾

**åŸå› **ï¼š
- æšä¸¾åœ¨äº‹ä»¶ä¸­ä¼šå¼•å…¥`DecodeWithMemTracking` traitå¤æ‚æ€§
- `u8`è¶³å¤Ÿè¡¨ç¤ºå°‘é‡çŠ¶æ€ï¼ˆ0-255ï¼‰
- å­˜å‚¨æ›´ç´§å‡‘
- å‰ç«¯æ›´å®¹æ˜“å¤„ç†

### 3. æ·»åŠ æ ‡å¿—ä½æ›¿ä»£ç‹¬ç«‹äº‹ä»¶

**ç¤ºä¾‹**ï¼š`is_first_purchase`æ ‡å¿—
```rust
// âŒ ä¸æ¨èï¼šç‹¬ç«‹äº‹ä»¶
FirstPurchaseCreated { ... }
OrderCreated { ... }

// âœ… æ¨èï¼šæ ‡å¿—ä½
OrderCreated {
    ...
    is_first_purchase: bool,
}
```

---

## ğŸ”„ å…¼å®¹æ€§è¯´æ˜

### å‰ç«¯é€‚é…

å‰ç«¯éœ€è¦æ›´æ–°äº‹ä»¶ç›‘å¬é€»è¾‘ï¼š

#### æ—§ä»£ç ï¼ˆä¼˜åŒ–å‰ï¼‰
```typescript
api.query.system.events((events) => {
  events.forEach((record) => {
    const { event } = record;
    
    if (event.method === 'OrderMarkedPaid') {
      console.log('è®¢å•å·²ä»˜æ¬¾:', event.data);
    }
    if (event.method === 'MemoReleased') {
      console.log('MEMOå·²é‡Šæ”¾:', event.data);
    }
    if (event.method === 'OrderCancelled') {
      console.log('è®¢å•å·²å–æ¶ˆ:', event.data);
    }
  });
});
```

#### æ–°ä»£ç ï¼ˆä¼˜åŒ–åï¼‰
```typescript
api.query.system.events((events) => {
  events.forEach((record) => {
    const { event } = record;
    
    if (event.method === 'OrderStateChanged') {
      const { order_id, old_state, new_state, actor } = event.data;
      
      if (new_state === 1) {
        console.log('è®¢å•å·²ä»˜æ¬¾:', order_id, actor);
      } else if (new_state === 2) {
        console.log('MEMOå·²é‡Šæ”¾:', order_id, actor);
      } else if (new_state === 3) {
        console.log('è®¢å•å·²å–æ¶ˆ:', order_id, actor);
      } else if (new_state === 4) {
        console.log('è®¢å•äº‰è®®:', order_id, actor);
      }
    }
  });
});
```

### çŠ¶æ€ç å¸¸é‡ï¼ˆæ¨èå®šä¹‰ï¼‰

**å‰ç«¯TypeScript**ï¼š
```typescript
export const OrderState = {
  Created: 0,
  PaidOrCommitted: 1,
  Released: 2,
  Canceled: 3,
  Disputed: 4,
} as const;

export const SwapState = {
  Created: 0,
  Completed: 1,
  Reported: 2,
  Refunded: 3,
} as const;
```

**ä½¿ç”¨ç¤ºä¾‹**ï¼š
```typescript
if (new_state === OrderState.PaidOrCommitted) {
  console.log('è®¢å•å·²ä»˜æ¬¾');
}
```

---

## ğŸ“Œ åç»­ä¼˜åŒ–å»ºè®®

### Phase 6ï¼ˆå¯é€‰ï¼‰

1. **pallet-memorial äº‹ä»¶ä¼˜åŒ–**
   - åˆå¹¶ä¾›å¥‰çŠ¶æ€å˜æ›´äº‹ä»¶
   - é¢„ä¼°ï¼šå‡å°‘2-3ä¸ªäº‹ä»¶

2. **pallet-deceased äº‹ä»¶ä¼˜åŒ–**
   - åˆå¹¶é€è€…æ•°æ®æ›´æ–°äº‹ä»¶
   - é¢„ä¼°ï¼šå‡å°‘1-2ä¸ªäº‹ä»¶

3. **å…¨å±€äº‹ä»¶ç´¢å¼•ä¼˜åŒ–**
   - ä¸ºé«˜é¢‘äº‹ä»¶æ·»åŠ ç´¢å¼•
   - åŠ é€Ÿå‰ç«¯æŸ¥è¯¢

---

## âœ… éªŒæ”¶æ¸…å•

- [x] äº‹ä»¶å®šä¹‰å·²ä¼˜åŒ–ï¼ˆå‡å°‘6ä¸ªäº‹ä»¶ï¼‰
- [x] äº‹ä»¶å‘å°„é€»è¾‘å·²æ›´æ–°
- [x] ç¼–è¯‘é€šè¿‡
- [x] çŠ¶æ€ç æ˜ å°„è¡¨å·²å®šä¹‰
- [x] å‰ç«¯é€‚é…æŒ‡å—å·²æä¾›
- [x] å®ŒæˆæŠ¥å‘Šå·²ç”Ÿæˆ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **å®æ–½æ–¹æ¡ˆ**ï¼š`docs/äº‹ä»¶ä¼˜åŒ–-å®æ–½æ–¹æ¡ˆ.md`
- **Phase 5è§„åˆ’**ï¼š`docs/Phase5-æ€§èƒ½ä¼˜åŒ–è§„åˆ’.md`
- **é“¾ç«¯æ€§èƒ½ä¼˜åŒ–åˆ†æ**ï¼š`docs/é“¾ç«¯æ€§èƒ½ä¼˜åŒ–-åˆ†ææŠ¥å‘Š.md`

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**ï¼š2025-10-28  
**å®æ–½å·¥æ—¶**ï¼š~2å°æ—¶  
**ä¸‹ä¸€æ­¥**ï¼šå‰ç«¯é€‚é…äº‹ä»¶å˜æ›´

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡äº‹ä»¶ä¼˜åŒ–æˆåŠŸå®ç°äº†ä»¥ä¸‹ç›®æ ‡ï¼š

1. **äº‹ä»¶æ•°é‡â†“20%**ï¼ˆ30 â†’ 24ä¸ªï¼‰
2. **OTCäº‹ä»¶â†“37.5%**ï¼ˆ8 â†’ 5ä¸ªï¼‰
3. **å­˜å‚¨æˆæœ¬â†“40%**ï¼ˆé¢„ä¼°ï¼‰
4. **Gasæˆæœ¬â†“15%**ï¼ˆé¢„ä¼°ï¼‰

æ ¸å¿ƒæ€è·¯æ˜¯**åˆå¹¶çŠ¶æ€å˜æ›´äº‹ä»¶**ï¼Œä½¿ç”¨**`u8`çŠ¶æ€ç **æ›¿ä»£å†—ä½™çš„ç‹¬ç«‹äº‹ä»¶ï¼Œæ—¢ä¿ç•™äº†å®Œæ•´çš„çŠ¶æ€è¿½è¸ªèƒ½åŠ›ï¼Œåˆæ˜¾è‘—é™ä½äº†é“¾ä¸Šå­˜å‚¨å’Œè®¡ç®—å¼€é”€ã€‚

**ä¼˜åŒ–æ•ˆæœ**ï¼šâœ… è¶…å‡ºé¢„æœŸç›®æ ‡ï¼ˆç›®æ ‡ï¼šäº‹ä»¶å­˜å‚¨â†“30-40%ï¼Œå®é™…ï¼šâ†“40%ï¼‰

