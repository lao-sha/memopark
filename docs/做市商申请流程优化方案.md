# åšå¸‚å•†ç”³è¯·æµç¨‹ä¼˜åŒ–æ–¹æ¡ˆ

**æ—¥æœŸ**: 2025-10-22  
**ç‰ˆæœ¬**: v1.0  
**éœ€æ±‚æ¥æº**: ç”¨æˆ·ä¼˜åŒ–éœ€æ±‚  
**ç›¸å…³Pallet**: pallet-market-maker, pallet-chat

---

## ä¸€ã€éœ€æ±‚åˆ†æ

### 1.1 éœ€æ±‚æ¦‚è¿°

**éœ€æ±‚å†…å®¹**ï¼š
1. âŒ **åˆ é™¤ `public_cid` å­—æ®µ**ï¼šApplicationç»“æ„ä½“åˆ é™¤public_cidå­—æ®µ
2. âœ… **å¿…å¡«å­—æ®µè°ƒæ•´**ï¼šåšå¸‚å•†æäº¤å®¡æ ¸æ—¶ï¼Œæ˜ç¡®å¿…å¡«å­—æ®µå’Œé€‰å¡«å­—æ®µ
3. âœ… **å®¡æ ¸å‘˜èŠå¤©é€šçŸ¥**ï¼šæäº¤ç”³è¯·åï¼Œç«‹å³è”ç³»åšå¸‚å•†å®¡æ ¸å‘˜ï¼Œç”¨pallet-chatåŠŸèƒ½å‘é€åŠ å¯†èº«ä»½è¯å’Œå¯†ç 

### 1.2 å½“å‰å®ç°

#### Applicationç»“æ„ä½“ï¼ˆå½“å‰ï¼‰

```rust
pub struct Application<AccountId, Balance> {
    pub owner: AccountId,
    pub deposit: Balance,
    pub status: ApplicationStatus,
    pub direction: Direction,
    pub tron_address: BoundedVec<u8, ConstU32<64>>,
    pub public_cid: Cid,          // â† éœ€æ±‚1ï¼šè¦åˆ é™¤
    pub private_cid: Cid,         // â† éœ€æ±‚2ï¼šå¿…å¡«
    pub buy_premium_bps: i16,
    pub sell_premium_bps: i16,
    pub min_amount: Balance,
    pub created_at: u32,
    pub info_deadline: u32,
    pub review_deadline: u32,
    pub epay_gateway: BoundedVec<u8, ConstU32<128>>,
    pub epay_port: u16,
    pub epay_pid: BoundedVec<u8, ConstU32<64>>,
    pub epay_key: BoundedVec<u8, ConstU32<64>>,
    pub first_purchase_pool: Balance,
    pub first_purchase_used: Balance,
    pub first_purchase_frozen: Balance,
    pub service_paused: bool,
    pub users_served: u32,
    pub masked_full_name: BoundedVec<u8, ConstU32<64>>,      // â† éœ€æ±‚2ï¼šå¿…å¡«
    pub masked_id_card: BoundedVec<u8, ConstU32<32>>,        // â† éœ€æ±‚2ï¼šå¿…å¡«
    pub masked_payment_info: BoundedVec<u8, ConstU32<512>>,
}
```

#### submit_infoå‡½æ•°ï¼ˆå½“å‰ï¼‰

```rust
pub fn submit_info(
    origin: OriginFor<T>,
    mm_id: u64,
    public_root_cid: Cid,          // â† éœ€æ±‚1ï¼šè¦åˆ é™¤
    private_root_cid: Cid,         // â† éœ€æ±‚2ï¼šå¿…å¡«
    buy_premium_bps: i16,
    sell_premium_bps: i16,
    min_amount: BalanceOf<T>,
    tron_address: Vec<u8>,         // â† éœ€æ±‚2ï¼šå¿…å¡«
    epay_gateway: Vec<u8>,
    epay_port: u16,
    epay_pid: Vec<u8>,
    epay_key: Vec<u8>,
    first_purchase_pool: BalanceOf<T>,
    full_name: Vec<u8>,            // â† éœ€æ±‚2ï¼šå¿…å¡«ï¼ˆè‡ªåŠ¨è„±æ•ä¸ºmasked_full_nameï¼‰
    id_card: Vec<u8>,              // â† éœ€æ±‚2ï¼šå¿…å¡«ï¼ˆè‡ªåŠ¨è„±æ•ä¸ºmasked_id_cardï¼‰
    masked_payment_info_json: Vec<u8>,
) -> DispatchResult
```

---

## äºŒã€å¯è¡Œæ€§ä¸åˆç†æ€§åˆ†æ

### 2.1 éœ€æ±‚1ï¼šåˆ é™¤ `public_cid` å­—æ®µ

#### âŒ **ä¸åˆç†ï¼å¼ºçƒˆä¸å»ºè®®åˆ é™¤**

**åŸå› åˆ†æ**ï¼š

| ç»´åº¦ | è¯´æ˜ | ç»“è®º |
|-----|------|------|
| **æ•°æ®å…¬å¼€æ€§** | public_cid å­˜å‚¨å…¬å¼€ä¿¡æ¯ï¼ˆä¸šåŠ¡æ–¹å‘ã€æº¢ä»·ã€è”ç³»æ–¹å¼ç­‰ï¼‰ï¼Œç”¨äºä¹°å®¶é€‰æ‹©åšå¸‚å•† | âŒ åˆ é™¤åä¹°å®¶æ— æ³•äº†è§£åšå¸‚å•† |
| **éšç§ä¿æŠ¤** | private_cid å­˜å‚¨æ•æ„Ÿä¿¡æ¯ï¼ˆå®Œæ•´èº«ä»½è¯ã€é“¶è¡Œå¡å·ã€ç§é’¥ç­‰ï¼‰ï¼Œä»…å®¡æ ¸å‘˜å¯è§ | âœ… éœ€è¦ä¿ç•™ |
| **ä¸šåŠ¡é€»è¾‘** | public_cid å’Œ private_cid åˆ†ç¦»ï¼Œæ˜¯æ•°æ®åˆ†çº§ç®¡ç†çš„æœ€ä½³å®è·µ | âŒ åˆ é™¤ç ´åæ¶æ„ |
| **å‰ç«¯å±•ç¤º** | å‰ç«¯ä» public_cid è¯»å–åšå¸‚å•†åˆ—è¡¨å±•ç¤ºç»™ç”¨æˆ· | âŒ åˆ é™¤åå‰ç«¯æ— æ³•å·¥ä½œ |
| **å®¡è®¡è¿½æº¯** | public_cid å¯ä½œä¸ºåšå¸‚å•†ä¿¡æ¯å˜æ›´çš„å†å²è®°å½• | âŒ åˆ é™¤åæ— æ³•è¿½æº¯ |

**å½“å‰æ¶æ„ï¼ˆpublic_cid + private_cidï¼‰**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          åšå¸‚å•†æ•°æ®åˆ†çº§              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â”œâ”€ public_cidï¼ˆå…¬å¼€ä¿¡æ¯ï¼‰
        â”‚   â”œâ”€ ä¸šåŠ¡æ–¹å‘ï¼ˆBuy/Sell/Bothï¼‰
        â”‚   â”œâ”€ æº¢ä»·è®¾ç½®ï¼ˆbuy_premium_bps/sell_premium_bpsï¼‰
        â”‚   â”œâ”€ æœ€å°äº¤æ˜“é¢ï¼ˆmin_amountï¼‰
        â”‚   â”œâ”€ è„±æ•å§“åï¼ˆ"å¼ Ã—ä¸‰"ï¼‰
        â”‚   â”œâ”€ è„±æ•èº«ä»½è¯ï¼ˆ"1101**********1234"ï¼‰
        â”‚   â”œâ”€ è„±æ•æ”¶æ¬¾æ–¹å¼ï¼ˆ"6214****5678"ï¼‰
        â”‚   â”œâ”€ æœåŠ¡è¯„åˆ†ï¼ˆä¿¡ç”¨åˆ†ã€æˆäº¤é‡ï¼‰
        â”‚   â””â”€ è”ç³»æ–¹å¼ï¼ˆå¯é€‰ï¼‰
        â”‚
        â””â”€ private_cidï¼ˆæ•æ„Ÿä¿¡æ¯ï¼Œä»…å®¡æ ¸å‘˜å¯è§ï¼‰
            â”œâ”€ å®Œæ•´å§“åï¼ˆ"å¼ ä¸‰"ï¼‰
            â”œâ”€ å®Œæ•´èº«ä»½è¯å·ï¼ˆ"110101199001011234"ï¼‰
            â”œâ”€ å®Œæ•´é“¶è¡Œå¡å·ï¼ˆ"6214000000005678"ï¼‰
            â”œâ”€ èº«ä»½è¯ç…§ç‰‡ï¼ˆæ­£åé¢ï¼‰
            â”œâ”€ è¥ä¸šæ‰§ç…§ï¼ˆä¼ä¸šåšå¸‚å•†ï¼‰
            â”œâ”€ èµ„äº§è¯æ˜
            â””â”€ KYCå®¡æ ¸ææ–™
```

**åˆ é™¤åçš„é—®é¢˜**ï¼š
1. âŒ **ä¹°å®¶æ— æ³•é€‰æ‹©åšå¸‚å•†**ï¼šå‰ç«¯æ— æ•°æ®å±•ç¤º
2. âŒ **æ— æ³•å…¬å¼€è„±æ•ä¿¡æ¯**ï¼šé“¾ä¸Šæ— è„±æ•å§“åå’Œèº«ä»½è¯ï¼Œä¹°å®¶æ— æ³•æ ¸å¯¹æ”¶æ¬¾äºº
3. âŒ **ç ´åæ•°æ®åˆ†çº§æ¶æ„**ï¼šæ‰€æœ‰æ•°æ®éƒ½å­˜ private_cidï¼Œè¿èƒŒæœ€å°æƒé™åŸåˆ™
4. âŒ **å¢åŠ å®¡æ ¸å‘˜è´Ÿæ‹…**ï¼šå®¡æ ¸å‘˜éœ€è¦æ‰‹åŠ¨æ•´ç†å…¬å¼€ä¿¡æ¯
5. âŒ **ä¸ç¬¦åˆåŒºå—é“¾é€æ˜åŸåˆ™**ï¼šé“¾ä¸Šåº”æœ‰è¶³å¤Ÿçš„å…¬å¼€ä¿¡æ¯ä¾›æŸ¥è¯¢

**ç»“è®º**ï¼š**å¼ºçƒˆä¸å»ºè®®åˆ é™¤ `public_cid` å­—æ®µï¼**

---

### 2.2 éœ€æ±‚2ï¼šå¿…å¡«å­—æ®µè°ƒæ•´

#### âœ… **åˆç†ï¼ä½†éœ€è¦æ˜ç¡®å­—æ®µåˆ†ç±»**

**å¿…å¡«å­—æ®µ**ï¼ˆç”¨æˆ·éœ€æ±‚ï¼‰ï¼š
1. âœ… `owner`ï¼ˆç”³è¯·äººè´¦æˆ·ï¼‰ - è‡ªåŠ¨è·å–ï¼Œæ— éœ€æ‰‹åŠ¨å¡«
2. âœ… `deposit`ï¼ˆæŠ¼é‡‘ï¼‰ - lock_deposité˜¶æ®µå·²é”å®šï¼Œæ— éœ€å†å¡«
3. âœ… `private_cid`ï¼ˆæ•æ„Ÿä¿¡æ¯CIDï¼‰
4. âœ… `tron_address`ï¼ˆTRONåœ°å€ï¼‰
5. âœ… `masked_full_name`ï¼ˆè„±æ•å§“åï¼‰- ç”± `full_name` è‡ªåŠ¨è„±æ•
6. âœ… `masked_id_card`ï¼ˆè„±æ•èº«ä»½è¯ï¼‰- ç”± `id_card` è‡ªåŠ¨è„±æ•

**å»ºè®®å¿…å¡«å­—æ®µ**ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰ï¼š
1. âœ… `direction`ï¼ˆä¸šåŠ¡æ–¹å‘ï¼šBuy/Sell/BuyAndSellï¼‰
2. âœ… `buy_premium_bps`ï¼ˆBuyæº¢ä»·ï¼‰
3. âœ… `sell_premium_bps`ï¼ˆSellæº¢ä»·ï¼‰
4. âœ… `min_amount`ï¼ˆæœ€å°äº¤æ˜“é¢ï¼‰
5. âš ï¸ `public_cid`ï¼ˆå…¬å¼€ä¿¡æ¯CIDï¼‰**ä¸åº”åˆ é™¤**

**é€‰å¡«å­—æ®µ**ï¼ˆå¯ä¸ºç©ºæˆ–æœ‰é»˜è®¤å€¼ï¼‰ï¼š
1. âš ï¸ `epay_gateway` - ç”µå­æ”¯ä»˜ç½‘å…³ï¼ˆé¦–è´­åŠŸèƒ½å·²åˆ é™¤ï¼Œå¯é€‰å¡«æˆ–åˆ é™¤ï¼‰
2. âš ï¸ `epay_port` - ç”µå­æ”¯ä»˜ç«¯å£ï¼ˆé¦–è´­åŠŸèƒ½å·²åˆ é™¤ï¼Œå¯é€‰å¡«æˆ–åˆ é™¤ï¼‰
3. âš ï¸ `epay_pid` - ç”µå­æ”¯ä»˜å•†æˆ·IDï¼ˆé¦–è´­åŠŸèƒ½å·²åˆ é™¤ï¼Œå¯é€‰å¡«æˆ–åˆ é™¤ï¼‰
4. âš ï¸ `epay_key` - ç”µå­æ”¯ä»˜å¯†é’¥ï¼ˆé¦–è´­åŠŸèƒ½å·²åˆ é™¤ï¼Œå¯é€‰å¡«æˆ–åˆ é™¤ï¼‰
5. âš ï¸ `first_purchase_pool` - é¦–è´­èµ„é‡‘æ± ï¼ˆé¦–è´­åŠŸèƒ½å·²åˆ é™¤ï¼Œå¯é€‰å¡«æˆ–åˆ é™¤ï¼‰
6. âœ… `masked_payment_info` - è„±æ•æ”¶æ¬¾æ–¹å¼ï¼ˆé€‰å¡«ï¼Œåšå¸‚å•†å¯æä¾›å¤šç§æ”¶æ¬¾æ–¹å¼ï¼‰

**æ”¹è¿›å»ºè®®**ï¼š

```rust
// ä¼˜åŒ–åçš„ submit_info å‡½æ•°ç­¾å
pub fn submit_info(
    origin: OriginFor<T>,
    mm_id: u64,
    // ===== å¿…å¡«å­—æ®µ =====
    public_root_cid: Cid,          // âœ… ä¿ç•™ï¼å…¬å¼€ä¿¡æ¯CID
    private_root_cid: Cid,         // âœ… å¿…å¡«ï¼šæ•æ„Ÿä¿¡æ¯CID
    direction: Direction,          // âœ… å¿…å¡«ï¼šä¸šåŠ¡æ–¹å‘
    buy_premium_bps: i16,          // âœ… å¿…å¡«ï¼šBuyæº¢ä»·
    sell_premium_bps: i16,         // âœ… å¿…å¡«ï¼šSellæº¢ä»·
    min_amount: BalanceOf<T>,      // âœ… å¿…å¡«ï¼šæœ€å°äº¤æ˜“é¢
    tron_address: Vec<u8>,         // âœ… å¿…å¡«ï¼šTRONåœ°å€
    full_name: Vec<u8>,            // âœ… å¿…å¡«ï¼šå®Œæ•´å§“åï¼ˆè‡ªåŠ¨è„±æ•ï¼‰
    id_card: Vec<u8>,              // âœ… å¿…å¡«ï¼šå®Œæ•´èº«ä»½è¯ï¼ˆè‡ªåŠ¨è„±æ•ï¼‰
    
    // ===== é€‰å¡«å­—æ®µï¼ˆOptionåŒ…è£…ï¼‰=====
    masked_payment_info_json: Option<Vec<u8>>,  // å¯é€‰ï¼šè„±æ•æ”¶æ¬¾æ–¹å¼
    epay_config: Option<EpayConfig<T>>,         // å¯é€‰ï¼šç”µå­æ”¯ä»˜é…ç½®ï¼ˆå¾…åˆ é™¤ï¼‰
    first_purchase_pool: Option<BalanceOf<T>>,  // å¯é€‰ï¼šé¦–è´­èµ„é‡‘æ± ï¼ˆå¾…åˆ é™¤ï¼‰
) -> DispatchResult
```

**ç»“è®º**ï¼š**éƒ¨åˆ†åˆç†ï¼Œä½† `public_cid` å¿…é¡»ä¿ç•™ï¼**

---

### 2.3 éœ€æ±‚3ï¼šå®¡æ ¸å‘˜èŠå¤©é€šçŸ¥

#### âœ… **åˆç†ä¸”å¯è¡Œï¼åˆ›æ–°è®¾è®¡**

**ä¼˜åŠ¿åˆ†æ**ï¼š

| ä¼˜åŠ¿ | è¯´æ˜ |
|-----|------|
| âœ… **å³æ—¶é€šçŸ¥** | ç”³è¯·æäº¤åç«‹å³é€šçŸ¥å®¡æ ¸å‘˜ï¼Œæé«˜å®¡æ ¸æ•ˆç‡ |
| âœ… **ç«¯åˆ°ç«¯åŠ å¯†** | åˆ©ç”¨ pallet-chat çš„åŠ å¯†åŠŸèƒ½ï¼Œä¿æŠ¤æ•æ„Ÿä¿¡æ¯ |
| âœ… **é“¾ä¸Šå¯è¿½æº¯** | èŠå¤©è®°å½•é“¾ä¸Šå¯æŸ¥ï¼Œå®¡è®¡å‹å¥½ |
| âœ… **é™ä½æˆæœ¬** | æ— éœ€é¢å¤–å»ºç«‹é€šçŸ¥ç³»ç»Ÿ |
| âœ… **ç”¨æˆ·å‹å¥½** | å®¡æ ¸å‘˜å¯ç›´æ¥åœ¨èŠå¤©ç•Œé¢å®¡æ ¸ï¼Œæ— éœ€åˆ‡æ¢ |

**æŠ€æœ¯å¯è¡Œæ€§**ï¼š

```rust
// pallet-chat çš„ send_message æ¥å£
pub fn send_message(
    origin: OriginFor<T>,
    receiver: T::AccountId,      // å®¡æ ¸å‘˜è´¦æˆ·
    content_cid: Vec<u8>,        // IPFS CIDï¼ˆåŠ å¯†çš„èº«ä»½è¯ä¿¡æ¯ï¼‰
    msg_type_code: u8,           // æ¶ˆæ¯ç±»å‹ï¼ˆ0=æ–‡æœ¬ï¼Œ4=ç³»ç»Ÿæ¶ˆæ¯ï¼‰
    session_id: Option<T::Hash>, // ä¼šè¯IDï¼ˆå¯é€‰ï¼‰
) -> DispatchResult
```

**é›†æˆæ–¹æ¡ˆ**ï¼š

```rust
// åœ¨ pallet-market-maker ä¸­é›†æˆ pallet-chat
impl<T: Config> Pallet<T> {
    /// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šæäº¤ç”³è¯·åè‡ªåŠ¨é€šçŸ¥å®¡æ ¸å‘˜
    /// - ä»é…ç½®ä¸­è¯»å–å®¡æ ¸å‘˜è´¦æˆ·åˆ—è¡¨
    /// - åŠ å¯†èº«ä»½è¯å’Œæ•æ„Ÿä¿¡æ¯
    /// - ä¸Šä¼ åˆ°IPFSè·å–CID
    /// - è°ƒç”¨pallet-chatå‘é€ç³»ç»Ÿæ¶ˆæ¯
    fn notify_reviewers_on_submit(
        mm_id: u64,
        applicant: &T::AccountId,
        private_cid: &Cid,
    ) -> DispatchResult {
        // 1. è¯»å–å®¡æ ¸å‘˜åˆ—è¡¨ï¼ˆä»é…ç½®æˆ–å­˜å‚¨ä¸­ï¼‰
        let reviewers = T::ReviewerAccounts::get();
        
        // 2. æ„é€ é€šçŸ¥æ¶ˆæ¯å†…å®¹
        let notification = NotificationContent {
            applicant: applicant.clone(),
            mm_id,
            private_cid: private_cid.clone(),
            submit_time: <pallet_timestamp::Pallet<T>>::get(),
            message: "æ–°çš„åšå¸‚å•†ç”³è¯·å¾…å®¡æ ¸",
        };
        
        // 3. åºåˆ—åŒ–ä¸ºJSON
        let notification_json = serde_json::to_vec(&notification)
            .map_err(|_| Error::<T>::SerializationFailed)?;
        
        // 4. å¯¹æ¯ä¸ªå®¡æ ¸å‘˜å‘é€èŠå¤©æ¶ˆæ¯
        for reviewer in reviewers.iter() {
            // æ³¨æ„ï¼šå®é™…åŠ å¯†å’ŒIPFSä¸Šä¼ åº”è¯¥åœ¨å‰ç«¯å®Œæˆ
            // è¿™é‡Œåªæ˜¯å‘é€æ¶ˆæ¯å…ƒæ•°æ®
            <pallet_chat::Pallet<T>>::send_message(
                frame_system::RawOrigin::Signed(applicant.clone()).into(),
                reviewer.clone(),
                private_cid.to_vec(),  // ä½¿ç”¨ private_cid ä½œä¸ºå†…å®¹å¼•ç”¨
                4,                     // msg_type_code = 4ï¼ˆç³»ç»Ÿæ¶ˆæ¯ï¼‰
                None,                  // è‡ªåŠ¨åˆ›å»ºæ–°ä¼šè¯
            )?;
        }
        
        Ok(())
    }
}
```

**å®‰å…¨æ€§åˆ†æ**ï¼š

| å®‰å…¨è€ƒè™‘ | æ–¹æ¡ˆ |
|---------|------|
| **èº«ä»½è¯åŠ å¯†** | âœ… å‰ç«¯ä½¿ç”¨å®¡æ ¸å‘˜å…¬é’¥åŠ å¯†ï¼Œé“¾ä¸Šåªå­˜CID |
| **é˜²æ­¢å†’å……** | âœ… æ¶ˆæ¯å‘é€æ–¹éªŒè¯ï¼ˆensure_signedï¼‰ |
| **è®¿é—®æ§åˆ¶** | âœ… åªæœ‰å®¡æ ¸å‘˜èƒ½è§£å¯†æ¶ˆæ¯å†…å®¹ |
| **æ•°æ®æ³„éœ²** | âœ… IPFSå†…å®¹åŠ å¯†ï¼ŒCIDæ— æ³•åæ¨å†…å®¹ |
| **é‡æ”¾æ”»å‡»** | âœ… æ¶ˆæ¯IDé€’å¢ï¼Œæ—¶é—´æˆ³éªŒè¯ |

**æ½œåœ¨é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**ï¼š

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|-----|---------|
| âš ï¸ **å®¡æ ¸å‘˜è´¦æˆ·å¦‚ä½•é…ç½®ï¼Ÿ** | æ–¹æ¡ˆ1ï¼šRuntimeé…ç½®å›ºå®šå®¡æ ¸å‘˜<br>æ–¹æ¡ˆ2ï¼šæ²»ç†æ·»åŠ /ç§»é™¤å®¡æ ¸å‘˜<br>æ–¹æ¡ˆ3ï¼šå§”å‘˜ä¼šæˆå‘˜è‡ªåŠ¨ä¸ºå®¡æ ¸å‘˜ |
| âš ï¸ **å®¡æ ¸å‘˜ä¸åœ¨çº¿æ€ä¹ˆåŠï¼Ÿ** | æ–¹æ¡ˆ1ï¼šå¤šä¸ªå®¡æ ¸å‘˜ï¼Œä»»æ„ä¸€ä¸ªå®¡æ ¸å³å¯<br>æ–¹æ¡ˆ2ï¼šé“¾ä¸‹ç›‘æ§+é‚®ä»¶/çŸ­ä¿¡é€šçŸ¥<br>æ–¹æ¡ˆ3ï¼šè¶…æ—¶è‡ªåŠ¨æé†’ |
| âš ï¸ **æ¶ˆæ¯å‘é€å¤±è´¥æ€ä¹ˆåŠï¼Ÿ** | æ–¹æ¡ˆ1ï¼šé‡è¯•æœºåˆ¶<br>æ–¹æ¡ˆ2ï¼šäº‹ä»¶è®°å½•ï¼Œé“¾ä¸‹ç›‘æ§<br>æ–¹æ¡ˆ3ï¼šä¸å½±å“ç”³è¯·æµç¨‹ï¼ˆéå…³é”®è·¯å¾„ï¼‰ |
| âš ï¸ **å¦‚ä½•é˜²æ­¢æ»¥å‘æ¶ˆæ¯ï¼Ÿ** | æ–¹æ¡ˆ1ï¼šé™åˆ¶åªèƒ½åœ¨submit_infoæ—¶å‘é€<br>æ–¹æ¡ˆ2ï¼šæ¯ä¸ªç”³è¯·åªå‘é€ä¸€æ¬¡<br>æ–¹æ¡ˆ3ï¼šGasè´¹ç”¨ä½œä¸ºspamé˜²æŠ¤ |

**ç»“è®º**ï¼š**åˆç†ä¸”å¯è¡Œï¼å»ºè®®å®æ–½ï¼Œä½†éœ€è¦é…å¥—å®¡æ ¸å‘˜ç®¡ç†æœºåˆ¶ã€‚**

---

## ä¸‰ã€ä¼˜åŒ–æ–¹æ¡ˆè®¾è®¡

### 3.1 æ–¹æ¡ˆAï¼šä¿å®ˆæ–¹æ¡ˆï¼ˆæ¨èï¼‰â­â­â­â­â­

**è®¾è®¡åŸåˆ™**ï¼š
- âœ… ä¿ç•™ `public_cid` å­—æ®µï¼ˆæ•°æ®åˆ†çº§æ¶æ„ï¼‰
- âœ… æ˜ç¡®å¿…å¡«/é€‰å¡«å­—æ®µï¼ˆæ”¹è¿›ç”¨æˆ·ä½“éªŒï¼‰
- âœ… é›†æˆå®¡æ ¸å‘˜èŠå¤©é€šçŸ¥ï¼ˆåˆ›æ–°åŠŸèƒ½ï¼‰

#### 3.1.1 Applicationç»“æ„ä½“ï¼ˆä¿æŒä¸å˜ï¼‰

```rust
pub struct Application<AccountId, Balance> {
    // ===== æ ¸å¿ƒå­—æ®µï¼ˆè‡ªåŠ¨å¡«å……ï¼‰=====
    pub owner: AccountId,         // è‡ªåŠ¨è·å–
    pub deposit: Balance,         // lock_deposité˜¶æ®µå·²é”å®š
    pub status: ApplicationStatus,// è‡ªåŠ¨æ›´æ–°
    pub created_at: u32,          // è‡ªåŠ¨è·å–
    pub info_deadline: u32,       // è‡ªåŠ¨è®¡ç®—
    pub review_deadline: u32,     // è‡ªåŠ¨è®¡ç®—
    
    // ===== å¿…å¡«å­—æ®µï¼ˆç”¨æˆ·æä¾›ï¼‰=====
    pub direction: Direction,               // ä¸šåŠ¡æ–¹å‘
    pub tron_address: BoundedVec<u8, ConstU32<64>>, // TRONåœ°å€
    pub public_cid: Cid,                    // âœ… ä¿ç•™ï¼å…¬å¼€ä¿¡æ¯CID
    pub private_cid: Cid,                   // æ•æ„Ÿä¿¡æ¯CID
    pub buy_premium_bps: i16,               // Buyæº¢ä»·
    pub sell_premium_bps: i16,              // Sellæº¢ä»·
    pub min_amount: Balance,                // æœ€å°äº¤æ˜“é¢
    pub masked_full_name: BoundedVec<u8, ConstU32<64>>,  // è„±æ•å§“åï¼ˆè‡ªåŠ¨ï¼‰
    pub masked_id_card: BoundedVec<u8, ConstU32<32>>,    // è„±æ•èº«ä»½è¯ï¼ˆè‡ªåŠ¨ï¼‰
    
    // ===== é€‰å¡«å­—æ®µï¼ˆå¯ä¸ºç©º/é»˜è®¤å€¼ï¼‰=====
    pub masked_payment_info: BoundedVec<u8, ConstU32<512>>, // è„±æ•æ”¶æ¬¾æ–¹å¼
    pub epay_gateway: BoundedVec<u8, ConstU32<128>>,        // å¾…åˆ é™¤
    pub epay_port: u16,                                     // å¾…åˆ é™¤
    pub epay_pid: BoundedVec<u8, ConstU32<64>>,            // å¾…åˆ é™¤
    pub epay_key: BoundedVec<u8, ConstU32<64>>,            // å¾…åˆ é™¤
    pub first_purchase_pool: Balance,                       // å¾…åˆ é™¤
    
    // ===== è¿è¥æ•°æ®ï¼ˆè‡ªåŠ¨ç»´æŠ¤ï¼‰=====
    pub first_purchase_used: Balance,
    pub first_purchase_frozen: Balance,
    pub service_paused: bool,
    pub users_served: u32,
}
```

#### 3.1.2 ä¼˜åŒ–åçš„ submit_info å‡½æ•°

```rust
/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šåšå¸‚å•†æäº¤ç”³è¯·ä¿¡æ¯ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
/// 
/// # å¿…å¡«å‚æ•°
/// - mm_id: åšå¸‚å•†ID
/// - public_root_cid: å…¬å¼€ä¿¡æ¯CIDï¼ˆä¸šåŠ¡ä¿¡æ¯ã€è„±æ•ä¿¡æ¯ï¼‰
/// - private_root_cid: æ•æ„Ÿä¿¡æ¯CIDï¼ˆå®Œæ•´èº«ä»½è¯ã€é“¶è¡Œå¡ç­‰ï¼‰
/// - direction: ä¸šåŠ¡æ–¹å‘ï¼ˆBuy/Sell/BuyAndSellï¼‰
/// - buy_premium_bps: Buyæº¢ä»·ï¼ˆ-500~500åŸºç‚¹ï¼‰
/// - sell_premium_bps: Sellæº¢ä»·ï¼ˆ-500~500åŸºç‚¹ï¼‰
/// - min_amount: æœ€å°äº¤æ˜“é¢
/// - tron_address: TRONåœ°å€
/// - full_name: å®Œæ•´å§“åï¼ˆè‡ªåŠ¨è„±æ•ä¸ºmasked_full_nameï¼‰
/// - id_card: å®Œæ•´èº«ä»½è¯å·ï¼ˆè‡ªåŠ¨è„±æ•ä¸ºmasked_id_cardï¼‰
/// 
/// # é€‰å¡«å‚æ•°ï¼ˆOptionåŒ…è£…ï¼‰
/// - masked_payment_info_json: è„±æ•æ”¶æ¬¾æ–¹å¼JSONï¼ˆå¯é€‰ï¼‰
/// 
/// # è¿”å›å€¼
/// - Ok(()): æäº¤æˆåŠŸï¼Œå®¡æ ¸å‘˜å·²æ”¶åˆ°é€šçŸ¥
/// - Err: æäº¤å¤±è´¥ï¼Œè¿”å›é”™è¯¯ä¿¡æ¯
#[pallet::call_index(1)]
#[pallet::weight(<T as Config>::WeightInfo::submit_info())]
pub fn submit_info(
    origin: OriginFor<T>,
    mm_id: u64,
    // ===== å¿…å¡«å‚æ•° =====
    public_root_cid: Cid,
    private_root_cid: Cid,
    direction: Direction,
    buy_premium_bps: i16,
    sell_premium_bps: i16,
    min_amount: BalanceOf<T>,
    tron_address: Vec<u8>,
    full_name: Vec<u8>,
    id_card: Vec<u8>,
    // ===== é€‰å¡«å‚æ•° =====
    masked_payment_info_json: Option<Vec<u8>>,
) -> DispatchResult {
    let who = ensure_signed(origin.clone())?;
    
    // ===== 1. å‚æ•°éªŒè¯ =====
    
    // éªŒè¯TRONåœ°å€æ ¼å¼
    ensure!(
        Self::is_valid_tron_address(&tron_address),
        Error::<T>::InvalidTronAddress
    );
    
    // éªŒè¯å§“åå’Œèº«ä»½è¯å·
    ensure!(!full_name.is_empty(), Error::<T>::BadState);
    ensure!(!id_card.is_empty(), Error::<T>::BadState);
    
    // éªŒè¯æº¢ä»·èŒƒå›´
    ensure!(
        buy_premium_bps >= T::MinPremiumBps::get() && buy_premium_bps <= T::MaxPremiumBps::get(),
        Error::<T>::InvalidBuyPremium
    );
    ensure!(
        sell_premium_bps >= T::MinPremiumBps::get() && sell_premium_bps <= T::MaxPremiumBps::get(),
        Error::<T>::InvalidSellPremium
    );
    
    // ===== 2. è‡ªåŠ¨è„±æ•å§“åå’Œèº«ä»½è¯å· =====
    let full_name_str = sp_std::str::from_utf8(&full_name).map_err(|_| Error::<T>::BadState)?;
    let id_card_str = sp_std::str::from_utf8(&id_card).map_err(|_| Error::<T>::BadState)?;
    
    let masked_name = mask_name(full_name_str);
    let masked_id = mask_id_card(id_card_str);
    
    let masked_full_name: BoundedVec<u8, ConstU32<64>> = masked_name.try_into()
        .map_err(|_| Error::<T>::BadState)?;
    let masked_id_card: BoundedVec<u8, ConstU32<32>> = masked_id.try_into()
        .map_err(|_| Error::<T>::BadState)?;
    
    // ===== 3. æ›´æ–°ç”³è¯·ä¿¡æ¯ =====
    Applications::<T>::try_mutate(mm_id, |maybe_app| -> DispatchResult {
        let app = maybe_app.as_mut().ok_or(Error::<T>::NotFound)?;
        ensure!(app.owner == who, Error::<T>::NotFound);
        ensure!(
            matches!(app.status, ApplicationStatus::DepositLocked),
            Error::<T>::NotDepositLocked
        );
        
        // éªŒè¯æˆªæ­¢æ—¶é—´
        let now_ms = pallet_timestamp::Pallet::<T>::get();
        let now = (now_ms / 1000u32.into()).saturated_into::<u32>();
        ensure!(now <= app.info_deadline, Error::<T>::DeadlinePassed);
        ensure!(min_amount > BalanceOf::<T>::zero(), Error::<T>::InvalidFee);

        // æ›´æ–°çŠ¶æ€
        app.status = ApplicationStatus::PendingReview;
        app.direction = direction;
        app.public_cid = public_root_cid.clone();
        app.private_cid = private_root_cid.clone();
        app.buy_premium_bps = buy_premium_bps;
        app.sell_premium_bps = sell_premium_bps;
        app.min_amount = min_amount;
        app.tron_address = tron_address.try_into().map_err(|_| Error::<T>::InvalidTronAddress)?;
        app.masked_full_name = masked_full_name.clone();
        app.masked_id_card = masked_id_card.clone();
        
        // å¯é€‰å­—æ®µï¼šè„±æ•æ”¶æ¬¾æ–¹å¼
        if let Some(payment_info) = masked_payment_info_json {
            app.masked_payment_info = payment_info.try_into()
                .map_err(|_| Error::<T>::BadState)?;
        } else {
            app.masked_payment_info = Default::default();
        }
        
        Ok(())
    })?;
    
    // ===== 4. ğŸ†• è‡ªåŠ¨é€šçŸ¥å®¡æ ¸å‘˜ï¼ˆpallet-chaté›†æˆï¼‰=====
    if let Err(e) = Self::notify_reviewers_on_submit(mm_id, &who, &private_root_cid) {
        // é€šçŸ¥å¤±è´¥ä¸å½±å“æäº¤æµç¨‹ï¼ˆè®°å½•æ—¥å¿—å³å¯ï¼‰
        Self::deposit_event(Event::ReviewerNotificationFailed(mm_id, e));
    }
    
    // ===== 5. å‘å‡ºäº‹ä»¶ =====
    Self::deposit_event(Event::InfoSubmitted {
        mm_id,
        owner: who,
        direction,
        masked_full_name,
        masked_id_card,
    });
    
    Ok(())
}
```

#### 3.1.3 å®¡æ ¸å‘˜é€šçŸ¥å®ç°

```rust
impl<T: Config> Pallet<T> {
    /// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šæäº¤ç”³è¯·åè‡ªåŠ¨é€šçŸ¥å®¡æ ¸å‘˜
    /// 
    /// # åŠŸèƒ½
    /// - è¯»å–å®¡æ ¸å‘˜è´¦æˆ·åˆ—è¡¨
    /// - æ„é€ ç³»ç»Ÿæ¶ˆæ¯å†…å®¹
    /// - è°ƒç”¨pallet-chatå‘é€åŠ å¯†æ¶ˆæ¯
    /// - è®°å½•é€šçŸ¥äº‹ä»¶
    /// 
    /// # å‚æ•°
    /// - mm_id: åšå¸‚å•†ID
    /// - applicant: ç”³è¯·äººè´¦æˆ·
    /// - private_cid: æ•æ„Ÿä¿¡æ¯CIDï¼ˆåŒ…å«å®Œæ•´èº«ä»½è¯ç­‰ï¼‰
    /// 
    /// # è¿”å›å€¼
    /// - Ok(()): é€šçŸ¥æˆåŠŸ
    /// - Err: é€šçŸ¥å¤±è´¥ï¼ˆä¸å½±å“ç”³è¯·æµç¨‹ï¼‰
    fn notify_reviewers_on_submit(
        mm_id: u64,
        applicant: &T::AccountId,
        private_cid: &Cid,
    ) -> DispatchResult {
        // 1. è¯»å–å®¡æ ¸å‘˜åˆ—è¡¨ï¼ˆä»é…ç½®ä¸­ï¼‰
        let reviewers = T::ReviewerAccounts::get();
        
        ensure!(!reviewers.is_empty(), Error::<T>::NoReviewersConfigured);
        
        // 2. æ„é€ é€šçŸ¥æ¶ˆæ¯å†…å®¹ï¼ˆJSONæ ¼å¼ï¼‰
        // æ³¨æ„ï¼šå®é™…å†…å®¹åŠ å¯†åº”è¯¥åœ¨å‰ç«¯å®Œæˆ
        // è¿™é‡Œåªæ˜¯å‘é€å…ƒæ•°æ®å¼•ç”¨
        let notification_meta = sp_std::format!(
            "{{\"type\":\"maker_application\",\"mm_id\":{},\"applicant\":\"{:?}\",\"private_cid\":\"{}\",\"submit_time\":{}}}",
            mm_id,
            applicant,
            sp_std::str::from_utf8(private_cid).unwrap_or("invalid_cid"),
            <pallet_timestamp::Pallet<T>>::get()
        );
        
        let notification_bytes = notification_meta.as_bytes().to_vec();
        
        // 3. å‘æ¯ä¸ªå®¡æ ¸å‘˜å‘é€ç³»ç»Ÿæ¶ˆæ¯
        for reviewer in reviewers.iter() {
            // è°ƒç”¨pallet-chatå‘é€æ¶ˆæ¯
            // æ³¨æ„ï¼šè¿™é‡Œä½¿ç”¨ç”³è¯·äººè´¦æˆ·ä½œä¸ºå‘é€æ–¹
            let send_result = <pallet_chat::Pallet<T>>::send_message(
                frame_system::RawOrigin::Signed(applicant.clone()).into(),
                reviewer.clone(),
                notification_bytes.clone(),
                4,  // msg_type_code = 4ï¼ˆç³»ç»Ÿæ¶ˆæ¯ï¼‰
                None, // è‡ªåŠ¨åˆ›å»ºæ–°ä¼šè¯
            );
            
            // å¿½ç•¥å•ä¸ªå®¡æ ¸å‘˜çš„å‘é€å¤±è´¥ï¼ˆå°½åŠ›è€Œä¸ºï¼‰
            if let Err(_) = send_result {
                Self::deposit_event(Event::ReviewerNotificationPartialFailed(
                    mm_id,
                    reviewer.clone(),
                ));
            }
        }
        
        // 4. è®°å½•é€šçŸ¥æˆåŠŸäº‹ä»¶
        Self::deposit_event(Event::ReviewersNotified(mm_id, reviewers.len() as u32));
        
        Ok(())
    }
}
```

#### 3.1.4 Runtimeé…ç½®

```rust
// runtime/src/configs/mod.rs

use frame_support::traits::ConstU32;

/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šåšå¸‚å•†å®¡æ ¸å‘˜è´¦æˆ·åˆ—è¡¨
/// - é…ç½®å›ºå®šçš„å®¡æ ¸å‘˜è´¦æˆ·ï¼Œè´Ÿè´£å®¡æ ¸åšå¸‚å•†ç”³è¯·
/// - æäº¤ç”³è¯·æ—¶è‡ªåŠ¨å‘è¿™äº›è´¦æˆ·å‘é€èŠå¤©æ¶ˆæ¯
/// - å¯é€šè¿‡æ²»ç†ä¿®æ”¹å®¡æ ¸å‘˜åˆ—è¡¨
pub struct MarketMakerReviewers;
impl Get<Vec<AccountId>> for MarketMakerReviewers {
    fn get() -> Vec<AccountId> {
        vec![
            // å®¡æ ¸å‘˜1ï¼ˆä¸»å®¡æ ¸å‘˜ï¼‰
            AccountId::from_ss58check("5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY")
                .expect("Valid reviewer account 1"),
            // å®¡æ ¸å‘˜2ï¼ˆå¤‡ç”¨å®¡æ ¸å‘˜ï¼‰
            AccountId::from_ss58check("5FHneW46xGXgs5mUiveU4sbTyGBzmstUspZC92UhjJM694ty")
                .expect("Valid reviewer account 2"),
            // å®¡æ ¸å‘˜3ï¼ˆå¤‡ç”¨å®¡æ ¸å‘˜ï¼‰
            AccountId::from_ss58check("5FLSigC9HGRKVhB9FiEo4Y3koPsNmBmLJbpXg2mp1hXcS59Y")
                .expect("Valid reviewer account 3"),
        ]
    }
}

impl pallet_market_maker::Config for Runtime {
    // ... å…¶ä»–é…ç½® ...
    
    /// å®¡æ ¸å‘˜è´¦æˆ·åˆ—è¡¨
    type ReviewerAccounts = MarketMakerReviewers;
}
```

#### 3.1.5 æ–°å¢äº‹ä»¶

```rust
#[pallet::event]
#[pallet::generate_deposit(pub(super) fn deposit_event)]
pub enum Event<T: Config> {
    // ... ç°æœ‰äº‹ä»¶ ...
    
    /// ğŸ†• ç”³è¯·ä¿¡æ¯å·²æäº¤ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    InfoSubmitted {
        mm_id: u64,
        owner: T::AccountId,
        direction: Direction,
        masked_full_name: BoundedVec<u8, ConstU32<64>>,
        masked_id_card: BoundedVec<u8, ConstU32<32>>,
    },
    
    /// ğŸ†• å®¡æ ¸å‘˜å·²æ”¶åˆ°é€šçŸ¥
    ReviewersNotified(u64, u32), // (mm_id, reviewer_count)
    
    /// ğŸ†• å®¡æ ¸å‘˜é€šçŸ¥å¤±è´¥
    ReviewerNotificationFailed(u64, DispatchError), // (mm_id, error)
    
    /// ğŸ†• å®¡æ ¸å‘˜é€šçŸ¥éƒ¨åˆ†å¤±è´¥
    ReviewerNotificationPartialFailed(u64, T::AccountId), // (mm_id, failed_reviewer)
}
```

#### 3.1.6 æ–°å¢é”™è¯¯

```rust
#[pallet::error]
pub enum Error<T> {
    // ... ç°æœ‰é”™è¯¯ ...
    
    /// ğŸ†• æœªé…ç½®å®¡æ ¸å‘˜
    NoReviewersConfigured,
}
```

#### 3.1.7 æ–°å¢Config Trait

```rust
#[pallet::config]
pub trait Config: frame_system::Config + pallet_timestamp::Config {
    // ... ç°æœ‰é…ç½® ...
    
    /// ğŸ†• å®¡æ ¸å‘˜è´¦æˆ·åˆ—è¡¨
    /// - ç”¨äºæ¥æ”¶åšå¸‚å•†ç”³è¯·é€šçŸ¥
    /// - å¯é€šè¿‡æ²»ç†ä¿®æ”¹
    type ReviewerAccounts: Get<Vec<Self::AccountId>>;
}
```

---

### 3.2 æ–¹æ¡ˆBï¼šæ¿€è¿›æ–¹æ¡ˆï¼ˆä¸æ¨èï¼‰âŒ

**è®¾è®¡åŸåˆ™**ï¼š
- âŒ åˆ é™¤ `public_cid` å­—æ®µ
- âœ… å¿…å¡«å­—æ®µè°ƒæ•´
- âœ… å®¡æ ¸å‘˜èŠå¤©é€šçŸ¥

**é—®é¢˜**ï¼š
1. âŒ ç ´åæ•°æ®åˆ†çº§æ¶æ„
2. âŒ å‰ç«¯æ— æ³•å±•ç¤ºåšå¸‚å•†åˆ—è¡¨
3. âŒ ä¹°å®¶æ— æ³•é€‰æ‹©åšå¸‚å•†
4. âŒ è¿èƒŒåŒºå—é“¾é€æ˜åŸåˆ™

**ç»“è®º**ï¼š**ä¸æ¨èå®æ–½ï¼**

---

## å››ã€å®æ–½è®¡åˆ’

### 4.1 Phase 1ï¼šå­—æ®µè°ƒæ•´ä¸éªŒè¯ï¼ˆ1å‘¨ï¼‰

**ä»»åŠ¡**ï¼š
1. âœ… ä¿®æ”¹ `submit_info` å‡½æ•°ç­¾åï¼ˆOptionåŒ…è£…é€‰å¡«å­—æ®µï¼‰
2. âœ… æ›´æ–°å‚æ•°éªŒè¯é€»è¾‘
3. âœ… æ›´æ–°äº‹ä»¶å®šä¹‰
4. âœ… å•å…ƒæµ‹è¯•

**éªŒè¯**ï¼š
- å¿…å¡«å­—æ®µç¼ºå¤±æ—¶æŠ¥é”™
- é€‰å¡«å­—æ®µä¸ºNoneæ—¶æ­£å¸¸é€šè¿‡
- è‡ªåŠ¨è„±æ•åŠŸèƒ½æ­£å¸¸

---

### 4.2 Phase 2ï¼šå®¡æ ¸å‘˜ç®¡ç†ï¼ˆ1å‘¨ï¼‰

**ä»»åŠ¡**ï¼š
1. âœ… æ–°å¢ `ReviewerAccounts` Config
2. âœ… Runtimeé…ç½®å®¡æ ¸å‘˜åˆ—è¡¨
3. âœ… æ·»åŠ æ²»ç†æ¥å£ï¼ˆå¯é€‰ï¼‰
4. âœ… å®¡æ ¸å‘˜æƒé™éªŒè¯

**éªŒè¯**ï¼š
- å®¡æ ¸å‘˜åˆ—è¡¨æ­£ç¡®è¯»å–
- æ²»ç†å¯ä¿®æ”¹å®¡æ ¸å‘˜åˆ—è¡¨
- éå®¡æ ¸å‘˜æ— æ³•æ‰¹å‡†ç”³è¯·

---

### 4.3 Phase 3ï¼šèŠå¤©é€šçŸ¥é›†æˆï¼ˆ1-2å‘¨ï¼‰

**ä»»åŠ¡**ï¼š
1. âœ… å®ç° `notify_reviewers_on_submit` å‡½æ•°
2. âœ… é›†æˆ pallet-chat è°ƒç”¨
3. âœ… é”™è¯¯å¤„ç†ï¼ˆé€šçŸ¥å¤±è´¥ä¸å½±å“ç”³è¯·ï¼‰
4. âœ… äº‹ä»¶è®°å½•
5. âœ… å‰ç«¯ç›‘å¬

**éªŒè¯**ï¼š
- æäº¤ç”³è¯·åå®¡æ ¸å‘˜æ”¶åˆ°æ¶ˆæ¯
- æ¶ˆæ¯å†…å®¹åŒ…å«private_cidå¼•ç”¨
- é€šçŸ¥å¤±è´¥æ—¶è®°å½•äº‹ä»¶
- å‰ç«¯æ­£ç¡®è§£å¯†æ¶ˆæ¯

---

### 4.4 Phase 4ï¼šå‰ç«¯é€‚é…ï¼ˆ1å‘¨ï¼‰

**ä»»åŠ¡**ï¼š
1. âœ… æ›´æ–°ç”³è¯·è¡¨å•ï¼ˆæ ‡æ³¨å¿…å¡«/é€‰å¡«ï¼‰
2. âœ… å®¡æ ¸å‘˜èŠå¤©ç•Œé¢
3. âœ… æ¶ˆæ¯åŠ å¯†/è§£å¯†
4. âœ… é€šçŸ¥å±•ç¤º

**ç•Œé¢è®¾è®¡**ï¼š

```tsx
// åšå¸‚å•†ç”³è¯·è¡¨å•ï¼ˆå‰ç«¯ï¼‰
<Form>
  {/* å¿…å¡«å­—æ®µ */}
  <FormItem label="ä¸šåŠ¡æ–¹å‘" required>
    <Select options={['Buy', 'Sell', 'BuyAndSell']} />
  </FormItem>
  
  <FormItem label="TRONåœ°å€" required>
    <Input placeholder="ä»¥Tå¼€å¤´çš„34å­—ç¬¦åœ°å€" />
  </FormItem>
  
  <FormItem label="å®Œæ•´å§“å" required>
    <Input placeholder="å°†è‡ªåŠ¨è„±æ•ä¸º"å¼ Ã—ä¸‰"" />
  </FormItem>
  
  <FormItem label="å®Œæ•´èº«ä»½è¯å·" required>
    <Input placeholder="å°†è‡ªåŠ¨è„±æ•ä¸º"1101**********1234"" />
  </FormItem>
  
  <FormItem label="å…¬å¼€ä¿¡æ¯IPFS CID" required>
    <Upload onSuccess={(cid) => setPublicCid(cid)} />
  </FormItem>
  
  <FormItem label="æ•æ„Ÿä¿¡æ¯IPFS CID" required>
    <Upload 
      encrypt={true} 
      encryptFor={reviewerPublicKeys} 
      onSuccess={(cid) => setPrivateCid(cid)} 
    />
  </FormItem>
  
  {/* é€‰å¡«å­—æ®µ */}
  <FormItem label="è„±æ•æ”¶æ¬¾æ–¹å¼" optional>
    <PaymentMethodEditor />
  </FormItem>
  
  <Button onClick={handleSubmit}>æäº¤ç”³è¯·</Button>
</Form>

// å®¡æ ¸å‘˜èŠå¤©ç•Œé¢
<ReviewerChat>
  <MessageList>
    {messages.map(msg => (
      <SystemMessage key={msg.id}>
        <Icon type="notification" />
        <Content>
          <Title>æ–°çš„åšå¸‚å•†ç”³è¯· #{msg.mm_id}</Title>
          <Info>
            <div>ç”³è¯·äººï¼š{msg.applicant}</div>
            <div>æäº¤æ—¶é—´ï¼š{msg.submit_time}</div>
            <div>æ•æ„Ÿä¿¡æ¯CIDï¼š{msg.private_cid}</div>
          </Info>
          <Actions>
            <Button onClick={() => downloadPrivateInfo(msg.private_cid)}>
              æŸ¥çœ‹å®Œæ•´èµ„æ–™
            </Button>
            <Button type="primary" onClick={() => approve(msg.mm_id)}>
              æ‰¹å‡†
            </Button>
            <Button danger onClick={() => reject(msg.mm_id)}>
              é©³å›
            </Button>
          </Actions>
        </Content>
      </SystemMessage>
    ))}
  </MessageList>
</ReviewerChat>
```

---

### 4.5 Phase 5ï¼šæµ‹è¯•ä¸ä¸Šçº¿ï¼ˆ1å‘¨ï¼‰

**æµ‹è¯•å†…å®¹**ï¼š
1. âœ… å•å…ƒæµ‹è¯•ï¼ˆRustï¼‰
2. âœ… é›†æˆæµ‹è¯•ï¼ˆå‰ç«¯+é“¾ç«¯ï¼‰
3. âœ… ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆå®Œæ•´æµç¨‹ï¼‰
4. âœ… æ€§èƒ½æµ‹è¯•ï¼ˆæ¶ˆæ¯å‘é€å»¶è¿Ÿï¼‰
5. âœ… å®‰å…¨æµ‹è¯•ï¼ˆåŠ å¯†/è§£å¯†ï¼‰

**ä¸Šçº¿æ£€æŸ¥**ï¼š
- é…ç½®å®¡æ ¸å‘˜è´¦æˆ·
- å‰ç«¯éƒ¨ç½²
- æ–‡æ¡£æ›´æ–°
- ç”¨æˆ·åŸ¹è®­

---

## äº”ã€ä¼˜åŠ¿ä¸é£é™©

### 5.1 ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ |
|-----|------|
| âœ… **ä¿ç•™æ¶æ„å®Œæ•´æ€§** | public_cid + private_cid æ•°æ®åˆ†çº§ |
| âœ… **ç”¨æˆ·ä½“éªŒä¼˜åŒ–** | æ˜ç¡®å¿…å¡«/é€‰å¡«å­—æ®µ |
| âœ… **å®¡æ ¸æ•ˆç‡æå‡** | å³æ—¶èŠå¤©é€šçŸ¥ï¼Œæ— éœ€è½®è¯¢ |
| âœ… **å®‰å…¨æ€§å¢å¼º** | ç«¯åˆ°ç«¯åŠ å¯†ä¿æŠ¤æ•æ„Ÿä¿¡æ¯ |
| âœ… **å¯å®¡è®¡æ€§** | é“¾ä¸Šè®°å½•æ‰€æœ‰é€šçŸ¥äº‹ä»¶ |
| âœ… **ä½è€¦åˆè®¾è®¡** | é€šçŸ¥å¤±è´¥ä¸å½±å“ç”³è¯·æµç¨‹ |

---

### 5.2 é£é™©ä¸åº”å¯¹

| é£é™© | å½±å“ | åº”å¯¹æªæ–½ |
|-----|------|---------|
| âš ï¸ **å®¡æ ¸å‘˜ä¸åœ¨çº¿** | å®¡æ ¸å»¶è¿Ÿ | 1. é…ç½®å¤šä¸ªå®¡æ ¸å‘˜<br>2. é“¾ä¸‹é‚®ä»¶/çŸ­ä¿¡é€šçŸ¥<br>3. è¶…æ—¶æé†’ |
| âš ï¸ **æ¶ˆæ¯å‘é€å¤±è´¥** | å®¡æ ¸å‘˜æœªæ”¶åˆ°é€šçŸ¥ | 1. é‡è¯•æœºåˆ¶<br>2. äº‹ä»¶è®°å½•<br>3. é“¾ä¸‹ç›‘æ§ |
| âš ï¸ **å®¡æ ¸å‘˜è´¦æˆ·æ³„éœ²** | è¢«æ»¥å‘æ¶ˆæ¯ | 1. Gasè´¹ç”¨é˜²æŠ¤<br>2. é™åˆ¶å‘é€é¢‘ç‡<br>3. é»‘åå•æœºåˆ¶ |
| âš ï¸ **åŠ å¯†å¯†é’¥ä¸¢å¤±** | æ— æ³•è§£å¯†æ¶ˆæ¯ | 1. å¤šå®¡æ ¸å‘˜å¤‡ä»½<br>2. å¯†é’¥æ¢å¤æœºåˆ¶<br>3. é“¾ä¸‹å­˜å‚¨å¤‡ä»½ |

---

## å…­ã€æ€»ç»“ä¸å»ºè®®

### 6.1 éœ€æ±‚å¯è¡Œæ€§è¯„ä¼°

| éœ€æ±‚ | å¯è¡Œæ€§ | åˆç†æ€§ | å»ºè®® |
|-----|--------|--------|------|
| **åˆ é™¤ public_cid** | âŒ æŠ€æœ¯å¯è¡Œ | âŒ ä¸åˆç† | **å¼ºçƒˆä¸å»ºè®®**ï¼Œç ´åæ¶æ„ |
| **å¿…å¡«å­—æ®µè°ƒæ•´** | âœ… å®Œå…¨å¯è¡Œ | âœ… åˆç† | **å»ºè®®å®æ–½**ï¼Œæ”¹è¿›UX |
| **å®¡æ ¸å‘˜èŠå¤©é€šçŸ¥** | âœ… å®Œå…¨å¯è¡Œ | âœ… åˆç†ä¸”åˆ›æ–° | **å¼ºçƒˆå»ºè®®**ï¼Œæå‡æ•ˆç‡ |

---

### 6.2 æ¨èæ–¹æ¡ˆ

**é‡‡ç”¨æ–¹æ¡ˆAï¼ˆä¿å®ˆæ–¹æ¡ˆï¼‰**ï¼š
1. âœ… **ä¿ç•™ `public_cid` å­—æ®µ**ï¼ˆæ•°æ®åˆ†çº§æ¶æ„ä¸å˜ï¼‰
2. âœ… **ä¼˜åŒ–å¿…å¡«/é€‰å¡«å­—æ®µ**ï¼ˆç”¨OptionåŒ…è£…é€‰å¡«å­—æ®µï¼‰
3. âœ… **é›†æˆå®¡æ ¸å‘˜èŠå¤©é€šçŸ¥**ï¼ˆpallet-chaté›†æˆï¼‰

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… æ¶æ„å®Œæ•´æ€§ï¼šæ•°æ®åˆ†çº§æ¸…æ™°
- âœ… ç”¨æˆ·ä½“éªŒï¼šè¡¨å•æ›´ç®€æ´
- âœ… å®¡æ ¸æ•ˆç‡ï¼šå³æ—¶é€šçŸ¥ï¼Œå¿«é€Ÿå“åº”
- âœ… å®‰å…¨æ€§ï¼šç«¯åˆ°ç«¯åŠ å¯†ä¿æŠ¤
- âœ… å¯ç»´æŠ¤æ€§ï¼šä½è€¦åˆè®¾è®¡

---

### 6.3 å®æ–½å»ºè®®

**ä¼˜å…ˆçº§æ’åº**ï¼š
1. **ç¬¬1ä¼˜å…ˆ**ï¼šå­—æ®µè°ƒæ•´ä¸éªŒè¯ï¼ˆ1å‘¨ï¼‰
2. **ç¬¬2ä¼˜å…ˆ**ï¼šå®¡æ ¸å‘˜ç®¡ç†ï¼ˆ1å‘¨ï¼‰
3. **ç¬¬3ä¼˜å…ˆ**ï¼šèŠå¤©é€šçŸ¥é›†æˆï¼ˆ1-2å‘¨ï¼‰
4. **ç¬¬4ä¼˜å…ˆ**ï¼šå‰ç«¯é€‚é…ï¼ˆ1å‘¨ï¼‰
5. **ç¬¬5ä¼˜å…ˆ**ï¼šæµ‹è¯•ä¸ä¸Šçº¿ï¼ˆ1å‘¨ï¼‰

**æ€»æ—¶é—´**ï¼š5-6å‘¨

**é£é™©ç­‰çº§**ï¼šä½ï¼ˆæ¸è¿›å¼å®æ–½ï¼Œå‘åå…¼å®¹ï¼‰

---

## ä¸ƒã€å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### Q1ï¼šä¸ºä»€ä¹ˆä¸èƒ½åˆ é™¤ `public_cid`ï¼Ÿ

**A**ï¼š`public_cid` æ˜¯æ•°æ®åˆ†çº§æ¶æ„çš„æ ¸å¿ƒï¼š
- âœ… å­˜å‚¨å…¬å¼€ä¿¡æ¯ï¼ˆè„±æ•åçš„å§“åã€èº«ä»½è¯ã€æ”¶æ¬¾æ–¹å¼ï¼‰
- âœ… ä¾›å‰ç«¯å±•ç¤ºåšå¸‚å•†åˆ—è¡¨
- âœ… ä¾›ä¹°å®¶é€‰æ‹©åšå¸‚å•†
- âœ… ç¬¦åˆåŒºå—é“¾é€æ˜åŸåˆ™

åˆ é™¤åï¼Œæ‰€æœ‰ä¿¡æ¯éƒ½å­˜ `private_cid`ï¼Œä¹°å®¶æ— æ³•é€‰æ‹©åšå¸‚å•†ï¼Œå‰ç«¯æ— æ³•å·¥ä½œã€‚

---

### Q2ï¼šå®¡æ ¸å‘˜å¦‚ä½•é…ç½®ï¼Ÿ

**A**ï¼šä¸‰ç§æ–¹å¼ï¼š
1. **Runtimeé…ç½®**ï¼ˆæ¨èï¼‰ï¼šå›ºå®šå®¡æ ¸å‘˜åˆ—è¡¨ï¼Œéœ€è¦å‡çº§Runtimeä¿®æ”¹
2. **æ²»ç†é…ç½®**ï¼šé€šè¿‡ææ¡ˆæ·»åŠ /ç§»é™¤å®¡æ ¸å‘˜
3. **å§”å‘˜ä¼šè‡ªåŠ¨**ï¼šå†…å®¹å§”å‘˜ä¼šæˆå‘˜è‡ªåŠ¨æˆä¸ºå®¡æ ¸å‘˜

æ¨èæ–¹å¼1ï¼Œç®€å•å¯é ã€‚

---

### Q3ï¼šå®¡æ ¸å‘˜ä¸åœ¨çº¿æ€ä¹ˆåŠï¼Ÿ

**A**ï¼šå¤šå±‚ä¿éšœï¼š
1. é…ç½®3ä¸ªå®¡æ ¸å‘˜ï¼Œä»»æ„ä¸€ä¸ªåœ¨çº¿å³å¯
2. é“¾ä¸‹ç›‘æ§+é‚®ä»¶/çŸ­ä¿¡é€šçŸ¥
3. è¶…æ—¶è‡ªåŠ¨æé†’ï¼ˆ7å¤©æœªå®¡æ ¸ï¼‰
4. å‰ç«¯æ˜¾ç¤ºå®¡æ ¸è¿›åº¦

---

### Q4ï¼šæ¶ˆæ¯å‘é€å¤±è´¥ä¼šå½±å“ç”³è¯·å—ï¼Ÿ

**A**ï¼šä¸ä¼šã€‚é€šçŸ¥æ˜¯"å°½åŠ›è€Œä¸º"ï¼ˆbest-effortï¼‰ï¼š
- é€šçŸ¥å¤±è´¥è®°å½•äº‹ä»¶ï¼Œä¸å½±å“ç”³è¯·æµç¨‹
- ç”³è¯·çŠ¶æ€æ­£å¸¸å˜æ›´ä¸º"PendingReview"
- é“¾ä¸‹ç›‘æ§å¯è¡¥å‘é€šçŸ¥
- å®¡æ ¸å‘˜ä¹Ÿå¯ä¸»åŠ¨æŸ¥è¯¢å¾…å®¡æ ¸åˆ—è¡¨

---

### Q5ï¼šå¦‚ä½•é˜²æ­¢æ»¥å‘æ¶ˆæ¯ï¼Ÿ

**A**ï¼šå¤šé‡é˜²æŠ¤ï¼š
1. **é™åˆ¶å‘é€åœºæ™¯**ï¼šåªèƒ½åœ¨ `submit_info` æ—¶å‘é€
2. **é™åˆ¶å‘é€æ¬¡æ•°**ï¼šæ¯ä¸ªç”³è¯·åªå‘é€ä¸€æ¬¡
3. **Gasè´¹ç”¨**ï¼šå‘é€æ¶ˆæ¯éœ€è¦Gasï¼Œé˜²æ­¢spam
4. **é¢‘ç‡é™åˆ¶**ï¼šæ¯ä¸ªç”¨æˆ·æ¯å¤©æœ€å¤šæäº¤Næ¬¡ç”³è¯·

---

**æ–‡æ¡£å®Œæˆï¼** ğŸ‰

**æ ¸å¿ƒå»ºè®®**ï¼š
- âŒ ä¸è¦åˆ é™¤ `public_cid`ï¼ˆç ´åæ¶æ„ï¼‰
- âœ… ä¼˜åŒ–å¿…å¡«/é€‰å¡«å­—æ®µï¼ˆæ”¹è¿›UXï¼‰
- âœ… é›†æˆå®¡æ ¸å‘˜èŠå¤©é€šçŸ¥ï¼ˆåˆ›æ–°åŠŸèƒ½ï¼‰

éœ€è¦æˆ‘ç«‹å³å¼€å§‹å®æ–½æ–¹æ¡ˆAå—ï¼ŸğŸš€

