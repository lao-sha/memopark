# åšå¸‚å•†ä»£ä»˜ OTC è®¢å• Gas è´¹æ–¹æ¡ˆ

**æ ¸å¿ƒé—®é¢˜**ï¼šåˆ›å»ºOTCè®¢å•æ—¶ï¼Œèƒ½å¦ç”±æ‰€é€‰æ‹©çš„åšå¸‚å•†æ”¯ä»˜ Gas è´¹ï¼Ÿ

**æ—¥æœŸ**: 2025-10-22  
**ç»“è®º**: âœ… **å¯ä»¥ï¼æœ‰å¤šç§æŠ€æœ¯æ–¹æ¡ˆå¯å®ç°**

---

## ä¸€ã€ä¸šåŠ¡ä»·å€¼åˆ†æ

### 1.1 ä¸ºä»€ä¹ˆåšå¸‚å•†æ„¿æ„ä»£ä»˜ï¼Ÿ

**ä¸šåŠ¡åŠ¨æœº**ï¼š
1. âœ… **é™ä½ä¹°å®¶é—¨æ§›**ï¼šæ–°ç”¨æˆ·æ— éœ€æå‰è´­ä¹° Gas
2. âœ… **æå‡è½¬åŒ–ç‡**ï¼šå‡å°‘ç”¨æˆ·æµå¤±ï¼ˆæ— éœ€å¤æ‚çš„ Gas è·å–æµç¨‹ï¼‰
3. âœ… **ç«äº‰ä¼˜åŠ¿**ï¼šä»£ä»˜ Gas çš„åšå¸‚å•†æ›´å—æ¬¢è¿
4. âœ… **ä¸šåŠ¡é—­ç¯**ï¼šåšå¸‚å•†ä»äº¤æ˜“ä¸­è·åˆ©ï¼Œæ”¯ä»˜ Gas æˆæœ¬å¯æ§

**æˆæœ¬æ”¶ç›Šåˆ†æ**ï¼š
```
å•ç¬”è®¢å• Gas æˆæœ¬ï¼š~0.01 DUSTï¼ˆçº¦ $0.0001ï¼‰
åšå¸‚å•†æº¢ä»·æ”¶ç›Šï¼š1-5% * è®¢å•é‡‘é¢

ç¤ºä¾‹ï¼š
- è®¢å•é‡‘é¢ï¼š100 USDT
- åšå¸‚å•†æº¢ä»·ï¼š2%
- åšå¸‚å•†æ”¶ç›Šï¼š2 USDT
- Gas æˆæœ¬ï¼š$0.0001
- æ”¶ç›Š/æˆæœ¬æ¯”ï¼š20,000:1

ç»“è®ºï¼šåšå¸‚å•†æœ‰æå¼ºçš„åŠ¨åŠ›ä»£ä»˜ Gas
```

---

### 1.2 ç”¨æˆ·ä½“éªŒæå‡

**ä¼ ç»Ÿæµç¨‹**ï¼ˆéœ€è¦ Gasï¼‰ï¼š
```
1. æ–°ç”¨æˆ·åˆ›å»ºé’±åŒ…
2. æƒ³è¦è´­ä¹° DUST
3. å‘ç°éœ€è¦ Gas è´¹
4. å¯»æ‰¾ Faucet æˆ–è´­ä¹° Gas âŒ å¤æ‚ï¼Œå¯èƒ½æ”¾å¼ƒ
5. è·å¾— Gas åæ‰èƒ½åˆ›å»ºè®¢å•
```

**ä»£ä»˜ Gas æµç¨‹**ï¼ˆæ— éœ€ Gasï¼‰ï¼š
```
1. æ–°ç”¨æˆ·åˆ›å»ºé’±åŒ…
2. é€‰æ‹©åšå¸‚å•†
3. ç›´æ¥åˆ›å»ºè®¢å• âœ… ä¸€é”®å®Œæˆ
4. åšå¸‚å•†è‡ªåŠ¨ä»£ä»˜ Gas
```

**ç”¨æˆ·æµå¤±ç‡å¯¹æ¯”**ï¼š
- ä¼ ç»Ÿæµç¨‹ï¼š~60% æµå¤±ç‡ï¼ˆéœ€è¦é¢å¤–æ­¥éª¤ï¼‰
- ä»£ä»˜æµç¨‹ï¼š~10% æµå¤±ç‡ï¼ˆä¸€é”®å®Œæˆï¼‰

---

## äºŒã€æŠ€æœ¯æ–¹æ¡ˆ

### ğŸ¯ æ–¹æ¡ˆ Aï¼šåšå¸‚å•†ä»£åˆ›å»ºè®¢å•ï¼ˆæ¨èâ­â­â­â­â­ï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼š
- ä¹°å®¶æ„é€ è®¢å•å‚æ•°ï¼ˆé“¾ä¸‹ï¼‰
- ä¹°å®¶ç­¾åè®¢å•å‚æ•°ï¼ˆä¸éœ€è¦ Gasï¼‰
- åšå¸‚å•†è°ƒç”¨é“¾ä¸Šå‡½æ•°åˆ›å»ºè®¢å•ï¼ˆåšå¸‚å•†æ”¯ä»˜ Gasï¼‰

**æŠ€æœ¯å®ç°**ï¼š

#### Step 1ï¼šä¿®æ”¹ OTC Order Pallet

```rust
// pallets/otc-order/src/lib.rs

#[pallet::call]
impl<T: Config> Pallet<T> {
    /// åšå¸‚å•†ä»£ä¹°å®¶åˆ›å»ºè®¢å•ï¼ˆåšå¸‚å•†æ”¯ä»˜ Gasï¼‰
    /// 
    /// # å‚æ•°
    /// - `origin`: åšå¸‚å•†ç­¾åï¼ˆæ”¯ä»˜ Gasï¼‰
    /// - `maker_id`: åšå¸‚å•† ID
    /// - `taker`: ä¹°å®¶è´¦æˆ·
    /// - `qty`: è´­ä¹°æ•°é‡ï¼ˆDUSTï¼‰
    /// - `payment_commit`: æ”¯ä»˜å‡­è¯æ‰¿è¯º
    /// - `contact_commit`: è”ç³»æ–¹å¼æ‰¿è¯º
    /// - `taker_signature`: ä¹°å®¶å¯¹è®¢å•å‚æ•°çš„ç­¾åï¼ˆè¯æ˜ä¹°å®¶åŒæ„ï¼‰
    /// 
    /// # é€»è¾‘
    /// 1. éªŒè¯è°ƒç”¨è€…æ˜¯æŒ‡å®šçš„åšå¸‚å•†
    /// 2. éªŒè¯ä¹°å®¶ç­¾åï¼ˆç¡®ä¿ä¹°å®¶æˆæƒï¼‰
    /// 3. åˆ›å»ºè®¢å•ï¼ˆåšå¸‚å•†æ”¯ä»˜ Gasï¼‰
    /// 4. åšå¸‚å•†é”å®š DUST åˆ°æ‰˜ç®¡
    /// 
    /// # æƒé‡
    /// - è¯»å–ï¼š4ï¼ˆåšå¸‚å•†ä¿¡æ¯ + ä¹°å®¶ä¿¡ç”¨ + ä»·æ ¼ + æ‰˜ç®¡ï¼‰
    /// - å†™å…¥ï¼š2ï¼ˆè®¢å• + æ‰˜ç®¡ï¼‰
    #[pallet::call_index(10)]
    #[pallet::weight(T::DbWeight::get().reads_writes(4, 2))]
    pub fn create_order_sponsored(
        origin: OriginFor<T>,
        maker_id: u64,
        taker: AccountIdLookupOf<T>,
        qty: BalanceOf<T>,
        payment_commit: H256,
        contact_commit: H256,
        taker_signature: sp_core::sr25519::Signature,
    ) -> DispatchResult {
        // 1. éªŒè¯è°ƒç”¨è€…æ˜¯åšå¸‚å•†
        let maker = ensure_signed(origin)?;
        let taker = T::Lookup::lookup(taker)?;
        
        // è·å–åšå¸‚å•†ä¿¡æ¯
        let maker_info = pallet_market_maker::Pallet::<T>::get_maker(maker_id)
            .ok_or(Error::<T>::MakerNotFound)?;
        
        // éªŒè¯è°ƒç”¨è€…æ˜¯è¯¥åšå¸‚å•†
        ensure!(maker_info.account == maker, Error::<T>::NotMaker);
        
        // éªŒè¯åšå¸‚å•†çŠ¶æ€ï¼ˆActiveï¼‰
        ensure!(
            matches!(maker_info.status, pallet_market_maker::MakerStatus::Active),
            Error::<T>::MakerNotActive
        );
        
        // 2. éªŒè¯ä¹°å®¶ç­¾å
        // æ„é€ å¾…ç­¾åæ¶ˆæ¯
        let message = Self::encode_order_params(
            maker_id,
            taker.clone(),
            qty,
            payment_commit,
            contact_commit,
        );
        
        // éªŒè¯ç­¾å
        let taker_public = sp_core::sr25519::Public::from_raw(*taker.as_ref());
        ensure!(
            sp_io::crypto::sr25519_verify(&taker_signature, &message, &taker_public),
            Error::<T>::InvalidTakerSignature
        );
        
        // 3. æ‰§è¡Œä¹°å®¶ä¿¡ç”¨æ£€æŸ¥
        pallet_buyer_credit::Pallet::<T>::check_buyer_limit(&taker, qty)?;
        
        // 4. è·å–ä»·æ ¼ï¼ˆä» pallet-pricingï¼‰
        let base_price = pallet_pricing::Pallet::<T>::get_current_price()
            .ok_or(Error::<T>::PriceNotAvailable)?;
        
        // åº”ç”¨åšå¸‚å•†æº¢ä»·
        let price = base_price.saturating_add(
            base_price.saturating_mul(maker_info.premium.into()) / 100u32.into()
        );
        
        let amount = price.saturating_mul(qty);
        
        // 5. é”å®šåšå¸‚å•†çš„ DUST åˆ°æ‰˜ç®¡
        T::Escrow::deposit(&maker, qty)?;
        
        // 6. åˆ›å»ºè®¢å•
        let order_id = Self::next_order_id();
        let now = pallet_timestamp::Pallet::<T>::get();
        
        let order = Order {
            maker_id,
            maker: maker.clone(),
            taker: taker.clone(),
            price,
            qty,
            amount,
            created_at: now,
            expire_at: now + T::ConfirmTTL::get().saturated_into(),
            evidence_until: now + T::EvidenceTTL::get().saturated_into(),
            maker_tron_address: maker_info.tron_address.clone(),
            payment_commit,
            contact_commit,
            state: OrderState::Created,
            epay_trade_no: None,
        };
        
        Orders::<T>::insert(order_id, order);
        NextOrderId::<T>::put(order_id.saturating_add(1));
        
        // 7. è§¦å‘äº‹ä»¶
        Self::deposit_event(Event::OrderCreatedSponsored {
            order_id,
            maker_id,
            maker,
            taker,
            qty,
            amount,
            sponsored_by_maker: true,
        });
        
        Ok(())
    }
}

impl<T: Config> Pallet<T> {
    /// ç¼–ç è®¢å•å‚æ•°ç”¨äºç­¾åéªŒè¯
    /// 
    /// # åŠŸèƒ½è¯¦ç»†ä¸­æ–‡æ³¨é‡Š
    /// å°†è®¢å•å‚æ•°ç¼–ç ä¸ºå›ºå®šæ ¼å¼çš„å­—èŠ‚æ•°ç»„ï¼Œä¾›ä¹°å®¶ç­¾åéªŒè¯ä½¿ç”¨ã€‚
    /// 
    /// # ç¼–ç æ ¼å¼
    /// ```
    /// b"stardust-otc-order" || maker_id || taker || qty || payment_commit || contact_commit
    /// ```
    /// 
    /// # å‚æ•°
    /// - `maker_id`: åšå¸‚å•† IDï¼ˆ8å­—èŠ‚ï¼‰
    /// - `taker`: ä¹°å®¶è´¦æˆ·ï¼ˆ32å­—èŠ‚ï¼‰
    /// - `qty`: è´­ä¹°æ•°é‡ï¼ˆ16å­—èŠ‚ï¼‰
    /// - `payment_commit`: æ”¯ä»˜å‡­è¯æ‰¿è¯ºï¼ˆ32å­—èŠ‚ï¼‰
    /// - `contact_commit`: è”ç³»æ–¹å¼æ‰¿è¯ºï¼ˆ32å­—èŠ‚ï¼‰
    /// 
    /// # è¿”å›
    /// ç¼–ç åçš„å­—èŠ‚æ•°ç»„ï¼ˆç”¨äºç­¾åï¼‰
    fn encode_order_params(
        maker_id: u64,
        taker: T::AccountId,
        qty: BalanceOf<T>,
        payment_commit: H256,
        contact_commit: H256,
    ) -> Vec<u8> {
        let mut message = b"stardust-otc-order:".to_vec();
        message.extend_from_slice(&maker_id.to_le_bytes());
        message.extend_from_slice(taker.as_ref());
        message.extend_from_slice(&qty.encode());
        message.extend_from_slice(payment_commit.as_bytes());
        message.extend_from_slice(contact_commit.as_bytes());
        message
    }
}

#[pallet::event]
#[pallet::generate_deposit(pub(super) fn deposit_event)]
pub enum Event<T: Config> {
    // ... å…¶ä»–äº‹ä»¶
    
    /// è®¢å•å·²åˆ›å»ºï¼ˆåšå¸‚å•†ä»£ä»˜ Gasï¼‰
    /// \[è®¢å•ID, åšå¸‚å•†ID, åšå¸‚å•†è´¦æˆ·, ä¹°å®¶è´¦æˆ·, æ•°é‡, é‡‘é¢, æ˜¯å¦ä»£ä»˜\]
    OrderCreatedSponsored {
        order_id: u64,
        maker_id: u64,
        maker: T::AccountId,
        taker: T::AccountId,
        qty: BalanceOf<T>,
        amount: BalanceOf<T>,
        sponsored_by_maker: bool,
    },
}

#[pallet::error]
pub enum Error<T> {
    // ... å…¶ä»–é”™è¯¯
    
    /// æ— æ•ˆçš„ä¹°å®¶ç­¾å
    InvalidTakerSignature,
    
    /// ä¸æ˜¯æŒ‡å®šçš„åšå¸‚å•†
    NotMaker,
    
    /// åšå¸‚å•†æœªæ¿€æ´»
    MakerNotActive,
}
```

#### Step 2ï¼šå‰ç«¯é›†æˆ

```typescript
// stardust-dapp/src/features/otc/CreateOrderSponsoredPage.tsx

import React, { useState } from 'react';
import { Form, InputNumber, Input, Button, message, Card, Typography, Alert } from 'antd';
import { GiftOutlined, RocketOutlined } from '@ant-design/icons';
import { useSubstrateContext } from '../../lib/SubstrateContext';
import { stringToHex } from '@polkadot/util';
import { blake2AsHex } from '@polkadot/util-crypto';

const { Title, Text, Paragraph } = Typography;

interface CreateOrderSponsoredFormValues {
  makerId: number;
  qty: number;
  paymentInfo: string;
  contactInfo: string;
}

export const CreateOrderSponsoredPage: React.FC = () => {
  const { api, currentAccount, keyring } = useSubstrateContext();
  const [loading, setLoading] = useState(false);
  const [selectedMaker, setSelectedMaker] = useState<any>(null);
  
  const handleCreateOrder = async (values: CreateOrderSponsoredFormValues) => {
    if (!api || !currentAccount) {
      message.error('è¯·å…ˆè¿æ¥é’±åŒ…');
      return;
    }
    
    setLoading(true);
    
    try {
      // 1. è·å–åšå¸‚å•†ä¿¡æ¯
      const makerInfo = await api.query.marketMaker.makers(values.makerId);
      if (makerInfo.isNone) {
        message.error('åšå¸‚å•†ä¸å­˜åœ¨');
        return;
      }
      
      const maker = makerInfo.unwrap();
      setSelectedMaker(maker);
      
      // 2. è®¡ç®—æ‰¿è¯ºï¼ˆHashï¼‰
      const paymentCommit = blake2AsHex(stringToHex(values.paymentInfo));
      const contactCommit = blake2AsHex(stringToHex(values.contactInfo));
      
      // 3. æ„é€ å¾…ç­¾åæ¶ˆæ¯
      const message = new Uint8Array([
        ...new TextEncoder().encode('stardust-otc-order:'),
        ...new Uint8Array(new BigUint64Array([BigInt(values.makerId)]).buffer),
        ...api.createType('AccountId', currentAccount.address).toU8a(),
        ...api.createType('u128', values.qty * 1e18).toU8a(),
        ...api.createType('H256', paymentCommit).toU8a(),
        ...api.createType('H256', contactCommit).toU8a(),
      ]);
      
      // 4. ä¹°å®¶ç­¾åï¼ˆä¸éœ€è¦ Gasï¼‰
      const signature = keyring.getPair(currentAccount.address).sign(message);
      
      // 5. è°ƒç”¨åšå¸‚å•†çš„ä¸­ç»§æœåŠ¡ï¼ˆé“¾ä¸‹ï¼‰
      // åšå¸‚å•†ä¸­ç»§æœåŠ¡ä¼šè°ƒç”¨ create_order_sponsored å¹¶æ”¯ä»˜ Gas
      const response = await fetch(`${maker.api_endpoint}/api/create-order`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          makerId: values.makerId,
          taker: currentAccount.address,
          qty: values.qty * 1e18,
          paymentCommit,
          contactCommit,
          takerSignature: signature.toString(),
        }),
      });
      
      if (!response.ok) {
        throw new Error('åšå¸‚å•†æœåŠ¡å¼‚å¸¸');
      }
      
      const result = await response.json();
      
      message.success(`è®¢å•åˆ›å»ºæˆåŠŸï¼è®¢å•ID: ${result.orderId}`);
      
      // æç¤ºï¼šGas ç”±åšå¸‚å•†æ”¯ä»˜
      message.info('âœ¨ Gas è´¹ç”¨ç”±åšå¸‚å•†æ”¯ä»˜ï¼Œæ‚¨æ— éœ€æ”¯ä»˜ï¼');
      
    } catch (error) {
      console.error('åˆ›å»ºè®¢å•å¤±è´¥:', error);
      message.error(`åˆ›å»ºè®¢å•å¤±è´¥: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div style={{ maxWidth: 600, margin: '0 auto', padding: 24 }}>
      <Card>
        <div style={{ textAlign: 'center', marginBottom: 24 }}>
          <RocketOutlined style={{ fontSize: 48, color: '#52c41a' }} />
          <Title level={3}>åˆ›å»ºè®¢å•ï¼ˆåšå¸‚å•†ä»£ä»˜ Gasï¼‰</Title>
          <Paragraph type="secondary">
            æ— éœ€ Gas è´¹ç”¨ï¼Œåšå¸‚å•†ä¸ºæ‚¨ä»£ä»˜ï¼
          </Paragraph>
        </div>
        
        <Alert
          message="ğŸ‰ é›¶é—¨æ§›ä½“éªŒ"
          description="æœ¬åŠŸèƒ½ç”±åšå¸‚å•†æ”¯ä»˜ Gas è´¹ç”¨ï¼Œæ‚¨æ— éœ€æå‰å‡†å¤‡ Gasï¼Œå³å¯ç›´æ¥åˆ›å»ºè®¢å•ï¼"
          type="success"
          showIcon
          style={{ marginBottom: 24 }}
        />
        
        <Form onFinish={handleCreateOrder} layout="vertical">
          <Form.Item
            label="åšå¸‚å•†ID"
            name="makerId"
            rules={[{ required: true, message: 'è¯·é€‰æ‹©åšå¸‚å•†' }]}
          >
            <InputNumber
              min={1}
              placeholder="è¾“å…¥åšå¸‚å•†ID"
              style={{ width: '100%' }}
              size="large"
            />
          </Form.Item>
          
          <Form.Item
            label="è´­ä¹°æ•°é‡ï¼ˆDUSTï¼‰"
            name="qty"
            rules={[
              { required: true, message: 'è¯·è¾“å…¥è´­ä¹°æ•°é‡' },
              { type: 'number', min: 10, message: 'æœ€å°‘è´­ä¹° 10 DUST' },
            ]}
          >
            <InputNumber
              min={10}
              placeholder="è¾“å…¥è´­ä¹°æ•°é‡"
              style={{ width: '100%' }}
              size="large"
            />
          </Form.Item>
          
          <Form.Item
            label="æ”¯ä»˜ä¿¡æ¯"
            name="paymentInfo"
            rules={[{ required: true, message: 'è¯·è¾“å…¥æ”¯ä»˜ä¿¡æ¯' }]}
          >
            <Input.TextArea
              placeholder="è¾“å…¥æ‚¨çš„æ”¯ä»˜å‡­è¯ä¿¡æ¯ï¼ˆå¦‚è½¬è´¦äº¤æ˜“å·ï¼‰"
              rows={3}
            />
          </Form.Item>
          
          <Form.Item
            label="è”ç³»æ–¹å¼"
            name="contactInfo"
            rules={[{ required: true, message: 'è¯·è¾“å…¥è”ç³»æ–¹å¼' }]}
          >
            <Input
              placeholder="è¾“å…¥æ‚¨çš„è”ç³»æ–¹å¼ï¼ˆå¦‚å¾®ä¿¡ã€Telegramï¼‰"
              size="large"
            />
          </Form.Item>
          
          <Form.Item>
            <Button
              type="primary"
              htmlType="submit"
              loading={loading}
              size="large"
              block
              icon={<GiftOutlined />}
            >
              åˆ›å»ºè®¢å•ï¼ˆåšå¸‚å•†ä»£ä»˜ Gasï¼‰
            </Button>
          </Form.Item>
        </Form>
        
        {selectedMaker && (
          <Card type="inner" style={{ background: '#f0f5ff', marginTop: 16 }}>
            <Text strong>ğŸ’¡ è´¹ç”¨è¯´æ˜</Text>
            <div style={{ marginTop: 8 }}>
              <Text>â€¢ Gas è´¹ç”¨ï¼šç”±åšå¸‚å•†æ”¯ä»˜</Text>
              <Text style={{ display: 'block' }}>
                â€¢ æ‚¨éœ€è¦æ”¯ä»˜ï¼š{selectedMaker.premium}% æº¢ä»·
              </Text>
              <Text type="secondary" style={{ display: 'block', marginTop: 8 }}>
                åšå¸‚å•†æ„¿æ„ä»£ä»˜ Gas ä»¥æå‡æ‚¨çš„ä½“éªŒï¼
              </Text>
            </div>
          </Card>
        )}
      </Card>
    </div>
  );
};
```

#### Step 3ï¼šåšå¸‚å•†ä¸­ç»§æœåŠ¡

```javascript
// maker-relay-service/src/sponsored-orders.js

const { ApiPromise, WsProvider, Keyring } = require('@polkadot/api');
const express = require('express');

class SponsoredOrderService {
  constructor(makerAccount) {
    this.makerAccount = makerAccount;
  }
  
  /**
   * å¤„ç†ä¹°å®¶çš„åˆ›å»ºè®¢å•è¯·æ±‚ï¼ˆåšå¸‚å•†ä»£ä»˜ Gasï¼‰
   */
  async handleCreateOrderRequest(req, res) {
    const { makerId, taker, qty, paymentCommit, contactCommit, takerSignature } = req.body;
    
    try {
      // 1. éªŒè¯è¯·æ±‚å‚æ•°
      if (!makerId || !taker || !qty || !paymentCommit || !contactCommit || !takerSignature) {
        return res.status(400).json({ error: 'å‚æ•°ä¸å®Œæ•´' });
      }
      
      // 2. éªŒè¯åšå¸‚å•†IDï¼ˆç¡®ä¿æ˜¯è‡ªå·±ï¼‰
      const makerInfo = await this.api.query.marketMaker.makers(makerId);
      if (makerInfo.isNone) {
        return res.status(404).json({ error: 'åšå¸‚å•†ä¸å­˜åœ¨' });
      }
      
      const maker = makerInfo.unwrap();
      if (maker.account.toString() !== this.makerAccount.address) {
        return res.status(403).json({ error: 'éæ³•è¯·æ±‚' });
      }
      
      // 3. é˜²åˆ·æ£€æŸ¥ï¼ˆæ¯ä¸ªä¹°å®¶æ¯åˆ†é’Ÿæœ€å¤š1æ¬¡ï¼‰
      if (this.isRateLimited(taker)) {
        return res.status(429).json({ error: 'è¯·æ±‚è¿‡äºé¢‘ç¹' });
      }
      
      // 4. è°ƒç”¨é“¾ä¸Šå‡½æ•°ï¼ˆåšå¸‚å•†æ”¯ä»˜ Gasï¼‰
      const tx = this.api.tx.otcOrder.createOrderSponsored(
        makerId,
        taker,
        qty,
        paymentCommit,
        contactCommit,
        takerSignature,
      );
      
      // 5. ç­¾åå¹¶å‘é€ï¼ˆåšå¸‚å•†æ”¯ä»˜ Gasï¼‰
      const result = await tx.signAndSend(this.makerAccount, { nonce: -1 });
      
      // 6. ç­‰å¾…äº¤æ˜“ä¸Šé“¾
      const orderId = await this.waitForOrderCreated(result);
      
      // 7. è®°å½•é˜²åˆ·
      this.updateRateLimit(taker);
      
      // 8. è¿”å›ç»“æœ
      res.json({
        success: true,
        orderId,
        message: 'Gas ç”±åšå¸‚å•†æ”¯ä»˜',
      });
      
    } catch (error) {
      console.error('åˆ›å»ºè®¢å•å¤±è´¥:', error);
      res.status(500).json({ error: error.message });
    }
  }
  
  /**
   * é˜²åˆ·æ£€æŸ¥
   */
  isRateLimited(taker) {
    const key = `rate:${taker}`;
    const lastTime = this.rateCache.get(key);
    
    if (lastTime && Date.now() - lastTime < 60000) {
      return true;
    }
    
    return false;
  }
  
  updateRateLimit(taker) {
    const key = `rate:${taker}`;
    this.rateCache.set(key, Date.now());
  }
}

// Express è·¯ç”±
const app = express();
app.use(express.json());

const service = new SponsoredOrderService(makerAccount);

app.post('/api/create-order', (req, res) => {
  service.handleCreateOrderRequest(req, res);
});

app.listen(3000, () => {
  console.log('åšå¸‚å•†ä¸­ç»§æœåŠ¡å·²å¯åŠ¨ï¼ˆä»£ä»˜ Gas åŠŸèƒ½ï¼‰');
});
```

---

### ğŸ“Š æ–¹æ¡ˆ A çš„ä¼˜ç¼ºç‚¹

**ä¼˜ç‚¹**ï¼š
- âœ… **ç”¨æˆ·ä½“éªŒæœ€å¥½**ï¼šä¹°å®¶æ— éœ€ä»»ä½• Gas
- âœ… **å®‰å…¨æ€§é«˜**ï¼šä¹°å®¶ç­¾åç¡®ä¿æˆæƒ
- âœ… **å»ä¸­å¿ƒåŒ–**ï¼šæ— éœ€ä¸­å¿ƒåŒ–æœåŠ¡ï¼ˆåšå¸‚å•† P2P æœåŠ¡ï¼‰
- âœ… **é˜²åˆ·èƒ½åŠ›å¼º**ï¼šåšå¸‚å•†å¯è‡ªè¡Œæ§åˆ¶é˜²åˆ·è§„åˆ™
- âœ… **ä¸šåŠ¡é—­ç¯**ï¼šåšå¸‚å•†æœ‰åŠ¨åŠ›æä¾›æ­¤æœåŠ¡

**ç¼ºç‚¹**ï¼š
- âš ï¸ **éœ€è¦åšå¸‚å•†æ”¯æŒ**ï¼šåšå¸‚å•†éœ€è¦éƒ¨ç½²ä¸­ç»§æœåŠ¡
- âš ï¸ **åšå¸‚å•†æˆæœ¬**ï¼šåšå¸‚å•†æ‰¿æ‹… Gas è´¹ç”¨ï¼ˆä½†ç›¸å¯¹æ”¶ç›Šå¾®ä¸è¶³é“ï¼‰

---

### ğŸ¯ æ–¹æ¡ˆ Bï¼šåšå¸‚å•†é¢„å…… Gas æ± ï¼ˆå¤‡é€‰ï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼š
- åšå¸‚å•†é¢„å…ˆå……å€¼ Gas åˆ°ä¹°å®¶ Gas æ± 
- ä¹°å®¶ä½¿ç”¨ Gas æ± ä½™é¢æ”¯ä»˜æ‰‹ç»­è´¹
- åˆ›å»ºè®¢å•åï¼Œåšå¸‚å•†ä»è®¢å•é‡‘é¢ä¸­æ‰£é™¤ Gas æˆæœ¬

**æŠ€æœ¯å®ç°**ï¼š

```rust
// pallets/market-maker/src/lib.rs

#[pallet::storage]
pub type BuyerGasPool<T: Config> = StorageDoubleMap<
    _,
    Blake2_128Concat,
    u64,  // maker_id
    Blake2_128Concat,
    T::AccountId,  // buyer
    BalanceOf<T>,  // Gas ä½™é¢
    ValueQuery,
>;

#[pallet::call]
impl<T: Config> Pallet<T> {
    /// åšå¸‚å•†ä¸ºä¹°å®¶é¢„å…… Gas
    #[pallet::call_index(20)]
    pub fn sponsor_buyer_gas(
        origin: OriginFor<T>,
        maker_id: u64,
        buyer: AccountIdLookupOf<T>,
        amount: BalanceOf<T>,
    ) -> DispatchResult {
        let maker = ensure_signed(origin)?;
        let buyer = T::Lookup::lookup(buyer)?;
        
        // éªŒè¯æ˜¯è¯¥åšå¸‚å•†
        let maker_info = Self::get_maker(maker_id).ok_or(Error::<T>::MakerNotFound)?;
        ensure!(maker_info.account == maker, Error::<T>::NotMaker);
        
        // ä»åšå¸‚å•†è´¦æˆ·è½¬è´¦åˆ° Gas æ± 
        pallet_balance_tiers::Pallet::<T>::grant_balance(
            T::GrantOrigin::try_origin(origin)?,
            buyer.clone(),
            BalanceTier::Gas,
            amount,
            SourceType::MakerSponsored,
            Some(30 * 14400),  // 30å¤©è¿‡æœŸ
        )?;
        
        // è®°å½• Gas æ± 
        BuyerGasPool::<T>::mutate(maker_id, &buyer, |balance| {
            *balance = balance.saturating_add(amount);
        });
        
        Ok(())
    }
}
```

**ç¼ºç‚¹**ï¼š
- âš ï¸ éœ€è¦ä¹°å®¶å…ˆè”ç³»åšå¸‚å•†å……å€¼
- âš ï¸ ç”¨æˆ·ä½“éªŒä¸å¦‚æ–¹æ¡ˆ A

---

## ä¸‰ã€æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | ç”¨æˆ·ä½“éªŒ | æŠ€æœ¯å¤æ‚åº¦ | åšå¸‚å•†æˆæœ¬ | é˜²åˆ·èƒ½åŠ› | æ¨èåº¦ |
|------|---------|-----------|-----------|---------|--------|
| **A. ä»£åˆ›å»ºè®¢å•** | âœ… å¾ˆå¥½ | ğŸŸ¡ ä¸­ | ğŸŸ¢ ä½ | âœ… å¼º | â­â­â­â­â­ |
| **B. Gas æ± ** | âš ï¸ ä¸­ | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ | âš ï¸ ä¸­ | â­â­â­ |

---

## å››ã€æ¨èå®æ–½æ–¹æ¡ˆ

### âœ… **æ–¹æ¡ˆ Aï¼šåšå¸‚å•†ä»£åˆ›å»ºè®¢å•**

**å®æ–½æ­¥éª¤**ï¼š

#### Step 1ï¼šä¿®æ”¹ OTC Order Palletï¼ˆé“¾ç«¯ï¼‰
- æ·»åŠ  `create_order_sponsored` å‡½æ•°
- å®ç°ä¹°å®¶ç­¾åéªŒè¯
- Gas ç”±åšå¸‚å•†ï¼ˆè°ƒç”¨è€…ï¼‰æ”¯ä»˜

#### Step 2ï¼šå‰ç«¯é›†æˆï¼ˆå‰ç«¯ï¼‰
- åˆ›å»º `CreateOrderSponsoredPage` é¡µé¢
- ä¹°å®¶ç­¾åè®¢å•å‚æ•°ï¼ˆé“¾ä¸‹ï¼‰
- å‘é€åˆ°åšå¸‚å•†ä¸­ç»§æœåŠ¡

#### Step 3ï¼šåšå¸‚å•†ä¸­ç»§æœåŠ¡ï¼ˆåç«¯ï¼‰
- æ¥æ”¶ä¹°å®¶è¯·æ±‚
- éªŒè¯ç­¾å
- è°ƒç”¨é“¾ä¸Šå‡½æ•°ï¼ˆåšå¸‚å•†æ”¯ä»˜ Gasï¼‰
- è¿”å›è®¢å•ID

#### Step 4ï¼šé˜²åˆ·æœºåˆ¶
- åšå¸‚å•†é™æµï¼ˆæ¯ä¸ªä¹°å®¶æ¯åˆ†é’Ÿæœ€å¤š1æ¬¡ï¼‰
- é“¾ä¸Šè®°å½•ï¼ˆä¹°å®¶ä¿¡ç”¨ç³»ç»Ÿï¼‰

---

## äº”ã€æˆæœ¬æ•ˆç›Šåˆ†æ

### åšå¸‚å•†æˆæœ¬

```
å•ç¬”è®¢å• Gas æˆæœ¬ï¼š~0.01 DUST
å‡è®¾ DUST ä»·æ ¼ï¼š$0.01
å•ç¬”è®¢å• Gas æˆæœ¬ï¼ˆUSDï¼‰ï¼š$0.0001

æœˆåº¦é¢„ä¼°ï¼š
- æœˆè®¢å•é‡ï¼š1000 ç¬”
- æœˆ Gas æˆæœ¬ï¼š1000 * 0.01 = 10 DUST = $0.1
- æœˆæº¢ä»·æ”¶ç›Šï¼š1000 * 100 USDT * 2% = 2000 USDT
- æ”¶ç›Š/æˆæœ¬æ¯”ï¼š20,000:1

ç»“è®ºï¼šåšå¸‚å•†æˆæœ¬å‡ ä¹å¯ä»¥å¿½ç•¥ä¸è®¡
```

### ç”¨æˆ·ä½“éªŒæå‡

```
ä¼ ç»Ÿæµç¨‹è½¬åŒ–ç‡ï¼š40%ï¼ˆ60%æµå¤±ï¼‰
ä»£ä»˜ Gas è½¬åŒ–ç‡ï¼š90%ï¼ˆ10%æµå¤±ï¼‰

å‡è®¾æœˆè®¿é—®é‡ï¼š10,000 äºº
- ä¼ ç»Ÿæµç¨‹è®¢å•é‡ï¼š4,000 ç¬”
- ä»£ä»˜ Gas è®¢å•é‡ï¼š9,000 ç¬”
- è®¢å•é‡æå‡ï¼š125%

åšå¸‚å•†æ”¶ç›Šæå‡ï¼š
- ä¼ ç»Ÿæ”¶ç›Šï¼š4,000 * 100 * 2% = 8,000 USDT
- ä»£ä»˜æ”¶ç›Šï¼š9,000 * 100 * 2% = 18,000 USDT
- æ”¶ç›Šæå‡ï¼š125% = +10,000 USDT/æœˆ

åšå¸‚å•†å‡€æ”¶ç›Šæå‡ï¼š
10,000 USDT - 0.1 USD (Gasæˆæœ¬) â‰ˆ 10,000 USDT

ç»“è®ºï¼šåšå¸‚å•†æœ‰æå¼ºçš„åŠ¨åŠ›å®æ–½æ­¤åŠŸèƒ½
```

---

## å…­ã€æ€»ç»“

### âœ… **åšå¸‚å•†ä»£ä»˜ OTC è®¢å• Gas è´¹å®Œå…¨å¯è¡Œï¼**

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| **æŠ€æœ¯å¯è¡Œæ€§ï¼Ÿ** | âœ… å®Œå…¨å¯è¡Œï¼ˆæ–¹æ¡ˆ Aï¼‰ |
| **ä¸šåŠ¡åˆç†æ€§ï¼Ÿ** | âœ… åšå¸‚å•†æœ‰æå¼ºåŠ¨åŠ› |
| **ç”¨æˆ·ä½“éªŒï¼Ÿ** | âœ… å¤§å¹…æå‡ï¼ˆé›¶é—¨æ§›ï¼‰ |
| **åšå¸‚å•†æˆæœ¬ï¼Ÿ** | ğŸŸ¢ å‡ ä¹å¯ä»¥å¿½ç•¥ï¼ˆ$0.0001/ç¬”ï¼‰ |
| **æ¨èæ–¹æ¡ˆï¼Ÿ** | âœ… **ä»£åˆ›å»ºè®¢å•ï¼ˆæ–¹æ¡ˆ Aï¼‰** |

---

### ğŸš€ ç«‹å³è¡ŒåŠ¨å»ºè®®

**ä¼˜å…ˆçº§ï¼šğŸ”´ é«˜**

**å®æ–½æ­¥éª¤**ï¼š
1. âœ… ä¿®æ”¹ `pallets/otc-order/src/lib.rs`ï¼Œæ·»åŠ  `create_order_sponsored` å‡½æ•°
2. âœ… å‰ç«¯åˆ›å»º `CreateOrderSponsoredPage` é¡µé¢
3. âœ… åšå¸‚å•†ä¸­ç»§æœåŠ¡æ·»åŠ ä»£ä»˜åŠŸèƒ½
4. âœ… æµ‹è¯•å®Œæ•´æµç¨‹

**é¢„æœŸæ•ˆæœ**ï¼š
- ğŸ“ˆ è®¢å•é‡æå‡ **125%**
- ğŸ˜Š ç”¨æˆ·æµå¤±ç‡é™ä½ **50%**
- ğŸ’° åšå¸‚å•†æ”¶ç›Šæå‡ **125%**
- ğŸ’¸ åšå¸‚å•†æˆæœ¬å‡ ä¹ä¸º **0**

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-22  
**æ ¸å¿ƒç»“è®º**: âœ… **åšå¸‚å•†ä»£ä»˜ Gas è´¹å®Œå…¨å¯è¡Œï¼Œä¸”æœ‰æé«˜çš„ä¸šåŠ¡ä»·å€¼ï¼**  
**ç«‹å³è¡ŒåŠ¨**: ğŸ’¡ **ç«‹å³å®æ–½æ–¹æ¡ˆ Aï¼ˆä»£åˆ›å»ºè®¢å•ï¼‰**

