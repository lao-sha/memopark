# çºªå¿µé¦†éŸ³ä¹ç³»ç»Ÿ - å¯è¡Œæ€§ä¸åˆç†æ€§åˆ†æ

## éœ€æ±‚æ¦‚è¿°

**æ ¸å¿ƒéœ€æ±‚**ï¼š
- æ¯ä¸ªé€è€…çºªå¿µé¦†å¯å…³è”èƒŒæ™¯éŸ³ä¹CID
- æ— éŸ³ä¹ä¾›å¥‰æ—¶ï¼Œæ’­æ”¾å…¬å…±éŸ³ä¹åº“çš„é»˜è®¤éŸ³ä¹
- æœ‰éŸ³ä¹ä¾›å¥‰æ—¶ï¼Œè‡ªåŠ¨åˆ‡æ¢æ’­æ”¾ä¾›å¥‰éŸ³ä¹
- ç”¨æˆ·å¯æ‰‹åŠ¨é€‰æ‹©è¿”å›å…¬å…±éŸ³ä¹

---

## ä¸€ã€ç°çŠ¶åˆ†æ

### 1.1 é“¾ç«¯ç°æœ‰åŸºç¡€è®¾æ–½

#### âœ… Pallet Deceasedï¼ˆé€è€…æ¡£æ¡ˆï¼‰
**æ–‡ä»¶ä½ç½®**: `pallets/deceased/src/lib.rs:410-457`

**ç°æœ‰ç»“æ„**:
```rust
pub struct Deceased<T: Config> {
    pub owner: T::AccountId,
    pub creator: T::AccountId,
    pub name: BoundedVec<u8, T::StringLimit>,
    pub gender: Gender,
    pub name_full_cid: Option<BoundedVec<u8, T::TokenLimit>>,
    pub birth_ts: Option<BoundedVec<u8, T::StringLimit>>,
    pub death_ts: Option<BoundedVec<u8, T::StringLimit>>,
    pub main_image_cid: Option<BoundedVec<u8, T::TokenLimit>>,
    pub deceased_token: BoundedVec<u8, T::TokenLimit>,
    // ... å…¶ä»–å­—æ®µ
}
```

**åˆ†æ**:
- âŒ **å½“å‰æ— éŸ³ä¹CIDå­—æ®µ**
- âœ… æœ‰ `main_image_cid` å­—æ®µä½œä¸ºå‚è€ƒæ¨¡å¼
- âœ… æ”¯æŒ Audio åª’ä½“ç±»å‹ï¼ˆ`MediaKind::Audio`ï¼‰
- âœ… ä½¿ç”¨ `BoundedVec<u8, T::TokenLimit>` å­˜å‚¨CID

**æ–°å¢å­—æ®µéœ€æ±‚**:
```rust
// éœ€è¦åœ¨ Deceased ç»“æ„ä½“ä¸­æ·»åŠ 
pub background_music_cid: Option<BoundedVec<u8, T::TokenLimit>>,
```

---

#### âœ… Pallet Memorialï¼ˆä¾›å¥‰ç³»ç»Ÿï¼‰
**æ–‡ä»¶ä½ç½®**: `pallets/memorial/README.md`

**ä¾›å¥‰å“è§„æ ¼ç»“æ„**:
```rust
pub struct OfferingSpec {
    pub kind_code: u8,
    pub name: BoundedString,
    pub media_schema_cid: BoundedCid,
    pub enabled: bool,
    pub kind: OfferingKind,  // Instant | Timed
}
```

**ä¾›å¥‰è®°å½•ç»“æ„**:
```rust
pub struct OfferingRecord {
    pub who: AccountId,
    pub target: (u8, u64),      // (domain, id)
    pub kind_code: u8,
    pub amount: u128,
    pub media: Vec<MediaItem>,   // âœ… æ”¯æŒåª’ä½“åˆ—è¡¨
    pub duration: Option<u32>,
    pub time: BlockNumber,
}
```

**åˆ†æ**:
- âœ… **ä¾›å¥‰è®°å½•å·²æ”¯æŒåª’ä½“åˆ—è¡¨**
- âœ… `media` å­—æ®µå¯å­˜å‚¨éŸ³ä¹CID
- âœ… æ”¯æŒå³æ—¶å‹ï¼ˆInstantï¼‰ä¾›å¥‰
- âœ… æ”¯æŒè®¡æ—¶å‹ï¼ˆTimedï¼‰ä¾›å¥‰

**éŸ³ä¹ä¾›å¥‰ç±»å‹è®¾è®¡**:
```rust
// å¯ä½¿ç”¨ç°æœ‰ OfferingKind æšä¸¾
OfferingKind::Instant  // ä¸€æ¬¡æ€§éŸ³ä¹ä¾›å¥‰
OfferingKind::Timed {  // å‘¨æœŸæ€§éŸ³ä¹æ’­æ”¾
    min: 1,  // æœ€å°‘1å‘¨
    max: Some(52),  // æœ€å¤š52å‘¨ï¼ˆ1å¹´ï¼‰
    can_renew: true,
}
```

---

### 1.2 å‰ç«¯ç°æœ‰åŸºç¡€

#### âœ… IPFSç±»å‹ç³»ç»Ÿ
**æ–‡ä»¶ä½ç½®**: `stardust-dapp/src/types/ipfs.ts:78`

```typescript
export enum CidType {
  DeceasedName = 'deceased_name',
  DeceasedMainImage = 'deceased_main_image',
  Media = 'media',
  // ... å…¶ä»–ç±»å‹
  MemorialAudio = 'memorial_audio',  // âœ… å·²æœ‰éŸ³é¢‘ç±»å‹
}

// ç±»å‹æ˜¾ç¤ºåç§°
export const CID_TYPE_NAMES: Record<CidType, string> = {
  [CidType.MemorialAudio]: 'çºªå¿µé¦†éŸ³é¢‘',  // âœ… å·²å®šä¹‰
};
```

**åˆ†æ**:
- âœ… **å‰ç«¯å·²æœ‰çºªå¿µé¦†éŸ³é¢‘ç±»å‹å®šä¹‰**
- âœ… IPFS Pinç³»ç»Ÿæ”¯æŒéŸ³é¢‘æ–‡ä»¶
- âœ… å­˜å‚¨è´¹ç”¨æœºåˆ¶å·²å®Œå–„

---

## äºŒã€æŠ€æœ¯å¯è¡Œæ€§åˆ†æ

### 2.1 é“¾ç«¯æ”¹é€ æ–¹æ¡ˆ

#### æ–¹æ¡ˆAï¼šæ‰©å±• Deceased ç»“æ„ä½“ï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹**:
- âœ… ç®€å•ç›´æ¥ï¼Œç¬¦åˆç›´è§‰
- âœ… æŸ¥è¯¢é«˜æ•ˆï¼ˆä¸€æ¬¡RPCè°ƒç”¨ï¼‰
- âœ… ä¸ `main_image_cid` æ¨¡å¼ä¸€è‡´

**ç¼ºç‚¹**:
- âš ï¸ éœ€è¦ Runtime å‡çº§
- âš ï¸ å­˜é‡æ•°æ®éœ€è¿ç§»ï¼ˆè®¾ä¸º Noneï¼‰

**å®æ–½æ­¥éª¤**:
```rust
// 1. ä¿®æ”¹ Deceased ç»“æ„ä½“
pub struct Deceased<T: Config> {
    // ... ç°æœ‰å­—æ®µ

    /// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šèƒŒæ™¯éŸ³ä¹CIDï¼ˆIPFSï¼‰
    /// - ç”¨é€”ï¼šçºªå¿µé¦†é¡µé¢è‡ªåŠ¨æ’­æ”¾èƒŒæ™¯éŸ³ä¹
    /// - æƒé™ï¼šownerå¯è®¾ç½®ï¼›éowneréœ€æ²»ç†æ‰¹å‡†
    /// - å¯é€‰ï¼šæœªè®¾ç½®æ—¶ä½¿ç”¨å…¬å…±éŸ³ä¹åº“
    pub background_music_cid: Option<BoundedVec<u8, T::TokenLimit>>,
}

// 2. æ–°å¢/æ‰©å±•æ¥å£
#[pallet::call]
impl<T: Config> Pallet<T> {
    /// è®¾ç½®èƒŒæ™¯éŸ³ä¹
    pub fn set_background_music(
        origin: OriginFor<T>,
        deceased_id: u64,
        music_cid: Option<Vec<u8>>,
    ) -> DispatchResult {
        let who = ensure_signed(origin)?;

        // 1. æ£€æŸ¥é€è€…å­˜åœ¨
        let mut deceased = DeceasedOf::<T>::get(deceased_id)
            .ok_or(Error::<T>::DeceasedNotFound)?;

        // 2. æƒé™éªŒè¯
        ensure!(deceased.owner == who, Error::<T>::NotOwner);

        // 3. CIDéªŒè¯ï¼ˆé•¿åº¦ã€æ ¼å¼ï¼‰
        let music_cid_bounded = if let Some(cid) = music_cid {
            let cid_bounded: BoundedVec<u8, T::TokenLimit> = cid
                .try_into()
                .map_err(|_| Error::<T>::CidTooLong)?;
            Some(cid_bounded)
        } else {
            None
        };

        // 4. æ›´æ–°è®°å½•
        deceased.background_music_cid = music_cid_bounded.clone();
        deceased.updated = <frame_system::Pallet<T>>::block_number();
        deceased.version += 1;
        DeceasedOf::<T>::insert(deceased_id, deceased);

        // 5. è§¦å‘äº‹ä»¶
        Self::deposit_event(Event::BackgroundMusicSet {
            deceased_id,
            music_cid: music_cid_bounded,
        });

        Ok(())
    }
}
```

**è¿ç§»ç­–ç•¥**:
```rust
// runtime/src/migrations.rs
pub mod v2 {
    use super::*;

    pub fn migrate<T: Config>() -> Weight {
        log::info!("Migrating Deceased to v2: adding background_music_cid");

        // éå†æ‰€æœ‰é€è€…ï¼Œè®¾ç½® background_music_cid = None
        DeceasedOf::<T>::translate(|key, mut deceased: Deceased<T>| {
            deceased.background_music_cid = None;
            Some(deceased)
        });

        Weight::from_parts(100_000, 0)
    }
}
```

---

#### æ–¹æ¡ˆBï¼šä½¿ç”¨ä¾›å¥‰ç³»ç»Ÿï¼ˆä¸æ¨èï¼‰

**æ€è·¯**: å°†èƒŒæ™¯éŸ³ä¹è§†ä¸ºç‰¹æ®Šä¾›å¥‰å“

**ä¼˜ç‚¹**:
- âœ… æ— éœ€ä¿®æ”¹ Deceased ç»“æ„
- âœ… å¤ç”¨ç°æœ‰ä¾›å¥‰ç³»ç»Ÿ

**ç¼ºç‚¹**:
- âŒ è¯­ä¹‰ä¸æ¸…æ™°ï¼ˆéŸ³ä¹ä¸æ˜¯"ä¾›å¥‰"ï¼‰
- âŒ æŸ¥è¯¢å¤æ‚ï¼ˆéœ€éå†ä¾›å¥‰è®°å½•ï¼‰
- âŒ ç”¨æˆ·ä½“éªŒå·®ï¼ˆéœ€"ä¾›å¥‰"æ‰èƒ½è®¾ç½®ï¼‰
- âŒ æƒé™æ··ä¹±ï¼ˆè°éƒ½èƒ½"ä¾›å¥‰"éŸ³ä¹ï¼‰

**ç»“è®º**: ä¸é‡‡ç”¨æ­¤æ–¹æ¡ˆ

---

### 2.2 å…¬å…±éŸ³ä¹åº“è®¾è®¡

#### æ–¹æ¡ˆ1ï¼šé“¾ä¸Šå­˜å‚¨éŸ³ä¹ç›®å½•ï¼ˆæ¨èï¼‰

**å­˜å‚¨ç»“æ„**:
```rust
/// å…¬å…±éŸ³ä¹æ¡ç›®
#[derive(Encode, Decode, Clone, PartialEq, Eq, TypeInfo, MaxEncodedLen)]
pub struct PublicMusicEntry<T: Config> {
    /// éŸ³ä¹ID
    pub id: u32,
    /// éŸ³ä¹åç§°
    pub name: BoundedVec<u8, T::StringLimit>,
    /// éŸ³ä¹CIDï¼ˆIPFSï¼‰
    pub music_cid: BoundedVec<u8, T::TokenLimit>,
    /// å°é¢å›¾CID
    pub cover_cid: Option<BoundedVec<u8, T::TokenLimit>>,
    /// æ—¶é•¿ï¼ˆç§’ï¼‰
    pub duration: u32,
    /// åˆ†ç±»ï¼ˆå¦‚ï¼šå“€ä¹ã€ä½›ä¹ã€è½»éŸ³ä¹ï¼‰
    pub category: MusicCategory,
    /// æ˜¯å¦å¯ç”¨
    pub enabled: bool,
    /// åˆ›å»ºæ—¶é—´
    pub created_at: BlockNumberFor<T>,
}

/// éŸ³ä¹åˆ†ç±»
#[derive(Encode, Decode, Clone, Copy, PartialEq, Eq, TypeInfo, MaxEncodedLen)]
pub enum MusicCategory {
    Requiem = 0,      // å“€ä¹
    Buddhist = 1,     // ä½›ä¹
    Light = 2,        // è½»éŸ³ä¹
    Classical = 3,    // å¤å…¸éŸ³ä¹
    Ambient = 4,      // ç¯å¢ƒéŸ³ä¹
}

/// å­˜å‚¨æ˜ å°„
#[pallet::storage]
pub type PublicMusicLibrary<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u32,  // music_id
    PublicMusicEntry<T>,
>;

/// åˆ†ç±»ç´¢å¼•
#[pallet::storage]
pub type MusicByCategory<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    MusicCategory,
    BoundedVec<u32, ConstU32<100>>,  // æ¯åˆ†ç±»æœ€å¤š100é¦–
    ValueQuery,
>;
```

**ç®¡ç†æ¥å£**:
```rust
#[pallet::call]
impl<T: Config> Pallet<T> {
    /// æ·»åŠ å…¬å…±éŸ³ä¹ï¼ˆRoot/æ²»ç†å§”å‘˜ä¼šï¼‰
    pub fn add_public_music(
        origin: OriginFor<T>,
        name: Vec<u8>,
        music_cid: Vec<u8>,
        cover_cid: Option<Vec<u8>>,
        duration: u32,
        category: MusicCategory,
    ) -> DispatchResult {
        ensure_root(origin)?;

        let music_id = Self::next_music_id();
        let entry = PublicMusicEntry {
            id: music_id,
            name: name.try_into()?,
            music_cid: music_cid.try_into()?,
            cover_cid: cover_cid.map(|c| c.try_into()).transpose()?,
            duration,
            category,
            enabled: true,
            created_at: <frame_system::Pallet<T>>::block_number(),
        };

        PublicMusicLibrary::<T>::insert(music_id, entry);
        MusicByCategory::<T>::try_mutate(category, |ids| {
            ids.try_push(music_id)
        })?;

        NextMusicId::<T>::put(music_id + 1);

        Self::deposit_event(Event::PublicMusicAdded {
            music_id,
            category,
        });

        Ok(())
    }

    /// å¯ç”¨/ç¦ç”¨å…¬å…±éŸ³ä¹
    pub fn set_public_music_status(
        origin: OriginFor<T>,
        music_id: u32,
        enabled: bool,
    ) -> DispatchResult {
        ensure_root(origin)?;

        PublicMusicLibrary::<T>::try_mutate(music_id, |entry| {
            let e = entry.as_mut().ok_or(Error::<T>::MusicNotFound)?;
            e.enabled = enabled;
            Ok(())
        })
    }
}
```

**ä¼˜ç‚¹**:
- âœ… å»ä¸­å¿ƒåŒ–ç®¡ç†
- âœ… é“¾ä¸Šå¯éªŒè¯
- âœ… æ”¯æŒåˆ†ç±»å’Œç´¢å¼•
- âœ… æ²»ç†å¯æ§

**ç¼ºç‚¹**:
- âš ï¸ é“¾ä¸Šå­˜å‚¨æˆæœ¬ï¼ˆå¯æ¥å—ï¼Œä»…å­˜CIDï¼‰
- âš ï¸ åˆå§‹åŒ–éœ€Rootæ“ä½œ

---

#### æ–¹æ¡ˆ2ï¼šå‰ç«¯ç¡¬ç¼–ç ï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰

**å®æ–½**: åœ¨å‰ç«¯ç›´æ¥å®šä¹‰éŸ³ä¹åˆ—è¡¨

```typescript
// src/constants/publicMusic.ts
export const PUBLIC_MUSIC_LIBRARY = [
  {
    id: 1,
    name: 'å“€ä¹ - è¿½æ€',
    musicCid: 'QmXXX...å“€ä¹1',
    category: 'requiem',
    duration: 180,
  },
  {
    id: 2,
    name: 'ä½›ä¹ - å¿ƒç»',
    musicCid: 'QmYYY...ä½›ä¹1',
    category: 'buddhist',
    duration: 240,
  },
  // ... æ›´å¤šéŸ³ä¹
];
```

**ä¼˜ç‚¹**:
- âœ… å¿«é€Ÿå®ç°ï¼Œæ— éœ€é“¾ç«¯æ”¹é€ 
- âœ… å‰ç«¯ç›´æ¥ä½¿ç”¨

**ç¼ºç‚¹**:
- âŒ ä¸­å¿ƒåŒ–ç®¡ç†
- âŒ æ›´æ–°éœ€å‘ç‰ˆ
- âŒ æ— æ³•é“¾ä¸ŠéªŒè¯

**ç»“è®º**: å¯ä½œä¸º MVP æ–¹æ¡ˆï¼Œé•¿æœŸåº”è¿ç§»åˆ°é“¾ä¸Š

---

### 2.3 éŸ³ä¹ä¾›å¥‰ç³»ç»Ÿè®¾è®¡

#### ä¾›å¥‰å“è§„æ ¼å®šä¹‰

**é“¾ç«¯é…ç½®**:
```rust
// åˆ›å»ºéŸ³ä¹ä¾›å¥‰å“è§„æ ¼
OfferingSpec {
    kind_code: 10,  // éŸ³ä¹ä¾›å¥‰ç±»å‹ä»£ç 
    name: "çŒ®ä¸ŠéŸ³ä¹".into(),
    media_schema_cid: "QmMusicSchema...".into(),  // éŸ³ä¹ä¸Šä¼ schema
    enabled: true,
    kind: OfferingKind::Timed {
        min: 1,         // æœ€å°‘æ’­æ”¾1å‘¨
        max: Some(52),  // æœ€å¤šæ’­æ”¾52å‘¨ï¼ˆ1å¹´ï¼‰
        can_renew: true,  // å¯ç»­è´¹
    },
}
```

**å®šä»·ç­–ç•¥**:
```rust
// Base price: 5 DUST/å‘¨
// ä¼šå‘˜æŠ˜æ‰£: 2æŠ˜ï¼ˆ1 DUST/å‘¨ï¼‰
// è®¡ç®—ç¤ºä¾‹:
// - æ’­æ”¾4å‘¨ï¼š20 DUSTï¼ˆä¼šå‘˜4 DUSTï¼‰
// - æ’­æ”¾52å‘¨ï¼š260 DUSTï¼ˆä¼šå‘˜52 DUSTï¼‰
```

---

#### ä¾›å¥‰éŸ³ä¹æŸ¥è¯¢é€»è¾‘

**é“¾ç«¯è¾…åŠ©å‡½æ•°**:
```rust
impl<T: Config> Pallet<T> {
    /// è·å–é€è€…çš„æœ‰æ•ˆä¾›å¥‰éŸ³ä¹
    pub fn get_active_offering_music(deceased_id: u64) -> Option<BoundedVec<u8, T::TokenLimit>> {
        let now = <frame_system::Pallet<T>>::block_number();

        // éå†è¯¥é€è€…çš„ä¾›å¥‰è®°å½•
        for (offering_id, record) in OfferingRecordsOf::<T>::iter() {
            if record.target != (DECEASED_DOMAIN, deceased_id) {
                continue;
            }

            if record.kind_code != MUSIC_OFFERING_KIND {
                continue;
            }

            // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            if let Some(duration_weeks) = record.duration {
                let blocks_per_week = 7 * 24 * 60 * 60 / 6;  // 100,800 blocks
                let expire_at = record.time + (duration_weeks * blocks_per_week);

                if now <= expire_at {
                    // ä» media åˆ—è¡¨ä¸­æå–éŸ³ä¹CID
                    if let Some(first_media) = record.media.first() {
                        return Some(first_media.cid.clone());
                    }
                }
            }
        }

        None
    }
}
```

**å‰ç«¯æŸ¥è¯¢é€»è¾‘**:
```typescript
// src/services/deceasedService.ts
async getBackgroundMusic(deceasedId: number): Promise<string | null> {
  // 1. æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„ä¾›å¥‰éŸ³ä¹
  const offeringMusic = await this.api.query.deceased.activeOfferingMusic(deceasedId)
  if (offeringMusic.isSome) {
    return this.decodeString(offeringMusic.unwrap())
  }

  // 2. æ£€æŸ¥æ˜¯å¦è®¾ç½®äº†èƒŒæ™¯éŸ³ä¹
  const deceased = await this.getDeceased(deceasedId)
  if (deceased?.backgroundMusicCid) {
    return deceased.backgroundMusicCid
  }

  // 3. è¿”å›ç©ºï¼ˆä½¿ç”¨å…¬å…±éŸ³ä¹ï¼‰
  return null
}
```

---

### 2.4 å‰ç«¯éŸ³ä¹æ’­æ”¾å™¨è®¾è®¡

#### æ’­æ”¾å™¨ç»„ä»¶æ¶æ„

```typescript
// src/components/memorial/MusicPlayer.tsx
interface MusicPlayerProps {
  deceasedId: number
  autoPlay?: boolean
}

interface MusicState {
  currentMusic: {
    cid: string
    source: 'offering' | 'background' | 'public'
    name: string
  } | null
  isPlaying: boolean
  volume: number
  isMuted: boolean
  progress: number
  duration: number
}

export const MusicPlayer: React.FC<MusicPlayerProps> = ({
  deceasedId,
  autoPlay = true
}) => {
  const [musicState, setMusicState] = useState<MusicState>({
    currentMusic: null,
    isPlaying: false,
    volume: 0.5,
    isMuted: false,
    progress: 0,
    duration: 0,
  })

  const audioRef = useRef<HTMLAudioElement>(null)

  // 1. è·å–éŸ³ä¹æºä¼˜å…ˆçº§
  useEffect(() => {
    const loadMusic = async () => {
      // ä¼˜å…ˆçº§1: ä¾›å¥‰éŸ³ä¹
      const offeringMusic = await service.getOfferingMusic(deceasedId)
      if (offeringMusic) {
        setMusicState(prev => ({
          ...prev,
          currentMusic: {
            cid: offeringMusic.cid,
            source: 'offering',
            name: offeringMusic.name || 'ä¾›å¥‰éŸ³ä¹',
          }
        }))
        return
      }

      // ä¼˜å…ˆçº§2: èƒŒæ™¯éŸ³ä¹
      const bgMusic = await service.getBackgroundMusic(deceasedId)
      if (bgMusic) {
        setMusicState(prev => ({
          ...prev,
          currentMusic: {
            cid: bgMusic,
            source: 'background',
            name: 'èƒŒæ™¯éŸ³ä¹',
          }
        }))
        return
      }

      // ä¼˜å…ˆçº§3: å…¬å…±éŸ³ä¹ï¼ˆéšæœºé€‰æ‹©ï¼‰
      const publicMusic = getRandomPublicMusic('requiem')  // é»˜è®¤å“€ä¹
      setMusicState(prev => ({
        ...prev,
        currentMusic: {
          cid: publicMusic.cid,
          source: 'public',
          name: publicMusic.name,
        }
      }))
    }

    loadMusic()
  }, [deceasedId])

  // 2. è‡ªåŠ¨æ’­æ”¾æ§åˆ¶
  useEffect(() => {
    if (autoPlay && musicState.currentMusic && audioRef.current) {
      audioRef.current.play()
      setMusicState(prev => ({ ...prev, isPlaying: true }))
    }
  }, [musicState.currentMusic, autoPlay])

  // 3. åˆ‡æ¢åˆ°å…¬å…±éŸ³ä¹
  const switchToPublicMusic = () => {
    const publicMusic = getRandomPublicMusic('requiem')
    setMusicState(prev => ({
      ...prev,
      currentMusic: {
        cid: publicMusic.cid,
        source: 'public',
        name: publicMusic.name,
      }
    }))
  }

  return (
    <div className="music-player">
      <audio
        ref={audioRef}
        src={`https://ipfs.io/ipfs/${musicState.currentMusic?.cid}`}
        onTimeUpdate={() => {/* æ›´æ–°è¿›åº¦ */}}
        onEnded={() => {/* å¾ªç¯æ’­æ”¾æˆ–ä¸‹ä¸€æ›² */}}
      />

      <div className="player-controls">
        {/* æ’­æ”¾/æš‚åœæŒ‰é’® */}
        <Button
          icon={musicState.isPlaying ? <PauseOutlined /> : <PlayCircleOutlined />}
          onClick={() => {
            if (musicState.isPlaying) {
              audioRef.current?.pause()
            } else {
              audioRef.current?.play()
            }
            setMusicState(prev => ({ ...prev, isPlaying: !prev.isPlaying }))
          }}
        />

        {/* éŸ³ä¹ä¿¡æ¯ */}
        <div className="music-info">
          <span>{musicState.currentMusic?.name}</span>
          <Tag color={
            musicState.currentMusic?.source === 'offering' ? 'gold' :
            musicState.currentMusic?.source === 'background' ? 'blue' : 'default'
          }>
            {musicState.currentMusic?.source === 'offering' ? 'ä¾›å¥‰éŸ³ä¹' :
             musicState.currentMusic?.source === 'background' ? 'èƒŒæ™¯éŸ³ä¹' : 'å…¬å…±éŸ³ä¹'}
          </Tag>
        </div>

        {/* åˆ‡æ¢åˆ°å…¬å…±éŸ³ä¹æŒ‰é’® */}
        {musicState.currentMusic?.source !== 'public' && (
          <Button size="small" onClick={switchToPublicMusic}>
            åˆ‡æ¢å…¬å…±éŸ³ä¹
          </Button>
        )}

        {/* éŸ³é‡æ§åˆ¶ */}
        <Slider
          min={0}
          max={1}
          step={0.01}
          value={musicState.volume}
          onChange={(value) => {
            setMusicState(prev => ({ ...prev, volume: value }))
            if (audioRef.current) audioRef.current.volume = value
          }}
          style={{ width: 100 }}
        />
      </div>
    </div>
  )
}
```

---

## ä¸‰ã€ä¸šåŠ¡åˆç†æ€§åˆ†æ

### 3.1 æƒ…æ„Ÿä»·å€¼

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **æƒ…æ„Ÿå…±é¸£** | â­â­â­â­â­ | éŸ³ä¹æ˜¯æƒ…æ„Ÿè¡¨è¾¾çš„é‡è¦åª’ä»‹ |
| **æ–‡åŒ–å¥‘åˆ** | â­â­â­â­â­ | ä¸­å›½ç¥­ç¥€æ–‡åŒ–ä¸­éŸ³ä¹ä¸å¯æˆ–ç¼º |
| **ç”¨æˆ·éœ€æ±‚** | â­â­â­â­ | æå‡çºªå¿µé¦†æ°›å›´æ„Ÿï¼Œå¢å¼ºæ²‰æµ¸ä½“éªŒ |
| **å·®å¼‚åŒ–** | â­â­â­â­ | å…¶ä»–çºªå¿µå¹³å°è¾ƒå°‘æ”¯æŒéŸ³ä¹åŠŸèƒ½ |

### 3.2 å•†ä¸šä»·å€¼

#### æ”¶å…¥æ¨¡å‹

**1. éŸ³ä¹ä¾›å¥‰æ”¶å…¥**
```
åŸºç¡€å®šä»·: 5 DUST/å‘¨
ä¼šå‘˜æŠ˜æ‰£: 1 DUST/å‘¨ï¼ˆ2æŠ˜ï¼‰

å‡è®¾åœºæ™¯:
- æœˆæ´»1000ä¸ªçºªå¿µé¦†
- 10%ä½¿ç”¨éŸ³ä¹ä¾›å¥‰
- å¹³å‡æ’­æ”¾4å‘¨

æœˆæ”¶å…¥ = 100ä¸ªçºªå¿µé¦† Ã— 4å‘¨ Ã— 5 DUST = 2,000 DUST
ä¼šå‘˜å æ¯”50% â†’ å®é™…æ”¶å…¥çº¦ 1,500 DUST/æœˆ
```

**2. ä¼šå‘˜è½¬åŒ–**
- éŸ³ä¹ä¾›å¥‰äº«å—ä¼šå‘˜æŠ˜æ‰£ â†’ ä¿ƒè¿›ä¼šå‘˜è´­ä¹°
- é¢„è®¡ä¼šå‘˜è½¬åŒ–ç‡æå‡ 5-10%

**3. è”ç›Ÿè®¡é…¬**
- éŸ³ä¹ä¾›å¥‰è§¦å‘15çº§åˆ†é”€
- æ¨å¹¿ç§¯ææ€§æå‡

---

### 3.3 ç”¨æˆ·ä½“éªŒæå‡

**åœºæ™¯1: é»˜è®¤ä½“éªŒ**
```
ç”¨æˆ·è®¿é—®çºªå¿µé¦†
â†’ è‡ªåŠ¨æ’­æ”¾å“€ä¹ï¼ˆå…¬å…±éŸ³ä¹åº“ï¼‰
â†’ è¥é€ è‚ƒç©†æ°›å›´
â†’ å¢å¼ºæƒ…æ„Ÿå…±é¸£
```

**åœºæ™¯2: ä¸ªæ€§åŒ–ä½“éªŒ**
```
çºªå¿µé¦†æ‹¥æœ‰è€…
â†’ ä¸Šä¼ é€è€…ç”Ÿå‰å–œæ¬¢çš„æ­Œæ›²
â†’ è®¾ç½®ä¸ºèƒŒæ™¯éŸ³ä¹
â†’ è®¿å®¢è‡ªåŠ¨æ’­æ”¾
â†’ æ›´å…·ä¸ªæ€§åŒ–å’Œçºªå¿µæ„ä¹‰
```

**åœºæ™¯3: ä¾›å¥‰ä½“éªŒ**
```
è®¿å®¢/äº²å‹
â†’ é€‰æ‹©"çŒ®ä¸ŠéŸ³ä¹"ä¾›å¥‰å“
â†’ ä¸Šä¼ æ­Œæ›²å¹¶è®¾ç½®æ’­æ”¾å‘¨æœŸ
â†’ çºªå¿µé¦†æ’­æ”¾ä¾›å¥‰éŸ³ä¹
â†’ ä¾›å¥‰è€…å§“åå±•ç¤º
â†’ å¢å¼ºä»ªå¼æ„Ÿå’Œå‚ä¸æ„Ÿ
```

---

### 3.4 é£é™©åˆ†æ

| é£é™© | ç­‰çº§ | åº”å¯¹æªæ–½ |
|------|------|---------|
| **ç‰ˆæƒé—®é¢˜** | ğŸ”´ é«˜ | 1. ç”¨æˆ·åè®®ï¼šä¸Šä¼ è€…æ‰¿æ‹…ç‰ˆæƒè´£ä»»<br>2. æŠ•è¯‰æœºåˆ¶ï¼šæ”¯æŒç‰ˆæƒæ–¹ä¸¾è¯ä¸‹æ¶<br>3. å…¬å…±éŸ³ä¹åº“ï¼šä½¿ç”¨å…ç‰ˆæƒéŸ³ä¹ |
| **å­˜å‚¨æˆæœ¬** | ğŸŸ¡ ä¸­ | 1. IPFSè‡ªåŠ¨Pinæœºåˆ¶<br>2. ä¸‰é‡æ‰£æ¬¾æœºåˆ¶ï¼ˆPoolâ†’Subjectâ†’Callerï¼‰<br>3. éŸ³é¢‘å‹ç¼©ï¼ˆå»ºè®®128kbps MP3ï¼‰ |
| **å¸¦å®½æ¶ˆè€—** | ğŸŸ¡ ä¸­ | 1. ä½¿ç”¨IPFSç½‘å…³<br>2. æ”¯æŒå¤šç½‘å…³è´Ÿè½½å‡è¡¡<br>3. å®¢æˆ·ç«¯ç¼“å­˜ |
| **å†…å®¹å®¡æ ¸** | ğŸŸ¢ ä½ | 1. æ²»ç†å§”å‘˜ä¼šå®¡æ ¸å…¬å…±éŸ³ä¹<br>2. ç”¨æˆ·ä¸¾æŠ¥æœºåˆ¶<br>3. AIå†…å®¹æ£€æµ‹ï¼ˆå¯é€‰ï¼‰ |

---

## å››ã€å®æ–½æ–¹æ¡ˆä¸è·¯çº¿å›¾

### 4.1 MVPæ–¹æ¡ˆï¼ˆ2å‘¨ï¼‰

**ç›®æ ‡**: å¿«é€ŸéªŒè¯æ ¸å¿ƒåŠŸèƒ½

#### é˜¶æ®µ1: å‰ç«¯ç¡¬ç¼–ç å…¬å…±éŸ³ä¹åº“ï¼ˆ3å¤©ï¼‰

**ä»»åŠ¡**:
1. å‡†å¤‡5-10é¦–å…ç‰ˆæƒéŸ³ä¹ï¼ˆå“€ä¹ã€ä½›ä¹ã€è½»éŸ³ä¹ï¼‰
2. ä¸Šä¼ åˆ°IPFSå¹¶è·å–CID
3. å‰ç«¯ç¡¬ç¼–ç éŸ³ä¹åˆ—è¡¨
4. å®ç°éŸ³ä¹æ’­æ”¾å™¨ç»„ä»¶

**äº¤ä»˜ç‰©**:
- `src/constants/publicMusic.ts`
- `src/components/memorial/MusicPlayer.tsx`

---

#### é˜¶æ®µ2: é“¾ç«¯èƒŒæ™¯éŸ³ä¹å­—æ®µï¼ˆ5å¤©ï¼‰

**ä»»åŠ¡**:
1. ä¿®æ”¹ `Deceased` ç»“æ„ä½“
2. æ–°å¢ `set_background_music` æ¥å£
3. ç¼–å†™è¿ç§»è„šæœ¬
4. å•å…ƒæµ‹è¯•

**äº¤ä»˜ç‰©**:
- `pallets/deceased/src/lib.rs`ï¼ˆä¿®æ”¹ï¼‰
- `runtime/src/migrations.rs`ï¼ˆæ–°å¢ï¼‰
- å•å…ƒæµ‹è¯•

---

#### é˜¶æ®µ3: å‰ç«¯èƒŒæ™¯éŸ³ä¹è®¾ç½®ï¼ˆ3å¤©ï¼‰

**ä»»åŠ¡**:
1. çºªå¿µé¦†ç®¡ç†é¡µé¢æ·»åŠ "è®¾ç½®èƒŒæ™¯éŸ³ä¹"åŠŸèƒ½
2. éŸ³ä¹ä¸Šä¼ ç»„ä»¶
3. éŸ³ä¹æ’­æ”¾å™¨é›†æˆ
4. ç”¨æˆ·æµ‹è¯•

**äº¤ä»˜ç‰©**:
- `src/features/memorial/MemorialManagementPage.tsx`ï¼ˆæ‰©å±•ï¼‰
- `src/components/memorial/MusicUploader.tsx`ï¼ˆæ–°å¢ï¼‰

---

#### é˜¶æ®µ4: æµ‹è¯•ä¸å‘å¸ƒï¼ˆ1å¤©ï¼‰

**ä»»åŠ¡**:
1. åŠŸèƒ½æµ‹è¯•
2. æ€§èƒ½æµ‹è¯•
3. ç”¨æˆ·éªŒæ”¶

---

### 4.2 å®Œæ•´æ–¹æ¡ˆï¼ˆ1-2æœˆï¼‰

#### ç¬¬äºŒé˜¶æ®µ: å…¬å…±éŸ³ä¹åº“é“¾ä¸ŠåŒ–ï¼ˆ1å‘¨ï¼‰

**ä»»åŠ¡**:
1. è®¾è®¡ `PublicMusicLibrary` å­˜å‚¨ç»“æ„
2. å®ç°éŸ³ä¹ç®¡ç†æ¥å£
3. å‰ç«¯å…¬å…±éŸ³ä¹é€‰æ‹©å™¨
4. åˆå§‹åŒ–10é¦–éŸ³ä¹

---

#### ç¬¬ä¸‰é˜¶æ®µ: éŸ³ä¹ä¾›å¥‰åŠŸèƒ½ï¼ˆ2å‘¨ï¼‰

**ä»»åŠ¡**:
1. å®šä¹‰éŸ³ä¹ä¾›å¥‰å“è§„æ ¼
2. æ‰©å±•ä¾›å¥‰ç³»ç»Ÿæ”¯æŒéŸ³ä¹
3. å‰ç«¯éŸ³ä¹ä¾›å¥‰é¡µé¢
4. ä¾›å¥‰éŸ³ä¹æŸ¥è¯¢é€»è¾‘

---

#### ç¬¬å››é˜¶æ®µ: é«˜çº§åŠŸèƒ½ï¼ˆ2å‘¨ï¼‰

**å¯é€‰åŠŸèƒ½**:
1. **éŸ³ä¹æ’­æ”¾åˆ—è¡¨**: æ”¯æŒå¤šé¦–éŸ³ä¹å¾ªç¯æ’­æ”¾
2. **éŸ³ä¹åˆ†ç±»ç­›é€‰**: æŒ‰æƒ…ç»ª/åœºæ™¯ç­›é€‰å…¬å…±éŸ³ä¹
3. **éŸ³ä¹æ¨è**: æ ¹æ®é€è€…ä¿¡æ¯æ¨èåˆé€‚éŸ³ä¹
4. **éŸ³ä¹å¯è§†åŒ–**: éŸ³é¢‘æ³¢å½¢/é¢‘è°±å±•ç¤º
5. **ç¤¾äº¤åŠŸèƒ½**: éŸ³ä¹è¯„è®º/ç‚¹èµ

---

## äº”ã€æˆæœ¬ä¼°ç®—

### 5.1 å¼€å‘æˆæœ¬

| é˜¶æ®µ | å·¥ä½œé‡ | å¤‡æ³¨ |
|------|-------|------|
| MVPæ–¹æ¡ˆ | 2å‘¨ | æ ¸å¿ƒåŠŸèƒ½å¿«é€ŸéªŒè¯ |
| å®Œæ•´æ–¹æ¡ˆ | 1-2æœˆ | åŒ…å«é«˜çº§åŠŸèƒ½ |

### 5.2 è¿è¥æˆæœ¬

**å­˜å‚¨æˆæœ¬**:
```
å•é¦–éŸ³ä¹å¤§å°: 3MBï¼ˆ128kbpsï¼Œ3åˆ†é’Ÿï¼‰
IPFSå­˜å‚¨å•ä»·: 1 DUST/å‰¯æœ¬/æœˆ
å‰¯æœ¬æ•°: 3

å•é¦–éŸ³ä¹æœˆæˆæœ¬ = 3 DUST/æœˆ

å…¬å…±éŸ³ä¹åº“10é¦– = 30 DUST/æœˆ
ç”¨æˆ·ä¸Šä¼ 100é¦– = 300 DUST/æœˆï¼ˆç”±ç”¨æˆ·/ä¸“æˆ·æ‰¿æ‹…ï¼‰
```

**å¸¦å®½æˆæœ¬**:
```
å‡è®¾:
- æœˆè®¿é—®10,000æ¬¡
- æ¯æ¬¡æ’­æ”¾3åˆ†é’Ÿ
- å¸¦å®½æˆæœ¬: 0ï¼ˆIPFSå…¬å…±ç½‘å…³å…è´¹ï¼‰
```

---

## å…­ã€æ€»ç»“ä¸å»ºè®®

### 6.1 å¯è¡Œæ€§ç»“è®º

| ç»´åº¦ | è¯„åˆ† | ç»“è®º |
|------|------|------|
| **æŠ€æœ¯å¯è¡Œæ€§** | â­â­â­â­â­ | ç°æœ‰åŸºç¡€è®¾æ–½å®Œå–„ï¼Œæ”¹é€ æˆæœ¬ä½ |
| **ä¸šåŠ¡åˆç†æ€§** | â­â­â­â­â­ | æƒ…æ„Ÿä»·å€¼é«˜ï¼Œå•†ä¸šæ½œåŠ›å¤§ |
| **ç”¨æˆ·éœ€æ±‚** | â­â­â­â­ | æå‡ä½“éªŒï¼Œå·®å¼‚åŒ–ç«äº‰ |
| **é£é™©å¯æ§æ€§** | â­â­â­â­ | ä¸»è¦é£é™©å¯é€šè¿‡æŠ€æœ¯å’Œæµç¨‹è§„é¿ |

### 6.2 æ¨èæ–¹æ¡ˆ

âœ… **å¼ºçƒˆæ¨èå®æ–½**

**ç†ç”±**:
1. **æƒ…æ„Ÿä»·å€¼æé«˜**: éŸ³ä¹æ˜¯çºªå¿µæ–‡åŒ–çš„é‡è¦ç»„æˆéƒ¨åˆ†
2. **æŠ€æœ¯æˆç†Ÿ**: é“¾ç«¯å·²æ”¯æŒAudioç±»å‹ï¼Œå‰ç«¯æœ‰å®Œå–„åŸºç¡€
3. **å•†ä¸šæ½œåŠ›**: éŸ³ä¹ä¾›å¥‰å¯å¸¦æ¥æ–°çš„æ”¶å…¥æ¥æº
4. **ç«äº‰ä¼˜åŠ¿**: å·®å¼‚åŒ–åŠŸèƒ½ï¼Œæå‡äº§å“ç«äº‰åŠ›

**å®æ–½å»ºè®®**:
1. **å…ˆå®æ–½MVPæ–¹æ¡ˆ**ï¼ˆ2å‘¨ï¼‰éªŒè¯éœ€æ±‚
2. æ ¹æ®ç”¨æˆ·åé¦ˆè¿­ä»£å®Œå–„
3. é€æ­¥æ·»åŠ é«˜çº§åŠŸèƒ½
4. é‡ç‚¹å…³æ³¨ç‰ˆæƒé£é™©ï¼Œå»ºç«‹å®Œå–„çš„æ³•å¾‹ä¿æŠ¤æœºåˆ¶

---

### 6.3 å…³é”®æˆåŠŸå› ç´ 

1. **éŸ³ä¹è´¨é‡**: å…¬å…±éŸ³ä¹åº“é€‰æ‹©é«˜è´¨é‡ã€æƒ…æ„Ÿé€‚é…çš„éŸ³ä¹
2. **ç”¨æˆ·ä½“éªŒ**: æ’­æ”¾å™¨è®¾è®¡ç®€æ´ç›´è§‚ï¼Œæ“ä½œæµç•…
3. **æ€§èƒ½ä¼˜åŒ–**: éŸ³é¢‘åŠ è½½é€Ÿåº¦ï¼Œæ’­æ”¾ç¨³å®šæ€§
4. **åˆè§„é£é™©**: ç‰ˆæƒåè®®æ¸…æ™°ï¼ŒæŠ•è¯‰æœºåˆ¶å®Œå–„
5. **è¿è¥æ¨å¹¿**: å¼•å¯¼ç”¨æˆ·ä½¿ç”¨éŸ³ä¹ä¾›å¥‰åŠŸèƒ½

---

**åˆ†æå®Œæˆæ—¶é—´**: 2025-11-23
**åˆ†æäºº**: Claude Code
**å»ºè®®ä¼˜å…ˆçº§**: â­â­â­â­â­ï¼ˆå¼ºçƒˆæ¨èï¼‰
