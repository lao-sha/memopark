# 签名错误排查指南

## 错误：Transaction has a bad signature (1010)

### 问题描述

提交交易时出现错误：
```
1010: Invalid Transaction: Transaction has a bad signature
```

### 根本原因

**当前选中的账户**与**本地 keystore 解密出的账户**不匹配，导致签名无效。

### 典型场景

**场景 1**：多账户混淆
- 前端显示当前账户是 Alice
- 但本地 keystore 存储的是 Bob 的密钥
- 签名时用 Bob 的密钥给 Alice 的交易签名 → 失败

**场景 2**：未切换账户
- 创建钱包时生成了账户 A
- 想用委员会账户 Alice 操作
- 但没有 Alice 的 keystore，仍在使用账户 A

## 解决方案

### 方案 1：使用正确的账户（推荐）

**步骤**：

1. **检查当前账户**
   - 查看页面顶部或设置中显示的当前地址
   - 例如：`5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY`

2. **检查是否有该账户的 keystore**
   - 前往"创建钱包"或"登录"页面
   - 查看账户列表
   - 确认当前账户在列表中

3. **如果账户不在列表**
   - **选项 A**：导入该账户的助记词
     - 点击"从助记词导入"
     - 输入 Alice 的助记词（开发模式：`//Alice`）
     - 设置密码
   
   - **选项 B**：切换到已有账户
     - 在账户列表选择已有账户
     - 点击"切换"

### 方案 2：导入开发账户（测试环境）

如果是开发模式，可以导入测试账户：

**Alice（Sudo + 委员会）**：
```
助记词：bottom drive obey lake curtain smoke basket hold race lonely fit walk
或简写：//Alice
```

**Bob（委员会）**：
```
助记词：//Bob
```

**Charlie（委员会）**：
```
助记词：//Charlie
```

**导入步骤**：
1. 访问创建钱包页面
2. 选择"从助记词导入"
3. 粘贴助记词（例如：`//Alice`）
4. 设置密码（建议：至少 8 位）
5. 确认导入

### 方案 3：使用 Polkadot.js Apps（临时方案）

如果本地 keystore 配置复杂，可以临时使用 Polkadot.js Apps：

1. 访问：https://polkadot.js.org/apps
2. 连接到：ws://127.0.0.1:9944
3. Developer → Extrinsics
4. 使用委员会账户提交提案

## 验证步骤

### 1. 确认当前账户

在浏览器控制台运行：
```javascript
localStorage.getItem('mp.current')
// 输出：当前选中的地址
```

### 2. 确认 keystore 地址

在浏览器控制台运行：
```javascript
JSON.parse(localStorage.getItem('mp.keystores') || '[]').map(k => k.address)
// 输出：所有已保存的 keystore 地址
```

### 3. 确认地址匹配

两个地址应该一致。如果不一致，说明需要：
- 导入正确账户的 keystore
- 或切换到已有账户

## 改进说明（已实施）

**新增地址验证**：
- 签名前自动检查地址是否匹配
- 不匹配时抛出友好错误提示
- 明确指出当前地址和 keystore 地址

**错误提示示例**：
```
地址不匹配：当前账户是 5GrwvaEF5...，但 keystore 解密出的是 5FHneW46x...。
请检查是否选择了正确的账户。
```

## 委员会成员配置

### 开发环境（推荐配置）

建议导入所有测试账户：

| 账户 | 助记词 | 角色 |
|------|--------|------|
| Alice | `//Alice` | Sudo + 委员会 |
| Bob | `//Bob` | 委员会 |
| Charlie | `//Charlie` | 委员会 |

**批量导入步骤**：
1. 导入 Alice（设置密码，例如：`password123`）
2. 导入 Bob（设置密码，例如：`password123`）
3. 导入 Charlie（设置密码，例如：`password123`）

**使用时**：
- 提交提案：切换到任一委员会成员
- 投票：切换到其他委员会成员
- 执行：切换到任意账户

### 切换账户

1. 访问"登录"页面或"设置"
2. 选择要切换的账户
3. 点击"切换账户"按钮
4. 当前地址会更新

## 测试流程

### 完整测试（3 个账户）

1. **准备**
   - 导入 Alice、Bob、Charlie
   - 配置委员会成员（使用 Alice 的 Sudo）

2. **创建申请**
   - 使用任意账户
   - 访问 `#/otc/mm-apply`
   - 完成 lock_deposit 和 submit_info

3. **提交提案**
   - 切换到 Alice
   - 访问 `#/gov/council-proposals`
   - 提交批准提案（threshold=2）
   - 复制提案哈希

4. **投票**
   - 切换到 Bob
   - 刷新提案列表
   - 点击"赞成"

5. **执行**
   - 切换到任意账户（或保持 Bob）
   - 点击"执行提案"

6. **验证**
   - 访问 `#/gov/mm-review`
   - 申请应在"已批准"列表

## 常见问题

### Q: 如何查看当前使用的是哪个账户？

**答案**：
- 查看页面顶部的账户栏
- 或打开浏览器控制台：`localStorage.getItem('mp.current')`

### Q: 如何导入开发测试账户？

**答案**：
1. 访问创建钱包页面
2. 选择"从助记词导入"
3. 输入 `//Alice`（或 `//Bob`、`//Charlie`）
4. 设置密码

### Q: 密码忘记了怎么办？

**答案**：
- 无法恢复密码
- 但可以用助记词重新导入
- 使用相同助记词、新密码即可

### Q: 如何切换账户？

**答案**：
1. 访问"登录"页面
2. 从账户列表选择
3. 点击"切换账户"

或使用浏览器控制台：
```javascript
localStorage.setItem('mp.current', '新地址')
window.location.reload()
```

## 技术细节

### 地址验证逻辑（新增）

```typescript
// 1. 获取当前地址
const currentAddr = getCurrentAddress()

// 2. 解密 keystore 得到密钥对
const pair = keyring.addFromUri(mnemonic)

// 3. 验证地址是否匹配
if (pair.address !== currentAddr) {
  throw new Error('地址不匹配...')
}
```

### Keystore 查找逻辑

```typescript
export function loadCurrentKeystore(): LocalKeystore | null {
  // 1. 获取当前地址
  const cur = getCurrentAddress()
  
  // 2. 从多账户存储中查找
  const byCur = loadKeystoreByAddress(cur)
  if (byCur) return byCur
  
  // 3. 回退到旧版单账户存储
  const legacy = loadLocalKeystore()
  return legacy
}
```

## 相关文档

- **委员会配置**：查看 Polkadot.js Apps 配置委员会成员
- **使用指南**：`docs/委员会提案UI快速开始.md`
- **技术文档**：`pallets/market-maker/README.md`

---

**总结**：确保当前选中的账户与本地 keystore 存储的账户一致，签名才能成功。
