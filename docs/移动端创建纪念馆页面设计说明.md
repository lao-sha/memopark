# 移动端创建纪念馆页面设计说明

> **创建日期**: 2025-11-07  
> **版本**: 1.0.0  
> **路由**: `#/grave/create`  
> **设计风格**: 移动端专用  

---

## 📱 设计概述

创建纪念馆页面采用移动端专用设计，去除所有响应式自适应代码，专注于触控体验优化和清晰的信息层次。

### 核心特点

- ✅ **移动端专用**: 固定宽度布局，去除所有响应式代码
- ✅ **触控优化**: 所有交互元素都有触控反馈
- ✅ **步骤清晰**: 三步流程，进度可视化
- ✅ **信息分层**: 卡片式布局，层次清晰
- ✅ **安全可靠**: 密码确认，交易上链
- ✅ **主题色统一**: 遵循项目色彩规范

---

## 🎨 设计规范

### 色彩方案

| 颜色类型 | 色值 | 用途 |
|---------|------|------|
| **主色** | `#B8860B` | 顶部导航、提交按钮、步骤图标 |
| **辅色** | `#2F4F4F` | 标题文字、表单标签 |
| **强调色** | `#DC143C` | 费用提示 |
| **背景色** | `#F5F5DC` | 页面背景 |
| **卡片背景** | `#FFFFFF` | 卡片容器 |

### 渐变配色

```css
/* 顶部导航渐变 */
linear-gradient(135deg, #B8860B 0%, #2F4F4F 100%)

/* 提交按钮渐变 */
linear-gradient(135deg, #B8860B 0%, #D4AF37 100%)

/* 步骤图标渐变 */
linear-gradient(135deg, #B8860B 0%, #D4AF37 100%)  /* 当前步骤 */
linear-gradient(135deg, #2F4F4F 0%, #5F9EA0 100%)  /* 完成步骤 */
```

### 尺寸规范

- **页面最大宽度**: 480px（大屏居中）
- **内边距**: 16px（标准）、20px（卡片）
- **卡片圆角**: 12px
- **按钮圆角**: 24px（圆形）、8px（输入框）
- **按钮高度**: 48px

### 字体规范

- **页面标题**: 18px, font-weight: 600
- **卡片标题**: 16px, font-weight: 600
- **表单标签**: 15px, font-weight: 600
- **正文**: 13-15px, font-weight: 400
- **辅助文字**: 12-13px, color: #708090

---

## 📐 页面结构

### 1. 顶部导航栏（Header）

**功能**: 返回导航和页面标题

**组成元素**:
- 返回按钮（左侧，白色图标）
- 页面标题："创建纪念馆"（居中）
- 占位元素（右侧，保持平衡）

**技术要点**:
```tsx
<div className="mobile-page-header">
  <Button 
    type="text" 
    icon={<ArrowLeftOutlined style={{ fontSize: 20 }} />} 
    onClick={() => window.history.back()}
    className="mobile-back-button"
  />
  <Title level={4} className="mobile-page-title">创建纪念馆</Title>
  <div style={{ width: 40 }} />
</div>
```

**样式特色**:
- 渐变背景（深金色→墨绿色）
- 固定顶部（sticky）
- 白色文字和图标
- 点击缩放反馈（:active scale(0.95)）

---

### 2. 进度指示器（Steps）

**功能**: 显示创建流程的三个步骤

**步骤列表**:
1. **填写信息** - UserOutlined - 输入基本信息
2. **提交上链** - HomeOutlined - 签名并提交交易
3. **完成** - CheckCircleOutlined - 创建成功

**状态管理**:
```tsx
const [currentStep, setCurrentStep] = useState(0)

// 点击提交时
setCurrentStep(1)

// 交易成功时
setCurrentStep(2)

// 交易失败时
setCurrentStep(0)
```

**技术要点**:
```tsx
<Card className="mobile-steps-card">
  <Steps current={currentStep} size="small">
    <Step title="填写信息" icon={<UserOutlined />} />
    <Step title="提交上链" icon={<HomeOutlined />} />
    <Step title="完成" icon={<CheckCircleOutlined />} />
  </Steps>
</Card>
```

**样式特色**:
- 小尺寸步骤条
- 当前步骤：深金色渐变图标
- 完成步骤：墨绿色渐变图标
- 淡入动画（0.5s）

---

### 3. 提示信息区域（Alerts）

#### 3.1 温馨提示（Info Alert）

**内容**:
- 纪念馆名称将永久保存在区块链上
- 可以是个人纪念馆或家族纪念馆
- 名称提交后无法修改，请仔细核对

**图标**: InfoCircleOutlined  
**类型**: info  
**颜色**: 蓝色系

#### 3.2 费用说明（Warning Alert）

**内容**:
- 一次性创建费：X.XX DUST（从链上读取）
- 另需支付链上交易费（根据网络状况动态调整）

**图标**: DollarOutlined  
**类型**: warning  
**颜色**: 黄色系

**技术要点**:
```tsx
<Alert
  type="info"
  icon={<InfoCircleOutlined />}
  showIcon
  message="温馨提示"
  description={
    <div className="alert-content">
      <p>• 纪念馆名称将永久保存在区块链上</p>
      <p>• 可以是个人纪念馆或家族纪念馆</p>
      <p>• 名称提交后无法修改，请仔细核对</p>
    </div>
  }
  className="mobile-alert"
/>
```

**样式特色**:
- 圆角 12px
- 2px 边框
- 淡入动画
- 内容字号 13px

---

### 4. 创建表单（Form）

#### 4.1 园区ID（可选）

**字段名**: `park_id`  
**类型**: InputNumber  
**验证**: 无（可选字段）  
**提示**: "留空表示暂不隶属任何园区"

**技术要点**:
```tsx
<Form.Item 
  name="park_id" 
  label={<Text strong>园区ID（可选）</Text>}
  extra="留空表示暂不隶属任何园区"
>
  <InputNumber 
    min={0} 
    style={{ width: '100%' }} 
    placeholder="请输入园区ID（可选）"
    size="large"
  />
</Form.Item>
```

#### 4.2 纪念馆名称（必填）

**字段名**: `name_plain`  
**类型**: Input  
**验证**: 
- 必填
- 最大长度：从链上读取 `maxCidLen`（默认100字节）

**提示**: "最多 X 字节（约 Y 个中文字符）"

**编码处理**:
```tsx
// 将字符串编码为字节数组
const nameBytes = Array.from(new TextEncoder().encode(namePlain))

// 验证字节长度
if (maxCidLen && nameBytes.length > maxCidLen) {
  return message.warning(`名称字节长度超限（${nameBytes.length}/${maxCidLen}）`)
}
```

**技术要点**:
```tsx
<Form.Item 
  name="name_plain" 
  label={
    <span>
      <Text strong>纪念馆名称</Text>
      <Text type="danger"> *</Text>
    </span>
  }
  rules={[
    { required: true, message: '请输入纪念馆名称' },
    { 
      max: maxCidLen || 100, 
      message: `名称不能超过 ${maxCidLen || 100} 字节` 
    }
  ]}
  extra={`最多 ${maxCidLen || 100} 字节（约 ${Math.floor((maxCidLen || 100) / 3)} 个中文字符）`}
>
  <Input 
    placeholder="请输入纪念馆名称（如：张氏纪念馆）" 
    maxLength={maxCidLen || 100}
    size="large"
  />
</Form.Item>
```

#### 4.3 提交按钮

**功能**: 提交表单，打开密码确认弹窗

**状态**:
- 正常：显示"创建纪念馆"
- 加载中：显示"正在提交..."，loading 动画
- 成功后：显示"创建成功"，禁用按钮

**技术要点**:
```tsx
<Button 
  type="primary" 
  htmlType="submit" 
  loading={loading} 
  block 
  size="large"
  className="mobile-submit-button"
  disabled={currentStep === 2}
>
  {loading ? '正在提交...' : currentStep === 2 ? '创建成功' : '创建纪念馆'}
</Button>
```

**样式特色**:
- 高度 48px
- 圆角 24px（圆形）
- 深金色渐变背景
- 阴影效果
- 点击缩放反馈（:active scale(0.98)）

#### 4.4 快捷入口

**功能**: 跳转到创建逝者档案页面

**技术要点**:
```tsx
<div className="mobile-quick-link">
  <Button 
    type="link"
    onClick={() => { 
      window.location.hash = '#/deceased/create' 
    }}
  >
    或者，直接创建逝者档案 →
  </Button>
</div>
```

---

### 5. 密码确认弹窗（Modal）

**功能**: 输入钱包密码以签名交易

**触发时机**: 点击"创建纪念馆"按钮，表单验证通过后

**组成元素**:
- 标题："输入签名密码"
- 提示文字："请输入钱包密码以完成上链交易"
- 密码输入框（至少8位）
- 确认按钮："确认创建"
- 取消按钮："取消"

**技术要点**:
```tsx
<Modal
  open={pwdOpen}
  title="输入签名密码"
  onCancel={() => { 
    setPwdOpen(false)
    setLoading(false)
    setCurrentStep(0)
  }}
  onOk={onConfirmPassword}
  okText="确认创建"
  cancelText="取消"
  confirmLoading={confirmLoading}
  centered
  className="mobile-password-modal"
>
  <Paragraph style={{ textAlign: 'center', marginBottom: 16, color: '#708090' }}>
    请输入钱包密码以完成上链交易
  </Paragraph>
  <Input.Password 
    placeholder="至少 8 位密码" 
    value={pwdVal} 
    onChange={e => setPwdVal(e.target.value)}
    size="large"
  />
</Modal>
```

**密码验证**:
```tsx
if (!pwdVal || pwdVal.length < 8) { 
  return message.warning('请输入至少 8 位签名密码') 
}
```

**样式特色**:
- 居中显示
- 圆角 16px
- 渐变背景标题栏
- 深金色确认按钮

---

### 6. 使用说明卡片（Guide）

#### 6.1 创建流程

**步骤展示**: 1-2-3-4 四个步骤

1. **填写信息** - 输入纪念馆名称
2. **提交上链** - 输入密码确认
3. **获得ID** - 系统分配10位编号
4. **添加逝者** - 完善纪念馆内容

**技术要点**:
```tsx
<div className="mobile-guide-steps">
  <div className="mobile-guide-step">
    <div className="mobile-step-number">1</div>
    <div className="mobile-step-content">
      <Text strong style={{ display: 'block', marginBottom: 4 }}>填写信息</Text>
      <Text type="secondary" style={{ fontSize: 13 }}>输入纪念馆名称</Text>
    </div>
  </div>
  {/* ...更多步骤 */}
</div>
```

**样式特色**:
- 圆形步骤编号（32px）
- 深金色渐变背景
- 浅色背景卡片
- 点击缩放反馈

#### 6.2 注意事项

**内容列表**:
- 名称将永久保存在区块链上，提交后无法修改
- 可使用个人姓名或家族名称，便于亲友搜索
- 创建费用将从账户余额中扣除
- 请确保账户余额充足

**样式特色**:
- 无序列表
- 深金色圆点标记
- 灰色文字（#708090）
- 字号 13px

---

## 🔧 技术实现

### 链上数据读取

**读取的链上常量**:
1. **创建费用**: `api.consts.memoGrave.createFee`
2. **最大CID长度**: `api.consts.memoGrave.maxCidLen`
3. **代币符号**: `api.registry.chainTokens[0]`
4. **代币精度**: `api.registry.chainDecimals[0]`

```tsx
React.useEffect(() => {
  let mounted = true
  ;(async () => {
    try {
      const api = await getApi()
      const sym = (api.registry.chainTokens?.[0] as string) || 'DUST'
      const dec = api.registry.chainDecimals?.[0] ?? 12
      const feeConst: any = (api.consts as any)?.memoGrave?.createFee
      const maxLenConst: any = (api.consts as any)?.memoGrave?.maxCidLen
      const feeStr = feeConst ? feeConst.toString() : '0'
      const maxLen = maxLenConst ? Number(maxLenConst.toString()) : 0
      if (!mounted) return
      setTokenSymbol(sym)
      setDecimals(dec)
      setCreateFee(feeStr)
      setMaxCidLen(maxLen)
    } catch (e) {
      // 忽略：链未连上时仍可渲染表单
    }
  })()
  return () => { mounted = false }
}, [])
```

### 交易提交流程

**流程图**:
```
用户提交表单
  ↓
验证表单数据
  ↓
编码纪念馆名称
  ↓
构建交易参数
  ↓
打开密码弹窗
  ↓
用户输入密码
  ↓
验证密码长度
  ↓
签名并发送交易
  ↓
等待交易上链
  ↓
显示交易结果
  ↓
跳转到我的纪念馆
```

**代码实现**:
```tsx
// 1. 提交表单
const onFinish = React.useCallback(async (values: any) => {
  try {
    setLoading(true)
    setCurrentStep(1) // 进入提交步骤
    
    const parkIdInput = values.park_id
    const namePlain: string = (values.name_plain || '').trim()
    
    // 验证
    if (!namePlain) { 
      setLoading(false)
      setCurrentStep(0)
      return message.warning('请填写纪念馆名称') 
    }
    
    // 编码
    const nameBytes = Array.from(new TextEncoder().encode(namePlain))
    if (maxCidLen && nameBytes.length > maxCidLen) {
      setLoading(false)
      setCurrentStep(0)
      return message.warning(`名称字节长度超限（${nameBytes.length}/${maxCidLen}）`)
    }
    
    // 构建参数
    const parkIdOpt = (parkIdInput === null || parkIdInput === undefined || parkIdInput === '') 
      ? null 
      : Number(parkIdInput)
    
    // 动态解析 section 名称
    let section = 'memoGrave'
    const api = await getApi()
    const txRoot: any = api.tx as any
    const candidates = ['memoGrave', 'memo_grave', 'grave']
    for (const s of candidates) {
      const m = txRoot[s]
      if (m && typeof m.createGrave === 'function') { 
        section = s
        break 
      }
    }
    
    const args: any[] = [ parkIdOpt, nameBytes ]
    txCtxRef.current = { section, args }
    setPwdVal('')
    setPwdOpen(true)
  } catch (e: any) {
    setCurrentStep(0)
    message.error('提交失败')
  } finally {
    setLoading(false)
  }
}, [maxCidLen])

// 2. 确认密码并提交
const onConfirmPassword = React.useCallback(async () => {
  if (!txCtxRef.current) { 
    setPwdOpen(false)
    setLoading(false)
    setCurrentStep(0)
    return 
  }
  if (!pwdVal || pwdVal.length < 8) { 
    return message.warning('请输入至少 8 位签名密码') 
  }
  
  const { section, args } = txCtxRef.current
  const key = 'tx-create-grave'
  try {
    setConfirmLoading(true)
    message.loading({ key, content: '正在提交交易…' })
    
    const txHash = await signAndSendLocalWithPassword(section, 'createGrave', args, pwdVal)
    
    message.success({ key, content: `创建成功：${txHash}` })
    setPwdOpen(false)
    form.resetFields()
    setCurrentStep(2) // 完成步骤
    
    // 延迟跳转
    setTimeout(() => {
      window.location.hash = '#/grave/my' 
    }, 2000)
  } catch (e: any) {
    setCurrentStep(0)
    message.error({ key, content: '提交失败' })
  } finally {
    setConfirmLoading(false)
    setLoading(false)
  }
}, [pwdVal, form])
```

### 错误处理

**常见错误及处理**:

1. **密码错误**:
   ```tsx
   if (/密码|password/i.test(String(e?.message||''))) {
     message.error('密码错误或解密失败，请重试')
   }
   ```

2. **未找到钱包**:
   ```tsx
   if (/未找到本地钱包/.test(msg)) {
     Modal.confirm({
       title: '未发现本地钱包',
       content: '请先创建或导入钱包后再试。',
       okText: '去创建/导入',
       cancelText: '取消',
       onOk: () => { 
         window.location.hash = '#/wallet'
       }
     })
   }
   ```

3. **名称超长**:
   ```tsx
   if (maxCidLen && nameBytes.length > maxCidLen) {
     return message.warning(`名称字节长度超限（${nameBytes.length}/${maxCidLen}）`)
   }
   ```

---

## 🎯 交互设计

### 触控反馈

所有可点击元素都有明确的触控反馈：

```css
/* 返回按钮 */
.mobile-back-button:active {
  transform: scale(0.95);
}

/* 提交按钮 */
.mobile-submit-button:active {
  transform: scale(0.98);
}

/* 步骤卡片 */
.mobile-guide-step:active {
  background: rgba(245, 245, 220, 0.5);
  transform: scale(0.98);
}
```

### 动画效果

1. **页面进入动画**:
   - 整体淡入（0.4s）
   
2. **卡片淡入动画**:
   - 从下方 20px 淡入
   - 错峰延迟（0s, 0.2s, 0.3s）
   
3. **步骤进度**:
   - 当前步骤：深金色渐变图标
   - 完成步骤：墨绿色渐变图标
   - 平滑过渡

### 状态管理

```tsx
// 当前步骤
const [currentStep, setCurrentStep] = useState(0)
  // 0: 填写信息
  // 1: 提交上链
  // 2: 完成

// 加载状态
const [loading, setLoading] = useState(false)

// 密码弹窗
const [pwdOpen, setPwdOpen] = useState(false)
const [pwdVal, setPwdVal] = useState('')
const [confirmLoading, setConfirmLoading] = useState(false)
```

---

## 📱 屏幕适配

### 标准屏幕（375px - 480px）

默认设计尺寸，最佳体验：
- 内边距 16px
- 卡片内边距 20px
- 按钮高度 48px

### 小屏幕（< 360px）

自动优化：
- 内边距 12px
- 卡片内边距 16px
- 按钮高度 44px
- 步骤编号 28px

```css
@media (max-width: 360px) {
  .mobile-page-content {
    padding: 12px;
  }

  .mobile-form-card .ant-card-body,
  .mobile-guide-card .ant-card-body {
    padding: 16px;
  }

  .mobile-submit-button {
    height: 44px;
    font-size: 15px;
  }
}
```

### 大屏幕（> 768px）

自动限制：
- 最大宽度 480px
- 居中显示
- 添加阴影效果

```css
@media (min-width: 768px) {
  .mobile-create-grave-page {
    max-width: 480px;
    margin: 0 auto;
    box-shadow: 0 0 24px rgba(0, 0, 0, 0.1);
  }
}
```

---

## 📝 使用说明

### 访问页面

```
#/grave/create
```

### 创建流程

1. **填写信息**
   - 输入园区ID（可选）
   - 输入纪念馆名称（必填）
   
2. **提交上链**
   - 点击"创建纪念馆"按钮
   - 在弹窗中输入钱包密码
   - 点击"确认创建"
   
3. **等待交易**
   - 显示"正在提交交易…"提示
   - 等待交易上链确认
   
4. **创建成功**
   - 显示交易哈希
   - 自动跳转到"我的纪念馆"页面

### 快捷操作

- **返回上一页**: 点击左上角返回按钮
- **创建逝者**: 点击表单下方的"直接创建逝者档案"链接
- **查看我的**: 创建成功后自动跳转

---

## ⚠️ 注意事项

### 设计约束

1. ✅ **仅移动端**: 不考虑PC端自适应
2. ✅ **固定宽度**: 最大宽度 480px
3. ✅ **触控优先**: 所有交互针对触控优化
4. ✅ **去除hover**: 移动端禁用hover效果

### 开发规范

1. 所有代码必须有详细的中文注释
2. 遵循项目色彩规范
3. 保持组件化设计
4. 优化加载性能

### 数据验证

1. **纪念馆名称**: 
   - 必填
   - 最大长度从链上读取（默认100字节）
   - UTF-8编码，1个中文字符≈3字节
   
2. **园区ID**: 
   - 可选
   - 必须为非负整数
   
3. **钱包密码**: 
   - 至少8位
   - 用于签名交易

### 错误处理

1. **表单验证错误**: 显示警告提示
2. **密码错误**: 显示错误提示，允许重试
3. **未找到钱包**: 弹窗提示，引导创建钱包
4. **交易失败**: 显示详细错误信息，重置状态

---

## 🚀 后续优化

### 已完成

- [x] 移动端专用设计
- [x] 去除响应式代码
- [x] 触控反馈优化
- [x] 步骤进度可视化
- [x] 密码确认弹窗
- [x] 错误处理机制

### 待优化

- [ ] 添加骨架屏加载
- [ ] 添加下拉刷新
- [ ] 优化交易等待体验
- [ ] 添加创建成功动画
- [ ] 支持图片上传封面
- [ ] 添加暗色模式

---

## 📚 相关文档

- `项目索引.md` - 项目完整信息
- `.cursorrules` - 项目开发规范
- `移动端首页设计说明.md` - 首页设计文档
- `pallet-memo-grave/README.md` - 纪念馆Pallet说明

---

## 👨‍💻 维护信息

- **创建日期**: 2025-11-07
- **维护团队**: Stardust 开发团队
- **文件路径**: `/home/xiaodong/文档/stardust/stardust-dapp/src/features/grave/`
  - `CreateGravePage.tsx` - 组件代码
  - `CreateGravePage.css` - 样式代码

---

## 🔗 相关链接

### 路由跳转

- **返回首页**: `#/home`
- **我的纪念馆**: `#/grave/my`
- **创建逝者**: `#/deceased/create`
- **钱包管理**: `#/wallet`

### Pallet 接口

```rust
// 链上调用
memoGrave.createGrave(parkId: Option<u32>, name: Vec<u8>)

// 链上常量
memoGrave.createFee: Balance
memoGrave.maxCidLen: u32
```

---

**让记忆永存，让爱延续** ✨

