# 我的钱包 - 昵称设置功能实现说明

## 📋 需求概述

在"我的钱包"页面,将个人中心页面(旧)的昵称设置功能迁移过来,放在"当前钱包"字样的前面,用空格分开。如果没有设置昵称,默认显示"亲友"。显示可修改图标,点击图标进入签名修改流程。

---

## 🎯 实现目标

1. ✅ 在"当前钱包"前显示昵称
2. ✅ 昵称和"当前钱包"用空格分开
3. ✅ 未设置昵称时默认显示"亲友"
4. ✅ 显示可修改图标 (✏️ EditOutlined)
5. ✅ 点击图标打开编辑弹窗
6. ✅ 通过签名交易修改昵称
7. ✅ 从链上 pallet-identity 读取昵称
8. ✅ 账户切换时自动加载新账户的昵称

---

## 🔧 核心实现

### 1. 数据来源

**链上存储**: `pallet-identity`
- **查询接口**: `api.query.identity.identityOf(address)`
- **字段路径**: `Registration.info.display`
- **数据类型**: `Data` 枚举 (Raw/None/...)

**保存接口**: `identity.setIdentity`
- **参数**: `{ display: { Raw: nickname } }`
- **需要签名**: 是

---

### 2. 状态管理

```typescript
const [nickname, setNickname] = useState<string>('');
const [editModalVisible, setEditModalVisible] = useState<boolean>(false);
const [loading, setLoading] = useState<boolean>(false);
const [form] = Form.useForm();
```

**状态说明**:
- `nickname`: 当前显示的昵称
- `editModalVisible`: 编辑弹窗的显示状态
- `loading`: 保存时的加载状态
- `form`: Ant Design 表单实例

---

### 3. 核心函数

#### 3.1 loadNickname()

```typescript
/**
 * 函数级详细中文注释：加载当前账户的昵称
 * - 从链上 pallet-identity 读取 display 字段
 * - 如果未设置，默认显示"亲友"
 */
const loadNickname = async (addr: string) => {
  try {
    const api = await getApi();
    const raw = await (api.query as any).identity?.identityOf?.(addr);
    if (raw && raw.isSome) {
      const reg = raw.unwrap();
      const disp = reg.info?.display;
      let value = '';
      if (disp) {
        if (disp.isRaw) value = Buffer.from(disp.asRaw.toU8a()).toString('utf8');
        else if (disp.isNone) value = '';
        else if (disp.asBytes) value = Buffer.from(disp.asBytes.toU8a()).toString('utf8');
        else value = String(disp.toString?.() || '');
      }
      setNickname(value || '亲友');
    } else {
      setNickname('亲友');
    }
  } catch (e: any) {
    console.warn('加载昵称失败:', e);
    setNickname('亲友');
  }
};
```

**执行流程**:
```
1. 获取 API 实例
   ↓
2. 查询 identity.identityOf(address)
   ↓
3. 检查返回值是否存在
   ↓
4. 解析 Registration.info.display
   ↓
5. 处理不同的 Data 类型 (Raw/None/Bytes)
   ↓
6. 设置昵称或默认"亲友"
```

**数据类型处理**:
- `isRaw`: 原始字节,转换为 UTF-8 字符串
- `isNone`: 空值,使用默认值"亲友"
- `asBytes`: 字节数组,转换为 UTF-8 字符串
- 其他: 调用 `toString()` 方法

---

#### 3.2 handleEditNickname()

```typescript
/**
 * 函数级详细中文注释：打开编辑昵称弹窗
 * - 显示编辑弹窗
 * - 设置当前昵称到表单
 */
const handleEditNickname = () => {
  form.setFieldsValue({ nickname: nickname === '亲友' ? '' : nickname });
  setEditModalVisible(true);
};
```

**逻辑说明**:
- 如果当前显示"亲友"(默认值),表单输入框为空
- 如果有自定义昵称,显示在表单输入框
- 打开编辑弹窗

---

#### 3.3 handleSaveNickname()

```typescript
/**
 * 函数级详细中文注释：保存昵称到链上
 * - 使用 identity.setIdentity 交易
 * - 需要用户签名
 * - 成功后更新显示
 */
const handleSaveNickname = async (values: any) => {
  try {
    if (!address) {
      message.warning('请先连接钱包');
      return;
    }
    const name = String(values.nickname || '').trim();
    if (!name) {
      message.warning('请输入昵称');
      return;
    }
    setLoading(true);
    const args = [{ display: { Raw: name } }];
    const hash = await signAndSendLocalFromKeystore('identity', 'setIdentity', args);
    message.success(`昵称已保存，交易哈希: ${hash.slice(0, 10)}...`);
    setNickname(name);
    setEditModalVisible(false);
    form.resetFields();
  } catch (e: any) {
    message.error(e?.message || '保存失败');
  } finally {
    setLoading(false);
  }
};
```

**执行流程**:
```
1. 验证钱包已连接
   ↓
2. 验证昵称非空
   ↓
3. 设置加载状态
   ↓
4. 构造交易参数 { display: { Raw: name } }
   ↓
5. 调用 signAndSendLocalFromKeystore 签名并发送
   ↓
6. 等待用户签名确认
   ↓
7. 交易上链成功
   ↓
8. 更新本地显示
   ↓
9. 关闭弹窗
```

**关键点**:
- ✅ 使用 `signAndSendLocalFromKeystore` 本地签名
- ✅ 需要用户输入密码解密密钥
- ✅ 交易上链需要消耗 Gas
- ✅ 成功后立即更新本地显示

---

#### 3.4 handleCancelEdit()

```typescript
/**
 * 函数级详细中文注释：取消编辑
 * - 关闭弹窗
 * - 重置表单
 */
const handleCancelEdit = () => {
  setEditModalVisible(false);
  form.resetFields();
};
```

---

### 4. UI 实现

#### 4.1 昵称显示区域

**位置**: 顶部头像区域,标题部分

**布局**:
```
┌─────────────────────────────┐
│  👤  亲友 ✏️ 当前钱包        │
│      5Cakw2y5...kPu6vj8      │
└─────────────────────────────┘
```

**代码**:
```typescript
<div style={{ display: 'flex', alignItems: 'center', gap: '8px', marginBottom: '4px' }}>
  {/* 昵称 */}
  <Text strong style={{ fontSize: '18px' }}>
    {nickname}
  </Text>
  
  {/* 编辑图标 */}
  <EditOutlined
    onClick={handleEditNickname}
    style={{
      fontSize: '14px',
      color: '#8c8c8c',
      cursor: 'pointer',
      transition: 'color 0.3s',
    }}
    onMouseEnter={(e) => {
      e.currentTarget.style.color = '#1890ff';
    }}
    onMouseLeave={(e) => {
      e.currentTarget.style.color = '#8c8c8c';
    }}
  />
  
  {/* "当前钱包"文字 */}
  <Text strong style={{ fontSize: '18px' }}>
    当前钱包
  </Text>
</div>
```

**样式特点**:
- 昵称: 18px 加粗字体
- 编辑图标: 14px,默认灰色,悬停变蓝色
- "当前钱包": 18px 加粗字体
- 元素间距: 8px
- 垂直居中对齐

---

#### 4.2 编辑昵称弹窗

**触发方式**: 点击编辑图标

**弹窗设计**:
```typescript
<Modal
  title="修改昵称"
  open={editModalVisible}
  onOk={() => form.submit()}
  onCancel={handleCancelEdit}
  confirmLoading={loading}
  okText="保存"
  cancelText="取消"
  centered
  width={400}
>
  <Form
    form={form}
    layout="vertical"
    onFinish={handleSaveNickname}
  >
    <Form.Item
      name="nickname"
      label="昵称"
      rules={[
        { required: true, message: '请输入昵称' },
        { max: 64, message: '昵称最多64个字符' },
      ]}
    >
      <Input placeholder="例如：小明" maxLength={64} />
    </Form.Item>
    
    {/* 提示信息 */}
    <div style={{ background: '#f0f7ff', padding: '12px', borderRadius: '6px' }}>
      <Text type="secondary" style={{ fontSize: '12px' }}>
        💡 提示：修改昵称需要发起链上交易并签名确认。
      </Text>
    </div>
  </Form>
</Modal>
```

**弹窗特点**:
- ✅ 居中显示
- ✅ 宽度 400px
- ✅ 垂直布局表单
- ✅ 必填验证
- ✅ 最大长度 64 字符
- ✅ 提示信息框 (浅蓝背景)
- ✅ 保存时显示加载状态

---

## 🔄 自动更新机制

### 触发加载昵称的场景

| 场景 | 事件 | 行为 |
|------|-----|------|
| 页面加载 | `useEffect` | 自动加载当前账户昵称 |
| 账户切换 | `mp.accountsUpdate` | 重新加载新账户昵称 |
| 保存成功 | 交易成功回调 | 立即更新本地显示 |

### 事件监听

```typescript
useEffect(() => {
  loadAddress();
  
  const handleAccountUpdate = () => {
    loadAddress();  // 会调用 loadNickname()
  };
  
  window.addEventListener('mp.accountsUpdate', handleAccountUpdate);
  
  return () => {
    window.removeEventListener('mp.accountsUpdate', handleAccountUpdate);
  };
}, []);
```

---

## 📝 代码修改

### 修改的文件

**文件**: `memopark-dapp/src/features/profile/MyWalletPage.tsx`

### 主要修改

#### 1. 导入新依赖

```typescript
// 新增
import { Modal, Input, Form } from 'antd';
import { EditOutlined } from '@ant-design/icons';
import { getApi, signAndSendLocalFromKeystore } from '../../lib/polkadot-safe';
```

#### 2. 新增状态

```typescript
const [nickname, setNickname] = useState<string>('');
const [editModalVisible, setEditModalVisible] = useState<boolean>(false);
const [loading, setLoading] = useState<boolean>(false);
const [form] = Form.useForm();
```

#### 3. 新增函数

- `loadNickname(addr: string)`: 加载昵称
- `handleEditNickname()`: 打开编辑弹窗
- `handleSaveNickname(values: any)`: 保存昵称
- `handleCancelEdit()`: 取消编辑

#### 4. 修改 UI

- 标题区域: 添加昵称和编辑图标
- 新增编辑弹窗组件

---

## 🎨 UI 设计对比

### 修改前

```
┌─────────────────────────────┐
│  👤  当前钱包                │
│      5Cakw2y5...kPu6vj8      │
└─────────────────────────────┘
```

### 修改后

```
┌─────────────────────────────┐
│  👤  亲友 ✏️ 当前钱包        │
│      5Cakw2y5...kPu6vj8      │
└─────────────────────────────┘
```

**变化**:
1. ✅ 添加昵称显示 ("亲友")
2. ✅ 添加编辑图标 (✏️)
3. ✅ 保持"当前钱包"在后面
4. ✅ 用空格分开

---

## 🧪 测试场景

### 1. 首次加载测试

**场景**: 从未设置过昵称

**步骤**:
1. 打开"我的钱包"页面
2. 观察标题区域

**预期**:
- ✅ 显示"亲友 ✏️ 当前钱包"
- ✅ 昵称为默认值"亲友"

---

### 2. 设置昵称测试

**步骤**:
1. 点击编辑图标 (✏️)
2. 输入昵称 "小明"
3. 点击"保存"
4. 输入密码签名
5. 等待交易上链

**预期**:
- ✅ 弹出编辑弹窗
- ✅ 输入框为空 (因为当前是"亲友")
- ✅ 显示密码输入弹窗
- ✅ 签名成功后显示交易哈希
- ✅ 页面昵称更新为"小明"
- ✅ 弹窗自动关闭

---

### 3. 修改昵称测试

**场景**: 已有自定义昵称

**步骤**:
1. 当前昵称为"小明"
2. 点击编辑图标
3. 修改为"小红"
4. 保存并签名

**预期**:
- ✅ 弹窗输入框显示"小明"
- ✅ 修改为"小红"后保存成功
- ✅ 页面显示"小红 ✏️ 当前钱包"

---

### 4. 取消编辑测试

**步骤**:
1. 点击编辑图标
2. 输入昵称
3. 点击"取消"

**预期**:
- ✅ 弹窗关闭
- ✅ 表单重置
- ✅ 页面昵称不变

---

### 5. 验证失败测试

**步骤**:
1. 点击编辑图标
2. 不输入昵称,直接点击"保存"

**预期**:
- ✅ 显示"请输入昵称"错误提示
- ✅ 不发起交易

---

### 6. 账户切换测试

**场景**: 切换到另一个账户

**步骤**:
1. 当前账户昵称为"小明"
2. 切换到另一个账户 (昵称未设置)
3. 返回"我的钱包"页面

**预期**:
- ✅ 显示新账户的昵称"亲友"
- ✅ 不再显示"小明"

---

### 7. 签名取消测试

**步骤**:
1. 点击编辑图标
2. 输入昵称
3. 点击"保存"
4. 在密码弹窗点击"取消"

**预期**:
- ✅ 交易取消
- ✅ 显示"保存失败"或"用户取消"
- ✅ 弹窗不关闭
- ✅ 可以重新尝试

---

## ⚠️ 注意事项

### 1. 链上交易

- **需要 Gas**: 设置昵称需要消耗链上 Gas
- **需要签名**: 需要用户输入密码解密密钥
- **不可撤销**: 交易一旦上链无法撤销
- **有延迟**: 交易上链需要等待区块确认

### 2. 数据同步

- **本地优先**: 保存成功后立即更新本地显示
- **链上验证**: 可以刷新页面验证链上数据
- **账户隔离**: 不同账户的昵称独立存储

### 3. 默认值

- **"亲友"**: 未设置昵称时的默认显示
- **非链上数据**: "亲友"只是前端默认值,不存储在链上
- **判断逻辑**: 如果链上无数据,则显示"亲友"

### 4. 字符限制

- **最大长度**: 64 个字符
- **UTF-8 编码**: 支持中文、emoji 等
- **前后空格**: 会自动去除

### 5. 错误处理

- **网络异常**: 显示错误提示,不更新本地
- **签名失败**: 显示错误信息,弹窗不关闭
- **链节点未启动**: 加载昵称失败,使用默认值"亲友"

---

## 🔗 相关接口

### getApi()
```typescript
export async function getApi(): Promise<ApiPromise>
```
- 获取 Polkadot API 实例
- 连接到链节点

### signAndSendLocalFromKeystore()
```typescript
export async function signAndSendLocalFromKeystore(
  pallet: string,
  method: string,
  args: any[]
): Promise<string>
```
- 使用本地密钥签名并发送交易
- 需要用户输入密码
- 返回交易哈希

---

## 📚 相关文档

- [Polkadot Identity Pallet](https://wiki.polkadot.network/docs/learn-identity)
- [Polkadot.js API 文档](https://polkadot.js.org/docs/)
- [Ant Design Modal 组件](https://ant.design/components/modal-cn/)
- [Ant Design Form 组件](https://ant.design/components/form-cn/)

---

## 🎯 功能特点总结

| 特点 | 说明 |
|------|------|
| ✅ **链上存储** | 昵称存储在 pallet-identity,永久保存 |
| ✅ **默认值** | 未设置时显示"亲友" |
| ✅ **可编辑** | 点击图标打开编辑弹窗 |
| ✅ **签名确认** | 需要用户签名交易 |
| ✅ **实时更新** | 保存成功后立即更新显示 |
| ✅ **账户隔离** | 不同账户独立昵称 |
| ✅ **自动加载** | 账户切换时自动加载 |
| ✅ **友好提示** | 清晰的操作提示和错误信息 |
| ✅ **表单验证** | 必填和长度验证 |
| ✅ **加载状态** | 保存时显示加载动画 |

---

## 📊 代码统计

- **新增行数**: ~150 行
- **修改文件**: 1 个
- **新增函数**: 4 个
- **新增状态**: 4 个
- **新增组件**: 1 个 (Modal)

---

**实现完成时间**: 2025-10-06  
**开发者**: Memopark Team  
**版本**: v1.0

