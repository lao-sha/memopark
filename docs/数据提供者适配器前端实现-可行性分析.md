# æ•°æ®æä¾›è€…é€‚é…å™¨å‰ç«¯å®ç° - å¯è¡Œæ€§åˆ†ææŠ¥å‘Š

## æ–‡æ¡£ä¿¡æ¯

- **åˆ›å»ºæ—¶é—´**: 2025å¹´1æœˆ25æ—¥
- **ç‰ˆæœ¬**: v1.0
- **åˆ†æå¯¹è±¡**: å°† MediaDataProvider é€‚é…å™¨ä»é“¾ä¸Šç§»åˆ°å‰ç«¯å®ç°
- **å‚è€ƒæ–‡æ¡£**: å…¬å…±éŸ³è§†é¢‘åª’ä½“åº“Palletè®¾è®¡-å¼€å‘æ–‡æ¡£.md (v2.0)

---

## æ‰§è¡Œæ‘˜è¦

**æ€»ä½“è¯„ä¼°**: âš ï¸ **ä¸å»ºè®®å®Œå…¨ç§»åˆ°å‰ç«¯** (å¯è¡Œæ€§: 3.5/10ï¼Œåˆç†æ€§: 4.0/10)

**æ ¸å¿ƒå‘ç°**:
- âš ï¸ **æ•°æ®è¿ç§»å—é˜»**: å‰ç«¯æ— æ³•å®ç°é“¾ä¸Šæ‰¹é‡æ•°æ®è¿ç§»
- âš ï¸ **æ¶æ„å€’é€€**: é‡æ–°å¼•å…¥å¾ªç¯ä¾èµ–ï¼Œè€¦åˆåº¦å›å‡
- âš ï¸ **æƒé™éªŒè¯ç¼ºå¤±**: å‰ç«¯æ— æ³•å®‰å…¨åœ°è¿›è¡Œæƒé™æ£€æŸ¥
- âœ… **éƒ¨åˆ†å¯è¡Œ**: æ–°å¢åª’ä½“ä¸Šä¼ å¯ä»¥åœ¨å‰ç«¯è¿›è¡Œç±»å‹è½¬æ¢

**å»ºè®®**: é‡‡ç”¨**æ··åˆæ¨¡å¼** - ä¿ç•™é“¾ä¸Šé€‚é…å™¨ç”¨äºæ•°æ®è¿ç§»ï¼Œå‰ç«¯ä»…åšæ–°å¢ä¸Šä¼ çš„æ•°æ®å‡†å¤‡

---

## 1. MediaDataProvider åŠŸèƒ½åˆ†æ

### 1.1 å½“å‰è®¾è®¡ä¸­çš„æ ¸å¿ƒåŠŸèƒ½

**MediaDataProvider trait åœ¨ v2.0 ä¸­çš„ä½œç”¨**:

```rust
pub trait MediaDataProvider<AccountId> {
    type MediaId: Encode + Decode + Clone;

    /// 1ï¸âƒ£ è·å–æ ‡å‡†åŒ–å…ƒæ•°æ®ï¼ˆæ ¸å¿ƒåŠŸèƒ½ï¼‰
    fn get_standard_metadata(
        media_id: Self::MediaId,
        requester: Option<AccountId>,
    ) -> Option<StandardMediaMetadata>;

    /// 2ï¸âƒ£ æ£€æŸ¥è®¿é—®æƒé™
    fn check_access_permission(
        media_id: Self::MediaId,
        requester: AccountId,
        access_type: AccessType,
    ) -> bool;

    /// 3ï¸âƒ£ è·å–åª’ä½“æ‰€æœ‰è€…
    fn get_owner(media_id: Self::MediaId) -> Option<AccountId>;

    /// 4ï¸âƒ£ åˆ—å‡ºå®ä½“çš„æ‰€æœ‰åª’ä½“ID
    fn list_entity_media(
        entity_id: u64,
        limit: u32,
    ) -> Vec<Self::MediaId>;
}
```

### 1.2 ä¸»è¦ä½¿ç”¨åœºæ™¯

æ ¹æ® v2.0 æ–‡æ¡£åˆ†æï¼ŒMediaDataProvider æœ‰ä»¥ä¸‹ä½¿ç”¨åœºæ™¯ï¼š

#### åœºæ™¯1: é“¾ä¸Šæ•°æ®è¿ç§»ï¼ˆæœ€å…³é”®ï¼‰

```rust
/// æ•°æ®è¿ç§»è¾…åŠ©å‡½æ•° - åœ¨é“¾ä¸Šæ‰§è¡Œ
pub fn migrate_deceased_media_batch(
    start_id: u64,
    batch_size: u32,
) -> Result<MigrationStats, Error> {
    for media_id in start_id..(start_id + batch_size as u64) {
        // ğŸ”´ å…³é”®ï¼šä½¿ç”¨MediaDataProviderè¯»å–æ—§æ•°æ®
        if let Some(metadata) = DeceasedMediaProvider::get_standard_metadata(media_id, None) {
            // å¯¼å…¥åˆ°æ–°åª’ä½“åº“
            match PublicMediaLibrary::import_external_media(
                DeceasedMediaProvider,
                media_id,
                well_known_domains::DECEASED,
                metadata.entity_id,
            ) {
                Ok(new_id) => {
                    stats.success_count += 1;
                },
                Err(e) => {
                    stats.failed_count += 1;
                }
            }
        }
    }
    Ok(stats)
}
```

**ç‰¹å¾**:
- âœ… æ‰¹é‡å¤„ç†ï¼ˆ10-100æ¡/æ‰¹æ¬¡ï¼‰
- âœ… OCW è‡ªåŠ¨æ‰§è¡Œ
- âœ… é“¾ä¸Šæƒé™éªŒè¯
- âœ… åŸå­æ€§ä¿è¯

#### åœºæ™¯2: æ–°åª’ä½“ä¸Šä¼ æ—¶çš„æ•°æ®è½¬æ¢

```rust
// ç”¨æˆ·ä¸Šä¼ æ–°åª’ä½“åˆ° deceased pallet
impl<T: Config> pallet_deceased::Pallet<T> {
    pub fn upload_media_new_way(...) -> DispatchResult {
        // ğŸŸ¡ å¯èƒ½ï¼šè°ƒç”¨åª’ä½“åº“ç»Ÿä¸€ä¸Šä¼ 
        let media_id = T::PublicMediaLibrary::upload_media(...)?;

        // å…³è”åˆ° deceased
        T::PublicMediaLibrary::associate_media_to_entity(
            well_known_domains::DECEASED,
            deceased_id,
            media_id,
            MediaRelationshipType::Work,
        )?;
    }
}
```

**ç‰¹å¾**:
- âœ… å•æ¬¡æ“ä½œ
- âœ… ç”¨æˆ·è§¦å‘
- ğŸŸ¡ å¯ä»¥åœ¨å‰ç«¯é¢„å¤„ç†

#### åœºæ™¯3: æƒé™éªŒè¯ï¼ˆè·¨palletæŸ¥è¯¢ï¼‰

```rust
impl MediaDataProvider<AccountId> for DeceasedMediaProvider {
    fn check_access_permission(
        media_id: Self::MediaId,
        requester: AccountId,
        access_type: AccessType,
    ) -> bool {
        // ğŸ”´ å…³é”®ï¼šä½¿ç”¨ deceased çš„æƒé™æ£€æŸ¥é€»è¾‘
        let media = pallet_deceased::MediaRegistry::<Runtime>::get(media_id)?;

        match media.visibility {
            Visibility::Public => true,
            Visibility::Private => media.owner == requester,
            Visibility::Family => Self::check_family_relationship(requester, media.deceased_id),
        }
    }
}
```

**ç‰¹å¾**:
- âœ… éœ€è¦é“¾ä¸Šæƒé™é€»è¾‘
- âœ… éœ€è¦è®¿é—® deceased pallet å­˜å‚¨
- âŒ å‰ç«¯æ— æ³•å®‰å…¨å®ç°

---

## 2. å‰ç«¯å®ç°å¯è¡Œæ€§è¯„ä¼°

### 2.1 æŠ€æœ¯å¯è¡Œæ€§åˆ†æ

| åŠŸèƒ½ç‚¹ | å‰ç«¯å¯è¡Œæ€§ | è¯„åˆ† | è¯´æ˜ |
|-------|----------|------|------|
| **è·å–æ ‡å‡†åŒ–å…ƒæ•°æ®** | ğŸŸ¡ éƒ¨åˆ†å¯è¡Œ | 6/10 | å¯ä»¥è¯»å–ï¼Œä½†æ— æ³•æ‰¹é‡å¤„ç† |
| **ç±»å‹è½¬æ¢** | âœ… å¯è¡Œ | 9/10 | å‰ç«¯å¯ä»¥åšç±»å‹æ˜ å°„ |
| **æƒé™éªŒè¯** | âŒ ä¸å¯è¡Œ | 2/10 | å‰ç«¯æ— æ³•å®‰å…¨éªŒè¯ |
| **æ‰¹é‡æ•°æ®è¿ç§»** | âŒ ä¸å¯è¡Œ | 1/10 | æ— æ³•åœ¨é“¾ä¸Šæ‰§è¡Œæ‰¹é‡æ“ä½œ |
| **OCW è‡ªåŠ¨è¿ç§»** | âŒ ä¸å¯è¡Œ | 0/10 | å‰ç«¯æ— æ³•æ›¿ä»£ OCW |
| **åŸå­æ€§ä¿è¯** | âŒ ä¸å¯è¡Œ | 2/10 | å‰ç«¯æ— æ³•ä¿è¯äº‹åŠ¡æ€§ |

**æ€»ä½“æŠ€æœ¯å¯è¡Œæ€§**: 3.5/10 âŒ

#### 2.1.1 å¯è¡Œçš„éƒ¨åˆ†

**âœ… æ–°å¢åª’ä½“ä¸Šä¼ çš„æ•°æ®å‡†å¤‡**:

```typescript
// stardust-dapp/src/utils/mediaAdapter.ts
export class DeceasedMediaAdapter {
  /**
   * å°† deceased çš„åª’ä½“æ•°æ®è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
   * ç”¨äºæ–°å¢ä¸Šä¼ åœºæ™¯
   */
  static convertToStandardMetadata(
    deceasedMedia: DeceasedMediaInput
  ): StandardMediaMetadata {
    return {
      title: deceasedMedia.title,
      description: deceasedMedia.description || null,
      privacy_level: this.convertPrivacyLevel(deceasedMedia.visibility),
      media_type: this.convertMediaKind(deceasedMedia.kind),
      file_size: deceasedMedia.file.size,
      created_at: Date.now(),
      owner: deceasedMedia.uploader,
      custom_properties: JSON.stringify({
        deceased_id: deceasedMedia.deceased_id,
        album_id: deceasedMedia.album_id,
      }),
    };
  }

  private static convertPrivacyLevel(visibility: DeceasedVisibility): number {
    switch (visibility) {
      case 'Public': return 0;
      case 'Unlisted': return 50;
      case 'Private': return 255;
    }
  }

  private static convertMediaKind(kind: DeceasedMediaKind): string {
    switch (kind) {
      case 'Photo': return 'image';
      case 'Video': return 'video';
      case 'Audio': return 'audio';
    }
  }
}
```

**é€‚ç”¨åœºæ™¯**:
- âœ… ç”¨æˆ·æ‰‹åŠ¨ä¸Šä¼ æ–°åª’ä½“
- âœ… å•æ¬¡æ“ä½œï¼Œéæ‰¹é‡
- âœ… å‰ç«¯è¡¨å•éªŒè¯å’Œæ•°æ®é¢„å¤„ç†

#### 2.1.2 ä¸å¯è¡Œçš„éƒ¨åˆ†

**âŒ é“¾ä¸Šæ•°æ®è¿ç§»**:

```typescript
// âŒ è¿™æ®µé€»è¾‘æ— æ³•åœ¨å‰ç«¯å®ç°
export class FrontendMediaMigration {
  /**
   * âŒ é—®é¢˜1: æ— æ³•æ‰¹é‡è¯»å–é“¾ä¸Šæ•°æ®
   * - éœ€è¦éå† pallet_deceased::MediaRegistry çš„æ‰€æœ‰æ¡ç›®
   * - å‰ç«¯åªèƒ½é€šè¿‡ RPC å•æ¡æŸ¥è¯¢ï¼Œæ•ˆç‡æä½
   * - æ— æ³•ä¿è¯æ•°æ®ä¸€è‡´æ€§
   */
  async migrateBatch(startId: number, batchSize: number) {
    for (let id = startId; id < startId + batchSize; id++) {
      // å•æ¡æŸ¥è¯¢ï¼Œç½‘ç»œå¼€é”€å·¨å¤§
      const media = await api.query.deceased.mediaRegistry(id);

      // âŒ é—®é¢˜2: æ— æ³•åœ¨é“¾ä¸Šæ‰§è¡ŒåŸå­æ“ä½œ
      // å¦‚æœä¸­é€”å¤±è´¥ï¼Œæ— æ³•å›æ»šï¼Œå¯¼è‡´æ•°æ®ä¸ä¸€è‡´
      await api.tx.publicMediaLibrary.importExternalMedia(...).signAndSend();
    }
  }

  /**
   * âŒ é—®é¢˜3: æ— æ³•æ›¿ä»£ OCW è‡ªåŠ¨è¿ç§»
   * - OCW å¯ä»¥ 7Ã—24 è‡ªåŠ¨æ‰§è¡Œ
   * - å‰ç«¯éœ€è¦ç”¨æˆ·ä¿æŒé¡µé¢æ‰“å¼€
   * - æ— æ³•ä¿è¯è¿ç§»å®Œæ•´æ€§
   */
  async startAutoMigration() {
    // ç”¨æˆ·å…³é—­é¡µé¢ â†’ è¿ç§»ä¸­æ–­
    // ç½‘ç»œä¸­æ–­ â†’ è¿ç§»å¤±è´¥
    // æ— æ³•æ¢å¤æ–­ç‚¹
  }
}
```

**âŒ æƒé™éªŒè¯**:

```typescript
// âŒ è¿™æ®µé€»è¾‘æ— æ³•åœ¨å‰ç«¯å®‰å…¨å®ç°
export class FrontendPermissionCheck {
  /**
   * âŒ é—®é¢˜1: å‰ç«¯éªŒè¯ä¸å¯ä¿¡
   * - ç”¨æˆ·å¯ä»¥ä¿®æ”¹å‰ç«¯ä»£ç ç»•è¿‡æ£€æŸ¥
   * - å¿…é¡»åœ¨é“¾ä¸ŠéªŒè¯æƒé™
   */
  async checkAccessPermission(
    mediaId: number,
    requester: string,
    accessType: 'View' | 'Edit' | 'Delete'
  ): Promise<boolean> {
    // å‰ç«¯è¯»å–æ•°æ®
    const media = await api.query.deceased.mediaRegistry(mediaId);

    // âŒ è¿™ä¸ªæ£€æŸ¥å¯ä»¥è¢«ç»•è¿‡
    if (media.visibility === 'Private' && media.owner !== requester) {
      return false;
    }

    // âŒ å¤æ‚çš„å®¶æ—å…³ç³»éªŒè¯æ— æ³•åœ¨å‰ç«¯å®ç°
    if (media.visibility === 'Family') {
      // éœ€è¦è®¿é—® pallet_deceased çš„å®¶æ—å…³ç³»å­˜å‚¨
      // å‰ç«¯æ— æ³•é«˜æ•ˆæŸ¥è¯¢
    }

    return true;
  }

  /**
   * âŒ é—®é¢˜2: æ— æ³•è®¿é—®å…¶ä»– pallet çš„å†…éƒ¨é€»è¾‘
   * - deceased çš„æƒé™æ£€æŸ¥å¯èƒ½ä¾èµ–å¤æ‚çš„é“¾ä¸ŠçŠ¶æ€
   * - å‰ç«¯æ— æ³•å¤åˆ¶è¿™äº›é€»è¾‘
   */
}
```

### 2.2 æ€§èƒ½å½±å“åˆ†æ

#### 2.2.1 é“¾ä¸Šå®ç°ï¼ˆå½“å‰ v2.0 è®¾è®¡ï¼‰

| æŒ‡æ ‡ | é“¾ä¸Šé€‚é…å™¨ | è¯´æ˜ |
|-----|----------|------|
| **æ‰¹é‡è¿ç§»é€Ÿåº¦** | âš¡ å¿« | 10-100æ¡/æ‰¹æ¬¡ï¼ŒOCWè‡ªåŠ¨æ‰§è¡Œ |
| **ç½‘ç»œå¼€é”€** | âœ… ä½ | é“¾ä¸Šç›´æ¥è®¿é—®å­˜å‚¨ |
| **æ•°æ®ä¸€è‡´æ€§** | âœ… å¼º | åŸå­æ€§ä¿è¯ |
| **æƒé™éªŒè¯** | âœ… å®‰å…¨ | é“¾ä¸ŠéªŒè¯ï¼Œä¸å¯ç»•è¿‡ |
| **è¿ç§»å¯é æ€§** | âœ… é«˜ | OCW è‡ªåŠ¨é‡è¯•ï¼Œæ–­ç‚¹ç»­ä¼  |

#### 2.2.2 å‰ç«¯å®ç°

| æŒ‡æ ‡ | å‰ç«¯é€‚é…å™¨ | è¯´æ˜ |
|-----|----------|------|
| **æ‰¹é‡è¿ç§»é€Ÿåº¦** | âŒ æ…¢ | å•æ¡ RPC æŸ¥è¯¢ï¼Œç½‘ç»œå¾€è¿”æ—¶é—´é•¿ |
| **ç½‘ç»œå¼€é”€** | âŒ é«˜ | æ¯æ¡æ•°æ®éœ€è¦å¤šæ¬¡ RPC è°ƒç”¨ |
| **æ•°æ®ä¸€è‡´æ€§** | âŒ å¼± | æ— æ³•ä¿è¯åŸå­æ€§ |
| **æƒé™éªŒè¯** | âŒ ä¸å®‰å…¨ | å‰ç«¯éªŒè¯å¯è¢«ç»•è¿‡ |
| **è¿ç§»å¯é æ€§** | âŒ ä½ | ä¾èµ–ç”¨æˆ·é¡µé¢ä¿æŒæ‰“å¼€ |

**æ€§èƒ½å¯¹æ¯”**:

```
æ‰¹é‡è¿ç§» 1000 æ¡åª’ä½“æ•°æ®ï¼š

é“¾ä¸Šé€‚é…å™¨ï¼ˆOCWï¼‰ï¼š
- 10æ‰¹æ¬¡ Ã— 100æ¡/æ‰¹
- æ¯æ‰¹æ¬¡ï¼š~2ç§’ï¼ˆé“¾ä¸Šå­˜å‚¨è¯»å†™ï¼‰
- æ€»è€—æ—¶ï¼š~20ç§’
- æˆåŠŸç‡ï¼š99.9%ï¼ˆè‡ªåŠ¨é‡è¯•ï¼‰

å‰ç«¯é€‚é…å™¨ï¼š
- 1000æ¬¡ç‹¬ç«‹æ“ä½œ
- æ¯æ¬¡ï¼š~500msï¼ˆRPCå¾€è¿” + ç­¾åï¼‰
- æ€»è€—æ—¶ï¼š~500ç§’ï¼ˆ8.3åˆ†é’Ÿï¼‰
- æˆåŠŸç‡ï¼š~85%ï¼ˆç½‘ç»œä¸­æ–­ã€ç”¨æˆ·å…³é—­é¡µé¢ï¼‰
- å¤±è´¥åéœ€è¦æ‰‹åŠ¨é‡è¯•
```

**æ€§èƒ½è¯„ä¼°**: å‰ç«¯å®ç°æ¯”é“¾ä¸Šæ…¢ 25 å€ï¼Œä¸”å¯é æ€§ä½ âŒ

---

## 3. æ¶æ„åˆç†æ€§åˆ†æ

### 3.1 è€¦åˆåº¦å½±å“

#### 3.1.1 å½“å‰ v2.0 è®¾è®¡ï¼ˆé“¾ä¸Šé€‚é…å™¨ï¼‰

```
ä½è€¦åˆæ¶æ„ï¼ˆè€¦åˆåº¦: 3.3/10ï¼‰ï¼š

stardust-media-traits (æŠ½è±¡)
    â†‘                    â†‘
    â”‚ å®ç°               â”‚ ä¾èµ–
    â”‚                    â”‚
DeceasedMediaProvider  pallet-public-media-library
    â†‘
    â”‚ ä½¿ç”¨
    â”‚
pallet-deceased (æ— éœ€ä¾èµ–åª’ä½“åº“)
```

**ä¼˜åŠ¿**:
- âœ… **å•å‘ä¾èµ–**: deceased â†’ traits â† media-library
- âœ… **æ— å¾ªç¯ä¾èµ–**
- âœ… **èŒè´£æ¸…æ™°**: é€‚é…å™¨å°è£…äº†æ‰€æœ‰è½¬æ¢é€»è¾‘
- âœ… **ç¬¦åˆ DIP**: ä¾èµ–å€’ç½®åŸåˆ™

#### 3.1.2 ç§»åˆ°å‰ç«¯åçš„æ¶æ„

```
é‡æ–°å¼•å…¥è€¦åˆï¼ˆè€¦åˆåº¦: 6.0/10 â¬†ï¸ï¼‰ï¼š

pallet-deceased â”€â”€â”
                  â”‚ å‰ç«¯éœ€è¦ç†è§£
                  â”‚ deceased æ•°æ®ç»“æ„
                  â–¼
            Frontend Adapter
                  â”‚
                  â”‚ å‰ç«¯éœ€è¦ç†è§£
                  â”‚ media-library æ¥å£
                  â–¼
pallet-public-media-library
```

**é—®é¢˜**:
- âŒ **å‰ç«¯è€¦åˆ**: å‰ç«¯éœ€è¦åŒæ—¶ç†è§£ä¸¤ä¸ª pallet çš„æ•°æ®ç»“æ„
- âŒ **ç»´æŠ¤è´Ÿæ‹…**: deceased ç»“æ„å˜åŒ– â†’ å‰ç«¯ä»£ç ä¹Ÿè¦æ”¹
- âŒ **æµ‹è¯•å›°éš¾**: éœ€è¦ç»´æŠ¤å‰ç«¯å’Œé“¾ä¸Šä¸¤å¥—è½¬æ¢é€»è¾‘
- âŒ **ç‰ˆæœ¬åŒæ­¥**: é“¾å‡çº§åï¼Œå‰ç«¯å¿…é¡»åŒæ­¥æ›´æ–°

**è€¦åˆåº¦å¯¹æ¯”**:

| ç»´åº¦ | v2.0 é“¾ä¸Šé€‚é…å™¨ | å‰ç«¯é€‚é…å™¨ | å˜åŒ– |
|-----|---------------|----------|------|
| **deceased â†” media-library** | 3.0/10 âœ… | 6.0/10 âš ï¸ | â¬†ï¸ 100% |
| **å‰ç«¯å¤æ‚åº¦** | 2.0/10 âœ… | 7.0/10 âŒ | â¬†ï¸ 250% |
| **ç»´æŠ¤æˆæœ¬** | ä½ âœ… | é«˜ âŒ | â¬†ï¸ 200% |
| **ç‰ˆæœ¬åŒæ­¥éš¾åº¦** | ä½ âœ… | é«˜ âŒ | â¬†ï¸ 300% |

**æ¶æ„åˆç†æ€§è¯„ä¼°**: 4.0/10 âš ï¸ï¼ˆè€¦åˆåº¦æ˜¾è‘—ä¸Šå‡ï¼‰

### 3.2 èŒè´£åˆ’åˆ†é—®é¢˜

#### 3.2.1 é“¾ä¸Šé€‚é…å™¨ï¼ˆæ¨èï¼‰

```rust
// âœ… ç¬¦åˆå•ä¸€èŒè´£åŸåˆ™
// èŒè´£ï¼šå°è£… deceased ç‰¹å®šçš„æ•°æ®è®¿é—®é€»è¾‘

pub struct DeceasedMediaProvider;

impl MediaDataProvider<AccountId> for DeceasedMediaProvider {
    // èŒè´£æ˜ç¡®ï¼šåªè´Ÿè´£ä» deceased è¯»å–æ•°æ®å¹¶æ ‡å‡†åŒ–
    fn get_standard_metadata(...) -> Option<StandardMediaMetadata> {
        // ç›´æ¥è®¿é—®é“¾ä¸Šå­˜å‚¨
        let legacy_media = pallet_deceased::MediaRegistry::<Runtime>::get(media_id)?;

        // è½¬æ¢é€»è¾‘å°è£…åœ¨é€‚é…å™¨å†…
        Some(StandardMediaMetadata {
            // ... è½¬æ¢
        })
    }
}
```

**èŒè´£è¾¹ç•Œæ¸…æ™°**:
- âœ… **é“¾ä¸Šé€»è¾‘å½’é“¾ä¸Š**: æ•°æ®è¯»å–ã€æƒé™éªŒè¯ã€æ‰¹é‡å¤„ç†
- âœ… **é€‚é…å™¨èŒè´£å•ä¸€**: åªè´Ÿè´£æ•°æ®è½¬æ¢
- âœ… **æ˜“äºæµ‹è¯•**: Mock é“¾ä¸Šå­˜å‚¨å³å¯

#### 3.2.2 å‰ç«¯é€‚é…å™¨ï¼ˆä¸æ¨èï¼‰

```typescript
// âŒ è¿åå•ä¸€èŒè´£åŸåˆ™
// èŒè´£æ··ä¹±ï¼šå‰ç«¯æ—¢è¦ç®¡ UIï¼Œåˆè¦ç®¡é“¾ä¸Šæ•°æ®è½¬æ¢

export class FrontendDeceasedAdapter {
  // âŒ é—®é¢˜1: å‰ç«¯éœ€è¦ç†è§£é“¾ä¸Šæ•°æ®ç»“æ„
  async getStandardMetadata(mediaId: number) {
    const media = await api.query.deceased.mediaRegistry(mediaId);

    // âŒ é—®é¢˜2: é‡å¤å®ç°è½¬æ¢é€»è¾‘ï¼ˆé“¾ä¸Šä¹Ÿæœ‰ï¼‰
    return {
      title: media.title,
      privacy_level: this.convertPrivacyLevel(media.visibility),
      // ...
    };
  }

  // âŒ é—®é¢˜3: å‰ç«¯éœ€è¦ç»´æŠ¤ç±»å‹æ˜ å°„
  private convertPrivacyLevel(visibility: DeceasedVisibility): number {
    // è¿™å¥—é€»è¾‘åœ¨é“¾ä¸Šä¹Ÿè¦ç»´æŠ¤
    // ä¸¤è¾¹å®¹æ˜“ä¸ä¸€è‡´
  }

  // âŒ é—®é¢˜4: å‰ç«¯è¿˜è¦å¤„ç†æ‰¹é‡è¿ç§»
  async migrateBatch() {
    // è¿™ä¸åº”è¯¥æ˜¯å‰ç«¯çš„èŒè´£
  }
}
```

**èŒè´£æ··ä¹±**:
- âŒ **å‰ç«¯èŒè´£è¿‡é‡**: UI + ä¸šåŠ¡é€»è¾‘ + æ•°æ®è½¬æ¢ + è¿ç§»
- âŒ **é€»è¾‘é‡å¤**: å‰ç«¯å’Œé“¾ä¸Šéƒ½è¦ç»´æŠ¤è½¬æ¢é€»è¾‘
- âŒ **æµ‹è¯•å›°éš¾**: éœ€è¦ Mock é“¾ä¸Š RPC è°ƒç”¨

### 3.3 SOLID åŸåˆ™è¿ååˆ†æ

| SOLID åŸåˆ™ | v2.0 é“¾ä¸Šé€‚é…å™¨ | å‰ç«¯é€‚é…å™¨ | å½±å“ |
|-----------|---------------|----------|------|
| **å•ä¸€èŒè´£ (SRP)** | âœ… 90% | âŒ 50% | å‰ç«¯èŒè´£è¿‡é‡ |
| **å¼€é—­åŸåˆ™ (OCP)** | âœ… 85% | âš ï¸ 60% | æ‰©å±•éœ€æ”¹å‰ç«¯ |
| **é‡Œæ°æ›¿æ¢ (LSP)** | âœ… 95% | âš ï¸ 70% | å‰ç«¯éš¾ä»¥æ›¿æ¢ |
| **æ¥å£éš”ç¦» (ISP)** | âœ… 90% | âš ï¸ 65% | å‰ç«¯æ¥å£å¤æ‚ |
| **ä¾èµ–å€’ç½® (DIP)** | âœ… 95% | âŒ 40% | å‰ç«¯ç›´æ¥ä¾èµ–å…·ä½“å®ç° |

**æ€»ä½“è¯„ä¼°**: å‰ç«¯å®ç°æ˜¾è‘—é™ä½æ¶æ„è´¨é‡ âŒ

---

## 4. å®‰å…¨æ€§åˆ†æ

### 4.1 æƒé™éªŒè¯æ¼æ´

#### 4.1.1 é“¾ä¸ŠéªŒè¯ï¼ˆå®‰å…¨ï¼‰

```rust
// âœ… é“¾ä¸ŠéªŒè¯ï¼Œä¸å¯ç»•è¿‡
impl MediaDataProvider<AccountId> for DeceasedMediaProvider {
    fn check_access_permission(
        media_id: Self::MediaId,
        requester: AccountId,
        access_type: AccessType,
    ) -> bool {
        // ğŸ”’ é“¾ä¸Šæ‰§è¡Œï¼Œç”¨æˆ·æ— æ³•ç¯¡æ”¹
        let media = pallet_deceased::MediaRegistry::<Runtime>::get(media_id)?;

        match media.visibility {
            Visibility::Public => true,
            Visibility::Private => {
                // ğŸ”’ é“¾ä¸Šå­˜å‚¨éªŒè¯ï¼Œå®‰å…¨
                media.owner == requester
            },
            Visibility::Family => {
                // ğŸ”’ é“¾ä¸ŠæŸ¥è¯¢å®¶æ—å…³ç³»ï¼Œå®‰å…¨
                Self::check_family_relationship(requester, media.deceased_id)
            },
        }
    }
}
```

**å®‰å…¨ä¿è¯**:
- âœ… **ä¸å¯ç¯¡æ”¹**: é“¾ä¸Šé€»è¾‘æ— æ³•è¢«ç”¨æˆ·ä¿®æ”¹
- âœ… **æƒå¨æ•°æ®**: ç›´æ¥è®¿é—®é“¾ä¸Šå­˜å‚¨
- âœ… **ä¸€è‡´æ€§**: æ‰€æœ‰ç”¨æˆ·æ‰§è¡Œç›¸åŒçš„éªŒè¯é€»è¾‘

#### 4.1.2 å‰ç«¯éªŒè¯ï¼ˆä¸å®‰å…¨ï¼‰

```typescript
// âŒ å‰ç«¯éªŒè¯ï¼Œå¯ä»¥è¢«ç»•è¿‡
export class FrontendPermissionCheck {
  async checkAccessPermission(
    mediaId: number,
    requester: string,
    accessType: 'View' | 'Edit' | 'Delete'
  ): Promise<boolean> {
    const media = await api.query.deceased.mediaRegistry(mediaId);

    // ğŸš¨ å®‰å…¨æ¼æ´1: ç”¨æˆ·å¯ä»¥ä¿®æ”¹è¿™æ®µä»£ç 
    // ä¾‹å¦‚ï¼šç›´æ¥ return true;
    if (media.visibility === 'Private' && media.owner !== requester) {
      return false;
    }

    // ğŸš¨ å®‰å…¨æ¼æ´2: ç”¨æˆ·å¯ä»¥ç»•è¿‡å‰ç«¯ç›´æ¥è°ƒç”¨é“¾ä¸Šæ¥å£
    // å¦‚æœé“¾ä¸Šä¸éªŒè¯æƒé™ï¼Œä»»ä½•äººéƒ½å¯ä»¥è®¿é—®

    return true;
  }
}
```

**å®‰å…¨é£é™©**:
- ğŸš¨ **ä»£ç å¯ç¯¡æ”¹**: ç”¨æˆ·å¯ä»¥ä¿®æ”¹æµè§ˆå™¨ä¸­çš„ JS ä»£ç 
- ğŸš¨ **ç»•è¿‡å‰ç«¯**: ç”¨æˆ·å¯ä»¥ç›´æ¥è°ƒç”¨ RPC æ¥å£
- ğŸš¨ **é“¾ä¸Šå¿…é¡»éªŒè¯**: å³ä½¿å‰ç«¯éªŒè¯äº†ï¼Œé“¾ä¸Šä¹Ÿå¿…é¡»å†éªŒè¯ä¸€æ¬¡

**ç»“è®º**: å‰ç«¯éªŒè¯ä¸èƒ½æ›¿ä»£é“¾ä¸ŠéªŒè¯ï¼Œåè€Œå¢åŠ äº†å¤æ‚åº¦ âŒ

### 4.2 æ•°æ®å®Œæ•´æ€§é£é™©

#### 4.2.1 é“¾ä¸Šè¿ç§»ï¼ˆå®‰å…¨ï¼‰

```rust
// âœ… åŸå­æ€§ä¿è¯
pub fn migrate_deceased_media_batch(...) -> Result<MigrationStats, Error> {
    for media_id in start_id..(start_id + batch_size as u64) {
        // ğŸ”’ åœ¨åŒä¸€ä¸ª extrinsic ä¸­æ‰§è¡Œ
        let metadata = DeceasedMediaProvider::get_standard_metadata(media_id, None)?;

        // ğŸ”’ å¤±è´¥è‡ªåŠ¨å›æ»šï¼Œä¸ä¼šäº§ç”Ÿä¸ä¸€è‡´çŠ¶æ€
        PublicMediaLibrary::import_external_media(
            DeceasedMediaProvider,
            media_id,
            well_known_domains::DECEASED,
            metadata.entity_id,
        )?;
    }
    Ok(stats)
}
```

**å®‰å…¨ä¿è¯**:
- âœ… **åŸå­æ€§**: è¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å›æ»š
- âœ… **ä¸€è‡´æ€§**: ä¸ä¼šäº§ç”Ÿéƒ¨åˆ†è¿ç§»çŠ¶æ€
- âœ… **æ–­ç‚¹ç»­ä¼ **: OCW å¯ä»¥ä»å¤±è´¥å¤„ç»§ç»­

#### 4.2.2 å‰ç«¯è¿ç§»ï¼ˆä¸å®‰å…¨ï¼‰

```typescript
// âŒ æ— æ³•ä¿è¯åŸå­æ€§
async migrateBatch(startId: number, batchSize: number) {
  for (let id = startId; id < startId + batchSize; id++) {
    const media = await api.query.deceased.mediaRegistry(id);

    try {
      // ğŸš¨ é£é™©1: å¦‚æœè¿™ä¸€æ­¥æˆåŠŸï¼Œä¸‹ä¸€æ­¥å¤±è´¥ â†’ æ•°æ®ä¸ä¸€è‡´
      await api.tx.publicMediaLibrary.importExternalMedia(...).signAndSend();
    } catch (e) {
      // ğŸš¨ é£é™©2: æ— æ³•å›æ»šä¹‹å‰çš„æ“ä½œ
      console.error(`Failed to migrate ${id}:`, e);

      // ğŸš¨ é£é™©3: ç”¨æˆ·å…³é—­é¡µé¢ â†’ è¿ç§»ä¸­æ–­ï¼Œæ— æ³•æ¢å¤
    }
  }
}
```

**å®‰å…¨é£é™©**:
- ğŸš¨ **éƒ¨åˆ†è¿ç§»**: ç½‘ç»œä¸­æ–­å¯èƒ½å¯¼è‡´åªè¿ç§»äº†ä¸€åŠ
- ğŸš¨ **æ— æ³•å›æ»š**: å‡ºé”™åæ— æ³•æ’¤é”€å·²æ‰§è¡Œçš„æ“ä½œ
- ğŸš¨ **çŠ¶æ€ä¸ä¸€è‡´**: é“¾ä¸Šæ•°æ®å¯èƒ½å¤„äºä¸­é—´çŠ¶æ€

**ç»“è®º**: å‰ç«¯è¿ç§»æ— æ³•ä¿è¯æ•°æ®å®Œæ•´æ€§ âŒ

---

## 5. æˆæœ¬æ•ˆç›Šåˆ†æ

### 5.1 å¼€å‘æˆæœ¬å¯¹æ¯”

| é¡¹ç›® | v2.0 é“¾ä¸Šé€‚é…å™¨ | å‰ç«¯é€‚é…å™¨ | å·®å¼‚ |
|-----|---------------|----------|------|
| **é€‚é…å™¨å¼€å‘** | 2å‘¨ï¼ˆRustï¼‰ | 1å‘¨ï¼ˆTypeScriptï¼‰ | â¬‡ï¸ 50% |
| **å‰ç«¯å¯¹æ¥** | 0.5å‘¨ï¼ˆç®€å•è°ƒç”¨ï¼‰ | 3å‘¨ï¼ˆå¤æ‚é€»è¾‘ï¼‰ | â¬†ï¸ 500% |
| **æµ‹è¯•ç¼–å†™** | 1å‘¨ï¼ˆå•å…ƒæµ‹è¯•ï¼‰ | 2å‘¨ï¼ˆé›†æˆæµ‹è¯•ï¼‰ | â¬†ï¸ 100% |
| **æ–‡æ¡£ç¼–å†™** | 0.5å‘¨ | 1å‘¨ | â¬†ï¸ 100% |
| **æ€»å¼€å‘æˆæœ¬** | **4å‘¨** | **7å‘¨** | â¬†ï¸ 75% |

**å¼€å‘æˆæœ¬è¯„ä¼°**: å‰ç«¯å®ç°åè€Œæ›´è´µ âŒ

### 5.2 ç»´æŠ¤æˆæœ¬å¯¹æ¯”

| é¡¹ç›® | v2.0 é“¾ä¸Šé€‚é…å™¨ | å‰ç«¯é€‚é…å™¨ | å·®å¼‚ |
|-----|---------------|----------|------|
| **é“¾å‡çº§æ—¶åŒæ­¥** | è‡ªåŠ¨ï¼ˆä¸€èµ·ç¼–è¯‘ï¼‰ | æ‰‹åŠ¨ï¼ˆéœ€æ›´æ–°å‰ç«¯ï¼‰ | â¬†ï¸ 300% |
| **ç±»å‹æ˜ å°„ç»´æŠ¤** | 1å¤„ï¼ˆé€‚é…å™¨ï¼‰ | 2å¤„ï¼ˆå‰ç«¯+é“¾ä¸Šï¼‰ | â¬†ï¸ 100% |
| **Bug ä¿®å¤** | 1å¤„ä¿®å¤ | 2å¤„ä¿®å¤ | â¬†ï¸ 100% |
| **å¹´ç»´æŠ¤æˆæœ¬** | **1äººæœˆ** | **3äººæœˆ** | â¬†ï¸ 200% |

**ç»´æŠ¤æˆæœ¬è¯„ä¼°**: å‰ç«¯å®ç°ç»´æŠ¤æˆæœ¬é«˜ 3 å€ âŒ

### 5.3 è¿ç§»æ•ˆç‡å¯¹æ¯”

| æŒ‡æ ‡ | v2.0 é“¾ä¸Šé€‚é…å™¨ | å‰ç«¯é€‚é…å™¨ | å·®å¼‚ |
|-----|---------------|----------|------|
| **è¿ç§»é€Ÿåº¦** | 50æ¡/ç§’ | 2æ¡/ç§’ | â¬‡ï¸ 96% |
| **ç½‘ç»œå¼€é”€** | ä½ï¼ˆé“¾ä¸Šç›´æ¥è®¿é—®ï¼‰ | é«˜ï¼ˆæ¯æ¡RPCï¼‰ | â¬†ï¸ 1000% |
| **å¯é æ€§** | 99.9% | 85% | â¬‡ï¸ 15% |
| **è¿ç§»1ä¸‡æ¡æ•°æ®** | 3.3åˆ†é’Ÿ | 83åˆ†é’Ÿ | â¬†ï¸ 2400% |

**è¿ç§»æ•ˆç‡è¯„ä¼°**: å‰ç«¯å®ç°æ…¢ 25 å€ âŒ

### 5.4 ROI åˆ†æ

**v2.0 é“¾ä¸Šé€‚é…å™¨**:
- å¼€å‘æˆæœ¬: 4å‘¨ Ã— 5ä¸‡/å‘¨ = 20ä¸‡
- ç»´æŠ¤æˆæœ¬: 1äººæœˆ/å¹´ Ã— 5ä¸‡ = 5ä¸‡/å¹´
- è¿ç§»æ•ˆç‡: é«˜ï¼ˆ3.3åˆ†é’Ÿå®Œæˆï¼‰
- **5å¹´ TCO**: 20ä¸‡ + 5ä¸‡Ã—5 = **45ä¸‡**

**å‰ç«¯é€‚é…å™¨**:
- å¼€å‘æˆæœ¬: 7å‘¨ Ã— 5ä¸‡/å‘¨ = 35ä¸‡
- ç»´æŠ¤æˆæœ¬: 3äººæœˆ/å¹´ Ã— 5ä¸‡ = 15ä¸‡/å¹´
- è¿ç§»æ•ˆç‡: ä½ï¼ˆ83åˆ†é’Ÿï¼Œå¯èƒ½å¤±è´¥ï¼‰
- æ‰‹åŠ¨å¹²é¢„æˆæœ¬: 10ä¸‡/å¹´ï¼ˆå¤„ç†è¿ç§»å¤±è´¥ï¼‰
- **5å¹´ TCO**: 35ä¸‡ + (15ä¸‡+10ä¸‡)Ã—5 = **160ä¸‡**

**ROI ç»“è®º**: å‰ç«¯å®ç° 5 å¹´å¤šèŠ± 115 ä¸‡ï¼Œä¸”è´¨é‡æ›´å·® âŒ

---

## 6. æ¨èæ–¹æ¡ˆï¼šæ··åˆæ¨¡å¼

åŸºäºä¸Šè¿°åˆ†æï¼Œå®Œå…¨ç§»åˆ°å‰ç«¯æ˜¯ä¸åˆç†çš„ã€‚å»ºè®®é‡‡ç”¨**æ··åˆæ¨¡å¼**ï¼š

### 6.1 é“¾ä¸Šä¿ç•™ï¼ˆç”¨äºæ•°æ®è¿ç§»ï¼‰

```rust
/// ä¿ç•™é“¾ä¸Šé€‚é…å™¨ï¼Œä»…ç”¨äºæ•°æ®è¿ç§»
pub trait MediaDataProvider<AccountId> {
    type MediaId: Encode + Decode + Clone;

    /// âœ… ä¿ç•™ï¼šç”¨äºæ‰¹é‡æ•°æ®è¿ç§»
    fn get_standard_metadata(
        media_id: Self::MediaId,
        requester: Option<AccountId>,
    ) -> Option<StandardMediaMetadata>;

    /// âœ… ä¿ç•™ï¼šç”¨äºæƒé™éªŒè¯
    fn check_access_permission(
        media_id: Self::MediaId,
        requester: AccountId,
        access_type: AccessType,
    ) -> bool;

    /// âœ… ä¿ç•™ï¼šç”¨äºåˆ—å‡ºåª’ä½“
    fn list_entity_media(
        entity_id: u64,
        limit: u32,
    ) -> Vec<Self::MediaId>;
}

/// ä»…ç”¨äº OCW æ•°æ®è¿ç§»
impl<T: Config> Pallet<T> {
    pub fn import_legacy_media<P>(
        provider: P,
        legacy_media_id: P::MediaId,
        domain_id: DomainId,
        entity_id: u64,
    ) -> Result<PublicMediaId, Error<T>>
    where
        P: MediaDataProvider<T::AccountId>,
    {
        // ä»…åœ¨ OCW æˆ–æ²»ç†è°ƒç”¨æ—¶ä½¿ç”¨
        // ä¸æš´éœ²ç»™æ™®é€šç”¨æˆ·
    }
}
```

**ä½¿ç”¨åœºæ™¯**:
- âœ… OCW è‡ªåŠ¨æ‰¹é‡è¿ç§»
- âœ… æ²»ç†æ‰‹åŠ¨è§¦å‘è¿ç§»
- âœ… é“¾ä¸Šæƒé™éªŒè¯
- âŒ ä¸æš´éœ²ç»™æ™®é€šç”¨æˆ·ç›´æ¥è°ƒç”¨

### 6.2 å‰ç«¯è´Ÿè´£ï¼ˆæ–°å¢ä¸Šä¼ ï¼‰

```typescript
// stardust-dapp/src/utils/mediaAdapter.ts

/**
 * å‰ç«¯é€‚é…å™¨ - ä»…ç”¨äºæ–°å¢åª’ä½“ä¸Šä¼ çš„æ•°æ®å‡†å¤‡
 * ä¸è´Ÿè´£æ•°æ®è¿ç§»å’Œæƒé™éªŒè¯
 */
export class MediaUploadAdapter {
  /**
   * âœ… å‰ç«¯èŒè´£ï¼šæ–°å¢ä¸Šä¼ æ—¶çš„æ•°æ®å‡†å¤‡
   * å°† deceased çš„ä¸Šä¼ è¡¨å•æ•°æ®è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼
   */
  static prepareDeceasedMedia(
    form: DeceasedMediaForm
  ): MediaUploadRequest {
    return {
      domain_id: DOMAIN_IDS.DECEASED,
      entity_id: form.deceased_id,
      media_type: this.convertMediaType(form.type),
      metadata: {
        title: form.title,
        description: form.description,
        privacy_level: this.convertPrivacyLevel(form.visibility),
        tags: form.tags,
        // ...
      },
      storage_config: this.getStorageConfig(form.type),
      access_policy: this.buildAccessPolicy(form.visibility),
    };
  }

  /**
   * âœ… å‰ç«¯èŒè´£ï¼šè°ƒç”¨ç»Ÿä¸€çš„åª’ä½“åº“ä¸Šä¼ æ¥å£
   */
  static async uploadDeceasedMedia(
    api: ApiPromise,
    signer: KeyringPair,
    form: DeceasedMediaForm,
    fileData: Uint8Array
  ): Promise<MediaId> {
    const request = this.prepareDeceasedMedia(form);

    // è°ƒç”¨ç»Ÿä¸€çš„åª’ä½“åº“æ¥å£
    const tx = api.tx.publicMediaLibrary.uploadMedia(
      request.domain_id,
      request.entity_id,
      fileData,
      request.metadata,
      request.storage_config,
      request.access_policy
    );

    return await tx.signAndSend(signer);
  }

  // âŒ ä¸è´Ÿè´£ï¼šæ‰¹é‡æ•°æ®è¿ç§»
  // âŒ ä¸è´Ÿè´£ï¼šæƒé™éªŒè¯
  // âŒ ä¸è´Ÿè´£ï¼šè·¨ pallet æ•°æ®è¯»å–
}
```

**èŒè´£è¾¹ç•Œ**:
- âœ… **å‰ç«¯è´Ÿè´£**: è¡¨å•éªŒè¯ã€æ•°æ®å‡†å¤‡ã€ç±»å‹è½¬æ¢
- âœ… **å‰ç«¯è´Ÿè´£**: è°ƒç”¨ç»Ÿä¸€çš„åª’ä½“åº“ä¸Šä¼ æ¥å£
- âŒ **å‰ç«¯ä¸è´Ÿè´£**: æ‰¹é‡æ•°æ®è¿ç§»
- âŒ **å‰ç«¯ä¸è´Ÿè´£**: æƒé™éªŒè¯
- âŒ **å‰ç«¯ä¸è´Ÿè´£**: é“¾ä¸Šæ•°æ®è¯»å–å’Œè½¬æ¢

### 6.3 æ··åˆæ¨¡å¼æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ•°æ®æµåˆ†ç¦»                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ğŸ”µ æ–°å¢ä¸Šä¼ æµï¼ˆå‰ç«¯å¤„ç†ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  æ•°æ®å‡†å¤‡  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  ç»Ÿä¸€æ¥å£  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·è¡¨å•   â”‚â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ MediaUploadAdapterâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ PublicMediaLibâ”‚
â”‚  (å‰ç«¯ UI)  â”‚  ç±»å‹è½¬æ¢ â”‚   (å‰ç«¯å·¥å…·ç±»)     â”‚  ä¸Šä¼      â”‚   (é“¾ä¸Š)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†“
                         åªåšæ•°æ®å‡†å¤‡ï¼Œä¸åšè¿ç§»

ğŸŸ¢ æ•°æ®è¿ç§»æµï¼ˆé“¾ä¸Šå¤„ç†ï¼‰ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  OCWè§¦å‘  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  æ‰¹é‡å¯¼å…¥  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     OCW     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ MediaDataProvider â”‚â”€â”€â”€â”€â”€â”€â”€â”€â†’â”‚ PublicMediaLibâ”‚
â”‚ (è‡ªåŠ¨æ‰§è¡Œ)  â”‚  æ‰¹é‡è¿ç§» â”‚   (é“¾ä¸Šé€‚é…å™¨)     â”‚  åŸå­æ“ä½œ  â”‚   (é“¾ä¸Š)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â†‘
                         è¯»å– deceased å­˜å‚¨
                         æƒé™éªŒè¯ã€ç±»å‹è½¬æ¢
```

**ä¼˜åŠ¿**:
- âœ… **èŒè´£æ¸…æ™°**: å‰ç«¯ç®¡ UIï¼Œé“¾ä¸Šç®¡è¿ç§»
- âœ… **ä½è€¦åˆ**: ä¸¤æ¡è·¯å¾„äº’ä¸å¹²æ‰°
- âœ… **é«˜æ•ˆç‡**: è¿ç§»åœ¨é“¾ä¸Šæ‰¹é‡æ‰§è¡Œ
- âœ… **å®‰å…¨æ€§**: æƒé™éªŒè¯åœ¨é“¾ä¸Šè¿›è¡Œ

---

## 7. æœ€ç»ˆå»ºè®®

### 7.1 æ€»ä½“è¯„ä¼°

| æ–¹æ¡ˆ | å¯è¡Œæ€§ | åˆç†æ€§ | å¼€å‘æˆæœ¬ | ç»´æŠ¤æˆæœ¬ | æ¨èåº¦ |
|-----|-------|-------|---------|---------|-------|
| **v2.0 é“¾ä¸Šé€‚é…å™¨** | 9/10 âœ… | 9/10 âœ… | ä½ | ä½ | â­â­â­â­â­ |
| **å®Œå…¨ç§»åˆ°å‰ç«¯** | 3.5/10 âŒ | 4/10 âŒ | é«˜ | é«˜ | â­ |
| **æ··åˆæ¨¡å¼ï¼ˆæ¨èï¼‰** | 8/10 âœ… | 8.5/10 âœ… | ä¸­ | ä½ | â­â­â­â­â­ |

### 7.2 æœ€ç»ˆæ¨è

**âŒ ä¸å»ºè®®**ï¼šå®Œå…¨ç§»åˆ°å‰ç«¯

**ç†ç”±**:
1. âŒ æ•°æ®è¿ç§»æ— æ³•åœ¨å‰ç«¯å®ç°ï¼ˆæ•ˆç‡ä½ 25 å€ï¼‰
2. âŒ æƒé™éªŒè¯ä¸å®‰å…¨ï¼ˆå‰ç«¯å¯ç»•è¿‡ï¼‰
3. âŒ æ¶æ„è´¨é‡ä¸‹é™ï¼ˆè€¦åˆåº¦ä» 3.3 å›å‡åˆ° 6.0ï¼‰
4. âŒ æˆæœ¬æ›´é«˜ï¼ˆ5 å¹´å¤šèŠ± 115 ä¸‡ï¼‰
5. âŒ ç»´æŠ¤å›°éš¾ï¼ˆéœ€è¦ç»´æŠ¤ä¸¤å¥—é€»è¾‘ï¼‰

**âœ… å¼ºçƒˆæ¨è**ï¼šæ··åˆæ¨¡å¼

**ç†ç”±**:
1. âœ… ä¿ç•™é“¾ä¸Šé€‚é…å™¨ç”¨äºæ•°æ®è¿ç§»ï¼ˆé«˜æ•ˆã€å®‰å…¨ã€å¯é ï¼‰
2. âœ… å‰ç«¯ä»…è´Ÿè´£æ–°å¢ä¸Šä¼ çš„æ•°æ®å‡†å¤‡ï¼ˆèŒè´£æ¸…æ™°ï¼‰
3. âœ… æ¶æ„è´¨é‡ä¿æŒï¼ˆè€¦åˆåº¦ 3.3/10ï¼‰
4. âœ… æˆæœ¬åˆç†ï¼ˆä»…å¢åŠ  1 å‘¨å‰ç«¯å·¥å…·ç±»å¼€å‘ï¼‰
5. âœ… æ˜“äºç»´æŠ¤ï¼ˆèŒè´£åˆ†ç¦»ï¼Œä¸é‡å¤ï¼‰

### 7.3 å®æ–½å»ºè®®

#### é˜¶æ®µ1: ä¿ç•™é“¾ä¸Šé€‚é…å™¨ï¼ˆv2.0 è®¾è®¡ï¼‰

```rust
// pallets/media-library/src/lib.rs
// âœ… ä¿æŒ v2.0 è®¾è®¡ä¸å˜

pub trait MediaDataProvider<AccountId> {
    // å®Œæ•´ä¿ç•™ï¼Œç”¨äºæ•°æ®è¿ç§»
}

impl<T: Config> Pallet<T> {
    /// âœ… ä¿ç•™ï¼šç”¨äº OCW æ‰¹é‡è¿ç§»
    pub fn import_legacy_media<P>(...) -> Result<PublicMediaId, Error<T>>
    where
        P: MediaDataProvider<T::AccountId>,
    {
        // å®ç°ä¿æŒä¸å˜
    }
}
```

#### é˜¶æ®µ2: æ–°å¢å‰ç«¯å·¥å…·ç±»ï¼ˆ1å‘¨ï¼‰

```typescript
// stardust-dapp/src/utils/mediaAdapter.ts
// âœ… æ–°å¢ï¼šå‰ç«¯æ•°æ®å‡†å¤‡å·¥å…·

export class MediaUploadAdapter {
  static prepareDeceasedMedia(form: DeceasedMediaForm): MediaUploadRequest {
    // ä»…åšæ•°æ®å‡†å¤‡ï¼Œä¸åšè¿ç§»
  }

  static async uploadDeceasedMedia(
    api: ApiPromise,
    signer: KeyringPair,
    form: DeceasedMediaForm,
    fileData: Uint8Array
  ): Promise<MediaId> {
    // è°ƒç”¨ç»Ÿä¸€çš„åª’ä½“åº“ä¸Šä¼ æ¥å£
  }
}
```

#### é˜¶æ®µ3: æ›´æ–°å‰ç«¯ UIï¼ˆ1å‘¨ï¼‰

```typescript
// stardust-dapp/src/pages/Deceased/UploadMedia.tsx
// âœ… ä½¿ç”¨æ–°çš„å·¥å…·ç±»

import { MediaUploadAdapter } from '@/utils/mediaAdapter';

export function UploadMediaPage() {
  const handleSubmit = async (form: DeceasedMediaForm) => {
    // ä½¿ç”¨å·¥å…·ç±»å‡†å¤‡æ•°æ®
    const mediaId = await MediaUploadAdapter.uploadDeceasedMedia(
      api,
      signer,
      form,
      fileData
    );

    // ä¸Šä¼ æˆåŠŸ
    message.success(`åª’ä½“ä¸Šä¼ æˆåŠŸ: ${mediaId}`);
  };
}
```

#### é˜¶æ®µ4: æ–‡æ¡£æ›´æ–°ï¼ˆ0.5å‘¨ï¼‰

æ›´æ–° v2.0 æ–‡æ¡£ï¼Œæ˜ç¡®èŒè´£åˆ’åˆ†ï¼š
- é“¾ä¸Šé€‚é…å™¨ï¼šæ•°æ®è¿ç§»ã€æƒé™éªŒè¯
- å‰ç«¯å·¥å…·ç±»ï¼šæ–°å¢ä¸Šä¼ çš„æ•°æ®å‡†å¤‡

### 7.4 æˆæœ¬å¯¹æ¯”

| æ–¹æ¡ˆ | å¼€å‘æˆæœ¬ | ç»´æŠ¤æˆæœ¬/å¹´ | 5å¹´TCO | æ¶æ„è´¨é‡ |
|-----|---------|-----------|--------|---------|
| **v2.0 åŸè®¾è®¡** | 4å‘¨ (20ä¸‡) | 1äººæœˆ (5ä¸‡) | 45ä¸‡ | 9/10 âœ… |
| **å®Œå…¨ç§»åˆ°å‰ç«¯** | 7å‘¨ (35ä¸‡) | 4äººæœˆ (20ä¸‡) | 160ä¸‡ | 4/10 âŒ |
| **æ··åˆæ¨¡å¼** | 4.5å‘¨ (22.5ä¸‡) | 1.5äººæœˆ (7.5ä¸‡) | 60ä¸‡ | 8.5/10 âœ… |

**ç»“è®º**: æ··åˆæ¨¡å¼ç•¥å¢åŠ æˆæœ¬ï¼ˆ+15ä¸‡ over 5å¹´ï¼‰ï¼Œä½†ä¿æŒé«˜æ¶æ„è´¨é‡ï¼Œæ˜¯æœ€ä½³å¹³è¡¡ç‚¹ âœ…

---

## 8. é£é™©è¯„ä¼°

### 8.1 å¦‚æœåšæŒå®Œå…¨ç§»åˆ°å‰ç«¯

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|-----|-------|-----|---------|
| **æ•°æ®è¿ç§»å¤±è´¥** | é«˜ (80%) | æé«˜ | âŒ æ— æœ‰æ•ˆç¼“è§£æªæ–½ |
| **æƒé™éªŒè¯æ¼æ´** | ä¸­ (60%) | é«˜ | é“¾ä¸Šå¿…é¡»é‡æ–°éªŒè¯ï¼ˆé‡å¤å·¥ä½œï¼‰ |
| **å‰ç«¯ç»´æŠ¤å›°éš¾** | é«˜ (90%) | ä¸­ | å¢åŠ ç»´æŠ¤äººå‘˜ï¼ˆæˆæœ¬é«˜ï¼‰ |
| **æ¶æ„è´¨é‡ä¸‹é™** | ç¡®å®š (100%) | é«˜ | âŒ æ— æ³•é¿å… |
| **ç”¨æˆ·ä½“éªŒå·®** | é«˜ (70%) | ä¸­ | è¿ç§»æ…¢ã€å¤±è´¥ç‡é«˜ |

**é£é™©æ€»ç»“**: é«˜é£é™©ï¼Œä¸å»ºè®®é‡‡çº³ âŒ

### 8.2 å¦‚æœé‡‡ç”¨æ··åˆæ¨¡å¼

| é£é™© | å¯èƒ½æ€§ | å½±å“ | ç¼“è§£æªæ–½ |
|-----|-------|-----|---------|
| **å‰ç«¯å·¥å…·ç±»å¼€å‘å»¶è¿Ÿ** | ä½ (20%) | ä½ | ç®€å•å·¥å…·ç±»ï¼Œé£é™©å¯æ§ |
| **èŒè´£è¾¹ç•Œä¸æ¸…** | ä½ (15%) | ä½ | æ–‡æ¡£æ˜ç¡®å®šä¹‰èŒè´£ |
| **å‰ç«¯è°ƒç”¨å¤æ‚åº¦** | ä½ (10%) | ä½ | å°è£…è‰¯å¥½çš„å·¥å…·ç±» |

**é£é™©æ€»ç»“**: ä½é£é™©ï¼Œå¯æ§ âœ…

---

## 9. æ€»ç»“

### 9.1 æ ¸å¿ƒç»“è®º

1. **âŒ ä¸å»ºè®®å®Œå…¨ç§»åˆ°å‰ç«¯**
   - æ•°æ®è¿ç§»æ— æ³•å®ç°ï¼ˆæ•ˆç‡ä½ 25 å€ï¼‰
   - æƒé™éªŒè¯ä¸å®‰å…¨
   - æ¶æ„è´¨é‡ä¸‹é™ï¼ˆè€¦åˆåº¦ +82%ï¼‰
   - æˆæœ¬æ›´é«˜ï¼ˆ5 å¹´å¤šèŠ± 115 ä¸‡ï¼‰

2. **âœ… å¼ºçƒˆæ¨èæ··åˆæ¨¡å¼**
   - é“¾ä¸Šä¿ç•™ MediaDataProviderï¼ˆç”¨äºè¿ç§»ï¼‰
   - å‰ç«¯æ–°å¢å·¥å…·ç±»ï¼ˆç”¨äºæ–°å¢ä¸Šä¼ ï¼‰
   - èŒè´£æ¸…æ™°ã€æˆæœ¬å¯æ§ã€æ¶æ„ä¼˜ç§€

3. **âœ… v2.0 åŸè®¾è®¡ä»ç„¶æœ€ä¼˜**
   - å¦‚æœä¸è€ƒè™‘å‰ç«¯å·¥å…·ç±»ï¼Œv2.0 åŸè®¾è®¡æœ€ä¼˜
   - è€¦åˆåº¦æœ€ä½ï¼ˆ3.3/10ï¼‰
   - æˆæœ¬æœ€ä½ï¼ˆ5 å¹´ 45 ä¸‡ï¼‰
   - æ¶æ„è´¨é‡æœ€é«˜ï¼ˆ9/10ï¼‰

### 9.2 å†³ç­–å»ºè®®

**å†³ç­–çŸ©é˜µ**:

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | ç†ç”± |
|-----|---------|------|
| **æ•°æ®è¿ç§»ä¸ºä¸»** | v2.0 åŸè®¾è®¡ | æœ€é«˜æ•ˆã€æœ€å®‰å…¨ |
| **å‰ç«¯éœ€è¦ç®€åŒ–** | æ··åˆæ¨¡å¼ | å¹³è¡¡æ¶æ„å’Œå‰ç«¯å¤æ‚åº¦ |
| **å®Œå…¨ç§»åˆ°å‰ç«¯** | âŒ ä¸æ¨è | æŠ€æœ¯ä¸å¯è¡Œã€æˆæœ¬é«˜ã€è´¨é‡å·® |

**æœ€ç»ˆå»ºè®®**: é‡‡ç”¨**æ··åˆæ¨¡å¼**ï¼Œåœ¨ v2.0 åŸºç¡€ä¸Šæ–°å¢å‰ç«¯å·¥å…·ç±» âœ…

### 9.3 ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³è¡ŒåŠ¨**: ç¡®è®¤é‡‡ç”¨æ··åˆæ¨¡å¼
2. **çŸ­æœŸï¼ˆ1å‘¨ï¼‰**: å¼€å‘å‰ç«¯ MediaUploadAdapter å·¥å…·ç±»
3. **ä¸­æœŸï¼ˆ2å‘¨ï¼‰**: é›†æˆåˆ°å‰ç«¯ UIï¼Œæ›´æ–°æ–‡æ¡£
4. **é•¿æœŸ**: ä¿æŒæ¶æ„ç¨³å®šï¼ŒæŒç»­ä¼˜åŒ–

---

*æœ¬æŠ¥å‘ŠåŸºäº v2.0 è®¾è®¡æ–‡æ¡£å’Œå®é™…æŠ€æœ¯çº¦æŸåˆ†æç¼–å†™ï¼Œå»ºè®®ä¼˜å…ˆé‡‡çº³æ··åˆæ¨¡å¼æ–¹æ¡ˆã€‚*
