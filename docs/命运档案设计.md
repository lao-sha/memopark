## 命运档案设计（占卜全生命周期记录）

> **版本**: v0.1（概念设计稿）  
> **适用范围**: `pallet-divination-*`（六爻 / 奇门 / 梅花 / 八字等）  
> **目标**: 为每次占卜建立可追溯、可验证、可复盘的「命运档案」

---

## 一、核心概念

- **命运档案（FateRecord）**  
  对「一次占卜行为」及其后续应验情况的完整记录。  
  由三部分组成：
  1. **链上元数据**：谁、什么时候、用什么方式、起了什么卦 / 局，当前应验状态等（结构化、可检索）  
  2. **IPFS 内容**：问题详情、人工解读、AI 解读、事后备注等（文本为主，加密保存）  
  3. **时间轴索引**：把多次占卜串成一条人生 / 家族「命运时间线」

- **设计原则**
  - **最小上链**：链上只放必要的索引与标签，敏感内容走 IPFS + 加密 CID（符合项目 CID 加密规范）
  - **不可篡改**：关键字段一经写入不可随意修改，应验状态允许追加更新但保留历史
  - **多占卜类型统一抽象**：六爻 / 奇门 / 梅花 / 八字共享一套 FateRecord 抽象，便于前端统一展示

---

## 二、链上数据结构设计（抽象层）

> 这里先给出**抽象结构**，后续可以按 pallet 具体落地到 `pallet-divination-common` 或各自 pallet 中。

### 1. FateRecord 抽象结构

```rust
/// 命运档案（一次占卜的链上元数据）
pub struct FateRecord<AccountId, BlockNumber, Moment, MaxCidLen> {
    /// 档案 ID（全局递增）
    pub id: u64,
    /// 发起人账号
    pub owner: AccountId,
    /// 占卜类型（六爻 / 奇门 / 梅花 / 八字 等）
    pub divination_kind: DivinationKind,
    /// 关联的具体卦象 / 局 ID（例如六爻 gua_id，奇门局 id 等）
    pub related_id: u64,

    // ===== 时间信息 =====
    /// 创建区块号
    pub created_at: BlockNumber,
    /// 创建时间戳（如有 pallet_timestamp）
    pub created_ts: Moment,

    // ===== 问题与上下文 =====
    /// 问题内容 CID（IPFS，需加密）
    pub question_cid: Option<BoundedVec<u8, MaxCidLen>>,
    /// 备注 / 场景标签 CID（IPFS，可包含更丰富描述）
    pub context_cid: Option<BoundedVec<u8, MaxCidLen>>,

    // ===== 状态与应验 =====
    /// 当前应验状态
    pub outcome_status: OutcomeStatus,
    /// 应验结果 CID（IPFS，记录事后反馈与总结）
    pub outcome_cid: Option<BoundedVec<u8, MaxCidLen>>,

    // ===== 标记与权限 =====
    /// 是否公开（前端可展示在「命运时间轴」中）
    pub is_public: bool,
    /// 隐私级别（仅自己 / 家族可见 / 完全公开 等）
    pub privacy_level: PrivacyLevel,
}
```

> 说明：以上为**概念层**，具体字段名和泛型参数可根据现有 Runtime 规范调整。  
> 关键点在于：**卦象本身的结构不动，只增加一层「命运档案」索引。**

### 2. 枚举字段建议

- **占卜类型 `DivinationKind`**

```rust
pub enum DivinationKind {
    LiuYao,    // 六爻
    QiMen,     // 奇门
    MeiHua,    // 梅花
    BaZi,      // 八字
    Other(u8), // 预留扩展
}
```

- **应验状态 `OutcomeStatus`**

```rust
pub enum OutcomeStatus {
    Pending,      // 未知 / 事件尚未发生
    PartiallyHit, // 部分应验
    Hit,          // 应验
    Missed,       // 未应验
    Cancelled,    // 事件取消 / 不再追踪
}
```

- **隐私级别 `PrivacyLevel`**

```rust
pub enum PrivacyLevel {
    Private,    // 仅自己可见
    Contacts,   // 授权联系人 / 家族可见
    Public,     // 完全公开
}
```

---

## 三、IPFS 内容结构设计

> 链上只存 CID，实际内容放 IPFS，除特殊说明外 **默认使用加密 CID**。

### 1. 问题内容（Question Payload）

```jsonc
{
  "version": "1.0",
  "kind": "question",
  "divination_kind": "meihua",      // liuyao / qimen / meihua / bazi ...
  "title": "某次重要决策占卜",
  "question_text": "我是否应该在今年内跳槽到 A 公司？",
  "context": {
    "category": "career",           // career / love / health / lawsuit ...
    "importance": "high",           // low / normal / high
    "tags": ["跳槽", "北京", "互联网公司"]
  },
  "client_snapshot": {
    "time": "2025-01-01T10:20:30Z",
    "timezone": "Asia/Shanghai",
    "location_hint": "北京",
    "device": "mobile"
  }
}
```

### 2. 解读与过程（Interpretation Payload）

可选地单独存一份解读内容：

```jsonc
{
  "version": "1.0",
  "kind": "interpretation",
  "fate_id": 123,                   // 关联命运档案 ID
  "raw_result": { /* 占卜结果的结构化摘要，可选 */ },
  "human_notes": "人工占卜师的解读文本...",
  "ai_notes": "AI 辅助解读文本...",
  "advice": "建议三个月内先观望，不要立刻跳槽...",
  "created_at": "2025-01-01T10:21:00Z"
}
```

### 3. 事后反馈与总结（Outcome Payload）

```jsonc
{
  "version": "1.0",
  "kind": "outcome",
  "fate_id": 123,
  "final_status": "Hit",            // Hit / PartiallyHit / Missed / Cancelled
  "event_time": "2025-06-30T09:00:00Z",
  "summary": "最终没有跳槽，但公司内部给了更好的岗位与薪酬，整体结果好于预期。",
  "reflection": "这次占卜让我冷静下来，多做了一些调研，也促成了和上级的沟通。",
  "labels": ["心态改善", "决策复盘"]
}
```

---

## 四、生命周期设计（从起卦到「命运档案」）

### 1. 创建阶段（占卜当下）

1. 用户在前端发起占卜（六爻 / 奇门 / 梅花等）  
2. 前端收集：
   - 占卜问题（明文 → 前端本地加密 → 生成加密 CID）
   - 场景标签（重要程度、分类标签等）
3. 前端：
   - 调用对应的 `pallet-divination-*` 生成卦象 / 局（**链上起卦或前端起卦+上链存证**）
   - 同时/随后调用「命运档案」创建接口，例如：

```rust
// 伪接口：由具体 pallet 或公共 pallet 暴露
fn create_fate_record(
    origin,
    divination_kind: DivinationKind,
    related_id: u64,
    question_cid: Option<BoundedVec<u8, MaxCidLen>>,
    context_cid: Option<BoundedVec<u8, MaxCidLen>>,
    is_public: bool,
    privacy_level: PrivacyLevel,
) -> DispatchResult;
```

4. 链上生成：
   - 新的 `FateRecord`  
   - 事件 `FateRecordCreated { id, owner, divination_kind, related_id }`

### 2. 使用阶段（查看与解读）

- 前端「命运时间轴」页面：  
  - 按 `owner` 查询所有 FateRecord ID  
  - 根据 `divination_kind + related_id` 跳转到对应卦象 / 局详情  
  - 结合 IPFS 中的 question / interpretation 内容进行展示

### 3. 应验反馈阶段（事后更新）

- 用户在事件发展后，可以发起「标记应验」操作：

```rust
fn update_fate_outcome(
    origin,
    fate_id: u64,
    new_status: OutcomeStatus,
    outcome_cid: Option<BoundedVec<u8, MaxCidLen>>, // 事后总结内容 CID（加密）
) -> DispatchResult;
```

- 链上更新：
  - `outcome_status`
  - `outcome_cid`
  - 记录事件 `FateOutcomeUpdated { fate_id, new_status }`

### 4. 隐私与公开控制

- 用户可随时调整 `is_public` / `privacy_level`：

```rust
fn set_fate_visibility(
    origin,
    fate_id: u64,
    is_public: bool,
    privacy_level: PrivacyLevel,
) -> DispatchResult;
```

- 前端根据隐私级别决定：
  - 是否在公开广场 / 纪念馆中展示  
  - 是否只在个人空间可见  
  - 是否允许家族成员访问

---

## 五、与现有占卜 Pallet 的关系

- **六爻 (`pallet-liuyao`) / 奇门 / 梅花 / 八字**：
  - 保持各自原有的卦象 / 局数据结构不变
  - 在起卦成功后，额外调用「命运档案创建」逻辑，建立一条 FateRecord

- **前端层**：
  - 统一提供「命运时间轴」组件：按时间展示所有 FateRecord  
  - 在每条记录中显示：
    - 占卜类型图标（六爻 / 奇门 / 梅花 / 八字）  
    - 简短问题标题 + 分类标签  
    - 当前应验状态（颜色标识）  
    - 点击后进入对应卦象 / 局的详情 + 解读 + 事后总结

---

## 六、后续迭代方向（供参考）

- **统计与可视化**
  - 按年份 / 事项类型统计一生中占卜分布与决策密度
  - 生成「人生命运热力图」

- **家族命运档案**
  - 将多个地址 / 纪念馆绑定为一个「家族」，聚合命运档案
  - 观察家族在某些事项上的长期模式（例如迁徙、职业偏好）

- **AI 命运教练**
  - 基于历史 FateRecord + 实际结果，为用户提供「决策风格分析」与「改进建议」

---

## 七、小结

- **命运档案 = 「问题 + 卦象 / 局 + 解读 + 结果」的完整闭环记录**  
- 链上负责：索引 + 状态 + 不可篡改时间线  
- IPFS 负责：具体文字内容（问题、解读、总结），按项目规范加密存储  
- 前端负责：把这些记录组织成「一生的命运时间轴」，服务于纪念、复盘与成长。


