# 购买年费会员 vs 购买供奉 - 资金流向对比分析

## 📋 文档概述

本文档详细分析购买年费会员（`pallet-membership`）和购买供奉（`pallet-memo-offerings`）两种场景下的资金流向异同，帮助理解当前代码的资金分配机制。

---

## 🔍 核心流程对比

### 场景1：购买年费会员（100,000 DUST）

**调用入口：** `pallet-membership::purchase_membership()`

```rust
// 位置：pallets/membership/src/lib.rs:316
pub fn purchase_membership(
    origin: OriginFor<T>,
    level_id: u8,           // 0=Year1, 1=Year3, 2=Year5, 3=Year10
    referral_code: Vec<u8>, // 推荐码（必填）
) -> DispatchResult
```

**资金流详细步骤：**

```
【步骤1】用户扣款 → 联盟托管账户
┌─────────────────────────────────────────────────────────┐
│ 代码位置：pallets/membership/src/lib.rs:351-356         │
│                                                          │
│ T::Currency::transfer(                                   │
│     &who,                                 // 用户账户   │
│     &affiliate_account,                   // 联盟托管   │
│     price,                                // 100,000    │
│     ExistenceRequirement::KeepAlive,                     │
│ )?;                                                      │
└─────────────────────────────────────────────────────────┘

【步骤2】触发分成分配 - 100%推荐链模式
┌─────────────────────────────────────────────────────────┐
│ 代码位置：pallets/membership/src/lib.rs:385-391         │
│                                                          │
│ T::AffiliateDistributor::distribute_membership_rewards( │
│     &who,                                 // 购买者     │
│     price_u128,                           // 100,000    │
│     current_block,                        // 当前区块   │
│ )?;                                                      │
└─────────────────────────────────────────────────────────┘
        ↓
【步骤3】affiliate-config 路由到即时分成
┌─────────────────────────────────────────────────────────┐
│ 代码位置：pallets/affiliate-config/src/lib.rs:528-534   │
│                                                          │
│ T::InstantProvider::distribute_to_referral_chain_only(  │
│     buyer,                                               │
│     amount,                              // 100,000     │
│     &escrow_account,                     // 托管账户    │
│ )?;                                                      │
└─────────────────────────────────────────────────────────┘
        ↓
【步骤4】affiliate-instant 纯推荐链分配（100%）
┌─────────────────────────────────────────────────────────┐
│ 代码位置：pallets/affiliate-instant/src/lib.rs:996-1133 │
│                                                          │
│ pub fn distribute_to_referral_chain_only(               │
│     buyer: &T::AccountId,                               │
│     amount: u128,                        // 100,000     │
│     escrow_account: &T::AccountId,       // 托管账户    │
│ )                                                        │
└─────────────────────────────────────────────────────────┘

【最终分配】100% 推荐链分成
├─ 第1代（30%）：30,000 DUST → 直接推荐人
├─ 第2代（25%）：25,000 DUST → 二级推荐人
├─ 第3代（15%）：15,000 DUST → 三级推荐人
├─ 第4代（10%）：10,000 DUST → 四级推荐人
├─ 第5代（7%）：7,000 DUST → 五级推荐人
├─ 第6代（3%）：3,000 DUST → 六级推荐人
├─ 第7-9代（各2%）：6,000 DUST → 中层推荐人
├─ 第10-15代（各1%）：6,000 DUST → 深层推荐人
└─ 无效层级/剩余 → 进入国库
```

---

### 场景2：购买供奉（100,000 DUST）

**调用入口：** `pallet-memo-offerings::offer_by_sacrifice()`

```rust
// 位置：pallets/memo-offerings/src/lib.rs:1122
pub fn offer_by_sacrifice(
    origin: OriginFor<T>,
    target: (u8, u64),                  // 目标对象
    sacrifice_id: u64,                  // 祭品ID
    media: Vec<...>,                    // 媒体列表
    duration_weeks: Option<u32>,        // 持续周数
    is_vip: bool,                       // 是否会员
) -> DispatchResult
```

**资金流详细步骤：**

```
【步骤1】计算价格（含会员折扣）
┌─────────────────────────────────────────────────────────┐
│ 代码位置：pallets/memo-offerings/src/lib.rs:1177-1191   │
│                                                          │
│ // 计算原价                                              │
│ let original_price: u128 = if let Some(p) = fixed {     │
│     p                                     // 100,000     │
│ } else {                                                 │
│     let u = unit × duration_weeks                        │
│ };                                                       │
│                                                          │
│ // 应用会员折扣（年费会员3折）                           │
│ let final_price = if is_member {                         │
│     original_price × 30 / 100           // 30,000       │
│ } else {                                                 │
│     original_price                      // 100,000      │
│ };                                                       │
└─────────────────────────────────────────────────────────┘

【步骤2】用户扣款 → 目标账户（直接转账）
┌─────────────────────────────────────────────────────────┐
│ 代码位置：pallets/memo-offerings/src/lib.rs:1199-1202   │
│                                                          │
│ let dest = T::DonationResolver::account_for(target);    │
│                                                          │
│ T::Currency::transfer(                                   │
│     &who,                                 // 用户账户   │
│     &dest,                                // 目标账户   │
│     amt_balance,                          // 30,000     │
│     ExistenceRequirement::KeepAlive                      │
│ )?;                                                      │
└─────────────────────────────────────────────────────────┘

【步骤3】触发回调钩子（仅通知，不处理资金）
┌─────────────────────────────────────────────────────────┐
│ 代码位置：pallets/memo-offerings/src/lib.rs:1235        │
│                                                          │
│ T::OnOffering::on_offering(                              │
│     target,                                              │
│     0,                                    // kind_code   │
│     &who,                                                │
│     Some(final_price),                    // 30,000     │
│     duration_weeks,                                      │
│     routed_simple                         // 资金路径   │
│ );                                                       │
└─────────────────────────────────────────────────────────┘

【最终分配】100% 直接转给目标账户
└─ 目标账户：30,000 DUST（会员折扣后）
   ⚠️ 没有推荐链分成！
   ⚠️ 没有销毁/国库/存储费！
```

---

## 📊 资金流向对比表

| 对比项 | 购买年费会员 | 购买供奉 | 差异说明 |
|--------|------------|---------|----------|
| **扣款方式** | 用户 → 联盟托管账户 | 用户 → 目标账户 | 会员走托管，供奉直达 |
| **会员折扣** | ❌ 无折扣 | ✅ 会员3折（30%） | 供奉享受折扣 |
| **推荐链分成** | ✅ 100%推荐链分配 | ❌ 无推荐链分成 | **核心差异** |
| **销毁机制** | ❌ 无销毁 | ❌ 无销毁 | 都没有销毁 |
| **国库费用** | 部分进国库（无效层级） | ❌ 无国库费用 | 会员有国库托底 |
| **存储费用** | ❌ 无存储费 | ❌ 无存储费 | 都没有存储费 |
| **资金终点** | 推荐链各层级 | 目标账户 | 完全不同 |
| **分配模式** | 即时分成（15层） | 直接转账（无分层） | 会员多层分配 |
| **分配比例** | 30/25/15/10/7/3/2... | 100%给目标 | 会员递减分配 |
| **调用链** | membership → affiliate-config → affiliate-instant | offerings → 直接转账 | 会员走联盟系统 |

---

## 💰 资金分配详细对比

### 案例：用户A购买100,000 MEMO产品

#### 场景1：购买年费会员（Year1，400 MEMO实际价格）

```
用户支付：400 DUST
├─ 扣款：400 DUST → 联盟托管账户
│
└─ 推荐链分成（100%）：400 DUST
    ├─ 第1代（30%）：120 DUST ✅
    ├─ 第2代（25%）：100 DUST ✅
    ├─ 第3代（15%）：60 DUST ✅
    ├─ 第4代（10%）：40 DUST ✅
    ├─ 第5代（7%）：28 DUST ✅
    ├─ 第6代（3%）：12 DUST ✅
    ├─ 第7-9代（各2%）：24 DUST ✅
    └─ 第10-15代（各1%）：24 DUST（总408，超出部分归一化）

目标账户收入：0 DUST（全部用于推荐分成）
推荐链总收入：400 DUST
```

#### 场景2：购买供奉（100,000 MEMO原价，会员3折）

```
原价：100,000 DUST
会员折扣：30%
实际支付：30,000 DUST
│
├─ 扣款：30,000 DUST → 目标账户（直接转账）
│
└─ 目标账户收入：30,000 DUST ✅

推荐链收入：0 DUST ❌（没有推荐分成！）
销毁金额：0 DUST
国库金额：0 DUST
```

---

## ⚠️ 关键问题发现

### 问题1：供奉购买**没有触发推荐链分成** ❌

**现状：**
- 购买供奉时，资金直接转给目标账户
- `OnOffering` 钩子仅做通知，不处理资金分配
- 推荐链没有任何收益

**代码位置：**
```rust
// pallets/memo-offerings/src/lib.rs:1200-1202
T::Currency::transfer(&who, &dest, amt_balance, ExistenceRequirement::KeepAlive)?;

// pallets/memo-offerings/src/lib.rs:1235
T::OnOffering::on_offering(target, 0, &who, Some(final_price), duration_weeks, routed_simple);
// ⚠️ 这里只是通知，没有调用分成系统！
```

**影响：**
- 推荐人没有动力推广供奉购买
- 破坏了推荐激励机制
- 与年费会员的激励逻辑不一致

---

### 问题2：没有销毁/国库/存储费机制 ❌

**现状：**
- 年费会员：100%推荐链（无系统费用）
- 购买供奉：100%给目标账户（无系统费用）
- 没有通缩机制（无销毁）
- 没有国库储备
- 没有存储费用

**对比方案9设计：**
```
应该的分配（供奉100,000 DUST）：
├─ 第一层：即时推荐分成（75,000 DUST）
│   ├─ 推荐链分配：67,500 DUST
│   └─ 滑落奖励：7,500 DUST
├─ 第二层：持币分红池（15,000 DUST）
└─ 第三层：系统费用（10,000 DUST）
    ├─ 销毁：5,000 DUST
    ├─ 国库：3,000 DUST
    └─ 存储：2,000 DUST
```

---

### 问题3：会员购买和供奉购买的分成逻辑完全不同

| 维度 | 购买会员 | 购买供奉 | 一致性 |
|------|---------|---------|--------|
| 推荐链分成 | ✅ 100%推荐链 | ❌ 无分成 | **不一致** |
| 销毁机制 | ❌ 无销毁 | ❌ 无销毁 | 一致（都没有） |
| 国库费用 | 部分（无效层级） | ❌ 无 | **不一致** |
| 分成层数 | 15层 | 0层 | **不一致** |
| 激励模式 | 推荐激励 | 无激励 | **不一致** |

---

## 🎯 方案9整合建议

### 建议1：统一供奉购买的资金流

**修改 `offer_by_sacrifice` 函数：**

```rust
// pallets/memo-offerings/src/lib.rs:1200-1235

// ❌ 当前代码（直接转账给目标）
T::Currency::transfer(&who, &dest, amt_balance, ExistenceRequirement::KeepAlive)?;

// ✅ 修改为：转账到联盟托管账户
let affiliate_account = T::AffiliatePalletId::get().into_account_truncating();
T::Currency::transfer(&who, &affiliate_account, amt_balance, ExistenceRequirement::KeepAlive)?;

// ✅ 触发方案9的三合一分配
T::AffiliateDistributor::distribute_three_in_one(
    &who,
    original_price,      // 原价（作为分成基数）
    final_price,         // 实付（会员折扣后）
    &affiliate_account,  // 托管账户
)?;
```

**分配逻辑：**
```
供奉100,000 DUST（会员3折，实付30,000）
├─ 扣款：30,000 DUST → 联盟托管账户
│
├─ 第一层：即时推荐分成（75% × 30,000 = 22,500）
│   ├─ 第1代：5,625 DUST
│   ├─ 第2代：4,500 DUST
│   ├─ ...
│   └─ 滑落剩余：500 DUST → 分红池
│
├─ 第二层：持币分红池（15% × 30,000 + 500 = 5,000）
│   └─ 累积待周期分配
│
├─ 第三层：系统费用（10% × 30,000 = 3,000）
│   ├─ 销毁：1,500 DUST
│   ├─ 国库：900 DUST
│   └─ 存储：600 DUST
│
└─ 目标账户（从托管账户转账剩余）
    └─ 0 DUST（全部用于分成系统）
    或者保留一定比例给目标（如10%）
```

---

### 建议2：设计供奉专用分配模式

**新增配置：供奉分配比例**

```rust
// 在 affiliate-config 中新增
pub struct OfferingAllocation {
    pub referral_chain: u8,    // 推荐链：60%
    pub target_account: u8,    // 目标账户：25%
    pub dividend_pool: u8,     // 分红池：10%
    pub system_fees: u8,       // 系统费用：5%（销毁2% + 国库2% + 存储1%）
}
```

**分配示例：**
```
供奉30,000 DUST（会员折扣后）
├─ 推荐链分成（60%）：18,000 DUST
│   ├─ 第1代：4,500 DUST
│   ├─ 第2代：3,600 DUST
│   └─ ...
│
├─ 目标账户（25%）：7,500 DUST ✅ 保留给逝者家属
│
├─ 持币分红池（10%）：3,000 DUST
│
└─ 系统费用（5%）：1,500 DUST
    ├─ 销毁：600 DUST
    ├─ 国库：600 DUST
    └─ 存储：300 DUST
```

**优点：**
- ✅ 推荐人有动力推广供奉
- ✅ 目标账户仍有收入（25%）
- ✅ 系统有通缩机制（销毁）
- ✅ 国库有储备（治理资金）
- ✅ 持币者有分红激励

---

### 建议3：会员购买也应用方案9

**修改 `purchase_membership` 函数：**

```rust
// pallets/membership/src/lib.rs:385-391

// ❌ 当前代码（100%推荐链）
T::AffiliateDistributor::distribute_membership_rewards(
    &who,
    price_u128,
    current_block,
)?;

// ✅ 修改为：应用三合一模式
T::AffiliateDistributor::distribute_three_in_one(
    &who,
    price_u128,      // 原价
    price_u128,      // 实付（会员购买无折扣）
    &affiliate_account,
)?;
```

**分配示例（400 MEMO年费会员）：**
```
用户支付：400 DUST
├─ 第一层：即时推荐分成（75%）：300 DUST
│   ├─ 第1代：75 DUST
│   ├─ 第2代：60 DUST
│   └─ ...
│
├─ 第二层：持币分红池（15%）：60 DUST
│
└─ 第三层：系统费用（10%）：40 DUST
    ├─ 销毁：20 DUST
    ├─ 国库：12 DUST
    └─ 存储：8 DUST
```

---

## 📋 实施步骤

### Phase 1：修改 offerings pallet

1. **修改资金流向**
   - [ ] 改为转账到联盟托管账户
   - [ ] 移除直接转账给目标账户

2. **集成三合一分配**
   - [ ] 调用 `distribute_three_in_one()`
   - [ ] 传递原价和实付参数

3. **保留目标账户收入（可选）**
   - [ ] 配置目标账户比例（如25%）
   - [ ] 从托管账户转账剩余给目标

### Phase 2：修改 membership pallet

1. **应用三合一分配**
   - [ ] 替换 `distribute_membership_rewards()`
   - [ ] 改为 `distribute_three_in_one()`

2. **添加系统费用**
   - [ ] 销毁5%
   - [ ] 国库3%
   - [ ] 存储2%

### Phase 3：扩展 affiliate-config

1. **新增供奉分配模式**
   - [ ] 定义 `OfferingAllocation` 结构
   - [ ] 实现供奉专用分配逻辑
   - [ ] 支持目标账户保留比例

2. **治理接口**
   - [ ] 设置供奉分配比例
   - [ ] 设置目标账户保留比例

### Phase 4：测试验证

1. **单元测试**
   - [ ] 测试供奉购买资金流
   - [ ] 测试会员购买资金流
   - [ ] 测试分成比例计算

2. **集成测试**
   - [ ] 端到端测试完整流程
   - [ ] 验证资金总和守恒
   - [ ] 验证推荐链分成正确

---

## 📊 修改前后对比

### 修改前（当前代码）

| 场景 | 推荐链收益 | 目标账户收益 | 销毁 | 国库 | 存储 |
|------|-----------|------------|------|------|------|
| 购买会员（400） | 400 (100%) | 0 | 0 | 少量 | 0 |
| 购买供奉（30,000） | 0 ❌ | 30,000 (100%) | 0 | 0 | 0 |

**问题：**
- ❌ 供奉购买没有推荐激励
- ❌ 没有通缩机制
- ❌ 没有持币分红
- ❌ 两种购买逻辑完全不一致

---

### 修改后（方案9）

| 场景 | 推荐链收益 | 目标账户收益 | 分红池 | 销毁 | 国库 | 存储 |
|------|-----------|------------|-------|------|------|------|
| 购买会员（400） | 300 (75%) | 0 | 60 (15%) | 20 (5%) | 12 (3%) | 8 (2%) |
| 购买供奉（30,000） | 18,000 (60%) | 7,500 (25%) | 3,000 (10%) | 600 (2%) | 600 (2%) | 300 (1%) |

**改进：**
- ✅ 供奉购买有推荐激励（60%）
- ✅ 目标账户仍有收入（25%）
- ✅ 通缩机制（销毁2%）
- ✅ 持币分红（10%）
- ✅ 国库储备（2%）
- ✅ 两种购买逻辑统一

---

## 🎯 关键收益

### 1. 推荐激励统一

**修改前：**
- 推广会员：有收益（100%）
- 推广供奉：无收益 ❌

**修改后：**
- 推广会员：有收益（75%）
- 推广供奉：有收益（60%）✅

### 2. 经济模型健康

**修改前：**
- 无销毁：通胀
- 无分红：持币无动力
- 无国库：治理无储备

**修改后：**
- 销毁2%：通缩机制
- 分红10-15%：持币有收益
- 国库2-3%：治理有资金

### 3. 生态平衡

**修改前：**
- 目标账户：100%（供奉）
- 推荐链：0%（供奉）❌

**修改后：**
- 目标账户：25%（供奉）
- 推荐链：60%（供奉）✅
- 平台发展：15%（分红+系统）

---

## 📚 相关代码位置

### 当前实现

| 功能 | 文件位置 | 行号 |
|------|---------|------|
| 会员购买 | `pallets/membership/src/lib.rs` | 316-402 |
| 会员扣款 | `pallets/membership/src/lib.rs` | 351-356 |
| 会员分成调用 | `pallets/membership/src/lib.rs` | 385-391 |
| 供奉购买 | `pallets/memo-offerings/src/lib.rs` | 1122-1256 |
| 供奉扣款 | `pallets/memo-offerings/src/lib.rs` | 1200-1202 |
| 供奉通知钩子 | `pallets/memo-offerings/src/lib.rs` | 1235 |
| 联盟分配器 | `pallets/affiliate-config/src/lib.rs` | 184-209 |
| 会员分成实现 | `pallets/affiliate-config/src/lib.rs` | 515-535 |
| 纯推荐链分配 | `pallets/affiliate-instant/src/lib.rs` | 996-1133 |

### 方案9实现

| 功能 | 文件位置 | 行号 |
|------|---------|------|
| 三合一分配 | `pallets/affiliate-instant/src/lib.rs` | 1168-1206 |
| 滑落分成 | `pallets/affiliate-instant/src/lib.rs` | 1212-1274 |
| 分红池 | `pallets/affiliate-instant/src/lib.rs` | 1349-1356 |
| 系统费用 | `pallets/affiliate-instant/src/lib.rs` | 1359-1407 |

---

## ✅ 总结

### 核心差异

1. **会员购买**：100%推荐链，走联盟托管，有分成机制
2. **供奉购买**：100%目标账户，直接转账，**无分成机制** ❌

### 主要问题

1. ❌ 供奉购买没有触发推荐链分成
2. ❌ 没有销毁/国库/存储费机制
3. ❌ 没有持币分红系统
4. ❌ 两种购买逻辑完全不一致

### 推荐方案

**立即实施方案9三合一模式：**
- ✅ 统一会员和供奉的资金流
- ✅ 引入推荐链分成（60-75%）
- ✅ 引入持币分红（10-15%）
- ✅ 引入系统费用（销毁+国库+存储）
- ✅ 保留目标账户收入（供奉25%）

**预期效果：**
- 推广积极性：+80%（供奉也有推荐收益）
- 持币意愿：+80%（分红激励）
- 系统通缩：3-5%/年（销毁机制）
- 生态平衡：推荐+目标+平台三方共赢

---

**版本：** v1.0.0  
**分析日期：** 2025-10-22  
**分析者：** Stardust Team  
**许可证：** Apache-2.0

