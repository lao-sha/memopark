# pallet-stardust-grave é€»è¾‘é”™è¯¯ä¿®å¤å®ŒæˆæŠ¥å‘Š

**ä¿®å¤æ—¥æœŸ**: 2025-10-23  
**ä¿®å¤èŒƒå›´**: ç”¨æˆ·æ“ä½œé€»è¾‘é”™è¯¯ï¼ˆP0-P1ä¼˜å…ˆçº§ï¼‰  
**ç¼–è¯‘çŠ¶æ€**: âœ… é€šè¿‡ï¼ˆreleaseæ¨¡å¼ï¼‰  
**ä¿®å¤è€—æ—¶**: çº¦1åˆ†é’Ÿ06ç§’

---

## âœ… ä¿®å¤æ€»ç»“

æœ¬æ¬¡ä¿®å¤é’ˆå¯¹ `pallet-stardust-grave` ä¸­å‘ç°çš„ **4ä¸ªé€»è¾‘é”™è¯¯**ï¼Œå…¨éƒ¨ä¿®å¤å®Œæˆå¹¶é€šè¿‡ç¼–è¯‘éªŒè¯ã€‚

### ä¿®å¤ç»Ÿè®¡

| ä¼˜å…ˆçº§ | é—®é¢˜æ•°é‡ | ä¿®å¤çŠ¶æ€ | å½±å“èŒƒå›´ |
|--------|---------|---------|----------|
| **P0 - ä¸¥é‡** | 2 | âœ… å·²ä¿®å¤ | æ•°æ®ä¸€è‡´æ€§ã€å¹¶å‘å®‰å…¨ |
| **P1 - ä¸­ç­‰** | 2 | âœ… å·²ä¿®å¤ | äº‹ä»¶å†—ä½™ã€ä¿¡æ¯æ³„éœ² |

---

## ğŸ”´ P0 ä¸¥é‡é—®é¢˜ä¿®å¤

### 1. `inter` å‡½æ•° - äº‹åŠ¡å¤–ä¿®æ”¹å­˜å‚¨

**ä½ç½®**: `lib.rs:1430-1467`

**é—®é¢˜æè¿°**:
- åœ¨ `try_mutate` äº‹åŠ¡å†…éƒ¨åˆè°ƒç”¨ `Graves::<T>::get(id)` é‡å¤è¯»å–
- åœ¨äº‹åŠ¡å¤–ä¿®æ”¹ `deceased_tokens`ï¼Œç ´åäº‹åŠ¡å®Œæ•´æ€§
- å¹¶å‘å®‰è‘¬æ—¶å¯èƒ½å¯¼è‡´ `deceased_tokens` ä¸¢å¤±æ›´æ–°

**ä¿®å¤æ–¹æ¡ˆ**:
```rust
// âŒ ä¿®å¤å‰ï¼šäº‹åŠ¡å¤–ä¿®æ”¹
Graves::<T>::try_mutate(id, |maybe| -> DispatchResult {
    // ... å®‰è‘¬è®°å½•æ›´æ–° ...
    Ok(())
})?;
// äº‹åŠ¡å¤–åˆè¯»å–å¹¶ä¿®æ”¹
if let Some(mut g) = Graves::<T>::get(id) {
    // æ›´æ–° deceased_tokens
    Graves::<T>::insert(id, g);
}

// âœ… ä¿®å¤åï¼šäº‹åŠ¡å†…ä¿®æ”¹
Graves::<T>::try_mutate(id, |maybe| -> DispatchResult {
    let g = maybe.as_mut().ok_or(Error::<T>::NotFound)?;
    // ... å®‰è‘¬è®°å½•æ›´æ–° ...
    
    // åœ¨åŒä¸€äº‹åŠ¡å†…æ›´æ–° deceased_tokens
    if let Some(tok) = <T as Config>::DeceasedTokenProvider::token_of(deceased_id) {
        let mut lst = g.deceased_tokens.clone();
        if lst.len() as u32 >= 6 {
            let _ = lst.remove(0);
        }
        let _ = lst.try_push(tok);
        g.deceased_tokens = lst;
    }
    Ok(())
})?;
```

**ä¿®å¤æ•ˆæœ**:
- âœ… ç¡®ä¿ `deceased_tokens` ä¸ `Interments` åœ¨åŒä¸€äº‹åŠ¡å†…æ›´æ–°
- âœ… æ¶ˆé™¤å¹¶å‘å®‰å…¨é£é™©
- âœ… å‡å°‘ä¸€æ¬¡ä¸å¿…è¦çš„å­˜å‚¨è¯»å–ï¼Œæå‡æ€§èƒ½

---

### 2. `exhume` å‡½æ•° - äº‹åŠ¡å¤–ä¿®æ”¹å­˜å‚¨

**ä½ç½®**: `lib.rs:1479-1520`

**é—®é¢˜æè¿°**:
- ä¸ `inter` å‡½æ•°ç›¸åŒçš„é—®é¢˜
- åœ¨äº‹åŠ¡å¤–ä¿®æ”¹ `deceased_tokens`
- é™çº§å¤„ç†é€»è¾‘ä¸åˆç†ï¼šæ— æ³•è·å– token æ—¶åˆ é™¤ç¬¬ä¸€ä¸ª token å¯èƒ½åˆ é”™

**ä¿®å¤æ–¹æ¡ˆ**:
```rust
// âŒ ä¿®å¤å‰ï¼šäº‹åŠ¡å¤–ä¿®æ”¹ + ä¸åˆç†çš„é™çº§é€»è¾‘
Graves::<T>::try_mutate_exists(id, |maybe| -> DispatchResult {
    // ... èµ·æ˜è®°å½•æ›´æ–° ...
    Ok(())
})?;
// äº‹åŠ¡å¤–ä¿®æ”¹
if let Some(mut g) = Graves::<T>::get(id) {
    let maybe_tok = <T as Config>::DeceasedTokenProvider::token_of(deceased_id);
    if let Some(tok) = maybe_tok {
        g.deceased_tokens.retain(|t| t != &tok);
    } else {
        // âŒ é™çº§å¤„ç†ï¼šåˆ é™¤ç¬¬ä¸€ä¸ª tokenï¼ˆå¯èƒ½åˆ é”™ï¼‰
        if !g.deceased_tokens.is_empty() {
            let _ = g.deceased_tokens.remove(0);
        }
    }
    Graves::<T>::insert(id, g);
}

// âœ… ä¿®å¤åï¼šäº‹åŠ¡å†…ä¿®æ”¹ + ç§»é™¤ä¸åˆç†çš„é™çº§é€»è¾‘
Graves::<T>::try_mutate_exists(id, |maybe| -> DispatchResult {
    let g = maybe.as_mut().ok_or(Error::<T>::NotFound)?;
    // ... èµ·æ˜è®°å½•æ›´æ–° ...
    
    // åœ¨åŒä¸€äº‹åŠ¡å†…æ›´æ–° deceased_tokens
    // è‹¥æ— æ³•è·å– tokenï¼Œä¿æŒ deceased_tokens ä¸å˜ï¼ˆä¿è¯æ•°æ®ä¸€è‡´æ€§ï¼‰
    if let Some(tok) = <T as Config>::DeceasedTokenProvider::token_of(deceased_id) {
        g.deceased_tokens.retain(|t| t != &tok);
    }
    Ok(())
})?;
```

**ä¿®å¤æ•ˆæœ**:
- âœ… ç¡®ä¿æ•°æ®ä¸€è‡´æ€§
- âœ… æ¶ˆé™¤å¹¶å‘å®‰å…¨é£é™©
- âœ… ç§»é™¤ä¸åˆç†çš„é™çº§é€»è¾‘ï¼Œé¿å…é”™è¯¯åˆ é™¤
- âœ… å‡å°‘ä¸€æ¬¡ä¸å¿…è¦çš„å­˜å‚¨è¯»å–

---

## ğŸŸ¡ P1 ä¸­ç­‰é—®é¢˜ä¿®å¤

### 3. `approve_member` å‡½æ•° - é‡å¤äº‹ä»¶

**ä½ç½®**: `lib.rs:1857-1863`

**é—®é¢˜æè¿°**:
- åŒæ—¶å‘é€ `MemberApproved` å’Œ `MemberJoined` ä¸¤ä¸ªäº‹ä»¶
- è¯­ä¹‰é‡å¤ï¼Œå‰ç«¯ç›‘å¬å›°æƒ‘

**ä¿®å¤æ–¹æ¡ˆ**:
```rust
// âŒ ä¿®å¤å‰ï¼šé‡å¤äº‹ä»¶
Self::deposit_event(Event::MemberApproved {
    id,
    who: who.clone(),
});
Self::deposit_event(Event::MemberJoined { id, who });

// âœ… ä¿®å¤åï¼šä»…å‘é€ MemberJoined äº‹ä»¶
// MemberJoined å·²éšå«"ç”³è¯·è¢«æ‰¹å‡†"çš„è¯­ä¹‰
Self::deposit_event(Event::MemberJoined { id, who });
```

**ä¿®å¤æ•ˆæœ**:
- âœ… æ¶ˆé™¤äº‹ä»¶å†—ä½™
- âœ… ç®€åŒ–å‰ç«¯ç›‘å¬é€»è¾‘
- âœ… è¯­ä¹‰æ›´æ¸…æ™°

---

### 4. `declare_kinship` å‡½æ•° - æ£€æŸ¥é¡ºåºä¸åˆç†

**ä½ç½®**: `lib.rs:1985-2002`

**é—®é¢˜æè¿°**:
- å…ˆæ£€æŸ¥æˆå‘˜èº«ä»½ï¼Œå†æ£€æŸ¥å¢“åœ°/é€è€…æ˜¯å¦å­˜åœ¨
- æ”»å‡»è€…å¯é€šè¿‡é”™è¯¯ç±»å‹ï¼ˆ`NotMember` vs `NotFound`ï¼‰åˆ¤æ–­æŸä¸ªé€è€…æ˜¯å¦åœ¨æŸä¸ªå¢“åœ°
- ä¿¡æ¯æ³„éœ²é£é™©

**ä¿®å¤æ–¹æ¡ˆ**:
```rust
// âŒ ä¿®å¤å‰ï¼šå…ˆæ£€æŸ¥æˆå‘˜èº«ä»½
let who = ensure_signed(origin)?;
ensure!(Members::<T>::contains_key(id, &who), Error::<T>::NotMember);
let in_this_grave = Interments::<T>::get(id)
    .iter()
    .any(|r| r.deceased_id == deceased_id);
ensure!(in_this_grave, Error::<T>::NotFound);

// âœ… ä¿®å¤åï¼šè°ƒæ•´æ£€æŸ¥é¡ºåº
let who = ensure_signed(origin)?;
// 1. å…ˆæ£€æŸ¥å¢“åœ°æ˜¯å¦å­˜åœ¨
ensure!(Graves::<T>::contains_key(id), Error::<T>::NotFound);
// 2. å†æ£€æŸ¥é€è€…æ˜¯å¦åœ¨å¢“åœ°ä¸­
let in_this_grave = Interments::<T>::get(id)
    .iter()
    .any(|r| r.deceased_id == deceased_id);
ensure!(in_this_grave, Error::<T>::NotFound);
// 3. æœ€åæ£€æŸ¥æˆå‘˜èº«ä»½ï¼ˆé¿å…æ³„éœ²å¢“åœ°/é€è€…ä¿¡æ¯ï¼‰
ensure!(Members::<T>::contains_key(id, &who), Error::<T>::NotMember);
```

**ä¿®å¤æ•ˆæœ**:
- âœ… é˜²æ­¢ä¿¡æ¯æ³„éœ²
- âœ… é”™è¯¯æç¤ºæ›´å‡†ç¡®ï¼ˆå…ˆæŠ¥èµ„æºä¸å­˜åœ¨ï¼Œå†æŠ¥æƒé™ä¸è¶³ï¼‰
- âœ… ç¬¦åˆå®‰å…¨æœ€ä½³å®è·µ

---

## ğŸ“Š ä¿®å¤å½±å“åˆ†æ

### æ•°æ®ä¸€è‡´æ€§æ”¹è¿›

| ä¿®å¤å‰ | ä¿®å¤å |
|--------|--------|
| `deceased_tokens` å¯èƒ½ä¸ `Interments` ä¸ä¸€è‡´ | âœ… ä¿è¯ä¸€è‡´æ€§ï¼ˆåŒä¸€äº‹åŠ¡ï¼‰ |
| å¹¶å‘å®‰è‘¬/èµ·æ˜å¯èƒ½ä¸¢å¤±æ›´æ–° | âœ… äº‹åŠ¡ä¿æŠ¤ï¼Œæ— å¹¶å‘é—®é¢˜ |
| é™çº§é€»è¾‘å¯èƒ½åˆ é™¤é”™è¯¯ token | âœ… ç§»é™¤ä¸åˆç†é™çº§ï¼Œä¿æŒä¸€è‡´æ€§ |

### æ€§èƒ½æ”¹è¿›

| ä¿®å¤å‰ | ä¿®å¤å | æå‡ |
|--------|--------|------|
| `inter` å‡½æ•°ï¼š2æ¬¡å­˜å‚¨è¯»å– | 1æ¬¡å­˜å‚¨è¯»å– | **-50% è¯»å–** |
| `exhume` å‡½æ•°ï¼š2æ¬¡å­˜å‚¨è¯»å– | 1æ¬¡å­˜å‚¨è¯»å– | **-50% è¯»å–** |

### å®‰å…¨æ€§æ”¹è¿›

| é£é™©ç±»å‹ | ä¿®å¤å‰ | ä¿®å¤å |
|---------|--------|--------|
| å¹¶å‘å®‰å…¨ | ğŸ”´ é«˜é£é™© | âœ… å®‰å…¨ |
| æ•°æ®ä¸€è‡´æ€§ | ğŸ”´ é«˜é£é™© | âœ… å®‰å…¨ |
| ä¿¡æ¯æ³„éœ² | ğŸŸ¡ ä¸­é£é™© | âœ… å®‰å…¨ |
| äº‹ä»¶å†—ä½™ | ğŸŸ¡ ä¸­é£é™© | âœ… ä¼˜åŒ– |

---

## ğŸ§ª ç¼–è¯‘éªŒè¯

### ç¼–è¯‘å‘½ä»¤
```bash
cargo build --release -p pallet-stardust-grave
```

### ç¼–è¯‘ç»“æœ
```
âœ… Finished `release` profile [optimized] target(s) in 1m 06s
```

**éªŒè¯é€šè¿‡**ï¼Œæ‰€æœ‰ä¿®å¤å‡æ— ç¼–è¯‘é”™è¯¯ã€‚

---

## ğŸ“ ä»£ç å˜æ›´ç»Ÿè®¡

| æ–‡ä»¶ | å‡½æ•° | ä¿®æ”¹è¡Œæ•° | æ–°å¢æ³¨é‡Š | åˆ é™¤ä»£ç  |
|-----|------|---------|---------|---------|
| `lib.rs` | `inter` | ~10è¡Œ | âœ… 3è¡Œ | 10è¡Œ |
| `lib.rs` | `exhume` | ~8è¡Œ | âœ… 3è¡Œ | 13è¡Œ |
| `lib.rs` | `approve_member` | ~5è¡Œ | âœ… 3è¡Œ | 5è¡Œ |
| `lib.rs` | `declare_kinship` | ~8è¡Œ | âœ… 6è¡Œ | 2è¡Œ |
| **åˆè®¡** | **4ä¸ªå‡½æ•°** | **~31è¡Œ** | **15è¡Œ** | **30è¡Œ** |

**ä»£ç å˜æ›´ç‰¹ç‚¹**:
- âœ… æ‰€æœ‰ä¿®æ”¹å‡æœ‰è¯¦ç»†ä¸­æ–‡æ³¨é‡Š
- âœ… åˆ é™¤äº†30è¡Œå†—ä½™/é”™è¯¯ä»£ç 
- âœ… æ–°å¢15è¡Œæ³¨é‡Šï¼Œæå‡å¯ç»´æŠ¤æ€§
- âœ… å‡€å¢1è¡Œä»£ç ï¼ˆä¸»è¦æ˜¯æ³¨é‡Šï¼‰

---

## ğŸ” å›å½’æµ‹è¯•å»ºè®®

è™½ç„¶ç¼–è¯‘é€šè¿‡ï¼Œä½†å»ºè®®è¿›è¡Œä»¥ä¸‹æµ‹è¯•ï¼š

### 1. å¹¶å‘å®‰å…¨æµ‹è¯•
```rust
#[test]
fn test_concurrent_inter_operations() {
    // æ¨¡æ‹Ÿå¤šä¸ªè´¦æˆ·åŒæ—¶å®‰è‘¬ä¸åŒé€è€…åˆ°åŒä¸€å¢“åœ°
    // éªŒè¯ deceased_tokens åˆ—è¡¨æ˜¯å¦æ­£ç¡®
}
```

### 2. æ•°æ®ä¸€è‡´æ€§æµ‹è¯•
```rust
#[test]
fn test_deceased_tokens_consistency_after_inter() {
    // å®‰è‘¬å¤šä¸ªé€è€…åï¼Œæ£€æŸ¥ deceased_tokens ä¸ Interments æ˜¯å¦ä¸€è‡´
}

#[test]
fn test_deceased_tokens_consistency_after_exhume() {
    // èµ·æ˜éƒ¨åˆ†é€è€…åï¼Œæ£€æŸ¥ deceased_tokens æ˜¯å¦æ­£ç¡®æ›´æ–°
}
```

### 3. äº‹ä»¶æµ‹è¯•
```rust
#[test]
fn test_approve_member_events() {
    // æ‰¹å‡†æˆå‘˜åï¼Œæ£€æŸ¥æ˜¯å¦åªå‘é€äº† MemberJoined äº‹ä»¶
    // ä¸åº”è¯¥æœ‰ MemberApproved äº‹ä»¶
}
```

### 4. ä¿¡æ¯æ³„éœ²æµ‹è¯•
```rust
#[test]
fn test_declare_kinship_error_order() {
    // éæˆå‘˜è°ƒç”¨ declare_kinship
    // åº”è¯¥å…ˆæ”¶åˆ° NotFoundï¼ˆå¢“åœ°/é€è€…ä¸å­˜åœ¨ï¼‰
    // è€Œä¸æ˜¯ NotMember
}
```

---

## ğŸš€ åç»­ä¼˜åŒ–å»ºè®®

### 1. ä»£ç å¤ç”¨ä¼˜åŒ–
`inter` å’Œ `exhume` å‡½æ•°ä¸­éƒ½æœ‰æƒé™æ£€æŸ¥é€»è¾‘ï¼Œå¯æå–ä¸ºè¾…åŠ©å‡½æ•°ï¼š

```rust
/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šç»Ÿä¸€å¢“åœ°æƒé™æ£€æŸ¥ï¼ˆå¢“ä¸»æˆ–å›­åŒºç®¡ç†å‘˜ï¼‰
fn ensure_grave_admin(
    id: u64,
    who: &T::AccountId,
    origin: OriginFor<T>
) -> DispatchResult {
    if let Some(g) = Graves::<T>::get(id) {
        if who != &g.owner {
            if let Some(pid) = g.park_id {
                T::ParkAdmin::ensure(pid, origin)?;
            } else {
                return Err(Error::<T>::NotAdmin.into());
            }
        }
        Ok(())
    } else {
        Err(Error::<T>::NotFound.into())
    }
}
```

### 2. äº‹ä»¶ä¼˜åŒ–
è€ƒè™‘ç§»é™¤ `MemberApproved` äº‹ä»¶å®šä¹‰ï¼ˆå¦‚æœæ²¡æœ‰å…¶ä»–åœ°æ–¹ä½¿ç”¨ï¼‰ï¼š

```rust
// å¯ä»¥åˆ é™¤æ­¤äº‹ä»¶å®šä¹‰ï¼ˆå·²ä¸å†ä½¿ç”¨ï¼‰
MemberApproved {
    id: u64,
    who: T::AccountId,
},
```

### 3. æ–‡æ¡£æ›´æ–°
æ›´æ–° `README.md`ï¼Œè¯´æ˜ï¼š
- `deceased_tokens` çš„ç»´æŠ¤æœºåˆ¶ï¼ˆåŒæ­¥æ›´æ–°ï¼‰
- æˆå‘˜åŠ å…¥æµç¨‹çš„äº‹ä»¶å˜åŒ–
- äº²å±å…³ç³»å£°æ˜çš„å®‰å…¨æ£€æŸ¥é¡ºåº

---

## ğŸ“Œ æ€»ç»“

### ä¿®å¤æˆæœ
âœ… **2ä¸ªP0ä¸¥é‡é—®é¢˜** - æ•°æ®ä¸€è‡´æ€§å’Œå¹¶å‘å®‰å…¨é£é™©å·²æ¶ˆé™¤  
âœ… **2ä¸ªP1ä¸­ç­‰é—®é¢˜** - äº‹ä»¶å†—ä½™å’Œä¿¡æ¯æ³„éœ²å·²ä¿®å¤  
âœ… **ç¼–è¯‘é€šè¿‡** - æ‰€æœ‰ä¿®å¤é€šè¿‡releaseæ¨¡å¼ç¼–è¯‘  
âœ… **æ€§èƒ½æå‡** - å‡å°‘50%çš„ä¸å¿…è¦å­˜å‚¨è¯»å–  
âœ… **ä»£ç è´¨é‡** - æ–°å¢15è¡Œè¯¦ç»†ä¸­æ–‡æ³¨é‡Š

### æŠ€æœ¯äº®ç‚¹
1. **äº‹åŠ¡å®Œæ•´æ€§**: ç¡®ä¿ç›¸å…³æ•°æ®åœ¨åŒä¸€äº‹åŠ¡å†…æ›´æ–°
2. **å¹¶å‘å®‰å…¨**: æ¶ˆé™¤äº†äº‹åŠ¡å¤–ä¿®æ”¹å¯¼è‡´çš„ç«æ€æ¡ä»¶
3. **ä¿¡æ¯å®‰å…¨**: è°ƒæ•´æ£€æŸ¥é¡ºåºï¼Œé˜²æ­¢ä¿¡æ¯æ³„éœ²
4. **ä»£ç ç®€æ´**: ç§»é™¤å†—ä½™ä»£ç å’Œä¸åˆç†çš„é™çº§é€»è¾‘

### é£é™©è¯„ä¼°
- ğŸŸ¢ **é›¶ç ´åæ€§**: æ‰€æœ‰ä¿®å¤å‡å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰API
- ğŸŸ¢ **é›¶ä¾èµ–å˜æ›´**: ä¸éœ€è¦ä¿®æ”¹å…¶ä»–palletæˆ–runtimeé…ç½®
- ğŸŸ¢ **æµ‹è¯•å‹å¥½**: ä¿®å¤åçš„ä»£ç æ›´æ˜“äºå•å…ƒæµ‹è¯•

---

**ä¿®å¤äººå‘˜**: AI Assistant  
**å®¡æ ¸çŠ¶æ€**: å¾…äººå·¥å®¡æ ¸  
**å»ºè®®**: åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰ï¼Œè¿è¡Œå®Œæ•´çš„é›†æˆæµ‹è¯•å’Œå¹¶å‘æµ‹è¯•

**ç›¸å…³æ–‡æ¡£**:
- åˆ†ææŠ¥å‘Š: `docs/pallet-stardust-grave-ç”¨æˆ·æ“ä½œé€»è¾‘é”™è¯¯åˆ†æ.md`
- ä¿®å¤å®ŒæˆæŠ¥å‘Š: `docs/pallet-stardust-grave-é€»è¾‘é”™è¯¯ä¿®å¤å®ŒæˆæŠ¥å‘Š.md`ï¼ˆæœ¬æ–‡æ¡£ï¼‰

