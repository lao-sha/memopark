# 祭祀品订阅模式修改完成报告

## 修改概述

**修改日期**: 2025-01-15

**修改内容**: 祭祀品（memorial pallet）只支持按周订阅，删除按月订阅相关代码

**状态**: ✅ 已完成，编译验证通过

---

## 一、修改背景

### 业务需求

用户要求祭祀品订阅服务**仅支持按周订阅**，不再提供按月订阅选项。

### 涉及模块

- **pallet-memorial** (纪念馆/祭祀品管理)
- **PricingModel::Subscription** (订阅定价模型)

---

## 二、代码修改详情

### 2.1 文件1: `pallets/memorial/src/types.rs`

#### 修改1: PricingModel::Subscription枚举定义

**修改位置**: Line 208-220

**修改前**:
```rust
/// 订阅模式（如长期供奉服务）
Subscription {
    /// 按月订阅价格（比按周更符合用户习惯）
    monthly_price: u128,
    /// 最少订阅月数
    min_months: u32,
    /// 最多订阅月数（None表示无限制）
    max_months: Option<u32>,
    /// 是否支持自动续费
    auto_renew: bool,
    /// 提前终止的退款比例（0-100）
    refund_rate: u8,
},
```

**修改后**:
```rust
/// 订阅模式（如长期供奉服务）- 仅支持按周订阅
Subscription {
    /// 按周订阅价格
    weekly_price: u128,
    /// 最少订阅周数
    min_weeks: u32,
    /// 最多订阅周数（None表示无限制）
    max_weeks: Option<u32>,
    /// 是否支持自动续费
    auto_renew: bool,
    /// 提前终止的退款比例（0-100）
    refund_rate: u8,
},
```

**变更说明**:
- `monthly_price` → `weekly_price`
- `min_months` → `min_weeks`
- `max_months` → `max_weeks`
- 注释更新为"仅支持按周订阅"

---

#### 修改2: get_price_for_user方法

**修改位置**: Line 348

**修改前**:
```rust
PricingModel::Subscription { monthly_price, .. } => Some(*monthly_price),
```

**修改后**:
```rust
PricingModel::Subscription { weekly_price, .. } => Some(*weekly_price),
```

**变更说明**: 匹配模式从`monthly_price`改为`weekly_price`

---

### 2.2 文件2: `pallets/memorial/README.md`

#### 修改: 定价模式文档

**修改位置**: Line 248

**修改前**:
```rust
Subscription(u128, u32),        // 订阅定价（价格，周期）
```

**修改后**:
```rust
Subscription(u128, u32),        // 订阅定价（按周价格，订阅周数）
```

**变更说明**: 明确订阅定价是"按周价格"和"订阅周数"

---

## 三、修改影响分析

### 3.1 链端影响

| 模块 | 影响范围 | 影响描述 |
|------|---------|---------|
| pallet-memorial | ✅ 已修改 | PricingModel::Subscription定义更新 |
| 其他pallet | ❌ 无影响 | 无其他pallet直接依赖该字段 |

---

### 3.2 前端影响

**搜索结果**: ❌ 无影响

前端代码（stardust-dapp）中**没有直接使用**`monthly_price`、`按月订阅`、`月订阅`等字符串。

**前端适配建议**:
如果前端有订阅UI，需要更新：
- 订阅周期选择从"月"改为"周"
- 价格显示从"XXX DUST/月"改为"XXX DUST/周"
- 订阅时长输入从"订阅X个月"改为"订阅X周"

---

### 3.3 数据库影响

**存储结构**: `PricingModel`是链上枚举，使用SCALE编码

**兼容性分析**:
- ⚠️ **不兼容**: Subscription枚举的字段名变更，SCALE编码结构相同但语义不同
- ⚠️ **需要迁移**: 已有的订阅数据需要手动迁移

**迁移建议**:
如果链上已有使用`monthly_price`的订阅数据：
1. 需要通过治理提案批量迁移
2. 或者在`on_runtime_upgrade`中自动转换（1个月 ≈ 4周）

---

## 四、编译验证

### 4.1 pallet-memorial编译

**命令**: `cargo check -p pallet-memorial`

**结果**: ✅ 通过

```
Checking pallet-memorial v0.1.0
Finished `dev` profile [unoptimized + debuginfo] target(s) in 3.22s
```

---

### 4.2 pallet-memorial测试

**命令**: `cargo test -p pallet-memorial --lib`

**结果**: ✅ 通过（0个测试）

```
running 0 tests
test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out
```

**说明**: 该pallet目前没有单元测试

---

### 4.3 整个workspace编译

**命令**: `cargo check --workspace`

**结果**: ✅ 通过（1分12秒）

```
Finished `dev` profile [unoptimized + debuginfo] target(s) in 1m 12s
warning: the following packages contain code that will be rejected by a future version of Rust: trie-db v0.30.0
```

**说明**: 所有依赖pallet均编译成功，无错误

---

## 五、修改清单

### 5.1 修改的文件

| 文件 | 修改行数 | 修改内容 |
|------|---------|---------|
| pallets/memorial/src/types.rs | Line 208-220 | Subscription枚举定义 |
| pallets/memorial/src/types.rs | Line 348 | get_price_for_user方法 |
| pallets/memorial/README.md | Line 248 | 定价模式文档 |

**总计**: 3处修改，涉及2个文件

---

### 5.2 删除的内容

| 原字段/注释 | 新字段/注释 |
|-----------|-----------|
| `monthly_price: u128` | `weekly_price: u128` |
| `/// 按月订阅价格（比按周更符合用户习惯）` | `/// 按周订阅价格` |
| `min_months: u32` | `min_weeks: u32` |
| `/// 最少订阅月数` | `/// 最少订阅周数` |
| `max_months: Option<u32>` | `max_weeks: Option<u32>` |
| `/// 最多订阅月数（None表示无限制）` | `/// 最多订阅周数（None表示无限制）` |
| `订阅定价（价格，周期）` | `订阅定价（按周价格，订阅周数）` |

---

## 六、技术细节

### 6.1 SCALE编码兼容性

**枚举变体**: `PricingModel::Subscription`

**SCALE编码结构**（修改前后）:
```
修改前: enum_index(1) + monthly_price(u128) + min_months(u32) + max_months(Option<u32>) + auto_renew(bool) + refund_rate(u8)
修改后: enum_index(1) + weekly_price(u128) + min_weeks(u32) + max_weeks(Option<u32>) + auto_renew(bool) + refund_rate(u8)
```

**结论**: 编码结构相同，但语义不同（monthly → weekly）

---

### 6.2 数据迁移考虑

如果链上已有订阅数据，需要考虑迁移策略：

#### 方案1: 治理提案批量修改

```rust
// 伪代码
for each existing_subscription in OfferingItems {
    if let PricingModel::Subscription { monthly_price, min_months, max_months, .. } = existing_subscription.pricing.model {
        // 1个月 ≈ 4周
        let weekly_price = monthly_price / 4;
        let min_weeks = min_months * 4;
        let max_weeks = max_months.map(|m| m * 4);

        // 更新存储
        update_subscription(weekly_price, min_weeks, max_weeks);
    }
}
```

---

#### 方案2: Runtime升级钩子

```rust
#[pallet::hooks]
impl<T: Config> Hooks<BlockNumberFor<T>> for Pallet<T> {
    fn on_runtime_upgrade() -> Weight {
        // 迁移逻辑
        migrate_monthly_to_weekly();
        Weight::from_parts(10_000, 0)
    }
}
```

---

## 七、后续工作建议

### 7.1 前端适配（高优先级）

**任务清单**:
- [ ] 更新供奉品创建表单：订阅周期选择改为"周"
- [ ] 更新价格显示：从"XXX/月"改为"XXX/周"
- [ ] 更新订阅时长输入：从"订阅X个月"改为"订阅X周"
- [ ] 更新用户订阅管理界面
- [ ] 更新订阅续费提醒逻辑

---

### 7.2 数据迁移（如果有现存数据）

**任务清单**:
- [ ] 检查链上是否有现存的Subscription类型供奉品
- [ ] 如有，制定迁移策略（治理提案或runtime升级）
- [ ] 执行数据迁移
- [ ] 验证迁移结果

---

### 7.3 文档更新

**任务清单**:
- [x] 更新pallet README.md（已完成）
- [ ] 更新API文档
- [ ] 更新用户使用手册
- [ ] 更新运营SOP

---

### 7.4 测试补充

**建议增加测试**:
```rust
#[test]
fn test_subscription_weekly_pricing() {
    // 测试按周订阅定价计算
    let offering = create_test_offering_subscription(
        weekly_price: 100_000, // 100 DUST/周
        min_weeks: 4,          // 最少4周
        max_weeks: Some(52),   // 最多52周
    );

    // 订阅4周
    let total = offering.calculate_subscription_cost(4);
    assert_eq!(total, 400_000); // 4周 × 100 DUST
}

#[test]
fn test_subscription_auto_renew() {
    // 测试自动续费逻辑
}
```

---

## 八、风险评估

| 风险 | 级别 | 说明 | 缓解措施 |
|------|------|------|---------|
| 数据不兼容 | ⚠️ 中 | 现存月订阅数据需迁移 | 执行数据迁移脚本 |
| 前端未同步 | ⚠️ 中 | 前端可能仍显示"按月" | 前端代码同步更新 |
| 用户混淆 | ⚠️ 低 | 用户可能不理解改为按周 | 更新用户通知和帮助文档 |
| SCALE编码 | ✅ 低 | 编码结构未变 | 无风险 |

---

## 九、总结

### 9.1 完成情况

✅ **代码修改**: 3处修改全部完成

✅ **编译验证**: pallet-memorial + workspace编译通过

✅ **文档更新**: README.md已更新

✅ **影响分析**: 已确认前端无直接依赖

---

### 9.2 后续建议

**立即执行**:
1. 前端同步更新订阅UI
2. 检查链上现存订阅数据

**短期内执行**:
1. 如有现存数据，执行迁移
2. 补充单元测试

**长期维护**:
1. 更新API文档和用户手册
2. 监控用户反馈

---

**修改人**: Substrate开发团队

**审核状态**: ✅ 编译通过，待前端适配

**文档版本**: v1.0

---

## 附录A：修改命令

```bash
# 1. 检查pallet编译
cargo check -p pallet-memorial

# 2. 运行测试
cargo test -p pallet-memorial --lib

# 3. 检查整个workspace
cargo check --workspace

# 4. 搜索相关引用
grep -r "monthly_price" pallets/memorial/
grep -r "按月订阅" stardust-dapp/
```

---

## 附录B：字段映射表

| 原字段（月） | 新字段（周） | 转换关系 |
|-----------|-----------|---------|
| monthly_price | weekly_price | weekly = monthly / 4 |
| min_months | min_weeks | weeks = months × 4 |
| max_months | max_weeks | weeks = months × 4 |

**示例**:
- 月订阅价格 1000 DUST → 周订阅价格 250 DUST
- 最少订阅3个月 → 最少订阅12周
- 最多订阅12个月 → 最多订阅48周

---

**END OF REPORT**
