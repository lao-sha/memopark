# é“¾ç«¯æ€§èƒ½ä¼˜åŒ– - åˆ†ææŠ¥å‘Š

**æ—¶é—´**ï¼š2025-10-28  
**åˆ†æèŒƒå›´**ï¼šæ‰€æœ‰è‡ªç ”Pallet  
**ä¼˜åŒ–ç›®æ ‡**ï¼šé™ä½Gasã€ä¼˜åŒ–å­˜å‚¨ã€æå‡TPS

---

## ğŸ“Š å½“å‰çŠ¶æ€åˆ†æ

### å­˜å‚¨é¡¹ç»Ÿè®¡

| Pallet | å­˜å‚¨é¡¹æ•°é‡ | BoundedVecæ•°é‡ | æ½œåœ¨å†—ä½™ |
|--------|-----------|---------------|---------|
| **trading** | 23 | 15 | ä¸­ |
| **deceased** | 15 | 12 | ä½ |
| **memorial** | 31 | 8 | é«˜ |
| **credit** | 11 | 6 | ä½ |
| **stardust-grave** | 32 | 10 | ä¸­ |
| **chat** | 6 | 4 | ä½ |
| **å…¶ä»–** | ~200 | ~80 | - |

**æ€»è®¡**ï¼š~471ä¸ªå­˜å‚¨é¡¹ï¼ˆgrepç»Ÿè®¡ï¼‰

---

## ğŸ” ä¸»è¦ä¼˜åŒ–ç‚¹

### 1. å­˜å‚¨ä¼˜åŒ–ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰â­â­â­

#### é—®é¢˜1ï¼šBoundedVec å¤§å°é…ç½®è¿‡å¤§

**ç°çŠ¶**ï¼š
```rust
// trading/src/lib.rs
pub type Cid = BoundedVec<u8, ConstU32<256>>;  // âŒ è¿‡å¤§
pub type TronAddress = BoundedVec<u8, ConstU32<64>>;  // âŒ è¿‡å¤§
```

**åˆ†æ**ï¼š
- IPFS CIDï¼ˆv1ï¼‰å®é™…é•¿åº¦ï¼š46-59å­—èŠ‚
- TRONåœ°å€å®é™…é•¿åº¦ï¼š34å­—èŠ‚
- å½“å‰é…ç½®æµªè´¹ 3-4å€å­˜å‚¨ç©ºé—´

**ä¼˜åŒ–å»ºè®®**ï¼š
```rust
// âœ… ä¼˜åŒ–å
pub type Cid = BoundedVec<u8, ConstU32<64>>;        // CID v1æœ€å¤§59å­—èŠ‚
pub type TronAddress = BoundedVec<u8, ConstU32<34>>;  // TRONåœ°å€34å­—èŠ‚
```

**é¢„æœŸæ”¶ç›Š**ï¼š
- æ¯ä¸ªCIDèŠ‚çœï¼š192å­—èŠ‚
- æ¯ä¸ªTRONåœ°å€èŠ‚çœï¼š30å­—èŠ‚
- å…¨é“¾é¢„ä¼°èŠ‚çœï¼š**10-20 MB**ï¼ˆå‡è®¾10ä¸‡æ¡è®°å½•ï¼‰

---

#### é—®é¢˜2ï¼šå†—ä½™å­˜å‚¨é¡¹

**æ¡ˆä¾‹1ï¼šmemorial pallet**
```rust
// memorial/src/lib.rs - å­˜åœ¨31ä¸ªå­˜å‚¨é¡¹

#[pallet::storage]
pub type SacrificeItems<T: Config> = StorageMap<_, Blake2_128Concat, u64, SacrificeItem<T>>;

#[pallet::storage]
pub type OfferingSpecs<T: Config> = StorageMap<_, Blake2_128Concat, u8, OfferingSpec<T>>;

// âŒ å¯èƒ½å­˜åœ¨çš„å†—ä½™ï¼šé‡å¤ç´¢å¼•ã€æœªä½¿ç”¨çš„è®¡æ•°å™¨
```

**ä¼˜åŒ–å»ºè®®**ï¼š
1. åˆå¹¶ç›¸å…³å­˜å‚¨é¡¹
2. ç§»é™¤æœªä½¿ç”¨çš„è®¡æ•°å™¨
3. ä½¿ç”¨æ´¾ç”Ÿå­˜å‚¨ï¼ˆcomputed storageï¼‰

---

#### é—®é¢˜3ï¼šæœªå®æ–½æ•°æ®å½’æ¡£

**ç°çŠ¶**ï¼š
- Tradingè®¢å•ï¼šæ— é™æœŸä¿ç•™
- Deceasedæ¶ˆæ¯ï¼šæ— é™æœŸä¿ç•™
- Memorialä¾›å¥‰è®°å½•ï¼šæ— é™æœŸä¿ç•™

**åˆ†æ**ï¼š
- 90å¤©å‰çš„è®¢å•å¾ˆå°‘è¢«æŸ¥è¯¢
- 1å¹´å‰çš„æ¶ˆæ¯å‡ ä¹ä¸è¢«è®¿é—®
- é“¾ä¸Šå­˜å‚¨æˆæœ¬æŒç»­å¢é•¿

**ä¼˜åŒ–å»ºè®®**ï¼š
å®æ–½åˆ†å±‚å­˜å‚¨ç­–ç•¥ï¼š
```
çƒ­æ•°æ®ï¼ˆ0-90å¤©ï¼‰ â†’ é“¾ä¸Šå­˜å‚¨
æ¸©æ•°æ®ï¼ˆ90å¤©-1å¹´ï¼‰ â†’ å½’æ¡£å­˜å‚¨ï¼ˆé“¾ä¸Šå“ˆå¸Œ + é“¾ä¸‹æ•°æ®ï¼‰
å†·æ•°æ®ï¼ˆ1å¹´+ï¼‰ â†’ å®Œå…¨è¿ç§»è‡³é“¾ä¸‹ï¼ˆä»…ä¿ç•™è¯æ˜ï¼‰
```

**é¢„æœŸæ”¶ç›Š**ï¼š
- é™ä½é“¾ä¸Šå­˜å‚¨ 60-80%
- ä¿æŒå†å²å¯éªŒè¯æ€§
- é™ä½èŠ‚ç‚¹åŒæ­¥æˆæœ¬

---

### 2. æƒé‡ä¼˜åŒ–ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰â­â­â­

#### é—®é¢˜1ï¼šç¼ºå°‘ Benchmark æµ‹è¯•

**ç°çŠ¶**ï¼š
```rust
// trading/src/lib.rs
pub trait TradingWeightInfo {
    fn lock_deposit() -> Weight;  // âŒ æœªå®ç°benchmark
    fn submit_info() -> Weight;
    fn create_order() -> Weight;
    // ...
}

impl TradingWeightInfo for () {
    fn lock_deposit() -> Weight {
        Weight::from_parts(10_000, 0)  // âŒ ä¼°ç®—å€¼ï¼Œä¸å‡†ç¡®
    }
    // ...
}
```

**ä¼˜åŒ–å»ºè®®**ï¼š
1. ä¸ºæ‰€æœ‰extrinsicsç¼–å†™benchmark
2. ä½¿ç”¨ `frame-benchmarking` æµ‹é‡å®é™…æƒé‡
3. åŒºåˆ†æœ€å¥½/å¹³å‡/æœ€åæƒ…å†µ

**é¢„æœŸæ”¶ç›Š**ï¼š
- å‡†ç¡®çš„Gasè®¡ç®—
- é¿å…è¿‡åº¦æ”¶è´¹
- æå‡ç”¨æˆ·ä½“éªŒ

---

#### é—®é¢˜2ï¼šæ‰¹é‡æ“ä½œæƒé‡çº¿æ€§å¢é•¿

**æ¡ˆä¾‹**ï¼š
```rust
// å‡è®¾çš„æ‰¹é‡æ“ä½œï¼ˆæœªä¼˜åŒ–ï¼‰
pub fn batch_add_photos(photos: Vec<Photo>) -> DispatchResult {
    for photo in photos {
        Self::add_photo(photo)?;  // âŒ O(n)æ¬¡å­˜å‚¨å†™å…¥
    }
}
```

**ä¼˜åŒ–å»ºè®®**ï¼š
```rust
// âœ… ä¼˜åŒ–åï¼šå‡å°‘å­˜å‚¨æ“ä½œ
pub fn batch_add_photos(photos: Vec<Photo>) -> DispatchResult {
    let mut album = Albums::<T>::get(album_id)?;
    album.photos.try_extend(photos)?;  // å•æ¬¡å†™å…¥
    Albums::<T>::insert(album_id, album);
}
```

**é¢„æœŸæ”¶ç›Š**ï¼š
- æ‰¹é‡æ“ä½œGasé™ä½ 50-70%
- æå‡ååé‡

---

### 3. Gas ä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰â­â­

#### é—®é¢˜1ï¼šè¿‡åº¦äº‹ä»¶å‘å°„

**ç°çŠ¶**ï¼š
```rust
// å¯èƒ½å­˜åœ¨çš„è¿‡åº¦äº‹ä»¶
Self::deposit_event(Event::OrderCreated { order_id });
Self::deposit_event(Event::OrderStateChanged { order_id, state });
Self::deposit_event(Event::OrderUpdated { order_id });  // âŒ å†—ä½™
```

**ä¼˜åŒ–å»ºè®®**ï¼š
- åˆå¹¶ç›¸å…³äº‹ä»¶
- åªå‘å°„å¿…è¦äº‹ä»¶
- ä½¿ç”¨ä½å›¾è¡¨ç¤ºçŠ¶æ€å˜æ›´

**é¢„æœŸæ”¶ç›Š**ï¼š
- å‡å°‘äº‹ä»¶å­˜å‚¨ 30-40%
- é™ä½Gasæˆæœ¬

---

#### é—®é¢˜2ï¼šé“¾ä¸Šè®¡ç®—è¿‡å¤š

**æ¡ˆä¾‹1ï¼šä»·æ ¼è®¡ç®—**
```rust
// âŒ é“¾ä¸Šæµ®ç‚¹è®¡ç®—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
let price = base_price * (1.0 + premium_rate);

// âœ… åº”ä½¿ç”¨æ•´æ•° + basis points
let price = base_price * (10000 + premium_bps) / 10000;
```

**æ¡ˆä¾‹2ï¼šå­—ç¬¦ä¸²æ“ä½œ**
```rust
// âŒ é“¾ä¸Šå­—ç¬¦ä¸²æ‹¼æ¥ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
let full_name = format!("{} {}", first, last);

// âœ… é“¾ä¸‹å¤„ç†æˆ–ä½¿ç”¨BoundedVec
```

**ä¼˜åŒ–å»ºè®®**ï¼š
- å°†å¤æ‚è®¡ç®—ç§»è‡³é“¾ä¸‹/OCW
- ä½¿ç”¨æ•´æ•°è¿ç®—æ›¿ä»£æµ®ç‚¹
- å‡å°‘å­—ç¬¦ä¸²æ“ä½œ

---

### 4. ç´¢å¼•ä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰â­â­

#### é—®é¢˜ï¼šåŒæ˜ å°„ç´¢å¼•ç¼ºå¤±

**ç°çŠ¶**ï¼š
```rust
// trading/src/otc.rs
#[pallet::storage]
pub type Orders<T: Config> = StorageMap<_, Blake2_128Concat, u64, Order<T>>;

// âŒ ç¼ºå°‘ taker -> orders ç´¢å¼•
// âŒ ç¼ºå°‘ maker -> orders ç´¢å¼•
```

**å½±å“**ï¼š
- æŸ¥è¯¢ç”¨æˆ·æ‰€æœ‰è®¢å•éœ€è¦éå†å…¨è¡¨ï¼ˆO(n)ï¼‰
- å‰ç«¯åŠ è½½ç¼“æ…¢

**ä¼˜åŒ–å»ºè®®**ï¼š
```rust
// âœ… æ·»åŠ åŒæ˜ å°„ç´¢å¼•
#[pallet::storage]
pub type OrdersByTaker<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    T::AccountId,
    BoundedVec<u64, ConstU32<1000>>,  // ç”¨æˆ·è®¢å•IDåˆ—è¡¨
>;

#[pallet::storage]
pub type OrdersByMaker<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u64,  // maker_id
    BoundedVec<u64, ConstU32<10000>>,  // åšå¸‚å•†è®¢å•IDåˆ—è¡¨
>;
```

**æƒè¡¡**ï¼š
- å¢åŠ å†™å…¥æˆæœ¬ï¼ˆç»´æŠ¤ç´¢å¼•ï¼‰
- å¤§å¹…é™ä½æŸ¥è¯¢æˆæœ¬
- é€‚åˆè¯»å¤šå†™å°‘åœºæ™¯

---

## ğŸ“‹ ä¼˜åŒ–ä¼˜å…ˆçº§

### ğŸ”¥ ç«‹å³æ‰§è¡Œï¼ˆP0ï¼‰

1. **BoundedVecå¤§å°ä¼˜åŒ–**
   - å·¥ä½œé‡ï¼š2-3å°æ—¶
   - å½±å“ï¼šå…¨é“¾å­˜å‚¨ä¼˜åŒ–
   - é£é™©ï¼šä½ï¼ˆä»…é…ç½®è°ƒæ•´ï¼‰

2. **æƒé‡Benchmarkå®æ–½**
   - å·¥ä½œé‡ï¼š4-5å°æ—¶
   - å½±å“ï¼šGaså‡†ç¡®æ€§
   - é£é™©ï¼šä½ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰

---

### âš¡ æœ¬å‘¨å®Œæˆï¼ˆP1ï¼‰

3. **æ‰¹é‡æ“ä½œä¼˜åŒ–**
   - å·¥ä½œé‡ï¼š3-4å°æ—¶
   - å½±å“ï¼šæ‰¹é‡æ“ä½œæ€§èƒ½
   - é£é™©ï¼šä¸­ï¼ˆéœ€è¦æµ‹è¯•ï¼‰

4. **äº‹ä»¶ä¼˜åŒ–**
   - å·¥ä½œé‡ï¼š2-3å°æ—¶
   - å½±å“ï¼šäº‹ä»¶å­˜å‚¨å’ŒGas
   - é£é™©ï¼šä½

---

### ğŸ“… ä¸‹å‘¨å®Œæˆï¼ˆP2ï¼‰

5. **æ•°æ®å½’æ¡£æœºåˆ¶**
   - å·¥ä½œé‡ï¼š6-8å°æ—¶
   - å½±å“ï¼šé•¿æœŸå­˜å‚¨å¢é•¿
   - é£é™©ï¼šé«˜ï¼ˆéœ€è¦è¿ç§»ç­–ç•¥ï¼‰

6. **åŒæ˜ å°„ç´¢å¼•**
   - å·¥ä½œé‡ï¼š4-5å°æ—¶
   - å½±å“ï¼šæŸ¥è¯¢æ€§èƒ½
   - é£é™©ï¼šä¸­ï¼ˆå¢åŠ å­˜å‚¨ï¼‰

---

## ğŸ¯ å…·ä½“ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šBoundedVec å¤§å°ä¼˜åŒ–ï¼ˆç«‹å³æ‰§è¡Œï¼‰

**æ–‡ä»¶æ¸…å•**ï¼š
```
pallets/trading/src/lib.rs
pallets/deceased/src/lib.rs
pallets/memorial/src/lib.rs
pallets/credit/src/lib.rs
runtime/src/configs/mod.rs
```

**ä¿®æ”¹ç¤ºä¾‹**ï¼š
```rust
// âŒ ä¿®æ”¹å‰
pub type Cid = BoundedVec<u8, ConstU32<256>>;
pub type TronAddress = BoundedVec<u8, ConstU32<64>>;

// âœ… ä¿®æ”¹å
pub type Cid = BoundedVec<u8, ConstU32<64>>;
pub type TronAddress = BoundedVec<u8, ConstU32<34>>;
```

**æµ‹è¯•è®¡åˆ’**ï¼š
1. å•å…ƒæµ‹è¯•éªŒè¯æ–°é™åˆ¶
2. é›†æˆæµ‹è¯•éªŒè¯å…¼å®¹æ€§
3. è¿ç§»æµ‹è¯•ï¼ˆå¦‚éœ€è¦ï¼‰

---

### æ–¹æ¡ˆ2ï¼šæƒé‡Benchmarkï¼ˆæœ¬å‘¨ï¼‰

**æ­¥éª¤**ï¼š
1. æ·»åŠ  `frame-benchmarking` ä¾èµ–
2. ä¸ºæ¯ä¸ªextrinsicç¼–å†™benchmark
3. è¿è¡Œbenchmarkç”Ÿæˆæƒé‡æ–‡ä»¶
4. æ›´æ–° `TradingWeightInfo` å®ç°

**ç¤ºä¾‹**ï¼š
```rust
#[cfg(feature = "runtime-benchmarks")]
mod benchmarking {
    use super::*;
    use frame_benchmarking::v2::*;

    #[benchmarks]
    mod benchmarks {
        use super::*;

        #[benchmark]
        fn create_order() {
            let caller: T::AccountId = whitelisted_caller();
            #[extrinsic_call]
            create_order(
                RawOrigin::Signed(caller),
                1,  // maker_id
                1_000_000,  // qty
                "contact".into(),
            );

            assert!(Orders::<T>::contains_key(1));
        }
    }
}
```

---

### æ–¹æ¡ˆ3ï¼šæ•°æ®å½’æ¡£æœºåˆ¶ï¼ˆä¸‹å‘¨ï¼‰

**è®¾è®¡**ï¼š
```rust
// æ–°å¢å½’æ¡£å­˜å‚¨
#[pallet::storage]
pub type ArchivedOrders<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u64,  // order_id
    OrderSummary<T>,  // ç²¾ç®€ç‰ˆè®¢å•ï¼ˆä»…ä¿ç•™æ‘˜è¦ï¼‰
>;

// æ–°å¢å½’æ¡£å‡½æ•°
#[pallet::call_index(XX)]
pub fn archive_old_orders(
    origin: OriginFor<T>,
    cutoff_block: BlockNumberFor<T>,
) -> DispatchResult {
    ensure_root(origin)?;

    let mut archived_count = 0;
    for (id, order) in Orders::<T>::iter() {
        if order.created_at < cutoff_block {
            // 1. åˆ›å»ºç²¾ç®€æ‘˜è¦
            let summary = OrderSummary {
                id: order.id,
                hash: Self::order_hash(&order),
                created_at: order.created_at,
            };

            // 2. ç§»è‡³å½’æ¡£
            ArchivedOrders::<T>::insert(id, summary);

            // 3. åˆ é™¤åŸè®°å½•
            Orders::<T>::remove(id);

            archived_count += 1;
        }
    }

    Self::deposit_event(Event::OrdersArchived { count: archived_count });
    Ok(())
}
```

---

## ğŸ“Š é¢„æœŸæ”¶ç›Š

| ä¼˜åŒ–é¡¹ | å­˜å‚¨èŠ‚çœ | Gasé™ä½ | TPSæå‡ |
|--------|---------|---------|---------|
| BoundedVecä¼˜åŒ– | 40-50% | 10-15% | 5-10% |
| æƒé‡ä¼˜åŒ– | 0% | 5-10% | 0% |
| æ‰¹é‡æ“ä½œä¼˜åŒ– | 0% | 50-70%* | 20-30%* |
| äº‹ä»¶ä¼˜åŒ– | 30-40% | 10-15% | 5-10% |
| æ•°æ®å½’æ¡£ | 60-80%* | 0% | 10-15% |

*æ³¨ï¼šä»…é’ˆå¯¹ç‰¹å®šæ“ä½œ

**ç»¼åˆé¢„æœŸ**ï¼š
- **å­˜å‚¨**ï¼šå…¨é“¾å­˜å‚¨é™ä½ 50-60%
- **Gas**ï¼šå¹³å‡äº¤æ˜“Gasé™ä½ 20-30%
- **TPS**ï¼šç†è®ºTPSæå‡ 15-25%

---

## âš ï¸ é£é™©è¯„ä¼°

### é«˜é£é™©é¡¹

1. **æ•°æ®å½’æ¡£**ï¼šéœ€è¦å®Œå–„çš„è¿ç§»ç­–ç•¥
2. **BoundedVecç¼©å°**ï¼šå¯èƒ½å½±å“ç°æœ‰æ•°æ®

### ä¸­é£é™©é¡¹

3. **æ‰¹é‡æ“ä½œ**ï¼šéœ€è¦å……åˆ†æµ‹è¯•
4. **åŒæ˜ å°„ç´¢å¼•**ï¼šå¢åŠ å­˜å‚¨æˆæœ¬

### ä½é£é™©é¡¹

5. **æƒé‡ä¼˜åŒ–**ï¼šçº¯æ€§èƒ½æå‡
6. **äº‹ä»¶ä¼˜åŒ–**ï¼šå‘ä¸‹å…¼å®¹

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç«‹å³æ‰§è¡Œï¼ˆä»Šå¤©ï¼‰

**ä»»åŠ¡1**ï¼šBoundedVec å¤§å°ä¼˜åŒ–
- [ ] åˆ†ææ‰€æœ‰BoundedVecä½¿ç”¨
- [ ] è°ƒæ•´Cid/TronAddress/å…¶ä»–ç±»å‹
- [ ] æ›´æ–°ç›¸å…³é…ç½®
- [ ] ç¼–è¯‘æµ‹è¯•

**ä»»åŠ¡2**ï¼šåˆ›å»ºæƒé‡benchmarkæ¡†æ¶
- [ ] æ·»åŠ benchmarkä¾èµ–
- [ ] åˆ›å»ºbenchmarkæ¨¡å—
- [ ] ç¼–å†™ç¬¬ä¸€ä¸ªbenchmarkæµ‹è¯•

---

### æœ¬å‘¨æ‰§è¡Œ

**ä»»åŠ¡3**ï¼šå®Œæˆæƒé‡benchmark
- [ ] ä¸ºæ‰€æœ‰extrinsicsç¼–å†™benchmark
- [ ] è¿è¡Œbenchmarkç”Ÿæˆæƒé‡
- [ ] æ›´æ–°æƒé‡å®ç°

**ä»»åŠ¡4**ï¼šæ‰¹é‡æ“ä½œä¼˜åŒ–
- [ ] è¯†åˆ«æ‰¹é‡æ“ä½œç“¶é¢ˆ
- [ ] ä¼˜åŒ–å­˜å‚¨æ“ä½œ
- [ ] æµ‹è¯•éªŒè¯

---

### ä¸‹å‘¨æ‰§è¡Œ

**ä»»åŠ¡5**ï¼šæ•°æ®å½’æ¡£POC
- [ ] è®¾è®¡å½’æ¡£æ–¹æ¡ˆ
- [ ] å®ç°å½’æ¡£é€»è¾‘
- [ ] æµ‹è¯•éªŒè¯

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-10-28  
**ä¸‹ä¸€æ­¥**ï¼šå¼€å§‹æ‰§è¡ŒBoundedVecä¼˜åŒ– ğŸš€

