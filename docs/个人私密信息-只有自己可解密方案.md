# ä¸ªäººç§å¯†ä¿¡æ¯ - åªæœ‰è‡ªå·±å¯è§£å¯†æ–¹æ¡ˆ

## ä¸€ã€éœ€æ±‚åœºæ™¯

### å…¸å‹åº”ç”¨

**ç”¨æˆ·ä¸ªäººèµ„æ–™ï¼š**
- ç”Ÿæ—¥
- èº«ä»½è¯å·
- é“¶è¡Œå¡å·
- å®¶åº­ä½å€
- è”ç³»ç”µè¯
- åŒ»ç–—è®°å½•
- å…¶ä»–æ•æ„Ÿä¿¡æ¯

**éšç§è¦æ±‚ï¼š**
- âœ… åªæœ‰ç”¨æˆ·è‡ªå·±å¯ä»¥è§£å¯†æŸ¥çœ‹
- âŒ å…¶ä»–æ‰€æœ‰äººï¼ˆåŒ…æ‹¬å§”å‘˜ä¼šã€èŠ‚ç‚¹ã€ç®¡ç†å‘˜ï¼‰éƒ½æ— æ³•è§£å¯†
- âœ… é“¾ä¸Šå¯éªŒè¯æ•°æ®å­˜åœ¨æ€§å’Œå®Œæ•´æ€§
- âœ… æ”¯æŒç”¨æˆ·éšæ—¶æ›´æ–°å’Œåˆ é™¤

---

## äºŒã€æŠ€æœ¯æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šå¯¹ç§°åŠ å¯†ï¼ˆæ¨èï¼Œæœ€ç®€å•ï¼‰

```typescript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç”¨æˆ·ï¼ˆé“¾ä¸‹ï¼‰                      â”‚
â”‚                                                  â”‚
â”‚  1. ä»é’±åŒ…æ´¾ç”ŸåŠ å¯†å¯†é’¥                            â”‚
â”‚     - ä½¿ç”¨åŠ©è®°è¯æ´¾ç”Ÿå­å¯†é’¥                        â”‚
â”‚     - æˆ–ä½¿ç”¨å¯†ç æ´¾ç”Ÿï¼ˆPBKDF2ï¼‰                    â”‚
â”‚                                                  â”‚
â”‚  2. ç”¨å¯†é’¥åŠ å¯†æ•°æ®ï¼ˆAES-256-GCMï¼‰                â”‚
â”‚     - åŸå§‹æ•°æ®ï¼š{ birthday: "1990-01-01" }      â”‚
â”‚     - åŠ å¯†åï¼š0x4a3f2b...                       â”‚
â”‚                                                  â”‚
â”‚  3. ä¸Šä¼ åŠ å¯†æ•°æ®åˆ°IPFS â†’ CID                    â”‚
â”‚                                                  â”‚
â”‚  4. è®¡ç®—å“ˆå¸Œç”¨äºéªŒè¯                             â”‚
â”‚     - hash = blake2b(åŸå§‹æ•°æ®)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Palletï¼ˆé“¾ä¸Šè®°å½•å±‚ï¼‰                  â”‚
â”‚                                                  â”‚
â”‚  âœ… å­˜å‚¨ï¼šCIDï¼ˆIPFSä½ç½®ï¼‰                        â”‚
â”‚  âœ… å­˜å‚¨ï¼šcontent_hashï¼ˆéªŒè¯å®Œæ•´æ€§ï¼‰             â”‚
â”‚  âœ… å­˜å‚¨ï¼šencrypted_atï¼ˆæ—¶é—´æˆ³ï¼‰                 â”‚
â”‚  âŒ ä¸å­˜å‚¨ï¼šä»»ä½•å¯†é’¥æˆ–åŸå§‹æ•°æ®                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ç”¨æˆ·è§£å¯†ï¼ˆé“¾ä¸‹ï¼‰                     â”‚
â”‚                                                  â”‚
â”‚  1. ä»IPFSä¸‹è½½åŠ å¯†æ•°æ®ï¼ˆCIDï¼‰                    â”‚
â”‚                                                  â”‚
â”‚  2. ä»é’±åŒ…æ´¾ç”Ÿç›¸åŒçš„åŠ å¯†å¯†é’¥                      â”‚
â”‚                                                  â”‚
â”‚  3. è§£å¯†æ•°æ®                                     â”‚
â”‚     - 0x4a3f2b... â†’ { birthday: "1990-01-01" } â”‚
â”‚                                                  â”‚
â”‚  4. éªŒè¯å“ˆå¸Œæ˜¯å¦åŒ¹é…                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®ç‚¹ï¼š**
- âœ… åŠ å¯†å¯†é’¥ä»åŠ©è®°è¯æ´¾ç”Ÿï¼Œæ°¸è¿œä¸ä¸Šé“¾
- âœ… åªè¦æœ‰åŠ©è®°è¯ï¼Œå°±èƒ½æ¢å¤å¯†é’¥å¹¶è§£å¯†
- âœ… å…¶ä»–äººæ— æ³•è·å–å¯†é’¥ï¼Œæ— æ³•è§£å¯†

---

### æ–¹æ¡ˆBï¼šéå¯¹ç§°åŠ å¯†

```typescript
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ç”¨æˆ·ï¼ˆé“¾ä¸‹ï¼‰                      â”‚
â”‚                                                  â”‚
â”‚  1. ç”Ÿæˆä¸“ç”¨å¯†é’¥å¯¹ï¼ˆRSA-2048ï¼‰                    â”‚
â”‚     - å…¬é’¥ï¼šæ³¨å†Œåˆ°é“¾ä¸Š                            â”‚
â”‚     - ç§é’¥ï¼šæœ¬åœ°ä¿å­˜ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰                   â”‚
â”‚                                                  â”‚
â”‚  2. ç”¨è‡ªå·±çš„å…¬é’¥åŠ å¯†æ•°æ®                          â”‚
â”‚     - åªæœ‰å¯¹åº”çš„ç§é’¥æ‰èƒ½è§£å¯†                      â”‚
â”‚                                                  â”‚
â”‚  3. ä¸Šä¼ åŠ å¯†æ•°æ®åˆ°IPFS â†’ CID                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Palletï¼ˆé“¾ä¸Šè®°å½•å±‚ï¼‰                  â”‚
â”‚                                                  â”‚
â”‚  âœ… å­˜å‚¨ï¼šç”¨æˆ·å…¬é’¥ï¼ˆå¯é€‰ï¼‰                        â”‚
â”‚  âœ… å­˜å‚¨ï¼šCIDï¼ˆIPFSä½ç½®ï¼‰                        â”‚
â”‚  âœ… å­˜å‚¨ï¼šcontent_hash                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               ç”¨æˆ·è§£å¯†ï¼ˆé“¾ä¸‹ï¼‰                     â”‚
â”‚                                                  â”‚
â”‚  1. ä»IPFSä¸‹è½½åŠ å¯†æ•°æ®                           â”‚
â”‚                                                  â”‚
â”‚  2. ç”¨ç§é’¥è§£å¯†                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä¸‰ã€æ¨èå®æ–½ï¼šæ–¹æ¡ˆAï¼ˆå¯¹ç§°åŠ å¯†ï¼‰

### 3.1 ä¸ºä»€ä¹ˆé€‰æ‹©å¯¹ç§°åŠ å¯†ï¼Ÿ

| å¯¹æ¯”é¡¹ | å¯¹ç§°åŠ å¯†ï¼ˆAESï¼‰ | éå¯¹ç§°åŠ å¯†ï¼ˆRSAï¼‰ |
|-------|----------------|------------------|
| æ€§èƒ½ | ğŸŸ¢ éå¸¸å¿« | ğŸŸ¡ è¾ƒæ…¢ |
| å¯†é’¥ç®¡ç† | ğŸŸ¢ ä»åŠ©è®°è¯æ´¾ç”Ÿ | ğŸŸ¡ éœ€è¦é¢å¤–å­˜å‚¨ç§é’¥ |
| åŠ å¯†å¤§å° | ğŸŸ¢ æ•°æ®å¤§å°+16å­—èŠ‚ | ğŸ”´ é™åˆ¶2048ä½ |
| å®ç°å¤æ‚åº¦ | ğŸŸ¢ ç®€å• | ğŸŸ¡ ä¸­ç­‰ |
| å¯†é’¥æ¢å¤ | ğŸŸ¢ åŠ©è®°è¯æ¢å¤ | ğŸ”´ ç§é’¥ä¸¢å¤±æ— æ³•æ¢å¤ |

**ç»“è®ºï¼šä¸ªäººæ•°æ®åŠ å¯†ä¼˜å…ˆä½¿ç”¨å¯¹ç§°åŠ å¯†ï¼ˆAES-256-GCMï¼‰**

---

### 3.2 å¯†é’¥æ´¾ç”Ÿæ–¹æ¡ˆ

#### æ–¹æ¡ˆ1ï¼šä»Substrateè´¦æˆ·æ´¾ç”Ÿï¼ˆæ¨èï¼‰

```typescript
import { mnemonicToMiniSecret } from '@polkadot/util-crypto';
import { blake2AsU8a } from '@polkadot/util-crypto';
import crypto from 'crypto';

/**
 * ä»åŠ©è®°è¯æ´¾ç”ŸåŠ å¯†å¯†é’¥
 * 
 * ä¼˜åŠ¿ï¼š
 * - åªéœ€è®°ä½åŠ©è®°è¯
 * - æ¢è®¾å¤‡å¯æ¢å¤
 * - ä¸è´¦æˆ·ä½“ç³»ç»Ÿä¸€
 */
function deriveEncryptionKey(mnemonic: string, purpose: string = 'encryption'): Uint8Array {
  // 1. åŠ©è®°è¯ â†’ ç§å­
  const seed = mnemonicToMiniSecret(mnemonic);
  
  // 2. æ´¾ç”Ÿè·¯å¾„ï¼š//encryption
  const derivationPath = stringToU8a(`//${purpose}`);
  
  // 3. HKDFæ´¾ç”Ÿå­å¯†é’¥
  const material = new Uint8Array([...seed, ...derivationPath]);
  const key = blake2AsU8a(material, 256); // 32å­—èŠ‚ = AES-256
  
  return key;
}

// ä½¿ç”¨ç¤ºä¾‹
const mnemonic = 'your twelve word mnemonic phrase here and so on';
const encryptionKey = deriveEncryptionKey(mnemonic);

console.log('åŠ å¯†å¯†é’¥ï¼ˆ32å­—èŠ‚ï¼‰:', encryptionKey);
console.log('âœ… æ­¤å¯†é’¥ä¸ä¼šä¸Šé“¾ï¼Œåªåœ¨æœ¬åœ°ä½¿ç”¨');
```

#### æ–¹æ¡ˆ2ï¼šä»å¯†ç æ´¾ç”Ÿï¼ˆå¤‡é€‰ï¼‰

```typescript
import { pbkdf2Sync } from 'crypto';

/**
 * ä»å¯†ç æ´¾ç”ŸåŠ å¯†å¯†é’¥
 * 
 * é€‚ç”¨åœºæ™¯ï¼š
 * - ç”¨æˆ·ä¸æƒ³ä½¿ç”¨åŠ©è®°è¯
 * - é¢å¤–çš„å¯†ç ä¿æŠ¤å±‚
 */
function deriveKeyFromPassword(
  password: string,
  accountId: string, // ä½œä¸ºsaltçš„ä¸€éƒ¨åˆ†
  iterations: number = 100000
): Uint8Array {
  const salt = stringToU8a(`stardust:${accountId}:encryption`);
  
  const key = pbkdf2Sync(
    password,
    Buffer.from(salt),
    iterations,
    32, // AES-256éœ€è¦32å­—èŠ‚
    'sha256'
  );
  
  return new Uint8Array(key);
}

// ä½¿ç”¨ç¤ºä¾‹
const password = 'MySecurePassword123!';
const accountId = '5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY';
const key = deriveKeyFromPassword(password, accountId);

console.log('âœ… å¯†é’¥æ´¾ç”ŸæˆåŠŸ');
```

---

### 3.3 åŠ å¯†å·¥å…·ç±»

```typescript
// src/utils/personalDataEncryption.ts

import { naclEncrypt, naclDecrypt, blake2AsHex } from '@polkadot/util-crypto';
import { stringToU8a, u8aToString } from '@polkadot/util';
import { create as ipfsHttpClient } from 'ipfs-http-client';

export class PersonalDataEncryption {
  /**
   * åŠ å¯†ä¸ªäººæ•°æ®
   * 
   * @param data - åŸå§‹æ•°æ®ï¼ˆå¯¹è±¡æˆ–å­—ç¬¦ä¸²ï¼‰
   * @param encryptionKey - ä»åŠ©è®°è¯æ´¾ç”Ÿçš„32å­—èŠ‚å¯†é’¥
   * @returns åŠ å¯†ç»“æœï¼ˆIPFS CID + å“ˆå¸Œï¼‰
   */
  static async encryptAndStore(
    data: any,
    encryptionKey: Uint8Array
  ): Promise<{
    cid: string;
    contentHash: string;
    originalSize: number;
  }> {
    // 1. åºåˆ—åŒ–æ•°æ®
    const dataStr = typeof data === 'string' ? data : JSON.stringify(data);
    const dataBytes = stringToU8a(dataStr);
    
    // 2. è®¡ç®—åŸå§‹æ•°æ®å“ˆå¸Œï¼ˆç”¨äºé“¾ä¸ŠéªŒè¯ï¼‰
    const contentHash = blake2AsHex(dataBytes);
    
    // 3. åŠ å¯†æ•°æ®
    const { encrypted, nonce } = naclEncrypt(dataBytes, encryptionKey);
    
    // 4. æ„é€ IPFSå­˜å‚¨æ ¼å¼
    const ipfsData = {
      version: '1.0',
      encryption_method: 'NaCl-SecretBox',
      nonce: Array.from(nonce), // Uint8Array â†’ Arrayæ–¹ä¾¿JSONåºåˆ—åŒ–
      encrypted_content: Array.from(encrypted),
      metadata: {
        encrypted_at: Date.now(),
        original_size: dataBytes.length,
      },
    };
    
    // 5. ä¸Šä¼ åˆ°IPFS
    const ipfs = ipfsHttpClient({ url: 'https://ipfs.infura.io:5001' });
    const result = await ipfs.add(JSON.stringify(ipfsData));
    
    return {
      cid: result.path,
      contentHash,
      originalSize: dataBytes.length,
    };
  }
  
  /**
   * è§£å¯†ä¸ªäººæ•°æ®
   * 
   * @param cid - IPFS CID
   * @param encryptionKey - ä»åŠ©è®°è¯æ´¾ç”Ÿçš„32å­—èŠ‚å¯†é’¥
   * @param expectedHash - é“¾ä¸Šå­˜å‚¨çš„å“ˆå¸Œï¼ˆå¯é€‰ï¼Œç”¨äºéªŒè¯ï¼‰
   * @returns è§£å¯†åçš„åŸå§‹æ•°æ®
   */
  static async downloadAndDecrypt(
    cid: string,
    encryptionKey: Uint8Array,
    expectedHash?: string
  ): Promise<any> {
    // 1. ä»IPFSä¸‹è½½
    const ipfs = ipfsHttpClient({ url: 'https://ipfs.infura.io:5001' });
    const chunks = [];
    for await (const chunk of ipfs.cat(cid)) {
      chunks.push(chunk);
    }
    const ipfsDataStr = Buffer.concat(chunks).toString();
    const ipfsData = JSON.parse(ipfsDataStr);
    
    // 2. æå–åŠ å¯†æ•°æ®å’Œnonce
    const encrypted = new Uint8Array(ipfsData.encrypted_content);
    const nonce = new Uint8Array(ipfsData.nonce);
    
    // 3. è§£å¯†
    const decrypted = naclDecrypt(encrypted, nonce, encryptionKey);
    
    if (!decrypted) {
      throw new Error('è§£å¯†å¤±è´¥ï¼šå¯†é’¥ä¸æ­£ç¡®æˆ–æ•°æ®å·²æŸå');
    }
    
    // 4. ååºåˆ—åŒ–
    const decryptedStr = u8aToString(decrypted);
    
    // 5. éªŒè¯å“ˆå¸Œï¼ˆå¦‚æœæä¾›ï¼‰
    if (expectedHash) {
      const actualHash = blake2AsHex(decrypted);
      if (actualHash !== expectedHash) {
        throw new Error('æ•°æ®å®Œæ•´æ€§éªŒè¯å¤±è´¥ï¼šå“ˆå¸Œä¸åŒ¹é…');
      }
    }
    
    // 6. å°è¯•è§£æä¸ºJSONï¼Œå¦‚æœå¤±è´¥åˆ™è¿”å›å­—ç¬¦ä¸²
    try {
      return JSON.parse(decryptedStr);
    } catch {
      return decryptedStr;
    }
  }
}
```

---

### 3.4 é“¾ä¸Šå­˜å‚¨ï¼ˆå¯é€‰ï¼‰

æ‚¨å¯ä»¥é€‰æ‹©ä½¿ç”¨ç°æœ‰çš„ `evidence pallet`ï¼Œæˆ–åˆ›å»ºç®€åŒ–ç‰ˆï¼š

```rust
// pallets/personal-data/src/lib.rs

/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šä¸ªäººåŠ å¯†æ•°æ®å…ƒæ•°æ®
#[derive(Clone, Encode, Decode, PartialEq, RuntimeDebug, TypeInfo, MaxEncodedLen)]
pub struct PersonalDataMeta<AccountId, BlockNumber> {
    /// æ•°æ®æ‹¥æœ‰è€…
    pub owner: AccountId,
    
    /// IPFS CIDï¼ˆåŠ å¯†æ•°æ®ä½ç½®ï¼‰
    pub cid: BoundedVec<u8, ConstU32<64>>,
    
    /// åŸå§‹æ•°æ®å“ˆå¸Œï¼ˆç”¨äºéªŒè¯å®Œæ•´æ€§ï¼Œä½†ä¸èƒ½åæ¨åŸå§‹æ•°æ®ï¼‰
    pub content_hash: H256,
    
    /// æ•°æ®ç±»å‹æ ‡è¯†ï¼ˆå¦‚ "identity", "medical"ï¼‰
    pub data_type: BoundedVec<u8, ConstU32<32>>,
    
    /// åŠ å¯†æ—¶é—´
    pub encrypted_at: BlockNumber,
    
    /// æœ€åæ›´æ–°æ—¶é—´
    pub updated_at: BlockNumber,
}

#[pallet::storage]
pub type PersonalData<T: Config> = StorageDoubleMap<
    _,
    Blake2_128Concat,
    T::AccountId,        // ç¬¬ä¸€ä¸ªkeyï¼šç”¨æˆ·è´¦æˆ·
    Blake2_128Concat,
    Vec<u8>,             // ç¬¬äºŒä¸ªkeyï¼šæ•°æ®ç±»å‹ï¼ˆå¦‚ "identity"ï¼‰
    PersonalDataMeta<T::AccountId, BlockNumberFor<T>>,
    OptionQuery,
>;

/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šå­˜å‚¨åŠ å¯†çš„ä¸ªäººæ•°æ®
/// 
/// # å‚æ•°
/// - data_type: æ•°æ®ç±»å‹ï¼ˆå¦‚ "identity", "medical", "financial"ï¼‰
/// - cid: IPFS CIDï¼ˆåŠ å¯†æ•°æ®çš„ä½ç½®ï¼‰
/// - content_hash: åŸå§‹æ•°æ®çš„å“ˆå¸Œï¼ˆç”¨äºéªŒè¯å®Œæ•´æ€§ï¼‰
#[pallet::call_index(0)]
#[pallet::weight(10_000)]
pub fn store_encrypted_data(
    origin: OriginFor<T>,
    data_type: Vec<u8>,
    cid: Vec<u8>,
    content_hash: H256,
) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    ensure!(
        data_type.len() <= 32,
        Error::<T>::DataTypeTooLong
    );
    
    ensure!(
        cid.len() <= 64,
        Error::<T>::CidTooLong
    );
    
    let now = <frame_system::Pallet<T>>::block_number();
    
    let meta = PersonalDataMeta {
        owner: who.clone(),
        cid: cid.clone().try_into().map_err(|_| Error::<T>::CidTooLong)?,
        content_hash,
        data_type: data_type.clone().try_into().map_err(|_| Error::<T>::DataTypeTooLong)?,
        encrypted_at: now,
        updated_at: now,
    };
    
    PersonalData::<T>::insert(&who, &data_type, meta);
    
    Self::deposit_event(Event::DataStored {
        owner: who,
        data_type,
        cid,
    });
    
    Ok(())
}

/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šæ›´æ–°åŠ å¯†æ•°æ®
#[pallet::call_index(1)]
#[pallet::weight(10_000)]
pub fn update_encrypted_data(
    origin: OriginFor<T>,
    data_type: Vec<u8>,
    new_cid: Vec<u8>,
    new_content_hash: H256,
) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    PersonalData::<T>::try_mutate(&who, &data_type, |maybe_meta| -> DispatchResult {
        let meta = maybe_meta.as_mut().ok_or(Error::<T>::DataNotFound)?;
        
        meta.cid = new_cid.clone().try_into().map_err(|_| Error::<T>::CidTooLong)?;
        meta.content_hash = new_content_hash;
        meta.updated_at = <frame_system::Pallet<T>>::block_number();
        
        Ok(())
    })?;
    
    Self::deposit_event(Event::DataUpdated {
        owner: who,
        data_type,
        new_cid,
    });
    
    Ok(())
}

/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šåˆ é™¤åŠ å¯†æ•°æ®
#[pallet::call_index(2)]
#[pallet::weight(10_000)]
pub fn delete_encrypted_data(
    origin: OriginFor<T>,
    data_type: Vec<u8>,
) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    ensure!(
        PersonalData::<T>::contains_key(&who, &data_type),
        Error::<T>::DataNotFound
    );
    
    PersonalData::<T>::remove(&who, &data_type);
    
    Self::deposit_event(Event::DataDeleted {
        owner: who,
        data_type,
    });
    
    Ok(())
}
```

---

### 3.5 å‰ç«¯å®Œæ•´ç¤ºä¾‹

```typescript
// src/pages/UserProfile/EncryptedIdentity.tsx

import React, { useState, useEffect } from 'react';
import { Form, Input, Button, Card, message, Descriptions } from 'antd';
import { useApi, useAccount } from '@/hooks';
import { PersonalDataEncryption } from '@/utils/personalDataEncryption';
import { mnemonicToMiniSecret } from '@polkadot/util-crypto';

export const EncryptedIdentity: React.FC = () => {
  const { api } = useApi();
  const { account, mnemonic } = useAccount();
  const [loading, setLoading] = useState(false);
  const [decryptedData, setDecryptedData] = useState<any>(null);
  
  /**
   * ä¿å­˜åŠ å¯†çš„ä¸ªäººä¿¡æ¯
   */
  const handleSave = async (values: any) => {
    if (!mnemonic) {
      message.error('è¯·å…ˆè§£é”é’±åŒ…');
      return;
    }
    
    setLoading(true);
    try {
      // 1. æ´¾ç”ŸåŠ å¯†å¯†é’¥
      const encryptionKey = deriveEncryptionKey(mnemonic);
      
      // 2. å‡†å¤‡æ•°æ®
      const personalData = {
        full_name: values.full_name,
        id_card: values.id_card,
        birthday: values.birthday,
        address: values.address,
        phone: values.phone,
        email: values.email,
      };
      
      // 3. åŠ å¯†å¹¶ä¸Šä¼ åˆ°IPFS
      const { cid, contentHash, originalSize } = 
        await PersonalDataEncryption.encryptAndStore(personalData, encryptionKey);
      
      console.log('âœ… æ•°æ®å·²åŠ å¯†å¹¶ä¸Šä¼ åˆ°IPFS:', cid);
      console.log('ğŸ“Š åŸå§‹å¤§å°:', originalSize, 'å­—èŠ‚');
      console.log('ğŸ”’ å“ˆå¸Œ:', contentHash);
      
      // 4. å°†å…ƒæ•°æ®å­˜å‚¨åˆ°é“¾ä¸Š
      await api.tx.personalData.storeEncryptedData(
        'identity',   // æ•°æ®ç±»å‹
        cid,          // IPFS CID
        contentHash   // å“ˆå¸Œ
      ).signAndSend(account, ({ status }) => {
        if (status.isInBlock) {
          message.success('âœ… ä¸ªäººä¿¡æ¯å·²åŠ å¯†ä¿å­˜ï¼åªæœ‰æ‚¨è‡ªå·±å¯ä»¥è§£å¯†');
        }
      });
      
    } catch (error) {
      console.error('ä¿å­˜å¤±è´¥ï¼š', error);
      message.error('ä¿å­˜å¤±è´¥ï¼š' + error.message);
    } finally {
      setLoading(false);
    }
  };
  
  /**
   * åŠ è½½å¹¶è§£å¯†ä¸ªäººä¿¡æ¯
   */
  const handleLoad = async () => {
    if (!mnemonic) {
      message.error('è¯·å…ˆè§£é”é’±åŒ…');
      return;
    }
    
    setLoading(true);
    try {
      // 1. ä»é“¾ä¸Šè·å–å…ƒæ•°æ®
      const meta = await api.query.personalData.personalData(
        account.address,
        'identity'
      );
      
      if (meta.isNone) {
        message.info('æ‚¨è¿˜æ²¡æœ‰ä¿å­˜è¿‡ä¸ªäººä¿¡æ¯');
        return;
      }
      
      const { cid, content_hash } = meta.unwrap();
      
      // 2. æ´¾ç”ŸåŠ å¯†å¯†é’¥
      const encryptionKey = deriveEncryptionKey(mnemonic);
      
      // 3. ä»IPFSä¸‹è½½å¹¶è§£å¯†
      const data = await PersonalDataEncryption.downloadAndDecrypt(
        cid.toString(),
        encryptionKey,
        content_hash.toHex()
      );
      
      setDecryptedData(data);
      message.success('âœ… è§£å¯†æˆåŠŸï¼');
      
    } catch (error) {
      console.error('åŠ è½½å¤±è´¥ï¼š', error);
      message.error('è§£å¯†å¤±è´¥ï¼š' + error.message);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <div style={{ maxWidth: 800, margin: '0 auto', padding: 24 }}>
      <Card title="ğŸ”’ åŠ å¯†ä¸ªäººä¿¡æ¯" extra={
        <Button onClick={handleLoad} loading={loading}>
          æŸ¥çœ‹æˆ‘çš„ä¿¡æ¯
        </Button>
      }>
        <Form onFinish={handleSave} layout="vertical">
          <Form.Item
            label="å§“å"
            name="full_name"
            rules={[{ required: true, message: 'è¯·è¾“å…¥å§“å' }]}
          >
            <Input placeholder="å¼ ä¸‰" />
          </Form.Item>
          
          <Form.Item
            label="èº«ä»½è¯å·"
            name="id_card"
            rules={[{ required: true, message: 'è¯·è¾“å…¥èº«ä»½è¯å·' }]}
          >
            <Input placeholder="110101199001011234" />
          </Form.Item>
          
          <Form.Item
            label="ç”Ÿæ—¥"
            name="birthday"
            rules={[{ required: true, message: 'è¯·è¾“å…¥ç”Ÿæ—¥' }]}
          >
            <Input type="date" />
          </Form.Item>
          
          <Form.Item label="åœ°å€" name="address">
            <Input.TextArea placeholder="åŒ—äº¬å¸‚æœé˜³åŒº..." />
          </Form.Item>
          
          <Form.Item label="æ‰‹æœºå·" name="phone">
            <Input placeholder="13800138000" />
          </Form.Item>
          
          <Form.Item label="é‚®ç®±" name="email">
            <Input type="email" placeholder="user@example.com" />
          </Form.Item>
          
          <Form.Item>
            <Button type="primary" htmlType="submit" loading={loading} block>
              åŠ å¯†ä¿å­˜ï¼ˆåªæœ‰æˆ‘è‡ªå·±å¯ä»¥è§£å¯†ï¼‰
            </Button>
          </Form.Item>
        </Form>
        
        {decryptedData && (
          <Descriptions 
            title="å·²è§£å¯†çš„ä¸ªäººä¿¡æ¯" 
            bordered 
            column={1}
            style={{ marginTop: 24 }}
          >
            <Descriptions.Item label="å§“å">
              {decryptedData.full_name}
            </Descriptions.Item>
            <Descriptions.Item label="èº«ä»½è¯å·">
              {decryptedData.id_card}
            </Descriptions.Item>
            <Descriptions.Item label="ç”Ÿæ—¥">
              {decryptedData.birthday}
            </Descriptions.Item>
            <Descriptions.Item label="åœ°å€">
              {decryptedData.address}
            </Descriptions.Item>
            <Descriptions.Item label="æ‰‹æœºå·">
              {decryptedData.phone}
            </Descriptions.Item>
            <Descriptions.Item label="é‚®ç®±">
              {decryptedData.email}
            </Descriptions.Item>
          </Descriptions>
        )}
      </Card>
      
      <Card 
        style={{ marginTop: 16 }}
        type="inner"
        title="ğŸ” å®‰å…¨è¯´æ˜"
      >
        <ul>
          <li>âœ… æ‚¨çš„æ•°æ®ä½¿ç”¨åŠ©è®°è¯æ´¾ç”Ÿçš„å¯†é’¥åŠ å¯†</li>
          <li>âœ… åŠ å¯†å¯†é’¥æ°¸è¿œä¸ä¼šä¸Šé“¾æˆ–ä¸Šä¼ åˆ°æœåŠ¡å™¨</li>
          <li>âœ… åªæœ‰æ‹¥æœ‰åŠ©è®°è¯çš„äººå¯ä»¥è§£å¯†</li>
          <li>âœ… æ¢è®¾å¤‡åªéœ€å¯¼å…¥åŠ©è®°è¯å³å¯æ¢å¤æ•°æ®</li>
          <li>âš ï¸ è¯·å¦¥å–„ä¿ç®¡åŠ©è®°è¯ï¼Œä¸¢å¤±å°†æ°¸ä¹…æ— æ³•è§£å¯†</li>
          <li>âš ï¸ ä¸è¦å°†åŠ©è®°è¯é€éœ²ç»™ä»»ä½•äºº</li>
        </ul>
      </Card>
    </div>
  );
};

/**
 * ä»åŠ©è®°è¯æ´¾ç”ŸåŠ å¯†å¯†é’¥
 */
function deriveEncryptionKey(mnemonic: string): Uint8Array {
  const seed = mnemonicToMiniSecret(mnemonic);
  const derivationPath = stringToU8a('//encryption');
  const material = new Uint8Array([...seed, ...derivationPath]);
  return blake2AsU8a(material, 256);
}
```

---

## å››ã€å®‰å…¨æ€§åˆ†æ

### âœ… ä¼˜åŠ¿

#### 1. **ç»å¯¹éšç§**
```
ç”¨æˆ·åŠ©è®°è¯ â†’ æ´¾ç”Ÿå¯†é’¥ â†’ åŠ å¯†æ•°æ®
     â†“            â†“          â†“
  ç”¨æˆ·ä¿ç®¡     ä¸ä¸Šé“¾      IPFSå­˜å‚¨
```
- åªæœ‰ç”¨æˆ·è‡ªå·±çŸ¥é“åŠ©è®°è¯
- å¯†é’¥æ°¸è¿œä¸ä¸Šé“¾
- å…¶ä»–äººæ— æ³•è§£å¯†

#### 2. **æ•°æ®å®Œæ•´æ€§**
- é“¾ä¸Šå­˜å‚¨å†…å®¹å“ˆå¸Œ
- ä¸‹è½½åéªŒè¯å“ˆå¸Œæ˜¯å¦åŒ¹é…
- é˜²æ­¢IPFSæ•°æ®è¢«ç¯¡æ”¹

#### 3. **å¯æ¢å¤æ€§**
- åªéœ€åŠ©è®°è¯å³å¯æ¢å¤æ‰€æœ‰æ•°æ®
- æ¢è®¾å¤‡ã€æ¢æµè§ˆå™¨éƒ½å¯ä»¥æ¢å¤
- ä¸Substrateè´¦æˆ·ä½“ç³»ç»Ÿä¸€

#### 4. **è½»é‡çº§**
- é“¾ä¸Šåªå­˜å‚¨å°‘é‡å…ƒæ•°æ®ï¼ˆCID + å“ˆå¸Œï¼‰
- ä¸å ç”¨é“¾ä¸Šå­˜å‚¨ç©ºé—´
- Gasè´¹ç”¨æä½

---

### âš ï¸ é£é™©ä¸å¯¹ç­–

#### é£é™©1ï¼šåŠ©è®°è¯ä¸¢å¤±

**åæœï¼šæ°¸ä¹…æ— æ³•è§£å¯†æ•°æ®**

**å¯¹ç­–ï¼š**
```typescript
// 1. åŠ©è®°è¯å¤‡ä»½æé†’
function remindBackup() {
  if (!hasBackedUpMnemonic()) {
    Modal.warning({
      title: 'âš ï¸ è¯·å¤‡ä»½åŠ©è®°è¯',
      content: 'åŠ©è®°è¯æ˜¯æ¢å¤æ•°æ®çš„å”¯ä¸€æ–¹å¼ï¼Œè¯·åŠ¡å¿…å¤‡ä»½å¹¶å¦¥å–„ä¿ç®¡ï¼',
    });
  }
}

// 2. ç¤¾äº¤æ¢å¤ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰
// å°†å¯†é’¥åˆ†å‰²ä¸º5ä»½ï¼Œä»»æ„3ä»½å¯æ¢å¤
async function setupSocialRecovery(
  guardians: string[], // 5ä¸ªä¿¡ä»»çš„æœ‹å‹
  threshold: number = 3
) {
  const encryptionKey = deriveEncryptionKey(mnemonic);
  const shares = shamirSecretSharing.split(encryptionKey, 5, 3);
  
  // ä¸ºæ¯ä¸ªguardianåŠ å¯†ä»–ä»¬çš„åˆ†ç‰‡
  for (let i = 0; i < guardians.length; i++) {
    const guardianPubKey = await getPublicKey(guardians[i]);
    const encryptedShare = rsaEncrypt(shares[i], guardianPubKey);
    await sendToGuardian(guardians[i], encryptedShare);
  }
}
```

---

#### é£é™©2ï¼šIPFSæ•°æ®ä¸¢å¤±

**åæœï¼šæ— æ³•ä¸‹è½½åŠ å¯†æ•°æ®**

**å¯¹ç­–ï¼š**
```typescript
// 1. å¤šIPFSç½‘å…³å¤‡ä»½
const ipfsGateways = [
  'https://ipfs.io/ipfs/',
  'https://gateway.pinata.cloud/ipfs/',
  'https://cloudflare-ipfs.com/ipfs/',
];

async function downloadWithFallback(cid: string): Promise<Buffer> {
  for (const gateway of ipfsGateways) {
    try {
      const response = await fetch(gateway + cid);
      return await response.buffer();
    } catch (error) {
      console.warn(`Gateway ${gateway} failed, trying next...`);
    }
  }
  throw new Error('All IPFS gateways failed');
}

// 2. æœ¬åœ°å¤‡ä»½
function autoBackupToLocal(cid: string, data: any) {
  localStorage.setItem(`backup_${cid}`, JSON.stringify(data));
}
```

---

## äº”ã€åº”ç”¨åœºæ™¯

### åœºæ™¯1ï¼šç”¨æˆ·ä¸ªäººèµ„æ–™ âœ…

```typescript
// æ•°æ®ç±»å‹ï¼šidentity
const personalInfo = {
  full_name: 'å¼ ä¸‰',
  id_card: '110101199001011234',
  birthday: '1990-01-01',
  address: 'åŒ—äº¬å¸‚æœé˜³åŒº...',
  phone: '13800138000',
  email: 'zhangsan@example.com',
};

// åªæœ‰ç”¨æˆ·è‡ªå·±å¯ä»¥è§£å¯†æŸ¥çœ‹
```

---

### åœºæ™¯2ï¼šåŒ»ç–—å¥åº·è®°å½• âœ…

```typescript
// æ•°æ®ç±»å‹ï¼šmedical
const medicalRecord = {
  blood_type: 'A+',
  allergies: ['é’éœ‰ç´ ', 'èŠ±ç²‰'],
  chronic_diseases: ['é«˜è¡€å‹'],
  medications: ['é™å‹è¯'],
  emergency_contact: '13900139000',
};

// ç´§æ€¥æƒ…å†µå¯æˆæƒåŒ»ç”Ÿè®¿é—®ï¼ˆéœ€è¦é¢å¤–åŠŸèƒ½ï¼‰
```

---

### åœºæ™¯3ï¼šè´¢åŠ¡ä¿¡æ¯ âœ…

```typescript
// æ•°æ®ç±»å‹ï¼šfinancial
const financialData = {
  bank_accounts: [
    {
      bank: 'ä¸­å›½é“¶è¡Œ',
      account: '6214850123456789',
      balance: 100000,
    }
  ],
  investments: [...],
  debts: [...],
};

// ç»å¯¹éšç§ï¼Œåªæœ‰è‡ªå·±å¯è§
```

---

### åœºæ™¯4ï¼šé—å˜±ï¼ˆå®šæ—¶è§£é”ï¼‰âœ…

```typescript
// æ•°æ®ç±»å‹ï¼šwill
const will = {
  executor: 'æå››',  // é—å˜±æ‰§è¡Œäºº
  beneficiaries: {
    'ç‹äº”': 'æˆ¿äº§ + 50%å­˜æ¬¾',
    'èµµå…­': 'è½¦è¾† + 50%å­˜æ¬¾',
  },
  instructions: '...',
};

// é«˜çº§åŠŸèƒ½ï¼šè®¾ç½®å®šæ—¶è§£é”æˆ–æ­»äº¡è¯æ˜è§¦å‘è§£é”
```

---

## å…­ã€å¯¹æ¯”æ–¹æ¡ˆ

| æ–¹æ¡ˆ | éšç§æ€§ | çµæ´»æ€§ | å®ç°éš¾åº¦ | é€‚ç”¨åœºæ™¯ |
|------|-------|--------|---------|---------|
| **åªæœ‰è‡ªå·±è§£å¯†ï¼ˆå½“å‰ï¼‰** | ğŸŸ¢ æé«˜ | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ ç®€å• | ä¸ªäººèµ„æ–™ã€æ—¥è®° |
| **å¤šäººå¯è§£å¯†ï¼ˆevidence palletï¼‰** | ğŸŸ¡ ä¸­ç­‰ | ğŸŸ¢ é«˜ | ğŸŸ¡ ä¸­ç­‰ | å§”å‘˜ä¼šå®¡æ ¸ã€ä»²è£ |
| **å…¬å¼€ï¼ˆä¸åŠ å¯†ï¼‰** | ğŸ”´ æ— éšç§ | ğŸŸ¢ é«˜ | ğŸŸ¢ æœ€ç®€å• | å…¬å¼€èµ„æ–™ |

---

## ä¸ƒã€æ€»ç»“

### âœ… å®Œå…¨å¯è¡Œï¼

**æ‚¨çš„éœ€æ±‚ï¼šé“¾ä¸Šä¿¡æ¯ï¼ˆç”Ÿæ—¥ã€èº«ä»½è¯å·ï¼‰åªæœ‰è‡ªå·±å¯ä»¥è§£å¯†**

**æ–¹æ¡ˆï¼šå¯¹ç§°åŠ å¯† + åŠ©è®°è¯æ´¾ç”Ÿå¯†é’¥**

**æ ¸å¿ƒä¼˜åŠ¿ï¼š**
1. âœ… **ç»å¯¹éšç§** - åªæœ‰æ‹¥æœ‰åŠ©è®°è¯çš„äººå¯ä»¥è§£å¯†
2. âœ… **ç®€å•å¯é ** - ä½¿ç”¨æ ‡å‡†çš„AES-256-GCMåŠ å¯†
3. âœ… **å¯æ¢å¤** - åªéœ€åŠ©è®°è¯å³å¯åœ¨ä»»ä½•è®¾å¤‡æ¢å¤
4. âœ… **è½»é‡çº§** - é“¾ä¸Šåªå­˜å‚¨å°‘é‡å…ƒæ•°æ®
5. âœ… **æˆæœ¬ä½** - Gasè´¹ç”¨æä½

### å»ºè®®å®æ–½æ­¥éª¤

1. âœ… ä½¿ç”¨ç°æœ‰çš„ `evidence pallet`ï¼ˆå·²æœ‰åŸºç¡€è®¾æ–½ï¼‰
2. âœ… å®ç° `PersonalDataEncryption` å·¥å…·ç±»
3. âœ… å¼€å‘å‰ç«¯åŠ å¯†ç»„ä»¶
4. âœ… æ·»åŠ åŠ©è®°è¯å¤‡ä»½æé†’
5. âš ï¸ ï¼ˆå¯é€‰ï¼‰å®ç°ç¤¾äº¤æ¢å¤æœºåˆ¶

---

**ç¼–å†™æ—¥æœŸ**ï¼š2025-10-23  
**ç‰ˆæœ¬**ï¼šv1.0  
**çŠ¶æ€**ï¼šå®æ–½æ–¹æ¡ˆ

