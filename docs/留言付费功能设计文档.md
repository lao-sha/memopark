# ç•™è¨€ä»˜è´¹åŠŸèƒ½è®¾è®¡æ–‡æ¡£

**æ—¥æœŸ**ï¼š2025-11-26
**ç‰ˆæœ¬**ï¼š1.0
**åŠŸèƒ½**ï¼šç”¨æˆ·ç»™é€è€…ç•™è¨€éœ€æ”¯ä»˜ 10,000 DUSTï¼Œèµ„é‡‘æµå‘ä¸ä¾›å¥‰å“ä¸€è‡´

---

## ğŸ“‹ ç›®å½•

1. [éœ€æ±‚æ¦‚è¿°](#1-éœ€æ±‚æ¦‚è¿°)
2. [ç°æœ‰ä¾›å¥‰å“èµ„é‡‘æµå‘åˆ†æ](#2-ç°æœ‰ä¾›å¥‰å“èµ„é‡‘æµå‘åˆ†æ)
3. [ç•™è¨€ä»˜è´¹åŠŸèƒ½è®¾è®¡](#3-ç•™è¨€ä»˜è´¹åŠŸèƒ½è®¾è®¡)
4. [èµ„é‡‘æµå‘è¯¦ç»†è®¾è®¡](#4-èµ„é‡‘æµå‘è¯¦ç»†è®¾è®¡)
5. [æŠ€æœ¯å®ç°æ–¹æ¡ˆ](#5-æŠ€æœ¯å®ç°æ–¹æ¡ˆ)
6. [é…ç½®å‚æ•°](#6-é…ç½®å‚æ•°)
7. [æ¥å£è®¾è®¡](#7-æ¥å£è®¾è®¡)
8. [äº‹ä»¶è®¾è®¡](#8-äº‹ä»¶è®¾è®¡)
9. [æµ‹è¯•ç”¨ä¾‹](#9-æµ‹è¯•ç”¨ä¾‹)
10. [å®æ–½è®¡åˆ’](#10-å®æ–½è®¡åˆ’)

---

## 1. éœ€æ±‚æ¦‚è¿°

### 1.1 èƒŒæ™¯

ç”¨æˆ·ç»™é€è€…ç•™è¨€åŠŸèƒ½ä»**å…è´¹æ¨¡å¼**å‡çº§ä¸º**ä»˜è´¹æ¨¡å¼**ï¼Œæ”¶å–å›ºå®šè´¹ç”¨ **10,000 DUST**ã€‚

### 1.2 æ ¸å¿ƒéœ€æ±‚

| é¡¹ç›® | è¯´æ˜ |
|------|------|
| **è´¹ç”¨é‡‘é¢** | 10,000 DUSTï¼ˆå›ºå®šï¼‰ |
| **èµ„é‡‘æµå‘** | ä¸ä¾›å¥‰å“å®Œå…¨ä¸€è‡´ |
| **ç›®æ ‡å—ç›Šè€…** | é€è€…æ‰€æœ‰è€…é€šè¿‡æ¨èé“¾è·ç›Š |
| **å…¼å®¹æ€§** | å¤ç”¨ç°æœ‰ `pallet-affiliate` åˆ†é…ç³»ç»Ÿ |

### 1.3 ä¸ä¾›å¥‰å“çš„å…³ç³»

| å¯¹æ¯”é¡¹ | ä¾›å¥‰å“ | ç•™è¨€ |
|--------|--------|------|
| **é‡‘é¢** | å¯å˜ï¼ˆç”¨æˆ·é€‰æ‹©ï¼‰ | å›ºå®š 10,000 DUST |
| **èµ„é‡‘æµå‘** | `do_distribute_rewards` | `do_distribute_rewards`ï¼ˆç›¸åŒï¼‰ |
| **å›è°ƒæœºåˆ¶** | `OnOfferingCommitted` | `OnMessagePaid`ï¼ˆæ–°å¢ï¼‰ |
| **è§¦å‘æ¡ä»¶** | `offer_by_sacrifice` | `create_text`ï¼ˆkind=Messageï¼‰ |

---

## 2. ç°æœ‰ä¾›å¥‰å“èµ„é‡‘æµå‘åˆ†æ

### 2.1 ä¾›å¥‰å“èµ„é‡‘æµå‘æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ä¾›å¥‰å“æ”¯ä»˜æµç¨‹                                â”‚
â”‚                                                                 â”‚
â”‚  ç”¨æˆ·æ”¯ä»˜ 100%                                                   â”‚
â”‚      â”‚                                                          â”‚
â”‚      â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚     pallet_affiliate::do_distribute_rewards()               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚      â”‚                                                          â”‚
â”‚      â”œâ”€â”€â”€â–¶ é”€æ¯è´¦æˆ· (BurnAccount)      5%                       â”‚
â”‚      â”œâ”€â”€â”€â–¶ å›½åº“è´¦æˆ· (TreasuryAccount)  2%                       â”‚
â”‚      â”œâ”€â”€â”€â–¶ å­˜å‚¨è´¦æˆ· (StorageAccount)   3%                       â”‚
â”‚      â”‚                                                          â”‚
â”‚      â””â”€â”€â”€â–¶ æ¨èé“¾åˆ†é…                  90%                      â”‚
â”‚              â”‚                                                  â”‚
â”‚              â”œâ”€â”€â”€â–¶ ç¬¬1å±‚æ¨èäºº  6%                              â”‚
â”‚              â”œâ”€â”€â”€â–¶ ç¬¬2å±‚æ¨èäºº  6%                              â”‚
â”‚              â”œâ”€â”€â”€â–¶ ç¬¬3å±‚æ¨èäºº  6%                              â”‚
â”‚              â”œâ”€â”€â”€â–¶ ...                                          â”‚
â”‚              â”œâ”€â”€â”€â–¶ ç¬¬15å±‚æ¨èäºº 6%                              â”‚
â”‚              â”‚                                                  â”‚
â”‚              â””â”€â”€â”€â–¶ æ— æ¨èäººéƒ¨åˆ† â†’ å›½åº“                          â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 èµ„é‡‘åˆ†é…æ¯”ä¾‹è¯¦è§£

| æ¥æ”¶æ–¹ | æ¯”ä¾‹ | è¯´æ˜ |
|--------|------|------|
| **é”€æ¯ï¼ˆBurnï¼‰** | 5% | é€šç¼©æœºåˆ¶ï¼Œè½¬å…¥é»‘æ´è´¦æˆ· `0x...dead` |
| **å›½åº“ï¼ˆTreasuryï¼‰** | 2% | å¹³å°è¿è¥èµ„é‡‘ |
| **å­˜å‚¨ï¼ˆStorageï¼‰** | 3% | IPFS å­˜å‚¨è´¹ç”¨ |
| **æ¨èé“¾ï¼ˆAffiliateï¼‰** | 90% | 15å±‚æ¨èé“¾åˆ†é…ï¼Œæ¯å±‚6% |

### 2.3 æ¨èé“¾åˆ†é…æœºåˆ¶

```rust
// å³æ—¶åˆ†æˆæ¯”ä¾‹ï¼ˆ15å±‚ï¼Œæ¯å±‚6%ï¼‰
InstantLevelPercents = [6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6]

// åˆ†é…é€»è¾‘
for level in 1..=15 {
    if let Some(sponsor) = get_sponsor_at_level(buyer, level) {
        transfer(buyer â†’ sponsor, amount * 6%)
    } else {
        transfer(buyer â†’ treasury, amount * 6%)  // æ— æ¨èäººå½’å›½åº“
    }
}
```

### 2.4 å…³é”®ä»£ç ä½ç½®

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `pallets/affiliate/src/distribute.rs` | æ ¸å¿ƒåˆ†é…é€»è¾‘ |
| `pallets/affiliate/src/instant.rs` | å³æ—¶åˆ†æˆå®ç° |
| `runtime/src/configs/mod.rs:1412-1436` | `MemorialOfferingHook` å›è°ƒ |

---

## 3. ç•™è¨€ä»˜è´¹åŠŸèƒ½è®¾è®¡

### 3.1 åŠŸèƒ½æ¶æ„

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç•™è¨€ä»˜è´¹æµç¨‹                                  â”‚
â”‚                                                                 â”‚
â”‚  ç”¨æˆ·è°ƒç”¨ create_text(kind=Message)                              â”‚
â”‚      â”‚                                                          â”‚
â”‚      â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚  1. éªŒè¯é€è€…å­˜åœ¨æ€§                       â”‚                     â”‚
â”‚  â”‚  2. éªŒè¯ç”¨æˆ·æƒé™ï¼ˆå¯è§æ€§æ£€æŸ¥ï¼‰            â”‚                     â”‚
â”‚  â”‚  3. æ£€æŸ¥é¢‘ç‡é™åˆ¶                         â”‚                     â”‚
â”‚  â”‚  4. æ£€æŸ¥ä½™é¢ â‰¥ 10,000 DUST              â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚      â”‚                                                          â”‚
â”‚      â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚  æ”¶å–è´¹ç”¨ 10,000 DUST                    â”‚                     â”‚
â”‚  â”‚  è°ƒç”¨ pallet_affiliate::do_distribute_rewards()             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚      â”‚                                                          â”‚
â”‚      â–¼                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”‚
â”‚  â”‚  åˆ›å»ºç•™è¨€è®°å½•                            â”‚                     â”‚
â”‚  â”‚  è§¦å‘å›è°ƒ OnMessagePaid                  â”‚                     â”‚
â”‚  â”‚  å‘å‡ºäº‹ä»¶ MessagePaid + MessageCreated   â”‚                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ä¸å…è´¹ç•™è¨€çš„å·®å¼‚

| é¡¹ç›® | å…è´¹ç•™è¨€ï¼ˆæ—§ï¼‰ | ä»˜è´¹ç•™è¨€ï¼ˆæ–°ï¼‰ |
|------|---------------|---------------|
| **æŠ¼é‡‘** | 0 DUST | æ— æŠ¼é‡‘æ¦‚å¿µ |
| **è´¹ç”¨** | æ—  | 10,000 DUST |
| **èµ„é‡‘å»å‘** | æ—  | Affiliate åˆ†é… |
| **å—ç›Šè€…** | æ—  | æ¨èé“¾ä¸Šçº¿ |
| **é¢‘ç‡é™åˆ¶** | æœ‰ï¼ˆé˜²åˆ·ï¼‰ | æœ‰ï¼ˆä¿ç•™ï¼‰ |

### 3.3 ä¸šåŠ¡è§„åˆ™

1. **ç•™è¨€ç±»å‹**ï¼šä»… `TextKind::Message` æ”¶è´¹ï¼Œ`TextKind::Article` ä¿æŒå…è´¹
2. **è´¹ç”¨å›ºå®š**ï¼š10,000 DUSTï¼Œä¸æ”¯æŒè‡ªå®šä¹‰é‡‘é¢
3. **å³æ—¶æ‰£æ¬¾**ï¼šåˆ›å»ºç•™è¨€æ—¶ç«‹å³æ‰£è´¹
4. **æ— é€€æ¬¾**ï¼šç•™è¨€åˆ›å»ºåè´¹ç”¨ä¸å¯é€€è¿˜
5. **é¢‘ç‡é™åˆ¶ä¿ç•™**ï¼šæ¯æ—¥/æ¯é€è€…é™åˆ¶ä»ç„¶ç”Ÿæ•ˆ

---

## 4. èµ„é‡‘æµå‘è¯¦ç»†è®¾è®¡

### 4.1 ç•™è¨€è´¹ç”¨åˆ†é…æ–¹æ¡ˆ

ä»¥ **10,000 DUST** ä¸ºä¾‹ï¼š

| æ¥æ”¶æ–¹ | æ¯”ä¾‹ | é‡‘é¢ï¼ˆDUSTï¼‰ | è¯´æ˜ |
|--------|------|-------------|------|
| **é”€æ¯** | 5% | 500 | é€šç¼©æœºåˆ¶ |
| **å›½åº“** | 2% | 200 | å¹³å°è¿è¥ |
| **å­˜å‚¨** | 3% | 300 | IPFS è´¹ç”¨ |
| **æ¨èé“¾** | 90% | 9,000 | 15å±‚åˆ†é… |

### 4.2 æ¨èé“¾è¯¦ç»†åˆ†é…

å‡è®¾ç•™è¨€è€…æœ‰å®Œæ•´çš„15å±‚æ¨èé“¾ï¼š

| å±‚çº§ | æ¯”ä¾‹ | é‡‘é¢ï¼ˆDUSTï¼‰ | æ¥æ”¶è€… |
|------|------|-------------|--------|
| ç¬¬1å±‚ | 6% | 600 | ç›´æ¥æ¨èäºº |
| ç¬¬2å±‚ | 6% | 600 | é—´æ¥æ¨èäºº |
| ç¬¬3å±‚ | 6% | 600 | ... |
| ... | ... | ... | ... |
| ç¬¬15å±‚ | 6% | 600 | ... |
| **åˆè®¡** | 90% | 9,000 | - |

### 4.3 æ— æ¨èäººåœºæ™¯

å¦‚æœç•™è¨€è€…æ²¡æœ‰æ¨èé“¾æˆ–æ¨èé“¾ä¸å®Œæ•´ï¼š

```text
åœºæ™¯1ï¼šæ— ä»»ä½•æ¨èäºº
- 90% (9,000 DUST) å…¨éƒ¨è¿›å…¥å›½åº“

åœºæ™¯2ï¼šä»…æœ‰3å±‚æ¨èäºº
- ç¬¬1-3å±‚ï¼š1,800 DUST (6% Ã— 3) â†’ æ¨èäºº
- ç¬¬4-15å±‚ï¼š7,200 DUST (6% Ã— 12) â†’ å›½åº“
```

### 4.4 èµ„é‡‘æµå‘å›¾

```text
ç•™è¨€è€…ä½™é¢: 50,000 DUST
ç•™è¨€è´¹ç”¨: 10,000 DUST

æ‰£æ¬¾åä½™é¢: 40,000 DUST

èµ„é‡‘åˆ†é…:
â”œâ”€â”€ é”€æ¯è´¦æˆ· (0x...dead)     +500 DUST   (5%)
â”œâ”€â”€ å›½åº“è´¦æˆ· (py/trsry)      +200 DUST   (2%)
â”œâ”€â”€ å­˜å‚¨è´¦æˆ· (py/dstor)      +300 DUST   (3%)
â”‚
â””â”€â”€ æ¨èé“¾ (90%)
    â”œâ”€â”€ L1 æ¨èäºº            +600 DUST
    â”œâ”€â”€ L2 æ¨èäºº            +600 DUST
    â”œâ”€â”€ L3 æ¨èäºº            +600 DUST
    â”œâ”€â”€ ...
    â”œâ”€â”€ L15 æ¨èäºº           +600 DUST
    â””â”€â”€ ç¼ºå¤±å±‚çº§ â†’ å›½åº“      +X DUST

æ€»è®¡: 10,000 DUST âœ“
```

---

## 5. æŠ€æœ¯å®ç°æ–¹æ¡ˆ

### 5.1 ä¿®æ”¹æ–‡ä»¶æ¸…å•

| æ–‡ä»¶ | ä¿®æ”¹å†…å®¹ |
|------|----------|
| `pallets/deceased/src/lib.rs` | Config æ–°å¢é…ç½®é¡¹ |
| `pallets/deceased/src/text.rs` | `create_text` æ·»åŠ æ”¶è´¹é€»è¾‘ |
| `runtime/src/configs/mod.rs` | Runtime é…ç½®å®ç° |
| `pallets/deceased/src/mock.rs` | æµ‹è¯• Mock æ›´æ–° |

### 5.2 Config æ–°å¢é…ç½®é¡¹

```rust
// pallets/deceased/src/lib.rs

#[pallet::config]
pub trait Config: frame_system::Config {
    // ... ç°æœ‰é…ç½® ...

    /// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šç•™è¨€è´¹ç”¨é‡‘é¢ï¼ˆå›ºå®šï¼‰
    /// - é»˜è®¤å€¼ï¼š10,000 DUST
    /// - ä»…å¯¹ Message ç±»å‹æ”¶è´¹
    #[pallet::constant]
    type MessageFee: Get<BalanceOf<Self>>;

    /// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šç•™è¨€è´¹ç”¨åˆ†é…å›è°ƒ
    /// - å¤ç”¨ pallet-affiliate çš„åˆ†é…é€»è¾‘
    type MessageFeeDistributor: MessageFeeDistributor<Self::AccountId, BalanceOf<Self>>;
}
```

### 5.3 æ–°å¢ Trait å®šä¹‰

```rust
// pallets/deceased/src/lib.rs æˆ–å•ç‹¬æ–‡ä»¶

/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šç•™è¨€è´¹ç”¨åˆ†é…å™¨æ¥å£
///
/// ### åŠŸèƒ½è¯´æ˜
/// - å°†ç•™è¨€è´¹ç”¨åˆ†é…åˆ°æ¨èé“¾
/// - ä¸ä¾›å¥‰å“èµ„é‡‘æµå‘ä¸€è‡´
/// - å¤ç”¨ pallet-affiliate å®ç°
pub trait MessageFeeDistributor<AccountId, Balance> {
    /// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šåˆ†é…ç•™è¨€è´¹ç”¨
    ///
    /// ### å‚æ•°
    /// - `payer`: ç•™è¨€è€…ï¼ˆä»˜æ¬¾äººï¼‰
    /// - `deceased_id`: é€è€…IDï¼ˆç”¨äºç¡®å®šå—ç›Šäººï¼‰
    /// - `amount`: è´¹ç”¨é‡‘é¢
    ///
    /// ### è¿”å›
    /// - Ok(distributed): å®é™…åˆ†é…é‡‘é¢
    /// - Err: åˆ†é…å¤±è´¥
    fn distribute_message_fee(
        payer: &AccountId,
        deceased_id: u64,
        amount: Balance,
    ) -> Result<Balance, sp_runtime::DispatchError>;
}
```

### 5.4 ä¿®æ”¹ `create_text` å‡½æ•°

```rust
// pallets/deceased/src/text.rs (æˆ– lib.rs ä¸­çš„æ–‡æœ¬æ¨¡å—)

/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šåˆ›å»ºæ–‡æœ¬ï¼ˆæ”¯æŒä»˜è´¹ç•™è¨€ï¼‰
///
/// ### ä¿®æ”¹è¯´æ˜
/// - 2025-11-26ï¼šMessage ç±»å‹æ–°å¢ä»˜è´¹é€»è¾‘
/// - Article ç±»å‹ä¿æŒå…è´¹
/// - è´¹ç”¨é€šè¿‡ Affiliate ç³»ç»Ÿåˆ†é…
#[pallet::call_index(XX)]
#[pallet::weight(T::WeightInfo::create_text())]
pub fn create_text(
    origin: OriginFor<T>,
    deceased_id: T::DeceasedId,
    kind: u8,  // 0=Article, 1=Message
    cid: BoundedVec<u8, T::MaxTokenLen>,
    title: Option<BoundedVec<u8, T::StringLimit>>,
    summary: Option<BoundedVec<u8, T::StringLimit>>,
) -> DispatchResult {
    let who = ensure_signed(origin)?;

    // 1. éªŒè¯é€è€…å­˜åœ¨
    ensure!(
        DeceasedOf::<T>::contains_key(deceased_id),
        Error::<T>::DeceasedNotFound
    );

    // 2. éªŒè¯å¯è§æ€§/æƒé™
    // ... ç°æœ‰é€»è¾‘ ...

    // 3. æ£€æŸ¥é¢‘ç‡é™åˆ¶ï¼ˆä¿ç•™ï¼‰
    if kind == 1 {  // Message
        Self::check_message_rate_limit(&who, deceased_id)?;
    }

    // ğŸ†• 4. Message ç±»å‹æ”¶è´¹å¤„ç†
    if kind == 1 {  // Message
        let fee = T::MessageFee::get();

        // æ£€æŸ¥ä½™é¢
        ensure!(
            T::Currency::free_balance(&who) >= fee,
            Error::<T>::InsufficientBalance
        );

        // åˆ†é…è´¹ç”¨ï¼ˆå¤ç”¨ Affiliate ç³»ç»Ÿï¼‰
        T::MessageFeeDistributor::distribute_message_fee(
            &who,
            deceased_id.saturated_into(),
            fee,
        )?;

        // å‘å‡ºä»˜è´¹äº‹ä»¶
        Self::deposit_event(Event::MessageFeePaid {
            payer: who.clone(),
            deceased_id,
            amount: fee,
        });
    }

    // 5. åˆ›å»ºæ–‡æœ¬è®°å½•
    // ... ç°æœ‰é€»è¾‘ ...

    // 6. æ›´æ–°ç•™è¨€è®¡æ•°ï¼ˆä¿ç•™ï¼‰
    if kind == 1 {
        Self::increment_message_count(&who, deceased_id);
    }

    // 7. å‘å‡ºåˆ›å»ºäº‹ä»¶
    Self::deposit_event(Event::TextCreated { /* ... */ });

    Ok(())
}
```

### 5.5 Runtime é…ç½®å®ç°

```rust
// runtime/src/configs/mod.rs

// ========== ç•™è¨€ä»˜è´¹é…ç½® ==========
parameter_types! {
    /// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šç•™è¨€è´¹ç”¨é‡‘é¢
    /// - å›ºå®š 10,000 DUST
    /// - ä»… Message ç±»å‹æ”¶è´¹
    pub const MessageFee: Balance = 10_000_000_000_000_000; // 10,000 DUST (10^12 * 10,000)
}

/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šç•™è¨€è´¹ç”¨åˆ†é…å™¨å®ç°
///
/// ### åŠŸèƒ½è¯´æ˜
/// - å¤ç”¨ pallet-affiliate çš„ do_distribute_rewards
/// - èµ„é‡‘æµå‘ä¸ä¾›å¥‰å“å®Œå…¨ä¸€è‡´
/// - æ”¯æŒ15å±‚æ¨èé“¾åˆ†é…
///
/// ### èµ„é‡‘åˆ†é…
/// - é”€æ¯ï¼š5%
/// - å›½åº“ï¼š2%
/// - å­˜å‚¨ï¼š3%
/// - æ¨èé“¾ï¼š90%
pub struct MessageFeeDistributorImpl;

impl pallet_deceased::MessageFeeDistributor<AccountId, Balance>
    for MessageFeeDistributorImpl
{
    fn distribute_message_fee(
        payer: &AccountId,
        _deceased_id: u64,
        amount: Balance,
    ) -> Result<Balance, sp_runtime::DispatchError> {
        // ç›´æ¥è°ƒç”¨ pallet-affiliate çš„åˆ†é…å‡½æ•°
        // èµ„é‡‘æµå‘ä¸ä¾›å¥‰å“å®Œå…¨ä¸€è‡´
        pallet_affiliate::Pallet::<Runtime>::do_distribute_rewards(
            payer,
            amount,
            None,  // æ— æ—¶é•¿å‚æ•°ï¼ˆéå®šæ—¶ä¾›å¥‰ï¼‰
        )
    }
}

// æ›´æ–° pallet-deceased Config å®ç°
impl pallet_deceased::Config for Runtime {
    // ... ç°æœ‰é…ç½® ...

    /// ç•™è¨€è´¹ç”¨é‡‘é¢
    type MessageFee = MessageFee;

    /// ç•™è¨€è´¹ç”¨åˆ†é…å™¨
    type MessageFeeDistributor = MessageFeeDistributorImpl;
}
```

---

## 6. é…ç½®å‚æ•°

### 6.1 Runtime é…ç½®é¡¹

| å‚æ•°å | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|--------|------|--------|------|
| `MessageFee` | `Balance` | 10,000 DUST | ç•™è¨€å›ºå®šè´¹ç”¨ |

### 6.2 ç›¸å…³ä¾èµ–é…ç½®

| å‚æ•°å | æ¥æº | å€¼ | è¯´æ˜ |
|--------|------|-----|------|
| `BurnAccount` | `pallet-affiliate` | `0x...dead` | é”€æ¯è´¦æˆ· |
| `TreasuryAccount` | `pallet-treasury` | `py/trsry` | å›½åº“è´¦æˆ· |
| `StorageAccount` | `pallet-storage-treasury` | `py/dstor` | å­˜å‚¨è´¦æˆ· |
| `InstantLevelPercents` | `pallet-affiliate` | `[6,6,...,6]` | 15å±‚åˆ†æˆæ¯”ä¾‹ |

---

## 7. æ¥å£è®¾è®¡

### 7.1 Extrinsic æ¥å£

#### `create_text`ï¼ˆä¿®æ”¹ï¼‰

```rust
/// åˆ›å»ºæ–‡æœ¬ï¼ˆæ–‡ç« /ç•™è¨€ï¼‰
///
/// ### å‚æ•°
/// - `deceased_id`: é€è€…ID
/// - `kind`: ç±»å‹ï¼ˆ0=Articleå…è´¹, 1=Messageæ”¶è´¹10000 DUSTï¼‰
/// - `cid`: å†…å®¹CID
/// - `title`: æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰
/// - `summary`: æ‘˜è¦ï¼ˆå¯é€‰ï¼‰
///
/// ### æ”¶è´¹è¯´æ˜
/// - kind=0 (Article): å…è´¹
/// - kind=1 (Message): æ”¶å– 10,000 DUST
///
/// ### é”™è¯¯ç 
/// - `InsufficientBalance`: ä½™é¢ä¸è¶³
/// - `DeceasedNotFound`: é€è€…ä¸å­˜åœ¨
/// - `DailyMessageLimitExceeded`: è¶…è¿‡æ¯æ—¥é™åˆ¶
```

### 7.2 RPC æŸ¥è¯¢æ¥å£ï¼ˆå¯é€‰ï¼‰

```rust
/// æŸ¥è¯¢ç•™è¨€è´¹ç”¨
fn get_message_fee() -> Balance;

/// æŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å¯ä»¥åˆ›å»ºç•™è¨€ï¼ˆä½™é¢+é¢‘ç‡æ£€æŸ¥ï¼‰
fn can_create_message(who: AccountId, deceased_id: u64) -> bool;
```

---

## 8. äº‹ä»¶è®¾è®¡

### 8.1 æ–°å¢äº‹ä»¶

```rust
#[pallet::event]
pub enum Event<T: Config> {
    // ... ç°æœ‰äº‹ä»¶ ...

    /// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šç•™è¨€è´¹ç”¨å·²æ”¯ä»˜
    ///
    /// ### å‚æ•°
    /// - `payer`: ä»˜æ¬¾äºº
    /// - `deceased_id`: é€è€…ID
    /// - `amount`: æ”¯ä»˜é‡‘é¢
    MessageFeePaid {
        payer: T::AccountId,
        deceased_id: T::DeceasedId,
        amount: BalanceOf<T>,
    },
}
```

### 8.2 äº‹ä»¶è§¦å‘æ—¶åº

```text
1. MessageFeePaid          // è´¹ç”¨æ”¯ä»˜æˆåŠŸ
2. TextCreated             // ç•™è¨€åˆ›å»ºæˆåŠŸ
3. (Affiliateäº‹ä»¶)         // åˆ†é…ç›¸å…³äº‹ä»¶ï¼ˆå¯é€‰ç›‘å¬ï¼‰
```

---

## 9. æµ‹è¯•ç”¨ä¾‹

### 9.1 å•å…ƒæµ‹è¯•

```rust
// pallets/deceased/src/tests.rs

/// Test: ç•™è¨€æ”¶è´¹æ­£å¸¸æµç¨‹
#[test]
fn message_fee_paid_successfully() {
    new_test_ext().execute_with(|| {
        // å‡†å¤‡
        let user = 1;
        let initial_balance = 50_000 * DUST;
        set_balance(user, initial_balance);
        create_deceased(user, deceased_id);

        // æ‰§è¡Œ
        assert_ok!(Deceased::create_text(
            RuntimeOrigin::signed(user),
            deceased_id,
            1,  // Message
            cid.clone(),
            None,
            None,
        ));

        // éªŒè¯
        // 1. ä½™é¢å‡å°‘ 10,000 DUST
        assert_eq!(
            Balances::free_balance(user),
            initial_balance - 10_000 * DUST
        );

        // 2. äº‹ä»¶è§¦å‘
        assert_event_emitted!(Event::MessageFeePaid { ... });
        assert_event_emitted!(Event::TextCreated { ... });
    });
}

/// Test: ä½™é¢ä¸è¶³æ— æ³•åˆ›å»ºç•™è¨€
#[test]
fn message_fee_insufficient_balance() {
    new_test_ext().execute_with(|| {
        let user = 1;
        set_balance(user, 5_000 * DUST);  // ä¸è¶³ 10,000

        assert_noop!(
            Deceased::create_text(
                RuntimeOrigin::signed(user),
                deceased_id,
                1,  // Message
                cid.clone(),
                None,
                None,
            ),
            Error::<Test>::InsufficientBalance
        );
    });
}

/// Test: Article ç±»å‹å…è´¹
#[test]
fn article_is_free() {
    new_test_ext().execute_with(|| {
        let user = 1;
        let initial_balance = 50_000 * DUST;
        set_balance(user, initial_balance);

        assert_ok!(Deceased::create_text(
            RuntimeOrigin::signed(user),
            deceased_id,
            0,  // Article
            cid.clone(),
            Some(title),
            Some(summary),
        ));

        // ä½™é¢ä¸å˜
        assert_eq!(Balances::free_balance(user), initial_balance);
    });
}

/// Test: èµ„é‡‘åˆ†é…æ¯”ä¾‹æ­£ç¡®
#[test]
fn message_fee_distribution_correct() {
    new_test_ext().execute_with(|| {
        let user = 1;
        let sponsor = 2;  // æ¨èäºº

        // è®¾ç½®æ¨èå…³ç³»
        bind_sponsor(user, sponsor);

        let fee = 10_000 * DUST;
        let initial_burn = Balances::free_balance(BURN_ACCOUNT);
        let initial_treasury = Balances::free_balance(TREASURY_ACCOUNT);
        let initial_storage = Balances::free_balance(STORAGE_ACCOUNT);
        let initial_sponsor = Balances::free_balance(sponsor);

        // åˆ›å»ºç•™è¨€
        assert_ok!(Deceased::create_text(...));

        // éªŒè¯åˆ†é…
        // é”€æ¯ 5%
        assert_eq!(
            Balances::free_balance(BURN_ACCOUNT),
            initial_burn + 500 * DUST
        );

        // å›½åº“ 2%
        assert_eq!(
            Balances::free_balance(TREASURY_ACCOUNT),
            initial_treasury + 200 * DUST
        );

        // å­˜å‚¨ 3%
        assert_eq!(
            Balances::free_balance(STORAGE_ACCOUNT),
            initial_storage + 300 * DUST
        );

        // æ¨èäºº 6% (ç¬¬1å±‚)
        assert_eq!(
            Balances::free_balance(sponsor),
            initial_sponsor + 600 * DUST
        );
    });
}
```

---

## 10. å®æ–½è®¡åˆ’

### 10.1 å·¥ä½œåˆ†è§£

| ä»»åŠ¡ | å·¥æœŸ | ä¼˜å…ˆçº§ |
|------|------|--------|
| 1. Config æ–°å¢é…ç½®é¡¹ | 0.5h | P0 |
| 2. å®šä¹‰ MessageFeeDistributor trait | 0.5h | P0 |
| 3. ä¿®æ”¹ create_text æ·»åŠ æ”¶è´¹é€»è¾‘ | 2h | P0 |
| 4. Runtime é…ç½®å®ç° | 1h | P0 |
| 5. æ–°å¢äº‹ä»¶å®šä¹‰ | 0.5h | P1 |
| 6. æ›´æ–° Mock æµ‹è¯•ç¯å¢ƒ | 1h | P1 |
| 7. ç¼–å†™æµ‹è¯•ç”¨ä¾‹ | 2h | P1 |
| 8. ç¼–è¯‘éªŒè¯ | 0.5h | P0 |

**æ€»å·¥æœŸ**ï¼šçº¦ **1 å¤©**

### 10.2 ä¾èµ–å…³ç³»

```text
pallet-affiliate (å·²å®Œæˆ)
    â”‚
    â””â”€â”€â–¶ pallet-deceased (æœ¬æ¬¡ä¿®æ”¹)
             â”‚
             â”œâ”€â”€ Config æ–°å¢
             â”œâ”€â”€ create_text ä¿®æ”¹
             â””â”€â”€ Runtime é…ç½®
```

### 10.3 é£é™©è¯„ä¼°

| é£é™© | ç­‰çº§ | åº”å¯¹æªæ–½ |
|------|------|----------|
| ç”¨æˆ·ä½™é¢ä¸è¶³ | ä½ | å‰ç«¯æå‰æ£€æŸ¥å¹¶æç¤º |
| æ¨èé“¾ä¸å®Œæ•´ | ä½ | ç¼ºå¤±å±‚çº§è‡ªåŠ¨å½’å›½åº“ |
| é¢‘ç¹ä»˜è´¹æ”»å‡» | ä¸­ | ä¿ç•™é¢‘ç‡é™åˆ¶æœºåˆ¶ |

### 10.4 å›æ»šæ–¹æ¡ˆ

å¦‚éœ€ç´§æ€¥å›æ»šï¼Œå¯é€šè¿‡ Runtime å‡çº§ï¼š

```rust
// ä¸´æ—¶ç¦ç”¨æ”¶è´¹
pub const MessageFee: Balance = 0;  // æ”¹ä¸º0å³å…è´¹
```

---

## é™„å½•

### A. ç›¸å…³ä»£ç ä½ç½®

| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `pallets/affiliate/src/distribute.rs` | æ ¸å¿ƒåˆ†é…é€»è¾‘ |
| `pallets/deceased/src/lib.rs` | é€è€…ä¸»æ¨¡å— |
| `runtime/src/configs/mod.rs` | Runtime é…ç½® |

### B. èµ„é‡‘è´¦æˆ·åœ°å€

| è´¦æˆ· | PalletId | ç”¨é€” |
|------|----------|------|
| é”€æ¯è´¦æˆ· | `0x...dead` | é€šç¼©é”€æ¯ |
| å›½åº“è´¦æˆ· | `py/trsry` | å¹³å°è¿è¥ |
| å­˜å‚¨è´¦æˆ· | `py/dstor` | IPFS è´¹ç”¨ |

### C. å‚è€ƒæ–‡æ¡£

- [pallet-affiliate README](../pallets/affiliate/README.md)
- [ä¾›å¥‰å“ç³»ç»Ÿè®¾è®¡](./ä¾›å¥‰å“ç³»ç»Ÿè®¾è®¡.md)
- [æŠ¼é‡‘æœºåˆ¶æ”¹é©åˆ†ææŠ¥å‘Š](./æŠ¼é‡‘æœºåˆ¶æ”¹é©åˆ†ææŠ¥å‘Š.md)

---

**æ–‡æ¡£æ—¥æœŸ**ï¼š2025-11-26
**ç‰ˆæœ¬**ï¼š1.0
**ä¸‹æ¬¡å®¡æŸ¥**ï¼šå®æ–½å‰
