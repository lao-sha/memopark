# æ€§èƒ½ä¼˜åŒ–å»ºè®®

## ğŸš€ Substrate ä¼˜åŒ–

### 1. Pallet ä¼˜åŒ–

#### å­˜å‚¨ä¼˜åŒ–
```rust
// âŒ ä¸å¥½ï¼šæ¯æ¬¡éƒ½è¯»å–æ•´ä¸ªç»“æ„
let strategy = AIStrategies::<T>::get(id).unwrap();
strategy.status = StrategyStatus::Active;
AIStrategies::<T>::insert(id, strategy);

// âœ… å¥½ï¼šåªæ›´æ–°éœ€è¦çš„å­—æ®µ
AIStrategies::<T>::mutate(id, |strategy_opt| {
    if let Some(strategy) = strategy_opt {
        strategy.status = StrategyStatus::Active;
    }
});
```

#### é¿å…å¾ªç¯è¯»å–å­˜å‚¨
```rust
// âŒ ä¸å¥½
for id in 0..NextBridgeId::<T>::get() {
    if let Some(request) = BridgeRequests::<T>::get(id) {
        // å¤„ç†...
    }
}

// âœ… å¥½ï¼šä½¿ç”¨è¿­ä»£å™¨
BridgeRequests::<T>::iter()
    .filter(|(_, req)| req.status == BridgeStatus::Pending)
    .take(100) // é™åˆ¶æ•°é‡
    .for_each(|(id, request)| {
        // å¤„ç†...
    });
```

#### ä½¿ç”¨ BoundedVec è€Œé Vec
```rust
// âœ… é™åˆ¶å¤§å°ï¼Œé¿å…æ— é™å¢é•¿
pub type Description = BoundedVec<u8, ConstU32<256>>;
```

### 2. OCW ä¼˜åŒ–

#### æ‰¹é‡å¤„ç†
```rust
// ä¸€æ¬¡å¤„ç†å¤šä¸ªè¯·æ±‚
let pending_requests: Vec<_> = BridgeRequests::<T>::iter()
    .filter(|(_, req)| req.status == BridgeStatus::Pending)
    .take(10) // æ¯æ¬¡æœ€å¤šå¤„ç† 10 ä¸ª
    .collect();

for (id, request) in pending_requests {
    // å¤„ç†...
}
```

#### HTTP è¯·æ±‚ä¼˜åŒ–
```rust
// ä½¿ç”¨è¿æ¥æ± 
// è®¾ç½®åˆç†çš„è¶…æ—¶æ—¶é—´
let deadline = sp_io::offchain::timestamp().add(Duration::from_millis(5_000));
let response = request.deadline(deadline).send()?;
```

#### ç¼“å­˜å¸¸ç”¨æ•°æ®
```rust
// ç¼“å­˜ Arbitrum æ¡¥æ¥åœ°å€ï¼Œé¿å…æ¯æ¬¡è¯»å–
static CACHED_BRIDGE_ADDRESS: OnceCell<EthAddress> = OnceCell::new();

fn get_bridge_address<T: Config>() -> Option<EthAddress> {
    CACHED_BRIDGE_ADDRESS.get_or_init(|| {
        ArbitrumBridgeAddress::<T>::get()
    }).clone()
}
```

### 3. Runtime ä¼˜åŒ–

#### æƒé‡ä¼˜åŒ–
```rust
// ç²¾ç¡®æµ‹é‡æ¯ä¸ª extrinsic çš„æƒé‡
#[pallet::weight(10_000 + T::DbWeight::get().reads_writes(2, 1))]
pub fn bridge_to_arbitrum(
    origin: OriginFor<T>,
    amount: BalanceOf<T>,
    eth_address: Vec<u8>,
) -> DispatchResult {
    // ...
}
```

#### æ‰¹é‡æ“ä½œ
```rust
// æä¾›æ‰¹é‡æ“ä½œæ¥å£
#[pallet::weight(10_000 * items.len() as u64)]
pub fn batch_update_nav(
    origin: OriginFor<T>,
    updates: Vec<(u64, BalanceOf<T>)>,
) -> DispatchResult {
    // ...
}
```

## âš™ï¸ æ™ºèƒ½åˆçº¦ä¼˜åŒ–

### 1. Gas ä¼˜åŒ–

#### ä½¿ç”¨ `unchecked` å—ï¼ˆSolidity 0.8+ï¼‰
```solidity
// åœ¨ç¡®ä¿ä¸ä¼šæº¢å‡ºæ—¶ä½¿ç”¨
function batchMint(address[] calldata recipients, uint256[] calldata amounts) external {
    unchecked {
        for (uint256 i = 0; i < recipients.length; ++i) {
            _mint(recipients[i], amounts[i]);
        }
    }
}
```

#### æ‰“åŒ…å˜é‡
```solidity
// âŒ ä¸å¥½ï¼šæ¯ä¸ªå˜é‡å ä¸€ä¸ª slot
bool paused;        // slot 0
uint256 totalSupply;  // slot 1
address owner;      // slot 2

// âœ… å¥½ï¼šæ‰“åŒ…åˆ°åŒä¸€ä¸ª slot
bool paused;        // slot 0 (1 byte)
address owner;      // slot 0 (20 bytes)
uint96 totalSupply;   // slot 0 (12 bytes) - å¦‚æœå¤Ÿç”¨çš„è¯
```

#### ä½¿ç”¨ `calldata` è€Œé `memory`
```solidity
// âŒ ä¸å¥½
function process(uint256[] memory data) external {
    // ...
}

// âœ… å¥½
function process(uint256[] calldata data) external {
    // ...
}
```

#### ç¼“å­˜å­˜å‚¨å˜é‡
```solidity
// âŒ ä¸å¥½ï¼šå¤šæ¬¡è¯»å–å­˜å‚¨
function calculate() public view returns (uint256) {
    return totalSupply * sharePrice / 1e18;
}

// âœ… å¥½ï¼šç¼“å­˜åˆ°å†…å­˜
function calculate() public view returns (uint256) {
    uint256 _totalSupply = totalSupply;
    uint256 _sharePrice = sharePrice;
    return _totalSupply * _sharePrice / 1e18;
}
```

### 2. åˆçº¦å¤§å°ä¼˜åŒ–

#### ä½¿ç”¨åº“
```solidity
// å°†å¸¸ç”¨é€»è¾‘æå–åˆ°åº“
library MathLib {
    function calculateShares(
        uint256 amount,
        uint256 totalSupply,
        uint256 nav
    ) internal pure returns (uint256) {
        // ...
    }
}
```

#### åˆ é™¤æœªä½¿ç”¨çš„ä»£ç 
```bash
# ä½¿ç”¨ solidity-coverage æ£€æŸ¥ä»£ç è¦†ç›–ç‡
npx hardhat coverage

# åˆ é™¤æœªä½¿ç”¨çš„å‡½æ•°å’Œå˜é‡
```

#### ä¼˜åŒ–é”™è¯¯ä¿¡æ¯
```solidity
// âŒ ä¸å¥½ï¼šé•¿å­—ç¬¦ä¸²æ¶ˆè€— gas
require(amount > 0, "The amount must be greater than zero");

// âœ… å¥½ï¼šçŸ­å­—ç¬¦ä¸²
require(amount > 0, "Amount must be > 0");

// âœ… æ›´å¥½ï¼šä½¿ç”¨è‡ªå®šä¹‰é”™è¯¯ï¼ˆSolidity 0.8.4+ï¼‰
error AmountTooSmall();
if (amount == 0) revert AmountTooSmall();
```

### 3. æ‰¹é‡æ“ä½œ

```solidity
// æä¾›æ‰¹é‡æ¥å£å‡å°‘äº¤æ˜“æ¬¡æ•°
function batchDeposit(uint256[] calldata amounts) external {
    uint256 totalAmount;
    for (uint256 i = 0; i < amounts.length; ++i) {
        totalAmount += amounts[i];
    }
    usdc.transferFrom(msg.sender, address(this), totalAmount);
    // ...
}
```

## ğŸ—„ æ•°æ®åº“ä¼˜åŒ–

### 1. ç´¢å¼•ä¼˜åŒ–

```sql
-- ä¸ºå¸¸ç”¨æŸ¥è¯¢å­—æ®µæ·»åŠ ç´¢å¼•
CREATE INDEX idx_bridge_status ON bridge_requests(status);
CREATE INDEX idx_bridge_created ON bridge_requests(created_at DESC);
CREATE INDEX idx_user_requests ON bridge_requests(user_id, created_at DESC);
```

### 2. æŸ¥è¯¢ä¼˜åŒ–

```sql
-- âŒ ä¸å¥½ï¼šæŸ¥è¯¢æ‰€æœ‰å­—æ®µ
SELECT * FROM bridge_requests WHERE status = 'pending';

-- âœ… å¥½ï¼šåªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
SELECT id, amount, target_address FROM bridge_requests 
WHERE status = 'pending' 
LIMIT 100;
```

### 3. åˆ†é¡µæŸ¥è¯¢

```rust
// ä½¿ç”¨ offset å’Œ limit
let page_size = 20;
let offset = (page - 1) * page_size;

let requests = BridgeRequests::<T>::iter()
    .skip(offset)
    .take(page_size)
    .collect();
```

## ğŸŒ ç½‘ç»œä¼˜åŒ–

### 1. RPC ä¼˜åŒ–

#### æ‰¹é‡ RPC è°ƒç”¨
```javascript
// âŒ ä¸å¥½ï¼šå¤šæ¬¡å•ç‹¬è°ƒç”¨
const balance1 = await api.query.system.account(addr1);
const balance2 = await api.query.system.account(addr2);
const balance3 = await api.query.system.account(addr3);

// âœ… å¥½ï¼šæ‰¹é‡è°ƒç”¨
const balances = await api.query.system.account.multi([addr1, addr2, addr3]);
```

#### ä½¿ç”¨ WebSocket è€Œé HTTP
```javascript
// WebSocket ä¿æŒè¿æ¥ï¼Œå‡å°‘æ¡æ‰‹å¼€é”€
const wsProvider = new WsProvider('wss://rpc.stardust.network');
const api = await ApiPromise.create({ provider: wsProvider });
```

### 2. IPFS ä¼˜åŒ–

#### ä½¿ç”¨ä¸“ç”¨èŠ‚ç‚¹
- éƒ¨ç½²ç§æœ‰ IPFS èŠ‚ç‚¹
- é…ç½®æœ¬åœ°ç¼“å­˜
- ä½¿ç”¨ IPFS é›†ç¾¤æé«˜å¯ç”¨æ€§

#### Pin é‡è¦æ•°æ®
```bash
# Pin å¸¸ç”¨çš„ CID
ipfs pin add QmXxx...
```

## ğŸ“Š ç›‘æ§å’Œåˆ†æ

### 1. æ€§èƒ½æŒ‡æ ‡

**Substrate**:
- åŒºå—ç”Ÿæˆæ—¶é—´
- äº¤æ˜“ååé‡ï¼ˆTPSï¼‰
- Extrinsic æƒé‡
- å­˜å‚¨å¢é•¿ç‡

**æ™ºèƒ½åˆçº¦**:
- Gas æ¶ˆè€—ç»Ÿè®¡
- åˆçº¦è°ƒç”¨é¢‘ç‡
- äº¤æ˜“æˆåŠŸç‡
- å¹³å‡ç¡®è®¤æ—¶é—´

### 2. åˆ†æå·¥å…·

```bash
# Substrate Benchmark
cargo build --release --features runtime-benchmarks
./target/release/stardust-node benchmark pallet \
  --pallet pallet_dust_bridge \
  --extrinsic '*' \
  --steps 50 \
  --repeat 20

# Hardhat Gas Reporter
npx hardhat test --gas-reporter

# Solidity Profiler
npm install --save-dev hardhat-contract-sizer
npx hardhat size-contracts
```

## ğŸ¯ ä¼˜åŒ–ä¼˜å…ˆçº§

### é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³æ‰§è¡Œï¼‰
1. âœ… ä¿®å¤æ˜æ˜¾çš„æ€§èƒ½ç“¶é¢ˆ
2. âœ… ä¼˜åŒ–é«˜é¢‘æ“ä½œçš„ gas æ¶ˆè€—
3. âœ… æ·»åŠ å¿…è¦çš„ç´¢å¼•

### ä¸­ä¼˜å…ˆçº§ï¼ˆ2å‘¨å†…ï¼‰
4. â­ å®ç°æ‰¹é‡æ“ä½œ
5. â­ ä¼˜åŒ– OCW å¤„ç†é€»è¾‘
6. â­ ä¼˜åŒ–å­˜å‚¨è¯»å†™

### ä½ä¼˜å…ˆçº§ï¼ˆ1ä¸ªæœˆå†…ï¼‰
7. â­ ä»£ç é‡æ„
8. â­ é•¿æœŸç›‘æ§å’Œè°ƒä¼˜
9. â­ æ¢ç´¢æ–°çš„ä¼˜åŒ–æŠ€æœ¯

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

ä¼˜åŒ–åé¢„æœŸæ”¹è¿›:

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹è¿› |
|---|---|---|---|
| æ¡¥æ¥ gas | 150k | 100k | -33% |
| å­˜æ¬¾ gas | 200k | 140k | -30% |
| OCW å¤„ç†æ—¶é—´ | 120s | 60s | -50% |
| TPS | 50 | 100 | +100% |
| æ•°æ®åº“æŸ¥è¯¢ | 500ms | 100ms | -80% |

## âœ… ä¼˜åŒ–æ£€æŸ¥æ¸…å•

- [ ] Substrate pallet ä»£ç å®¡æŸ¥
- [ ] æ™ºèƒ½åˆçº¦ gas ä¼˜åŒ–
- [ ] æ•°æ®åº“ç´¢å¼•æ·»åŠ 
- [ ] OCW æ‰¹é‡å¤„ç†å®ç°
- [ ] RPC è°ƒç”¨ä¼˜åŒ–
- [ ] æ€§èƒ½åŸºå‡†æµ‹è¯•
- [ ] ç›‘æ§æŒ‡æ ‡é…ç½®
- [ ] æ–‡æ¡£æ›´æ–°

---

**æ³¨æ„**: æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹ã€‚å®šæœŸå›é¡¾å’Œæ”¹è¿›ã€‚

