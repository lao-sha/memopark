# æŠ¼é‡‘æ‰˜ç®¡ç»Ÿä¸€åŒ– - æ‰§è¡Œæ¸…å•

> åŸºäºã€ŠæŠ¼é‡‘æ‰˜ç®¡ç»Ÿä¸€åŒ–åˆ†ææŠ¥å‘Šã€‹çš„å…·ä½“æ‰§è¡Œæ­¥éª¤

## ğŸ“‹ ä»»åŠ¡æ€»è§ˆ

- [x] **å®¡æŸ¥ pallet-deposits ä½¿ç”¨æƒ…å†µ** âœ… å·²å®Œæˆ
- [x] **è®¾è®¡ Escrow æ‰©å±•åŠŸèƒ½** âœ… å·²å®Œæˆ  
- [x] **åˆ¶å®šæ•°æ®è¿ç§»æ–¹æ¡ˆ** âœ… å·²å®Œæˆ
- [ ] **æ‰§è¡Œå½’æ¡£æ“ä½œ** â¸ï¸ å¾…æ‰§è¡Œ
- [ ] **ç¼–è¯‘æµ‹è¯•éªŒè¯** â¸ï¸ å¾…æ‰§è¡Œ
- [ ] **æ›´æ–°å‰ç«¯æ–‡æ¡£** â¸ï¸ å¾…æ‰§è¡Œ

---

## ğŸš€ Phase 1ï¼šç«‹å³æ‰§è¡Œï¼ˆé›¶é£é™©ï¼‰

### ä»»åŠ¡ 1.1ï¼šå½’æ¡£ pallet-deposits

**é¢„è®¡æ—¶é—´**ï¼š10åˆ†é’Ÿ  
**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½

#### è‡ªåŠ¨åŒ–æ‰§è¡Œï¼ˆæ¨èï¼‰

```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
cd /home/xiaodong/æ–‡æ¡£/stardust
./scripts/archive-pallet-deposits.sh
```

**è„šæœ¬åŠŸèƒ½**ï¼š
- âœ… å°† `pallets/deposits` ç§»è‡³ `archived-pallets/deposits`
- âœ… æ³¨é‡Š Runtime é…ç½®ï¼ˆè‡ªåŠ¨å¤‡ä»½ï¼‰
- âœ… æ³¨é‡Š Cargo.toml ä¾èµ–
- âœ… æ¸…ç†ç¼–è¯‘ç¼“å­˜

#### æ‰‹åŠ¨æ‰§è¡Œï¼ˆå¤‡é€‰ï¼‰

```bash
# 1. ç§»åŠ¨æ¨¡å—
mkdir -p archived-pallets
mv pallets/deposits archived-pallets/

# 2. ç¼–è¾‘ runtime/src/lib.rsï¼ˆæ³¨é‡Šä»¥ä¸‹è¡Œï¼‰
# #[runtime::pallet_index(52)]
# pub type Deposits = pallet_deposits;

# 3. ç¼–è¾‘ runtime/src/configs/mod.rsï¼ˆæ³¨é‡Šä»¥ä¸‹å—ï¼‰
# impl pallet_deposits::Config for Runtime {
#     ...
# }

# 4. ç¼–è¾‘ runtime/Cargo.tomlï¼ˆæ³¨é‡Šä»¥ä¸‹è¡Œï¼‰
# pallet-deposits = { path = "../pallets/deposits", default-features = false }

# 5. ç¼–è¾‘æ ¹ Cargo.tomlï¼ˆæ³¨é‡Šä»¥ä¸‹è¡Œï¼‰
# "pallets/deposits",

# 6. æ¸…ç†ç¼“å­˜
cargo clean
```

### ä»»åŠ¡ 1.2ï¼šç¼–è¯‘éªŒè¯

**é¢„è®¡æ—¶é—´**ï¼š5-10åˆ†é’Ÿ  
**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½

```bash
# ç¼–è¯‘ Runtime
cargo build --release -p stardust-runtime

# é¢„æœŸç»“æœï¼šæˆåŠŸç¼–è¯‘ï¼Œæ—  pallet-deposits ç›¸å…³é”™è¯¯
```

**æ£€æŸ¥ç‚¹**ï¼š
- âœ… ç¼–è¯‘æ— é”™è¯¯
- âœ… æ—  `pallet_deposits` æœªæ‰¾åˆ°çš„è­¦å‘Š
- âœ… Runtime å¤§å°æ­£å¸¸

### ä»»åŠ¡ 1.3ï¼šæ›´æ–°æ–‡æ¡£

**é¢„è®¡æ—¶é—´**ï¼š5åˆ†é’Ÿ  
**é£é™©ç­‰çº§**ï¼šğŸŸ¢ ä½

**æ£€æŸ¥æ¸…å•**ï¼š
- [x] `archived-pallets/deposits/ARCHIVED.md` - âœ… å·²åˆ›å»º
- [ ] `docs/æŠ¼é‡‘æ‰˜ç®¡ç»Ÿä¸€åŒ–åˆ†ææŠ¥å‘Š.md` - âœ… å·²åˆ›å»º
- [ ] `README.md` - æ·»åŠ å½’æ¡£è¯´æ˜ï¼ˆå¯é€‰ï¼‰

### ä»»åŠ¡ 1.4ï¼šæäº¤ä»£ç 

```bash
# æŸ¥çœ‹å˜æ›´
git status

# æ·»åŠ å˜æ›´
git add .

# æäº¤
git commit -m "chore: å½’æ¡£ pallet-deposits

- ç§»é™¤ Runtime ä¸­çš„ pallet-deposits é…ç½®
- å°†æ¨¡å—ç§»è‡³ archived-pallets/deposits/
- æ·»åŠ  ARCHIVED.md å½’æ¡£è¯´æ˜
- åŸå› ï¼šå·²è¢« Holds API æ›¿ä»£ï¼Œæ— å®é™…ä½¿ç”¨

å‚è€ƒï¼šdocs/æŠ¼é‡‘æ‰˜ç®¡ç»Ÿä¸€åŒ–åˆ†ææŠ¥å‘Š.md"

# æ¨é€ï¼ˆå¯é€‰ï¼‰
# git push origin cleanup/frontend-redundancy
```

---

## ğŸ”§ Phase 2ï¼šæŒ‰éœ€æ‰§è¡Œï¼ˆå¯é€‰ï¼‰

### ä»»åŠ¡ 2.1ï¼šæ‰©å±• pallet-escrowï¼ˆä»…å½“éœ€è¦ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- âœ… åšå¸‚å•†ä¿è¯é‡‘éœ€è¦ç½šæ²¡åŠŸèƒ½
- âœ… å…¶ä»–ä¸šåŠ¡éœ€è¦"å†»ç»“åœ¨ç”¨æˆ·è´¦æˆ·"çš„æŠ¼é‡‘

**ä¸é€‚ç”¨åœºæ™¯**ï¼š
- âŒ ç”³è¯‰æŠ¼é‡‘ï¼ˆåº”ä½¿ç”¨ Holds APIï¼‰
- âŒ å®¡æ ¸æŠ¼é‡‘ï¼ˆåº”ä½¿ç”¨ Holds APIï¼‰

#### å†³ç­–æµç¨‹

```text
éœ€è¦æŠ¼é‡‘åŠŸèƒ½ï¼Ÿ
  â”œâ”€ No â”€â”€> æ— éœ€æ“ä½œ âœ…
  â””â”€ Yes â”€â”€> æ˜¯å¦éœ€è¦"å†»ç»“åœ¨ç”¨æˆ·è´¦æˆ·"ï¼Ÿ
       â”œâ”€ No â”€â”€> ä½¿ç”¨ç°æœ‰ Escrow::lock_from() âœ…
       â””â”€ Yes â”€â”€> æ˜¯å¦éœ€è¦ç½šæ²¡åŠŸèƒ½ï¼Ÿ
            â”œâ”€ No â”€â”€> ä½¿ç”¨ Holds API âœ…
            â””â”€ Yes â”€â”€> æ‰©å±• pallet-escrow âš ï¸ï¼ˆå‚è€ƒä¸‹æ–¹å®æ–½æ­¥éª¤ï¼‰
```

#### å®æ–½æ­¥éª¤ï¼ˆå¦‚éœ€è¦ï¼‰

**é¢„è®¡æ—¶é—´**ï¼š1-2å¤©  
**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­

1. **æ·»åŠ  DepositPurpose æšä¸¾**

```bash
# ç¼–è¾‘ pallets/escrow/src/lib.rs
# å‚è€ƒï¼šdocs/æŠ¼é‡‘æ‰˜ç®¡ç»Ÿä¸€åŒ–åˆ†ææŠ¥å‘Š.md ç¬¬2.2èŠ‚
```

2. **æ·»åŠ  reserve_deposit() å‡½æ•°**

```rust
// å‚è€ƒæŠ¥å‘Šä¸­çš„ç¤ºä¾‹ä»£ç 
pub fn reserve_deposit(
    who: &T::AccountId,
    id: u64,
    amount: BalanceOf<T>,
    purpose: DepositPurpose,
) -> DispatchResult {
    // ... å®ç°ä»£ç 
}
```

3. **æ·»åŠ  release_deposit() å‡½æ•°**
4. **æ·»åŠ  slash_deposit() å‡½æ•°**
5. **æ·»åŠ å•å…ƒæµ‹è¯•**

```bash
# è¿è¡Œæµ‹è¯•
cargo test -p pallet-escrow
```

6. **æ›´æ–° README**

```bash
# ç¼–è¾‘ pallets/escrow/README.md
# æ·»åŠ æŠ¼é‡‘ç®¡ç†åŠŸèƒ½è¯´æ˜
```

### ä»»åŠ¡ 2.2ï¼šè¿ç§» pallet-trading åšå¸‚å•†æŠ¼é‡‘

**å‰ç½®æ¡ä»¶**ï¼šå·²å®Œæˆä»»åŠ¡ 2.1

**é¢„è®¡æ—¶é—´**ï¼š2å¤©  
**é£é™©ç­‰çº§**ï¼šğŸŸ¡ ä¸­

#### å®æ–½æ­¥éª¤

1. **æ›´æ–° pallet-trading Config**

```rust
// pallets/trading/src/lib.rs
#[pallet::config]
pub trait Config: frame_system::Config {
    // æ–°å¢ï¼šæŠ¼é‡‘ç®¡ç†å™¨
    type DepositManager: pallet_escrow::DepositManager<
        Self::AccountId,
        BalanceOf<Self>,
    >;
    
    // æ–°å¢ï¼šå›½åº“è´¦æˆ·
    #[pallet::constant]
    type TreasuryAccount: Get<Self::AccountId>;
}
```

2. **ä¿®æ”¹æŠ¼é‡‘é”å®šé€»è¾‘**

```rust
// pallets/trading/src/maker.rs
pub fn do_lock_deposit<T: Config>(who: &T::AccountId) -> DispatchResult {
    let deposit = T::MakerDepositAmount::get();
    let maker_id = NextMakerId::<T>::get();
    
    // ã€æ—§ã€‘ä½¿ç”¨ Currency::reserve
    // <T as Config>::Currency::reserve(who, deposit)?;
    
    // ã€æ–°ã€‘ä½¿ç”¨ DepositManager
    T::DepositManager::reserve_deposit(
        who,
        maker_id,
        deposit,
        DepositPurpose::MakerDeposit { maker_id },
    )?;
    
    // ...
}
```

3. **ä¿®æ”¹æŠ¼é‡‘é‡Šæ”¾é€»è¾‘**

```rust
pub fn do_withdraw_deposit<T: Config>(maker_id: u64) -> DispatchResult {
    // ã€æ—§ã€‘ä½¿ç”¨ Currency::unreserve
    // T::Currency::unreserve(&who, deposit);
    
    // ã€æ–°ã€‘ä½¿ç”¨ DepositManager
    T::DepositManager::release_deposit(maker_id)?;
    
    // ...
}
```

4. **æ·»åŠ ç½šæ²¡é€»è¾‘**

```rust
/// æ–°å‡½æ•°ï¼šç½šæ²¡åšå¸‚å•†æŠ¼é‡‘
pub fn do_slash_maker<T: Config>(
    maker_id: u64,
    slash_ratio: Perbill, // å¦‚ Perbill::from_percent(50) = ç½šæ²¡50%
) -> DispatchResult {
    let treasury = T::TreasuryAccount::get();
    T::DepositManager::slash_deposit(maker_id, slash_ratio, &treasury)?;
    
    // æ›´æ–°åšå¸‚å•†çŠ¶æ€
    MakerApplications::<T>::mutate(maker_id, |app| {
        if let Some(app) = app {
            app.status = ApplicationStatus::Slashed;
        }
    });
    
    Ok(())
}
```

5. **æ›´æ–° Runtime é…ç½®**

```rust
// runtime/src/configs/mod.rs
impl pallet_trading::Config for Runtime {
    // ... å…¶ä»–é…ç½®
    
    // æ–°å¢
    type DepositManager = Escrow;
    type TreasuryAccount = TreasuryAccountId;
}
```

6. **å•å…ƒæµ‹è¯•**

```bash
cargo test -p pallet-trading
```

7. **é›†æˆæµ‹è¯•**

```bash
# å¯åŠ¨æµ‹è¯•é“¾
./target/release/stardust-node --dev --tmp

# æµ‹è¯•åšå¸‚å•†ç”³è¯·ã€æç°ã€ç½šæ²¡æµç¨‹
```

8. **æ›´æ–°å‰ç«¯**

```bash
# ç¼–è¾‘ stardust-dapp/src/features/market-maker/
# æ›´æ–°æŠ¼é‡‘ç®¡ç†ç›¸å…³ç»„ä»¶
```

---

## âœ… éªŒæ”¶æ ‡å‡†

### Phase 1 éªŒæ”¶ï¼ˆå¿…é¡»ï¼‰

- [ ] **ç¼–è¯‘æµ‹è¯•**
  - [x] `cargo build --release` æˆåŠŸ
  - [x] `cargo test` å…¨éƒ¨é€šè¿‡
  - [x] æ—  pallet-deposits ç›¸å…³è­¦å‘Š

- [ ] **æ–‡æ¡£å®Œå–„**
  - [x] `ARCHIVED.md` å·²åˆ›å»º
  - [x] å½’æ¡£åŸå› æ¸…æ™°
  - [x] è¿ç§»è·¯å¾„æ˜ç¡®

- [ ] **ä»£ç æ¸…ç†**
  - [ ] `pallets/deposits` å·²ç§»é™¤
  - [ ] Runtime é…ç½®å·²æ³¨é‡Š
  - [ ] Cargo.toml ä¾èµ–å·²ç§»é™¤

### Phase 2 éªŒæ”¶ï¼ˆå¯é€‰ï¼‰

- [ ] **åŠŸèƒ½å®Œæ•´**
  - [ ] `reserve_deposit()` æ­£å¸¸å·¥ä½œ
  - [ ] `release_deposit()` æ­£å¸¸å·¥ä½œ
  - [ ] `slash_deposit()` æ­£å¸¸å·¥ä½œ

- [ ] **æµ‹è¯•è¦†ç›–**
  - [ ] å•å…ƒæµ‹è¯•é€šè¿‡ç‡ > 90%
  - [ ] é›†æˆæµ‹è¯•é€šè¿‡
  - [ ] å‹åŠ›æµ‹è¯•é€šè¿‡

- [ ] **æ–‡æ¡£æ›´æ–°**
  - [ ] `pallets/escrow/README.md` å·²æ›´æ–°
  - [ ] `pallets/trading/README.md` å·²æ›´æ–°
  - [ ] å‰ç«¯æ–‡æ¡£å·²æ›´æ–°

---

## ğŸ“Š è¿›åº¦è·Ÿè¸ª

### å½“å‰çŠ¶æ€ï¼šPhase 1 å‡†å¤‡å°±ç»ª âœ…

| ä»»åŠ¡ | çŠ¶æ€ | è´Ÿè´£äºº | å®Œæˆæ—¥æœŸ |
|------|------|--------|---------|
| å®¡æŸ¥ pallet-deposits | âœ… å®Œæˆ | AI | 2025-11-03 |
| è®¾è®¡ Escrow æ‰©å±• | âœ… å®Œæˆ | AI | 2025-11-03 |
| åˆ¶å®šè¿ç§»æ–¹æ¡ˆ | âœ… å®Œæˆ | AI | 2025-11-03 |
| åˆ›å»ºå½’æ¡£è„šæœ¬ | âœ… å®Œæˆ | AI | 2025-11-03 |
| **æ‰§è¡Œå½’æ¡£** | â¸ï¸ å¾…æ‰§è¡Œ | - | - |
| ç¼–è¯‘éªŒè¯ | â¸ï¸ å¾…æ‰§è¡Œ | - | - |
| æäº¤ä»£ç  | â¸ï¸ å¾…æ‰§è¡Œ | - | - |

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [æŠ¼é‡‘æ‰˜ç®¡ç»Ÿä¸€åŒ–åˆ†ææŠ¥å‘Š](./æŠ¼é‡‘æ‰˜ç®¡ç»Ÿä¸€åŒ–åˆ†ææŠ¥å‘Š.md) - è¯¦ç»†åˆ†ææŠ¥å‘Š
- [ARCHIVED.md](../archived-pallets/deposits/ARCHIVED.md) - å½’æ¡£è¯´æ˜
- [pallet-escrow README](../pallets/escrow/README.md) - Escrow æ¨¡å—æ–‡æ¡£
- [pallet-trading README](../pallets/trading/README.md) - Trading æ¨¡å—æ–‡æ¡£

---

## ğŸ’¡ å¸¸è§é—®é¢˜

### Q1ï¼šå½’æ¡£åå¦‚ä½•å›æ»šï¼Ÿ

```bash
# æ¢å¤å¤‡ä»½æ–‡ä»¶
cp runtime/src/lib.rs.bak runtime/src/lib.rs
cp runtime/src/configs/mod.rs.bak runtime/src/configs/mod.rs
cp runtime/Cargo.toml.bak runtime/Cargo.toml
cp Cargo.toml.bak Cargo.toml

# ç§»å›æ¨¡å—
mv archived-pallets/deposits pallets/

# é‡æ–°ç¼–è¯‘
cargo clean
cargo build --release
```

### Q2ï¼šæ˜¯å¦éœ€è¦æ‰§è¡Œ Phase 2ï¼Ÿ

**åˆ¤æ–­æ ‡å‡†**ï¼š

| åœºæ™¯ | æ˜¯å¦éœ€è¦ Phase 2 | æ¨èæ–¹æ¡ˆ |
|------|----------------|---------|
| ç”³è¯‰æŠ¼é‡‘ | âŒ å¦ | ä½¿ç”¨ Holds APIï¼ˆå·²å®æ–½ï¼‰ |
| å®¡æ ¸æŠ¼é‡‘ | âŒ å¦ | ä½¿ç”¨ Holds API |
| æŠ•è¯‰æŠ¼é‡‘ | âŒ å¦ | ä½¿ç”¨ Holds API |
| åšå¸‚å•†ä¿è¯é‡‘ | âš ï¸ çœ‹éœ€æ±‚ | å¦‚éœ€ç½šæ²¡åŠŸèƒ½ï¼Œæ‰§è¡Œ Phase 2 |
| è®¢å•æ‰˜ç®¡ | âŒ å¦ | ä½¿ç”¨ç°æœ‰ Escrowï¼ˆå·²å®æ–½ï¼‰ |

**å½“å‰å»ºè®®**ï¼šä»…æ‰§è¡Œ Phase 1ï¼Œåšå¸‚å•†ä¿è¯é‡‘ä¿æŒä½¿ç”¨ `Currency::reserve`ã€‚

### Q3ï¼šå½’æ¡£åä¼šå½±å“ç°æœ‰åŠŸèƒ½å—ï¼Ÿ

**ä¸ä¼š**ã€‚ç†ç”±ï¼š

1. âœ… pallet-stardust-appeals å·²è¿ç§»åˆ° Holds APIï¼ˆv0.3.0ï¼‰
2. âœ… æ— å…¶ä»–æ¨¡å—ä¾èµ– pallet-deposits
3. âœ… åšå¸‚å•†æŠ¼é‡‘ä½¿ç”¨ç‹¬ç«‹çš„ `Currency::reserve`
4. âœ… å½’æ¡£è„šæœ¬è‡ªåŠ¨å¤‡ä»½æ‰€æœ‰ä¿®æ”¹

---

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒï¼š
- [åˆ†ææŠ¥å‘Šè¯¦ç»†è¯´æ˜](./æŠ¼é‡‘æ‰˜ç®¡ç»Ÿä¸€åŒ–åˆ†ææŠ¥å‘Š.md)
- [Substrate Holds API æ–‡æ¡£](https://docs.substrate.io/reference/how-to-guides/pallet-design/implement-lockable-currency/)

---

**æœ€åæ›´æ–°**ï¼š2025-11-03  
**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**ç»´æŠ¤è€…**ï¼šStardust å¼€å‘å›¢é˜Ÿ

