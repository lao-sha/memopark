# æ–¹æ¡ˆBï¼šåŒå±‚èŒè´£åˆ†ç¦» - è¯¦ç»†è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ æ–¹æ¡ˆæ¦‚è¿°

**æ ¸å¿ƒæ€æƒ³**: ä¿ç•™å¢“ä½ownerå’Œé€è€…ownerï¼Œä½†æ˜ç¡®èŒè´£åˆ†å·¥ï¼Œå»ºç«‹æ¸…æ™°çš„åŒå±‚æƒé™æ¨¡å‹

**è®¾è®¡ç†å¿µ**:
- âœ… **èŒè´£åˆ†ç¦»**: å¢“ä½ç®¡ç†ï¼ˆåŸºç¡€è®¾æ–½ï¼‰vs é€è€…ç®¡ç†ï¼ˆå†…å®¹ç®¡ç†ï¼‰
- âœ… **çµæ´»æˆæƒ**: æ”¯æŒå¢“ä¸»æˆæƒä»–äººç®¡ç†é€è€…
- âœ… **æƒé™ç»§æ‰¿**: å¢“ä½æƒé™å¯å‘ä¸‹å…¼å®¹ï¼Œä½†é€è€…ownerä¼˜å…ˆ
- âœ… **æ¸…æ™°è¯­ä¹‰**: é€šè¿‡å‘½åå’Œæ–‡æ¡£æ¶ˆé™¤æ··æ·†

**é€‚ç”¨åœºæ™¯**:
- å¢“ä¸»å§”æ‰˜ä»–äººç»´æŠ¤é€è€…èµ„æ–™
- å®¶æ—å¢“ä¸­ä¸åŒåˆ†æ”¯ç®¡ç†è‡ªå·±çš„é€è€…
- VIPæœåŠ¡ï¼ˆä¸“ä¸šä»£ç†ç®¡ç†ï¼‰
- å¤æ‚æƒé™éœ€æ±‚

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### 1. æƒé™å±‚çº§æ¨¡å‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å›­åŒºå±‚ (Park)                           â”‚
â”‚  - å›­åŒºç®¡ç†å‘˜ï¼šå¯ç®¡ç†å›­åŒºä¸‹æ‰€æœ‰å¢“ä½å’Œé€è€…                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      å¢“ä½å±‚ (Grave)                          â”‚
â”‚  å¢“ä½owner:  å¢“ä¸» â† å¢“ä½æ‰€æœ‰è€…ï¼Œæœ€é«˜æƒé™                      â”‚
â”‚    â”œâ”€ å¯è½¬è®©å¢“ä½                                             â”‚
â”‚    â”œâ”€ å¯æ·»åŠ /ç§»é™¤å¢“ä½ç®¡ç†å‘˜                                   â”‚
â”‚    â”œâ”€ å¯è®¾ç½®å¢“ä½å°é¢/éŸ³ä¹                                     â”‚
â”‚    â”œâ”€ å¯ç®¡ç†å¢“ä½ä¸‹æ‰€æœ‰é€è€…ï¼ˆè¶Šæƒèƒ½åŠ›ï¼‰                         â”‚
â”‚    â””â”€ å¯æ‰¹é‡è½¬è®©é€è€…owner                                     â”‚
â”‚                                                              â”‚
â”‚  å¢“ä½admins: å¢“ä½ç®¡ç†å‘˜ â† è¾…åŠ©ç®¡ç†                            â”‚
â”‚    â”œâ”€ å¯è®¾ç½®å¢“ä½å°é¢/éŸ³ä¹ï¼ˆéƒ¨åˆ†æƒé™ï¼‰                          â”‚
â”‚    â”œâ”€ å¯åˆ›å»ºé€è€…ï¼ˆè‡ªåŠ¨æˆä¸ºé€è€…ownerï¼‰                          â”‚
â”‚    â””â”€ å¯ç®¡ç†é€è€…ï¼ˆè¶Šæƒèƒ½åŠ›ï¼‰                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      é€è€…å±‚ (Deceased)                       â”‚
â”‚  é€è€…owner:  é€è€…èµ„æ–™ç®¡ç†è€… â† å†…å®¹ç®¡ç†æƒé™                     â”‚
â”‚    â”œâ”€ å¯ä¿®æ”¹é€è€…èµ„æ–™ï¼ˆå§“åã€æ—¥æœŸã€æ€§åˆ«ç­‰ï¼‰                     â”‚
â”‚    â”œâ”€ å¯è®¾ç½®é€è€…ä¸»å›¾                                          â”‚
â”‚    â”œâ”€ å¯ç®¡ç†é€è€…å…³ç³»ï¼ˆäº²å±ã€é…å¶ç­‰ï¼‰                           â”‚
â”‚    â”œâ”€ å¯ç®¡ç†äº²å‹å›¢                                            â”‚
â”‚    â”œâ”€ å¯è½¬è®©é€è€…ownerç»™ä»–äºº                                   â”‚
â”‚    â””â”€ ä¸èƒ½ä¿®æ”¹æ‰€å±å¢“ä½ï¼ˆéœ€é€šè¿‡å¢“ä¸»ï¼‰                           â”‚
â”‚                                                              â”‚
â”‚  é€è€…creator: åˆ›å»ºè€… â† å®¡è®¡å­—æ®µï¼Œä¸å¯å˜                       â”‚
â”‚    â””â”€ ä»…ç”¨äºè¿½æº¯ï¼Œæ— æƒé™                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      ç¤¾äº¤å±‚ (Friends)                        â”‚
â”‚  äº²å‹å›¢: çº¯ç¤¾äº¤åŠŸèƒ½ï¼Œæ— ç®¡ç†æƒé™                               â”‚
â”‚    â”œâ”€ Member: æ™®é€šäº²å‹ï¼ˆç¤¾äº¤æ ‡è¯†ï¼‰                            â”‚
â”‚    â””â”€ Core: æ ¸å¿ƒäº²å‹ï¼ˆç¤¾äº¤æ ‡è¯†ï¼Œæœªæ¥å¯æ‰©å±•ï¼‰                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. æƒé™ä¼˜å…ˆçº§

```
é€è€…èµ„æ–™æ“ä½œçš„æƒé™æ£€æŸ¥é¡ºåºï¼š

1. é€è€…ownerï¼ˆä¼˜å…ˆï¼‰
   â†“ å¦‚æœä¸æ˜¯
2. å¢“ä½ownerï¼ˆå¢“ä¸»è¶Šæƒï¼‰
   â†“ å¦‚æœä¸æ˜¯
3. å¢“ä½adminï¼ˆç®¡ç†å‘˜è¶Šæƒï¼‰
   â†“ å¦‚æœä¸æ˜¯
4. å›­åŒºadminï¼ˆå›­åŒºç®¡ç†å‘˜è¶Šæƒï¼‰
   â†“ å¦åˆ™
5. æ‹’ç»è®¿é—®

ä¼˜åŠ¿ï¼š
âœ… é€è€…ownerç›´æ¥ç®¡ç†ï¼Œæ— éœ€æŸ¥è¯¢å¢“ä½
âœ… å¢“ä½æƒé™å…œåº•ï¼Œä¿è¯å¢“ä¸»æ§åˆ¶åŠ›
âœ… å±‚çº§æ¸…æ™°ï¼Œæ˜“äºç†è§£å’Œå®æ–½
```

---

## ğŸ’¾ æ•°æ®ç»“æ„è®¾è®¡

### 1. å¢“ä½ç»“æ„ï¼ˆGraveï¼‰- ä¸å˜

```rust
// pallets/stardust-grave/src/lib.rs

/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šå¢“ä½è®°å½•
/// 
/// èŒè´£ï¼š
/// - ç‰©ç†è½½ä½“ç®¡ç†ï¼ˆä½ç½®ã€å°é¢ã€éŸ³ä¹ï¼‰
/// - åŸºç¡€æƒé™ç®¡ç†ï¼ˆownerã€adminsï¼‰
/// - ä½œä¸ºé€è€…çš„å½’å±å®¹å™¨
#[derive(Encode, Decode, Clone, PartialEq, Eq, TypeInfo, MaxEncodedLen)]
#[scale_info(skip_type_params(T))]
pub struct Grave<T: Config> {
    /// å¢“ä¸»ï¼šå¢“ä½æ‰€æœ‰è€…ï¼Œæœ€é«˜æƒé™
    pub owner: T::AccountId,
    
    /// æ‰€å±å›­åŒºï¼ˆå¯é€‰ï¼‰
    pub park_id: Option<T::ParkId>,
    
    /// ç®¡ç†å‘˜ç»„IDï¼ˆå¯é€‰ï¼Œæš‚æœªä½¿ç”¨ï¼‰
    pub admin_group: Option<u64>,
    
    /// å°é¢CID
    pub cover: BoundedVec<u8, T::CidLimit>,
    
    /// éŸ³ä¹CID
    pub audio: BoundedVec<u8, T::CidLimit>,
    
    /// åˆ›å»ºæ—¶é—´
    pub created_at: BlockNumberFor<T>,
    
    /// å¯è§æ€§
    pub visibility: GraveVisibility,
}

/// å¢“ä½ç®¡ç†å‘˜åˆ—è¡¨
#[pallet::storage]
pub type GraveAdmins<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    T::GraveId,
    BoundedVec<T::AccountId, T::MaxAdminsPerGrave>,
    ValueQuery,
>;
```

---

### 2. é€è€…ç»“æ„ï¼ˆDeceasedï¼‰- å¢å¼º

```rust
// pallets/deceased/src/lib.rs

/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šé€è€…è®°å½•
/// 
/// èŒè´£ï¼š
/// - é€è€…èµ„æ–™æ•°æ®ï¼ˆå§“åã€æ—¥æœŸã€æ€§åˆ«ç­‰ï¼‰
/// - å†…å®¹ç®¡ç†æƒé™ï¼ˆé€šè¿‡ owner å­—æ®µï¼‰
/// - å…³ç³»å’Œç¤¾äº¤åŠŸèƒ½ï¼ˆäº²å±ã€äº²å‹å›¢ï¼‰
/// 
/// æƒé™è¯´æ˜ï¼š
/// - owner: é€è€…èµ„æ–™ç®¡ç†è€…ï¼ˆå¯è½¬è®©ï¼‰
/// - creator: æœ€åˆåˆ›å»ºè€…ï¼ˆå®¡è®¡ç”¨ï¼Œä¸å¯å˜ï¼‰
/// - å¢“ä½æƒé™: å¯è¶Šæƒæ“ä½œï¼Œä½†åº”ä¼˜å…ˆä½¿ç”¨ owner
#[derive(Encode, Decode, Clone, PartialEq, Eq, TypeInfo, MaxEncodedLen)]
#[scale_info(skip_type_params(T))]
pub struct Deceased<T: Config> {
    /// æ‰€å±å¢“ä½ï¼ˆå¿…é¡»ï¼Œä¸å¯å˜ï¼‰
    /// ç”¨äºï¼š
    /// - ç¡®å®šç‰©ç†å½’å±
    /// - å¢“ä½æƒé™æ£€æŸ¥ï¼ˆè¶Šæƒæ“ä½œï¼‰
    /// - åˆè‘¬æŸ¥è¯¢
    pub grave_id: T::GraveId,
    
    /// é€è€…èµ„æ–™ç®¡ç†è€…ï¼ˆä¼˜å…ˆæƒé™ï¼‰
    /// 
    /// èŒè´£ï¼š
    /// - ç®¡ç†é€è€…èµ„æ–™ï¼ˆå§“åã€æ—¥æœŸã€ä¸»å›¾ç­‰ï¼‰
    /// - ç®¡ç†é€è€…å…³ç³»ï¼ˆäº²å±ã€é…å¶ç­‰ï¼‰
    /// - ç®¡ç†äº²å‹å›¢ï¼ˆæ·»åŠ /ç§»é™¤æˆå‘˜ã€è®¾ç½®è§’è‰²ï¼‰
    /// - è½¬è®©é€è€…ownerç»™ä»–äºº
    /// 
    /// é™åˆ¶ï¼š
    /// - ä¸èƒ½ä¿®æ”¹æ‰€å±å¢“ä½ï¼ˆéœ€é€šè¿‡å¢“ä¸»çš„ transfer_deceasedï¼‰
    /// - ä¸èƒ½ä¿®æ”¹å¢“ä½çº§é…ç½®ï¼ˆå°é¢ã€éŸ³ä¹ç­‰ï¼‰
    /// 
    /// é»˜è®¤ï¼šåˆ›å»ºæ—¶ owner = callerï¼ˆé€šå¸¸æ˜¯å¢“ä¸»æˆ–å¢“ä½ç®¡ç†å‘˜ï¼‰
    /// å¯è½¬è®©ï¼šé€šè¿‡ transfer_deceased_owner æ¥å£
    pub owner: T::AccountId,
    
    /// æœ€åˆåˆ›å»ºè€…ï¼ˆå®¡è®¡ç”¨ï¼Œä¸å¯å˜ï¼‰
    /// 
    /// ç”¨é€”ï¼š
    /// - è¿½æº¯è´£ä»»ï¼ˆå†…å®¹å®¡æ ¸ã€äº‰è®®å¤„ç†ï¼‰
    /// - æ•°æ®åˆ†æï¼ˆç”¨æˆ·è¡Œä¸ºï¼‰
    /// - æ²»ç†ä¾æ®ï¼ˆé—®é¢˜æº¯æºï¼‰
    /// 
    /// ç‰¹æ€§ï¼š
    /// - åˆ›å»ºåæ°¸ä¹…ä¸å¯ä¿®æ”¹
    /// - ä¸æ¶‰åŠä»»ä½•æƒé™
    /// - ä»…ç”¨äºå†å²è®°å½•
    pub creator: T::AccountId,
    
    /// å§“åå…¨ç§°ï¼ˆåŠ å¯†CIDï¼‰
    pub full_name: BoundedVec<u8, T::CidLimit>,
    
    /// æ€§åˆ«ï¼ˆ0=ç”·, 1=å¥³, 2=ä¿å¯†ï¼‰
    pub gender: Gender,
    
    /// å‡ºç”Ÿæ—¥æœŸï¼ˆåŠ å¯†CIDï¼‰
    pub birth_date: BoundedVec<u8, T::CidLimit>,
    
    /// é€ä¸–æ—¥æœŸï¼ˆåŠ å¯†CIDï¼‰
    pub death_date: BoundedVec<u8, T::CidLimit>,
    
    /// ä¸»å›¾CIDï¼ˆå…¬å¼€æˆ–åŠ å¯†ï¼‰
    pub main_image: BoundedVec<u8, T::CidLimit>,
    
    /// åˆ›å»ºæ—¶é—´
    pub created_at: BlockNumberFor<T>,
    
    /// æœ€åæ›´æ–°æ—¶é—´
    pub last_updated: BlockNumberFor<T>,
    
    /// å”¯ä¸€æ ‡è¯†tokenï¼ˆ49å­—èŠ‚ï¼‰
    pub deceased_token: [u8; 49],
}
```

---

### 3. æ–°å¢å­˜å‚¨é¡¹

```rust
// pallets/deceased/src/lib.rs

/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šé€è€…ownerå˜æ›´æ—¥å¿—
/// 
/// ç”¨é€”ï¼š
/// - è¿½æº¯é€è€…ownerçš„å†å²è½¬è®©è®°å½•
/// - å®¡è®¡å’Œäº‰è®®å¤„ç†
/// - é˜²æ­¢é¢‘ç¹è½¬è®©ä½œæ¶
#[pallet::storage]
pub type DeceasedOwnerHistory<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    T::DeceasedId,
    BoundedVec<
        OwnerChangeRecord<T::AccountId, BlockNumberFor<T>>,
        ConstU32<100>  // æœ€å¤šè®°å½•100æ¬¡è½¬è®©
    >,
    ValueQuery,
>;

/// ownerå˜æ›´è®°å½•
#[derive(Encode, Decode, Clone, PartialEq, Eq, TypeInfo, MaxEncodedLen)]
pub struct OwnerChangeRecord<AccountId, BlockNumber> {
    pub from_owner: AccountId,
    pub to_owner: AccountId,
    pub changed_at: BlockNumber,
    pub changed_by: AccountId,  // è°å‘èµ·çš„è½¬è®©ï¼ˆå¯èƒ½æ˜¯from_owneræˆ–å¢“ä¸»ï¼‰
}
```

---

## ğŸ”§ æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. ç»Ÿä¸€æƒé™æ£€æŸ¥å‡½æ•°

```rust
// pallets/deceased/src/lib.rs

impl<T: Config> Pallet<T> {
    /// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šæ£€æŸ¥è´¦æˆ·æ˜¯å¦æœ‰æƒé™ç®¡ç†é€è€…èµ„æ–™
    /// 
    /// æƒé™æ£€æŸ¥ä¼˜å…ˆçº§ï¼š
    /// 1. é€è€…ownerï¼ˆä¼˜å…ˆï¼‰
    /// 2. å¢“ä½æƒé™ï¼ˆè¶Šæƒèƒ½åŠ›ï¼‰
    ///    - å¢“ä¸»
    ///    - å¢“ä½ç®¡ç†å‘˜
    ///    - å›­åŒºç®¡ç†å‘˜
    /// 
    /// å‚æ•°ï¼š
    /// - who: å¾…æ£€æŸ¥çš„è´¦æˆ·
    /// - deceased_id: é€è€…ID
    /// 
    /// è¿”å›ï¼š
    /// - true: æœ‰æƒé™
    /// - false: æ— æƒé™
    /// 
    /// ä½¿ç”¨åœºæ™¯ï¼š
    /// - update_deceased: ä¿®æ”¹é€è€…èµ„æ–™
    /// - set_main_image: è®¾ç½®ä¸»å›¾
    /// - propose_relation: ææ¡ˆå…³ç³»
    /// - transfer_deceased_owner: è½¬è®©é€è€…owner
    pub fn can_manage_deceased(
        who: &T::AccountId,
        deceased_id: T::DeceasedId,
    ) -> bool {
        if let Some(deceased) = DeceasedOf::<T>::get(deceased_id) {
            // 1) ä¼˜å…ˆæ£€æŸ¥ï¼šé€è€…ownerç›´æ¥å¯ä»¥
            if deceased.owner == *who {
                return true;
            }
            
            // 2) å…œåº•æ£€æŸ¥ï¼šå¢“ä½æƒé™ä¹Ÿå¯ä»¥ï¼ˆè¶Šæƒèƒ½åŠ›ï¼‰
            T::GraveProvider::can_attach(who, deceased.grave_id)
        } else {
            false
        }
    }
    
    /// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šæ£€æŸ¥è´¦æˆ·æ˜¯å¦æ˜¯é€è€…ownerï¼ˆä¸¥æ ¼æ£€æŸ¥ï¼‰
    /// 
    /// ç”¨é€”ï¼š
    /// - éœ€è¦ä¸¥æ ¼é™åˆ¶ä¸ºé€è€…ownerçš„æ“ä½œ
    /// - ä¾‹å¦‚ï¼šè½¬è®©é€è€…ownerã€æŸäº›æ•æ„Ÿæ“ä½œ
    /// 
    /// ä¸ can_manage_deceased çš„åŒºåˆ«ï¼š
    /// - can_manage_deceased: å®½æ¾ï¼Œå…è®¸å¢“ä½æƒé™è¶Šæƒ
    /// - is_deceased_owner: ä¸¥æ ¼ï¼Œåªå…è®¸é€è€…owneræœ¬äºº
    pub fn is_deceased_owner(
        who: &T::AccountId,
        deceased_id: T::DeceasedId,
    ) -> bool {
        DeceasedOf::<T>::get(deceased_id)
            .map(|d| d.owner == *who)
            .unwrap_or(false)
    }
    
    /// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šæ£€æŸ¥è´¦æˆ·æ˜¯å¦æœ‰å¢“ä½çº§æƒé™ï¼ˆå¢“ä¸»/ç®¡ç†å‘˜/å›­åŒºç®¡ç†å‘˜ï¼‰
    /// 
    /// ç”¨é€”ï¼š
    /// - å¢“ä½çº§æ“ä½œï¼ˆå¦‚è½¬ç§»é€è€…åˆ°å…¶ä»–å¢“ä½ï¼‰
    /// - éœ€è¦åŒºåˆ†å¢“ä½æƒé™ vs é€è€…owneræƒé™çš„åœºæ™¯
    pub fn has_grave_permission(
        who: &T::AccountId,
        grave_id: T::GraveId,
    ) -> bool {
        T::GraveProvider::can_attach(who, grave_id)
    }
}
```

---

### 2. åˆ›å»ºé€è€…ï¼ˆcreate_deceasedï¼‰

```rust
/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šåˆ›å»ºé€è€…è®°å½•
/// 
/// æƒé™ï¼šå¢“ä½æƒé™ï¼ˆå¢“ä¸»/å¢“ä½ç®¡ç†å‘˜/å›­åŒºç®¡ç†å‘˜ï¼‰
/// 
/// é€»è¾‘ï¼š
/// 1. æ£€æŸ¥å¢“ä½æƒé™ï¼ˆcan_attachï¼‰
/// 2. åˆ›å»ºé€è€…ï¼Œowner = callerï¼ˆè°åˆ›å»ºè°è´Ÿè´£ï¼‰
/// 3. creator = callerï¼ˆå®¡è®¡ç”¨ï¼‰
#[pallet::call_index(0)]
#[pallet::weight(T::WeightInfo::create_deceased())]
pub fn create_deceased(
    origin: OriginFor<T>,
    grave_id: T::GraveId,
    full_name: Vec<u8>,
    gender_code: u8,
    birth_date: Vec<u8>,
    death_date: Vec<u8>,
    main_image: Vec<u8>,
) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    // 1. æ ¡éªŒå¢“ä½å­˜åœ¨
    ensure!(
        T::GraveProvider::grave_exists(grave_id),
        Error::<T>::GraveNotFound
    );
    
    // 2. æ ¡éªŒå¢“ä½æƒé™ï¼ˆå¢“ä¸»/ç®¡ç†å‘˜/å›­åŒºç®¡ç†å‘˜ï¼‰
    ensure!(
        T::GraveProvider::can_attach(&who, grave_id),
        Error::<T>::NotAuthorized
    );
    
    // 3. æ„å»ºé€è€…è®°å½•
    let deceased = Deceased {
        grave_id,
        owner: who.clone(),      // åˆ›å»ºè€…æˆä¸ºowner
        creator: who.clone(),     // è®°å½•åˆ›å»ºè€…
        full_name: BoundedVec::try_from(full_name)?,
        gender: Gender::from_code(gender_code),
        birth_date: BoundedVec::try_from(birth_date)?,
        death_date: BoundedVec::try_from(death_date)?,
        main_image: BoundedVec::try_from(main_image)?,
        created_at: <frame_system::Pallet<T>>::block_number(),
        last_updated: <frame_system::Pallet<T>>::block_number(),
        deceased_token: Self::build_deceased_token(/* ... */),
    };
    
    // 4. å­˜å‚¨é€è€…
    let deceased_id = Self::next_deceased_id()?;
    DeceasedOf::<T>::insert(deceased_id, deceased.clone());
    
    // 5. æ›´æ–°å¢“ä½çš„é€è€…åˆ—è¡¨
    DeceasedByGrave::<T>::try_mutate(grave_id, |list| {
        list.try_push(deceased.deceased_token)
            .map_err(|_| Error::<T>::TooManyDeceasedInGrave)
    })?;
    
    // 6. è‡ªåŠ¨pin IPFSï¼ˆå…¨ç§°ã€ä¸»å›¾ï¼‰
    Self::auto_pin_cid(
        &deceased.full_name,
        AutoPinType::FullName,
        deceased_id,
        &who,
        grave_id,
    );
    Self::auto_pin_cid(
        &deceased.main_image,
        AutoPinType::MainImage,
        deceased_id,
        &who,
        grave_id,
    );
    
    // 7. å‘é€äº‹ä»¶
    Self::deposit_event(Event::DeceasedCreated {
        deceased_id,
        grave_id,
        owner: who.clone(),
        creator: who,
    });
    
    Ok(())
}
```

---

### 3. æ›´æ–°é€è€…èµ„æ–™ï¼ˆupdate_deceasedï¼‰

```rust
/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šæ›´æ–°é€è€…èµ„æ–™
/// 
/// æƒé™ï¼šé€è€…ownerï¼ˆä¼˜å…ˆï¼‰æˆ–å¢“ä½æƒé™ï¼ˆè¶Šæƒï¼‰
/// 
/// é€»è¾‘ï¼š
/// 1. ä½¿ç”¨ can_manage_deceased æ£€æŸ¥æƒé™
/// 2. æ›´æ–°èµ„æ–™
/// 3. è®°å½•æœ€åæ›´æ–°æ—¶é—´
#[pallet::call_index(1)]
#[pallet::weight(T::WeightInfo::update_deceased())]
pub fn update_deceased(
    origin: OriginFor<T>,
    deceased_id: T::DeceasedId,
    full_name: Option<Vec<u8>>,
    gender_code: Option<u8>,
    birth_date: Option<Vec<u8>>,
    death_date: Option<Vec<u8>>,
) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    // æƒé™æ£€æŸ¥ï¼šé€è€…owner æˆ– å¢“ä½æƒé™
    ensure!(
        Self::can_manage_deceased(&who, deceased_id),
        Error::<T>::NotAuthorized
    );
    
    DeceasedOf::<T>::try_mutate(deceased_id, |maybe_d| {
        let d = maybe_d.as_mut().ok_or(Error::<T>::DeceasedNotFound)?;
        
        // æ›´æ–°å­—æ®µ
        if let Some(fn_cid) = full_name {
            let fn_bounded = BoundedVec::try_from(fn_cid.clone())
                .map_err(|_| Error::<T>::BadInput)?;
            d.full_name = fn_bounded.clone();
            
            // è‡ªåŠ¨pinæ–°CID
            Self::auto_pin_cid(
                &fn_bounded,
                AutoPinType::FullName,
                deceased_id,
                &who,
                d.grave_id,
            );
        }
        
        if let Some(gc) = gender_code {
            d.gender = Gender::from_code(gc);
        }
        
        if let Some(bd) = birth_date {
            d.birth_date = BoundedVec::try_from(bd)
                .map_err(|_| Error::<T>::BadInput)?;
        }
        
        if let Some(dd) = death_date {
            d.death_date = BoundedVec::try_from(dd)
                .map_err(|_| Error::<T>::BadInput)?;
        }
        
        // æ›´æ–°æ—¶é—´æˆ³
        d.last_updated = <frame_system::Pallet<T>>::block_number();
        
        Ok(())
    })?;
    
    Self::deposit_event(Event::DeceasedUpdated {
        deceased_id,
        updated_by: who,
    });
    
    Ok(())
}
```

---

### 4. è½¬è®©é€è€…ownerï¼ˆæ–°å¢ï¼‰â­â­â­

```rust
/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šè½¬è®©é€è€…ownerï¼ˆä»…è½¬è®©èµ„æ–™ç®¡ç†æƒï¼Œä¸è½¬ç§»å¢“ä½ï¼‰
/// 
/// æƒé™ï¼š
/// - é€è€…å½“å‰ownerï¼ˆæœ¬äººå‘èµ·ï¼‰
/// - æˆ–å¢“ä½æƒé™ï¼ˆå¢“ä¸»/ç®¡ç†å‘˜å¼ºåˆ¶è½¬è®©ï¼‰
/// 
/// ç”¨é€”ï¼š
/// - å¢“ä¸»æˆæƒä»–äººç®¡ç†é€è€…èµ„æ–™
/// - å®¶æ—å¢“ä¸­ä¸åŒåˆ†æ”¯ç®¡ç†è‡ªå·±çš„é€è€…
/// - VIPæœåŠ¡ï¼ˆå§”æ‰˜ä¸“ä¸šäººå‘˜ç»´æŠ¤ï¼‰
/// 
/// é™åˆ¶ï¼š
/// - ä¸å½±å“å¢“ä½å½’å±
/// - ä¸å½±å“äº²å‹å›¢ï¼ˆä¿ç•™ï¼‰
/// - ä¸å½±å“å…³ç³»ç½‘ç»œï¼ˆä¿ç•™ï¼‰
/// 
/// æ³¨æ„ï¼š
/// - è®°å½•ownerå˜æ›´å†å²ï¼ˆå®¡è®¡ç”¨ï¼‰
/// - æ–°owneréœ€è¦æ¥å—ï¼ˆéœ€å…ˆè°ƒç”¨ accept_deceased_ownerï¼‰
#[pallet::call_index(30)]
#[pallet::weight(T::WeightInfo::transfer_deceased_owner())]
pub fn transfer_deceased_owner(
    origin: OriginFor<T>,
    deceased_id: T::DeceasedId,
    new_owner: T::AccountId,
) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    // æƒé™æ£€æŸ¥ï¼šé€è€…owner æˆ– å¢“ä½æƒé™
    ensure!(
        Self::can_manage_deceased(&who, deceased_id),
        Error::<T>::NotAuthorized
    );
    
    DeceasedOf::<T>::try_mutate(deceased_id, |maybe_d| {
        let d = maybe_d.as_mut().ok_or(Error::<T>::DeceasedNotFound)?;
        
        // ä¸å…è®¸è½¬ç»™è‡ªå·±
        ensure!(d.owner != new_owner, Error::<T>::BadInput);
        
        let old_owner = d.owner.clone();
        let grave_id = d.grave_id;
        
        // æ›´æ–°owner
        d.owner = new_owner.clone();
        d.last_updated = <frame_system::Pallet<T>>::block_number();
        
        // è®°å½•å˜æ›´å†å²
        DeceasedOwnerHistory::<T>::try_mutate(deceased_id, |history| {
            let record = OwnerChangeRecord {
                from_owner: old_owner.clone(),
                to_owner: new_owner.clone(),
                changed_at: <frame_system::Pallet<T>>::block_number(),
                changed_by: who.clone(),
            };
            history.try_push(record)
                .map_err(|_| Error::<T>::Overflow)
        })?;
        
        // å‘é€äº‹ä»¶
        Self::deposit_event(Event::DeceasedOwnerTransferred {
            deceased_id,
            grave_id,
            old_owner,
            new_owner,
            transferred_by: who,
        });
        
        Ok(())
    })
}
```

---

### 5. æ‰¹é‡è½¬è®©é€è€…ownerï¼ˆæ–°å¢ï¼‰â­â­â­

```rust
/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šæ‰¹é‡è½¬è®©å¢“ä½ä¸‹æ‰€æœ‰é€è€…çš„owner
/// 
/// æƒé™ï¼šä»…å¢“ä¸»ï¼ˆå¢“ä½ownerï¼‰
/// 
/// ç”¨é€”ï¼š
/// - å¢“ä½è½¬è®©æ—¶ï¼Œæ‰¹é‡è½¬è®©æ‰€æœ‰é€è€…owner
/// - ç®€åŒ–æ“ä½œï¼Œé¿å…é€ä¸ªè½¬è®©
/// 
/// åœºæ™¯ï¼š
/// - å¢“ä½å‡ºå”®/èµ é€ç»™ä»–äºº
/// - å®¶æ—å¢“ç»Ÿä¸€è½¬äº¤æ–°ç®¡ç†è€…
#[pallet::call_index(31)]
#[pallet::weight(T::WeightInfo::batch_transfer_deceased_owners())]
pub fn batch_transfer_deceased_owners(
    origin: OriginFor<T>,
    grave_id: T::GraveId,
    new_owner: T::AccountId,
) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    // æƒé™æ£€æŸ¥ï¼šä»…å¢“ä¸»å¯ä»¥æ‰¹é‡è½¬è®©
    ensure!(
        T::GraveProvider::is_grave_owner(&who, grave_id),
        Error::<T>::NotAuthorized
    );
    
    // è·å–å¢“ä½ä¸‹æ‰€æœ‰é€è€…token
    let deceased_tokens = DeceasedByGrave::<T>::get(grave_id);
    
    let mut count = 0u32;
    
    // éå†æ‰€æœ‰é€è€…ï¼Œè½¬è®©owner
    for token in deceased_tokens.iter() {
        if let Some(deceased_id) = DeceasedIdByToken::<T>::get(token) {
            // è°ƒç”¨å•ä¸ªè½¬è®©å‡½æ•°
            Self::do_transfer_deceased_owner(
                deceased_id,
                new_owner.clone(),
                who.clone(),
            )?;
            count = count.saturating_add(1);
        }
    }
    
    Self::deposit_event(Event::DeceasedOwnersBatchTransferred {
        grave_id,
        new_owner,
        count,
        transferred_by: who,
    });
    
    Ok(())
}

/// å†…éƒ¨å‡½æ•°ï¼šæ‰§è¡Œé€è€…ownerè½¬è®©ï¼ˆæ— æƒé™æ£€æŸ¥ï¼‰
fn do_transfer_deceased_owner(
    deceased_id: T::DeceasedId,
    new_owner: T::AccountId,
    changed_by: T::AccountId,
) -> DispatchResult {
    DeceasedOf::<T>::try_mutate(deceased_id, |maybe_d| {
        let d = maybe_d.as_mut().ok_or(Error::<T>::DeceasedNotFound)?;
        
        let old_owner = d.owner.clone();
        d.owner = new_owner.clone();
        d.last_updated = <frame_system::Pallet<T>>::block_number();
        
        // è®°å½•å˜æ›´å†å²
        DeceasedOwnerHistory::<T>::try_mutate(deceased_id, |history| {
            let record = OwnerChangeRecord {
                from_owner: old_owner.clone(),
                to_owner: new_owner.clone(),
                changed_at: <frame_system::Pallet<T>>::block_number(),
                changed_by: changed_by.clone(),
            };
            history.try_push(record)
                .map_err(|_| Error::<T>::Overflow)
        })?;
        
        Ok(())
    })
}
```

---

### 6. è½¬ç§»é€è€…åˆ°å…¶ä»–å¢“ä½ï¼ˆtransfer_deceasedï¼‰

```rust
/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šè½¬ç§»é€è€…åˆ°å…¶ä»–å¢“ä½ï¼ˆè¿å¢“ï¼‰
/// 
/// æƒé™ï¼šä»…æºå¢“ä½çš„å¢“ä¸»
/// 
/// é€»è¾‘ï¼š
/// 1. æ£€æŸ¥æºå¢“ä½æƒé™ï¼ˆå¢“ä¸»ï¼‰
/// 2. æ£€æŸ¥ç›®æ ‡å¢“ä½æƒé™ï¼ˆcan_attachï¼‰
/// 3. æ›´æ–°é€è€…çš„ grave_id
/// 4. æ›´æ–°ä¸¤ä¸ªå¢“ä½çš„ DeceasedByGrave
/// 5. ä¿ç•™é€è€…ownerï¼ˆä¸è‡ªåŠ¨è½¬è®©ï¼‰
/// 
/// æ³¨æ„ï¼š
/// - ä¸ä¼šè‡ªåŠ¨è½¬è®©é€è€…owner
/// - å¦‚æœéœ€è¦è½¬è®©ownerï¼Œè¯·å…ˆè°ƒç”¨ transfer_deceased_owner
#[pallet::call_index(10)]
#[pallet::weight(T::WeightInfo::transfer_deceased())]
pub fn transfer_deceased(
    origin: OriginFor<T>,
    deceased_id: T::DeceasedId,
    new_grave_id: T::GraveId,
) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    DeceasedOf::<T>::try_mutate(deceased_id, |maybe_d| {
        let d = maybe_d.as_mut().ok_or(Error::<T>::DeceasedNotFound)?;
        
        let old_grave_id = d.grave_id;
        
        // ä¸å…è®¸è½¬ç§»åˆ°åŒä¸€ä¸ªå¢“ä½
        ensure!(old_grave_id != new_grave_id, Error::<T>::BadInput);
        
        // æƒé™æ£€æŸ¥ï¼šä»…æºå¢“ä½çš„å¢“ä¸»
        ensure!(
            T::GraveProvider::is_grave_owner(&who, old_grave_id),
            Error::<T>::NotAuthorized
        );
        
        // æ£€æŸ¥ç›®æ ‡å¢“ä½å­˜åœ¨ä¸”æœ‰æƒé™
        ensure!(
            T::GraveProvider::grave_exists(new_grave_id),
            Error::<T>::GraveNotFound
        );
        ensure!(
            T::GraveProvider::can_attach(&who, new_grave_id),
            Error::<T>::NotAuthorized
        );
        
        // ä»æ—§å¢“ä½ç§»é™¤
        DeceasedByGrave::<T>::try_mutate(old_grave_id, |list| {
            if let Some(pos) = list.iter().position(|t| t == &d.deceased_token) {
                list.remove(pos);
            }
            Ok::<(), DispatchError>(())
        })?;
        
        // æ·»åŠ åˆ°æ–°å¢“ä½
        DeceasedByGrave::<T>::try_mutate(new_grave_id, |list| {
            list.try_push(d.deceased_token)
                .map_err(|_| Error::<T>::TooManyDeceasedInGrave)
        })?;
        
        // æ›´æ–°é€è€…çš„å¢“ä½
        d.grave_id = new_grave_id;
        d.last_updated = <frame_system::Pallet<T>>::block_number();
        
        Self::deposit_event(Event::DeceasedTransferred {
            deceased_id,
            old_grave_id,
            new_grave_id,
            transferred_by: who,
        });
        
        Ok(())
    })
}
```

---

### 7. è®¾ç½®ä¸»å›¾ï¼ˆset_main_imageï¼‰

```rust
/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šè®¾ç½®é€è€…ä¸»å›¾
/// 
/// æƒé™ï¼šé€è€…ownerï¼ˆä¼˜å…ˆï¼‰æˆ–å¢“ä½æƒé™ï¼ˆè¶Šæƒï¼‰
#[pallet::call_index(3)]
#[pallet::weight(T::WeightInfo::set_main_image())]
pub fn set_main_image(
    origin: OriginFor<T>,
    deceased_id: T::DeceasedId,
    main_image_cid: Vec<u8>,
) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    // æƒé™æ£€æŸ¥ï¼šé€è€…owner æˆ– å¢“ä½æƒé™
    ensure!(
        Self::can_manage_deceased(&who, deceased_id),
        Error::<T>::NotAuthorized
    );
    
    DeceasedOf::<T>::try_mutate(deceased_id, |maybe_d| {
        let d = maybe_d.as_mut().ok_or(Error::<T>::DeceasedNotFound)?;
        
        let cid_bounded = BoundedVec::try_from(main_image_cid.clone())
            .map_err(|_| Error::<T>::BadInput)?;
        
        d.main_image = cid_bounded.clone();
        d.last_updated = <frame_system::Pallet<T>>::block_number();
        
        // è‡ªåŠ¨pin
        Self::auto_pin_cid(
            &cid_bounded,
            AutoPinType::MainImage,
            deceased_id,
            &who,
            d.grave_id,
        );
        
        Self::deposit_event(Event::MainImageSet {
            deceased_id,
            cid: main_image_cid,
            set_by: who,
        });
        
        Ok(())
    })
}
```

---

### 8. æŸ¥è¯¢æ¥å£ï¼ˆæ–°å¢ï¼‰

```rust
/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šæŸ¥è¯¢é€è€…ownerå˜æ›´å†å²
/// 
/// ç”¨é€”ï¼š
/// - å®¡è®¡å’Œäº‰è®®å¤„ç†
/// - è¿½æº¯ownerè½¬è®©è®°å½•
pub fn get_deceased_owner_history(
    deceased_id: T::DeceasedId,
) -> Vec<OwnerChangeRecord<T::AccountId, BlockNumberFor<T>>> {
    DeceasedOwnerHistory::<T>::get(deceased_id).to_vec()
}

/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šæŸ¥è¯¢å¢“ä½ä¸‹æ‰€æœ‰é€è€…çš„owneråˆ—è¡¨
/// 
/// ç”¨é€”ï¼š
/// - æ‰¹é‡è½¬è®©å‰é¢„è§ˆ
/// - å¢“ä½ç®¡ç†ç•Œé¢å±•ç¤º
pub fn get_deceased_owners_in_grave(
    grave_id: T::GraveId,
) -> Vec<(T::DeceasedId, T::AccountId)> {
    let tokens = DeceasedByGrave::<T>::get(grave_id);
    let mut result = Vec::new();
    
    for token in tokens.iter() {
        if let Some(deceased_id) = DeceasedIdByToken::<T>::get(token) {
            if let Some(deceased) = DeceasedOf::<T>::get(deceased_id) {
                result.push((deceased_id, deceased.owner));
            }
        }
    }
    
    result
}
```

---

## ğŸ¯ äº‹ä»¶å®šä¹‰

```rust
#[pallet::event]
#[pallet::generate_deposit(pub(super) fn deposit_event)]
pub enum Event<T: Config> {
    /// é€è€…åˆ›å»ºæˆåŠŸ
    /// [deceased_id, grave_id, owner, creator]
    DeceasedCreated {
        deceased_id: T::DeceasedId,
        grave_id: T::GraveId,
        owner: T::AccountId,
        creator: T::AccountId,
    },
    
    /// é€è€…ownerè½¬è®©æˆåŠŸ
    /// [deceased_id, grave_id, old_owner, new_owner, transferred_by]
    DeceasedOwnerTransferred {
        deceased_id: T::DeceasedId,
        grave_id: T::GraveId,
        old_owner: T::AccountId,
        new_owner: T::AccountId,
        transferred_by: T::AccountId,
    },
    
    /// æ‰¹é‡è½¬è®©é€è€…owneræˆåŠŸ
    /// [grave_id, new_owner, count, transferred_by]
    DeceasedOwnersBatchTransferred {
        grave_id: T::GraveId,
        new_owner: T::AccountId,
        count: u32,
        transferred_by: T::AccountId,
    },
    
    /// é€è€…è½¬ç§»åˆ°å…¶ä»–å¢“ä½æˆåŠŸ
    /// [deceased_id, old_grave_id, new_grave_id, transferred_by]
    DeceasedTransferred {
        deceased_id: T::DeceasedId,
        old_grave_id: T::GraveId,
        new_grave_id: T::GraveId,
        transferred_by: T::AccountId,
    },
    
    /// é€è€…èµ„æ–™æ›´æ–°æˆåŠŸ
    /// [deceased_id, updated_by]
    DeceasedUpdated {
        deceased_id: T::DeceasedId,
        updated_by: T::AccountId,
    },
    
    /// ä¸»å›¾è®¾ç½®æˆåŠŸ
    /// [deceased_id, cid, set_by]
    MainImageSet {
        deceased_id: T::DeceasedId,
        cid: Vec<u8>,
        set_by: T::AccountId,
    },
    
    // ... å…¶ä»–äº‹ä»¶
}
```

---

## ğŸ“š å…¸å‹åœºæ™¯ä¸æµç¨‹

### åœºæ™¯1ï¼šå¢“ä¸»è‡ªå·±ç®¡ç†ï¼ˆé»˜è®¤åœºæ™¯ï¼‰

```
æµç¨‹ï¼š
1. Alice åˆ›å»ºå¢“ä½A
   â†’ Grave { owner: Alice }

2. Alice åˆ›å»ºé€è€…D1
   â†’ Deceased { grave_id: A, owner: Alice, creator: Alice }

3. Alice ä¿®æ”¹é€è€…èµ„æ–™
   â†’ can_manage_deceased(Alice, D1)
      âœ… deceased.owner == Alice â†’ true

ç»“æœï¼šç®€å•ç›´æ¥ï¼Œé›¶å†—ä½™
```

---

### åœºæ™¯2ï¼šå¢“ä¸»æˆæƒä»–äººç®¡ç†

```
æµç¨‹ï¼š
1. Alice åˆ›å»ºå¢“ä½Aï¼Œåˆ›å»ºé€è€…D1
   â†’ Deceased { grave_id: A, owner: Alice, creator: Alice }

2. Alice æˆæƒ Bob ç®¡ç†é€è€…D1
   â†’ transfer_deceased_owner(D1, Bob)
   â†’ Deceased { owner: Bob }  â† ownerå˜æ›´
   â†’ Event::DeceasedOwnerTransferred(D1, Alice, Bob)

3. Bob ä¿®æ”¹é€è€…èµ„æ–™
   â†’ can_manage_deceased(Bob, D1)
      âœ… deceased.owner == Bob â†’ true

4. Alice ä»ç„¶å¯ä»¥è¶Šæƒç®¡ç†ï¼ˆå¢“ä¸»ç‰¹æƒï¼‰
   â†’ can_manage_deceased(Alice, D1)
      âŒ deceased.owner != Alice
      âœ… can_attach(Alice, grave_id=A) â†’ true

ç»“æœï¼š
- Bob æ˜¯ä¼˜å…ˆç®¡ç†è€…
- Alice ä¿ç•™å…œåº•æ§åˆ¶æƒ
```

---

### åœºæ™¯3ï¼šå®¶æ—å¢“ä¸åŒåˆ†æ”¯ç®¡ç†

```
æµç¨‹ï¼š
1. å®¶æ—é•¿ Alice åˆ›å»ºå®¶æ—å¢“G
   â†’ Grave { owner: Alice }

2. Alice åˆ›å»ºç¥–è¾ˆé€è€…D1, D2, D3
   â†’ Deceased { owner: Alice }

3. Alice åˆ›å»ºä¸€æ”¯åè£”é€è€…D4, D5
   â†’ Deceased { owner: Alice }
   â†’ transfer_deceased_owner(D4, Bob)  â† è½¬ç»™ä¸€æ”¯åäººBob
   â†’ transfer_deceased_owner(D5, Bob)

4. Alice åˆ›å»ºäºŒæ”¯åè£”é€è€…D6, D7
   â†’ transfer_deceased_owner(D6, Carol) â† è½¬ç»™äºŒæ”¯åäººCarol
   â†’ transfer_deceased_owner(D7, Carol)

ç»“æœï¼š
å¢“ä½G (Alice)
  â”œâ”€ D1, D2, D3 (Aliceç®¡ç†) â† ç¥–è¾ˆ
  â”œâ”€ D4, D5 (Bobç®¡ç†)       â† ä¸€æ”¯
  â””â”€ D6, D7 (Carolç®¡ç†)     â† äºŒæ”¯

ä¼˜åŠ¿ï¼š
- å„åˆ†æ”¯ç‹¬ç«‹ç®¡ç†è‡ªå·±çš„é€è€…
- Alice ä¿ç•™æ•´ä½“æ§åˆ¶æƒï¼ˆå¢“ä¸»ï¼‰
- æ¸…æ™°çš„èŒè´£åˆ’åˆ†
```

---

### åœºæ™¯4ï¼šå¢“ä½è½¬è®©

```
æµç¨‹ï¼š
1. Alice æ‹¥æœ‰å¢“ä½Aï¼Œä¸‹æœ‰é€è€…D1, D2, D3
   â†’ Grave { owner: Alice }
   â†’ Deceased { owner: Alice }

2. Alice å°†å¢“ä½è½¬è®©ç»™ Bob
   â†’ transfer_grave(A, Bob)
   â†’ Grave { owner: Bob }

3. é€è€…owneræœªè‡ªåŠ¨è½¬è®©
   â†’ Deceased { owner: Alice }  â† ä»æ˜¯Alice

4. Bob å¯ä»¥è¶Šæƒç®¡ç†ï¼ˆå¢“ä¸»ç‰¹æƒï¼‰
   â†’ can_manage_deceased(Bob, D1)
      âŒ deceased.owner != Bob
      âœ… can_attach(Bob, grave_id=A) â†’ true

5. å¯é€‰ï¼šBob æ‰¹é‡è½¬è®©é€è€…owner
   â†’ batch_transfer_deceased_owners(A, Bob)
   â†’ Deceased { owner: Bob }

ç»“æœï¼š
- é»˜è®¤ï¼šå¢“ä½è½¬è®©ä¸è‡ªåŠ¨è½¬è®©é€è€…owner
- å¯é€‰ï¼šæ‰¹é‡è½¬è®©é€è€…owner
- çµæ´»ï¼šæ”¯æŒæˆæƒç®¡ç†åœºæ™¯
```

---

### åœºæ™¯5ï¼šé€è€…è½¬ç§»å¢“ä½

```
æµç¨‹ï¼š
1. Alice æ‹¥æœ‰å¢“ä½Aï¼Œä¸‹æœ‰é€è€…D1
   â†’ Deceased { grave_id: A, owner: Alice }

2. Alice åˆ›å»ºæ–°å¢“ä½B
   â†’ Grave { owner: Alice }

3. Alice å°†é€è€…D1 è½¬ç§»åˆ°å¢“ä½B
   â†’ transfer_deceased(D1, B)
   â†’ Deceased { grave_id: B, owner: Alice }

4. é€è€…owneræœªå˜æ›´
   â†’ Alice ä»æ˜¯é€è€…owner

ç»“æœï¼š
- è½¬ç§»å¢“ä½ä¸å½±å“é€è€…owner
- é€‚åˆè¿å¢“åœºæ™¯
```

---

## ğŸ–¥ï¸ å‰ç«¯é›†æˆ

### 1. é€è€…è¯¦æƒ…é¡µ

```typescript
// src/features/deceased/DeceasedDetail.tsx

interface DeceasedDetailProps {
  deceasedId: number;
}

export const DeceasedDetail: React.FC<DeceasedDetailProps> = ({ 
  deceasedId 
}) => {
  const { api, account } = useSubstrate();
  const [deceased, setDeceased] = useState<Deceased | null>(null);
  const [grave, setGrave] = useState<Grave | null>(null);
  const [ownerHistory, setOwnerHistory] = useState<OwnerChangeRecord[]>([]);
  
  // æƒé™çŠ¶æ€
  const [isOwner, setIsOwner] = useState(false);
  const [hasGravePermission, setHasGravePermission] = useState(false);
  const [canManage, setCanManage] = useState(false);
  
  useEffect(() => {
    if (!api || !account) return;
    
    // è·å–é€è€…ä¿¡æ¯
    api.query.deceased.deceasedOf(deceasedId).then(data => {
      const d = data.toJSON() as Deceased;
      setDeceased(d);
      
      // æ£€æŸ¥æƒé™
      setIsOwner(d.owner === account.address);
      
      // è·å–å¢“ä½ä¿¡æ¯
      return api.query.memoGrave.graves(d.graveId);
    }).then(graveData => {
      const g = graveData.toJSON() as Grave;
      setGrave(g);
      
      // æ£€æŸ¥å¢“ä½æƒé™
      const hasGrave = 
        g.owner === account.address ||
        g.admins?.includes(account.address);
      setHasGravePermission(hasGrave);
      
      setCanManage(isOwner || hasGrave);
    });
    
    // è·å–ownerå˜æ›´å†å²
    api.query.deceased.deceasedOwnerHistory(deceasedId).then(data => {
      setOwnerHistory(data.toJSON() as OwnerChangeRecord[]);
    });
  }, [api, account, deceasedId]);
  
  return (
    <Card>
      <Descriptions title="é€è€…ä¿¡æ¯" bordered>
        <Descriptions.Item label="é€è€…ID">
          {deceasedId}
        </Descriptions.Item>
        
        <Descriptions.Item label="æ‰€å±å¢“ä½">
          <Link to={`/grave/${deceased?.graveId}`}>
            å¢“ä½ #{deceased?.graveId}
          </Link>
        </Descriptions.Item>
        
        <Descriptions.Item label="èµ„æ–™ç®¡ç†è€…">
          <Space>
            <Typography.Text code>{deceased?.owner}</Typography.Text>
            {isOwner && <Tag color="green">æ‚¨</Tag>}
          </Space>
        </Descriptions.Item>
        
        <Descriptions.Item label="åˆ›å»ºè€…">
          <Typography.Text code>{deceased?.creator}</Typography.Text>
        </Descriptions.Item>
        
        <Descriptions.Item label="å¢“ä¸»">
          <Space>
            <Typography.Text code>{grave?.owner}</Typography.Text>
            {grave?.owner === account?.address && (
              <Tag color="blue">æ‚¨</Tag>
            )}
          </Space>
        </Descriptions.Item>
        
        <Descriptions.Item label="æ‚¨çš„æƒé™">
          {canManage ? (
            <Space>
              {isOwner && <Tag color="green">èµ„æ–™ç®¡ç†è€…</Tag>}
              {hasGravePermission && <Tag color="blue">å¢“ä½æƒé™</Tag>}
            </Space>
          ) : (
            <Tag color="default">ä»…æŸ¥çœ‹</Tag>
          )}
        </Descriptions.Item>
      </Descriptions>
      
      {/* æ“ä½œæŒ‰é’® */}
      <Space style={{ marginTop: 16 }}>
        <Button
          type="primary"
          disabled={!canManage}
          onClick={() => showEditModal()}
        >
          ç¼–è¾‘èµ„æ–™
        </Button>
        
        <Button
          disabled={!canManage}
          onClick={() => showSetImageModal()}
        >
          è®¾ç½®ä¸»å›¾
        </Button>
        
        <Dropdown
          disabled={!canManage}
          menu={{
            items: [
              {
                key: 'transfer-owner',
                label: 'è½¬è®©èµ„æ–™ç®¡ç†æƒ',
                disabled: !isOwner && !hasGravePermission,
              },
              {
                key: 'transfer-grave',
                label: 'è½¬ç§»å¢“ä½',
                disabled: !hasGravePermission,
              },
            ],
            onClick: handleMenuClick,
          }}
        >
          <Button>æ›´å¤šæ“ä½œ</Button>
        </Dropdown>
      </Space>
      
      {/* ownerå˜æ›´å†å² */}
      {ownerHistory.length > 0 && (
        <Card 
          title="èµ„æ–™ç®¡ç†æƒè½¬è®©å†å²" 
          size="small" 
          style={{ marginTop: 16 }}
        >
          <Timeline>
            {ownerHistory.map((record, index) => (
              <Timeline.Item key={index}>
                <Space direction="vertical" size="small">
                  <Typography.Text>
                    {record.fromOwner} â†’ {record.toOwner}
                  </Typography.Text>
                  <Typography.Text type="secondary" style={{ fontSize: 12 }}>
                    å‘èµ·äºº: {record.changedBy}
                  </Typography.Text>
                  <Typography.Text type="secondary" style={{ fontSize: 12 }}>
                    åŒºå—: #{record.changedAt}
                  </Typography.Text>
                </Space>
              </Timeline.Item>
            ))}
          </Timeline>
        </Card>
      )}
    </Card>
  );
};
```

---

### 2. è½¬è®©é€è€…ownerå¯¹è¯æ¡†

```typescript
// src/features/deceased/TransferOwnerModal.tsx

interface TransferOwnerModalProps {
  deceasedId: number;
  currentOwner: string;
  visible: boolean;
  onClose: () => void;
  onSuccess: () => void;
}

export const TransferOwnerModal: React.FC<TransferOwnerModalProps> = ({
  deceasedId,
  currentOwner,
  visible,
  onClose,
  onSuccess,
}) => {
  const { api, account } = useSubstrate();
  const [form] = Form.useForm();
  const [loading, setLoading] = useState(false);
  
  const handleSubmit = async (values: { newOwner: string }) => {
    if (!api || !account) return;
    
    setLoading(true);
    
    try {
      const tx = api.tx.deceased.transferDeceasedOwner(
        deceasedId,
        values.newOwner
      );
      
      await tx.signAndSend(account.address, ({ status, events }) => {
        if (status.isInBlock) {
          message.success('è½¬è®©æˆåŠŸï¼');
          onSuccess();
          onClose();
        }
      });
    } catch (error) {
      message.error('è½¬è®©å¤±è´¥ï¼š' + error.message);
    } finally {
      setLoading(false);
    }
  };
  
  return (
    <Modal
      title="è½¬è®©é€è€…èµ„æ–™ç®¡ç†æƒ"
      open={visible}
      onCancel={onClose}
      footer={null}
    >
      <Alert
        message="æƒé™è¯´æ˜"
        description={
          <Space direction="vertical" size="small">
            <Typography.Text>
              â€¢ è½¬è®©åï¼Œæ–°ç®¡ç†è€…å¯ä»¥ä¿®æ”¹é€è€…èµ„æ–™
            </Typography.Text>
            <Typography.Text>
              â€¢ å¢“ä¸»ä»ä¿ç•™è¶Šæƒç®¡ç†èƒ½åŠ›
            </Typography.Text>
            <Typography.Text>
              â€¢ ä¸å½±å“å¢“ä½å½’å±å’Œå…¶ä»–é€è€…
            </Typography.Text>
          </Space>
        }
        type="info"
        showIcon
        style={{ marginBottom: 16 }}
      />
      
      <Form
        form={form}
        layout="vertical"
        onFinish={handleSubmit}
      >
        <Form.Item label="å½“å‰ç®¡ç†è€…">
          <Input value={currentOwner} disabled />
        </Form.Item>
        
        <Form.Item
          label="æ–°ç®¡ç†è€…åœ°å€"
          name="newOwner"
          rules={[
            { required: true, message: 'è¯·è¾“å…¥æ–°ç®¡ç†è€…åœ°å€' },
            { 
              pattern: /^5[A-Za-z0-9]{47}$/, 
              message: 'è¯·è¾“å…¥æœ‰æ•ˆçš„Substrateåœ°å€' 
            },
          ]}
        >
          <Input placeholder="5GrwvaEF5zXb26Fz9..." />
        </Form.Item>
        
        <Form.Item>
          <Space>
            <Button type="primary" htmlType="submit" loading={loading}>
              ç¡®è®¤è½¬è®©
            </Button>
            <Button onClick={onClose}>
              å–æ¶ˆ
            </Button>
          </Space>
        </Form.Item>
      </Form>
    </Modal>
  );
};
```

---

### 3. å¢“ä½è¯¦æƒ…é¡µ - æ‰¹é‡è½¬è®©

```typescript
// src/features/grave/GraveDetail.tsx

export const GraveDetail: React.FC<{ graveId: number }> = ({ graveId }) => {
  const { api, account } = useSubstrate();
  const [grave, setGrave] = useState<Grave | null>(null);
  const [deceasedList, setDeceasedList] = useState<DeceasedWithOwner[]>([]);
  const [isOwner, setIsOwner] = useState(false);
  
  useEffect(() => {
    // è·å–å¢“ä½ä¿¡æ¯å’Œé€è€…åˆ—è¡¨
    // ...
  }, []);
  
  const handleBatchTransfer = async () => {
    Modal.confirm({
      title: 'æ‰¹é‡è½¬è®©æ‰€æœ‰é€è€…çš„èµ„æ–™ç®¡ç†æƒ',
      content: (
        <Space direction="vertical">
          <Typography.Text>
            å°†å¢“ä½ä¸‹æ‰€æœ‰ {deceasedList.length} ä¸ªé€è€…çš„èµ„æ–™ç®¡ç†æƒè½¬è®©ç»™ï¼š
          </Typography.Text>
          <Input 
            placeholder="æ–°ç®¡ç†è€…åœ°å€" 
            onChange={(e) => setNewOwner(e.target.value)}
          />
          <Alert
            message="æ­¤æ“ä½œä¼šè½¬è®©æ‰€æœ‰é€è€…ï¼Œè¯·è°¨æ…æ“ä½œ"
            type="warning"
            showIcon
          />
        </Space>
      ),
      onOk: async () => {
        const tx = api.tx.deceased.batchTransferDeceasedOwners(
          graveId,
          newOwner
        );
        
        await tx.signAndSend(account.address, ({ status }) => {
          if (status.isInBlock) {
            message.success('æ‰¹é‡è½¬è®©æˆåŠŸï¼');
          }
        });
      },
    });
  };
  
  return (
    <Card>
      {/* å¢“ä½ä¿¡æ¯ */}
      
      {/* é€è€…åˆ—è¡¨ */}
      <Table
        columns={[
          { title: 'ID', dataIndex: 'id' },
          { title: 'å§“å', dataIndex: 'name' },
          { 
            title: 'èµ„æ–™ç®¡ç†è€…', 
            dataIndex: 'owner',
            render: (owner) => (
              <Space>
                <Typography.Text code>{owner}</Typography.Text>
                {owner === grave?.owner && <Tag color="blue">å¢“ä¸»</Tag>}
              </Space>
            ),
          },
        ]}
        dataSource={deceasedList}
      />
      
      {isOwner && (
        <Button
          type="primary"
          danger
          onClick={handleBatchTransfer}
          style={{ marginTop: 16 }}
        >
          æ‰¹é‡è½¬è®©æ‰€æœ‰é€è€…
        </Button>
      )}
    </Card>
  );
};
```

---

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### 1. æƒé™æµ‹è¯•

```rust
#[test]
fn test_deceased_owner_can_manage() {
    new_test_ext().execute_with(|| {
        // 1. Aliceåˆ›å»ºå¢“ä½
        assert_ok!(MemoGrave::create_grave(RuntimeOrigin::signed(ALICE), ...));
        
        // 2. Aliceåˆ›å»ºé€è€…D1
        assert_ok!(Deceased::create_deceased(
            RuntimeOrigin::signed(ALICE),
            1, // grave_id
            ...
        ));
        
        // 3. Aliceè½¬è®©é€è€…ownerç»™Bob
        assert_ok!(Deceased::transfer_deceased_owner(
            RuntimeOrigin::signed(ALICE),
            1, // deceased_id
            BOB
        ));
        
        // 4. Bobå¯ä»¥ä¿®æ”¹é€è€…èµ„æ–™
        assert_ok!(Deceased::update_deceased(
            RuntimeOrigin::signed(BOB),
            1,
            Some(b"New Name".to_vec()),
            None,
            None,
            None,
        ));
        
        // 5. Aliceä»å¯ä»¥è¶Šæƒä¿®æ”¹ï¼ˆå¢“ä¸»ç‰¹æƒï¼‰
        assert_ok!(Deceased::update_deceased(
            RuntimeOrigin::signed(ALICE),
            1,
            Some(b"Another Name".to_vec()),
            None,
            None,
            None,
        ));
        
        // 6. Charlieä¸èƒ½ä¿®æ”¹ï¼ˆæ— æƒé™ï¼‰
        assert_noop!(
            Deceased::update_deceased(
                RuntimeOrigin::signed(CHARLIE),
                1,
                Some(b"Hacked".to_vec()),
                None,
                None,
                None,
            ),
            Error::<Test>::NotAuthorized
        );
    });
}
```

### 2. æ‰¹é‡è½¬è®©æµ‹è¯•

```rust
#[test]
fn test_batch_transfer_deceased_owners() {
    new_test_ext().execute_with(|| {
        // 1. Aliceåˆ›å»ºå¢“ä½å’Œ3ä¸ªé€è€…
        assert_ok!(MemoGrave::create_grave(RuntimeOrigin::signed(ALICE), ...));
        assert_ok!(Deceased::create_deceased(RuntimeOrigin::signed(ALICE), 1, ...));
        assert_ok!(Deceased::create_deceased(RuntimeOrigin::signed(ALICE), 1, ...));
        assert_ok!(Deceased::create_deceased(RuntimeOrigin::signed(ALICE), 1, ...));
        
        // 2. æ‰¹é‡è½¬è®©ç»™Bob
        assert_ok!(Deceased::batch_transfer_deceased_owners(
            RuntimeOrigin::signed(ALICE),
            1, // grave_id
            BOB
        ));
        
        // 3. éªŒè¯æ‰€æœ‰é€è€…owneréƒ½æ˜¯Bob
        let d1 = Deceased::deceased_of(1).unwrap();
        let d2 = Deceased::deceased_of(2).unwrap();
        let d3 = Deceased::deceased_of(3).unwrap();
        assert_eq!(d1.owner, BOB);
        assert_eq!(d2.owner, BOB);
        assert_eq!(d3.owner, BOB);
        
        // 4. Bobå¯ä»¥ç®¡ç†æ‰€æœ‰é€è€…
        assert_ok!(Deceased::update_deceased(RuntimeOrigin::signed(BOB), 1, ...));
        assert_ok!(Deceased::update_deceased(RuntimeOrigin::signed(BOB), 2, ...));
        assert_ok!(Deceased::update_deceased(RuntimeOrigin::signed(BOB), 3, ...));
    });
}
```

---

## ğŸ“ æ–‡æ¡£ä¸æ³¨é‡Š

### 1. READMEæ›´æ–°

````markdown
## æƒé™æ¨¡å‹ï¼ˆåŒå±‚èŒè´£åˆ†ç¦»ï¼‰

### æ ¸å¿ƒæ¦‚å¿µ

æœ¬palleté‡‡ç”¨**åŒå±‚èŒè´£åˆ†ç¦»**çš„æƒé™æ¨¡å‹ï¼š

```
å¢“ä½å±‚ï¼ˆåŸºç¡€è®¾æ–½ï¼‰
  â””â”€ å¢“ä¸»/ç®¡ç†å‘˜ï¼šç®¡ç†å¢“ä½æœ¬èº« + è¶Šæƒç®¡ç†é€è€…

é€è€…å±‚ï¼ˆå†…å®¹ç®¡ç†ï¼‰
  â””â”€ é€è€…ownerï¼šç®¡ç†é€è€…èµ„æ–™ï¼ˆä¼˜å…ˆæƒï¼‰
```

### æƒé™è¯´æ˜

#### å¢“ä½å±‚æƒé™

| è§’è‰² | æƒé™ |
|------|------|
| **å¢“ä¸»** | è½¬è®©å¢“ä½ã€æ·»åŠ ç®¡ç†å‘˜ã€è®¾ç½®å°é¢/éŸ³ä¹ã€è¶Šæƒç®¡ç†é€è€… |
| **å¢“ä½ç®¡ç†å‘˜** | è®¾ç½®å°é¢/éŸ³ä¹ï¼ˆéƒ¨åˆ†ï¼‰ã€åˆ›å»ºé€è€…ã€è¶Šæƒç®¡ç†é€è€… |
| **å›­åŒºç®¡ç†å‘˜** | ç®¡ç†å›­åŒºä¸‹æ‰€æœ‰å¢“ä½å’Œé€è€… |

#### é€è€…å±‚æƒé™

| è§’è‰² | æƒé™ |
|------|------|
| **é€è€…owner** | ä¿®æ”¹èµ„æ–™ã€è®¾ç½®ä¸»å›¾ã€ç®¡ç†å…³ç³»ã€ç®¡ç†äº²å‹å›¢ã€è½¬è®©owner |
| **creator** | æ— æƒé™ï¼ˆä»…å®¡è®¡ç”¨ï¼‰ |

### æƒé™æ£€æŸ¥ä¼˜å…ˆçº§

```rust
pub fn can_manage_deceased(who, deceased_id) -> bool {
    // 1) ä¼˜å…ˆï¼šé€è€…owner
    if deceased.owner == who {
        return true;
    }
    
    // 2) å…œåº•ï¼šå¢“ä½æƒé™ï¼ˆå¢“ä¸»/ç®¡ç†å‘˜/å›­åŒºç®¡ç†å‘˜ï¼‰
    if can_attach(who, deceased.grave_id) {
        return true;
    }
    
    return false;
}
```

### å…¸å‹åœºæ™¯

#### åœºæ™¯1ï¼šé»˜è®¤ç®¡ç†ï¼ˆç®€å•ï¼‰

```
å¢“ä¸» Alice åˆ›å»ºé€è€… D1
â†’ Deceased { owner: Alice, creator: Alice }
â†’ Alice ç›´æ¥ç®¡ç†
```

#### åœºæ™¯2ï¼šæˆæƒç®¡ç†ï¼ˆçµæ´»ï¼‰

```
å¢“ä¸» Alice æˆæƒ Bob ç®¡ç†é€è€… D1
â†’ transfer_deceased_owner(D1, Bob)
â†’ Deceased { owner: Bob }
â†’ Bob ä¼˜å…ˆç®¡ç†ï¼ŒAlice ä¿ç•™è¶Šæƒèƒ½åŠ›
```

#### åœºæ™¯3ï¼šå®¶æ—å¢“ï¼ˆå¤æ‚ï¼‰

```
å®¶æ—é•¿ Alice åˆ›å»ºå®¶æ—å¢“
â†’ D1, D2 (Aliceç®¡ç†) â† ç¥–è¾ˆ
â†’ D3, D4 (Bobç®¡ç†)   â† ä¸€æ”¯åäºº
â†’ D5, D6 (Carolç®¡ç†) â† äºŒæ”¯åäºº
â†’ å„åˆ†æ”¯ç‹¬ç«‹ç®¡ç†ï¼ŒAlice ä¿ç•™æ•´ä½“æ§åˆ¶
```

### ç›¸å…³æ¥å£

#### è½¬è®©é€è€…owner

```rust
// å•ä¸ªè½¬è®©
deceased.transfer_deceased_owner(deceased_id, new_owner)

// æ‰¹é‡è½¬è®©
deceased.batch_transfer_deceased_owners(grave_id, new_owner)
```

#### æŸ¥è¯¢æ¥å£

```rust
// æŸ¥è¯¢ownerå˜æ›´å†å²
deceased.deceased_owner_history(deceased_id)

// æŸ¥è¯¢å¢“ä½ä¸‹æ‰€æœ‰é€è€…owner
deceased.get_deceased_owners_in_grave(grave_id)
```
````

---

## ğŸš€ å®æ–½è®¡åˆ’

### Phase 1: é“¾ç«¯å®ç°ï¼ˆ8å°æ—¶ï¼‰

**Step 1: æ•°æ®ç»“æ„è°ƒæ•´ï¼ˆ2hï¼‰**
```rust
// 1. å¢å¼ºDeceasedç»“æ„ï¼ˆå·²æœ‰ownerå­—æ®µï¼Œæ·»åŠ è¯¦ç»†æ³¨é‡Šï¼‰
// 2. æ–°å¢DeceasedOwnerHistoryå­˜å‚¨
// 3. æ–°å¢OwnerChangeRecordç»“æ„
```

**Step 2: æƒé™å‡½æ•°å®ç°ï¼ˆ2hï¼‰**
```rust
// 1. can_manage_deceasedï¼ˆåŒå±‚æ£€æŸ¥ï¼‰
// 2. is_deceased_ownerï¼ˆä¸¥æ ¼æ£€æŸ¥ï¼‰
// 3. has_grave_permissionï¼ˆå¢“ä½æƒé™ï¼‰
```

**Step 3: Extrinsicå®ç°ï¼ˆ3hï¼‰**
```rust
// 1. transfer_deceased_ownerï¼ˆå•ä¸ªè½¬è®©ï¼‰
// 2. batch_transfer_deceased_ownersï¼ˆæ‰¹é‡è½¬è®©ï¼‰
// 3. do_transfer_deceased_ownerï¼ˆå†…éƒ¨å‡½æ•°ï¼‰
// 4. æ›´æ–°æ‰€æœ‰extrinsicçš„æƒé™æ£€æŸ¥ä¸ºcan_manage_deceased
```

**Step 4: æµ‹è¯•ä¸ç¼–è¯‘ï¼ˆ1hï¼‰**
```bash
cargo test -p pallet-deceased
cargo build --release
```

---

### Phase 2: å‰ç«¯é›†æˆï¼ˆ6å°æ—¶ï¼‰

**Step 1: åŸºç¡€ç»„ä»¶ï¼ˆ2hï¼‰**
```typescript
// 1. é€è€…è¯¦æƒ…é¡µå¢å¼ºï¼ˆæ˜¾ç¤ºownerã€creatorã€æƒé™ï¼‰
// 2. æƒé™æç¤ºç»„ä»¶
// 3. ownerå†å²å±•ç¤º
```

**Step 2: è½¬è®©åŠŸèƒ½ï¼ˆ2hï¼‰**
```typescript
// 1. TransferOwnerModalï¼ˆå•ä¸ªè½¬è®©ï¼‰
// 2. BatchTransferModalï¼ˆæ‰¹é‡è½¬è®©ï¼‰
// 3. è¡¨å•éªŒè¯ä¸æäº¤
```

**Step 3: å¢“ä½ç®¡ç†ï¼ˆ1hï¼‰**
```typescript
// 1. å¢“ä½è¯¦æƒ…é¡µå¢å¼ºï¼ˆé€è€…åˆ—è¡¨æ˜¾ç¤ºownerï¼‰
// 2. æ‰¹é‡è½¬è®©æŒ‰é’®ä¸é€»è¾‘
```

**Step 4: æµ‹è¯•ä¸ä¼˜åŒ–ï¼ˆ1hï¼‰**
```bash
npm run test
npm run lint
```

---

### Phase 3: æ–‡æ¡£ä¸åŸ¹è®­ï¼ˆ2å°æ—¶ï¼‰

**Step 1: æŠ€æœ¯æ–‡æ¡£ï¼ˆ1hï¼‰**
- READMEæ›´æ–°
- æ¥å£æ–‡æ¡£
- æƒé™æ¨¡å‹è¯´æ˜

**Step 2: ç”¨æˆ·æŒ‡å—ï¼ˆ1hï¼‰**
- æ“ä½œæ‰‹å†Œ
- å¸¸è§é—®é¢˜
- å…¸å‹åœºæ™¯ç¤ºä¾‹

---

## ğŸ“Š ä¼˜åŠ¿ä¸æˆæœ¬è¯„ä¼°

### ä¼˜åŠ¿

| ä¼˜åŠ¿ | è¯´æ˜ | ä»·å€¼ |
|------|------|------|
| **çµæ´»æ€§** | æ”¯æŒæˆæƒç®¡ç†ã€å®¶æ—å¢“åˆ†æ”¯ç®¡ç† | â­â­â­â­â­ |
| **æ¸…æ™°æ€§** | èŒè´£åˆ†ç¦»ï¼Œæ¦‚å¿µæ˜ç¡® | â­â­â­â­ |
| **å…¼å®¹æ€§** | å‘åå…¼å®¹ï¼Œä¿ç•™ç°æœ‰ç»“æ„ | â­â­â­â­â­ |
| **å®‰å…¨æ€§** | å¤šå±‚æƒé™ä¿æŠ¤ï¼Œè®°å½•å˜æ›´å†å² | â­â­â­â­â­ |
| **å¯æ‰©å±•æ€§** | ä¸ºæœªæ¥VIPæœåŠ¡ã€ä»£ç†ç®¡ç†é¢„ç•™ç©ºé—´ | â­â­â­â­â­ |

### æˆæœ¬

| é¡¹ç›® | å·¥ä½œé‡ | é£é™© |
|------|--------|------|
| **é“¾ç«¯å¼€å‘** | 8å°æ—¶ | ğŸŸ¢ ä½ |
| **å‰ç«¯å¼€å‘** | 6å°æ—¶ | ğŸŸ¢ ä½ |
| **æ–‡æ¡£ç¼–å†™** | 2å°æ—¶ | ğŸŸ¢ ä½ |
| **å­˜å‚¨å¼€é”€** | +32å­—èŠ‚/é€è€…ï¼ˆownerå†å²ï¼‰ | ğŸŸ¡ ä¸­ |
| **Gasæˆæœ¬** | +10% per txï¼ˆåŒå±‚æ£€æŸ¥ï¼‰ | ğŸŸ¢ ä½ |

**æ€»å·¥ä½œé‡**: 16å°æ—¶ï¼ˆ2ä¸ªå·¥ä½œæ—¥ï¼‰

---

## ğŸ¯ ä¸æ–¹æ¡ˆAå¯¹æ¯”

| ç»´åº¦ | æ–¹æ¡ˆAï¼ˆç»Ÿä¸€ï¼‰ | æ–¹æ¡ˆBï¼ˆåˆ†ç¦»ï¼‰ | èƒœè€… |
|------|-------------|-------------|------|
| **æ¸…æ™°æ€§** | â­â­â­â­â­ | â­â­â­â­ | A |
| **ç®€æ´æ€§** | â­â­â­â­â­ | â­â­â­ | A |
| **çµæ´»æ€§** | â­â­â­ | â­â­â­â­â­ | B |
| **é€‚ç”¨åœºæ™¯** | 90%ç”¨æˆ· | 100%ç”¨æˆ· | B |
| **å®æ–½æˆæœ¬** | 3.5h | 16h | A |
| **å­˜å‚¨æˆæœ¬** | 0 | +32å­—èŠ‚/é€è€… | A |
| **Gasæˆæœ¬** | -5% | +10% | A |
| **æœªæ¥æ‰©å±•** | â­â­â­ | â­â­â­â­â­ | B |

---

## âœ… å†³ç­–å»ºè®®

### æ¨èè·¯å¾„ï¼šåˆ†é˜¶æ®µå®æ–½

**é˜¶æ®µ1: å…ˆå®æ–½æ–¹æ¡ˆAï¼ˆç«‹å³ï¼‰**
- âœ… å¿«é€Ÿè§£å†³å½“å‰æ··æ·†é—®é¢˜
- âœ… 3.5å°æ—¶å®Œæˆ
- âœ… é›¶é£é™©

**é˜¶æ®µ2: æ ¹æ®éœ€æ±‚å‡çº§åˆ°æ–¹æ¡ˆBï¼ˆå¯é€‰ï¼‰**
- â° è§¦å‘æ¡ä»¶ï¼šç”¨æˆ·åé¦ˆéœ€è¦æˆæƒç®¡ç†
- â° å·¥ä½œé‡ï¼š16å°æ—¶
- â° å¢é‡å‡çº§ï¼ŒåŸºäºæ–¹æ¡ˆA

**ç†ç”±**:
1. âœ… **å¿«é€Ÿè§£å†³ç—›ç‚¹**: æ–¹æ¡ˆAç«‹å³æ¶ˆé™¤æ··æ·†
2. âœ… **é™ä½é£é™©**: å…ˆç®€åç¹ï¼Œé€æ­¥è¿­ä»£
3. âœ… **ä¿ç•™çµæ´»æ€§**: æ–¹æ¡ˆAå¯æ— ç¼å‡çº§åˆ°æ–¹æ¡ˆB
4. âœ… **èŠ‚çº¦æˆæœ¬**: ä»…åœ¨éœ€è¦æ—¶æŠ•å…¥é¢å¤–å·¥ä½œ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- **æ–¹æ¡ˆå¯¹æ¯”**: `/docs/å¢“ä½ä¸é€è€…æƒé™æ¨¡å‹-ä¼˜åŒ–è®¾è®¡æ–¹æ¡ˆ.md`
- **æ–¹æ¡ˆAè®¾è®¡**: è§ä¸Šè¿°æ–‡æ¡£ Phase 1
- **å¢“ä½æ¨¡å—**: `/pallets/stardust-grave/README.md`
- **é€è€…æ¨¡å—**: `/pallets/deceased/README.md`

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-24  
**åˆ†æè€…**: AI Assistant  
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0 - æ–¹æ¡ˆBè¯¦ç»†è®¾è®¡  
**çŠ¶æ€**: âœ… è®¾è®¡å®Œæˆï¼Œå¾…å†³ç­–å®æ–½

