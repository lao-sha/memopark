# 做市商申请详情显示功能说明

## 功能概述

在做市商申请页面（`http://localhost:5173/#/otc/mm-apply`）添加已质押详情和提交资料详情的显示功能，让用户清楚地看到申请的完整信息。

## 新增功能

### 1. **已质押详情卡片** 📋

**位置**：步骤2（提交资料）页面的顶部

**显示内容**：
- ✅ 做市商 ID
- ✅ 申请人地址（可复制）
- ✅ 质押金额（自动转换为 MEMO）
- ✅ 创建时间（本地时间格式）
- ✅ 资料提交截止时间
- ✅ 申请状态标签（颜色编码）

**状态颜色**：
- 🟠 `DepositLocked`（已质押）：橙色
- 🔵 `PendingReview`（待审核）：蓝色
- 🟢 `Active`（已批准）：绿色
- ⚪ 其他状态：默认色

### 2. **已提交资料详情** 📄

**显示条件**：
- 当申请状态为 `PendingReview` 时
- 且已提交公开资料 CID

**显示内容**：
- ✅ 公开资料 CID（可复制）
- ✅ 私密资料 CID（可复制）
- ✅ 费率（百分比 + bps）
- ✅ 最小下单额（MEMO）
- ✅ 审核截止时间
- ✅ 审核状态提示

### 3. **自动加载功能** 🔄

**触发时机**：
- 页面加载时（如果有 mmId）
- 质押成功后
- 提交资料成功后（延迟3秒等待区块确认）
- mmId 或 API 状态变化时

## 技术实现

### 1. **数据结构**

```typescript
interface ApplicationDetails {
  mmId: number              // 做市商 ID
  owner: string             // 申请人地址
  deposit: string           // 质押金额（12位小数）
  status: string            // 申请状态
  publicCid: string         // 公开资料 CID
  privateCid: string        // 私密资料 CID
  feeBps: number            // 费率（bps）
  minAmount: string         // 最小金额（12位小数）
  createdAt: number         // 创建时间（秒）
  infoDeadline: number      // 资料提交截止（秒）
  reviewDeadline: number    // 审核截止（秒）
}
```

### 2. **状态管理**

```typescript
const [appDetails, setAppDetails] = React.useState<ApplicationDetails | null>(null)
const [loadingDetails, setLoadingDetails] = React.useState<boolean>(false)
```

### 3. **查询函数**

```typescript
/**
 * 函数级详细中文注释：加载申请详情
 * - 从链上查询指定 mmId 的申请详情
 * - 包含质押信息和提交资料信息
 */
const loadApplicationDetails = React.useCallback(async (id: number) => {
  if (!api) return
  
  try {
    setLoadingDetails(true)
    
    // 检查 pallet 是否存在
    if (!(api.query as any).marketMaker) {
      return
    }

    // 查询申请详情
    const appOption = await (api.query as any).marketMaker.applications(id)
    
    if (appOption.isSome) {
      const app = appOption.unwrap()
      const appData = app.toJSON()
      
      // 解析 CID（从 Uint8Array 转字符串）
      const publicCid = // ... 转换逻辑
      const privateCid = // ... 转换逻辑
      
      const details: ApplicationDetails = {
        // ... 构建详情对象
      }
      
      setAppDetails(details)
    }
  } catch (e) {
    console.error('[查询] 加载详情失败:', e)
  } finally {
    setLoadingDetails(false)
  }
}, [api])
```

### 4. **自动加载钩子**

```typescript
/**
 * 函数级详细中文注释：当 mmId 或 API 变化时，加载详情
 */
React.useEffect(() => {
  if (mmId !== null && api) {
    loadApplicationDetails(mmId)
  }
}, [mmId, api, loadApplicationDetails])
```

### 5. **CID 解析**

```typescript
// 解析 CID（从 Uint8Array 转字符串）
const publicCid = appData.publicCid ? 
  (Array.isArray(appData.publicCid) ? 
    new TextDecoder().decode(new Uint8Array(appData.publicCid)) : 
    appData.publicCid) : ''
```

### 6. **金额格式化**

```typescript
// MEMO 使用 12 位小数
{(BigInt(appDetails.deposit) / BigInt(1e12)).toString()} MEMO
```

## 页面布局

### 步骤2：提交资料页面

```
┌────────────────────────────────────────┐
│ [✓] 质押保证金  [○] 提交资料（待审）  │
├────────────────────────────────────────┤
│ ✓ 质押成功！mmId = 0                   │
│   [剩余时间: XX 小时] 截止时间: ...     │
├────────────────────────────────────────┤
│ 已质押详情              [DepositLocked]│
│ ┌────────────────────────────────────┐ │
│ │ 做市商 ID:      0                  │ │
│ │ 申请人地址:     5GrwV... [复制]    │ │
│ │ 质押金额:       1000 MEMO          │ │
│ │ 创建时间:       2025-10-06 10:00   │ │
│ │ 资料提交截止:   2025-10-07 10:00   │ │
│ └────────────────────────────────────┘ │
│                                        │
│ ─────── 已提交资料详情 ─────           │
│ ┌────────────────────────────────────┐ │
│ │ 公开资料 CID:   bafy... [复制]     │ │
│ │ 私密资料 CID:   bafy... [复制]     │ │
│ │ 费率:           0.25% (25 bps)     │ │
│ │ 最小下单额:     100 MEMO           │ │
│ │ 审核截止时间:   2025-10-14 10:00   │ │
│ └────────────────────────────────────┘ │
│ ℹ️ 资料已提交，等待委员会审核          │
├────────────────────────────────────────┤
│ [公开资料根 CID]                       │
│ [私密资料根 CID]                       │
│ [费率 (bps)]                           │
│ [最小下单额]                           │
│ [提交资料]                             │
│ [返回上一步]                           │
└────────────────────────────────────────┘
```

## 用户体验优化

### 1. **加载状态**

```tsx
{loadingDetails && (
  <Card style={{ marginBottom: 12 }} size="small">
    <Spin tip="正在加载申请详情..." />
  </Card>
)}
```

### 2. **地址复制功能**

```tsx
<Typography.Text 
  copyable={{ text: appDetails.owner, icon: <CopyOutlined /> }}
  ellipsis={{ tooltip: appDetails.owner }}
  style={{ maxWidth: 400 }}
>
  {appDetails.owner}
</Typography.Text>
```

### 3. **CID 复制功能**

```tsx
<Typography.Text 
  copyable={{ text: appDetails.publicCid, icon: <CopyOutlined /> }}
  ellipsis={{ tooltip: appDetails.publicCid }}
  style={{ maxWidth: 400, fontSize: 12 }}
>
  {appDetails.publicCid}
</Typography.Text>
```

### 4. **时间格式化**

```tsx
{new Date(appDetails.createdAt * 1000).toLocaleString('zh-CN')}
```

### 5. **条件显示**

```tsx
{appDetails.publicCid && appDetails.status === 'PendingReview' && (
  <>
    <Divider>已提交资料详情</Divider>
    {/* 显示提交资料详情 */}
  </>
)}
```

## 状态流转

### 状态1：DepositLocked（已质押）

**显示内容**：
- 基本质押信息
- 不显示提交资料详情
- 允许填写表单提交资料

### 状态2：PendingReview（待审核）

**显示内容**：
- 基本质押信息
- **已提交资料详情**
- 提示"资料已提交，等待委员会审核"
- 表单仍可见（可修改重新提交）

### 状态3：Active（已批准）

**显示内容**：
- 基本质押信息
- 已提交资料详情
- 状态标签为绿色
- 申请完成，可以开始做市

## 数据来源

### 链上查询

```typescript
// 查询申请详情
const appOption = await api.query.marketMaker.applications(mmId)

if (appOption.isSome) {
  const app = appOption.unwrap()
  const appData = app.toJSON()
  // 处理数据...
}
```

### 数据字段映射

| 链上字段 | 前端字段 | 转换 |
|----------|---------|------|
| `owner` | `owner` | 直接使用 |
| `deposit` | `deposit` | BigInt / 1e12 |
| `status` | `status` | 枚举转字符串 |
| `publicCid` | `publicCid` | Uint8Array → String |
| `privateCid` | `privateCid` | Uint8Array → String |
| `feeBps` | `feeBps` | 直接使用 |
| `minAmount` | `minAmount` | BigInt / 1e12 |
| `createdAt` | `createdAt` | 时间戳（秒） |
| `infoDeadline` | `infoDeadline` | 时间戳（秒） |
| `reviewDeadline` | `reviewDeadline` | 时间戳（秒） |

## 错误处理

### 1. **查询失败**

```typescript
catch (e) {
  console.error('[查询] 加载详情失败:', e)
}
```

### 2. **数据不存在**

```typescript
if (appOption.isSome) {
  // 处理数据
} else {
  console.warn('[查询] 申请不存在:', id)
  setAppDetails(null)
}
```

### 3. **Pallet 不存在**

```typescript
if (!(api.query as any).marketMaker) {
  console.warn('pallet-market-maker 不存在')
  return
}
```

## 更新时机

### 1. **提交资料后自动刷新**

```typescript
// 提交资料成功
message.success({
  content: `资料提交成功！交易哈希: ${hash}`,
  key: 'submit',
  duration: 5
})

// 等待区块确认后重新加载详情
await new Promise(resolve => setTimeout(resolve, 3000))
if (mmId !== null) {
  await loadApplicationDetails(mmId)
}
```

### 2. **延迟加载**

- 等待 3 秒让区块确认
- 确保链上状态已更新
- 然后查询最新详情

## 相关文件

- **申请页面**：`memopark-dapp/src/features/otc/CreateMarketMakerPage.tsx`
- **Pallet**：`pallets/market-maker/src/lib.rs`
- **Pallet 文档**：`pallets/market-maker/README.md`

## 测试要点

### 功能测试

- ✅ 质押成功后显示已质押详情
- ✅ 详情包含所有必要信息
- ✅ 地址和 CID 可复制
- ✅ 金额正确转换（12位小数）
- ✅ 时间正确显示（本地格式）
- ✅ 状态标签颜色正确

### 提交资料测试

- ✅ 提交资料成功后自动刷新详情
- ✅ 显示已提交资料详情区域
- ✅ 状态从 DepositLocked 变为 PendingReview
- ✅ 显示审核提示

### 边界情况测试

- ✅ mmId 为 null 时不查询
- ✅ API 未连接时不查询
- ✅ 链上数据不存在时正确处理
- ✅ 加载失败时不影响其他功能

## 完成日期

2025-10-06

## 遵循规则

- ✅ 函数级详细中文注释
- ✅ 显示已质押详情
- ✅ 显示提交资料详情
- ✅ 自动加载和刷新
- ✅ 用户体验优化（复制、格式化等）
- ✅ 错误处理完善
- ✅ 状态管理清晰

