# Stardust 前端冗余代码清理 - 快速开始

**最后更新**: 2025-11-02  
**预计时间**: 30-60 分钟  
**难度**: ⭐⭐ (简单)

---

## 📋 概览

基于链端 Pallet 整合（pallet-trading、pallet-memorial 等），前端存在少量需要更新的 API 调用和冗余模块。

**主要问题**:
- 3 个文件使用旧 Pallet API（影响功能）
- 1 个冗余模块（deceasedMedia，434 行）
- ~50 个文档需要整理

---

## 🚀 快速执行（推荐）

### 方案 A：自动化一键清理

```bash
cd /home/xiaodong/文档/stardust/stardust-dapp

# 1. 创建清理分支（安全起见）
git checkout -b cleanup/frontend-redundancy

# 2. 运行一键清理脚本
./cleanup-all.sh

# 3. 测试功能
npm run dev
# 浏览器打开 http://localhost:5173
# 测试：做市商申请、OTC订单、桥接等

# 4. 如果一切正常，推送
git push origin cleanup/frontend-redundancy

# 5. 创建 Pull Request 合并到 main
```

**时间**: ~10 分钟（脚本执行） + 20 分钟（测试）

---

## 🔧 手动执行（精细控制）

### Step 1: API 调用修复（必须）

```bash
cd /home/xiaodong/文档/stardust/stardust-dapp

# 运行 API 修复脚本
./fix-pallet-api.sh

# 查看修改
git diff src/

# 确认无误后提交
git add src/
git commit -m "fix: 更新 Pallet API 调用，适配链端整合"
```

**影响的文件**:
- `src/services/freeQuotaService.ts` - 免费配额服务
- `src/utils/committeeEncryption.ts` - 委员会加密
- `src/features/otc/CreateMarketMakerPage.tsx` - 做市商申请

**修复内容**:
```typescript
// 修复前
api.query.marketMaker.freeOrderQuota(...)
api.query.otcOrder.orderOf(...)
api.query.simpleBridge.swapOf(...)

// 修复后
api.query.trading.freeOrderQuota(...)
api.query.trading.orderOf(...)
api.query.trading.swapOf(...)
```

### Step 2: 删除冗余模块（建议）

```bash
# 删除 deceasedMedia 模块
rm -rf src/features/deceasedMedia

# 验证无其他引用
grep -r "deceasedMedia" src/ --exclude-dir=node_modules

# 提交删除
git add src/features/
git commit -m "chore: 删除冗余的 deceasedMedia 模块"
```

### Step 3: 整理文档（可选）

```bash
# 创建归档目录
mkdir -p docs/archived

# 移动旧文档
mv *.md docs/archived/ 2>/dev/null || true
git mv README.md ./ 2>/dev/null || true  # 保留 README

# 提交整理
git add docs/
git commit -m "chore: 整理文档到 docs/archived/"
```

---

## ✅ 测试清单

完成清理后，必须测试以下功能：

### 1. 交易模块 (Trading)

```bash
# 打开浏览器测试
open http://localhost:5173

# 测试页面
#/otc/mm-apply         - 做市商申请
#/otc/order           - 创建 OTC 订单
#/otc/release         - 卖家释放
#/bridge/simple       - 桥接服务
#/first-purchase      - 首购功能
```

**测试步骤**:
1. ✅ 做市商申请表单能否正常加载
2. ✅ 提交资料时加密功能正常
3. ✅ 免费配额查询显示正确
4. ✅ OTC 订单创建和查询正常
5. ✅ 桥接功能正常运行

### 2. 纪念服务 (Memorial)

```bash
#/grave/detail?id=1   - 墓地详情
#/sacrifice/create    - 创建祭祀品（管理员）
```

**测试步骤**:
1. ✅ 供奉功能正常
2. ✅ 祭祀品目录加载
3. ✅ VIP 折扣计算正确

### 3. 逝者管理 (Deceased)

```bash
#/deceased/create     - 创建逝者
#/deceased/list       - 逝者列表
```

**测试步骤**:
1. ✅ 创建逝者功能正常
2. ✅ 媒体上传功能正常
3. ✅ 逝者列表显示正常

---

## 🐛 故障排除

### 问题 1: 编译错误

**错误信息**: `Property 'marketMaker' does not exist on type...`

**解决方案**:
```bash
# 清除缓存重新编译
rm -rf node_modules/.vite
npm run dev
```

### 问题 2: API 调用失败

**错误信息**: `Cannot read property 'freeOrderQuota' of undefined`

**解决方案**:
1. 确认链端已启动最新版本
2. 检查链端是否包含 `pallet-trading`
3. 重新连接节点

```bash
# 检查链端 Pallet
cd /home/xiaodong/文档/stardust
grep "type Trading" runtime/src/lib.rs
```

### 问题 3: 功能异常

**现象**: 做市商申请、OTC 订单功能不正常

**回滚方案**:
```bash
# 快速回滚到清理前
git reset --hard HEAD~1

# 或单独回滚某个文件
git checkout HEAD~1 -- src/services/freeQuotaService.ts
```

---

## 📊 清理效果

### 代码质量提升

| 指标 | 清理前 | 清理后 | 改善 |
|------|--------|--------|------|
| 旧 API 调用 | 3+ 处 | 0 处 | ✅ 100% |
| 冗余模块 | 1 个 (434 行) | 0 个 | ✅ -434 行 |
| 冗余文档 | ~50 个 | 0 个 | ✅ 整理 |
| API 兼容性 | ❌ 不兼容 | ✅ 完全兼容 | ✅ |

### 性能影响

- ⚡ **打包体积**: 减少 ~5KB（删除冗余模块）
- ⚡ **编译速度**: 提升 ~2%（减少文件数量）
- ⚡ **运行时**: 无影响（API 调用效率相同）

---

## 📖 详细文档

如需更详细的分析和说明，请查阅：

- [完整分析报告](./stardust-dapp-冗余代码分析报告.md) - 详细的问题分析和修复方案
- [Frontier 分析](./frontier-analysis.md) - Frontier 以太坊兼容层分析（可选功能）

---

## 🎯 下一步

清理完成后，建议：

1. **更新 CI/CD**  
   添加检查脚本，防止未来使用旧 API：
   ```yaml
   # .github/workflows/check-deprecated-api.yml
   - name: Check deprecated API
     run: |
       if grep -r "api\.query\.marketMaker" src/; then
         echo "发现使用已废弃的 API"
         exit 1
       fi
   ```

2. **更新团队文档**  
   在团队 Wiki 记录：
   - 新的 Pallet 名称映射
   - API 调用规范
   - 禁止使用的旧 API 列表

3. **代码审查规范**  
   在 PR 模板中添加检查项：
   ```markdown
   - [ ] 未使用已废弃的 Pallet API
   - [ ] API 调用使用新的整合后名称
   ```

---

## 💡 提示

- ✅ **推荐使用自动化脚本**：减少人工错误，节省时间
- ✅ **创建独立分支**：便于测试和回滚
- ✅ **充分测试**：至少测试 3 个关键功能
- ✅ **查看 git diff**：确认修改内容符合预期
- ⚠️ **不要跳过测试**：API 调用错误可能导致功能完全失效

---

## 📞 获取帮助

如遇到问题：

1. **查看日志**：浏览器控制台 + 终端日志
2. **检查链端**：确认链端版本和 Pallet 配置
3. **参考文档**：查阅完整分析报告
4. **寻求支持**：联系团队技术负责人

---

**祝清理顺利！** 🎉

