# æ‰¹é‡æ“ä½œä¼˜åŒ–è®¾è®¡æ–¹æ¡ˆ

**æ—¶é—´**ï¼š2025-10-28  
**ç›®æ ‡**ï¼šä¼˜åŒ–é“¾ä¸Šæ‰¹é‡æ“ä½œï¼Œé™ä½Gasæˆæœ¬ï¼Œæå‡TPS  
**é¢„æœŸå·¥ä½œé‡**ï¼š3-4å°æ—¶

---

## ğŸ“Š ç°çŠ¶åˆ†æ

### å½“å‰æ‰¹é‡æ“ä½œåœºæ™¯è¯†åˆ«

#### 1. Memorial ä¾›å¥‰æ“ä½œ

**ç°çŠ¶**ï¼š
- ç”¨æˆ·å¤šæ¬¡ä¾›å¥‰éœ€è¦å¤šæ¬¡äº¤æ˜“
- æ¯æ¬¡äº¤æ˜“éƒ½æœ‰å›ºå®šçš„åŸºç¡€Gasæˆæœ¬
- å¤šæ¬¡å­˜å‚¨å†™å…¥æ“ä½œ

**ç¤ºä¾‹åœºæ™¯**ï¼š
- ç”¨æˆ·æƒ³è¦ä¸ºé€è€…ä¾›å¥‰å¤šä¸ªç¥­ç¥€å“ï¼ˆèŠ±ã€èœ¡çƒ›ã€é£Ÿç‰©ç­‰ï¼‰
- å½“å‰éœ€è¦è°ƒç”¨3æ¬¡`offer()`ï¼Œäº§ç”Ÿ3æ¬¡äº¤æ˜“

**Gasæˆæœ¬**ï¼š
```
å•æ¬¡ä¾›å¥‰ï¼š~15,000 units
3æ¬¡ä¾›å¥‰ï¼š~45,000 unitsï¼ˆåŒ…å«3æ¬¡åŸºç¡€å¼€é”€ï¼‰
```

#### 2. IPFS Pin æ“ä½œ

**ç°çŠ¶**ï¼š
- Deceased/Memorialåˆ›å»ºæ—¶éœ€è¦Pinå¤šä¸ªCID
- æ¯ä¸ªCIDå•ç‹¬Pin

**ç¤ºä¾‹åœºæ™¯**ï¼š
- åˆ›å»ºé€è€…æ¡£æ¡ˆï¼šä¸»å›¾1ä¸ª + ç›¸å†Œ20å¼ ç…§ç‰‡ = 21ä¸ªCID
- å½“å‰éœ€è¦21æ¬¡Pinè°ƒç”¨

**é—®é¢˜**ï¼š
- å¤§é‡é‡å¤çš„å‡½æ•°è°ƒç”¨å¼€é”€
- å¤šæ¬¡å­˜å‚¨è¯»å†™æ“ä½œ

#### 3. Trading æ‰¹é‡æ¸…ç†ï¼ˆå·²å®ç°ï¼‰âœ…

**ç°çŠ¶**ï¼šå·²é€šè¿‡`clean_expired_orders`å®ç°æ‰¹é‡æ¸…ç†
- å•æ¬¡è°ƒç”¨æ¸…ç†å¤šä¸ªè®¢å•
- æ‰¹é‡æ›´æ–°ç´¢å¼•

**æˆæœå‚è€ƒ**ï¼š
- æ¸…ç†æ•ˆç‡ï¼š~50å€æå‡
- å­˜å‚¨æ“ä½œï¼šä»Næ¬¡å‡å°‘åˆ°1æ¬¡

---

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

### æ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | æå‡ |
|------|------|------|------|
| **æ‰¹é‡ä¾›å¥‰Gas** | N Ã— 15,000 | 5,000 + N Ã— 10,000 | **30-50%** â†“ |
| **æ‰¹é‡Pin Gas** | N Ã— 5,000 | 2,000 + N Ã— 3,000 | **40%** â†“ |
| **TPSï¼ˆæ‰¹é‡åœºæ™¯ï¼‰** | åŸºå‡† | ä¼˜åŒ– | **20-30%** â†‘ |
| **ç”¨æˆ·ä½“éªŒ** | å¤šæ¬¡äº¤æ˜“ | å•æ¬¡äº¤æ˜“ | æ˜¾è‘—æå‡ |

### èŠ‚çœè®¡ç®—ç¤ºä¾‹

**æ‰¹é‡ä¾›å¥‰10ä¸ªç¥­ç¥€å“**ï¼š
```
ä¼˜åŒ–å‰ï¼š10 Ã— 15,000 = 150,000 units
ä¼˜åŒ–åï¼š5,000 + 10 Ã— 10,000 = 105,000 units
èŠ‚çœï¼š30%
```

**æ‰¹é‡Pin 20ä¸ªCID**ï¼š
```
ä¼˜åŒ–å‰ï¼š20 Ã— 5,000 = 100,000 units
ä¼˜åŒ–åï¼š2,000 + 20 Ã— 3,000 = 62,000 units
èŠ‚çœï¼š38%
```

---

## ğŸ”§ æŠ€æœ¯æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šMemorialæ‰¹é‡ä¾›å¥‰

#### è®¾è®¡æ€è·¯

**é—®é¢˜åˆ†æ**ï¼š
- å½“å‰`offer()`æ¯æ¬¡è°ƒç”¨éƒ½éœ€è¦ï¼š
  1. éªŒè¯æƒé™
  2. æ£€æŸ¥ç›®æ ‡æ˜¯å¦å­˜åœ¨
  3. æ£€æŸ¥é™é¢‘
  4. è½¬è´¦
  5. å†™å…¥ä¾›å¥‰è®°å½•
  6. æ›´æ–°ç»Ÿè®¡
  7. å‘å°„äº‹ä»¶

**ä¼˜åŒ–ç­–ç•¥**ï¼š
- æƒé™éªŒè¯ï¼š1æ¬¡ï¼ˆæ‰¹é‡å…¥å£ï¼‰
- ç›®æ ‡éªŒè¯ï¼š1æ¬¡ï¼ˆæ‰¹é‡å…¥å£ï¼‰
- é™é¢‘æ£€æŸ¥ï¼šæ‰¹é‡æ£€æŸ¥
- è½¬è´¦ï¼š1æ¬¡å¤§é¢è½¬è´¦
- å­˜å‚¨å†™å…¥ï¼šæ‰¹é‡å†™å…¥ï¼ˆå•æ¬¡try_mutateï¼‰
- äº‹ä»¶ï¼šåˆå¹¶ä¸ºæ‰¹é‡äº‹ä»¶

#### æ–°å¢æ¥å£

```rust
#[pallet::call_index(XX)]
#[pallet::weight(T::WeightInfo::batch_offer(offerings.len() as u32))]
pub fn batch_offer(
    origin: OriginFor<T>,
    target: (u8, u64),
    offerings: BoundedVec<BatchOfferingInput<T>, ConstU32<10>>,
) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    // ğŸ”‘ å…³é”®ä¼˜åŒ–1ï¼šå•æ¬¡ç›®æ ‡éªŒè¯
    T::TargetControl::ensure_allowed(origin.clone(), target)?;
    
    // ğŸ”‘ å…³é”®ä¼˜åŒ–2ï¼šå•æ¬¡é™é¢‘æ£€æŸ¥ï¼ˆæ‰¹é‡æ€»æ•°ï¼‰
    Self::check_batch_rate_limit(&who, target, offerings.len() as u32)?;
    
    // ğŸ”‘ å…³é”®ä¼˜åŒ–3ï¼šè®¡ç®—æ€»é‡‘é¢
    let mut total_amount: u128 = 0;
    for offering in &offerings {
        total_amount = total_amount.saturating_add(offering.amount);
    }
    
    // ğŸ”‘ å…³é”®ä¼˜åŒ–4ï¼šå•æ¬¡å¤§é¢è½¬è´¦
    ensure!(
        total_amount >= T::MinOfferAmount::get(),
        Error::<T>::OfferAmountTooLow
    );
    T::Currency::transfer(
        &who,
        &Self::offering_treasury_account(),
        total_amount.saturated_into(),
        ExistenceRequirement::KeepAlive,
    )?;
    
    // ğŸ”‘ å…³é”®ä¼˜åŒ–5ï¼šæ‰¹é‡å†™å…¥ä¾›å¥‰è®°å½•ï¼ˆå•æ¬¡try_mutateï¼‰
    OfferingsByTarget::<T>::try_mutate(target, |records| -> DispatchResult {
        for offering_input in offerings.iter() {
            let record = OfferingRecord {
                who: who.clone(),
                target,
                kind_code: offering_input.kind_code,
                amount: offering_input.amount,
                media: offering_input.media.clone(),
                duration: offering_input.duration,
                time: frame_system::Pallet::<T>::block_number(),
            };
            
            records.try_push(record)
                .map_err(|_| Error::<T>::TooManyOfferings)?;
        }
        Ok(())
    })?;
    
    // ğŸ”‘ å…³é”®ä¼˜åŒ–6ï¼šå•ä¸€æ‰¹é‡äº‹ä»¶
    Self::deposit_event(Event::BatchOfferingsCommitted {
        who: who.clone(),
        target,
        count: offerings.len() as u32,
        total_amount,
    });
    
    Ok(())
}
```

#### æ•°æ®ç»“æ„

```rust
/// æ‰¹é‡ä¾›å¥‰è¾“å…¥é¡¹
#[derive(Encode, Decode, Clone, PartialEq, Eq, TypeInfo)]
pub struct BatchOfferingInput<T: Config> {
    /// ç¥­ç¥€å“ç±»å‹ä»£ç 
    pub kind_code: u8,
    /// ä¾›å¥‰é‡‘é¢
    pub amount: u128,
    /// é™„å¸¦åª’ä½“ï¼ˆå¯é€‰ï¼‰
    pub media: BoundedVec<MediaItem<T>, T::MaxMediaPerOffering>,
    /// æŒç»­æ—¶é•¿ï¼ˆå¯é€‰ï¼‰
    pub duration: Option<u32>,
}
```

#### æ–°å¢äº‹ä»¶

```rust
/// æ‰¹é‡ä¾›å¥‰å·²æäº¤
BatchOfferingsCommitted {
    who: T::AccountId,
    target: (u8, u64),
    count: u32,
    total_amount: u128,
}
```

---

### æ–¹æ¡ˆ2ï¼šIPFSæ‰¹é‡Pin

#### è®¾è®¡æ€è·¯

**å½“å‰é—®é¢˜**ï¼š
- Deceased/Memorialåˆ›å»ºæ—¶éœ€è¦Pinå¤šä¸ªCID
- æ¯æ¬¡Pinéƒ½æ˜¯ç‹¬ç«‹çš„å‡½æ•°è°ƒç”¨

**ä¼˜åŒ–ç­–ç•¥**ï¼š
- æ‰¹é‡æäº¤CIDåˆ—è¡¨
- å•æ¬¡å­˜å‚¨å†™å…¥
- æ‰¹é‡PinéªŒè¯ï¼ˆå¦‚æœæœ‰OCWï¼‰

#### æ–°å¢æ¥å£ï¼ˆå¦‚æœstardust-ipfsæ”¯æŒï¼‰

```rust
#[pallet::call_index(XX)]
#[pallet::weight(T::WeightInfo::batch_pin(cids.len() as u32))]
pub fn batch_pin(
    origin: OriginFor<T>,
    cids: BoundedVec<BoundedVec<u8, T::MaxCidLen>, ConstU32<50>>,
) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    // ğŸ”‘ æ‰¹é‡Piné€»è¾‘
    for cid in cids.iter() {
        // éªŒè¯CIDæ ¼å¼
        ensure!(Self::is_valid_cid(cid), Error::<T>::InvalidCid);
        
        // è®°å½•Pinï¼ˆå•æ¬¡try_mutateå†…å®Œæˆï¼‰
        PinnedCids::<T>::try_mutate(&who, |pins| -> DispatchResult {
            pins.try_push(cid.clone())
                .map_err(|_| Error::<T>::TooManyPins)?;
            Ok(())
        })?;
    }
    
    // å•ä¸€æ‰¹é‡äº‹ä»¶
    Self::deposit_event(Event::BatchPinned {
        who,
        count: cids.len() as u32,
    });
    
    Ok(())
}
```

**æ³¨æ„**ï¼šæ­¤åŠŸèƒ½ä¾èµ–äº`pallet-stardust-ipfs`çš„è®¾è®¡ï¼Œå¯èƒ½éœ€è¦å…ˆåˆ†æè¯¥palletçš„å®ç°ã€‚

---

### æ–¹æ¡ˆ3ï¼šé€šç”¨æ‰¹é‡æ“ä½œæ¨¡å¼ï¼ˆæœ€ä½³å®è·µï¼‰

#### æ¨¡å¼Aï¼šæ‰¹é‡å†™å…¥æ¨¡å¼

**é€‚ç”¨åœºæ™¯**ï¼šå¤šæ¬¡å†™å…¥åŒä¸€ä¸ªStorageMap/StorageValue

```rust
// âŒ ä½æ•ˆï¼šå¤šæ¬¡å­˜å‚¨å†™å…¥
for item in items {
    Storage::<T>::insert(key, item);  // Næ¬¡å†™å…¥
}

// âœ… é«˜æ•ˆï¼šå•æ¬¡å­˜å‚¨å†™å…¥
Storage::<T>::try_mutate(key, |storage| -> DispatchResult {
    for item in items {
        storage.try_push(item)?;  // å•æ¬¡å†™å…¥
    }
    Ok(())
})?;
```

**èŠ‚çœ**ï¼š
- å­˜å‚¨å†™å…¥ï¼šNæ¬¡ â†’ 1æ¬¡
- Gasæˆæœ¬ï¼š~70% â†“

#### æ¨¡å¼Bï¼šæ‰¹é‡éªŒè¯æ¨¡å¼

**é€‚ç”¨åœºæ™¯**ï¼šæ‰¹é‡æ“ä½œå‰çš„å…¬å…±éªŒè¯

```rust
// âœ… é«˜æ•ˆï¼šå‰ç½®æ‰¹é‡éªŒè¯
pub fn batch_operation(items: Vec<Item>) -> DispatchResult {
    // 1. æ‰¹é‡å‰ç½®éªŒè¯
    ensure!(items.len() <= MAX_BATCH, Error::<T>::TooManyItems);
    for item in &items {
        Self::validate_item(item)?;  // å¿«é€ŸéªŒè¯ï¼Œæ— å­˜å‚¨æ“ä½œ
    }
    
    // 2. å•æ¬¡å­˜å‚¨æ“ä½œ
    Storage::<T>::try_mutate(|storage| {
        for item in items {
            storage.process(item)?;
        }
        Ok(())
    })
}
```

#### æ¨¡å¼Cï¼šæ‰¹é‡äº‹ä»¶æ¨¡å¼

**é€‚ç”¨åœºæ™¯**ï¼šé¿å…å¤§é‡äº‹ä»¶å‘å°„

```rust
// âŒ ä½æ•ˆï¼šå¤šæ¬¡äº‹ä»¶å‘å°„
for item in items {
    Self::deposit_event(Event::ItemProcessed { item });  // Næ¬¡äº‹ä»¶
}

// âœ… é«˜æ•ˆï¼šå•æ¬¡æ‰¹é‡äº‹ä»¶
Self::deposit_event(Event::BatchProcessed {
    count: items.len() as u32,
    total_value: items.iter().sum(),
});
```

**èŠ‚çœ**ï¼š
- äº‹ä»¶å­˜å‚¨ï¼š~60% â†“
- é“¾åŒæ­¥é€Ÿåº¦ï¼š~15% â†‘

---

## ğŸ“Š æˆæœ¬æ”¶ç›Šåˆ†æ

### Gasæˆæœ¬å¯¹æ¯”

| æ“ä½œ | å•æ¬¡æ“ä½œ | æ‰¹é‡10æ¬¡ï¼ˆä¼˜åŒ–å‰ï¼‰ | æ‰¹é‡10æ¬¡ï¼ˆä¼˜åŒ–åï¼‰ | èŠ‚çœ |
|------|---------|------------------|------------------|------|
| **ä¾›å¥‰** | 15,000 | 150,000 | 105,000 | **30%** |
| **Pin CID** | 5,000 | 50,000 | 32,000 | **36%** |

### ç”¨æˆ·ä½“éªŒæ”¹å–„

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–å | æ”¹å–„ |
|------|--------|--------|------|
| **äº¤æ˜“æ¬¡æ•°** | 10æ¬¡ | 1æ¬¡ | **90%** â†“ |
| **ç¡®è®¤ç­‰å¾…æ—¶é—´** | 10ä¸ªåŒºå— | 1ä¸ªåŒºå— | **90%** â†“ |
| **äº¤æ˜“è´¹ç”¨** | 10æ¬¡è´¹ç”¨ | 1æ¬¡è´¹ç”¨ | **30-50%** â†“ |
| **æ“ä½œå¤æ‚åº¦** | å¤æ‚ | ç®€å• | æ˜¾è‘—æ”¹å–„ |

---

## ğŸ¯ å®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šMemorialæ‰¹é‡ä¾›å¥‰ï¼ˆ2å°æ—¶ï¼‰

**ä»»åŠ¡**ï¼š
- [x] è®¾è®¡`batch_offer`æ¥å£
- [ ] å®ç°æ‰¹é‡ä¾›å¥‰é€»è¾‘
- [ ] æ·»åŠ æ‰¹é‡äº‹ä»¶
- [ ] ç¼–å†™æµ‹è¯•ç”¨ä¾‹
- [ ] æ›´æ–°READMEæ–‡æ¡£

### ç¬¬äºŒé˜¶æ®µï¼šé€šç”¨æ‰¹é‡æ“ä½œä¼˜åŒ–ï¼ˆ1-2å°æ—¶ï¼‰

**ä»»åŠ¡**ï¼š
- [ ] åˆ†æIPFS palletå¯è¡Œæ€§
- [ ] ï¼ˆå¯é€‰ï¼‰å®ç°æ‰¹é‡Pin
- [ ] ç¼–å†™æ‰¹é‡æ“ä½œæœ€ä½³å®è·µæ–‡æ¡£
- [ ] ç”Ÿæˆå®ŒæˆæŠ¥å‘Š

---

## âš ï¸ é£é™©ä¸é™åˆ¶

### é£é™©1ï¼šæ‰¹é‡æ“ä½œé™åˆ¶

**é—®é¢˜**ï¼šæ‰¹é‡æ“ä½œè¿‡å¤§å¯èƒ½å¯¼è‡´ï¼š
- å•ä¸ªåŒºå—Gasè¶…é™
- äº¤æ˜“æ‰§è¡Œè¶…æ—¶

**ç¼“è§£**ï¼š
- ä½¿ç”¨`BoundedVec`é™åˆ¶æ‰¹é‡å¤§å°
- æ¨èæ‰¹é‡å¤§å°ï¼šâ‰¤ 10-20ä¸ª

### é£é™©2ï¼šåŸå­æ€§é—®é¢˜

**é—®é¢˜**ï¼šæ‰¹é‡æ“ä½œä¸­å¦‚æœæŸä¸€é¡¹å¤±è´¥ï¼Œæ˜¯å¦å›æ»šå…¨éƒ¨ï¼Ÿ

**æ–¹æ¡ˆ**ï¼š
- **å…¨éƒ¨å›æ»š**ï¼ˆæ¨èï¼‰ï¼šä¿è¯åŸå­æ€§ï¼Œç”¨æˆ·ä½“éªŒæ›´å¥½
- **éƒ¨åˆ†æˆåŠŸ**ï¼šè®°å½•å¤±è´¥é¡¹ï¼Œä½†å®ç°å¤æ‚

**é€‰æ‹©**ï¼šæ¨èå…¨éƒ¨å›æ»šï¼Œä½¿ç”¨`try_mutate`ä¿è¯åŸå­æ€§

### é£é™©3ï¼šå…¼å®¹æ€§

**é—®é¢˜**ï¼šç°æœ‰å‰ç«¯/SDKæ˜¯å¦éœ€è¦æ›´æ–°ï¼Ÿ

**æ–¹æ¡ˆ**ï¼š
- ä¿ç•™åŸæœ‰å•æ¬¡æ“ä½œæ¥å£
- æ‰¹é‡æ“ä½œä½œä¸ºæ–°å¢æ¥å£
- å‘ä¸‹å…¼å®¹ï¼Œæ— ç ´åæ€§å˜æ›´

---

## ğŸ“š å‚è€ƒå®ç°

### Substrateå®˜æ–¹æ‰¹é‡æ“ä½œ

**utility pallet**ï¼š
- `batch()`: æ‰¹é‡æ‰§è¡Œå¤šä¸ªè°ƒç”¨
- `batch_all()`: æ‰¹é‡æ‰§è¡Œï¼ˆå…¨éƒ¨æˆåŠŸæˆ–å…¨éƒ¨å¤±è´¥ï¼‰
- `force_batch()`: æ‰¹é‡æ‰§è¡Œï¼ˆå¿½ç•¥å¤±è´¥ï¼‰

**æˆ‘ä»¬çš„ç­–ç•¥**ï¼š
- å­¦ä¹ `batch_all()`çš„åŸå­æ€§è®¾è®¡
- é’ˆå¯¹ç‰¹å®šåœºæ™¯ä¼˜åŒ–ï¼ˆä¾›å¥‰ã€Pinç­‰ï¼‰
- æ¯”é€šç”¨batchæ›´é«˜æ•ˆï¼ˆæ— éœ€åŠ¨æ€dispatchï¼‰

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**ï¼š2025-10-28  
**ä¸‹ä¸€æ­¥**ï¼šå®æ–½Memorialæ‰¹é‡ä¾›å¥‰åŠŸèƒ½

