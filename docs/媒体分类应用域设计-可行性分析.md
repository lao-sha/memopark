# åª’ä½“åˆ†ç±»åº”ç”¨åŸŸè®¾è®¡ - å¯è¡Œæ€§ä¸åˆç†æ€§åˆ†æ

## ä¸€ã€éœ€æ±‚èƒŒæ™¯

### 1.1 æ ¸å¿ƒéœ€æ±‚

**ç›®æ ‡**: ä¸ºéŸ³é¢‘/è§†é¢‘åˆ†ç±»æ·»åŠ "å¯åº”ç”¨åŸŸ"æ¦‚å¿µï¼Œæ˜ç¡®æ¯ä¸ªåª’ä½“åˆ†ç±»é€‚ç”¨çš„çºªå¿µåœºæ™¯æˆ–åŠŸèƒ½ã€‚

**ä¸šåŠ¡ä»·å€¼**:
- ğŸ¯ **æ™ºèƒ½æ¨è**: æ ¹æ®å½“å‰åœºæ™¯è‡ªåŠ¨ç­›é€‰åˆé€‚çš„åª’ä½“
- ğŸš€ **å‡å°‘é…ç½®**: å‰ç«¯æ— éœ€ç¡¬ç¼–ç åˆ†ç±»-åœºæ™¯æ˜ å°„å…³ç³»
- âœ… **ç±»å‹å®‰å…¨**: é“¾ä¸ŠéªŒè¯åª’ä½“åˆ†ç±»ä¸åº”ç”¨åœºæ™¯çš„åŒ¹é…æ€§
- ğŸ“Š **æ•°æ®ç»Ÿè®¡**: æŒ‰åº”ç”¨åŸŸç»Ÿè®¡åª’ä½“ä½¿ç”¨æƒ…å†µ

### 1.2 ç°æœ‰é—®é¢˜

**å½“å‰è®¾è®¡**:
```rust
// åˆ†ç±»ä¸åº”ç”¨åœºæ™¯æ˜¯éšå¼çš„ï¼Œéœ€è¦å‰ç«¯ç¡¬ç¼–ç 
pub enum AudioCategory {
    Requiem = 0,      // â“ å“ªäº›åœºæ™¯å¯ä»¥ç”¨ï¼Ÿ
    Buddhist = 1,     // â“ é€‚ç”¨èŒƒå›´ï¼Ÿ
    // ...
}
```

**é—®é¢˜**:
1. âŒ åˆ†ç±»ä¸åœºæ™¯çš„å…³ç³»ä¸æ˜ç¡®
2. âŒ å‰ç«¯éœ€è¦ç»´æŠ¤æ˜ å°„è¡¨
3. âŒ æ— æ³•è¿›è¡Œé“¾ä¸ŠéªŒè¯
4. âŒ éš¾ä»¥è¿›è¡Œåœºæ™¯åŒ–æ¨è

---

## äºŒã€åº”ç”¨åŸŸå®šä¹‰

### 2.1 åº”ç”¨åŸŸæšä¸¾è®¾è®¡

```rust
/// åª’ä½“åº”ç”¨åŸŸï¼ˆçºªå¿µåœºæ™¯ï¼‰
#[derive(Encode, Decode, Clone, Copy, PartialEq, Eq, TypeInfo, MaxEncodedLen, RuntimeDebug)]
pub enum MediaDomain {
    /// é€è€…çºªå¿µé¦†ï¼ˆDeceased Memorialï¼‰
    DeceasedMemorial = 0,
    /// å¢“åœ°è¯¦æƒ…é¡µï¼ˆGrave Detailï¼‰
    GraveDetail = 1,
    /// é™µå›­ä¸»é¡µï¼ˆCemetery Parkï¼‰
    CemeteryPark = 2,
    /// çºªå¿µç©ºé—´ï¼ˆMemorial Spaceï¼‰
    MemorialSpace = 3,
    /// ä¾›å¥‰ä»ªå¼ï¼ˆOffering Ritualï¼‰
    OfferingRitual = 4,
    /// äº‹ä»¶é¦†ï¼ˆEvent Hallï¼‰
    EventHall = 5,
    /// å® ç‰©çºªå¿µï¼ˆPet Memorialï¼‰
    PetMemorial = 6,
    /// æ•™è‚²åœºæ™¯ï¼ˆEducationï¼‰
    Education = 7,
    /// ç›´æ’­è¿½æ‚¼ä¼šï¼ˆLive Memorialï¼‰
    LiveMemorial = 8,
    /// è™šæ‹Ÿç¥­ç¥€ï¼ˆVirtual Ritualï¼‰
    VirtualRitual = 9,
    /// é€šç”¨åœºæ™¯ï¼ˆUniversalï¼‰- é€‚ç”¨äºæ‰€æœ‰åœºæ™¯
    Universal = 255,
}

impl Default for MediaDomain {
    fn default() -> Self {
        Self::Universal
    }
}
```

---

### 2.2 éŸ³é¢‘åˆ†ç±»ä¸åº”ç”¨åŸŸæ˜ å°„

#### æ–¹æ¡ˆA: æ¯ä¸ªåˆ†ç±»ç»‘å®šå¤šä¸ªåº”ç”¨åŸŸï¼ˆæ¨èï¼‰

```rust
/// éŸ³é¢‘åˆ†ç±»ï¼ˆæ‰©å±•ç‰ˆ - å¸¦åº”ç”¨åŸŸï¼‰
#[derive(Encode, Decode, Clone, PartialEq, Eq, TypeInfo, MaxEncodedLen, RuntimeDebug)]
pub struct AudioCategoryConfig {
    /// åˆ†ç±»ç±»å‹
    pub category: AudioCategory,
    /// é€‚ç”¨çš„åº”ç”¨åŸŸåˆ—è¡¨ï¼ˆæœ€å¤šæ”¯æŒ10ä¸ªï¼‰
    pub applicable_domains: BoundedVec<MediaDomain, ConstU32<10>>,
    /// åˆ†ç±»åç§°
    pub name: BoundedVec<u8, ConstU32<64>>,
    /// åˆ†ç±»æè¿°
    pub description: BoundedVec<u8, ConstU32<256>>,
}

/// é¢„å®šä¹‰é…ç½®ç¤ºä¾‹
impl AudioCategoryConfig {
    /// å“€ä¹é…ç½®
    pub fn requiem() -> Self {
        Self {
            category: AudioCategory::Requiem,
            applicable_domains: vec![
                MediaDomain::DeceasedMemorial,
                MediaDomain::GraveDetail,
                MediaDomain::OfferingRitual,
                MediaDomain::EventHall,
            ].try_into().unwrap(),
            name: b"å“€ä¹".to_vec().try_into().unwrap(),
            description: b"é€‚ç”¨äºè¿½æ€ã€æ‚¼å¿µåœºæ™¯çš„è‚ƒç©†éŸ³ä¹".to_vec().try_into().unwrap(),
        }
    }

    /// ä½›ä¹é…ç½®
    pub fn buddhist() -> Self {
        Self {
            category: AudioCategory::Buddhist,
            applicable_domains: vec![
                MediaDomain::DeceasedMemorial,
                MediaDomain::OfferingRitual,
                MediaDomain::MemorialSpace,
            ].try_into().unwrap(),
            name: b"ä½›ä¹".to_vec().try_into().unwrap(),
            description: b"ä½›æ•™éŸ³ä¹ã€ç»æ–‡ï¼Œé€‚ç”¨äºä½›æ•™ä¿¡ä»°ç›¸å…³åœºæ™¯".to_vec().try_into().unwrap(),
        }
    }

    /// è½»éŸ³ä¹é…ç½®
    pub fn light() -> Self {
        Self {
            category: AudioCategory::Light,
            applicable_domains: vec![
                MediaDomain::CemeteryPark,
                MediaDomain::MemorialSpace,
                MediaDomain::Universal,
            ].try_into().unwrap(),
            name: b"è½»éŸ³ä¹".to_vec().try_into().unwrap(),
            description: b"æŠ’æƒ…ã€å¹³å’Œçš„éŸ³ä¹ï¼Œé€‚ç”¨äºå¤§å¤šæ•°åœºæ™¯".to_vec().try_into().unwrap(),
        }
    }

    /// ç¯å¢ƒéŸ³ä¹é…ç½®
    pub fn ambient() -> Self {
        Self {
            category: AudioCategory::Ambient,
            applicable_domains: vec![
                MediaDomain::CemeteryPark,
                MediaDomain::MemorialSpace,
                MediaDomain::VirtualRitual,
                MediaDomain::Universal,
            ].try_into().unwrap(),
            name: b"ç¯å¢ƒéŸ³ä¹".to_vec().try_into().unwrap(),
            description: b"è‡ªç„¶éŸ³ã€ç™½å™ªéŸ³ï¼Œè¥é€ å®é™æ°›å›´".to_vec().try_into().unwrap(),
        }
    }

    /// å†¥æƒ³éŸ³ä¹é…ç½®
    pub fn meditation() -> Self {
        Self {
            category: AudioCategory::Meditation,
            applicable_domains: vec![
                MediaDomain::MemorialSpace,
                MediaDomain::VirtualRitual,
            ].try_into().unwrap(),
            name: b"å†¥æƒ³éŸ³ä¹".to_vec().try_into().unwrap(),
            description: b"ç¦…ä¿®ã€é™å¿ƒéŸ³ä¹".to_vec().try_into().unwrap(),
        }
    }
}
```

---

### 2.3 è§†é¢‘åˆ†ç±»ä¸åº”ç”¨åŸŸæ˜ å°„

```rust
/// è§†é¢‘åˆ†ç±»é…ç½®
impl VideoCategoryConfig {
    /// ç”Ÿå¹³çºªå½•é…ç½®
    pub fn biography() -> Self {
        Self {
            category: VideoCategory::Biography,
            applicable_domains: vec![
                MediaDomain::DeceasedMemorial,
                MediaDomain::EventHall,
            ].try_into().unwrap(),
            name: b"ç”Ÿå¹³çºªå½•".to_vec().try_into().unwrap(),
            description: b"ä¸ªäººç”Ÿå¹³ã€å›å¿†å½•è§†é¢‘".to_vec().try_into().unwrap(),
        }
    }

    /// å†å²å½±åƒé…ç½®
    pub fn historical() -> Self {
        Self {
            category: VideoCategory::Historical,
            applicable_domains: vec![
                MediaDomain::EventHall,
                MediaDomain::Education,
            ].try_into().unwrap(),
            name: b"å†å²å½±åƒ".to_vec().try_into().unwrap(),
            description: b"å†å²äº‹ä»¶ã€æ¡£æ¡ˆè§†é¢‘".to_vec().try_into().unwrap(),
        }
    }

    /// æ•™è‚²è§†é¢‘é…ç½®
    pub fn educational() -> Self {
        Self {
            category: VideoCategory::Educational,
            applicable_domains: vec![
                MediaDomain::Education,
                MediaDomain::EventHall,
                MediaDomain::CemeteryPark,
            ].try_into().unwrap(),
            name: b"æ•™è‚²è§†é¢‘".to_vec().try_into().unwrap(),
            description: b"ç”Ÿå‘½æ•™è‚²ã€æ–‡åŒ–ä¼ æ‰¿è§†é¢‘".to_vec().try_into().unwrap(),
        }
    }

    /// ä»ªå¼å¼•å¯¼é…ç½®
    pub fn ritual() -> Self {
        Self {
            category: VideoCategory::Ritual,
            applicable_domains: vec![
                MediaDomain::OfferingRitual,
                MediaDomain::VirtualRitual,
                MediaDomain::LiveMemorial,
            ].try_into().unwrap(),
            name: b"ä»ªå¼å¼•å¯¼".to_vec().try_into().unwrap(),
            description: b"ç¥­ç¥€æµç¨‹ã€æ“ä½œæŒ‡å—è§†é¢‘".to_vec().try_into().unwrap(),
        }
    }

    /// å®£ä¼ ç‰‡é…ç½®
    pub fn promotional() -> Self {
        Self {
            category: VideoCategory::Promotional,
            applicable_domains: vec![
                MediaDomain::CemeteryPark,
            ].try_into().unwrap(),
            name: b"å®£ä¼ ç‰‡".to_vec().try_into().unwrap(),
            description: b"é™µå›­ä»‹ç»ã€æœåŠ¡å±•ç¤ºè§†é¢‘".to_vec().try_into().unwrap(),
        }
    }

    /// å…¨æ™¯è§†é¢‘é…ç½®
    pub fn panoramic() -> Self {
        Self {
            category: VideoCategory::Panoramic,
            applicable_domains: vec![
                MediaDomain::VirtualRitual,
                MediaDomain::CemeteryPark,
                MediaDomain::MemorialSpace,
            ].try_into().unwrap(),
            name: b"å…¨æ™¯è§†é¢‘".to_vec().try_into().unwrap(),
            description: b"360Â°ã€VR/ARè§†é¢‘".to_vec().try_into().unwrap(),
        }
    }
}
```

---

## ä¸‰ã€å­˜å‚¨è®¾è®¡

### 3.1 æ–°å¢å­˜å‚¨æ˜ å°„

```rust
/// åº”ç”¨åŸŸé…ç½®å­˜å‚¨ï¼ˆéŸ³é¢‘åˆ†ç±»ï¼‰
#[pallet::storage]
#[pallet::getter(fn audio_category_config)]
pub type AudioCategoryConfigs<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    AudioCategory,
    AudioCategoryConfig,
>;

/// åº”ç”¨åŸŸé…ç½®å­˜å‚¨ï¼ˆè§†é¢‘åˆ†ç±»ï¼‰
#[pallet::storage]
#[pallet::getter(fn video_category_config)]
pub type VideoCategoryConfigs<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    VideoCategory,
    VideoCategoryConfig,
>;

/// åº”ç”¨åŸŸåˆ°éŸ³é¢‘åˆ†ç±»çš„åå‘ç´¢å¼•
#[pallet::storage]
#[pallet::getter(fn audio_by_domain)]
pub type AudioCategoriesByDomain<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    MediaDomain,
    BoundedVec<AudioCategory, ConstU32<20>>,  // æ¯ä¸ªåŸŸæœ€å¤š20ç§éŸ³é¢‘åˆ†ç±»
    ValueQuery,
>;

/// åº”ç”¨åŸŸåˆ°è§†é¢‘åˆ†ç±»çš„åå‘ç´¢å¼•
#[pallet::storage]
#[pallet::getter(fn video_by_domain)]
pub type VideoCategoriesByDomain<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    MediaDomain,
    BoundedVec<VideoCategory, ConstU32<20>>,  // æ¯ä¸ªåŸŸæœ€å¤š20ç§è§†é¢‘åˆ†ç±»
    ValueQuery,
>;
```

---

### 3.2 Genesisé…ç½®ï¼ˆåˆå§‹åŒ–é¢„è®¾æ˜ å°„ï¼‰

```rust
#[pallet::genesis_config]
pub struct GenesisConfig<T: Config> {
    /// éŸ³é¢‘åˆ†ç±»é…ç½®
    pub audio_configs: Vec<(AudioCategory, Vec<MediaDomain>, Vec<u8>, Vec<u8>)>,
    /// è§†é¢‘åˆ†ç±»é…ç½®
    pub video_configs: Vec<(VideoCategory, Vec<MediaDomain>, Vec<u8>, Vec<u8>)>,
    #[serde(skip)]
    pub _phantom: PhantomData<T>,
}

impl<T: Config> Default for GenesisConfig<T> {
    fn default() -> Self {
        Self {
            audio_configs: vec![
                // (åˆ†ç±», åº”ç”¨åŸŸåˆ—è¡¨, åç§°, æè¿°)
                (
                    AudioCategory::Requiem,
                    vec![
                        MediaDomain::DeceasedMemorial,
                        MediaDomain::GraveDetail,
                        MediaDomain::OfferingRitual,
                        MediaDomain::EventHall,
                    ],
                    b"å“€ä¹".to_vec(),
                    b"é€‚ç”¨äºè¿½æ€ã€æ‚¼å¿µåœºæ™¯çš„è‚ƒç©†éŸ³ä¹".to_vec(),
                ),
                (
                    AudioCategory::Buddhist,
                    vec![
                        MediaDomain::DeceasedMemorial,
                        MediaDomain::OfferingRitual,
                        MediaDomain::MemorialSpace,
                    ],
                    b"ä½›ä¹".to_vec(),
                    b"ä½›æ•™éŸ³ä¹ã€ç»æ–‡".to_vec(),
                ),
                // ... å…¶ä»–éŸ³é¢‘åˆ†ç±»
            ],
            video_configs: vec![
                (
                    VideoCategory::Biography,
                    vec![
                        MediaDomain::DeceasedMemorial,
                        MediaDomain::EventHall,
                    ],
                    b"ç”Ÿå¹³çºªå½•".to_vec(),
                    b"ä¸ªäººç”Ÿå¹³ã€å›å¿†å½•è§†é¢‘".to_vec(),
                ),
                // ... å…¶ä»–è§†é¢‘åˆ†ç±»
            ],
            _phantom: Default::default(),
        }
    }
}

#[pallet::genesis_build]
impl<T: Config> BuildGenesisConfig for GenesisConfig<T> {
    fn build(&self) {
        // åˆå§‹åŒ–éŸ³é¢‘åˆ†ç±»é…ç½®
        for (category, domains, name, desc) in &self.audio_configs {
            let config = AudioCategoryConfig {
                category: *category,
                applicable_domains: domains.clone().try_into().unwrap(),
                name: name.clone().try_into().unwrap(),
                description: desc.clone().try_into().unwrap(),
            };
            AudioCategoryConfigs::<T>::insert(category, config);

            // å»ºç«‹åå‘ç´¢å¼•
            for domain in domains {
                AudioCategoriesByDomain::<T>::try_mutate(domain, |cats| {
                    cats.try_push(*category)
                }).ok();
            }
        }

        // åˆå§‹åŒ–è§†é¢‘åˆ†ç±»é…ç½®ï¼ˆç±»ä¼¼ï¼‰
        // ...
    }
}
```

---

## å››ã€æ ¸å¿ƒæ¥å£æ‰©å±•

### 4.1 åº”ç”¨åŸŸæŸ¥è¯¢æ¥å£

```rust
impl<T: Config> Pallet<T> {
    /// è·å–æŒ‡å®šåº”ç”¨åŸŸå¯ç”¨çš„éŸ³é¢‘åˆ†ç±»åˆ—è¡¨
    pub fn get_audio_categories_for_domain(domain: MediaDomain) -> Vec<AudioCategory> {
        AudioCategoriesByDomain::<T>::get(domain).into_inner()
    }

    /// è·å–æŒ‡å®šåº”ç”¨åŸŸå¯ç”¨çš„è§†é¢‘åˆ†ç±»åˆ—è¡¨
    pub fn get_video_categories_for_domain(domain: MediaDomain) -> Vec<VideoCategory> {
        VideoCategoriesByDomain::<T>::get(domain).into_inner()
    }

    /// æ£€æŸ¥éŸ³é¢‘åˆ†ç±»æ˜¯å¦é€‚ç”¨äºæŒ‡å®šåº”ç”¨åŸŸ
    pub fn is_audio_category_applicable(
        category: AudioCategory,
        domain: MediaDomain,
    ) -> bool {
        if let Some(config) = AudioCategoryConfigs::<T>::get(category) {
            config.applicable_domains.contains(&domain) ||
            config.applicable_domains.contains(&MediaDomain::Universal)
        } else {
            false
        }
    }

    /// æ£€æŸ¥è§†é¢‘åˆ†ç±»æ˜¯å¦é€‚ç”¨äºæŒ‡å®šåº”ç”¨åŸŸ
    pub fn is_video_category_applicable(
        category: VideoCategory,
        domain: MediaDomain,
    ) -> bool {
        if let Some(config) = VideoCategoryConfigs::<T>::get(category) {
            config.applicable_domains.contains(&domain) ||
            config.applicable_domains.contains(&MediaDomain::Universal)
        } else {
            false
        }
    }

    /// è·å–æŒ‡å®šåº”ç”¨åŸŸçš„éšæœºéŸ³é¢‘ï¼ˆæ™ºèƒ½æ¨èï¼‰
    pub fn get_random_audio_for_domain(domain: MediaDomain) -> Option<u32> {
        // 1. è·å–è¯¥åŸŸå¯ç”¨çš„éŸ³é¢‘åˆ†ç±»
        let categories = Self::get_audio_categories_for_domain(domain);
        if categories.is_empty() {
            return None;
        }

        // 2. éšæœºé€‰æ‹©ä¸€ä¸ªåˆ†ç±»
        let block_hash = <frame_system::Pallet<T>>::block_hash(
            <frame_system::Pallet<T>>::block_number()
        );
        let seed = block_hash.as_ref()[0] as usize;
        let category_index = seed % categories.len();
        let selected_category = categories[category_index];

        // 3. ä»è¯¥åˆ†ç±»ä¸­éšæœºé€‰æ‹©ä¸€ä¸ªåª’ä½“
        Self::get_random_media(MediaCategory::Audio(selected_category))
    }

    /// è·å–æŒ‡å®šåº”ç”¨åŸŸçš„éšæœºè§†é¢‘ï¼ˆæ™ºèƒ½æ¨èï¼‰
    pub fn get_random_video_for_domain(domain: MediaDomain) -> Option<u32> {
        let categories = Self::get_video_categories_for_domain(domain);
        if categories.is_empty() {
            return None;
        }

        let block_hash = <frame_system::Pallet<T>>::block_hash(
            <frame_system::Pallet<T>>::block_number()
        );
        let seed = block_hash.as_ref()[0] as usize;
        let category_index = seed % categories.len();
        let selected_category = categories[category_index];

        Self::get_random_media(MediaCategory::Video(selected_category))
    }
}
```

---

### 4.2 æ·»åŠ åª’ä½“æ—¶çš„éªŒè¯

```rust
#[pallet::call]
impl<T: Config> Pallet<T> {
    /// æ·»åŠ åª’ä½“ï¼ˆæ‰©å±•ç‰ˆ - å¸¦åº”ç”¨åŸŸéªŒè¯ï¼‰
    #[pallet::weight(T::WeightInfo::add_media())]
    pub fn add_media_with_domain(
        origin: OriginFor<T>,
        media_type: MediaType,
        name: Vec<u8>,
        media_cid: Vec<u8>,
        cover_cid: Option<Vec<u8>>,
        duration: u32,
        category: MediaCategory,
        target_domain: Option<MediaDomain>,  // æ–°å¢ï¼šç›®æ ‡åº”ç”¨åŸŸ
        quality: Option<VideoQuality>,
        subtitle_cid: Option<Vec<u8>>,
    ) -> DispatchResult {
        T::AdminOrigin::ensure_origin(origin.clone())?;
        let creator = ensure_signed(origin)?;

        // ... åŸºç¡€éªŒè¯ ...

        // æ–°å¢ï¼šåº”ç”¨åŸŸéªŒè¯
        if let Some(domain) = target_domain {
            let is_applicable = match &category {
                MediaCategory::Audio(audio_cat) => {
                    Self::is_audio_category_applicable(*audio_cat, domain)
                },
                MediaCategory::Video(video_cat) => {
                    Self::is_video_category_applicable(*video_cat, domain)
                },
            };

            ensure!(is_applicable, Error::<T>::CategoryNotApplicableForDomain);
        }

        // ... å…¶ä½™é€»è¾‘ ...

        Ok(())
    }
}
```

---

## äº”ã€ä½¿ç”¨ç¤ºä¾‹

### 5.1 Pallet Deceased é›†æˆï¼ˆæ™ºèƒ½æ¨èï¼‰

```rust
// pallets/deceased/src/lib.rs

impl<T: Config> Pallet<T> {
    /// è·å–é€è€…çºªå¿µé¦†èƒŒæ™¯éŸ³ä¹ï¼ˆæ™ºèƒ½æ¨èï¼‰
    pub fn get_memorial_audio(deceased_id: u64) -> Option<u32> {
        // 1. æ£€æŸ¥æ˜¯å¦æœ‰è‡ªå®šä¹‰èƒŒæ™¯éŸ³ä¹
        if let Some(deceased) = DeceasedOf::<T>::get(deceased_id) {
            if deceased.background_music_id.is_some() {
                return deceased.background_music_id;
            }
        }

        // 2. æ ¹æ®åº”ç”¨åŸŸæ™ºèƒ½æ¨èï¼ˆè‡ªåŠ¨è¿‡æ»¤é€‚ç”¨åˆ†ç±»ï¼‰
        T::PublicMedia::get_random_audio_for_domain(MediaDomain::DeceasedMemorial)
    }

    /// è·å–é€è€…çºªå¿µé¦†ç”Ÿå¹³è§†é¢‘ï¼ˆæ™ºèƒ½æ¨èï¼‰
    pub fn get_memorial_video(deceased_id: u64) -> Option<u32> {
        if let Some(deceased) = DeceasedOf::<T>::get(deceased_id) {
            if deceased.biography_video_id.is_some() {
                return deceased.biography_video_id;
            }
        }

        // æ™ºèƒ½æ¨èç”Ÿå¹³çºªå½•æˆ–æ•™è‚²è§†é¢‘
        T::PublicMedia::get_random_video_for_domain(MediaDomain::DeceasedMemorial)
    }
}
```

---

### 5.2 å‰ç«¯é›†æˆç¤ºä¾‹

```typescript
// src/services/mediaService.ts

/**
 * è·å–æŒ‡å®šåº”ç”¨åŸŸå¯ç”¨çš„éŸ³é¢‘åˆ†ç±»
 */
async getAudioCategoriesForDomain(domain: MediaDomain): Promise<AudioCategory[]> {
  const categories = await this.api.query.publicMedia.audioCategoriesByDomain(domain);
  return categories.toJSON() as AudioCategory[];
}

/**
 * è·å–æŒ‡å®šåº”ç”¨åŸŸçš„éšæœºèƒŒæ™¯éŸ³ä¹
 */
async getRandomAudioForDomain(domain: MediaDomain): Promise<number | null> {
  const mediaId = await this.api.query.publicMedia.getRandomAudioForDomain(domain);
  return mediaId.isSome ? mediaId.unwrap().toNumber() : null;
}

/**
 * ä½¿ç”¨ç¤ºä¾‹ - çºªå¿µé¦†é¡µé¢
 */
const MemorialPage: React.FC = () => {
  useEffect(() => {
    const loadMedia = async () => {
      // è‡ªåŠ¨è·å–é€‚åˆçºªå¿µé¦†åœºæ™¯çš„éŸ³é¢‘
      const audioId = await mediaService.getRandomAudioForDomain(
        MediaDomain.DeceasedMemorial
      );

      // è‡ªåŠ¨è·å–é€‚åˆçºªå¿µé¦†åœºæ™¯çš„è§†é¢‘
      const videoId = await mediaService.getRandomVideoForDomain(
        MediaDomain.DeceasedMemorial
      );

      // æ— éœ€ç¡¬ç¼–ç åˆ†ç±»æ˜ å°„ï¼
      setBackgroundAudio(audioId);
      setBiographyVideo(videoId);
    };

    loadMedia();
  }, []);

  // ...
};
```

---

## å…­ã€å¯è¡Œæ€§è¯„ä¼°

### 6.1 æŠ€æœ¯å¯è¡Œæ€§ â­â­â­â­â­

| ç»´åº¦ | è¯„åˆ† | è¯´æ˜ |
|------|------|------|
| **å®ç°éš¾åº¦** | â­â­ | æ ‡å‡†å­˜å‚¨æ˜ å°„+ç´¢å¼•ï¼Œå®ç°ç®€å• |
| **å­˜å‚¨æˆæœ¬** | â­â­ | é¢å¤–å­˜å‚¨çº¦500å­—èŠ‚/åˆ†ç±»ï¼Œæˆæœ¬æä½ |
| **æŸ¥è¯¢æ€§èƒ½** | â­â­â­â­â­ | O(1)æŸ¥è¯¢ï¼Œåå‘ç´¢å¼•é«˜æ•ˆ |
| **å…¼å®¹æ€§** | â­â­â­â­â­ | å‘åå…¼å®¹ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½ |
| **æ‰©å±•æ€§** | â­â­â­â­â­ | æ”¯æŒåŠ¨æ€æ›´æ–°é…ç½® |

**ç»“è®º**: âœ… æŠ€æœ¯å¯è¡Œæ€§æé«˜

---

### 6.2 åˆç†æ€§è¯„ä¼°

#### æ¶æ„åˆç†æ€§ â­â­â­â­â­

**ä¼˜ç‚¹**:
1. âœ… **èŒè´£æ¸…æ™°**: é“¾ä¸Šæ˜ç¡®å®šä¹‰åº”ç”¨åŸŸå…³ç³»
2. âœ… **ç±»å‹å®‰å…¨**: ç¼–è¯‘æ—¶å’Œè¿è¡Œæ—¶åŒé‡éªŒè¯
3. âœ… **æ™ºèƒ½æ¨è**: æ ¹æ®åœºæ™¯è‡ªåŠ¨è¿‡æ»¤åˆé€‚åª’ä½“
4. âœ… **å‡å°‘ç»´æŠ¤**: å‰ç«¯æ— éœ€ç¡¬ç¼–ç æ˜ å°„è¡¨
5. âœ… **çµæ´»é…ç½®**: æ”¯æŒæ²»ç†å§”å‘˜ä¼šåŠ¨æ€è°ƒæ•´

**æ½œåœ¨é—®é¢˜**:
- âš ï¸ éœ€è¦é¢„å…ˆå®šä¹‰åº”ç”¨åŸŸï¼ˆå¯é€šè¿‡æ²»ç†æ‰©å±•ï¼‰
- âš ï¸ åˆå§‹é…ç½®éœ€è¦ä»”ç»†è®¾è®¡

#### ä¸šåŠ¡åˆç†æ€§ â­â­â­â­â­

**ä¼˜ç‚¹**:
1. âœ… **åœºæ™¯åŒ–æ¨è**: ä¸åŒåœºæ™¯æ’­æ”¾åˆé€‚åª’ä½“
2. âœ… **ç”¨æˆ·ä½“éªŒ**: è‡ªåŠ¨é€‚é…ï¼Œæ— éœ€ç”¨æˆ·é€‰æ‹©
3. âœ… **å¯ç»´æŠ¤æ€§**: ç»Ÿä¸€ç®¡ç†åª’ä½“-åœºæ™¯å…³ç³»
4. âœ… **å¯æ‰©å±•æ€§**: æ”¯æŒæœªæ¥æ–°å¢åº”ç”¨åŸŸ

---

## ä¸ƒã€æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆA: é“¾ä¸Šå­˜å‚¨åº”ç”¨åŸŸé…ç½®ï¼ˆæ¨èï¼‰

**ä¼˜ç‚¹**:
- âœ… å®Œå…¨å»ä¸­å¿ƒåŒ–
- âœ… é“¾ä¸Šå¯éªŒè¯
- âœ… æ”¯æŒæ²»ç†æ›´æ–°
- âœ… ç±»å‹å®‰å…¨

**ç¼ºç‚¹**:
- âš ï¸ å­˜å‚¨æˆæœ¬ï¼ˆçº¦0.5KB/åˆ†ç±»ï¼Œæ€»è®¡~10KBï¼‰
- âš ï¸ éœ€è¦Genesisé…ç½®

---

### æ–¹æ¡ˆB: å‰ç«¯ç¡¬ç¼–ç æ˜ å°„

**ä¼˜ç‚¹**:
- âœ… æ— é“¾ä¸Šå­˜å‚¨æˆæœ¬
- âœ… å®ç°å¿«é€Ÿ

**ç¼ºç‚¹**:
- âŒ ä¸­å¿ƒåŒ–ç®¡ç†
- âŒ æ— æ³•é“¾ä¸ŠéªŒè¯
- âŒ å‰ç«¯ç»´æŠ¤è´Ÿæ‹…
- âŒ ä¸åŒå®¢æˆ·ç«¯å¯èƒ½ä¸ä¸€è‡´

---

### æ–¹æ¡ˆC: æ··åˆæ–¹æ¡ˆ

**è®¾è®¡**: é“¾ä¸Šå­˜å‚¨æ ¸å¿ƒæ˜ å°„ï¼Œå‰ç«¯æ‰©å±•å±•ç¤ºé€»è¾‘

**ä¼˜ç‚¹**:
- âœ… å¹³è¡¡å­˜å‚¨æˆæœ¬å’Œçµæ´»æ€§
- âœ… æ ¸å¿ƒéªŒè¯åœ¨é“¾ä¸Š

**ç¼ºç‚¹**:
- âš ï¸ å¤æ‚åº¦ä¸­ç­‰

---

**æ¨è**: â­â­â­â­â­ æ–¹æ¡ˆAï¼ˆé“¾ä¸Šå­˜å‚¨å®Œæ•´é…ç½®ï¼‰

---

## å…«ã€å®æ–½è®¡åˆ’

### Phase 1: æ ¸å¿ƒåŠŸèƒ½ï¼ˆ2å¤©ï¼‰

**Day 1**:
- âœ… å®šä¹‰ `MediaDomain` æšä¸¾ï¼ˆ10ä¸ªåº”ç”¨åŸŸï¼‰
- âœ… è®¾è®¡ `AudioCategoryConfig` å’Œ `VideoCategoryConfig` ç»“æ„
- âœ… å®ç°å­˜å‚¨æ˜ å°„å’Œåå‘ç´¢å¼•
- âœ… ç¼–å†™Genesisé…ç½®

**Day 2**:
- âœ… å®ç°åº”ç”¨åŸŸæŸ¥è¯¢æ¥å£
- âœ… å®ç°æ™ºèƒ½æ¨èå‡½æ•°
- âœ… æ·»åŠ éªŒè¯é€»è¾‘
- âœ… ç¼–å†™å•å…ƒæµ‹è¯•

---

### Phase 2: æ²»ç†åŠŸèƒ½ï¼ˆ1å¤©ï¼Œå¯é€‰ï¼‰

- æ·»åŠ  `update_category_domains()` æ¥å£ï¼ˆæ²»ç†å§”å‘˜ä¼šå¯æ›´æ–°ï¼‰
- æ·»åŠ  `add_media_domain()` æ¥å£ï¼ˆæ–°å¢åº”ç”¨åŸŸï¼‰
- äº‹ä»¶é€šçŸ¥

---

## ä¹ã€ä½¿ç”¨åœºæ™¯ç¤ºä¾‹

### åœºæ™¯1: é€è€…çºªå¿µé¦†

```rust
// è‡ªåŠ¨æ¨èï¼šå“€ä¹ã€ä½›ä¹ã€è½»éŸ³ä¹
let audio = PublicMedia::get_random_audio_for_domain(MediaDomain::DeceasedMemorial);

// è‡ªåŠ¨æ¨èï¼šç”Ÿå¹³çºªå½•è§†é¢‘
let video = PublicMedia::get_random_video_for_domain(MediaDomain::DeceasedMemorial);
```

### åœºæ™¯2: é™µå›­ä¸»é¡µ

```rust
// è‡ªåŠ¨æ¨èï¼šè½»éŸ³ä¹ã€ç¯å¢ƒéŸ³ä¹
let audio = PublicMedia::get_random_audio_for_domain(MediaDomain::CemeteryPark);

// è‡ªåŠ¨æ¨èï¼šå®£ä¼ ç‰‡ã€æ•™è‚²è§†é¢‘
let video = PublicMedia::get_random_video_for_domain(MediaDomain::CemeteryPark);
```

### åœºæ™¯3: è™šæ‹Ÿç¥­ç¥€

```rust
// è‡ªåŠ¨æ¨èï¼šå†¥æƒ³éŸ³ä¹ã€ç¯å¢ƒéŸ³ä¹
let audio = PublicMedia::get_random_audio_for_domain(MediaDomain::VirtualRitual);

// è‡ªåŠ¨æ¨èï¼šä»ªå¼å¼•å¯¼è§†é¢‘ã€å…¨æ™¯è§†é¢‘
let video = PublicMedia::get_random_video_for_domain(MediaDomain::VirtualRitual);
```

---

## åã€é£é™©ä¸åº”å¯¹

### 10.1 æŠ€æœ¯é£é™©

| é£é™© | ç­‰çº§ | åº”å¯¹æªæ–½ |
|------|------|---------|
| **å­˜å‚¨è†¨èƒ€** | ğŸŸ¢ ä½ | æ¯åˆ†ç±»ä»…500å­—èŠ‚ï¼Œæ€»è®¡~10KB |
| **é…ç½®é”™è¯¯** | ğŸŸ¡ ä¸­ | Genesisé…ç½®ä¸¥æ ¼æµ‹è¯•ï¼Œæ”¯æŒæ²»ç†æ›´æ–° |
| **æ€§èƒ½å½±å“** | ğŸŸ¢ ä½ | O(1)æŸ¥è¯¢ï¼Œæ— æ€§èƒ½é—®é¢˜ |

### 10.2 ä¸šåŠ¡é£é™©

| é£é™© | ç­‰çº§ | åº”å¯¹æªæ–½ |
|------|------|---------|
| **åº”ç”¨åŸŸå®šä¹‰ä¸å…¨** | ğŸŸ¡ ä¸­ | é¢„ç•™æ‰©å±•æ¥å£ï¼Œæ”¯æŒæ²»ç†æ–°å¢ |
| **æ˜ å°„å…³ç³»äº‰è®®** | ğŸŸ¡ ä¸­ | æ²»ç†å§”å‘˜ä¼šæŠ•ç¥¨å†³å®š |
| **ç”¨æˆ·å›°æƒ‘** | ğŸŸ¢ ä½ | è‡ªåŠ¨æ¨èï¼Œç”¨æˆ·æ— æ„ŸçŸ¥ |

---

## åä¸€ã€æ€»ç»“ä¸å»ºè®®

### 11.1 æ ¸å¿ƒç»“è®º

âœ… **å¼ºçƒˆæ¨èå®æ–½åº”ç”¨åŸŸè®¾è®¡ï¼ˆæ–¹æ¡ˆA - é“¾ä¸Šå­˜å‚¨ï¼‰**

**ç†ç”±**:
1. **æ™ºèƒ½åŒ–**: æ ¹æ®åœºæ™¯è‡ªåŠ¨æ¨èåˆé€‚åª’ä½“
2. **å»ä¸­å¿ƒåŒ–**: å®Œå…¨é“¾ä¸Šç®¡ç†ï¼Œå¯éªŒè¯
3. **æ˜“ç»´æŠ¤**: å‰ç«¯æ— éœ€ç¡¬ç¼–ç æ˜ å°„å…³ç³»
4. **æˆæœ¬ä½**: å­˜å‚¨æˆæœ¬æä½ï¼ˆ~10KBï¼‰
5. **æ‰©å±•æ€§å¼º**: æ”¯æŒæ²»ç†åŠ¨æ€è°ƒæ•´

### 11.2 å…³é”®ä¼˜åŠ¿

| ç»´åº¦ | æ— åº”ç”¨åŸŸè®¾è®¡ | æœ‰åº”ç”¨åŸŸè®¾è®¡ |
|------|-------------|-------------|
| **æ¨èå‡†ç¡®æ€§** | âŒ éšæœº | âœ… åœºæ™¯åŒ–æ™ºèƒ½æ¨è |
| **å‰ç«¯ç»´æŠ¤** | âŒ ç¡¬ç¼–ç æ˜ å°„è¡¨ | âœ… è‡ªåŠ¨è·å– |
| **ç±»å‹å®‰å…¨** | âŒ æ— éªŒè¯ | âœ… é“¾ä¸ŠéªŒè¯ |
| **ç”¨æˆ·ä½“éªŒ** | â­â­ | â­â­â­â­â­ |

### 11.3 å®æ–½å»ºè®®

**ç«‹å³è¡ŒåŠ¨**:
1. âœ… å®šä¹‰10ä¸ªæ ¸å¿ƒåº”ç”¨åŸŸ
2. âœ… è®¾è®¡8ä¸ªéŸ³é¢‘åˆ†ç±» + 8ä¸ªè§†é¢‘åˆ†ç±»çš„åº”ç”¨åŸŸæ˜ å°„
3. âœ… å®ç°é“¾ä¸Šå­˜å‚¨å’ŒæŸ¥è¯¢æ¥å£ï¼ˆ2å¤©ï¼‰
4. âœ… å‰ç«¯é›†æˆæµ‹è¯•

**åç»­ä¼˜åŒ–**:
5. æ·»åŠ æ²»ç†æ›´æ–°æ¥å£ï¼ˆPhase 2ï¼‰
6. ç»Ÿè®¡åˆ†æå„åº”ç”¨åŸŸåª’ä½“ä½¿ç”¨æƒ…å†µ
7. åŸºäºä½¿ç”¨æ•°æ®ä¼˜åŒ–æ¨èç®—æ³•

---

### 11.4 æˆåŠŸæ¡ˆä¾‹å‚è€ƒ

ç±»ä¼¼è®¾è®¡æ¨¡å¼ï¼š
- **Spotify**: åœºæ™¯åŒ–æ­Œå•ï¼ˆè¿åŠ¨ã€å­¦ä¹ ã€ç¡çœ ï¼‰
- **YouTube**: å†…å®¹åˆ†ç±»æ ‡ç­¾ç³»ç»Ÿ
- **Netflix**: å†…å®¹åˆ†çº§å’Œåœºæ™¯æ¨è

---

**åˆ†æå®Œæˆæ—¶é—´**: 2025-11-23
**åˆ†æäºº**: Claude Code
**æ¨èæ–¹æ¡ˆ**: â­â­â­â­â­ æ–¹æ¡ˆA - é“¾ä¸Šå­˜å‚¨åº”ç”¨åŸŸé…ç½®
**ä¼˜å…ˆçº§**: é«˜ï¼ˆå¼ºçƒˆå»ºè®®å®æ–½ï¼‰
**å¼€å‘å‘¨æœŸ**: 2å¤©
