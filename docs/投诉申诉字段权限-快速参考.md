# 投诉/申诉字段权限-快速参考

> **版本**: v1.0 | **日期**: 2025-10-27  
> **用途**: 快速查询自研pallet中投诉/申诉字段的修改权限

---

## 📌 核心结论

### ✅ 任意用户可以修改的字段内容

| Pallet | 操作 | 可修改字段 | 限制条件 |
|--------|------|-----------|---------|
| **stardust-appeals** | 提交申诉 | `domain`, `target`, `action`, `reason_cid`, `evidence_cid`, `new_owner` | 需押金、限频、证据必填 |
| **stardust-appeals** | 撤回申诉 | 将`status`改为3 | 仅本人、status=0时、罚没10% |
| **deceased-text** | 投诉生平 | 触发创建`ComplaintCase` | 需押金、不能重复投诉 |
| **deceased-text** | 投诉悼词 | 触发创建`ComplaintCase` | 需押金、不能重复投诉 |
| **deceased-media** | 投诉相册 | 触发创建`ComplaintCase` | 需押金、不能重复投诉 |
| **deceased-media** | 投诉媒体 | 触发创建`ComplaintCase` | 需押金、不能重复投诉 |
| **stardust-grave** | 投诉墓地 | 添加`Complaint`记录（`who`, `cid`） | 最多`MaxComplaintsPerGrave`条 |
| **escrow** | 进入争议 | ❌ 无（需授权调用） | 仅AuthorizedOrigin |
| **arbitration** | 发起争议 | `domain`, `id`, `evidence_id` | 需Router校验（买家/卖家/做市商） |

### ❌ 普通用户不可以修改的字段内容

| 字段类别 | 字段名 | 修改权限 | 涉及Pallet |
|---------|--------|---------|-----------|
| **状态字段** | `status` | 治理委员会/Root | stardust-appeals, deceased-text, deceased-media |
| **押金字段** | `deposit`, `deposit_id` | 系统自动 | 所有 |
| **时间字段** | `execute_at`, `approved_at`, `created`, `time` | 系统自动 | 所有 |
| **托管状态** | `LockStateOf` | AuthorizedOrigin/Root | escrow |
| **裁决结果** | 资金分配、内容回滚 | 治理委员会 | deceased-text, deceased-media |
| **争议裁决** | `arbitrate()`, `Decision` | DecisionOrigin（治理委员会/Root） | arbitration |
| **裁决应用** | `Router::apply_decision()` | 系统自动（通过Router） | arbitration |

---

## 🔐 关键安全机制

### 1. 状态保护
```
用户提交 → status=0 (Submitted)
         ↓
治理批准 → status=1 (Approved) ✅ 仅治理
         ↓
系统执行 → status=4 (Executed)  ✅ 自动
```

### 2. 押金保护
- **提交时**：系统自动冻结押金（用户不可指定金额）
- **撤回时**：罚没10%押金到国库（stardust-appeals）
- **驳回时**：罚没30%押金到国库（stardust-appeals）
- **裁决时**：20%奖励赢家、5%仲裁费、75%退回输家

### 3. 资金安全
- 托管资金由专用PalletId账户管理
- 争议状态下禁止普通释放/退款
- 仲裁决议仅授权方可调用

---

## 📊 对比表：6个自研Pallet

| 功能 | stardust-appeals | deceased-text | deceased-media | stardust-grave | escrow | arbitration |
|-----|-------------|--------------|---------------|-----------|--------|------------|
| 用户可提交 | ✅ | ✅ | ✅ | ✅ | ❌ | ✅（需Router校验） |
| 用户可撤回 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 用户可修改状态 | ❌ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 治理可裁决 | ✅ | ✅ | ✅ | ✅ | ✅ | ✅ |
| 自动执行 | ✅ | ❌ | ❌ | ❌ | ✅ | ❌ |
| 公示期 | ✅ 30天 | ❌ | ❌ | ❌ | ❌ | ❌ |
| 重试机制 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 应答否决 | ✅ | ❌ | ❌ | ❌ | ❌ | ❌ |
| 域路由解耦 | ❌ | ❌ | ❌ | ❌ | ❌ | ✅ |
| 证据统一管理 | ❌ | ❌ | ❌ | ❌ | ❌ | ✅（pallet-evidence） |

---

## 🎯 典型场景示例

### 场景1：用户投诉不当内容（deceased-media）

```
1. 用户发现不当相册 → complain_album(album_id)
   ✅ 可以操作：提交投诉、提供证据CID
   ❌ 不能操作：修改押金金额、修改状态

2. 系统冻结押金 → 自动扣除ComplaintDeposit
   ❌ 用户不能修改押金金额

3. 治理委员会审查 → gov_resolve_album_complaint(album_id, uphold, evidence_cid)
   ❌ 用户不能修改裁决结果
   ❌ 用户不能修改分账比例

4. 系统执行分账 → 20%/5%/75% 自动分配
   ❌ 用户不能干预资金流向
```

### 场景2：用户提交治理申诉（stardust-appeals）

```
1. 用户提交申诉 → submit_appeal(domain, target, action, reason_cid, evidence_cid)
   ✅ 可以操作：指定申诉域、目标、操作类型、提供证据
   ❌ 不能操作：修改押金、修改执行时间

2. 用户反悔撤回 → withdraw_appeal(id)
   ✅ 可以操作：撤回申诉（仅status=0时）
   ❌ 不能操作：避免罚没（固定10%）

3. 治理批准申诉 → approve_appeal(id, notice_blocks)
   ❌ 用户不能修改批准决定
   ❌ 用户不能修改公示期长度

4. 公示期到期 → 系统自动执行 (on_initialize)
   ❌ 用户不能提前执行
   ❌ 用户不能取消执行

5. 对象所有者应答 → 自动否决申诉 (status → 6)
   ❌ 用户不能阻止应答否决机制
```

### 场景3：OTC订单争议（arbitration）

```
1. 用户（买家/卖家）发起争议 → dispute_with_evidence_id(domain, id, evidence_id)
   ✅ 可以操作：提交争议、提供证据ID
   ❌ 不能操作：重复发起、绕过Router校验

2. 系统登记争议 → Disputed[(domain, id)] = ()
   ❌ 用户不能修改争议状态

3. 委员会审查证据 → 查看evidence_id指向的证据（pallet-evidence）
   ❌ 用户不能修改证据内容（已提交）

4. 委员会裁决 → arbitrate(domain, id, decision_code, bps)
   ❌ 用户不能调用裁决接口
   ❌ 用户不能修改裁决决定
   - decision_code=0: Release（全额放款）
   - decision_code=1: Refund（全额退款）
   - decision_code=2: Partial（按bps比例）

5. Router路由分发 → apply_decision(domain, id, decision)
   ❌ 用户不能干预路由逻辑

6. 业务pallet执行 → OTC/Bridge应用裁决
   ❌ 用户不能修改执行逻辑
   - 释放/退款资金（通过escrow）
   - 更新订单状态
   - 扣除信用分（buyer-credit/maker-credit）
```

### 场景4：托管到期处理（escrow）

```
1. OTC订单异常 → 通过OTC pallet触发dispute()
   ❌ 用户不能直接调用dispute()
   ❌ 需通过OTC等授权pallet间接触发

2. 托管进入争议状态 → LockStateOf = 1 (Disputed)
   ❌ 用户不能修改状态
   ❌ 普通release/refund被禁用

3. 仲裁员裁决 → apply_decision_*(id, to, bps)
   ❌ 用户不能调用仲裁决议接口
   ❌ 用户不能指定分账比例

4. 资金按裁决转出 → 从托管账户转账
   ❌ 用户不能直接提取托管资金
```

---

## 💡 重要提示

### 用户侧限制
1. ❌ **不能修改状态**：所有状态变更由治理或系统控制
2. ❌ **不能修改押金**：押金金额由配置或策略决定
3. ❌ **不能修改时间**：执行时间、批准时间由系统记录
4. ❌ **不能修改裁决**：裁决结果、资金分配由治理决定

### 用户侧权利
1. ✅ **可以提交**：提供证据和理由提交投诉/申诉
2. ✅ **可以撤回**：stardust-appeals支持撤回（有罚没）
3. ✅ **可以应答**：通过保持活跃触发应答否决（stardust-appeals）
4. ✅ **可以质询**：通过社区渠道质疑治理决策

### 治理侧职责
1. ✅ 审查证据的真实性和完整性
2. ✅ 做出公正的裁决决定
3. ✅ 设置合理的公示期和执行时间
4. ✅ 监督系统自动执行的正确性

---

## 📚 详细文档

完整分析报告请参考：[自研pallet投诉申诉字段权限分析报告.md](./自研pallet投诉申诉字段权限分析报告.md)

---

**更新日期**: 2025-10-27  
**维护**: 项目架构组

