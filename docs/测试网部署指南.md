# 测试网部署指南

## 🌐 Arbitrum Sepolia 测试网部署

### 准备工作

1. **获取测试网 ETH**
   - Arbitrum Sepolia Faucet: https://faucet.quicknode.com/arbitrum/sepolia
   - 或通过 Sepolia ETH 桥接到 Arbitrum

2. **获取测试网 USDC**
   - 部署 Mock USDC 或使用现有测试代币

3. **配置环境变量**

```bash
cd contracts/arbitrum
cp .env.example .env
```

编辑 `.env`:
```
PRIVATE_KEY=your_private_key_here
ARBITRUM_SEPOLIA_RPC=https://sepolia-rollup.arbitrum.io/rpc
ETHERSCAN_API_KEY=your_etherscan_api_key
```

### 部署步骤

#### 1. 编译合约

```bash
npx hardhat compile
```

#### 2. 部署到 Arbitrum Sepolia

```bash
npx hardhat run scripts/deploy.ts --network arbitrum-sepolia
```

**预期输出**:
```
Deploying contracts to Arbitrum Sepolia...
DUSTToken deployed to: 0x1234...
DUSTBridge deployed to: 0x5678...
StardustTradingVault deployed to: 0x9abc...
StardustVaultRouter deployed to: 0xdef0...
Deployment complete!
```

#### 3. 验证合约

```bash
npx hardhat verify --network arbitrum-sepolia 0x1234... # DUSTToken
npx hardhat verify --network arbitrum-sepolia 0x5678... 0x1234... # DUSTBridge
npx hardhat verify --network arbitrum-sepolia 0x9abc... 0xUSDC... # Vault
npx hardhat verify --network arbitrum-sepolia 0xdef0... 0x1234... 0xUSDC... 0x9abc... 0xUNISWAP... # Router
```

### 配置 Substrate 侧

#### 1. 更新 Runtime 配置

修改 `runtime/src/configs/mod.rs`:

```rust
// 设置 Arbitrum 桥接合约地址
impl pallet_dust_bridge::Config for Runtime {
    // ... 其他配置
}
```

#### 2. 启动测试网节点

```bash
cd /home/xiaodong/文档/stardust
./target/release/stardust-node --dev --tmp
```

#### 3. 配置桥接地址

通过治理提案或 sudo 设置:

```javascript
// 使用 Polkadot.js Apps
api.tx.sudo.sudo(
  api.tx.dustBridge.setArbitrumBridgeAddress("0x5678...")
).signAndSend(sudoAccount);
```

### 测试流程

#### 测试 1: Substrate → Arbitrum

1. 在 Stardust 链上调用 `dustBridge.bridgeToArbitrum(amount, ethAddress)`
2. 等待 OCW 处理（约 1-2 分钟）
3. 在 Arbitrum Sepolia 查看 ERC20 DUST 余额

#### 测试 2: Arbitrum → Substrate

1. 在 Arbitrum Sepolia 调用 `DUSTBridge.burnToSubstrate(amount, substrateAddress)`
2. 等待 OCW 处理
3. 在 Stardust 链查看 DUST 余额

#### 测试 3: AI 交易参与

1. 批准 Router 使用 DUST
2. 调用 `StardustVaultRouter.depositWithDUST(amount, minUsdcOut)`
3. 检查收到的 stUSDC

#### 测试 4: 提取

1. 批准 Router 使用 stUSDC
2. 调用 `StardustVaultRouter.withdrawToDUST(amount, minDustOut)`
3. 检查收到的 DUST

### 监控和调试

#### 查看事件日志

```javascript
// 监听桥接事件
dustBridge.on("BridgeMinted", (bridgeId, to, amount) => {
  console.log(`Minted: ${amount} DUST to ${to}`);
});

dustBridge.on("BridgeBurned", (from, amount, substrateAddr) => {
  console.log(`Burned: ${amount} DUST from ${from}`);
});
```

#### OCW 日志

```bash
# 查看节点日志
tail -f node.log | grep "DUST Bridge OCW"
```

### 常见问题

**Q: OCW 没有处理桥接请求？**
- 检查 OCW 是否正确配置 Arbitrum RPC
- 检查 relayer 账户是否有足够的 ETH
- 查看节点日志排查错误

**Q: 交易失败？**
- 检查 gas 限制是否足够
- 确认授权是否正确
- 检查合约是否暂停

**Q: Uniswap 兑换失败？**
- 确认流动性池已创建
- 检查滑点设置是否合理
- 验证授权金额

### 部署清单

- [ ] Arbitrum Sepolia 合约部署完成
- [ ] 合约在 Arbiscan 上验证
- [ ] Substrate 测试网节点运行
- [ ] 桥接地址配置完成
- [ ] OCW 配置正确
- [ ] 测试 1: Substrate → Arbitrum ✓
- [ ] 测试 2: Arbitrum → Substrate ✓
- [ ] 测试 3: AI 交易参与 ✓
- [ ] 测试 4: 提取流程 ✓
- [ ] 监控和日志系统工作正常

## 下一步

完成测试网部署和测试后:
1. 修复发现的问题
2. 进行压力测试
3. 准备主网部署

