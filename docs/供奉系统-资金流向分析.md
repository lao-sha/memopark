# ä¾›å¥‰ç³»ç»Ÿï¼ˆpallet-memo-offeringsï¼‰èµ„é‡‘æµå‘åˆ†æ

**æ—¥æœŸ**: 2025-10-22  
**åˆ†æäºº**: AIåŠ©æ‰‹  
**Pallet**: `pallet-memo-offerings`  
**æºæ–‡ä»¶**: `pallets/memo-offerings/src/lib.rs`

---

## ä¸€ã€æ¦‚è¿°

ä¾›å¥‰ç³»ç»Ÿæ˜¯Stardusté¡¹ç›®çš„æ ¸å¿ƒåŠŸèƒ½ä¹‹ä¸€ï¼Œç”¨æˆ·å¯ä»¥ä¸ºå¢“åœ°ã€å® ç‰©ç­‰ç›®æ ‡è´­ä¹°ä¾›å¥‰å“ï¼ˆå¦‚é²œèŠ±ã€èœ¡çƒ›ã€å® ç‰©é“å…·ç­‰ï¼‰ã€‚æœ¬æ–‡æ¡£è¯¦ç»†åˆ†æè´­ä¹°ä¾›å¥‰æ—¶çš„èµ„é‡‘æµå‘ã€‚

---

## äºŒã€ä¸¤ç§è´­ä¹°æ–¹å¼

### 2.1 æ–¹å¼ä¸€ï¼š`offer()` - åŸºäºä¾›å¥‰å“æ¨¡æ¿

**æ¥å£**: `offer(origin, target, kind_code, amount, media, duration)`

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ä¾›å¥‰å“æ¨¡æ¿ï¼ˆOfferingSpecï¼‰
- æ”¯æŒ**å¤šè·¯åˆ†è´¦**ï¼ˆé€šè¿‡DonationRouterï¼‰
- èµ„é‡‘æµå‘å¯é…ç½®ï¼ˆè·¯ç”±è¡¨ï¼‰

**å…³é”®ä»£ç **ï¼šç¬¬641-811è¡Œ

### 2.2 æ–¹å¼äºŒï¼š`offer_by_sacrifice()` - åŸºäºç¥­ç¥€å“ç›®å½•

**æ¥å£**: `offer_by_sacrifice(origin, target, sacrifice_id, media, duration_weeks, is_vip)`

**ç‰¹ç‚¹**ï¼š
- ä½¿ç”¨ç¥­ç¥€å“ç›®å½•ï¼ˆSacrificeCatalogï¼‰
- **ç›´æ¥è½¬è´¦**åˆ°ç›®æ ‡æ”¶æ¬¾è´¦æˆ·
- èµ„é‡‘æµå‘ç®€å•ï¼ˆä¸ä½¿ç”¨è·¯ç”±è¡¨ï¼‰

**å…³é”®ä»£ç **ï¼šç¬¬1122-1256è¡Œ

---

## ä¸‰ã€æ–¹å¼ä¸€ï¼š`offer()` èµ„é‡‘æµå‘è¯¦è§£

### 3.1 ä»·æ ¼è®¡ç®—

#### æ­¥éª¤1ï¼šè®¡ç®—åŸä»·ï¼ˆç¬¬685-695è¡Œï¼‰

```rust
// æ ¹æ®ä¾›å¥‰ç±»å‹è®¡ç®—åŸä»·
let original_price = match &spec.kind {
    // Instantç±»å‹ï¼šå›ºå®šä»·æ ¼
    OfferingKind::Instant => {
        FixedPriceOf::<T>::get(kind_code).ok_or(Error::<T>::AmountRequired)?
    }
    // Timedç±»å‹ï¼šå•ä»· Ã— æ—¶é•¿ï¼ˆå‘¨ï¼‰
    OfferingKind::Timed { .. } => {
        let u = UnitPricePerWeekOf::<T>::get(kind_code).ok_or(Error::<T>::AmountRequired)?;
        let d = duration.ok_or(Error::<T>::DurationRequired)? as u128;
        u.saturating_mul(d)
    }
};
```

**ç¤ºä¾‹**ï¼š
- Instantä¾›å¥‰ï¼ˆé²œèŠ±ï¼‰ï¼š`100 DUST`ï¼ˆå›ºå®šä»·æ ¼ï¼‰
- Timedä¾›å¥‰ï¼ˆå® ç‰©é£Ÿç‰©ï¼‰ï¼š`10 DUST/å‘¨ Ã— 4å‘¨ = 40 DUST`

#### æ­¥éª¤2ï¼šåº”ç”¨ä¼šå‘˜æŠ˜æ‰£ï¼ˆç¬¬697-703è¡Œï¼‰

```rust
// å¹´è´¹ä¼šå‘˜äº«å—3æŠ˜ä¼˜æƒ 
let final_price = if T::MembershipProvider::is_valid_member(&who) {
    let discount_percent = T::MembershipProvider::get_discount() as u128; // 30 (3æŠ˜)
    original_price.saturating_mul(discount_percent) / 100
} else {
    original_price
};
```

**ç¤ºä¾‹**ï¼š
- åŸä»·ï¼š`100 DUST`
- ä¼šå‘˜æŠ˜æ‰£ï¼š`30%`ï¼ˆ3æŠ˜ï¼‰
- æœ€ç»ˆä»·æ ¼ï¼š`100 Ã— 30% = 30 DUST` âœ…

### 3.2 å¤šè·¯åˆ†è´¦ï¼ˆæ ¸å¿ƒï¼‰

#### æ­¥éª¤3ï¼šè·å–è·¯ç”±è¡¨ï¼ˆç¬¬719è¡Œï¼‰

```rust
let shares = T::DonationRouter::route(target, amt);
```

**è·¯ç”±è¡¨æŸ¥è¯¢ä¼˜å…ˆçº§**ï¼š
1. æŒ‰åŸŸè·¯ç”±è¡¨ï¼ˆ`RouteTableByDomain`ï¼‰- ä¼˜å…ˆçº§é«˜
2. å…¨å±€è·¯ç”±è¡¨ï¼ˆ`RouteTableGlobal`ï¼‰- å›é€€

**è·¯ç”±è¡¨ç»“æ„**ï¼ˆç¬¬347-351è¡Œï¼‰ï¼š
```rust
pub struct RouteEntry<T: Config> {
    pub kind: u8,        // è·¯ç”±ç±»å‹ï¼š0-3
    pub account: Option<T::AccountId>, // æ”¶æ¬¾è´¦æˆ·ï¼ˆkind=1æ—¶å¿…å¡«ï¼‰
    pub share: Permill,  // åˆ†é…æ¯”ä¾‹ï¼ˆ0-100%ï¼‰
}
```

#### è·¯ç”±ç±»å‹è¯´æ˜ï¼ˆç¬¬335-345è¡Œï¼‰

| kind | åç§° | è¯´æ˜ | æ”¶æ¬¾è´¦æˆ· |
|------|------|------|----------|
| 0 | SubjectFunding | ä¸»é¢˜èµ„é‡‘è´¦æˆ· | è‡ªåŠ¨æ´¾ç”Ÿï¼ˆå¢“åœ°/å® ç‰©ç®¡ç†è€…ï¼‰ |
| 1 | SpecificAccount | æŒ‡å®šå›ºå®šè´¦æˆ· | å¿…é¡»æŒ‡å®šï¼ˆè”ç›Ÿè®¡é…¬/å¹³å°è´¹ç­‰ï¼‰ |
| 2 | Burn | é”€æ¯ | `BurnAccount`ï¼ˆé»‘æ´è´¦æˆ·ï¼‰ |
| 3 | Treasury | å›½åº“ | `TreasuryAccount`ï¼ˆè´¢æ”¿è´¦æˆ·ï¼‰ |

#### æ­¥éª¤4ï¼šæŒ‰è·¯ç”±è¡¨é€ä¸ªè½¬è´¦ï¼ˆç¬¬729-749è¡Œï¼‰

```rust
// è£å‰ªè·¯ç”±æ¡æ•°ï¼ˆæœ€å¤š5ä¸ªï¼‰
let max_splits = MaxRouteSplits::<T>::get().max(0);
let shares_trimmed = if shares.len() as u32 > max_splits {
    shares.into_iter().take(max_splits as usize).collect()
} else {
    shares
};

// æŒ‰è·¯ç”±è¡¨é€ä¸ªè½¬è´¦
for (acc, pm) in shares_trimmed.into_iter() {
    let part_u128: u128 = pm * amt; // è®¡ç®—åˆ†é…é‡‘é¢
    if part_u128 == 0 {
        continue;
    }
    let transfer_u128 = core::cmp::min(part_u128, remainder_u128);
    if transfer_u128 == 0 {
        break;
    }
    let bal: BalanceOf<T> = transfer_u128.saturated_into();
    
    // æ‰§è¡Œè½¬è´¦
    T::Currency::transfer(&who, &acc, bal, ExistenceRequirement::KeepAlive)?;
    
    routed.push((acc, transfer_u128));
    remainder_u128 = remainder_u128.saturating_sub(transfer_u128);
    if remainder_u128 == 0 {
        break;
    }
}
```

#### æ­¥éª¤5ï¼šå¤„ç†å‰©ä½™é‡‘é¢ï¼ˆç¬¬751-758è¡Œï¼‰

```rust
// æ ¹æ®é…ç½®å†³å®šæ˜¯å¦å›é€€åˆ°é»˜è®¤è´¦æˆ·
if remainder_u128 > 0 && RouteRemainderToDefault::<T>::get() {
    let dest = T::DonationResolver::account_for(target);
    let bal: BalanceOf<T> = remainder_u128.saturated_into();
    T::Currency::transfer(&who, &dest, bal, ExistenceRequirement::KeepAlive)?;
    routed.push((dest, remainder_u128));
    remainder_u128 = 0;
}
```

---

## å››ã€å…¸å‹çš„èµ„é‡‘åˆ†é…æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šå…¨å±€è·¯ç”±è¡¨ï¼ˆæ¨èï¼‰

**åœºæ™¯**ï¼šæ ‡å‡†çš„ä¾›å¥‰åˆ†è´¦æ¨¡å¼

**é…ç½®**ï¼ˆé€šè¿‡`set_route_table_global`ï¼‰ï¼š

```rust
[
    // 20% â†’ ä¸»é¢˜èµ„é‡‘è´¦æˆ·ï¼ˆå¢“åœ°ç®¡ç†è€…/å® ç‰©ä¸»äººï¼‰
    (kind: 0, account: None, share: 200000),  // 20% = 200000/1000000
    
    // 40% â†’ è”ç›Ÿè®¡é…¬æ‰˜ç®¡è´¦æˆ·ï¼ˆæ¨èå¥–åŠ±æ± ï¼‰
    (kind: 1, account: Some(AffiliateEscrowAccount), share: 400000),  // 40%
    
    // 2% â†’ å­˜å‚¨è´¹ç”¨è´¦æˆ·
    (kind: 1, account: Some(StorageAccount), share: 20000),  // 2%
    
    // 8% â†’ å›½åº“è´¦æˆ·ï¼ˆå¹³å°è´¢æ”¿ï¼‰
    (kind: 3, account: None, share: 80000),  // 8%
    
    // 30% â†’ é”€æ¯ï¼ˆé€šç¼©æœºåˆ¶ï¼‰
    (kind: 2, account: None, share: 300000),  // 30%
]
```

**æ€»è®¡**ï¼š100% = 20% + 40% + 2% + 8% + 30%

### èµ„é‡‘æµå‘ç¤ºæ„å›¾ï¼ˆæ–¹æ¡ˆAï¼‰

```
ç”¨æˆ·è´­ä¹°ä¾›å¥‰
    â†“
æ”¯ä»˜ 100 DUST
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         å¤šè·¯åˆ†è´¦ï¼ˆDonationRouterï¼‰          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â”œâ”€ 20 DUST (20%) â†’ å¢“åœ°ç®¡ç†è€…è´¦æˆ·
    â”‚                   ï¼ˆSubjectFundingï¼‰
    â”‚
    â”œâ”€ 40 DUST (40%) â†’ è”ç›Ÿè®¡é…¬æ‰˜ç®¡è´¦æˆ·
    â”‚                   ï¼ˆAffiliateEscrowAccountï¼‰
    â”‚                   â””â†’ å†ç”±affiliate-instantåˆ†é…
    â”‚
    â”œâ”€ 2 DUST (2%)   â†’ å­˜å‚¨è´¹ç”¨è´¦æˆ·
    â”‚                   ï¼ˆStorageAccountï¼‰
    â”‚
    â”œâ”€ 8 DUST (8%)   â†’ å›½åº“è´¦æˆ·
    â”‚                   ï¼ˆTreasuryAccountï¼‰
    â”‚
    â””â”€ 30 DUST (30%) â†’ é»‘æ´è´¦æˆ·ï¼ˆé”€æ¯ï¼‰
                        ï¼ˆBurnAccountï¼‰
```

### æ–¹æ¡ˆBï¼šæŒ‰åŸŸè·¯ç”±è¡¨

**åœºæ™¯**ï¼šä¸åŒåŸŸï¼ˆå¢“åœ°ã€å® ç‰©ç­‰ï¼‰é‡‡ç”¨ä¸åŒçš„åˆ†è´¦æ¯”ä¾‹

**ç¤ºä¾‹**ï¼šå¢“åœ°åŸŸï¼ˆdomain=1ï¼‰

```rust
// domain=1 çš„è·¯ç”±è¡¨
[
    // å¢“åœ°ç®¡ç†è€…ï¼š30%ï¼ˆæ›´é«˜æ¯”ä¾‹æ¿€åŠ±å¢“åœ°è¿è¥ï¼‰
    (kind: 0, account: None, share: 300000),
    
    // è”ç›Ÿè®¡é…¬ï¼š30%
    (kind: 1, account: Some(AffiliateEscrowAccount), share: 300000),
    
    // å­˜å‚¨è´¹ç”¨ï¼š2%
    (kind: 1, account: Some(StorageAccount), share: 20000),
    
    // å›½åº“ï¼š8%
    (kind: 3, account: None, share: 80000),
    
    // é”€æ¯ï¼š30%
    (kind: 2, account: None, share: 300000),
]
```

**ç¤ºä¾‹**ï¼šå® ç‰©åŸŸï¼ˆdomain=3ï¼‰

```rust
// domain=3 çš„è·¯ç”±è¡¨
[
    // å® ç‰©ä¸»äººï¼š10%ï¼ˆå® ç‰©ä¸»äººåˆ†æˆè¾ƒä½ï¼‰
    (kind: 0, account: None, share: 100000),
    
    // è”ç›Ÿè®¡é…¬ï¼š50%ï¼ˆå® ç‰©åœºæ™¯æ¨å¹¿åŠ›åº¦æ›´å¤§ï¼‰
    (kind: 1, account: Some(AffiliateEscrowAccount), share: 500000),
    
    // å­˜å‚¨è´¹ç”¨ï¼š2%
    (kind: 1, account: Some(StorageAccount), share: 20000),
    
    // å›½åº“ï¼š8%
    (kind: 3, account: None, share: 80000),
    
    // é”€æ¯ï¼š30%
    (kind: 2, account: None, share: 300000),
]
```

---

## äº”ã€æ–¹å¼äºŒï¼š`offer_by_sacrifice()` èµ„é‡‘æµå‘

### 5.1 ä»·æ ¼è®¡ç®—

#### æ­¥éª¤1ï¼šè®¡ç®—åŸä»·ï¼ˆç¬¬1176-1183è¡Œï¼‰

```rust
// ä»ç¥­ç¥€å“ç›®å½•è¯»å–ä»·æ ¼
let original_price: u128 = if let Some(p) = fixed {
    p  // å›ºå®šä»·æ ¼
} else {
    let u = unit.ok_or(Error::<T>::AmountRequired)?;
    let d = duration_weeks.ok_or(Error::<T>::DurationRequired)? as u128;
    u.saturating_mul(d)  // å•ä»· Ã— æ—¶é•¿
};
```

#### æ­¥éª¤2ï¼šåº”ç”¨ä¼šå‘˜æŠ˜æ‰£ï¼ˆç¬¬1185-1191è¡Œï¼‰

```rust
// å¹´è´¹ä¼šå‘˜äº«å—3æŠ˜ä¼˜æƒ ï¼ˆä¸æ–¹å¼ä¸€ç›¸åŒï¼‰
let final_price = if T::MembershipProvider::is_valid_member(&who) {
    let discount_percent = T::MembershipProvider::get_discount() as u128; // 30 (3æŠ˜)
    original_price.saturating_mul(discount_percent) / 100
} else {
    original_price
};
```

### 5.2 ç›´æ¥è½¬è´¦ï¼ˆç®€å•ï¼‰

#### æ­¥éª¤3ï¼šè½¬è´¦åˆ°ç›®æ ‡è´¦æˆ·ï¼ˆç¬¬1199-1202è¡Œï¼‰

```rust
let dest = T::DonationResolver::account_for(target);
if final_price > 0 {
    let amt_balance: BalanceOf<T> = final_price.saturated_into();
    T::Currency::transfer(&who, &dest, amt_balance, ExistenceRequirement::KeepAlive)?;
}
```

**ç‰¹ç‚¹**ï¼š
- âŒ **ä¸ä½¿ç”¨è·¯ç”±è¡¨**
- âœ… **èµ„é‡‘ç›´æ¥è½¬å…¥ç›®æ ‡è´¦æˆ·**ï¼ˆç”±DonationResolverè§£æï¼‰
- âœ… **æµç¨‹ç®€å•ï¼ŒGasè´¹ç”¨ä½**

### èµ„é‡‘æµå‘ç¤ºæ„å›¾ï¼ˆæ–¹å¼äºŒï¼‰

```
ç”¨æˆ·è´­ä¹°ç¥­ç¥€å“
    â†“
æ”¯ä»˜ 100 DUST
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         DonationResolverè§£æç›®æ ‡è´¦æˆ·        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
100 DUST (100%) â†’ ç›®æ ‡è´¦æˆ·ï¼ˆå¢“åœ°/å® ç‰©ç®¡ç†è€…ï¼‰
                  âŒ æ— åˆ†è´¦
                  âŒ æ— é”€æ¯
                  âŒ æ— æ¨èå¥–åŠ±
```

---

## å…­ã€å…³é”®è´¦æˆ·è¯´æ˜

### 6.1 é…ç½®è´¦æˆ·ï¼ˆRuntimeæ³¨å…¥ï¼‰

| è´¦æˆ·åç§° | Configå®šä¹‰ | ç”¨é€” |
|---------|-----------|------|
| **AffiliateEscrowAccount** | ç¬¬188è¡Œ | è”ç›Ÿè®¡é…¬æ‰˜ç®¡è´¦æˆ·ï¼ˆæ¥æ”¶æ¨èå¥–åŠ±æ± ï¼‰ |
| **StorageAccount** | ç¬¬193è¡Œ | å­˜å‚¨è´¹ç”¨è´¦æˆ·ï¼ˆæ¥æ”¶é“¾ä¸Šå­˜å‚¨è´¹ç”¨ï¼‰ |
| **BurnAccount** | ç¬¬196è¡Œ | é»‘æ´è´¦æˆ·ï¼ˆé”€æ¯MEMOï¼Œé€šç¼©æœºåˆ¶ï¼‰ |
| **TreasuryAccount** | ç¬¬199è¡Œ | å›½åº“è´¦æˆ·ï¼ˆå¹³å°è´¢æ”¿æ”¶å…¥ï¼‰ |

### 6.2 åŠ¨æ€è´¦æˆ·ï¼ˆè¿è¡Œæ—¶è§£æï¼‰

| è´¦æˆ·ç±»å‹ | è§£æå™¨ | ç”¨é€” |
|---------|-------|------|
| **SubjectFunding** | `DonationResolver::account_for(target)` | ä¸»é¢˜èµ„é‡‘è´¦æˆ·ï¼ˆå¢“åœ°/å® ç‰©ç®¡ç†è€…ï¼‰ |
| **SpecificAccount** | è·¯ç”±è¡¨æŒ‡å®š | è‡ªå®šä¹‰æ”¶æ¬¾è´¦æˆ·ï¼ˆçµæ´»é…ç½®ï¼‰ |

---

## ä¸ƒã€å›è°ƒæœºåˆ¶ï¼ˆè”ç›Ÿè®¡é…¬é›†æˆï¼‰

### 7.1 OnOfferingCommitted Hook

**ä»£ç **ï¼ˆç¬¬800è¡Œï¼‰ï¼š

```rust
// è°ƒç”¨Hookå¹¶ä¼ é€’è·¯ç”±åˆ†è´¦è®°å½•
T::OnOffering::on_offering(
    target,           // ç›®æ ‡ï¼ˆdomain, idï¼‰
    kind_code,        // ä¾›å¥‰å“ç±»å‹
    &who,             // è´­ä¹°è€…
    settled_amount,   // å®é™…é‡‘é¢
    duration_weeks,   // æœ‰æ•ˆæœŸï¼ˆå‘¨ï¼‰
    routed            // èµ„é‡‘æµå‘è®°å½• [(è´¦æˆ·, é‡‘é¢)]
);
```

**Hookæ¥å£å®šä¹‰**ï¼ˆç¬¬42-58è¡Œï¼‰ï¼š

```rust
pub trait OnOfferingCommitted<AccountId> {
    fn on_offering(
        target: (u8, u64),
        kind_code: u8,
        who: &AccountId,
        amount: Option<u128>,
        duration_weeks: Option<u32>,
        routed: alloc::vec::Vec<(AccountId, u128)>,  // â† èµ„é‡‘æµå‘è®°å½•
    );
}
```

### 7.2 è”ç›Ÿè®¡é…¬å¦‚ä½•å·¥ä½œ

**æµç¨‹**ï¼š
1. ä¾›å¥‰è´­ä¹°æ—¶ï¼Œ40% MEMOè½¬å…¥`AffiliateEscrowAccount`æ‰˜ç®¡è´¦æˆ·
2. `OnOffering` Hookè§¦å‘ï¼Œé€šçŸ¥`pallet-affiliate-instant`
3. `pallet-affiliate-instant`ä»æ‰˜ç®¡è´¦æˆ·ä¸­å–å‡ºæ¨èå¥–åŠ±
4. åˆ†é…ç»™æ¨èäººï¼ˆL1/L2/L3ç­‰å¤šçº§æ¨èï¼‰

**ç¤ºä¾‹**ï¼š
```
ç”¨æˆ·Aï¼ˆè¢«æ¨èäººï¼‰è´­ä¹°ä¾›å¥‰ 100 DUST
    â†“
40 DUST â†’ AffiliateEscrowAccountï¼ˆæ‰˜ç®¡ï¼‰
    â†“
OnOffering Hook è§¦å‘
    â†“
pallet-affiliate-instant è¯»å–æ¨èå…³ç³»ï¼š
    - æ¨èäººBï¼ˆL1ï¼‰ï¼š20 DUSTï¼ˆ50%ï¼‰
    - æ¨èäººCï¼ˆL2ï¼‰ï¼š12 DUSTï¼ˆ30%ï¼‰
    - æ¨èäººDï¼ˆL3ï¼‰ï¼š8 DUSTï¼ˆ20%ï¼‰
```

**å‚è€ƒæ–‡æ¡£**ï¼š`docs/åˆ†æˆç³»ç»Ÿ-å¤šç§ç©æ³•æ–¹æ¡ˆè®¾è®¡.md`

---

## å…«ã€äº‹ä»¶è®°å½•ï¼ˆå®¡è®¡è¿½è¸ªï¼‰

### 8.1 OfferingRouted äº‹ä»¶ï¼ˆç¬¬454-460è¡Œï¼‰

```rust
/// ä¾›å¥‰åˆ†è´¦è·¯ç”±å¿«ç…§ï¼ˆä¾¿äºå®¡è®¡ï¼‰
OfferingRouted {
    id: u64,                                 // ä¾›å¥‰ID
    target: (u8, u64),                       // ç›®æ ‡
    gross: u128,                             // æ€»é‡‘é¢
    shares: alloc::vec::Vec<(T::AccountId, u128)>, // åˆ†è´¦è®°å½•
    remainder: u128,                         // å‰©ä½™é‡‘é¢
}
```

**ç”¨é€”**ï¼š
- âœ… é“¾ä¸Šå®Œæ•´è®°å½•èµ„é‡‘æµå‘
- âœ… ä¾¿äºSubsquidç´¢å¼•å’Œå®¡è®¡
- âœ… é€æ˜åŒ–åˆ†è´¦è¿‡ç¨‹

### 8.2 OfferingCommitted äº‹ä»¶ï¼ˆç¬¬442-450è¡Œï¼‰

```rust
/// ä¾›å¥‰å·²ç¡®è®¤å¹¶è½è´¦ï¼ˆä¾¿äºç´¢å¼•ï¼‰
OfferingCommitted {
    id: u64,
    target: (u8, u64),
    kind_code: u8,
    who: T::AccountId,
    amount: Option<u128>,
    duration_weeks: Option<u32>,
    block: BlockNumberFor<T>,
}
```

---

## ä¹ã€é£é™©æ§åˆ¶

### 9.1 é™é¢‘æœºåˆ¶ï¼ˆé˜²åˆ·ï¼‰

**è´¦æˆ·çº§é™é¢‘**ï¼ˆç¬¬664-672è¡Œï¼‰ï¼š
```rust
let (win_start, cnt) = OfferRate::<T>::get(&who);
let window = OfferWindowParam::<T>::get();  // çª—å£å¤§å°ï¼ˆå—ï¼‰
// æ£€æŸ¥çª—å£å†…ä¾›å¥‰æ¬¡æ•°
ensure!(cnt < OfferMaxInWindowParam::<T>::get(), Error::<T>::TooMany);
```

**ç›®æ ‡çº§é™é¢‘**ï¼ˆç¬¬673-683è¡Œï¼‰ï¼š
```rust
let (t_start, t_cnt) = OfferRateByTarget::<T>::get(target);
// é˜²æ­¢å¯¹å•ä¸€ç›®æ ‡åˆ·ä¾›å¥‰
ensure!(t_cnt < OfferMaxInWindowParam::<T>::get(), Error::<T>::TooMany);
```

### 9.2 æœ€å°é‡‘é¢é™åˆ¶ï¼ˆç¬¬707-709è¡Œï¼‰

```rust
ensure!(
    amt >= MinOfferAmountParam::<T>::get(),
    Error::<T>::AmountTooLow
);
```

### 9.3 æš‚åœæœºåˆ¶

**å…¨å±€æš‚åœ**ï¼ˆç¬¬651è¡Œï¼‰ï¼š
```rust
ensure!(!PausedGlobal::<T>::get(), Error::<T>::NotAllowed);
```

**æŒ‰åŸŸæš‚åœ**ï¼ˆç¬¬652-654è¡Œï¼‰ï¼š
```rust
if PausedByDomain::<T>::get(target.0) {
    return Err(Error::<T>::NotAllowed.into());
}
```

---

## åã€æ€»ç»“å¯¹æ¯”

### 10.1 ä¸¤ç§æ–¹å¼å¯¹æ¯”

| ç»´åº¦ | `offer()` | `offer_by_sacrifice()` |
|-----|----------|----------------------|
| **åˆ†è´¦æ–¹å¼** | âœ… å¤šè·¯åˆ†è´¦ï¼ˆè·¯ç”±è¡¨ï¼‰ | âŒ ç›´æ¥è½¬è´¦ï¼ˆæ— åˆ†è´¦ï¼‰ |
| **é”€æ¯æœºåˆ¶** | âœ… æ”¯æŒï¼ˆå¯é…ç½®ï¼‰ | âŒ ä¸æ”¯æŒ |
| **æ¨èå¥–åŠ±** | âœ… æ”¯æŒï¼ˆé€šè¿‡æ‰˜ç®¡è´¦æˆ·ï¼‰ | âŒ ä¸æ”¯æŒ |
| **èµ„é‡‘æµå‘** | çµæ´»å¯é…ç½®ï¼ˆ5è·¯ï¼‰ | å›ºå®šï¼ˆå•ä¸€è´¦æˆ·ï¼‰ |
| **Gasè´¹ç”¨** | è¾ƒé«˜ï¼ˆå¤šæ¬¡è½¬è´¦ï¼‰ | è¾ƒä½ï¼ˆå•æ¬¡è½¬è´¦ï¼‰ |
| **å®¡è®¡é€æ˜** | âœ… OfferingRoutedäº‹ä»¶ | âš ï¸ ç®€å•è®°å½• |
| **ä½¿ç”¨åœºæ™¯** | æ ‡å‡†ä¾›å¥‰ï¼ˆæ¨èä½¿ç”¨ï¼‰ | ç‰¹æ®Šåœºæ™¯ï¼ˆå¿«é€Ÿæ¨¡å¼ï¼‰ |

### 10.2 æ¨èä½¿ç”¨åœºæ™¯

#### ä½¿ç”¨ `offer()` çš„åœºæ™¯ âœ…

1. **æ ‡å‡†ä¾›å¥‰è´­ä¹°**ï¼ˆé²œèŠ±ã€èœ¡çƒ›ç­‰ï¼‰
2. **éœ€è¦æ¨èå¥–åŠ±**çš„åœºæ™¯
3. **éœ€è¦é”€æ¯MEMO**ï¼ˆé€šç¼©æœºåˆ¶ï¼‰
4. **éœ€è¦è¯¦ç»†å®¡è®¡**çš„åœºæ™¯

#### ä½¿ç”¨ `offer_by_sacrifice()` çš„åœºæ™¯ âš ï¸

1. **å® ç‰©é“å…·è´­ä¹°**ï¼ˆå¿«é€Ÿç”Ÿæ•ˆï¼‰
2. **ä¸éœ€è¦åˆ†è´¦**çš„åœºæ™¯
3. **è¿½æ±‚ä½Gasè´¹ç”¨**çš„åœºæ™¯
4. **ç®€å•ç›´æ¥è½¬è´¦**çš„åœºæ™¯

---

## åä¸€ã€èµ„é‡‘å®‰å…¨ä¿éšœ

### 11.1 è½¬è´¦å®‰å…¨

âœ… **KeepAliveä¿æŠ¤**ï¼š
```rust
T::Currency::transfer(&who, &acc, bal, ExistenceRequirement::KeepAlive)?;
```
- é˜²æ­¢è´¦æˆ·ä½™é¢é™è‡³0è¢«æ¸…ç†
- ç¡®ä¿ç”¨æˆ·è´¦æˆ·å¯æŒç»­ä½¿ç”¨

âœ… **é¥±å’Œè½¬æ¢**ï¼š
```rust
let bal: BalanceOf<T> = transfer_u128.saturated_into();
```
- é˜²æ­¢æ•´å‹æº¢å‡º
- å®‰å…¨çš„ç±»å‹è½¬æ¢

### 11.2 å‰©ä½™é‡‘é¢å¤„ç†

âœ… **å‰©ä½™é‡‘é¢å›é€€**ï¼ˆç¬¬751-758è¡Œï¼‰ï¼š
```rust
if remainder_u128 > 0 && RouteRemainderToDefault::<T>::get() {
    let dest = T::DonationResolver::account_for(target);
    T::Currency::transfer(&who, &dest, bal, ExistenceRequirement::KeepAlive)?;
}
```

âœ… **é˜²æ­¢èµ„é‡‘ä¸¢å¤±**ï¼š
- è·¯ç”±è¡¨åˆ†é…ä¸è¶³100%æ—¶ï¼Œå‰©ä½™é‡‘é¢è½¬å…¥ç›®æ ‡è´¦æˆ·
- å¯é…ç½®æ˜¯å¦å›é€€ï¼ˆ`RouteRemainderToDefault`ï¼‰

### 11.3 è·¯ç”±è¡¨é™åˆ¶

âœ… **æœ€å¤š5è·¯åˆ†è´¦**ï¼ˆç¬¬722-727è¡Œï¼‰ï¼š
```rust
let max_splits = MaxRouteSplits::<T>::get().max(0);
let shares_trimmed = if shares.len() as u32 > max_splits {
    shares.into_iter().take(max_splits as usize).collect()
} else {
    shares
};
```

âœ… **æ€»æ¯”ä¾‹ä¸è¶…è¿‡100%**ï¼ˆç¬¬895è¡Œï¼‰ï¼š
```rust
ensure!(sum <= Permill::ACCURACY as u32, Error::<T>::TooMany);
```

---

## åäºŒã€æ²»ç†å‚æ•°

### 12.1 å¯è°ƒæ•´å‚æ•°

| å‚æ•°åç§° | é»˜è®¤å€¼ | è°ƒæ•´æ¥å£ | è¯´æ˜ |
|---------|-------|----------|------|
| **OfferWindow** | å¸¸é‡ | `set_offer_params` | é™é¢‘çª—å£å¤§å°ï¼ˆå—ï¼‰ |
| **OfferMaxInWindow** | å¸¸é‡ | `set_offer_params` | çª—å£å†…æœ€å¤šä¾›å¥‰æ¬¡æ•° |
| **MinOfferAmount** | å¸¸é‡ | `set_offer_params` | æœ€å°ä¾›å¥‰é‡‘é¢ï¼ˆu128ï¼‰ |
| **SubjectBps** | 20% | `set_offer_params` | ä¸»é¢˜è´¦æˆ·åˆ†è´¦æ¯”ä¾‹ |
| **MaxRouteSplits** | 5 | å­˜å‚¨å‚æ•° | è·¯ç”±è¡¨æœ€å¤§æ¡æ•° |
| **RouteRemainderToDefault** | true | å­˜å‚¨å‚æ•° | æ˜¯å¦å›é€€å‰©ä½™é‡‘é¢ |

### 12.2 è·¯ç”±è¡¨é…ç½®

**å…¨å±€è·¯ç”±è¡¨**ï¼š
```rust
// æ²»ç†æ¥å£
set_route_table_global(origin, routes: Vec<(u8, Option<AccountId>, u32)>)
```

**æŒ‰åŸŸè·¯ç”±è¡¨**ï¼š
```rust
// æ²»ç†æ¥å£
set_route_table_by_domain(origin, domain: u8, routes: Vec<(u8, Option<AccountId>, u32)>)
```

---

## åä¸‰ã€æ¡ˆä¾‹åˆ†æ

### æ¡ˆä¾‹1ï¼šæ™®é€šç”¨æˆ·è´­ä¹°é²œèŠ±ï¼ˆæ— ä¼šå‘˜ï¼‰

**åœºæ™¯**ï¼š
- ä¾›å¥‰å“ï¼šé²œèŠ±ï¼ˆInstantç±»å‹ï¼‰
- åŸä»·ï¼š`100 DUST`
- ç”¨æˆ·ï¼šéä¼šå‘˜
- è·¯ç”±è¡¨ï¼šå…¨å±€è·¯ç”±è¡¨ï¼ˆæ–¹æ¡ˆAï¼‰

**èµ„é‡‘æµå‘**ï¼š
```
ç”¨æˆ·æ”¯ä»˜ï¼š100 DUST
    â†“
ä¼šå‘˜æŠ˜æ‰£ï¼šæ— ï¼ˆéä¼šå‘˜ï¼‰
æœ€ç»ˆä»·æ ¼ï¼š100 DUST
    â†“
å¤šè·¯åˆ†è´¦ï¼š
    - 20 DUST â†’ å¢“åœ°ç®¡ç†è€…ï¼ˆ20%ï¼‰
    - 40 DUST â†’ è”ç›Ÿæ‰˜ç®¡è´¦æˆ·ï¼ˆ40%ï¼‰
    - 2 DUST  â†’ å­˜å‚¨è´¹ç”¨ï¼ˆ2%ï¼‰
    - 8 DUST  â†’ å›½åº“ï¼ˆ8%ï¼‰
    - 30 DUST â†’ é”€æ¯ï¼ˆ30%ï¼‰
```

### æ¡ˆä¾‹2ï¼šå¹´è´¹ä¼šå‘˜è´­ä¹°å® ç‰©é£Ÿç‰©ï¼ˆTimedï¼‰

**åœºæ™¯**ï¼š
- ä¾›å¥‰å“ï¼šå® ç‰©é£Ÿç‰©ï¼ˆTimedç±»å‹ï¼‰
- å•ä»·ï¼š`10 DUST/å‘¨`
- è´­ä¹°æ—¶é•¿ï¼š`4å‘¨`
- åŸä»·ï¼š`10 Ã— 4 = 40 DUST`
- ç”¨æˆ·ï¼šå¹´è´¹ä¼šå‘˜ï¼ˆ30%æŠ˜æ‰£ï¼‰
- è·¯ç”±è¡¨ï¼šå® ç‰©åŸŸè·¯ç”±è¡¨

**èµ„é‡‘æµå‘**ï¼š
```
åŸä»·ï¼š40 DUST
    â†“
ä¼šå‘˜æŠ˜æ‰£ï¼š30%ï¼ˆ3æŠ˜ï¼‰
æœ€ç»ˆä»·æ ¼ï¼š40 Ã— 30% = 12 DUST âœ…
    â†“
å¤šè·¯åˆ†è´¦ï¼ˆå® ç‰©åŸŸï¼‰ï¼š
    - 1.2 DUST â†’ å® ç‰©ä¸»äººï¼ˆ10%ï¼‰
    - 6 DUST   â†’ è”ç›Ÿæ‰˜ç®¡è´¦æˆ·ï¼ˆ50%ï¼‰
    - 0.24 DUST â†’ å­˜å‚¨è´¹ç”¨ï¼ˆ2%ï¼‰
    - 0.96 DUST â†’ å›½åº“ï¼ˆ8%ï¼‰
    - 3.6 DUST  â†’ é”€æ¯ï¼ˆ30%ï¼‰
```

### æ¡ˆä¾‹3ï¼šæ¨èå¥–åŠ±åˆ†é…ï¼ˆè”ç›Ÿè®¡é…¬ï¼‰

**åœºæ™¯**ï¼š
- æ¥ä¸Šè¿°æ¡ˆä¾‹2ï¼Œè”ç›Ÿæ‰˜ç®¡è´¦æˆ·æ”¶åˆ° `6 DUST`
- æ¨èå…³ç³»ï¼šç”¨æˆ·Aè¢«Bæ¨èï¼ŒBè¢«Cæ¨èï¼ŒCè¢«Dæ¨è
- æ¨èåˆ†é…æ¯”ä¾‹ï¼šL1=50%, L2=30%, L3=20%

**æ¨èå¥–åŠ±åˆ†é…**ï¼ˆç”±`pallet-affiliate-instant`å¤„ç†ï¼‰ï¼š
```
è”ç›Ÿæ‰˜ç®¡è´¦æˆ·ï¼š6 DUST
    â†“
OnOffering Hook è§¦å‘
    â†“
æ¨èå¥–åŠ±åˆ†é…ï¼š
    - Bï¼ˆL1ï¼‰ï¼š6 Ã— 50% = 3 DUST
    - Cï¼ˆL2ï¼‰ï¼š6 Ã— 30% = 1.8 DUST
    - Dï¼ˆL3ï¼‰ï¼š6 Ã— 20% = 1.2 DUST
```

**æ€»è®¡**ï¼š3 + 1.8 + 1.2 = 6 DUST âœ…

---

## åå››ã€å»ºè®®ä¸ä¼˜åŒ–

### 14.1 å½“å‰é—®é¢˜

1. **`offer_by_sacrifice` ç¼ºä¹åˆ†è´¦**ï¼š
   - âŒ èµ„é‡‘ç›´æ¥è½¬å…¥ç›®æ ‡è´¦æˆ·
   - âŒ æ— æ¨èå¥–åŠ±
   - âŒ æ— é”€æ¯æœºåˆ¶

2. **è·¯ç”±è¡¨é…ç½®å¤æ‚**ï¼š
   - âš ï¸ éœ€è¦æ²»ç†å¤šæ¬¡è°ƒç”¨é…ç½®
   - âš ï¸ å‰ç«¯éœ€è¦ç†è§£è·¯ç”±è§„åˆ™

### 14.2 ä¼˜åŒ–å»ºè®®

#### å»ºè®®1ï¼šç»Ÿä¸€ä¸¤ç§æ–¹å¼çš„åˆ†è´¦é€»è¾‘

**æ–¹æ¡ˆ**ï¼šè®©`offer_by_sacrifice`ä¹Ÿæ”¯æŒè·¯ç”±è¡¨

```rust
// ä¿®æ”¹ offer_by_sacrifice å‡½æ•°ï¼ˆç¬¬1199-1202è¡Œï¼‰
// ä»ï¼š
let dest = T::DonationResolver::account_for(target);
T::Currency::transfer(&who, &dest, amt_balance, ExistenceRequirement::KeepAlive)?;

// æ”¹ä¸ºï¼š
let shares = T::DonationRouter::route(target, final_price);
// ... æŒ‰è·¯ç”±è¡¨åˆ†è´¦ï¼ˆä¸ offer å‡½æ•°é€»è¾‘ä¸€è‡´ï¼‰
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç»Ÿä¸€èµ„é‡‘æµå‘é€»è¾‘
- âœ… ç¥­ç¥€å“è´­ä¹°ä¹Ÿèƒ½è·å¾—æ¨èå¥–åŠ±
- âœ… æ”¯æŒé”€æ¯æœºåˆ¶

#### å»ºè®®2ï¼šæä¾›é»˜è®¤è·¯ç”±è¡¨æ¨¡æ¿

**æ–¹æ¡ˆ**ï¼šåœ¨Runtimeåˆå§‹åŒ–æ—¶è®¾ç½®é»˜è®¤è·¯ç”±è¡¨

```rust
// runtime/src/lib.rs

// æ ‡å‡†åˆ†è´¦æ¨¡æ¿
const DEFAULT_ROUTES: [(u8, Option<AccountId>, u32); 5] = [
    (0, None, 200000),  // ä¸»é¢˜ï¼š20%
    (1, Some(AffiliateEscrow), 400000),  // æ¨èï¼š40%
    (1, Some(Storage), 20000),  // å­˜å‚¨ï¼š2%
    (3, None, 80000),   // å›½åº“ï¼š8%
    (2, None, 300000),  // é”€æ¯ï¼š30%
];
```

#### å»ºè®®3ï¼šå‰ç«¯å¯è§†åŒ–é…ç½®å·¥å…·

**æ–¹æ¡ˆ**ï¼šåœ¨æ²»ç†å‰ç«¯æä¾›è·¯ç”±è¡¨é…ç½®ç•Œé¢

```tsx
// è·¯ç”±è¡¨é…ç½®ç»„ä»¶
<RouteTableEditor
  routes={[
    { type: 'SubjectFunding', percent: 20 },
    { type: 'AffiliateReward', percent: 40 },
    { type: 'Storage', percent: 2 },
    { type: 'Treasury', percent: 8 },
    { type: 'Burn', percent: 30 },
  ]}
  onSave={(routes) => api.tx.offerings.setRouteTableGlobal(routes)}
/>
```

---

## åäº”ã€ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | è·¯å¾„ | è¯´æ˜ |
|-----|------|------|
| **åˆ†æˆç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ** | `docs/åˆ†æˆç³»ç»Ÿ-å¤šç§ç©æ³•æ–¹æ¡ˆè®¾è®¡.md` | è”ç›Ÿè®¡é…¬è¯¦ç»†è®¾è®¡ |
| **Offerings Palletæºç ** | `pallets/memo-offerings/src/lib.rs` | ä¾›å¥‰ç³»ç»Ÿå®ç° |
| **Affiliate Instant Pallet** | `pallets/affiliate-instant/src/lib.rs` | å³æ—¶æ¨èå¥–åŠ± |
| **æœ¬æ–‡æ¡£** | `docs/ä¾›å¥‰ç³»ç»Ÿ-èµ„é‡‘æµå‘åˆ†æ.md` | ä¾›å¥‰èµ„é‡‘æµå‘åˆ†æ |

---

## åå…­ã€å¸¸è§é—®é¢˜ï¼ˆFAQï¼‰

### Q1ï¼šä¼šå‘˜æŠ˜æ‰£å¦‚ä½•åº”ç”¨ï¼Ÿ

**A**ï¼šä¼šå‘˜æŠ˜æ‰£åœ¨ä»·æ ¼è®¡ç®—é˜¶æ®µåº”ç”¨ï¼Œæœ€ç»ˆä»·æ ¼ = åŸä»· Ã— æŠ˜æ‰£æ¯”ä¾‹ / 100ã€‚
- å¹´è´¹ä¼šå‘˜ï¼š30%ï¼ˆ3æŠ˜ï¼‰
- éä¼šå‘˜ï¼š100%ï¼ˆæ— æŠ˜æ‰£ï¼‰

### Q2ï¼šè·¯ç”±è¡¨åˆ†é…ä¸è¶³100%æ€ä¹ˆåŠï¼Ÿ

**A**ï¼šå‰©ä½™é‡‘é¢ä¼šæ ¹æ®`RouteRemainderToDefault`é…ç½®å†³å®šæ˜¯å¦å›é€€åˆ°ç›®æ ‡è´¦æˆ·ã€‚
- é»˜è®¤ï¼šå›é€€åˆ°ç›®æ ‡è´¦æˆ·ï¼ˆå¢“åœ°/å® ç‰©ç®¡ç†è€…ï¼‰
- å¯é…ç½®ä¸ºï¼šä¸å›é€€ï¼ˆå‰©ä½™é‡‘é¢ä¿ç•™åœ¨ç”¨æˆ·è´¦æˆ·ï¼‰

### Q3ï¼šé”€æ¯çš„MEMOå»å“ªäº†ï¼Ÿ

**A**ï¼šè½¬å…¥`BurnAccount`ï¼ˆé»‘æ´è´¦æˆ·ï¼‰ï¼Œè¿™æ˜¯ä¸€ä¸ªä¸å¯è®¿é—®çš„è´¦æˆ·ï¼Œèµ„é‡‘æ°¸ä¹…é”å®šï¼Œå®ç°é€šç¼©æ•ˆæœã€‚

### Q4ï¼šæ¨èå¥–åŠ±å¦‚ä½•åˆ†é…ï¼Ÿ

**A**ï¼šæ¨èå¥–åŠ±ç”±`pallet-affiliate-instant`å¤„ç†ï¼Œä»è”ç›Ÿæ‰˜ç®¡è´¦æˆ·ä¸­å–å‡ºï¼ŒæŒ‰L1/L2/L3ç­‰çº§åˆ†é…ç»™æ¨èäººã€‚

è¯¦è§ï¼š`docs/åˆ†æˆç³»ç»Ÿ-å¤šç§ç©æ³•æ–¹æ¡ˆè®¾è®¡.md`

### Q5ï¼šä¸ºä»€ä¹ˆæœ‰ä¸¤ç§è´­ä¹°æ–¹å¼ï¼Ÿ

**A**ï¼š
- `offer()`ï¼šæ ‡å‡†æ¨¡å¼ï¼Œæ”¯æŒå®Œæ•´çš„åˆ†è´¦å’Œæ¨èå¥–åŠ±
- `offer_by_sacrifice()`ï¼šå¿«é€Ÿæ¨¡å¼ï¼Œé€‚ç”¨äºç‰¹æ®Šåœºæ™¯ï¼ˆå¦‚å® ç‰©é“å…·ï¼‰

å»ºè®®ç»Ÿä¸€ä½¿ç”¨`offer()`ä»¥è·å¾—å®Œæ•´åŠŸèƒ½ã€‚

---

**åˆ†æå®Œæˆï¼** ğŸ“Š

å¦‚æœ‰ä»»ä½•é—®é¢˜æˆ–éœ€è¦è¿›ä¸€æ­¥åˆ†æï¼Œè¯·éšæ—¶è”ç³»ã€‚

