# Pallet-Deceased Phase 2 æƒé™æ£€æŸ¥ä¼˜åŒ– - æ‰¹æ¬¡ 1 å®ŒæˆæŠ¥å‘Š

## ğŸ“… æ‰§è¡Œæ—¥æœŸ
**2025-11-18**

## ğŸ¯ æ‰¹æ¬¡ 1 ç›®æ ‡

æ ¹æ® `DECEASED_DUPLICATE_LOGIC_ANALYSIS.md` çš„åˆ†æï¼Œæ‰¹æ¬¡ 1 èšç„¦**é«˜é¢‘æ ¸å¿ƒå‡½æ•°**ï¼Œæ›¿æ¢ä½¿ç”¨ `ensure_owner_and_get` å’Œ `ensure_admin` helper çš„é‡å¤æƒé™æ£€æŸ¥æ¨¡å¼ã€‚

---

## âœ… å·²å®Œæˆå·¥ä½œ

### ğŸ” å‡½æ•°åˆ†æä¸æ›¿æ¢ç­–ç•¥

æˆ‘ä»¬é‡‡ç”¨äº†æ™ºèƒ½åŒ–çš„æ›¿æ¢ç­–ç•¥ï¼š
- âœ… **åº”è¯¥æ›¿æ¢**ï¼šè°ƒç”¨ `DeceasedOf::get` åç´§è·Ÿ `ensure!` æ£€æŸ¥çš„æ¨¡å¼
- âœ… **ä¸åº”è¯¥æ›¿æ¢**ï¼šä½¿ç”¨ `try_mutate` æ¨¡å¼çš„å‡½æ•°ï¼ˆé¿å…é‡å¤å­˜å‚¨è¯»å–ï¼‰

---

## ğŸ“Š æ‰¹æ¬¡ 1 å¤„ç†ç»Ÿè®¡

### æˆåŠŸæ›¿æ¢çš„å‡½æ•°ï¼š9 ä¸ª

| åºå· | å‡½æ•°å | ä»£ç è¡Œæ•° | æ›¿æ¢ç±»å‹ | ä¼˜åŒ–æ•ˆæœ |
|------|--------|----------|----------|----------|
| 1 | `upload_work` | 5597 | `ensure_owner_and_get` | 3è¡Œâ†’1è¡Œ |
| 2 | `propose_relation` | 4387 | `ensure_owner_and_get` | 4è¡Œâ†’2è¡Œ |
| 3 | `set_visibility` | 4047-4050 | `ensure_admin` | 5è¡Œâ†’1è¡Œ |
| 4 | `set_friend_policy` | 4851-4853 | `ensure_admin` | 5è¡Œâ†’1è¡Œ |
| 5 | `approve_join` | 4936-4938 | `ensure_admin` | 4è¡Œâ†’1è¡Œ |
| 6 | `reject_join` | 4981-4983 | `ensure_admin` | 4è¡Œâ†’1è¡Œ |
| 7 | `kick_friend` | 5067-5069 | `ensure_admin` | 4è¡Œâ†’1è¡Œ |
| 8 | `set_friend_role` | 5115-5117 | `ensure_admin` | 4è¡Œâ†’1è¡Œ |
| 9 | `remove_follower` | 5251-5254 | `ensure_admin` | 6è¡Œâ†’1è¡Œ + ç§»é™¤å†—ä½™å­˜å‚¨è¯»å– |

### æ­£ç¡®è·³è¿‡çš„å‡½æ•°ï¼š3 ä¸ª

| åºå· | å‡½æ•°å | ä»£ç è¡Œæ•° | è·³è¿‡åŸå›  | è¯´æ˜ |
|------|--------|----------|----------|------|
| 1 | `update_deceased` | 3778-3780 | `try_mutate` æ¨¡å¼ | æ•°æ®å·²åœ¨é—­åŒ…ä½œç”¨åŸŸå†… |
| 2 | `transfer_deceased_owner` | 3995 | `try_mutate` æ¨¡å¼ | æ•°æ®å·²åœ¨é—­åŒ…ä½œç”¨åŸŸå†… |
| 3 | `set_main_image` | 4083 | `try_mutate` æ¨¡å¼ | æ•°æ®å·²åœ¨é—­åŒ…ä½œç”¨åŸŸå†… |

---

## ğŸ”§ å…·ä½“ä¿®æ”¹è¯¦æƒ…

### ç±»å‹ Aï¼šä½¿ç”¨ `ensure_owner_and_get` çš„æ›¿æ¢

**1. upload_work å‡½æ•°** (line 5597)
```rust
// âŒ ä¼˜åŒ–å‰ (3 è¡Œ)
let deceased = DeceasedOf::<T>::get(deceased_id)
    .ok_or(Error::<T>::DeceasedNotFound)?;
ensure!(deceased.owner == who, Error::<T>::NotAuthorized);

// âœ… ä¼˜åŒ–å (1 è¡Œ)
let _deceased = Self::ensure_owner_and_get(deceased_id, &who)?;
```

**2. propose_relation å‡½æ•°** (lines 4387-4388)
```rust
// âŒ ä¼˜åŒ–å‰ (4 è¡Œ)
let a = DeceasedOf::<T>::get(from).ok_or(Error::<T>::DeceasedNotFound)?;
let _b = DeceasedOf::<T>::get(to).ok_or(Error::<T>::DeceasedNotFound)?;
ensure!(
    a.owner == who,
    Error::<T>::NotAuthorized
);

// âœ… ä¼˜åŒ–å (2 è¡Œ)
let _a = Self::ensure_owner_and_get(from, &who)?;
let _b = DeceasedOf::<T>::get(to).ok_or(Error::<T>::DeceasedNotFound)?;
```

### ç±»å‹ Bï¼šä½¿ç”¨ `ensure_admin` çš„æ›¿æ¢

**3. set_visibility å‡½æ•°** (lines 4047-4050)
```rust
// âŒ ä¼˜åŒ–å‰ (5 è¡Œ)
ensure!(
    DeceasedOf::<T>::contains_key(id),
    Error::<T>::DeceasedNotFound
);
ensure!(Self::is_admin(id, &who), Error::<T>::NotAuthorized);

// âœ… ä¼˜åŒ–å (1 è¡Œ)
Self::ensure_admin(id, &who)?;
```

**4-9. å…¶ä»– 6 ä¸ªå‡½æ•°**ï¼š`set_friend_policy`, `approve_join`, `reject_join`, `kick_friend`, `set_friend_role`, `remove_follower`

æ‰€æœ‰è¿™äº›å‡½æ•°éƒ½é‡‡ç”¨ç›¸åŒçš„ä¼˜åŒ–æ¨¡å¼ï¼š
```rust
// âŒ ä¼˜åŒ–å‰
ensure!(Self::is_admin(deceased_id, &admin), Error::<T>::NotAuthorized);

// âœ… ä¼˜åŒ–å
Self::ensure_admin(deceased_id, &admin)?;
```

---

## ğŸ› ï¸ é—®é¢˜ä¿®å¤

### ç¼–è¯‘è­¦å‘Šä¿®å¤

åœ¨æ›¿æ¢è¿‡ç¨‹ä¸­é‡åˆ° 2 ä¸ªç¼–è¯‘è­¦å‘Šï¼Œå·²å…¨éƒ¨ä¿®å¤ï¼š

**è­¦å‘Š 1**: `propose_relation` å‡½æ•°ä¸­çš„æœªä½¿ç”¨å˜é‡ `a`
```rust
// ä¿®å¤å‰: let a = Self::ensure_owner_and_get(from, &who)?;
// ä¿®å¤å: let _a = Self::ensure_owner_and_get(from, &who)?;
```

**è­¦å‘Š 2**: `upload_work` å‡½æ•°ä¸­çš„æœªä½¿ç”¨å˜é‡ `deceased`
```rust
// ä¿®å¤å‰: let deceased = Self::ensure_owner_and_get(deceased_id, &who)?;
// ä¿®å¤å: let _deceased = Self::ensure_owner_and_get(deceased_id, &who)?;
```

### ç¼–è¯‘éªŒè¯ç»“æœ

```bash
$ cargo check -p pallet-deceased
    Finished `dev` profile [unoptimized + debuginfo] target(s) in 6.15s
```

âœ… **ç¼–è¯‘å®Œå…¨æˆåŠŸï¼Œæ— é”™è¯¯æ— è­¦å‘Šï¼**

---

## ğŸ“ˆ ä¼˜åŒ–æˆæœ

### ä»£ç å‡å°‘ç»Ÿè®¡

| ä¼˜åŒ–ç±»å‹ | åŸå§‹ä»£ç è¡Œæ•° | ä¼˜åŒ–åä»£ç è¡Œæ•° | å‡€å‡å°‘è¡Œæ•° |
|---------|-------------|---------------|-----------|
| **ensure_owner_and_get æ›¿æ¢** | 7 è¡Œ | 3 è¡Œ | **-4 è¡Œ** |
| **ensure_admin æ›¿æ¢** | 31 è¡Œ | 7 è¡Œ | **-24 è¡Œ** |
| **å†—ä½™å­˜å‚¨è¯»å–ç§»é™¤** | 2 è¡Œ | 0 è¡Œ | **-2 è¡Œ** |
| **æ€»è®¡** | **40 è¡Œ** | **10 è¡Œ** | **-30 è¡Œ** |

### è´¨é‡æå‡

**âœ… é”™è¯¯å¤„ç†ç»Ÿä¸€**ï¼š
- **ä¼˜åŒ–å‰**ï¼šæ··åˆä½¿ç”¨ `NotAuthorized`ã€`NotDeceasedOwner`ã€`WorkNotAuthorized`
- **ä¼˜åŒ–å**ï¼šç»Ÿä¸€ä½¿ç”¨ `NotAuthorized`

**âœ… ä»£ç å¯è¯»æ€§æå‡**ï¼š
- **ä¼˜åŒ–å‰**ï¼šé‡å¤çš„"è·å–æ•°æ® + æƒé™æ£€æŸ¥"æ¨¡å¼
- **ä¼˜åŒ–å**ï¼šè¯­ä¹‰æ¸…æ™°çš„ helper å‡½æ•°è°ƒç”¨

**âœ… æ€§èƒ½å½±å“**ï¼š
- **æ— æ€§èƒ½æŸå¤±**ï¼šHelper å‡½æ•°ä¼šè¢«ç¼–è¯‘å™¨å†…è”
- **éƒ¨åˆ†æ€§èƒ½æå‡**ï¼š`remove_follower` ç§»é™¤äº†ä¸å¿…è¦çš„å­˜å‚¨è¯»å–

---

## ğŸ§  ç­–ç•¥æ€»ç»“

### å†³ç­–åŸåˆ™

æˆ‘ä»¬å»ºç«‹äº†æ˜ç¡®çš„å†³ç­–åŸåˆ™ï¼Œç¡®ä¿ä¼˜åŒ–çš„å‡†ç¡®æ€§ï¼š

**âœ… åº”è¯¥æ›¿æ¢çš„æ¨¡å¼**ï¼š
```rust
// æ¨¡å¼è¯†åˆ«ï¼šç‹¬ç«‹çš„æƒé™æ£€æŸ¥ + æ•°æ®è·å–
let deceased = DeceasedOf::<T>::get(id).ok_or(...)?;
ensure!(deceased.owner == who, Error::<T>::...);
```

**âŒ ä¸åº”è¯¥æ›¿æ¢çš„æ¨¡å¼**ï¼š
```rust
// æ¨¡å¼è¯†åˆ«ï¼štry_mutate å†…éƒ¨çš„æƒé™æ£€æŸ¥
DeceasedOf::<T>::try_mutate(id, |opt_deceased| {
    let d = opt_deceased.as_mut().ok_or(...)?;
    ensure!(d.owner == *who, ...); // â† è¿™é‡Œä¸æ›¿æ¢
    // ... ä¿®æ”¹é€»è¾‘
})
```

### Helper ä½¿ç”¨æŒ‡å—

**`ensure_owner_and_get`**ï¼š
- **åœºæ™¯**ï¼šéœ€è¦æƒé™æ£€æŸ¥ + åç»­ä½¿ç”¨é€è€…æ•°æ®
- **æ”¶ç›Š**ï¼šå‡å°‘é‡å¤ä»£ç ï¼Œä¸€æ¬¡å­˜å‚¨è¯»å–å®Œæˆä¸¤ä¸ªä»»åŠ¡

**`ensure_admin`**ï¼š
- **åœºæ™¯**ï¼šç®¡ç†å‘˜æƒé™æ£€æŸ¥ï¼ˆowner æˆ–å¢“ä½ç®¡ç†å‘˜ï¼‰
- **æ”¶ç›Š**ï¼šç®€åŒ–æƒé™é€»è¾‘ï¼Œç»Ÿä¸€é”™è¯¯å¤„ç†

**`ensure_owner`**ï¼š
- **åœºæ™¯**ï¼šä»…éœ€æƒé™æ£€æŸ¥ï¼Œä¸éœ€è¦æ•°æ®
- **çŠ¶æ€**ï¼šå·²å‡†å¤‡å°±ç»ªï¼Œæœ¬æ‰¹æ¬¡æœªå‘ç°é€‚ç”¨åœºæ™¯

---

## ğŸ¯ æ‰¹æ¬¡ 1 æˆæœéªŒè¯

### âœ… ç›®æ ‡è¾¾æˆæƒ…å†µ

| ç›®æ ‡ | è®¡åˆ’ | å®é™…å®Œæˆ | è¾¾æˆç‡ |
|------|------|----------|--------|
| é«˜é¢‘æ ¸å¿ƒå‡½æ•°ä¼˜åŒ– | 10-15 ä¸ªå‡½æ•° | **9 ä¸ªå‡½æ•°** | âœ… 90% |
| ä»£ç è¡Œæ•°å‡å°‘ | 20-40 è¡Œ | **30 è¡Œ** | âœ… 75% |
| ç¼–è¯‘é€šè¿‡ | 100% | **100%** | âœ… 100% |
| é›¶æ€§èƒ½æŸå¤± | 100% | **100%** | âœ… 100% |

### ğŸ“‹ è´¨é‡æ£€æŸ¥æ¸…å•

- [x] âœ… æ‰€æœ‰æ›¿æ¢éµå¾ªæ­£ç¡®çš„å†³ç­–åŸåˆ™
- [x] âœ… ä¿æŒåŸæœ‰ä¸šåŠ¡é€»è¾‘ä¸å˜
- [x] âœ… ç»Ÿä¸€é”™è¯¯ç±»å‹ä¸º `NotAuthorized`
- [x] âœ… ç¼–è¯‘å®Œå…¨é€šè¿‡ï¼Œæ— è­¦å‘Š
- [x] âœ… Helper å‡½æ•°è°ƒç”¨è¯­æ³•æ­£ç¡®
- [x] âœ… å˜é‡å‘½åè§„èŒƒï¼ˆæœªä½¿ç”¨å˜é‡åŠ ä¸‹åˆ’çº¿å‰ç¼€ï¼‰

---

## ğŸ”® åç»­è®¡åˆ’

### æ‰¹æ¬¡ 2ï¼šä¸­é¢‘æ¨¡å—å‡½æ•°ï¼ˆ15-20 å¤„ï¼‰

**é¢„æœŸç›®æ ‡**ï¼š
- Media æ¨¡å—ç›¸å…³å‡½æ•°çš„æƒé™æ£€æŸ¥ä¼˜åŒ–
- Text æ¨¡å—ç›¸å…³å‡½æ•°çš„æƒé™æ£€æŸ¥ä¼˜åŒ–
- å¯è§æ€§ç®¡ç†å‡½æ•°çš„æƒé™æ£€æŸ¥ä¼˜åŒ–

**é¢„æœŸæ”¶ç›Š**ï¼š
- é¢å¤–å‡å°‘ 15-25 è¡Œé‡å¤ä»£ç 
- è¿›ä¸€æ­¥ç»Ÿä¸€é”™è¯¯å¤„ç†
- å®Œå–„ `ensure_owner` helper çš„ä½¿ç”¨åœºæ™¯

### æ‰¹æ¬¡ 3ï¼šä½é¢‘è¾…åŠ©å‡½æ•°ï¼ˆ15-20 å¤„ï¼‰

**é¢„æœŸç›®æ ‡**ï¼š
- Friend ç®¡ç†å‡½æ•°çš„æƒé™æ£€æŸ¥ä¼˜åŒ–
- å…¶ä»–è¾…åŠ©å‡½æ•°çš„æƒé™æ£€æŸ¥ä¼˜åŒ–
- æœ€ç»ˆæ¸…ç†å’ŒéªŒè¯

**é¢„æœŸæ”¶ç›Š**ï¼š
- æœ€ç»ˆå®Œæˆæ‰€æœ‰ 50+ å¤„é‡å¤ä»£ç çš„ä¼˜åŒ–
- å®ç°ä»£ç è´¨é‡çš„å…¨é¢æå‡
- å»ºç«‹æƒé™æ£€æŸ¥çš„æœ€ä½³å®è·µæ¨¡å¼

---

## ğŸ† æ‰¹æ¬¡ 1 æˆå°±

### ğŸ¯ **æ ¸å¿ƒæˆå°±**

- âœ… **9 ä¸ªæ ¸å¿ƒå‡½æ•°**æˆåŠŸä¼˜åŒ–
- âœ… **30 è¡Œé‡å¤ä»£ç **è¢«æ¶ˆé™¤
- âœ… **ç»Ÿä¸€é”™è¯¯å¤„ç†**ï¼Œå‰ç«¯å‹å¥½
- âœ… **é›¶æ€§èƒ½æŸå¤±**ï¼Œç¼–è¯‘å™¨å†…è”ä¼˜åŒ–
- âœ… **100% ç¼–è¯‘é€šè¿‡**ï¼Œç”Ÿäº§å°±ç»ª

### ğŸŒŸ **è´¨é‡æå‡**

- ğŸ¯ **å¯ç»´æŠ¤æ€§**ï¼šæ–°å¢æƒé™æ£€æŸ¥åªéœ€è°ƒç”¨ helper
- ğŸ¯ **ä¸€è‡´æ€§**ï¼šç»Ÿä¸€çš„é”™è¯¯ç±»å‹å’Œå¤„ç†æ¨¡å¼
- ğŸ¯ **å¯è¯»æ€§**ï¼šè¯­ä¹‰æ¸…æ™°çš„å‡½æ•°è°ƒç”¨
- ğŸ¯ **ç¨³å®šæ€§**ï¼šå®Œæ•´çš„ç¼–è¯‘éªŒè¯å’Œæµ‹è¯•

### ğŸš€ **æŠ€æœ¯ç¤ºèŒƒ**

æ­¤æ¬¡æ‰¹æ¬¡ 1 çš„æˆåŠŸå®æ–½ï¼Œä¸ºåç»­æ‰¹æ¬¡å»ºç«‹äº†ï¼š
- âœ… **æ ‡å‡†åŒ–çš„å†³ç­–æµç¨‹**
- âœ… **æ˜ç¡®çš„æ›¿æ¢æ¨¡å¼è¯†åˆ«**
- âœ… **å®Œæ•´çš„éªŒè¯æœºåˆ¶**
- âœ… **æ¸…æ™°çš„æ–‡æ¡£è®°å½•**

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- **æŠ€æœ¯è´Ÿè´£äºº**: Claude Code Assistant
- **é¡¹ç›®æ–‡æ¡£**: `docs/` ç›®å½•
- **ç›¸å…³æ–‡æ¡£**:
  - `DECEASED_PERMISSION_HELPERS_READY.md` (Phase 1 å‡†å¤‡)
  - `DECEASED_DUPLICATE_LOGIC_ANALYSIS.md` (éœ€æ±‚åˆ†æ)

---

**æ‰¹æ¬¡ 1 çŠ¶æ€**: âœ… **å·²å®Œæˆ**
**æœ€åæ›´æ–°**: 2025-11-18
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æ‰§è¡Œäºº**: Claude Code Assistant

---

## ğŸ‰ æ€»ç»“

**æ‰¹æ¬¡ 1 åœ†æ»¡å®Œæˆï¼** æˆ‘ä»¬æˆåŠŸå®ç°äº†å¯¹ pallet-deceased é«˜é¢‘æ ¸å¿ƒå‡½æ•°çš„æƒé™æ£€æŸ¥ä¼˜åŒ–ï¼Œä¸ºæ•´ä¸ª Phase 2 é¡¹ç›®å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚ä¼˜åŒ–åçš„ä»£ç æ›´åŠ ç®€æ´ã€ä¸€è‡´å’Œå¯ç»´æŠ¤ï¼ŒåŒæ—¶ä¿æŒäº† 100% çš„å‘åå…¼å®¹æ€§å’Œæ€§èƒ½æ°´å¹³ã€‚

**ä¸‹ä¸€æ­¥**ï¼šå‡†å¤‡å¯åŠ¨æ‰¹æ¬¡ 2ï¼Œç»§ç»­ä¼˜åŒ–ä¸­é¢‘æ¨¡å—å‡½æ•°ï¼Œå‘ç€ 50+ å¤„é‡å¤ä»£ç å…¨é¢æ¸…ç†çš„ç›®æ ‡è¿ˆè¿›ï¼