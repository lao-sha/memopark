# å›ºå®šå…è´¹æ¬¡æ•°æ–¹æ¡ˆ - è¯¦ç»†è®¾è®¡ä¸å®æ–½

**æ–¹æ¡ˆåç§°**ï¼šæ¯ä¸ªä¹°å®¶å¯¹æ¯ä¸ªåšå¸‚å•†æœ‰å›ºå®šå…è´¹æ¬¡æ•°ï¼ˆå¦‚ 3 æ¬¡ï¼‰

**æ—¥æœŸ**: 2025-10-22  
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜  
**å®æ–½éš¾åº¦**: ğŸŸ¢ ä½

---

## ä¸€ã€æ–¹æ¡ˆæ¦‚è¿°

### 1.1 æ ¸å¿ƒè§„åˆ™

```
1. é»˜è®¤é…é¢ï¼šæ¯ä¸ªåšå¸‚å•†å¯è®¾ç½®é»˜è®¤å…è´¹æ¬¡æ•°ï¼ˆå¦‚ 3 æ¬¡ï¼‰
2. ä¹°å®¶é¦–æ¬¡åˆ›å»ºè®¢å•æ—¶ï¼Œè‡ªåŠ¨è·å¾—é»˜è®¤é…é¢
3. æ¯åˆ›å»ºä¸€ç¬”å…è´¹è®¢å•ï¼Œé…é¢é€’å‡ 1
4. é…é¢ç”¨å®Œåï¼Œä¹°å®¶éœ€è¦è‡ªå·±æ”¯ä»˜ Gas
5. åšå¸‚å•†å¯ä¸ºç‰¹å®šä¹°å®¶å¢åŠ é¢å¤–é…é¢ï¼ˆç”¨äºæ¨å¹¿ï¼‰
```

### 1.2 ä¸šåŠ¡åœºæ™¯

**åœºæ™¯ Aï¼šæ–°ä¹°å®¶é¦–æ¬¡ä¸‹å•**
```
ä¹°å®¶ Alice é€‰æ‹©åšå¸‚å•† #1
  â†“
é¦–æ¬¡åˆ›å»ºè®¢å•ï¼ˆå…è´¹ï¼Œåšå¸‚å•†ä»£ä»˜ Gasï¼‰
  â†“
é…é¢ï¼š3 â†’ 2ï¼ˆå‰©ä½™ 2 æ¬¡å…è´¹ï¼‰
```

**åœºæ™¯ Bï¼šä¹°å®¶ç”¨å®Œé…é¢**
```
ä¹°å®¶ Alice å·²åˆ›å»º 3 ç¬”å…è´¹è®¢å•
  â†“
é…é¢ï¼š0ï¼ˆå·²ç”¨å®Œï¼‰
  â†“
ç¬¬ 4 ç¬”è®¢å•éœ€è¦è‡ªå·±æ”¯ä»˜ Gas
```

**åœºæ™¯ Cï¼šåšå¸‚å•†å¢åŠ é…é¢**
```
åšå¸‚å•†ä¸ºä¼˜è´¨ä¹°å®¶ Alice å¢åŠ  5 æ¬¡å…è´¹é…é¢
  â†“
é…é¢ï¼š0 â†’ 5
  â†“
Alice å¯ç»§ç»­äº«å— 5 æ¬¡å…è´¹æœåŠ¡
```

---

## äºŒã€æŠ€æœ¯å®ç°

### 2.1 Market Maker Pallet å®ç°

#### Step 1ï¼šæ·»åŠ å­˜å‚¨

```rust
// pallets/market-maker/src/lib.rs

#[pallet::storage]
#[pallet::getter(fn free_order_quota)]
/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šä¹°å®¶å…è´¹è®¢å•é…é¢
/// 
/// # å­˜å‚¨ç»“æ„
/// (åšå¸‚å•†ID, ä¹°å®¶è´¦æˆ·) => å‰©ä½™å…è´¹æ¬¡æ•°
/// 
/// # ä¸šåŠ¡é€»è¾‘
/// - æ–°ä¹°å®¶é¦–æ¬¡åˆ›å»ºè®¢å•æ—¶ï¼Œè‡ªåŠ¨åˆå§‹åŒ–ä¸ºé»˜è®¤é…é¢
/// - æ¯æ¬¡åˆ›å»ºå…è´¹è®¢å•æ—¶é€’å‡ 1
/// - é…é¢ä¸º 0 æ—¶ï¼Œä¹°å®¶éœ€è¦è‡ªå·±æ”¯ä»˜ Gas
/// - åšå¸‚å•†å¯ä¸ºç‰¹å®šä¹°å®¶å¢åŠ é¢å¤–é…é¢
/// 
/// # ç¤ºä¾‹
/// ```
/// FreeOrderQuota::<T>::get(1, alice) // è¿”å› 3ï¼ˆå‰©ä½™ 3 æ¬¡å…è´¹ï¼‰
/// ```
pub type FreeOrderQuota<T: Config> = StorageDoubleMap<
    _,
    Blake2_128Concat,
    u64,  // maker_id
    Blake2_128Concat,
    T::AccountId,  // buyer
    u32,  // å‰©ä½™å…è´¹æ¬¡æ•°
    ValueQuery,
>;

#[pallet::storage]
#[pallet::getter(fn free_order_quota_config)]
/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šåšå¸‚å•†å…è´¹æ¬¡æ•°é…ç½®
/// 
/// # å­˜å‚¨ç»“æ„
/// åšå¸‚å•†ID => æ¯ä¸ªæ–°ä¹°å®¶çš„é»˜è®¤å…è´¹æ¬¡æ•°
/// 
/// # ä¸šåŠ¡é€»è¾‘
/// - åšå¸‚å•†å¯ä»¥è®¾ç½®æ¯ä¸ªæ–°ä¹°å®¶çš„é»˜è®¤å…è´¹æ¬¡æ•°
/// - é»˜è®¤ä¸º 3 æ¬¡
/// - è®¾ç½®ä¸º 0 è¡¨ç¤ºä¸æä¾›å…è´¹æœåŠ¡
/// 
/// # ç¤ºä¾‹
/// ```
/// FreeOrderQuotaConfig::<T>::get(1) // è¿”å› 3ï¼ˆæ¯ä¸ªæ–°ä¹°å®¶ 3 æ¬¡å…è´¹ï¼‰
/// ```
pub type FreeOrderQuotaConfig<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u64,  // maker_id
    u32,  // é»˜è®¤å…è´¹æ¬¡æ•°
    ValueQuery,
>;

#[pallet::storage]
#[pallet::getter(fn total_free_orders_consumed)]
/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šåšå¸‚å•†ä»£ä»˜ç»Ÿè®¡
/// 
/// # å­˜å‚¨ç»“æ„
/// åšå¸‚å•†ID => (æ€»ä»£ä»˜æ¬¡æ•°, æ€»ä»£ä»˜é‡‘é¢)
/// 
/// # ä¸šåŠ¡é€»è¾‘
/// - è®°å½•æ¯ä¸ªåšå¸‚å•†ä»£ä»˜çš„æ€»æ¬¡æ•°å’Œæ€»é‡‘é¢
/// - ç”¨äºè¿è¥åˆ†æå’Œæˆæœ¬æ ¸ç®—
/// 
/// # ç¤ºä¾‹
/// ```
/// TotalFreeOrdersConsumed::<T>::get(1) // è¿”å› (150, 1500000000000000000) å³ 150æ¬¡ï¼Œ1.5 DUST
/// ```
pub type TotalFreeOrdersConsumed<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u64,  // maker_id
    (u32, BalanceOf<T>),  // (æ€»æ¬¡æ•°, æ€»é‡‘é¢)
    ValueQuery,
>;
```

#### Step 2ï¼šå®ç°é…é¢ç®¡ç†å‡½æ•°

```rust
// pallets/market-maker/src/lib.rs

#[pallet::call]
impl<T: Config> Pallet<T> {
    /// åšå¸‚å•†è®¾ç½®é»˜è®¤å…è´¹é…é¢
    /// 
    /// # å‚æ•°
    /// - `origin`: åšå¸‚å•†ç­¾å
    /// - `maker_id`: åšå¸‚å•† ID
    /// - `quota`: æ¯ä¸ªæ–°ä¹°å®¶çš„é»˜è®¤å…è´¹æ¬¡æ•°ï¼ˆ0 è¡¨ç¤ºä¸æä¾›å…è´¹æœåŠ¡ï¼‰
    /// 
    /// # åŠŸèƒ½è¯¦ç»†ä¸­æ–‡æ³¨é‡Š
    /// åšå¸‚å•†å¯ä»¥è®¾ç½®æ¯ä¸ªæ–°ä¹°å®¶å¯ä»¥äº«å—çš„å…è´¹è®¢å•æ¬¡æ•°ã€‚
    /// ä¾‹å¦‚ï¼šè®¾ç½®ä¸º 3ï¼Œåˆ™æ¯ä¸ªæ–°ä¹°å®¶æœ‰ 3 æ¬¡å…è´¹åˆ›å»ºè®¢å•çš„æœºä¼šã€‚
    /// è®¾ç½®ä¸º 0 è¡¨ç¤ºä¸æä¾›å…è´¹æœåŠ¡ï¼Œæ‰€æœ‰ä¹°å®¶éƒ½éœ€è¦è‡ªå·±æ”¯ä»˜ Gasã€‚
    /// 
    /// # æƒé‡
    /// - è¯»å–ï¼š1ï¼ˆåšå¸‚å•†éªŒè¯ï¼‰
    /// - å†™å…¥ï¼š1ï¼ˆé…é¢é…ç½®ï¼‰
    /// 
    /// # é”™è¯¯
    /// - `MakerNotFound`: åšå¸‚å•†ä¸å­˜åœ¨
    /// - `NotMaker`: è°ƒç”¨è€…ä¸æ˜¯è¯¥åšå¸‚å•†
    /// 
    /// # äº‹ä»¶
    /// - `FreeQuotaConfigSet`: é…é¢é…ç½®å·²æ›´æ–°
    #[pallet::call_index(30)]
    #[pallet::weight(T::DbWeight::get().reads_writes(1, 1))]
    pub fn set_free_quota_config(
        origin: OriginFor<T>,
        maker_id: u64,
        quota: u32,
    ) -> DispatchResult {
        let who = ensure_signed(origin)?;
        
        // éªŒè¯æ˜¯è¯¥åšå¸‚å•†
        let maker_info = ActiveMarketMakers::<T>::get(maker_id)
            .ok_or(Error::<T>::MakerNotFound)?;
        ensure!(maker_info.account == who, Error::<T>::NotMaker);
        
        // è®¾ç½®é…é¢
        FreeOrderQuotaConfig::<T>::insert(maker_id, quota);
        
        Self::deposit_event(Event::FreeQuotaConfigSet {
            maker_id,
            quota,
        });
        
        Ok(())
    }
    
    /// åšå¸‚å•†ä¸ºç‰¹å®šä¹°å®¶å¢åŠ å…è´¹é…é¢
    /// 
    /// # å‚æ•°
    /// - `origin`: åšå¸‚å•†ç­¾å
    /// - `maker_id`: åšå¸‚å•† ID
    /// - `buyer`: ä¹°å®¶è´¦æˆ·
    /// - `additional_quota`: å¢åŠ çš„å…è´¹æ¬¡æ•°
    /// 
    /// # åŠŸèƒ½è¯¦ç»†ä¸­æ–‡æ³¨é‡Š
    /// åšå¸‚å•†å¯ä»¥ä¸ºç‰¹å®šä¹°å®¶å¢åŠ é¢å¤–çš„å…è´¹é…é¢ã€‚
    /// 
    /// ä½¿ç”¨åœºæ™¯ï¼š
    /// 1. æ¨å¹¿æ´»åŠ¨ï¼šä¸ºå‚ä¸æ´»åŠ¨çš„ç”¨æˆ·å¢åŠ  5 æ¬¡å…è´¹æœºä¼š
    /// 2. ä¼˜è´¨ä¹°å®¶ï¼šä¸ºä¿¡ç”¨è‰¯å¥½çš„ä¹°å®¶å¢åŠ é¢å¤–é…é¢
    /// 3. å®¢æˆ·æœåŠ¡ï¼šä¸ºæŠ•è¯‰ç”¨æˆ·è¡¥å¿å…è´¹æ¬¡æ•°
    /// 4. åˆä½œä¼™ä¼´ï¼šä¸ºåˆä½œæ–¹çš„ç”¨æˆ·æä¾›æ›´å¤šå…è´¹æ¬¡æ•°
    /// 
    /// # æƒé‡
    /// - è¯»å–ï¼š1ï¼ˆåšå¸‚å•†éªŒè¯ï¼‰
    /// - å†™å…¥ï¼š1ï¼ˆä¹°å®¶é…é¢ï¼‰
    /// 
    /// # é”™è¯¯
    /// - `MakerNotFound`: åšå¸‚å•†ä¸å­˜åœ¨
    /// - `NotMaker`: è°ƒç”¨è€…ä¸æ˜¯è¯¥åšå¸‚å•†
    /// 
    /// # äº‹ä»¶
    /// - `FreeQuotaGranted`: å…è´¹é…é¢å·²æˆäºˆ
    #[pallet::call_index(31)]
    #[pallet::weight(T::DbWeight::get().reads_writes(1, 1))]
    pub fn grant_free_quota(
        origin: OriginFor<T>,
        maker_id: u64,
        buyer: AccountIdLookupOf<T>,
        additional_quota: u32,
    ) -> DispatchResult {
        let who = ensure_signed(origin)?;
        let buyer = T::Lookup::lookup(buyer)?;
        
        // éªŒè¯æ˜¯è¯¥åšå¸‚å•†
        let maker_info = ActiveMarketMakers::<T>::get(maker_id)
            .ok_or(Error::<T>::MakerNotFound)?;
        ensure!(maker_info.account == who, Error::<T>::NotMaker);
        
        // å¢åŠ é…é¢
        FreeOrderQuota::<T>::mutate(maker_id, &buyer, |quota| {
            *quota = quota.saturating_add(additional_quota);
        });
        
        Self::deposit_event(Event::FreeQuotaGranted {
            maker_id,
            buyer,
            additional_quota,
        });
        
        Ok(())
    }
    
    /// åšå¸‚å•†æ‰¹é‡å¢åŠ å…è´¹é…é¢
    /// 
    /// # å‚æ•°
    /// - `origin`: åšå¸‚å•†ç­¾å
    /// - `maker_id`: åšå¸‚å•† ID
    /// - `buyers`: ä¹°å®¶è´¦æˆ·åˆ—è¡¨
    /// - `quota_per_buyer`: æ¯ä¸ªä¹°å®¶å¢åŠ çš„å…è´¹æ¬¡æ•°
    /// 
    /// # åŠŸèƒ½è¯¦ç»†ä¸­æ–‡æ³¨é‡Š
    /// åšå¸‚å•†å¯ä»¥æ‰¹é‡ä¸ºå¤šä¸ªä¹°å®¶å¢åŠ å…è´¹é…é¢ã€‚
    /// ç”¨äºå¤§è§„æ¨¡æ¨å¹¿æ´»åŠ¨æˆ–æ‰¹é‡å¥–åŠ±ã€‚
    /// 
    /// # æƒé‡
    /// - è¯»å–ï¼š1ï¼ˆåšå¸‚å•†éªŒè¯ï¼‰
    /// - å†™å…¥ï¼šbuyers.len()ï¼ˆæ¯ä¸ªä¹°å®¶çš„é…é¢ï¼‰
    /// 
    /// # é™åˆ¶
    /// - æœ€å¤šæ‰¹é‡å¤„ç† 100 ä¸ªä¹°å®¶
    #[pallet::call_index(32)]
    #[pallet::weight(T::DbWeight::get().reads_writes(1, buyers.len() as u64))]
    pub fn batch_grant_free_quota(
        origin: OriginFor<T>,
        maker_id: u64,
        buyers: Vec<AccountIdLookupOf<T>>,
        quota_per_buyer: u32,
    ) -> DispatchResult {
        let who = ensure_signed(origin)?;
        
        // éªŒè¯æ˜¯è¯¥åšå¸‚å•†
        let maker_info = ActiveMarketMakers::<T>::get(maker_id)
            .ok_or(Error::<T>::MakerNotFound)?;
        ensure!(maker_info.account == who, Error::<T>::NotMaker);
        
        // é™åˆ¶æ‰¹é‡æ•°é‡
        ensure!(buyers.len() <= 100, Error::<T>::TooManyBuyers);
        
        // æ‰¹é‡å¢åŠ é…é¢
        for buyer_lookup in buyers {
            let buyer = T::Lookup::lookup(buyer_lookup)?;
            FreeOrderQuota::<T>::mutate(maker_id, &buyer, |quota| {
                *quota = quota.saturating_add(quota_per_buyer);
            });
        }
        
        Self::deposit_event(Event::FreeQuotaBatchGranted {
            maker_id,
            count: buyers.len() as u32,
            quota_per_buyer,
        });
        
        Ok(())
    }
}
```

#### Step 3ï¼šå®ç°é…é¢æ¶ˆè´¹é€»è¾‘

```rust
// pallets/market-maker/src/lib.rs

impl<T: Config> Pallet<T> {
    /// æ£€æŸ¥å¹¶æ¶ˆè´¹ä¹°å®¶çš„å…è´¹é…é¢
    /// 
    /// # åŠŸèƒ½è¯¦ç»†ä¸­æ–‡æ³¨é‡Š
    /// å½“ä¹°å®¶å°è¯•åˆ›å»ºå…è´¹è®¢å•æ—¶ï¼Œæ£€æŸ¥å…¶æ˜¯å¦è¿˜æœ‰å…è´¹é…é¢ã€‚
    /// å¦‚æœæœ‰ï¼Œåˆ™é€’å‡é…é¢ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™è¿”å› falseã€‚
    /// 
    /// # å‚æ•°
    /// - `maker_id`: åšå¸‚å•† ID
    /// - `buyer`: ä¹°å®¶è´¦æˆ·
    /// 
    /// # è¿”å›
    /// - `Ok(true)`: æœ‰å…è´¹é…é¢ï¼Œå·²é€’å‡
    /// - `Ok(false)`: æ— å…è´¹é…é¢ï¼Œä¹°å®¶éœ€è‡ªå·±æ”¯ä»˜
    /// 
    /// # ä¸šåŠ¡é€»è¾‘
    /// 1. è·å–ä¹°å®¶å½“å‰é…é¢
    /// 2. å¦‚æœæ˜¯æ–°ä¹°å®¶ï¼ˆé…é¢ä¸º0ï¼‰ï¼Œåˆå§‹åŒ–ä¸ºé»˜è®¤é…é¢
    /// 3. å¦‚æœé…é¢ > 0ï¼Œé€’å‡ 1 å¹¶è¿”å› true
    /// 4. å¦‚æœé…é¢ = 0ï¼Œè¿”å› false
    pub fn consume_free_quota(
        maker_id: u64,
        buyer: &T::AccountId,
    ) -> Result<bool, DispatchError> {
        // è·å–å½“å‰é…é¢
        let mut current_quota = FreeOrderQuota::<T>::get(maker_id, buyer);
        
        // å¦‚æœæ˜¯æ–°ä¹°å®¶ï¼ˆé…é¢ä¸º0ï¼‰ï¼Œåˆå§‹åŒ–é…é¢
        if current_quota == 0 {
            let default_quota = FreeOrderQuotaConfig::<T>::get(maker_id);
            
            // å¦‚æœé»˜è®¤é…é¢ä¹Ÿæ˜¯0ï¼Œè¯´æ˜åšå¸‚å•†ä¸æä¾›å…è´¹æœåŠ¡
            if default_quota == 0 {
                return Ok(false);
            }
            
            // åˆå§‹åŒ–é…é¢
            current_quota = default_quota;
            FreeOrderQuota::<T>::insert(maker_id, buyer, default_quota);
        }
        
        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é…é¢
        if current_quota == 0 {
            return Ok(false);  // æ— é…é¢ï¼Œéœ€è‡ªå·±æ”¯ä»˜
        }
        
        // é€’å‡é…é¢
        let new_quota = current_quota.saturating_sub(1);
        FreeOrderQuota::<T>::insert(maker_id, buyer, new_quota);
        
        // è§¦å‘äº‹ä»¶
        Self::deposit_event(Event::FreeQuotaConsumed {
            maker_id,
            buyer: buyer.clone(),
            remaining: new_quota,
        });
        
        Ok(true)  // æœ‰é…é¢ï¼Œå·²é€’å‡
    }
    
    /// è®°å½•ä»£ä»˜ç»Ÿè®¡
    /// 
    /// # åŠŸèƒ½è¯¦ç»†ä¸­æ–‡æ³¨é‡Š
    /// å½“åšå¸‚å•†ä»£ä»˜ Gas åï¼Œè®°å½•ç»Ÿè®¡ä¿¡æ¯ã€‚
    /// 
    /// # å‚æ•°
    /// - `maker_id`: åšå¸‚å•† ID
    /// - `gas_amount`: Gas é‡‘é¢
    pub fn record_gas_sponsored(
        maker_id: u64,
        gas_amount: BalanceOf<T>,
    ) {
        TotalFreeOrdersConsumed::<T>::mutate(maker_id, |(count, total)| {
            *count = count.saturating_add(1);
            *total = total.saturating_add(gas_amount);
        });
    }
    
    /// æŸ¥è¯¢ä¹°å®¶çš„å‰©ä½™å…è´¹æ¬¡æ•°
    /// 
    /// # å‚æ•°
    /// - `maker_id`: åšå¸‚å•† ID
    /// - `buyer`: ä¹°å®¶è´¦æˆ·
    /// 
    /// # è¿”å›
    /// å‰©ä½™å…è´¹æ¬¡æ•°ï¼ˆå¦‚æœæ˜¯æ–°ä¹°å®¶ï¼Œè¿”å›é»˜è®¤é…é¢ï¼‰
    pub fn get_remaining_quota(
        maker_id: u64,
        buyer: &T::AccountId,
    ) -> u32 {
        let current_quota = FreeOrderQuota::<T>::get(maker_id, buyer);
        
        // å¦‚æœæ˜¯æ–°ä¹°å®¶ï¼Œè¿”å›é»˜è®¤é…é¢
        if current_quota == 0 {
            return FreeOrderQuotaConfig::<T>::get(maker_id);
        }
        
        current_quota
    }
    
    /// æŸ¥è¯¢åšå¸‚å•†çš„ä»£ä»˜ç»Ÿè®¡
    /// 
    /// # è¿”å›
    /// (æ€»ä»£ä»˜æ¬¡æ•°, æ€»ä»£ä»˜é‡‘é¢)
    pub fn get_sponsored_stats(maker_id: u64) -> (u32, BalanceOf<T>) {
        TotalFreeOrdersConsumed::<T>::get(maker_id)
    }
}
```

#### Step 4ï¼šæ·»åŠ äº‹ä»¶å’Œé”™è¯¯

```rust
// pallets/market-maker/src/lib.rs

#[pallet::event]
#[pallet::generate_deposit(pub(super) fn deposit_event)]
pub enum Event<T: Config> {
    // ... å…¶ä»–äº‹ä»¶
    
    /// åšå¸‚å•†è®¾ç½®å…è´¹é…é¢é…ç½®
    /// \[åšå¸‚å•†ID, é…é¢\]
    FreeQuotaConfigSet {
        maker_id: u64,
        quota: u32,
    },
    
    /// åšå¸‚å•†ä¸ºä¹°å®¶æˆäºˆå…è´¹é…é¢
    /// \[åšå¸‚å•†ID, ä¹°å®¶, å¢åŠ çš„é…é¢\]
    FreeQuotaGranted {
        maker_id: u64,
        buyer: T::AccountId,
        additional_quota: u32,
    },
    
    /// åšå¸‚å•†æ‰¹é‡æˆäºˆå…è´¹é…é¢
    /// \[åšå¸‚å•†ID, ä¹°å®¶æ•°é‡, æ¯äººé…é¢\]
    FreeQuotaBatchGranted {
        maker_id: u64,
        count: u32,
        quota_per_buyer: u32,
    },
    
    /// ä¹°å®¶æ¶ˆè´¹å…è´¹é…é¢
    /// \[åšå¸‚å•†ID, ä¹°å®¶, å‰©ä½™é…é¢\]
    FreeQuotaConsumed {
        maker_id: u64,
        buyer: T::AccountId,
        remaining: u32,
    },
}

#[pallet::error]
pub enum Error<T> {
    // ... å…¶ä»–é”™è¯¯
    
    /// å…è´¹é…é¢å·²ç”¨å®Œ
    FreeQuotaExhausted,
    
    /// æ‰¹é‡æ“ä½œä¹°å®¶æ•°é‡è¿‡å¤š
    TooManyBuyers,
}
```

---

### 2.2 OTC Order Pallet é›†æˆ

```rust
// pallets/otc-order/src/lib.rs

#[pallet::call]
impl<T: Config> Pallet<T> {
    /// ä¹°å®¶åˆ›å»ºè®¢å•ï¼ˆåšå¸‚å•†ä»£ä»˜ Gasï¼‰
    /// 
    /// # å‚æ•°
    /// - `origin`: ä¹°å®¶ç­¾å
    /// - `maker_id`: åšå¸‚å•† ID
    /// - `qty`: è´­ä¹°æ•°é‡
    /// - `payment_commit`: æ”¯ä»˜å‡­è¯æ‰¿è¯º
    /// - `contact_commit`: è”ç³»æ–¹å¼æ‰¿è¯º
    /// 
    /// # åŠŸèƒ½è¯¦ç»†ä¸­æ–‡æ³¨é‡Š
    /// ä¹°å®¶åˆ›å»ºè®¢å•ï¼Œå¦‚æœæœ‰å…è´¹é…é¢ï¼ŒGas ç”±åšå¸‚å•†ä»£ä»˜ï¼›å¦åˆ™ä¹°å®¶è‡ªå·±æ”¯ä»˜ã€‚
    /// 
    /// # å…è´¹æ¬¡æ•°æ£€æŸ¥
    /// 1. è°ƒç”¨ `pallet_market_maker::consume_free_quota` æ£€æŸ¥é…é¢
    /// 2. å¦‚æœæœ‰é…é¢ï¼Œç»§ç»­åˆ›å»ºè®¢å•ï¼ˆGas ç”±åšå¸‚å•†ä»£ä»˜ï¼‰
    /// 3. å¦‚æœæ— é…é¢ï¼Œè¿”å›é”™è¯¯ï¼Œæç¤ºä¹°å®¶ä½¿ç”¨æ™®é€šåˆ›å»ºè®¢å•åŠŸèƒ½
    /// 
    /// # æƒé‡
    /// - è¯»å–ï¼š5ï¼ˆåšå¸‚å•† + ä¹°å®¶é…é¢ + ä¹°å®¶ä¿¡ç”¨ + ä»·æ ¼ + æ‰˜ç®¡ï¼‰
    /// - å†™å…¥ï¼š3ï¼ˆè®¢å• + ä¹°å®¶é…é¢ + æ‰˜ç®¡ï¼‰
    #[pallet::call_index(11)]
    #[pallet::weight(<T as frame_system::Config>::DbWeight::get().reads_writes(5, 3))]
    pub fn create_order_free(
        origin: OriginFor<T>,
        maker_id: u64,
        qty: BalanceOf<T>,
        payment_commit: H256,
        contact_commit: H256,
    ) -> DispatchResult {
        let taker = ensure_signed(origin)?;
        
        // 1. æ£€æŸ¥ä¹°å®¶æ˜¯å¦æœ‰å…è´¹é…é¢
        let has_free_quota = pallet_market_maker::Pallet::<T>::consume_free_quota(
            maker_id,
            &taker,
        )?;
        
        if !has_free_quota {
            // æ— å…è´¹é…é¢ï¼Œè¿”å›é”™è¯¯
            return Err(Error::<T>::FreeQuotaExhausted.into());
        }
        
        // 2. éªŒè¯åšå¸‚å•†
        let maker_info = pallet_market_maker::ActiveMarketMakers::<T>::get(maker_id)
            .ok_or(Error::<T>::MakerNotFound)?;
        
        ensure!(
            maker_info.status == pallet_market_maker::ApplicationStatus::Active,
            Error::<T>::MakerNotApproved
        );
        
        // 3. æ£€æŸ¥åšå¸‚å•†ä»£ä»˜æ± ä½™é¢
        let estimated_gas = Self::estimate_gas_fee();
        let sponsor_balance = pallet_market_maker::Pallet::<T>::gas_sponsor_pool(maker_id);
        ensure!(
            sponsor_balance >= estimated_gas,
            Error::<T>::MakerGasSponsorInsufficient
        );
        
        // 4. ä¹°å®¶ä¿¡ç”¨æ£€æŸ¥
        let base_price = pallet_pricing::Pallet::<T>::get_memo_market_price_weighted();
        ensure!(base_price > 0, Error::<T>::PriceNotAvailable);
        
        let amount_usdt = base_price
            .saturating_mul(qty.saturated_into::<u64>())
            / 1_000_000_000_000u64;
        
        pallet_buyer_credit::Pallet::<T>::check_buyer_limit(&taker, amount_usdt)
            .map_err(|_| Error::<T>::BadState)?;
        
        // 5. è·å–ä»·æ ¼å¹¶è®¡ç®—é‡‘é¢
        let sell_premium = maker_info.sell_premium_bps;
        let final_price_u64 = base_price
            .saturating_mul((10000i32 + sell_premium as i32) as u64)
            .saturating_div(10000);
        
        pallet_pricing::Pallet::<T>::check_price_deviation(final_price_u64)?;
        
        let final_price_b: BalanceOf<T> = (final_price_u64 as u128).saturated_into();
        let divisor: BalanceOf<T> = 1_000_000u128.saturated_into();
        let amount_b: BalanceOf<T> = final_price_b.saturating_mul(qty) / divisor;
        
        // 6. é”å®šåšå¸‚å•†çš„ DUST åˆ°æ‰˜ç®¡
        T::Escrow::deposit(&maker_info.account, qty)?;
        
        // 7. åˆ›å»ºè®¢å•
        let order_id = NextOrderId::<T>::mutate(|x| {
            let id = *x;
            *x = x.saturating_add(1);
            id
        });
        
        let now = pallet_timestamp::Pallet::<T>::get();
        
        let order = Order {
            maker_id,
            maker: maker_info.account.clone(),
            taker: taker.clone(),
            price: final_price_b,
            qty,
            amount: amount_b,
            created_at: now,
            expire_at: now + T::ConfirmTTL::get().saturated_into(),
            evidence_until: now + T::EvidenceTTL::get().saturated_into(),
            maker_tron_address: maker_info.tron_address.clone(),
            payment_commit,
            contact_commit,
            state: OrderState::Created,
            epay_trade_no: None,
        };
        
        Orders::<T>::insert(order_id, order);
        
        // 8. è®°å½•ä»£ä»˜ç»Ÿè®¡
        pallet_market_maker::Pallet::<T>::record_gas_sponsored(maker_id, estimated_gas);
        
        // 9. è§¦å‘äº‹ä»¶
        Self::deposit_event(Event::OrderCreatedFree {
            order_id,
            maker_id,
            taker,
            qty,
            amount: amount_b,
            gas_sponsored: true,
        });
        
        Ok(())
    }
}

impl<T: Config> Pallet<T> {
    /// ä¼°ç®—åˆ›å»ºè®¢å•çš„ Gas è´¹ç”¨
    fn estimate_gas_fee() -> BalanceOf<T> {
        // é¢„ä¼°å€¼ï¼šçº¦ 0.01 DUST
        (10_000_000_000_000_000u128).saturated_into()
    }
}

#[pallet::event]
pub enum Event<T: Config> {
    // ... å…¶ä»–äº‹ä»¶
    
    /// è®¢å•å·²åˆ›å»ºï¼ˆåšå¸‚å•†ä»£ä»˜ Gasï¼‰
    /// \[è®¢å•ID, åšå¸‚å•†ID, ä¹°å®¶, æ•°é‡, é‡‘é¢, æ˜¯å¦ä»£ä»˜\]
    OrderCreatedFree {
        order_id: u64,
        maker_id: u64,
        taker: T::AccountId,
        qty: BalanceOf<T>,
        amount: BalanceOf<T>,
        gas_sponsored: bool,
    },
}

#[pallet::error]
pub enum Error<T> {
    // ... å…¶ä»–é”™è¯¯
    
    /// å…è´¹é…é¢å·²ç”¨å®Œ
    FreeQuotaExhausted,
    
    /// åšå¸‚å•†ä»£ä»˜æ± ä½™é¢ä¸è¶³
    MakerGasSponsorInsufficient,
}
```

---

### 2.3 Runtime é…ç½®

```rust
// runtime/src/configs/mod.rs

// æ— éœ€é¢å¤–é…ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼å³å¯
// åšå¸‚å•†å¯ä»¥é€šè¿‡é“¾ä¸Šè°ƒç”¨ set_free_quota_config è®¾ç½®é…é¢
```

---

## ä¸‰ã€å‰ç«¯é›†æˆ

### 3.1 æ˜¾ç¤ºå‰©ä½™å…è´¹æ¬¡æ•°

```typescript
// stardust-dapp/src/features/otc/CreateOrderFreePage.tsx

import React, { useState, useEffect } from 'react';
import { Card, Alert, Progress, Tag, Space, Typography, Form, InputNumber, Input, Button, message } from 'antd';
import { GiftOutlined, RocketOutlined, InfoCircleOutlined } from '@ant-design/icons';
import { useSubstrateContext } from '../../lib/SubstrateContext';
import { stringToHex } from '@polkadot/util';
import { blake2AsHex } from '@polkadot/util-crypto';

const { Title, Text, Paragraph } = Typography;

interface QuotaInfo {
  remaining: number;
  defaultQuota: number;
  consumed: number;
}

export const CreateOrderFreePage: React.FC = () => {
  const { api, currentAccount } = useSubstrateContext();
  const [loading, setLoading] = useState(false);
  const [quotaInfo, setQuotaInfo] = useState<QuotaInfo>({
    remaining: 0,
    defaultQuota: 3,
    consumed: 0,
  });
  const [makerGasSponsor, setMakerGasSponsor] = useState<string>('0');
  
  const makerId = 1;  // å‡è®¾åšå¸‚å•† ID = 1
  
  useEffect(() => {
    if (api && currentAccount) {
      loadQuotaInfo();
    }
  }, [api, currentAccount]);
  
  const loadQuotaInfo = async () => {
    if (!api || !currentAccount) return;
    
    try {
      // 1. æŸ¥è¯¢å‰©ä½™å…è´¹æ¬¡æ•°
      const remainingQuota = await api.query.marketMaker.freeOrderQuota(
        makerId,
        currentAccount.address
      );
      
      // 2. æŸ¥è¯¢é»˜è®¤é…é¢
      const defaultQuota = await api.query.marketMaker.freeOrderQuotaConfig(makerId);
      
      // 3. æŸ¥è¯¢åšå¸‚å•†ä»£ä»˜æ± ä½™é¢
      const sponsorBalance = await api.query.marketMaker.gasSponsorPool(makerId);
      setMakerGasSponsor(sponsorBalance.toString());
      
      const remaining = remainingQuota.toNumber();
      const defaultQ = defaultQuota.toNumber();
      
      setQuotaInfo({
        remaining: remaining === 0 ? defaultQ : remaining,  // æ–°ä¹°å®¶æ˜¾ç¤ºé»˜è®¤é…é¢
        defaultQuota: defaultQ,
        consumed: remaining === 0 ? 0 : defaultQ - remaining,
      });
    } catch (error) {
      console.error('åŠ è½½é…é¢ä¿¡æ¯å¤±è´¥:', error);
    }
  };
  
  const handleCreateOrder = async (values: any) => {
    if (!api || !currentAccount) {
      message.error('è¯·å…ˆè¿æ¥é’±åŒ…');
      return;
    }
    
    if (quotaInfo.remaining === 0) {
      message.error('å…è´¹æ¬¡æ•°å·²ç”¨å®Œï¼Œè¯·ä½¿ç”¨æ™®é€šåˆ›å»ºè®¢å•åŠŸèƒ½');
      return;
    }
    
    setLoading(true);
    
    try {
      // 1. è®¡ç®—æ‰¿è¯º
      const paymentCommit = blake2AsHex(stringToHex(values.paymentInfo));
      const contactCommit = blake2AsHex(stringToHex(values.contactInfo));
      
      // 2. è°ƒç”¨é“¾ä¸Šå‡½æ•°ï¼ˆGas ç”±åšå¸‚å•†ä»£ä»˜ï¼‰
      const tx = api.tx.otcOrder.createOrderFree(
        makerId,
        values.qty * 1e18,
        paymentCommit,
        contactCommit,
      );
      
      // 3. ç­¾åå¹¶å‘é€
      await tx.signAndSend(currentAccount, ({ status, events }) => {
        if (status.isInBlock) {
          // è§£æäº‹ä»¶
          events.forEach(({ event }) => {
            if (api.events.otcOrder.OrderCreatedFree.is(event)) {
              const [orderId] = event.data;
              message.success(`è®¢å•åˆ›å»ºæˆåŠŸï¼è®¢å•ID: ${orderId.toHuman()}`);
              message.info('ğŸ‰ Gas è´¹ç”¨ç”±åšå¸‚å•†æ”¯ä»˜ï¼Œå®Œå…¨å…è´¹ï¼');
            }
            
            if (api.events.marketMaker.FreeQuotaConsumed.is(event)) {
              const [, , remaining] = event.data;
              message.info(`å‰©ä½™å…è´¹æ¬¡æ•°: ${remaining.toHuman()}`);
            }
          });
          
          // åˆ·æ–°é…é¢ä¿¡æ¯
          setTimeout(() => loadQuotaInfo(), 2000);
        }
      });
      
    } catch (error) {
      console.error('åˆ›å»ºè®¢å•å¤±è´¥:', error);
      
      if (error.message.includes('FreeQuotaExhausted')) {
        message.error('å…è´¹æ¬¡æ•°å·²ç”¨å®Œï¼Œè¯·ä½¿ç”¨æ™®é€šåˆ›å»ºè®¢å•åŠŸèƒ½');
      } else {
        message.error(`åˆ›å»ºè®¢å•å¤±è´¥: ${error.message}`);
      }
    } finally {
      setLoading(false);
    }
  };
  
  // è®¡ç®—é…é¢è¿›åº¦
  const quotaPercentage = (quotaInfo.remaining / quotaInfo.defaultQuota) * 100;
  
  return (
    <div style={{ maxWidth: 600, margin: '0 auto', padding: 24 }}>
      <Card>
        <div style={{ textAlign: 'center', marginBottom: 24 }}>
          <RocketOutlined style={{ fontSize: 48, color: '#1890ff' }} />
          <Title level={3}>åˆ›å»ºè®¢å•ï¼ˆå…è´¹ï¼‰</Title>
          <Paragraph type="secondary">
            åšå¸‚å•†ä¸ºæ‚¨ä»£ä»˜ Gas è´¹ç”¨ï¼Œå®Œå…¨å…è´¹ï¼
          </Paragraph>
        </div>
        
        {/* å…è´¹é…é¢å¡ç‰‡ */}
        <Card type="inner" style={{ background: '#f0f5ff', marginBottom: 24 }}>
          <Space direction="vertical" size="middle" style={{ width: '100%' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <Space>
                <GiftOutlined style={{ fontSize: 24, color: '#1890ff' }} />
                <Text strong style={{ fontSize: 18 }}>æ‚¨çš„å…è´¹é…é¢</Text>
              </Space>
              <Tag color={quotaInfo.remaining > 0 ? 'blue' : 'default'} style={{ fontSize: 14 }}>
                {quotaInfo.remaining > 0 ? 'å¯ç”¨' : 'å·²ç”¨å®Œ'}
              </Tag>
            </div>
            
            <div>
              <Text style={{ fontSize: 36, fontWeight: 'bold', color: '#1890ff' }}>
                {quotaInfo.remaining}
              </Text>
              <Text type="secondary" style={{ marginLeft: 8, fontSize: 16 }}>
                / {quotaInfo.defaultQuota} æ¬¡å…è´¹
              </Text>
            </div>
            
            <Progress
              percent={quotaPercentage}
              strokeColor={{
                '0%': '#ff4d4f',
                '50%': '#faad14',
                '100%': '#52c41a',
              }}
              format={() => `å‰©ä½™ ${quotaInfo.remaining} æ¬¡`}
            />
            
            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
              <Text type="secondary">
                <InfoCircleOutlined /> æ¯ä¸ªæ–°ä¹°å®¶é»˜è®¤ {quotaInfo.defaultQuota} æ¬¡å…è´¹
              </Text>
              <Text type="secondary">
                å·²ä½¿ç”¨ {quotaInfo.consumed} æ¬¡
              </Text>
            </div>
          </Space>
        </Card>
        
        {/* åšå¸‚å•†ä»£ä»˜æ± çŠ¶æ€ */}
        <Card type="inner" style={{ background: '#f6ffed', marginBottom: 24 }}>
          <Text strong>ğŸ’° åšå¸‚å•†ä»£ä»˜æ± çŠ¶æ€</Text>
          <div style={{ marginTop: 12 }}>
            <Text>
              å‰©ä½™é¢åº¦: {(parseFloat(makerGasSponsor) / 1e18).toFixed(2)} DUST
            </Text>
            <br />
            <Text type="secondary">
              é¢„ä¼°å¯åˆ›å»º {Math.floor(parseFloat(makerGasSponsor) / 1e18 / 0.01)} ç¬”å…è´¹è®¢å•
            </Text>
          </div>
        </Card>
        
        {/* é…é¢ç”¨å®Œæç¤º */}
        {quotaInfo.remaining === 0 && (
          <Alert
            message="âš ï¸ å…è´¹æ¬¡æ•°å·²ç”¨å®Œ"
            description={
              <div>
                <Text>æ‚¨å¯ä»¥ï¼š</Text>
                <ol style={{ marginTop: 8, marginBottom: 0 }}>
                  <li>ä½¿ç”¨æ™®é€šåˆ›å»ºè®¢å•åŠŸèƒ½ï¼ˆæ”¯ä»˜çº¦ 0.01 DUST Gas è´¹ï¼‰</li>
                  <li>è”ç³»åšå¸‚å•†ç”³è¯·å¢åŠ å…è´¹é…é¢</li>
                  <li>å®Œæˆè®¢å•æå‡ä¿¡ç”¨åˆ†ï¼Œæœªæ¥å¯èƒ½è·å¾—æ›´å¤šå…è´¹æ¬¡æ•°</li>
                </ol>
              </div>
            }
            type="warning"
            showIcon
            style={{ marginBottom: 24 }}
          />
        )}
        
        {/* åˆ›å»ºè®¢å•è¡¨å• */}
        <Form onFinish={handleCreateOrder} layout="vertical">
          <Form.Item
            label="è´­ä¹°æ•°é‡ï¼ˆDUSTï¼‰"
            name="qty"
            rules={[
              { required: true, message: 'è¯·è¾“å…¥è´­ä¹°æ•°é‡' },
              { type: 'number', min: 10, message: 'æœ€å°‘è´­ä¹° 10 DUST' },
            ]}
          >
            <InputNumber
              min={10}
              placeholder="è¾“å…¥è´­ä¹°æ•°é‡"
              style={{ width: '100%' }}
              size="large"
            />
          </Form.Item>
          
          <Form.Item
            label="æ”¯ä»˜ä¿¡æ¯"
            name="paymentInfo"
            rules={[{ required: true, message: 'è¯·è¾“å…¥æ”¯ä»˜ä¿¡æ¯' }]}
          >
            <Input.TextArea
              placeholder="è¾“å…¥æ‚¨çš„æ”¯ä»˜å‡­è¯ä¿¡æ¯"
              rows={3}
            />
          </Form.Item>
          
          <Form.Item
            label="è”ç³»æ–¹å¼"
            name="contactInfo"
            rules={[{ required: true, message: 'è¯·è¾“å…¥è”ç³»æ–¹å¼' }]}
          >
            <Input
              placeholder="è¾“å…¥æ‚¨çš„è”ç³»æ–¹å¼"
              size="large"
            />
          </Form.Item>
          
          <Form.Item>
            <Button
              type="primary"
              htmlType="submit"
              loading={loading}
              size="large"
              block
              icon={<RocketOutlined />}
              disabled={quotaInfo.remaining === 0}
            >
              {quotaInfo.remaining > 0 ? 'åˆ›å»ºè®¢å•ï¼ˆå®Œå…¨å…è´¹ï¼‰' : 'å…è´¹æ¬¡æ•°å·²ç”¨å®Œ'}
            </Button>
          </Form.Item>
        </Form>
        
        {/* ä¼˜åŠ¿è¯´æ˜ */}
        <Card type="inner" style={{ background: '#fffbe6' }}>
          <Text strong>ğŸ’¡ å…è´¹æœåŠ¡ä¼˜åŠ¿</Text>
          <div style={{ marginTop: 8 }}>
            <Text>â€¢ âœ… å®Œå…¨å…è´¹ï¼šGas ç”±åšå¸‚å•†æ”¯ä»˜</Text>
            <Text style={{ display: 'block' }}>â€¢ âœ… æ— éœ€å‡†å¤‡ï¼šæ— éœ€æå‰è·å– Gas</Text>
            <Text style={{ display: 'block' }}>â€¢ âœ… ç®€å•å¿«æ·ï¼šä¸€é”®åˆ›å»ºè®¢å•</Text>
            <Text style={{ display: 'block' }}>â€¢ âœ… å…¬å¹³åˆ†é…ï¼šæ¯äºº {quotaInfo.defaultQuota} æ¬¡å…è´¹æœºä¼š</Text>
          </div>
        </Card>
      </Card>
    </div>
  );
};
```

---

### 3.2 åšå¸‚å•†ç®¡ç†é¡µé¢

```typescript
// stardust-dapp/src/features/market-maker/MakerQuotaManagementPage.tsx

import React, { useState, useEffect } from 'react';
import { Card, Form, InputNumber, Button, message, Table, Space, Typography, Statistic, Row, Col } from 'antd';
import { SettingOutlined, GiftOutlined, BarChartOutlined } from '@ant-design/icons';
import { useSubstrateContext } from '../../lib/SubstrateContext';

const { Title, Text } = Typography;

export const MakerQuotaManagementPage: React.FC = () => {
  const { api, currentAccount } = useSubstrateContext();
  const [loading, setLoading] = useState(false);
  const [config, setConfig] = useState({ quota: 3 });
  const [stats, setStats] = useState({ totalCount: 0, totalAmount: '0' });
  
  const makerId = 1;  // å‡è®¾å½“å‰åšå¸‚å•† ID = 1
  
  useEffect(() => {
    if (api && currentAccount) {
      loadData();
    }
  }, [api, currentAccount]);
  
  const loadData = async () => {
    if (!api || !currentAccount) return;
    
    try {
      // 1. æŸ¥è¯¢é…é¢é…ç½®
      const quotaConfig = await api.query.marketMaker.freeOrderQuotaConfig(makerId);
      setConfig({ quota: quotaConfig.toNumber() });
      
      // 2. æŸ¥è¯¢ç»Ÿè®¡æ•°æ®
      const statsData = await api.query.marketMaker.totalFreeOrdersConsumed(makerId);
      const [count, amount] = statsData;
      setStats({
        totalCount: count.toNumber(),
        totalAmount: (amount / 1e18).toFixed(4),
      });
    } catch (error) {
      console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
    }
  };
  
  const handleSetConfig = async (values: { quota: number }) => {
    if (!api || !currentAccount) {
      message.error('è¯·å…ˆè¿æ¥é’±åŒ…');
      return;
    }
    
    setLoading(true);
    
    try {
      const tx = api.tx.marketMaker.setFreeQuotaConfig(makerId, values.quota);
      
      await tx.signAndSend(currentAccount, ({ status }) => {
        if (status.isInBlock) {
          message.success(`é…é¢å·²è®¾ç½®ä¸º ${values.quota} æ¬¡`);
          loadData();
        }
      });
    } catch (error) {
      console.error('è®¾ç½®å¤±è´¥:', error);
      message.error(`è®¾ç½®å¤±è´¥: ${error.message}`);
    } finally {
      setLoading(false);
    }
  };
  
  const handleGrantQuota = async (buyer: string, quota: number) => {
    if (!api || !currentAccount) return;
    
    try {
      const tx = api.tx.marketMaker.grantFreeQuota(makerId, buyer, quota);
      
      await tx.signAndSend(currentAccount, ({ status }) => {
        if (status.isInBlock) {
          message.success(`å·²ä¸º ${buyer} å¢åŠ  ${quota} æ¬¡å…è´¹é…é¢`);
        }
      });
    } catch (error) {
      message.error(`æˆäºˆå¤±è´¥: ${error.message}`);
    }
  };
  
  return (
    <div style={{ maxWidth: 1200, margin: '0 auto', padding: 24 }}>
      <Title level={2}>
        <SettingOutlined /> å…è´¹é…é¢ç®¡ç†
      </Title>
      
      {/* ç»Ÿè®¡å¡ç‰‡ */}
      <Row gutter={16} style={{ marginBottom: 24 }}>
        <Col span={8}>
          <Card>
            <Statistic
              title="é»˜è®¤é…é¢"
              value={config.quota}
              suffix="æ¬¡/äºº"
              prefix={<GiftOutlined />}
            />
          </Card>
        </Col>
        <Col span={8}>
          <Card>
            <Statistic
              title="ç´¯è®¡ä»£ä»˜æ¬¡æ•°"
              value={stats.totalCount}
              suffix="æ¬¡"
              prefix={<BarChartOutlined />}
            />
          </Card>
        </Col>
        <Col span={8}>
          <Card>
            <Statistic
              title="ç´¯è®¡ä»£ä»˜é‡‘é¢"
              value={stats.totalAmount}
              suffix="DUST"
              precision={4}
            />
          </Card>
        </Col>
      </Row>
      
      {/* é…ç½®è¡¨å• */}
      <Card title="é»˜è®¤é…é¢è®¾ç½®" style={{ marginBottom: 24 }}>
        <Form
          initialValues={config}
          onFinish={handleSetConfig}
          layout="inline"
        >
          <Form.Item
            label="æ¯ä¸ªæ–°ä¹°å®¶çš„å…è´¹æ¬¡æ•°"
            name="quota"
            rules={[{ required: true, message: 'è¯·è¾“å…¥é…é¢' }]}
          >
            <InputNumber min={0} max={100} />
          </Form.Item>
          
          <Form.Item>
            <Button type="primary" htmlType="submit" loading={loading}>
              ä¿å­˜è®¾ç½®
            </Button>
          </Form.Item>
        </Form>
        
        <Text type="secondary" style={{ marginTop: 12, display: 'block' }}>
          ğŸ’¡ æç¤ºï¼šè®¾ç½®ä¸º 0 è¡¨ç¤ºä¸æä¾›å…è´¹æœåŠ¡
        </Text>
      </Card>
      
      {/* å•ç‹¬æˆäºˆé…é¢ */}
      <Card title="ä¸ºç‰¹å®šä¹°å®¶å¢åŠ é…é¢">
        <Form
          onFinish={(values) => handleGrantQuota(values.buyer, values.quota)}
          layout="inline"
        >
          <Form.Item
            label="ä¹°å®¶åœ°å€"
            name="buyer"
            rules={[{ required: true, message: 'è¯·è¾“å…¥ä¹°å®¶åœ°å€' }]}
          >
            <Input placeholder="0x..." style={{ width: 400 }} />
          </Form.Item>
          
          <Form.Item
            label="å¢åŠ æ¬¡æ•°"
            name="quota"
            rules={[{ required: true, message: 'è¯·è¾“å…¥æ¬¡æ•°' }]}
          >
            <InputNumber min={1} max={100} />
          </Form.Item>
          
          <Form.Item>
            <Button type="primary" htmlType="submit" icon={<GiftOutlined />}>
              æˆäºˆé…é¢
            </Button>
          </Form.Item>
        </Form>
      </Card>
    </div>
  );
};
```

---

## å››ã€æµ‹è¯•æ–¹æ¡ˆ

### 4.1 å•å…ƒæµ‹è¯•

```rust
// pallets/market-maker/src/tests.rs

#[test]
fn test_set_free_quota_config() {
    new_test_ext().execute_with(|| {
        let maker = 1;
        let maker_account = account(1);
        
        // è®¾ç½®é…é¢ä¸º 5
        assert_ok!(MarketMaker::set_free_quota_config(
            Origin::signed(maker_account),
            maker,
            5
        ));
        
        // éªŒè¯é…ç½®
        assert_eq!(FreeOrderQuotaConfig::<Test>::get(maker), 5);
    });
}

#[test]
fn test_consume_free_quota() {
    new_test_ext().execute_with(|| {
        let maker = 1;
        let buyer = account(2);
        
        // è®¾ç½®é»˜è®¤é…é¢ä¸º 3
        FreeOrderQuotaConfig::<Test>::insert(maker, 3);
        
        // ç¬¬ä¸€æ¬¡æ¶ˆè´¹ï¼ˆåˆå§‹åŒ–ï¼‰
        assert_eq!(MarketMaker::consume_free_quota(maker, &buyer).unwrap(), true);
        assert_eq!(FreeOrderQuota::<Test>::get(maker, &buyer), 2);
        
        // ç¬¬äºŒæ¬¡æ¶ˆè´¹
        assert_eq!(MarketMaker::consume_free_quota(maker, &buyer).unwrap(), true);
        assert_eq!(FreeOrderQuota::<Test>::get(maker, &buyer), 1);
        
        // ç¬¬ä¸‰æ¬¡æ¶ˆè´¹
        assert_eq!(MarketMaker::consume_free_quota(maker, &buyer).unwrap(), true);
        assert_eq!(FreeOrderQuota::<Test>::get(maker, &buyer), 0);
        
        // ç¬¬å››æ¬¡æ¶ˆè´¹ï¼ˆé…é¢ç”¨å®Œï¼‰
        assert_eq!(MarketMaker::consume_free_quota(maker, &buyer).unwrap(), false);
    });
}

#[test]
fn test_grant_free_quota() {
    new_test_ext().execute_with(|| {
        let maker = 1;
        let maker_account = account(1);
        let buyer = account(2);
        
        // åˆå§‹åŒ–é…é¢ä¸º 0ï¼ˆå·²ç”¨å®Œï¼‰
        FreeOrderQuota::<Test>::insert(maker, &buyer, 0);
        
        // æˆäºˆ 5 æ¬¡é¢å¤–é…é¢
        assert_ok!(MarketMaker::grant_free_quota(
            Origin::signed(maker_account),
            maker,
            buyer,
            5
        ));
        
        // éªŒè¯é…é¢
        assert_eq!(FreeOrderQuota::<Test>::get(maker, &buyer), 5);
    });
}
```

---

## äº”ã€æ€»ç»“

### âœ… å®Œæ•´å®æ–½æ–¹æ¡ˆå·²è®¾è®¡å®Œæˆ

| é¡¹ç›® | çŠ¶æ€ |
|------|------|
| **Market Maker Pallet** | âœ… å®Œæˆ |
| **OTC Order Pallet** | âœ… å®Œæˆ |
| **å‰ç«¯é›†æˆ** | âœ… å®Œæˆ |
| **æµ‹è¯•æ–¹æ¡ˆ** | âœ… å®Œæˆ |
| **æ–‡æ¡£è¯´æ˜** | âœ… å®Œæˆ |

---

### ğŸš€ å®æ–½æ­¥éª¤

1. **ä¿®æ”¹ Market Maker Pallet**ï¼ˆçº¦ 2 å°æ—¶ï¼‰
   - æ·»åŠ å­˜å‚¨ç»“æ„
   - å®ç°é…é¢ç®¡ç†å‡½æ•°
   - æ·»åŠ äº‹ä»¶å’Œé”™è¯¯

2. **ä¿®æ”¹ OTC Order Pallet**ï¼ˆçº¦ 1 å°æ—¶ï¼‰
   - é›†æˆå…è´¹é…é¢æ£€æŸ¥
   - ä¿®æ”¹ `create_order_free` å‡½æ•°

3. **å‰ç«¯å¼€å‘**ï¼ˆçº¦ 3 å°æ—¶ï¼‰
   - ä¹°å®¶åˆ›å»ºè®¢å•é¡µé¢
   - åšå¸‚å•†ç®¡ç†é¡µé¢
   - é…é¢æ˜¾ç¤ºå’ŒæŸ¥è¯¢

4. **æµ‹è¯•**ï¼ˆçº¦ 2 å°æ—¶ï¼‰
   - å•å…ƒæµ‹è¯•
   - é›†æˆæµ‹è¯•
   - å‰ç«¯æµ‹è¯•

**æ€»è®¡ï¼šçº¦ 8 å°æ—¶**

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-22  
**æ ¸å¿ƒç»“è®º**: âœ… **å›ºå®šå…è´¹æ¬¡æ•°æ–¹æ¡ˆè®¾è®¡å®Œæˆï¼Œç«‹å³å¯å®æ–½**  
**å…³é”®ç‰¹ç‚¹**: ç®€å•ã€å¯æ§ã€å…¬å¹³ã€æ˜“äºç†è§£å’Œä½¿ç”¨

