# 委员会提案流程 - 实现说明

## 概述

本文档说明委员会提案流程的技术实现、页面组件、使用方法和代码位置。

## 需求背景

**问题**：委员会成员没有权限直接批准/驳回做市商申请  
**原因**：`marketMaker.approve` 和 `marketMaker.reject` 需要 `GovernanceOrigin` 权限（Root 或 委员会 2/3 多数）  
**解决方案**：实现委员会提案流程，通过集体投票完成批准/驳回操作

## 实现方案

### 1. 链端配置

**文件**: `pallets/market-maker/src/lib.rs`

```rust
// GovernanceOrigin 类型，用于批准/驳回
type GovernanceOrigin: EnsureOrigin<Self::RuntimeOrigin>;

// approve 和 reject 使用 GovernanceOrigin
pub fn approve(origin: OriginFor<T>, mm_id: u64) -> DispatchResult {
    T::GovernanceOrigin::ensure_origin(origin)?;
    // ...
}

pub fn reject(origin: OriginFor<T>, mm_id: u64, slash_bps: u16) -> DispatchResult {
    T::GovernanceOrigin::ensure_origin(origin)?;
    // ...
}
```

**Runtime 配置**: `runtime/src/configs/mod.rs`

```rust
impl pallet_market_maker::Config for Runtime {
    // ...
    type GovernanceOrigin = EitherOfDiverse<
        EnsureRoot<AccountId>,
        pallet_collective::EnsureProportionAtLeast<AccountId, CouncilCollective, 2, 3>
    >;
}
```

**说明**：
- `EnsureRoot`: Sudo 账户可直接批准（紧急通道）
- `EnsureProportionAtLeast<2, 3>`: 委员会 2/3 多数通过（推荐方式）

### 2. 前端实现

#### 页面结构

```
memopark-dapp/src/features/
├── governance/
│   ├── CouncilProposalPage.tsx          # 主页面
│   └── components/
│       ├── CreateProposalForm.tsx       # 提交提案表单
│       ├── ProposalList.tsx             # 提案列表（投票+执行）
│       └── MyVotes.tsx                  # 我的投票记录
└── otc/
    └── GovMarketMakerReviewPage.tsx     # 做市商审核页面
```

#### 主页面：CouncilProposalPage.tsx

**路径**: `#/gov/council-proposals`

**功能**：
- 三个标签页：提案列表、提交提案、我的投票
- 移动端优先设计（最大宽度 640px）
- 组件化架构，易于扩展

**代码位置**: `memopark-dapp/src/features/governance/CouncilProposalPage.tsx`

```typescript
export default function CouncilProposalPage() {
  const [activeTab, setActiveTab] = React.useState<string>('list')
  
  const items = [
    { key: 'list', label: '提案列表', children: <ProposalList /> },
    { key: 'create', label: '提交提案', children: <CreateProposalForm /> },
    { key: 'votes', label: '我的投票', children: <MyVotes /> }
  ]
  
  return <Tabs activeKey={activeTab} onChange={setActiveTab} items={items} />
}
```

#### 组件 1：CreateProposalForm.tsx

**功能**：
- 自动加载待审核申请列表（`PendingReview` 状态）
- 支持批准和驳回两种提案类型
- 自动计算提案参数（threshold, length）
- 提交后显示提案哈希

**核心代码**：
```typescript
const handleSubmit = async (values: any) => {
  const api = await getApi()
  const { mmId, slashBps, threshold } = values
  
  // 构造内部调用
  let innerCall
  if (proposalType === 'approve') {
    innerCall = api.tx.marketMaker.approve(mmId)
  } else {
    innerCall = api.tx.marketMaker.reject(mmId, slashBps || 0)
  }
  
  // 提交提案
  await signAndSendLocalFromKeystore(
    'council',
    'propose',
    [threshold, innerCall, innerCall.length]
  )
  
  // 显示提案哈希
  const proposalHash = innerCall.method.hash.toHex()
  Modal.info({ content: proposalHash })
}
```

**说明**：
- `council.propose(threshold, call, length)` 创建提案
- `innerCall` 是实际要执行的调用（approve 或 reject）
- `proposalHash` 用于后续投票和执行

#### 组件 2：ProposalList.tsx

**功能**：
- 查询所有活跃提案（`council.proposals()`）
- 显示投票进度（赞成/反对/阈值）
- 支持投票操作（赞成/反对）
- 支持执行已达阈值的提案
- 显示当前用户投票状态

**核心代码**：
```typescript
// 加载提案列表
const loadProposals = async () => {
  const proposalHashes = await api.query.council.proposals()
  
  for (const hash of proposalHashes) {
    const voting = await api.query.council.voting(hash)
    const proposal = await api.query.council.proposalOf(hash)
    
    proposalList.push({
      hash: hash.toHex(),
      threshold: voting.threshold,
      ayes: voting.ayes,
      nays: voting.nays,
      call: {
        section: proposal.section,
        method: proposal.method,
        args: proposal.args
      }
    })
  }
}

// 投票
const handleVote = async (proposal, approve) => {
  await signAndSendLocalFromKeystore(
    'council',
    'vote',
    [proposal.hash, proposal.index, approve]
  )
}

// 执行提案
const handleExecute = async (proposal) => {
  await signAndSendLocalFromKeystore(
    'council',
    'close',
    [proposal.hash, proposal.index, weightBound, lengthBound]
  )
}
```

**UI 特性**：
- 进度条显示投票进度
- 已达阈值显示"可执行"标签
- 当前用户已投票显示"已投赞成/反对"标签
- 支持查看提案详情（弹窗）

#### 组件 3：MyVotes.tsx

**功能**：
- 显示当前用户所有投票记录
- 统计赞成/反对票数
- 显示每个提案的当前状态

**核心代码**：
```typescript
const loadMyVotes = async () => {
  const api = await getApi()
  const currentUser = getCurrentAddress()
  const proposalHashes = await api.query.council.proposals()
  
  const votes = []
  for (const hash of proposalHashes) {
    const voting = await api.query.council.voting(hash)
    
    const votedAye = voting.ayes.includes(currentUser)
    const votedNay = voting.nays.includes(currentUser)
    
    if (votedAye || votedNay) {
      votes.push({ votedAye, votedNay, ... })
    }
  }
  
  setMyVotes(votes)
}
```

#### 做市商审核页面：GovMarketMakerReviewPage.tsx

**路径**: `#/gov/mm-review`

**功能**：
- 显示待审核申请列表
- 显示已批准做市商列表
- 链接到委员会提案管理页面
- 提示治理流程

**关键改进**：
```typescript
<Alert 
  type="info" 
  message="治理说明" 
  description={
    <div>
      <p>批准/驳回需要通过<strong>委员会 2/3 多数投票</strong>或 <strong>Root 直接调用</strong>。</p>
      <p>
        委员会成员请使用 
        <a href="#/gov/council-proposals">委员会提案管理</a> 
        提交提案和投票。
      </p>
    </div>
  }
/>
```

## 使用流程

### 流程图

```
申请人                委员会                   链上
  |                      |                       |
  |--lock_deposit------->|                       |
  |                      |                       |
  |--submit_info-------->|                       |
  |                      |                       |
  |                      |--1.提交提案---------->|
  |                      |   (propose)           |
  |                      |                       |
  |                      |<-----提案哈希---------|
  |                      |                       |
  |                      |--2.成员投票---------->|
  |                      |   (vote)              |
  |                      |                       |
  |                      |--3.执行提案---------->|
  |                      |   (close)             |
  |                      |                       |
  |                      |                       |--approve/reject-->
  |                      |                       |
  |<-----状态更新--------|<----------------------|
  |    (Active/Rejected) |                       |
```

### 详细步骤

#### 1. 提交提案

**操作者**：任一委员会成员

**步骤**：
1. 访问 `#/gov/council-proposals`
2. 切换到"提交提案"标签
3. 选择提案类型（批准/驳回）
4. 选择申请编号
5. 设置投票阈值（推荐：2）
6. 提交并获取提案哈希

**链上调用**：
```rust
council.propose(
    threshold: 2,                      // 投票阈值
    proposal: marketMaker.approve(5),  // 内部调用
    length: 47                         // 调用长度（自动计算）
)
```

**结果**：
- 提案进入活跃列表
- 提案索引（index）自动递增
- 提案哈希可用于投票

#### 2. 成员投票

**操作者**：其他委员会成员

**步骤**：
1. 访问 `#/gov/council-proposals`
2. 在"提案列表"找到提案
3. 查看提案详情（调用内容、进度）
4. 点击"赞成"或"反对"
5. 确认投票

**链上调用**：
```rust
council.vote(
    proposal_hash: 0xabcd..., // 提案哈希
    index: 0,                 // 提案索引
    approve: true             // true=赞成, false=反对
)
```

**结果**：
- 投票记录更新
- 进度条更新（1/2 → 2/2）
- 达到阈值后显示"可执行"标签

#### 3. 执行提案

**操作者**：任何人（提案已达阈值）

**步骤**：
1. 访问 `#/gov/council-proposals`
2. 找到已达阈值的提案（显示"可执行"）
3. 点击"执行提案"
4. 确认执行

**链上调用**：
```rust
council.close(
    proposal_hash: 0xabcd...,
    index: 0,
    proposal_weight_bound: { refTime: 1_000_000_000, proofSize: 1000 },
    length_bound: 1000
)
```

**链上自动执行**：
```rust
// council.close 内部会：
// 1. 检查投票是否达到阈值
// 2. 如果达到，调用 marketMaker.approve(5)
// 3. 更新申请状态为 Active
// 4. 发出 Approved 事件
```

**结果**：
- 做市商申请状态变为 `Active` 或 `Rejected`
- 提案从活跃列表移除
- 可在 `#/gov/mm-review` 查看结果

## 技术特性

### 1. 全局链上直连

**特点**：
- 不依赖 Subsquid 索引器
- 直接从链上查询数据
- 实时获取最新状态

**数据查询**：
```typescript
// 查询提案列表
const proposalHashes = await api.query.council.proposals()

// 查询投票详情
const voting = await api.query.council.voting(hash)

// 查询提案内容
const proposal = await api.query.council.proposalOf(hash)

// 查询待审申请
for (let id = 0; id < maxId; id++) {
  const app = await api.query.marketMaker.applications(id)
  if (app.status === 'PendingReview') {
    pendingList.push(app)
  }
}
```

### 2. 本地钱包签名

**特点**：
- 不使用浏览器扩展（Polkadot.js 扩展）
- 使用 Keystore 本地钱包
- 支持密码加密

**签名函数**：
```typescript
import { signAndSendLocalFromKeystore } from '../../lib/polkadot-safe'

// 使用 Keystore 钱包签名
await signAndSendLocalFromKeystore(
  'council',    // pallet 名称
  'propose',    // 方法名称
  [threshold, innerCall, length]  // 参数
)
```

### 3. 移动端优先设计

**布局**：
- 最大宽度：640px
- 自动居中
- 响应式卡片布局

**组件**：
- Ant Design 5
- Typography, Card, List, Button, Space
- 按钮使用 `block` 布局

**示例**：
```typescript
<div style={{ maxWidth: 640, margin: '0 auto', padding: '16px' }}>
  <Card>
    <Typography.Title level={4}>委员会提案管理</Typography.Title>
    <Tabs items={items} />
  </Card>
</div>
```

### 4. 组件化设计

**优点**：
- 职责分离，易于维护
- 可复用组件
- 独立测试

**组件职责**：
- `CouncilProposalPage`: 页面容器，管理标签切换
- `CreateProposalForm`: 提案创建逻辑
- `ProposalList`: 提案展示和操作
- `MyVotes`: 个人投票记录

### 5. 错误处理

**用户友好提示**：
```typescript
try {
  await signAndSendLocalFromKeystore(...)
  message.success('操作成功！')
} catch (e: any) {
  message.error('操作失败：' + (e?.message || ''))
}
```

**权限检查**：
```typescript
// 前端提示
<Alert 
  type="warning" 
  message="仅限委员会成员"
  description="提交提案需要您是委员会成员。非委员会成员提交会失败（BadOrigin）。"
/>

// 链端检查
T::GovernanceOrigin::ensure_origin(origin)?
```

## 路由配置

**文件**: `memopark-dapp/src/App.tsx`

```typescript
import CouncilProposalPage from './features/governance/CouncilProposalPage'
import GovMarketMakerReviewPage from './features/otc/GovMarketMakerReviewPage'

const App = () => {
  const hash = window.location.hash
  
  return (
    <>
      {hash === '#/gov/council-proposals' ? <CouncilProposalPage />
      : hash === '#/gov/mm-review' ? <GovMarketMakerReviewPage />
      : <AuthEntryPage />}
    </>
  )
}
```

## 导航入口

### 1. 个人资料页

**文件**: `memopark-dapp/src/features/profile/ProfilePage.tsx`

```typescript
<Card size="small" title="做市商与OTC交易">
  <Space direction="vertical" style={{ width: '100%' }}>
    <Button onClick={() => { window.location.hash = '#/otc/mm-apply' }}>
      申请做市商
    </Button>
    <Button onClick={() => { window.location.hash = '#/gov/mm-review' }}>
      审核做市商
    </Button>
    <Button onClick={() => { window.location.hash = '#/gov/council-proposals' }}>
      委员会提案
    </Button>
  </Space>
</Card>
```

### 2. 做市商审核页

**文件**: `memopark-dapp/src/features/otc/GovMarketMakerReviewPage.tsx`

```typescript
<Alert 
  description={
    <p>
      委员会成员请使用 
      <a href="#/gov/council-proposals">委员会提案管理</a> 
      提交提案和投票。
    </p>
  }
/>
```

## 配置委员会成员

### 使用 Sudo 设置成员

```typescript
const api = await getApi()

// 设置委员会成员
await api.tx.sudo.sudo(
  api.tx.council.setMembers(
    [
      'member1_address',
      'member2_address',
      'member3_address'
    ],
    null,  // prime member (可选)
    0      // old count
  )
).signAndSend(sudoAccount)
```

### 查询当前成员

```typescript
const members = await api.query.council.members()
console.log('委员会成员:', members.toJSON())
```

## 测试流程

### 1. 准备工作

```bash
# 启动链节点
./start-node.sh

# 启动前端
cd memopark-dapp
npm run dev
```

### 2. 配置委员会

```typescript
// 使用 Sudo 账户设置 3 个委员会成员
// Alice, Bob, Charlie
```

### 3. 创建测试申请

```typescript
// 使用任意账户申请做市商
#/otc/mm-apply
→ 质押押金
→ 提交资料
→ 申请进入 PendingReview 状态
```

### 4. 测试提案流程

```typescript
// Alice 提交提案
#/gov/council-proposals → 提交提案
→ 批准做市商 #0
→ 阈值: 2

// Bob 投赞成票
#/gov/council-proposals → 提案列表
→ 提案 #0 → 赞成

// Charlie 投赞成票
#/gov/council-proposals → 提案列表
→ 提案 #0 → 赞成

// 任何人执行
#/gov/council-proposals → 提案列表
→ 提案 #0 → 执行提案

// 验证结果
#/gov/mm-review → 已审核
→ 做市商 #0 状态为 Active
```

## 常见问题排查

### 1. BadOrigin 错误

**原因**：当前账户不是委员会成员

**排查**：
```typescript
const members = await api.query.council.members()
const currentUser = getCurrentAddress()
console.log('委员会成员:', members.toJSON())
console.log('当前用户:', currentUser)
console.log('是否是成员:', members.includes(currentUser))
```

**解决**：使用 Sudo 账户添加用户到委员会

### 2. 提案列表为空

**原因**：没有活跃提案

**排查**：
```typescript
const proposals = await api.query.council.proposals()
console.log('提案数量:', proposals.length)
```

**解决**：提交新提案或等待其他成员提交

### 3. 投票后未更新

**原因**：交易需要等待区块确认

**解决**：等待 6 秒后点击"刷新提案列表"

### 4. 执行提案失败

**原因**：
- 未达到投票阈值
- weight/length bound 不足

**排查**：
```typescript
const voting = await api.query.council.voting(hash)
console.log('赞成票:', voting.ayes.length)
console.log('阈值:', voting.threshold)
console.log('是否达到:', voting.ayes.length >= voting.threshold)
```

**解决**：
- 等待更多成员投票
- 增加 weight_bound

## 后续优化

### 1. 通知系统
- 新提案提醒
- 投票达到阈值提醒
- 提案执行结果通知

### 2. 批量操作
- 批量批准多个申请
- 一次性对多个提案投票

### 3. 历史记录
- 已执行提案列表
- 委员会投票统计
- 做市商审批历史

### 4. 集成 Subsquid
- 索引提案数据
- 高级搜索和筛选
- 实时事件推送

## 文件清单

### 前端文件

```
memopark-dapp/src/
├── features/
│   ├── governance/
│   │   ├── CouncilProposalPage.tsx           # 主页面
│   │   └── components/
│   │       ├── CreateProposalForm.tsx        # 提交提案
│   │       ├── ProposalList.tsx              # 提案列表
│   │       └── MyVotes.tsx                   # 我的投票
│   └── otc/
│       └── GovMarketMakerReviewPage.tsx      # 做市商审核
├── lib/
│   ├── polkadot.ts                           # API 初始化
│   ├── polkadot-safe.ts                      # 签名函数
│   └── keystore.ts                           # Keystore 管理
└── App.tsx                                   # 路由配置
```

### 链端文件

```
pallets/
├── market-maker/
│   ├── src/lib.rs                            # Pallet 实现
│   └── README.md                             # 文档
├── collective/
│   └── src/lib.rs                            # 委员会 Pallet
└── runtime/
    └── src/configs/mod.rs                    # Runtime 配置
```

### 文档文件

```
docs/
├── 委员会提案使用指南.md                    # 完整使用指南
├── 委员会提案快速开始.md                    # 快速开始
└── 委员会提案实现说明.md                    # 本文档（技术实现）
```

## 总结

✅ **已实现功能**：
- 委员会提案管理页面（提交、投票、执行）
- 做市商审核页面（待审、已批准列表）
- 我的投票记录
- 全局链上直连
- 本地钱包签名
- 移动端优先设计
- 组件化架构

✅ **技术特性**：
- React 18 + TypeScript
- Ant Design 5
- Polkadot.js API
- 本地 Keystore 钱包
- 无浏览器扩展依赖

✅ **文档完善**：
- 使用指南（完整版）
- 快速开始指南
- 技术实现说明

📌 **下一步**：
- 测试完整流程
- 收集用户反馈
- 添加通知系统
- 优化查询性能

---

**创建日期**: 2025-10-02  
**版本**: v1.0.0  
**状态**: ✅ 已完成

