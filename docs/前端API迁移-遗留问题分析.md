# âš ï¸ å‰ç«¯APIè¿ç§» - é—ç•™é—®é¢˜åˆ†æ

**ğŸ“… æ—¥æœŸ**: 2025-10-29  
**ğŸ”´ ä¼˜å…ˆçº§**: é«˜  
**ğŸ“Š çŠ¶æ€**: å¾…ç”¨æˆ·å†³ç­–

---

## ğŸš¨ æ ¸å¿ƒé—®é¢˜

### è¿ç§»æ‰§è¡Œç»“æœ

æ‰§è¡Œè‡ªåŠ¨åŒ–è¿ç§»è„šæœ¬åï¼š
- âœ… å·²æˆåŠŸè¿ç§»: 73å¤„APIå¼•ç”¨ä¸­çš„ **72å¤„**
- âš ï¸ æ®‹ç•™æœªè¿ç§»: **1å¤„**

### æ®‹ç•™çš„APIå¼•ç”¨

**æ–‡ä»¶**: `stardust-dapp/src/services/freeQuotaService.ts:363`

```typescript
const tx = api.tx.otcOrder.openOrderFree(
  makerId,
  qtyWithDecimals.toString(),
  paymentCommit,
  contactCommit
);
```

---

## ğŸ” é—®é¢˜æ ¹æºåˆ†æ

### é“¾ç«¯ç°çŠ¶

#### 1. `pallet-otc-order` çŠ¶æ€
- âœ… æœ‰ `open_order_free()` å‡½æ•°å®ç°
- âŒ å·²ä» Runtime ä¸­ç§»é™¤
- âŒ è®¡åˆ’åˆ é™¤

#### 2. `pallet-trading` çŠ¶æ€
- âš ï¸ README å£°ç§°æ”¯æŒ"é¦–è´­è®¢å•æ”¯æŒ"
- âŒ **å®é™…æœªå®ç°** `open_order_free()` æˆ–ç±»ä¼¼å‡½æ•°
- âš ï¸ `create_order()` æœ‰ TODO æ³¨é‡Šï¼š`is_first_purchase: false,  // TODO: å®ç°é¦–è´­æ£€æµ‹é€»è¾‘`

**æºç è¯æ®** (`pallets/trading/src/otc.rs:180`):
```rust
// ğŸ†• å‘å°„ä¼˜åŒ–åçš„è®¢å•åˆ›å»ºäº‹ä»¶ï¼ˆåŒ…å«é¦–è´­æ ‡å¿—ï¼‰
Pallet::<T>::deposit_event(Event::OrderCreated {
    order_id,
    maker_id,
    buyer: buyer.clone(),
    dust_amount,
    is_first_purchase: false,  // TODO: å®ç°é¦–è´­æ£€æµ‹é€»è¾‘
});
```

**å‡½æ•°åˆ—è¡¨å¯¹æ¯”**:

| å‡½æ•°å | pallet-otc-order | pallet-trading | å¤‡æ³¨ |
|--------|------------------|----------------|------|
| `open_order_free` | âœ… å·²å®ç° | âŒ ä¸å­˜åœ¨ | å…è´¹é¦–è´­è®¢å• |
| `create_order` | âœ… å·²å®ç° | âš ï¸ TODOä¸­ | æ™®é€šè®¢å• |
| `create_first_purchase` | âŒ ä¸å­˜åœ¨ | âš ï¸ ä»…æ³¨é‡Š | è®¡åˆ’ä¸­çš„åŠŸèƒ½ |

---

## ğŸ’¼ ä¸šåŠ¡å½±å“åˆ†æ

### å—å½±å“çš„å‰ç«¯åŠŸèƒ½

#### 1. æ ¸å¿ƒæ–‡ä»¶
- `src/services/freeQuotaService.ts` - å…è´¹é…é¢æœåŠ¡
- `src/features/otc/CreateFreeOrderPage.tsx` - åˆ›å»ºå…è´¹è®¢å•é¡µé¢
- `src/features/otc/ClaimMemoForm.tsx` - é¢†å–å…è´¹DUSTè¡¨å•

#### 2. ä¸šåŠ¡æµç¨‹
```
ç”¨æˆ·é¦–è´­ â†’ åˆ›å»ºå…è´¹è®¢å•(openOrderFree) â†’ é¢†å–å…è´¹DUST
```

å¦‚æœè¿™ä¸ªåŠŸèƒ½è¢«ç§»é™¤ï¼Œå°†å½±å“ï¼š
- âŒ æ–°ç”¨æˆ·é¦–è´­ä½“éªŒ
- âŒ å…è´¹é…é¢é¢†å–åŠŸèƒ½
- âš ï¸ å¯èƒ½å½±å“ç”¨æˆ·å¢é•¿ç­–ç•¥

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆå¯¹æ¯”

### æ–¹æ¡ˆ1ï¼šç­‰å¾…é“¾ç«¯å®ç°ï¼ˆæ¨èï¼‰â­

**æ“ä½œ**ï¼š
```typescript
// ä¸´æ—¶ç¦ç”¨å…è´¹è®¢å•åˆ›å»ºåŠŸèƒ½
export async function createFreeOrder(...) {
  throw new Error('å…è´¹è®¢å•åŠŸèƒ½æ­£åœ¨å‡çº§ä¸­ï¼Œè¯·ç¨åå†è¯•æˆ–ä½¿ç”¨æ™®é€šè®¢å•');
  
  // âŒ æš‚æ—¶æ³¨é‡Šæ‰åŸæœ‰é€»è¾‘
  // const tx = api.tx.otcOrder.openOrderFree(...);
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… ä¸ä¼šå¼•å…¥æŠ€æœ¯å€º
- âœ… ç­‰å¾…é“¾ç«¯æ­£å¼å®ç°åå†è¿ç§»
- âœ… ä¿æŒå‰åç«¯ä¸€è‡´æ€§

**ç¼ºç‚¹**ï¼š
- âŒ ä¸´æ—¶ç¦ç”¨é¦–è´­å…è´¹åŠŸèƒ½
- âš ï¸ éœ€è¦ç­‰å¾…é“¾ç«¯å¼€å‘

**æ—¶é—´çº¿**ï¼š
- å‰ç«¯ç¦ç”¨: ç«‹å³
- é“¾ç«¯å®ç°: å¾…å®šï¼ˆéœ€ä¸é“¾ç«¯å›¢é˜Ÿç¡®è®¤ï¼‰
- é‡æ–°å¯ç”¨: é“¾ç«¯å®ç°å1-2å¤©

---

### æ–¹æ¡ˆ2ï¼šä½¿ç”¨æ™®é€šè®¢å•æ›¿ä»£

**æ“ä½œ**ï¼š
```typescript
// æ”¹ç”¨æ™®é€š create_order
export async function createFreeOrder(...) {
  // âš ï¸ ä¸´æ—¶æ–¹æ¡ˆï¼šä½¿ç”¨æ™®é€šè®¢å•ï¼Œä½†ä¸ä¼šå…è´¹
  const tx = api.tx.trading.createOrder(
    makerId,
    qtyWithDecimals.toString(),
    paymentCommit,
    contactCommit
  );
  // ...
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… åŠŸèƒ½å¯ç»§ç»­ä½¿ç”¨
- âœ… å‰ç«¯è¿ç§»å®Œæ•´

**ç¼ºç‚¹**ï¼š
- âŒ **å¤±å»å…è´¹åŠŸèƒ½**ï¼ˆç”¨æˆ·éœ€ä»˜è´¹ï¼‰
- âŒ ä¸äº§å“è®¾è®¡ä¸ç¬¦
- âŒ å¯èƒ½å½±å“ç”¨æˆ·ä½“éªŒ

---

### æ–¹æ¡ˆ3ï¼šä¿ç•™æ—§çš„ pallet-otc-order

**æ“ä½œ**ï¼š
- ä¸è¿ç§»è¿™ä¸ªåŠŸèƒ½
- ä¿ç•™ `pallet-otc-order` åœ¨ Runtime ä¸­

**ä¼˜ç‚¹**ï¼š
- âœ… å…è´¹åŠŸèƒ½æ­£å¸¸è¿è¡Œ
- âœ… æ— éœ€ç­‰å¾…é“¾ç«¯å¼€å‘

**ç¼ºç‚¹**ï¼š
- âŒ **æ— æ³•åˆ é™¤ pallet-otc-order**
- âŒ è¿èƒŒæ¶æ„æ•´åˆç›®æ ‡
- âŒ ç»´æŠ¤ä¸¤å¥—ä»£ç 

---

### æ–¹æ¡ˆ4ï¼šå‰ç«¯å®ç°é¦–è´­æ£€æµ‹é€»è¾‘

**æ“ä½œ**ï¼š
```typescript
// å‰ç«¯æ£€æµ‹æ˜¯å¦é¦–è´­ç”¨æˆ·
const isFirstPurchase = await checkIsFirstPurchase(api, buyer);

if (isFirstPurchase) {
  // ä½¿ç”¨å…è´¹é…é¢æ± ç›´æ¥è½¬è´¦ï¼ˆéœ€é“¾ç«¯æ”¯æŒï¼‰
  const tx = api.tx.balances.transfer(buyer, freeAmount);
} else {
  // æ™®é€šè®¢å•
  const tx = api.tx.trading.createOrder(...);
}
```

**ä¼˜ç‚¹**ï¼š
- âœ… å‰ç«¯å¯æ§
- âœ… çµæ´»æ€§é«˜

**ç¼ºç‚¹**ï¼š
- âŒ éœ€è¦é“¾ç«¯æä¾›å…è´¹é…é¢æ± è®¿é—®æ¥å£
- âŒ å®‰å…¨æ€§é£é™©ï¼ˆå¯èƒ½è¢«ç»•è¿‡ï¼‰
- âŒ è¿èƒŒé“¾ç«¯é€»è¾‘åŸåˆ™

---

## ğŸ“‹ æ¨èæ‰§è¡Œæ­¥éª¤

### ç¬¬1æ­¥ï¼šç«‹å³æ‰§è¡Œï¼ˆä»Šå¤©ï¼‰

#### 1.1 ä¸´æ—¶ç¦ç”¨å…è´¹è®¢å•åŠŸèƒ½

ä¿®æ”¹ `freeQuotaService.ts`:

```typescript
export async function createFreeOrder(...) {
  // ğŸš§ ä¸´æ—¶ç¦ç”¨ï¼šç­‰å¾… pallet-trading å®ç° create_first_purchase
  throw new Error(
    'é¦–è´­å…è´¹è®¢å•åŠŸèƒ½æ­£åœ¨å‡çº§ä¸­\n' +
    'é¢„è®¡ä¸Šçº¿æ—¶é—´ï¼šå¾…å®š\n\n' +
    'æš‚æ—¶è¯·ä½¿ç”¨æ™®é€šè®¢å•åˆ›å»ºåŠŸèƒ½\n' +
    'å¦‚æœ‰ç–‘é—®ï¼Œè¯·è”ç³»å®¢æœ'
  );
}
```

#### 1.2 ç¦ç”¨ç›¸å…³é¡µé¢è·¯ç”±

ä¿®æ”¹ `routes.tsx`:

```typescript
// ä¸´æ—¶æ³¨é‡Šæ‰å…è´¹è®¢å•è·¯ç”±
/*
{
  path: '/otc/create-free',
  element: <CreateFreeOrderPage />,
},
*/
```

#### 1.3 éšè—UIå…¥å£

ä¿®æ”¹ç›¸å…³æŒ‰é’®/é“¾æ¥ï¼Œæ·»åŠ ç¦ç”¨æç¤ºã€‚

---

### ç¬¬2æ­¥ï¼šé“¾ç«¯å¼€å‘ï¼ˆä¼˜å…ˆçº§ï¼šé«˜ï¼‰

#### 2.1 éœ€æ±‚ç¡®è®¤

ä¸äº§å“å›¢é˜Ÿç¡®è®¤ï¼š
- [ ] é¦–è´­å…è´¹åŠŸèƒ½æ˜¯å¦ä»æ˜¯æ ¸å¿ƒåŠŸèƒ½ï¼Ÿ
- [ ] å…è´¹é…é¢çš„é¢åº¦æ˜¯å¤šå°‘ï¼Ÿ
- [ ] æ˜¯å¦éœ€è¦é¦–è´­æ£€æµ‹é€»è¾‘ï¼Ÿ

#### 2.2 é“¾ç«¯å®ç°

åœ¨ `pallets/trading/src/otc.rs` ä¸­å®ç°ï¼š

```rust
/// åˆ›å»ºé¦–è´­å…è´¹è®¢å•
pub fn do_create_first_purchase<T: Config>(
    buyer: &T::AccountId,
    maker_id: u64,
    dust_amount: BalanceOf<T>,
    payment_commit: H256,
    contact_commit: H256,
) -> Result<u64, DispatchError> {
    // 1. æ£€æŸ¥æ˜¯å¦é¦–è´­ç”¨æˆ·
    // 2. æ£€æŸ¥å…è´¹é…é¢æ± ä½™é¢
    // 3. ä»å…è´¹é…é¢æ± æ‰£é™¤
    // 4. åˆ›å»ºå…è´¹è®¢å•
    // 5. å‘å°„ OrderCreated äº‹ä»¶ï¼ˆis_first_purchase: trueï¼‰
}
```

åœ¨ `pallets/trading/src/lib.rs` ä¸­æš´éœ²æ¥å£ï¼š

```rust
#[pallet::call]
impl<T: Config> Pallet<T> {
    /// åˆ›å»ºé¦–è´­å…è´¹è®¢å•
    #[pallet::weight(Weight::from_parts(10_000, 0))]
    pub fn create_first_purchase(
        origin: OriginFor<T>,
        maker_id: u64,
        dust_amount: BalanceOf<T>,
        payment_commit: H256,
        contact_commit: H256,
    ) -> DispatchResult {
        let buyer = ensure_signed(origin)?;
        crate::otc::do_create_first_purchase::<T>(
            &buyer, 
            maker_id, 
            dust_amount, 
            payment_commit, 
            contact_commit
        )?;
        Ok(())
    }
}
```

#### 2.3 æµ‹è¯•éªŒè¯

- [ ] å•å…ƒæµ‹è¯•
- [ ] é›†æˆæµ‹è¯•
- [ ] æœ¬åœ°æµ‹è¯•ç½‘éªŒè¯

---

### ç¬¬3æ­¥ï¼šå‰ç«¯è¿ç§»ï¼ˆé“¾ç«¯å®Œæˆåï¼‰

#### 3.1 APIè¿ç§»

```typescript
// âŒ æ—§ä»£ç 
const tx = api.tx.otcOrder.openOrderFree(...);

// âœ… æ–°ä»£ç 
const tx = api.tx.trading.createFirstPurchase(...);
```

#### 3.2 æ¢å¤åŠŸèƒ½

- å–æ¶ˆ `createFreeOrder` å‡½æ•°çš„ç¦ç”¨
- æ¢å¤è·¯ç”±
- æ¢å¤UIå…¥å£

#### 3.3 åŠŸèƒ½æµ‹è¯•

- [ ] é¦–è´­ç”¨æˆ·å¯åˆ›å»ºå…è´¹è®¢å•
- [ ] éé¦–è´­ç”¨æˆ·æç¤ºé”™è¯¯
- [ ] å…è´¹é…é¢æ­£ç¡®æ‰£é™¤

---

## ğŸ”„ æ›¿ä»£ä¸´æ—¶æ–¹æ¡ˆï¼ˆå¦‚éœ€ç«‹å³æ¢å¤åŠŸèƒ½ï¼‰

å¦‚æœä¸šåŠ¡è¦æ±‚**ç«‹å³æ¢å¤**é¦–è´­å…è´¹åŠŸèƒ½ï¼š

### ä¿ç•™ pallet-otc-order çš„æœ€å°åŒ–æ–¹æ¡ˆ

#### 1. Runtime é…ç½®

ä¿ç•™ `pallet-otc-order`ï¼Œä½†**ä»…å¼€æ”¾** `open_order_free` å‡½æ•°ï¼š

```rust
// runtime/src/lib.rs

// ä¿ç•™ otc-orderï¼ˆä»…ç”¨äºå…è´¹è®¢å•ï¼‰
construct_runtime!(
    pub enum Runtime {
        // ... å…¶ä»– pallets
        OtcOrder: pallet_otc_order = 50,  // ä¿ç•™
        Trading: pallet_trading = 60,     // æ–°çš„
    }
);
```

#### 2. å‰ç«¯ä¸å˜

```typescript
// å…è´¹è®¢å•ç»§ç»­ä½¿ç”¨æ—§ pallet
const tx = api.tx.otcOrder.openOrderFree(...);

// æ™®é€šè®¢å•ä½¿ç”¨æ–° pallet
const tx = api.tx.trading.createOrder(...);
```

#### 3. æ–‡æ¡£æ ‡æ³¨

åœ¨ä»£ç ä¸­æ·»åŠ æ˜ç¡®æ³¨é‡Šï¼š

```typescript
/**
 * âš ï¸ ä¸´æ—¶æ–¹æ¡ˆï¼šä½¿ç”¨æ—§çš„ pallet-otc-order.openOrderFree
 * 
 * èƒŒæ™¯ï¼špallet-trading å°šæœªå®ç°é¦–è´­å…è´¹è®¢å•åŠŸèƒ½
 * TODO: ç­‰å¾… pallet-trading å®ç° create_first_purchase åè¿ç§»
 * 
 * @deprecated ç­‰å¾…é“¾ç«¯å®ç°åç§»é™¤
 */
const tx = api.tx.otcOrder.openOrderFree(...);
```

**ç¼ºç‚¹**ï¼š
- æ— æ³•å®Œå…¨åˆ é™¤ `pallet-otc-order`
- éœ€è¦ç»´æŠ¤ä¸¤å¥—ä»£ç 
- è¿èƒŒæ¶æ„æ•´åˆç›®æ ‡

---

## ğŸ“Š å†³ç­–çŸ©é˜µ

| æ–¹æ¡ˆ | æŠ€æœ¯å€º | ç”¨æˆ·å½±å“ | å¼€å‘å·¥ä½œé‡ | ä¸Šçº¿æ—¶é—´ | æ¨èåº¦ |
|------|--------|---------|-----------|---------|--------|
| **æ–¹æ¡ˆ1: ç­‰å¾…å®ç°** | â­â­â­â­â­ æ—  | âš ï¸ åŠŸèƒ½ä¸´æ—¶ç¦ç”¨ | ä½ | å¾…å®š | â­â­â­â­â­ |
| æ–¹æ¡ˆ2: æ™®é€šè®¢å•æ›¿ä»£ | âš ï¸ ä¸­ç­‰ | âŒ å¤±å»å…è´¹åŠŸèƒ½ | ä½ | ç«‹å³ | â­â­ |
| æ–¹æ¡ˆ3: ä¿ç•™æ—§pallet | âŒ é«˜ | âœ… æ— å½±å“ | ä½ | ç«‹å³ | â­â­â­ |
| æ–¹æ¡ˆ4: å‰ç«¯æ£€æµ‹ | âŒ å¾ˆé«˜ | âš ï¸ å®‰å…¨é£é™© | é«˜ | 1å‘¨ | â­ |

---

## ğŸ¯ æœ€ç»ˆå»ºè®®

### æ¨èæ–¹æ¡ˆï¼š**æ–¹æ¡ˆ1ï¼ˆç­‰å¾…é“¾ç«¯å®ç°ï¼‰**

**ç†ç”±**ï¼š
1. ä¿æŒæ¶æ„æ•´æ´ï¼Œæ— æŠ€æœ¯å€º
2. ç¬¦åˆé•¿æœŸè§„åˆ’ï¼ˆPhase 2 æ¶æ„æ•´åˆï¼‰
3. ç»™é“¾ç«¯åˆç†çš„å¼€å‘æ—¶é—´

**æ‰§è¡Œæ­¥éª¤**ï¼š
1. âœ… **ç«‹å³**ï¼šç¦ç”¨å‰ç«¯é¦–è´­å…è´¹åŠŸèƒ½ï¼Œæ˜¾ç¤º"å‡çº§ä¸­"æç¤º
2. â³ **æœ¬å‘¨**ï¼šä¸é“¾ç«¯å›¢é˜Ÿç¡®è®¤å¼€å‘æ—¶é—´çº¿
3. â³ **é“¾ç«¯å®Œæˆå**ï¼šå‰ç«¯è¿ç§»ï¼ˆé¢„è®¡1-2å¤©ï¼‰
4. âœ… **ä¸Šçº¿**ï¼šæ¢å¤é¦–è´­å…è´¹åŠŸèƒ½

---

### å¤‡é€‰æ–¹æ¡ˆï¼š**æ–¹æ¡ˆ3ï¼ˆæœ€å°åŒ–ä¿ç•™ï¼‰**

å¦‚æœä¸šåŠ¡å›¢é˜Ÿè¦æ±‚**ç«‹å³æ¢å¤**åŠŸèƒ½ï¼Œå¯ä»¥ï¼š
1. æš‚æ—¶ä¿ç•™ `pallet-otc-order`ï¼ˆä»…ç”¨äºå…è´¹è®¢å•ï¼‰
2. å…¶ä»–åŠŸèƒ½å…¨éƒ¨è¿ç§»åˆ° `pallet-trading`
3. åœ¨é“¾ç«¯å®ç° `create_first_purchase` åå†å®Œå…¨ç§»é™¤

---

## ğŸ“ éœ€è¦å†³ç­–

### å…³é”®é—®é¢˜ï¼ˆè¯·äº§å“/ä¸šåŠ¡å›¢é˜Ÿå›ç­”ï¼‰

1. **é¦–è´­å…è´¹åŠŸèƒ½çš„é‡è¦æ€§**ï¼š
   - æ˜¯å¦æ ¸å¿ƒåŠŸèƒ½ï¼Ÿ
   - æ˜¯å¦å¯ä»¥ä¸´æ—¶ç¦ç”¨1-2å‘¨ï¼Ÿ

2. **å¯æ¥å—çš„æ–¹æ¡ˆ**ï¼š
   - æ–¹æ¡ˆ1ï¼šä¸´æ—¶ç¦ç”¨ï¼Œç­‰å¾…å®ç°
   - æ–¹æ¡ˆ3ï¼šä¿ç•™æ—§ä»£ç ï¼Œç«‹å³æ¢å¤

3. **é“¾ç«¯å¼€å‘æ—¶é—´çº¿**ï¼š
   - é“¾ç«¯å›¢é˜Ÿä½•æ—¶å¯ä»¥å®ç° `create_first_purchase`ï¼Ÿ
   - æ˜¯å¦éœ€è¦è°ƒæ•´ä¼˜å…ˆçº§ï¼Ÿ

---

## ğŸ“… ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### ç­‰å¾…ç”¨æˆ·å†³ç­–

åœ¨ç”¨æˆ·åšå‡ºå†³ç­–å‰ï¼Œå»ºè®®ï¼š
1. âœ… å®Œæˆå…¶ä»–72å¤„APIè¿ç§»çš„æäº¤
2. â¸ï¸ æš‚åœåˆ é™¤ `pallet-otc-order`
3. ğŸ“ åˆ›å»ºè¯¦ç»†çš„é“¾ç«¯éœ€æ±‚æ–‡æ¡£

### ç”¨æˆ·å†³ç­–å

æ ¹æ®ç”¨æˆ·é€‰æ‹©ï¼Œæ‰§è¡Œç›¸åº”æ–¹æ¡ˆçš„æ­¥éª¤ã€‚

---

**ğŸ“… æ–‡æ¡£åˆ›å»ºæ—¶é—´**: 2025-10-29 18:45  
**âœï¸ åˆ›å»ºè€…**: AI Assistant  
**ğŸ”´ ä¼˜å…ˆçº§**: é«˜  
**ğŸ“Š çŠ¶æ€**: å¾…ç”¨æˆ·å†³ç­–  

**ğŸš¨ è¯·ç”¨æˆ·å°½å¿«å†³ç­–ï¼Œä»¥ä¾¿ç»§ç»­åç»­å·¥ä½œï¼**

