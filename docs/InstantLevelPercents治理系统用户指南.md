# InstantLevelPercents 全民投票治理系统 - 用户指南

## 📋 系统概述

本系统实现了对 InstantLevelPercents（即时分成比例）的全民投票治理机制，确保只有通过社区投票才能修改15层联盟推荐分成比例。

### 🎯 核心特性

- **唯一修改通道**：InstantLevelPercents 只能通过治理提案修改，管理员无法直接修改
- **社区投票决策**：提案通过需要社区投票达成共识
- **多重权重计算**：投票权重 = 持币权重（70%）+ 参与权重（20%）+ 贡献权重（10%）
- **信念投票机制**：支持时间锁定换取更高投票权重（1x - 6x）
- **提案分级管理**：微调提案（≤10%变化）和重大提案（>10%变化）采用不同治理流程

---

## 🚀 快速开始

### 访问治理系统

1. **移动端**：
   - 打开 Stardust DApp
   - 导航到"我的钱包"页面（底部导航栏）
   - 点击"联盟治理"菜单项

2. **直接访问**：
   - 治理仪表板：`#/gov/affiliate/dashboard`
   - 创建提案：`#/gov/affiliate/create-proposal`
   - 提案投票：`#/gov/affiliate/vote/{proposal_id}`

---

## 📊 治理参数

### 提案押金
- **微调提案**（变化 ≤10%）：1,000 DUST
- **重大提案**（变化 >10%）：10,000 DUST

### 时间参数
- **提案执行延迟**：43,200 区块（约3天）
- **提案冷却期**：100,800 区块（约7天）
- **失败冷却期**：432,000 区块（约30天）

### 权重计算公式
```
投票权重 = 持币权重 × 70% + 参与权重 × 20% + 贡献权重 × 10%

其中：
- 持币权重 = sqrt(余额/1DUST)，上限1000
- 参与权重 = 历史投票次数
- 贡献权重 = 推荐贡献积分 + 委员会成员加权
```

### 信念投票倍数
| 锁定期间 | 权重倍数 |
|---------|---------|
| 不锁定   | 1.0x    |
| 1周     | 1.5x    |
| 2周     | 2.0x    |
| 4周     | 3.0x    |
| 8周     | 4.0x    |
| 16周    | 5.0x    |
| 32周    | 6.0x    |

---

## 📝 使用流程

### 1. 创建提案

#### 前置条件
- 持有至少 1,000-10,000 DUST（根据提案类型）
- 账户余额足够支付押金和交易费

#### 操作步骤
1. **准备 IPFS 内容**：
   ```bash
   # 上传提案标题到 IPFS
   ipfs add title.txt
   # 上传提案详情到 IPFS
   ipfs add description.md
   # 上传提案理由到 IPFS
   ipfs add rationale.md
   ```

2. **访问创建页面**：
   - 点击治理仪表板的"发起提案"按钮
   - 或直接访问 `#/gov/affiliate/create-proposal`

3. **填写提案信息**：
   - **新分成比例**：输入15层的新比例（总和50%-99%）
   - **标题 CID**：粘贴 IPFS 标题内容的 CID
   - **详情 CID**：粘贴 IPFS 详情内容的 CID
   - **理由 CID**：粘贴 IPFS 理由内容的 CID

4. **验证规则**：
   - 比例总和：50% ≤ 总和 ≤ 99%
   - 前3层不能为0%
   - 前5层应递减
   - 变化幅度决定提案类型

5. **提交提案**：
   - 系统显示押金金额
   - 签名交易完成提案创建

#### 比例配置示例
```typescript
// 当前默认比例（示例）
L1: 30%  L2: 15%  L3: 10%  L4: 8%   L5: 6%
L6: 5%   L7: 4%   L8: 3%   L9: 3%   L10: 2%
L11: 2%  L12: 2%  L13: 2%  L14: 2%  L15: 2%

// 微调提案示例（总变化 ≤10%）
L1: 28%  L2: 16%  L3: 11%  L4: 8%   L5: 6%
L6: 5%   L7: 4%   L8: 3%   L9: 3%   L10: 2%
L11: 2%  L12: 2%  L13: 2%  L14: 2%  L15: 2%
// 变化幅度：|-2|+1|+1| = 4% < 10%（微调提案，1000 DUST 押金）

// 重大提案示例（总变化 >10%）
L1: 35%  L2: 20%  L3: 12%  L4: 8%   L5: 6%
L6: 4%   L7: 3%   L8: 2%   L9: 2%   L10: 2%
L11: 1%  L12: 1%  L13: 1%  L14: 1%  L15: 1%
// 变化幅度：|5|+5|+2|+|-1|+... > 10%（重大提案，10000 DUST 押金）
```

### 2. 参与投票

#### 前置条件
- 拥有钱包账户
- 提案处于投票状态

#### 操作步骤
1. **查看提案列表**：
   - 访问治理仪表板 `#/gov/affiliate/dashboard`
   - 查看"投票中"标签页

2. **进入投票页面**：
   - 点击提案卡片的"立即投票"按钮
   - 或点击"查看详情"后点击投票

3. **选择投票选项**：
   - **支持（Aye）**：赞成提案
   - **反对（Nay）**：反对提案
   - **弃权（Abstain）**：不表态

4. **选择信念投票**：
   - 评估锁定期间和权重倍数
   - 选择合适的锁定时长

5. **提交投票**：
   - 系统显示您的投票权重预览
   - 签名交易完成投票

#### 投票权重计算示例
```typescript
// 假设用户数据
余额: 10,000 DUST
历史投票次数: 15次
推荐贡献积分: 50分
委员会成员: false

// 权重计算
持币权重 = sqrt(10000) = 100 (上限1000)
参与权重 = 15
贡献权重 = 50 + 0 = 50

基础投票权重 = 100 × 0.7 + 15 × 0.2 + 50 × 0.1 = 70 + 3 + 5 = 78

// 信念投票加权
选择锁定4周(3x): 最终投票权重 = 78 × 3 = 234
```

### 3. 查看提案状态

#### 提案生命周期
1. **Discussion（讨论中）**：提案刚创建，社区讨论期
2. **Voting（投票中）**：正在进行社区投票
3. **Approved（已通过）**：投票通过，等待执行
4. **Executed（已执行）**：新比例已生效
5. **Rejected（已拒绝）**：投票未通过
6. **Cancelled（已取消）**：提案人取消

#### 查看提案详情
- **基本信息**：提案人、创建时间、类型
- **新比例预览**：15层分成比例对比
- **投票进度**：实时支持率、反对率统计
- **投票记录**：参与用户和投票权重

---

## ⚠️ 重要注意事项

### 安全提醒
1. **唯一修改通道**：本系统是修改 InstantLevelPercents 的唯一合法途径
2. **押金风险**：提案被拒绝后押金不退还
3. **锁定期限**：信念投票的代币在指定期间内被锁定
4. **不可撤销**：投票提交后无法修改

### 最佳实践
1. **充分讨论**：在社区充分讨论后再提交正式提案
2. **合理比例**：确保新比例符合业务逻辑和社区利益
3. **IPFS 备份**：确保提案内容的 IPFS 文件持久可访问
4. **理性投票**：基于提案质量而非个人偏好投票

### 常见错误
1. **比例总和错误**：确保15层总和在50%-99%之间
2. **递减规则违反**：前5层应当递减
3. **IPFS CID 格式**：确保CID格式正确（Qm... 或 bafy...）
4. **余额不足**：确保有足够余额支付押金和手续费

---

## 🔧 技术参考

### 链端调用
```rust
// 创建提案
affiliate::propose_percentage_adjustment(
    new_percentages: Vec<u8>,  // 15层比例
    title_cid: BoundedVec<u8, ConstU32<64>>,
    description_cid: BoundedVec<u8, ConstU32<64>>,
    rationale_cid: BoundedVec<u8, ConstU32<64>>
)

// 投票
affiliate::vote_on_percentage_proposal(
    proposal_id: u64,
    vote: u8,       // 0=Aye, 1=Nay, 2=Abstain
    conviction: u8  // 0-6 信念投票等级
)
```

### 存储查询
```javascript
// 查询提案
const proposal = await api.query.affiliate.activeProposals(proposalId);

// 查询投票统计
const tally = await api.query.affiliate.voteTally(proposalId);

// 查询投票记录
const vote = await api.query.affiliate.proposalVotes(proposalId, accountId);

// 查询当前比例
const percentages = await api.query.affiliate.instantLevelPercents();
```

### 前端路由
```typescript
// 治理仪表板
window.location.hash = '#/gov/affiliate/dashboard';

// 创建提案
window.location.hash = '#/gov/affiliate/create-proposal';

// 投票页面
window.location.hash = `#/gov/affiliate/vote/${proposalId}`;

// 提案详情
window.location.hash = `#/gov/affiliate/proposal/${proposalId}`;
```

---

## 📞 支持与反馈

### 文档资源
- **架构设计**：`docs/即时分成比例全民投票治理方案.md`
- **实施方案**：`docs/全民投票治理系统-实施方案.md`
- **进度报告**：`docs/全民投票治理系统-实施进度报告.md`

### 技术支持
如遇问题，请检查：
1. 钱包连接状态
2. 账户余额充足
3. 浏览器开发者工具控制台错误
4. 区块链节点连接状态

---

## 📈 更新日志

### v1.0.0 (2025-11-12)
- ✅ 完成链端治理模块开发
- ✅ 完成 Runtime 集成
- ✅ 完成前端治理界面开发
- ✅ 完成路由配置和导航集成
- ✅ 测试验证通过

---

**创建日期**: 2025-11-12
**最后更新**: 2025-11-12
**状态**: 🎉 已完成 - 可投入使用