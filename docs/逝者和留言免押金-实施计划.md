# é€è€…å’Œç•™è¨€å…æŠ¼é‡‘ - å®æ–½è®¡åˆ’

**æ—¥æœŸ**ï¼š2025-11-26
**ç‰ˆæœ¬**ï¼š1.0
**é¢„è®¡æ€»å·¥æœŸ**ï¼š3.5å¤©

---

## ğŸ“‹ å®æ–½æ¦‚è§ˆ

| é˜¶æ®µ | åŠŸèƒ½ | ä¼˜å…ˆçº§ | å·¥æœŸ | é£é™©ç­‰çº§ |
|------|------|--------|------|----------|
| **é˜¶æ®µ1** | ç•™è¨€å…æŠ¼é‡‘ | P0 | 0.5å¤© | ğŸŸ¢ ä½ |
| **é˜¶æ®µ2** | é€è€…åˆ›å»ºå…æŠ¼é‡‘ | P1 | 3å¤© | ğŸŸ¡ ä¸­ |

---

## é˜¶æ®µ1ï¼šç•™è¨€å…æŠ¼é‡‘

### 1.1 ä¿®æ”¹ç›®æ ‡

å°†ç•™è¨€ï¼ˆMessageï¼‰åŠŸèƒ½çš„æŠ¼é‡‘ä» 100 DUST æ”¹ä¸º 0ï¼ŒåŒæ—¶æ–°å¢é¢‘ç‡é™åˆ¶é˜²æ­¢æ»¥ç”¨ã€‚

### 1.2 ä¿®æ”¹æ­¥éª¤

#### Step 1.1ï¼šä¿®æ”¹ Runtime é…ç½® (10åˆ†é’Ÿ)

**æ–‡ä»¶**ï¼š`runtime/src/lib.rs` æˆ– `runtime/src/configs/mod.rs`

```rust
// æ‰¾åˆ° TextDeposit é…ç½®ï¼Œä¿®æ”¹ä¸º 0
parameter_types! {
    // ä¿®æ”¹å‰
    // pub const TextDeposit: Balance = 100 * DUST;

    // ä¿®æ”¹å
    pub const TextDeposit: Balance = 0;  // ç•™è¨€å…æŠ¼é‡‘
}
```

#### Step 1.2ï¼šæ–°å¢ç•™è¨€é¢‘ç‡é™åˆ¶å­˜å‚¨ (30åˆ†é’Ÿ)

**æ–‡ä»¶**ï¼š`pallets/deceased/src/lib.rs`

```rust
// åœ¨ #[pallet::storage] åŒºåŸŸæ–°å¢

/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šç”¨æˆ·æ¯æ—¥ç•™è¨€è®¡æ•°
/// - Key: (AccountId, day_index)
/// - Value: å½“æ—¥å·²å‘é€ç•™è¨€æ•°
#[pallet::storage]
pub type UserDailyMessageCount<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    (T::AccountId, u32),  // (user, day_index)
    u32,
    ValueQuery,
>;

/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šç”¨æˆ·å¯¹ç‰¹å®šé€è€…çš„æ¯æ—¥ç•™è¨€è®¡æ•°
/// - Key: (AccountId, DeceasedId, day_index)
/// - Value: å½“æ—¥å¯¹è¯¥é€è€…çš„ç•™è¨€æ•°
#[pallet::storage]
pub type UserDeceasedDailyMessageCount<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    (T::AccountId, T::DeceasedId, u32),
    u32,
    ValueQuery,
>;
```

#### Step 1.3ï¼šæ–°å¢é¢‘ç‡é™åˆ¶é…ç½® (10åˆ†é’Ÿ)

**æ–‡ä»¶**ï¼š`pallets/deceased/src/lib.rs` - Config trait

```rust
#[pallet::config]
pub trait Config: frame_system::Config {
    // ... ç°æœ‰é…ç½® ...

    /// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šæ¯æ—¥æœ€å¤§ç•™è¨€æ•°ï¼ˆå…¨å±€ï¼‰
    #[pallet::constant]
    type MaxMessagesPerUserDaily: Get<u32>;  // å»ºè®®ï¼š20

    /// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šæ¯æ—¥å¯¹å•ä¸ªé€è€…æœ€å¤§ç•™è¨€æ•°
    #[pallet::constant]
    type MaxMessagesPerDeceasedDaily: Get<u32>;  // å»ºè®®ï¼š5
}
```

#### Step 1.4ï¼šä¿®æ”¹ç•™è¨€åˆ›å»ºé€»è¾‘ (1å°æ—¶)

**æ–‡ä»¶**ï¼š`pallets/deceased/src/lib.rs` - æ‰¾åˆ°åˆ›å»ºç•™è¨€çš„ extrinsic

```rust
// åœ¨åˆ›å»º Message ç±»å‹çš„æ–‡æœ¬æ—¶ï¼Œæ·»åŠ é¢‘ç‡æ£€æŸ¥

/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šåˆ›å»ºæ–‡æœ¬ï¼ˆArticle/Messageï¼‰
#[pallet::call_index(X)]  // æ‰¾åˆ°å¯¹åº”çš„ call_index
#[pallet::weight(...)]
pub fn create_text(
    origin: OriginFor<T>,
    deceased_id: T::DeceasedId,
    kind: u8,  // 0=Article, 1=Message
    cid: Vec<u8>,
    title: Option<Vec<u8>>,
    summary: Option<Vec<u8>>,
) -> DispatchResult {
    let who = ensure_signed(origin)?;

    // ğŸ†• æ–°å¢ï¼šMessage ç±»å‹çš„é¢‘ç‡é™åˆ¶æ£€æŸ¥
    if kind == 1 {  // Message
        Self::check_message_rate_limit(&who, deceased_id)?;
    }

    // ... ç°æœ‰é€»è¾‘ ...

    // ğŸ†• æ–°å¢ï¼šæ›´æ–°ç•™è¨€è®¡æ•°
    if kind == 1 {
        Self::increment_message_count(&who, deceased_id);
    }

    Ok(())
}

// ğŸ†• æ–°å¢è¾…åŠ©å‡½æ•°
impl<T: Config> Pallet<T> {
    /// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šæ£€æŸ¥ç•™è¨€é¢‘ç‡é™åˆ¶
    fn check_message_rate_limit(
        who: &T::AccountId,
        deceased_id: T::DeceasedId,
    ) -> DispatchResult {
        let day_index = Self::current_day_index();

        // æ£€æŸ¥æ¯æ—¥å…¨å±€é™åˆ¶
        let daily_count = UserDailyMessageCount::<T>::get((who.clone(), day_index));
        ensure!(
            daily_count < T::MaxMessagesPerUserDaily::get(),
            Error::<T>::DailyMessageLimitExceeded
        );

        // æ£€æŸ¥å¯¹å•ä¸ªé€è€…çš„æ¯æ—¥é™åˆ¶
        let deceased_daily_count = UserDeceasedDailyMessageCount::<T>::get(
            (who.clone(), deceased_id, day_index)
        );
        ensure!(
            deceased_daily_count < T::MaxMessagesPerDeceasedDaily::get(),
            Error::<T>::DeceasedDailyMessageLimitExceeded
        );

        Ok(())
    }

    /// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šæ›´æ–°ç•™è¨€è®¡æ•°
    fn increment_message_count(who: &T::AccountId, deceased_id: T::DeceasedId) {
        let day_index = Self::current_day_index();

        UserDailyMessageCount::<T>::mutate((who.clone(), day_index), |count| {
            *count = count.saturating_add(1);
        });

        UserDeceasedDailyMessageCount::<T>::mutate(
            (who.clone(), deceased_id, day_index),
            |count| {
                *count = count.saturating_add(1);
            }
        );
    }

    /// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šè·å–å½“å‰æ—¥æœŸç´¢å¼•ï¼ˆåŸºäºåŒºå—å·ï¼‰
    fn current_day_index() -> u32 {
        let now = <frame_system::Pallet<T>>::block_number();
        // å‡è®¾6ç§’/å—ï¼Œ1å¤© = 14400å—
        let blocks_per_day: u32 = 14400;
        (now.saturated_into::<u64>() / blocks_per_day as u64) as u32
    }
}
```

#### Step 1.5ï¼šæ–°å¢é”™è¯¯ç±»å‹ (5åˆ†é’Ÿ)

**æ–‡ä»¶**ï¼š`pallets/deceased/src/lib.rs` - Error enum

```rust
#[pallet::error]
pub enum Error<T> {
    // ... ç°æœ‰é”™è¯¯ ...

    /// æ¯æ—¥ç•™è¨€æ•°å·²è¾¾ä¸Šé™
    DailyMessageLimitExceeded,
    /// å¯¹è¯¥é€è€…çš„æ¯æ—¥ç•™è¨€æ•°å·²è¾¾ä¸Šé™
    DeceasedDailyMessageLimitExceeded,
}
```

#### Step 1.6ï¼šæ›´æ–° Runtime é…ç½®å®ç° (10åˆ†é’Ÿ)

**æ–‡ä»¶**ï¼š`runtime/src/lib.rs`

```rust
impl pallet_deceased::Config for Runtime {
    // ... ç°æœ‰é…ç½® ...

    type MaxMessagesPerUserDaily = ConstU32<20>;      // æ¯æ—¥æœ€å¤š20æ¡ç•™è¨€
    type MaxMessagesPerDeceasedDaily = ConstU32<5>;   // æ¯ä¸ªé€è€…æ¯æ—¥æœ€å¤š5æ¡
}
```

#### Step 1.7ï¼šæ›´æ–°æµ‹è¯• Mock (15åˆ†é’Ÿ)

**æ–‡ä»¶**ï¼š`pallets/deceased/src/mock.rs`

```rust
impl pallet_deceased::Config for Test {
    // ... ç°æœ‰é…ç½® ...

    type TextDeposit = ConstU64<0>;  // å…æŠ¼é‡‘
    type MaxMessagesPerUserDaily = ConstU32<20>;
    type MaxMessagesPerDeceasedDaily = ConstU32<5>;
}
```

#### Step 1.8ï¼šç¼–å†™æµ‹è¯•ç”¨ä¾‹ (30åˆ†é’Ÿ)

**æ–‡ä»¶**ï¼š`pallets/deceased/src/tests.rs` æˆ–æ–°å»º `message_tests.rs`

```rust
/// Test: ç•™è¨€å…æŠ¼é‡‘åˆ›å»º
#[test]
fn message_creation_without_deposit() {
    new_test_ext().execute_with(|| {
        System::set_block_number(1);

        // å…ˆåˆ›å»ºé€è€…
        // ...

        // åˆ›å»ºç•™è¨€ï¼ˆæ— éœ€æŠ¼é‡‘ï¼‰
        assert_ok!(Pallet::<Test>::create_text(
            RuntimeOrigin::signed(1),
            deceased_id,
            1,  // Message
            b"QmTest...".to_vec(),
            None,
            None,
        ));

        // éªŒè¯ä½™é¢æœªå˜åŒ–
        // ...
    });
}

/// Test: ç•™è¨€é¢‘ç‡é™åˆ¶
#[test]
fn message_rate_limit_enforced() {
    new_test_ext().execute_with(|| {
        System::set_block_number(1);

        // åˆ›å»º20æ¡ç•™è¨€
        for _ in 0..20 {
            assert_ok!(Pallet::<Test>::create_text(...));
        }

        // ç¬¬21æ¡åº”è¯¥å¤±è´¥
        assert_noop!(
            Pallet::<Test>::create_text(...),
            Error::<Test>::DailyMessageLimitExceeded
        );
    });
}
```

### 1.3 éªŒè¯æ¸…å•

- [ ] `cargo check -p pallet-deceased` é€šè¿‡
- [ ] `cargo test -p pallet-deceased` é€šè¿‡
- [ ] ç•™è¨€åˆ›å»ºä¸å†æ‰£é™¤æŠ¼é‡‘
- [ ] é¢‘ç‡é™åˆ¶æ­£å¸¸å·¥ä½œ
- [ ] å‰ç«¯æ›´æ–°æç¤ºä¿¡æ¯ï¼ˆå¯é€‰ï¼‰

---

## é˜¶æ®µ2ï¼šé€è€…åˆ›å»ºå…æŠ¼é‡‘

### 2.1 ä¿®æ”¹ç›®æ ‡

ç§»é™¤é€è€…åˆ›å»ºçš„ 10 USDT æ°¸ä¹…è´¨æŠ¼æŠ¼é‡‘ï¼Œæ”¹ä¸ºé¢‘ç‡é™åˆ¶ + æŠ•è¯‰æ²»ç†ã€‚

### 2.2 ä¿®æ”¹æ­¥éª¤

#### Step 2.1ï¼šæ–°å¢åˆ›å»ºé¢‘ç‡é™åˆ¶å­˜å‚¨ (20åˆ†é’Ÿ)

**æ–‡ä»¶**ï¼š`pallets/deceased/src/lib.rs`

```rust
/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šç”¨æˆ·é€è€…åˆ›å»ºè®¡æ•°
/// - Key: AccountId
/// - Value: åˆ›å»ºç»Ÿè®¡ä¿¡æ¯
#[pallet::storage]
pub type UserCreationStats<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    T::AccountId,
    CreationStats<T>,
    OptionQuery,
>;

/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šåˆ›å»ºç»Ÿè®¡ç»“æ„
#[derive(Encode, Decode, Clone, PartialEq, Eq, TypeInfo, MaxEncodedLen)]
#[scale_info(skip_type_params(T))]
pub struct CreationStats<T: Config> {
    /// ä»Šæ—¥å·²åˆ›å»ºæ•°
    pub daily_count: u32,
    /// ä»Šæ—¥ç´¢å¼•
    pub last_day_index: u32,
    /// æ€»åˆ›å»ºæ•°
    pub total_count: u32,
    /// æœ€ååˆ›å»ºæ—¶é—´
    pub last_created_at: BlockNumberFor<T>,
}
```

#### Step 2.2ï¼šæ–°å¢é¢‘ç‡é™åˆ¶é…ç½® (10åˆ†é’Ÿ)

**æ–‡ä»¶**ï¼š`pallets/deceased/src/lib.rs` - Config trait

```rust
/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šæ¯æ—¥æœ€å¤§é€è€…åˆ›å»ºæ•°
#[pallet::constant]
type MaxDeceasedCreationsPerUserDaily: Get<u32>;  // å»ºè®®ï¼š3

/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šç”¨æˆ·æœ€å¤§é€è€…æ€»æ•°
#[pallet::constant]
type MaxDeceasedPerUser: Get<u32>;  // å»ºè®®ï¼š20

/// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šåˆ›å»ºæœ€å°é—´éš”ï¼ˆåŒºå—æ•°ï¼‰
#[pallet::constant]
type MinCreationIntervalBlocks: Get<BlockNumberFor<Self>>;  // å»ºè®®ï¼š100å—ï¼ˆ~10åˆ†é’Ÿï¼‰
```

#### Step 2.3ï¼šä¿®æ”¹ create_deceased å‡½æ•° (1.5å°æ—¶)

**æ–‡ä»¶**ï¼š`pallets/deceased/src/lib.rs` - create_deceased extrinsic

```rust
/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šåˆ›å»ºé€è€…è®°å½•ï¼ˆå…æŠ¼é‡‘ç‰ˆæœ¬ï¼‰
///
/// ### ä¿®æ”¹è¯´æ˜
/// - ç§»é™¤æ°¸ä¹…è´¨æŠ¼æŠ¼é‡‘é€»è¾‘
/// - æ–°å¢é¢‘ç‡é™åˆ¶æ£€æŸ¥
/// - ä¿ç•™ç‰¹æƒç”¨æˆ·ç»•è¿‡é™åˆ¶çš„èƒ½åŠ›
#[pallet::call_index(X)]
#[pallet::weight(T::WeightInfo::create())]
pub fn create_deceased(
    origin: OriginFor<T>,
    name: Vec<u8>,
    gender_code: u8,
    name_full_cid: Option<Vec<u8>>,
    birth_ts: Vec<u8>,
    death_ts: Vec<u8>,
    links: Vec<Vec<u8>>,
) -> DispatchResult {
    // å°è¯•ç‰¹æƒæºï¼ˆå…é¢‘ç‡é™åˆ¶ï¼‰
    let is_privileged = T::PrivilegedOrigin::try_origin(origin.clone()).is_ok();

    let who = if is_privileged {
        // ç‰¹æƒç”¨æˆ·ï¼šä» origin æå–æˆ–ä½¿ç”¨é»˜è®¤è´¦æˆ·
        // æ³¨æ„ï¼šRoot origin æ²¡æœ‰ç­¾åè€…ï¼Œéœ€è¦ç‰¹æ®Šå¤„ç†
        match ensure_signed(origin.clone()) {
            Ok(account) => account,
            Err(_) => {
                // Root originï¼Œä½¿ç”¨ç³»ç»Ÿè´¦æˆ·æˆ–è¿”å›é”™è¯¯
                return Err(Error::<T>::RootOriginRequiresExplicitOwner.into());
            }
        }
    } else {
        // æ™®é€šç”¨æˆ·ï¼šæ£€æŸ¥é¢‘ç‡é™åˆ¶
        let who = ensure_signed(origin)?;
        Self::check_creation_rate_limit(&who)?;
        who
    };

    // âŒ ç§»é™¤ï¼šæŠ¼é‡‘é”å®šé€»è¾‘
    // let deposit_usdt = DepositCalculator::<T>::calculate_creation_deposit_usdt(...);
    // let deposit_dust = ExchangeRateHelper::<T>::convert_usdt_to_dust(deposit_usdt)?;
    // T::Fungible::hold(&HoldReason::DeceasedOwnerDeposit, &who, deposit_dust)?;

    // ç”Ÿæˆéšæœº 10 ä½æ•° ID
    let deceased_id = Self::generate_random_deceased_id()?;

    // æ„å»º deceased_token
    let gender = Gender::from_code(gender_code);
    let deceased_token = Self::build_deceased_token(&name, &gender, &birth_ts, &death_ts)?;

    // ... ç°æœ‰åˆ›å»ºé€»è¾‘ ...

    // ğŸ†• æ›´æ–°åˆ›å»ºç»Ÿè®¡
    if !is_privileged {
        Self::increment_creation_count(&who);
    }

    // âŒ ç§»é™¤ï¼šåˆ›å»º OwnerDepositRecord
    // OwnerDepositRecords::<T>::insert(deceased_id, deposit_record);

    // å‘å‡ºäº‹ä»¶
    Self::deposit_event(Event::DeceasedCreated(deceased_id.into(), who));

    Ok(())
}
```

#### Step 2.4ï¼šå®ç°é¢‘ç‡é™åˆ¶è¾…åŠ©å‡½æ•° (30åˆ†é’Ÿ)

**æ–‡ä»¶**ï¼š`pallets/deceased/src/lib.rs`

```rust
impl<T: Config> Pallet<T> {
    /// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šæ£€æŸ¥é€è€…åˆ›å»ºé¢‘ç‡é™åˆ¶
    fn check_creation_rate_limit(who: &T::AccountId) -> DispatchResult {
        let now = <frame_system::Pallet<T>>::block_number();
        let day_index = Self::current_day_index();

        let stats = UserCreationStats::<T>::get(who);

        if let Some(mut stats) = stats {
            // æ£€æŸ¥æœ€å°é—´éš”
            let interval = now.saturating_sub(stats.last_created_at);
            ensure!(
                interval >= T::MinCreationIntervalBlocks::get(),
                Error::<T>::CreationTooFrequent
            );

            // é‡ç½®æ—¥è®¡æ•°ï¼ˆå¦‚æœæ˜¯æ–°çš„ä¸€å¤©ï¼‰
            if stats.last_day_index != day_index {
                stats.daily_count = 0;
                stats.last_day_index = day_index;
            }

            // æ£€æŸ¥æ¯æ—¥é™åˆ¶
            ensure!(
                stats.daily_count < T::MaxDeceasedCreationsPerUserDaily::get(),
                Error::<T>::DailyCreationLimitExceeded
            );

            // æ£€æŸ¥æ€»æ•°é™åˆ¶
            ensure!(
                stats.total_count < T::MaxDeceasedPerUser::get(),
                Error::<T>::TotalCreationLimitExceeded
            );
        }

        Ok(())
    }

    /// å‡½æ•°çº§ä¸­æ–‡æ³¨é‡Šï¼šæ›´æ–°åˆ›å»ºç»Ÿè®¡
    fn increment_creation_count(who: &T::AccountId) {
        let now = <frame_system::Pallet<T>>::block_number();
        let day_index = Self::current_day_index();

        UserCreationStats::<T>::mutate(who, |maybe_stats| {
            let stats = maybe_stats.get_or_insert(CreationStats {
                daily_count: 0,
                last_day_index: day_index,
                total_count: 0,
                last_created_at: now,
            });

            // é‡ç½®æ—¥è®¡æ•°ï¼ˆå¦‚æœæ˜¯æ–°çš„ä¸€å¤©ï¼‰
            if stats.last_day_index != day_index {
                stats.daily_count = 0;
                stats.last_day_index = day_index;
            }

            stats.daily_count = stats.daily_count.saturating_add(1);
            stats.total_count = stats.total_count.saturating_add(1);
            stats.last_created_at = now;
        });
    }
}
```

#### Step 2.5ï¼šæ–°å¢é”™è¯¯ç±»å‹ (5åˆ†é’Ÿ)

**æ–‡ä»¶**ï¼š`pallets/deceased/src/lib.rs`

```rust
#[pallet::error]
pub enum Error<T> {
    // ... ç°æœ‰é”™è¯¯ ...

    /// åˆ›å»ºè¿‡äºé¢‘ç¹ï¼ˆæœªè¾¾åˆ°æœ€å°é—´éš”ï¼‰
    CreationTooFrequent,
    /// æ¯æ—¥åˆ›å»ºæ•°å·²è¾¾ä¸Šé™
    DailyCreationLimitExceeded,
    /// æ€»åˆ›å»ºæ•°å·²è¾¾ä¸Šé™
    TotalCreationLimitExceeded,
    /// Root origin éœ€è¦æ˜¾å¼æŒ‡å®š owner
    RootOriginRequiresExplicitOwner,
}
```

#### Step 2.6ï¼šæ¸…ç†æŠ¼é‡‘ç›¸å…³ä»£ç  (1å°æ—¶)

**éœ€è¦ç§»é™¤/æ³¨é‡Šçš„ä»£ç **ï¼š

**æ–‡ä»¶**ï¼š`pallets/deceased/src/lib.rs`
- [ ] ç§»é™¤ `OwnerDepositRecords` å­˜å‚¨çš„å†™å…¥é€»è¾‘
- [ ] ç§»é™¤ `HoldReason::DeceasedOwnerDeposit` çš„ä½¿ç”¨
- [ ] ç§»é™¤æŠ¼é‡‘æ£€æŸ¥ç›¸å…³çš„æƒé™æ§åˆ¶é€»è¾‘

**æ–‡ä»¶**ï¼š`pallets/deceased/src/governance.rs`
- [ ] ä¿ç•™ `OwnerDepositRecord` ç»“æ„ï¼ˆä¾›å‚è€ƒï¼‰
- [ ] æ³¨é‡Šæˆ–ç§»é™¤ `GovernanceOps::create_deceased_with_deposit`
- [ ] ä¿ç•™æŠ•è¯‰æ²»ç†æœºåˆ¶ï¼ˆä¸æŠ¼é‡‘æ— å…³ï¼‰

**æ³¨æ„**ï¼šå»ºè®®ä½¿ç”¨ `#[cfg(feature = "with-deposit")]` æ¡ä»¶ç¼–è¯‘ä¿ç•™æŠ¼é‡‘ä»£ç ï¼Œä¾¿äºå›æ»šã€‚

#### Step 2.7ï¼šæ›´æ–° Runtime é…ç½® (15åˆ†é’Ÿ)

**æ–‡ä»¶**ï¼š`runtime/src/lib.rs`

```rust
impl pallet_deceased::Config for Runtime {
    // ... ç°æœ‰é…ç½® ...

    // ğŸ†• æ–°å¢é¢‘ç‡é™åˆ¶é…ç½®
    type MaxDeceasedCreationsPerUserDaily = ConstU32<3>;
    type MaxDeceasedPerUser = ConstU32<20>;
    type MinCreationIntervalBlocks = ConstU64<100>;  // ~10åˆ†é’Ÿ
}
```

#### Step 2.8ï¼šæ›´æ–°æµ‹è¯• (30åˆ†é’Ÿ)

**æ–‡ä»¶**ï¼š`pallets/deceased/src/tests.rs`

```rust
/// Test: æ™®é€šç”¨æˆ·å…æŠ¼é‡‘åˆ›å»ºé€è€…
#[test]
fn regular_user_create_deceased_without_deposit() {
    new_test_ext().execute_with(|| {
        System::set_block_number(1);
        let initial_balance = Balances::free_balance(1);

        assert_ok!(Pallet::<Test>::create_deceased(
            RuntimeOrigin::signed(1),
            name(),
            0,
            None,
            birth_ts(),
            death_ts(),
            Vec::new(),
        ));

        // éªŒè¯ä½™é¢æœªå˜åŒ–ï¼ˆæ— æŠ¼é‡‘æ‰£é™¤ï¼‰
        assert_eq!(Balances::free_balance(1), initial_balance);
    });
}

/// Test: åˆ›å»ºé¢‘ç‡é™åˆ¶
#[test]
fn creation_rate_limit_enforced() {
    new_test_ext().execute_with(|| {
        System::set_block_number(1);

        // åˆ›å»º3ä¸ªé€è€…
        for i in 0..3 {
            System::set_block_number(1 + i * 100);  // æ»¡è¶³é—´éš”è¦æ±‚
            assert_ok!(Pallet::<Test>::create_deceased(...));
        }

        // ç¬¬4ä¸ªåº”è¯¥å¤±è´¥ï¼ˆæ¯æ—¥é™åˆ¶ï¼‰
        System::set_block_number(301);
        assert_noop!(
            Pallet::<Test>::create_deceased(...),
            Error::<Test>::DailyCreationLimitExceeded
        );
    });
}
```

### 2.3 éªŒè¯æ¸…å•

- [ ] `cargo check -p pallet-deceased` é€šè¿‡
- [ ] `cargo test -p pallet-deceased` é€šè¿‡
- [ ] `cargo build --release` é€šè¿‡
- [ ] é€è€…åˆ›å»ºä¸å†æ‰£é™¤æŠ¼é‡‘
- [ ] é¢‘ç‡é™åˆ¶æ­£å¸¸å·¥ä½œ
- [ ] ç‰¹æƒç”¨æˆ·ä»å¯ç»‘å®šé™åˆ¶åˆ›å»º
- [ ] æŠ•è¯‰æ²»ç†æœºåˆ¶æ­£å¸¸å·¥ä½œ

---

## å®æ–½æ£€æŸ¥æ¸…å•

### é˜¶æ®µ1 æ£€æŸ¥æ¸…å•ï¼ˆç•™è¨€å…æŠ¼é‡‘ï¼‰

- [ ] 1. ä¿®æ”¹ `TextDeposit = 0`
- [ ] 2. æ–°å¢ `UserDailyMessageCount` å­˜å‚¨
- [ ] 3. æ–°å¢ `UserDeceasedDailyMessageCount` å­˜å‚¨
- [ ] 4. æ–°å¢é¢‘ç‡é™åˆ¶é…ç½®
- [ ] 5. ä¿®æ”¹åˆ›å»ºç•™è¨€é€»è¾‘
- [ ] 6. æ–°å¢é”™è¯¯ç±»å‹
- [ ] 7. æ›´æ–° Runtime é…ç½®
- [ ] 8. æ›´æ–°æµ‹è¯• Mock
- [ ] 9. ç¼–å†™æµ‹è¯•ç”¨ä¾‹
- [ ] 10. é€šè¿‡æ‰€æœ‰æµ‹è¯•

### é˜¶æ®µ2 æ£€æŸ¥æ¸…å•ï¼ˆé€è€…åˆ›å»ºå…æŠ¼é‡‘ï¼‰

- [ ] 1. æ–°å¢ `UserCreationStats` å­˜å‚¨
- [ ] 2. æ–°å¢ `CreationStats` ç»“æ„
- [ ] 3. æ–°å¢é¢‘ç‡é™åˆ¶é…ç½®
- [ ] 4. ä¿®æ”¹ `create_deceased` å‡½æ•°
- [ ] 5. å®ç°é¢‘ç‡é™åˆ¶è¾…åŠ©å‡½æ•°
- [ ] 6. æ–°å¢é”™è¯¯ç±»å‹
- [ ] 7. æ¸…ç†æŠ¼é‡‘ç›¸å…³ä»£ç 
- [ ] 8. æ›´æ–° Runtime é…ç½®
- [ ] 9. æ›´æ–°æµ‹è¯•ç”¨ä¾‹
- [ ] 10. é€šè¿‡æ‰€æœ‰æµ‹è¯•
- [ ] 11. å®Œæ•´æ„å»ºæµ‹è¯•

---

## å›æ»šæ–¹æ¡ˆ

### å¿«é€Ÿå›æ»š

å¦‚æœå‡ºç°ä¸¥é‡é—®é¢˜ï¼Œå¯é€šè¿‡ä»¥ä¸‹æ–¹å¼å¿«é€Ÿå›æ»šï¼š

1. **ç•™è¨€æŠ¼é‡‘æ¢å¤**ï¼š
   ```rust
   pub const TextDeposit: Balance = 100 * DUST;
   ```

2. **é€è€…åˆ›å»ºæŠ¼é‡‘æ¢å¤**ï¼š
   - å¯ç”¨ `#[cfg(feature = "with-deposit")]` æ¡ä»¶ç¼–è¯‘
   - æˆ–é€šè¿‡ Runtime å‡çº§æ¢å¤æŠ¼é‡‘é€»è¾‘

### ç›‘æ§å‘Šè­¦

éƒ¨ç½²åéœ€ç›‘æ§ï¼š
- ç•™è¨€åˆ›å»ºé€Ÿç‡ï¼ˆå‘Šè­¦ï¼š>5000/å¤©ï¼‰
- é€è€…åˆ›å»ºé€Ÿç‡ï¼ˆå‘Šè­¦ï¼š>500/å¤©ï¼‰
- æŠ•è¯‰æ•°é‡ï¼ˆå‘Šè­¦ï¼šæŠ•è¯‰ç‡ >20%ï¼‰
- å­˜å‚¨å¢é•¿ï¼ˆå‘Šè­¦ï¼šæ—¥å¢ >100MBï¼‰

---

**è®¡åˆ’æ—¥æœŸ**ï¼š2025-11-26
**é¢„è®¡å®Œæˆ**ï¼š2025-11-30
**è´£ä»»äºº**ï¼šå¼€å‘å›¢é˜Ÿ
