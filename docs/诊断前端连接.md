# Profile 页面数据无法显示 - 问题诊断

## 问题现象

访问 `http://127.0.0.1:5173/#/profile` 时，"网络与业务数据面板"无法显示链上动态数据。

## 根本原因

前端的 `getApi()` 函数报 **30秒连接超时**，导致所有依赖 API 的数据无法加载：
- 昵称设置（identity.identityOf）
- 推荐码（memoReferrals.codeOf）
- 数据面板（chain info, blocks, peers）

## 问题定位

### 1. 链节点状态 ✅ 正常

```bash
# 节点进程运行中
$ pgrep -af memopark-node
19485 ./target/release/memopark-node --dev --tmp --rpc-external --rpc-cors=all --rpc-port 9944

# RPC 接口响应正常
$ curl -s -m 3 -H "Content-Type: application/json" -d '{"id":1,"jsonrpc":"2.0","method":"system_health"}' http://127.0.0.1:9944
{"jsonrpc":"2.0","id":1,"result":{"peers":0,"isSyncing":false,"shouldHavePeers":false}}

# WebSocket 测试通过
$ node memopark-dapp/check-ws.mjs
chain=Development name=Substrate Node version=0.1.0-cfd52a44366 best=146
```

**结论**：节点完全正常，WebSocket 端口 9944 可连接。

### 2. 前端连接问题 ❌ 

浏览器控制台错误：
```
[polkadot-safe] 节点连接失败: Error: 区块链连接超时（30秒无响应）
[polkadot-safe] 正在连接节点: ws://127.0.0.1:9944
```

**原因**：
1. 前端可能没有使用 `./启动前端.sh` 启动（缺少 `VITE_ALLOW_DEV_SESSION=1`）
2. 浏览器可能缓存了旧的前端代码
3. `getApi()` 的单例实例可能处于错误状态

## 解决方案

### 方案 1：重新启动前端（推荐）

**步骤**：

1. **停止旧前端**：
   ```bash
   cd /home/xiaodong/文档/memopark
   lsof -ti:5173 | xargs -r kill -9
   ```

2. **使用正确脚本启动**：
   ```bash
   ./启动前端.sh
   ```
   该脚本已包含：
   - `VITE_WS=ws://127.0.0.1:9944`
   - `VITE_ALLOW_DEV_SESSION=1`（跳过后端认证）

3. **等待启动完成**（10-20秒），看到：
   ```
   ➜  Local:   http://127.0.0.1:5173/
   ➜  ready in xxx ms
   ```

4. **清除浏览器缓存**：
   - 按 `Ctrl+Shift+Delete`
   - 或使用隐身窗口（`Ctrl+Shift+N`）

5. **访问并验证**：
   - 打开：http://127.0.0.1:5173/#/profile
   - 按 `F12` 查看控制台，应该看到：
     ```
     [polkadot-safe] 正在连接节点: ws://127.0.0.1:9944
     [polkadot-safe] 节点连接成功
     ```

### 方案 2：手动重连 API

如果页面已经打开，在**浏览器控制台**执行：

```js
// 1. 导入模块
const mp = await import('/src/lib/polkadot-safe.ts')

// 2. 断开旧连接
await mp.disconnectApi()

// 3. 重新连接
const api = await mp.getApi()

// 4. 验证连接状态
console.log('连接状态:', api.isConnected)  // 应该返回 true

// 5. 刷新页面
location.reload()
```

### 方案 3：检查环境变量

在浏览器控制台执行：

```js
const { AppConfig } = await import('/src/lib/config.ts')
console.log('WS 端点:', AppConfig.wsEndpoint)        // 应该是 ws://127.0.0.1:9944
console.log('后端URL:', AppConfig.backendUrl)        // 应该是 http://127.0.0.1:8787
```

如果 `wsEndpoint` 不是 `ws://127.0.0.1:9944`，说明前端启动时缺少环境变量。

## 验证成功标志

### 控制台日志 ✅
```
[polkadot-safe] 正在连接节点: ws://127.0.0.1:9944
[polkadot-safe] 节点连接成功
[session] using dev fallback  ← 开发会话已启用
```

### Profile 页面显示 ✅
- ✅ 数据面板显示区块高度、链名称
- ✅ 推荐码可以刷新/领取
- ✅ 昵称设置可以读取/保存

## 相关文档

- **完整启动指南**：`/home/xiaodong/文档/memopark/快速启动节点.md`
- **启动脚本**：`/home/xiaodong/文档/memopark/启动前端.sh`
- **委员会提案**：`/home/xiaodong/文档/memopark/docs/council-proposal-ui.md`

## 快速命令

```bash
# 一键启动链节点（新终端1）
cd /home/xiaodong/文档/memopark && ./完全重置并启动.sh

# 一键启动前端（新终端2，等节点启动30秒后）
cd /home/xiaodong/文档/memopark && ./启动前端.sh

# 测试节点连接
curl -s http://127.0.0.1:9944 -H "Content-Type: application/json" -d '{"id":1,"jsonrpc":"2.0","method":"system_health"}'

# 测试 WebSocket
node /home/xiaodong/文档/memopark/memopark-dapp/check-ws.mjs
```

