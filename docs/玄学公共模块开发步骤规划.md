# 玄学公共模块开发步骤规划

> 版本：v1.0.0
> 日期：2025-11-29
> 预计总工期：10周

---

## 开发概览

```
Week 1      Week 2-3    Week 4-5    Week 6-7    Week 8      Week 9-10
  │            │           │           │          │            │
  ▼            ▼           ▼           ▼          ▼            ▼
┌────┐     ┌──────┐    ┌──────┐    ┌──────┐   ┌────┐      ┌──────┐
│公共│     │ NFT  │    │  AI  │    │Market│   │集成│      │ 前端 │
│类型│ ──► │ 模块 │ ──►│ 模块 │ ──►│ 模块 │──►│测试│ ──►  │ 适配 │
│ 库 │     │ 重构 │    │ 重构 │    │ 重构 │   │    │      │      │
└────┘     └──────┘    └──────┘    └──────┘   └────┘      └──────┘
```

---

## Phase 1: 公共类型库 (Week 1)

### 1.1 创建 pallet-divination-common

**目标**: 定义所有公共类型和核心 trait

**步骤**:

```bash
# Step 1.1.1: 创建目录结构
mkdir -p pallets/divination-common/src
```

**文件清单**:
```
pallets/divination-common/
├── Cargo.toml
└── src/
    ├── lib.rs          # 模块入口，导出所有公共类型
    ├── types.rs        # 核心类型定义
    └── traits.rs       # DivinationProvider trait
```

### 1.2 实现核心类型

**任务列表**:

| 序号 | 任务 | 文件 | 预计时间 |
|------|------|------|----------|
| 1.2.1 | 创建 Cargo.toml | Cargo.toml | 0.5h |
| 1.2.2 | 定义 DivinationType 枚举 | types.rs | 1h |
| 1.2.3 | 定义 Rarity 枚举 | types.rs | 0.5h |
| 1.2.4 | 定义 RarityInput 结构体及计算逻辑 | types.rs | 2h |
| 1.2.5 | 定义 InterpretationType 枚举 | types.rs | 0.5h |
| 1.2.6 | 定义 InterpretationStatus 枚举 | types.rs | 0.5h |
| 1.2.7 | 定义 ServiceType 枚举 | types.rs | 0.5h |
| 1.2.8 | 定义 OrderStatus 枚举 | types.rs | 0.5h |
| 1.2.9 | 定义 DivinationProvider trait | traits.rs | 3h |
| 1.2.10 | 模块入口整合导出 | lib.rs | 1h |

### 1.3 编写单元测试

**测试用例**:
```rust
// tests/rarity_test.rs
#[test]
fn test_common_rarity() { ... }

#[test]
fn test_rare_rarity() { ... }

#[test]
fn test_epic_rarity() { ... }

#[test]
fn test_legendary_rarity() { ... }

#[test]
fn test_special_date_bonus() { ... }

#[test]
fn test_special_combination_bonus() { ... }
```

### 1.4 Phase 1 验收标准

- [ ] `cargo check -p pallet-divination-common` 编译通过
- [ ] `cargo test -p pallet-divination-common` 所有测试通过
- [ ] 类型文档注释完整
- [ ] 无 clippy 警告

---

## Phase 2: NFT 模块重构 (Week 2-3)

### 2.1 创建 pallet-divination-nft

**目标**: 从 meihua-nft 重构为通用 NFT 模块

**文件清单**:
```
pallets/divination-nft/
├── Cargo.toml
└── src/
    ├── lib.rs              # 主模块 + dispatchables
    ├── types.rs            # NFT 结构体定义
    ├── mint.rs             # 铸造逻辑
    ├── trade.rs            # 交易逻辑（挂单、购买、出价）
    ├── collection.rs       # 收藏集逻辑
    ├── weights.rs          # 权重定义
    ├── mock.rs             # 测试 mock
    ├── tests.rs            # 单元测试
    └── benchmarking.rs     # 基准测试
```

### 2.2 存储结构变更

**旧结构 (meihua-nft)**:
```rust
pub struct HexagramNft {
    pub hexagram_id: u64,  // 仅支持梅花卦象
    // ...
}
```

**新结构 (divination-nft)**:
```rust
pub struct DivinationNft {
    pub divination_type: DivinationType,  // 占卜类型
    pub result_id: u64,                   // 结果ID（通用）
    // ...
}

// 存储映射变更
#[pallet::storage]
pub type NftsByType<T> = StorageDoubleMap<
    _,
    Blake2_128Concat, DivinationType,
    Blake2_128Concat, u64,  // result_id
    u64,  // nft_id
    OptionQuery,
>;
```

### 2.3 开发任务

| 序号 | 任务 | 预计时间 | 依赖 |
|------|------|----------|------|
| 2.3.1 | 创建 Cargo.toml，添加 divination-common 依赖 | 1h | Phase 1 |
| 2.3.2 | 复制 meihua-nft 代码到 divination-nft | 1h | - |
| 2.3.3 | 重构 types.rs：HexagramNft → DivinationNft | 3h | 2.3.2 |
| 2.3.4 | 重构 Config trait：添加 DivinationProvider | 2h | 2.3.3 |
| 2.3.5 | 重构存储：添加 DivinationType 维度 | 4h | 2.3.4 |
| 2.3.6 | 重构 mint.rs：支持多类型铸造 | 4h | 2.3.5 |
| 2.3.7 | 重构 trade.rs：交易逻辑泛化 | 3h | 2.3.5 |
| 2.3.8 | 重构 collection.rs：收藏集泛化 | 2h | 2.3.5 |
| 2.3.9 | 重构 mock.rs：MockDivinationProvider | 4h | 2.3.6 |
| 2.3.10 | 重构测试用例 | 6h | 2.3.9 |
| 2.3.11 | 编写数据迁移脚本 | 4h | 2.3.10 |
| 2.3.12 | 编写基准测试 | 3h | 2.3.10 |

### 2.4 关键代码变更示例

```rust
// 旧: mint 函数
pub fn mint(
    origin: OriginFor<T>,
    hexagram_id: u64,  // 仅梅花
    // ...
) -> DispatchResult

// 新: mint 函数
pub fn mint(
    origin: OriginFor<T>,
    divination_type: DivinationType,  // 支持多类型
    result_id: u64,
    // ...
) -> DispatchResult {
    // 验证占卜结果存在
    ensure!(
        T::DivinationProvider::result_exists(divination_type, result_id),
        Error::<T>::DivinationResultNotFound
    );

    // 验证未被铸造
    ensure!(
        T::DivinationProvider::is_nftable(divination_type, result_id),
        Error::<T>::AlreadyMinted
    );

    // 获取创建者
    let creator = T::DivinationProvider::result_creator(divination_type, result_id)
        .ok_or(Error::<T>::DivinationResultNotFound)?;

    // 计算稀有度
    let rarity_input = T::DivinationProvider::rarity_data(divination_type, result_id)
        .ok_or(Error::<T>::RarityDataNotAvailable)?;
    let rarity = rarity_input.calculate_rarity();

    // ... 铸造逻辑
}
```

### 2.5 Phase 2 验收标准

- [ ] `cargo check -p pallet-divination-nft` 编译通过
- [ ] `cargo test -p pallet-divination-nft` 所有测试通过（≥20 个）
- [ ] 支持 DivinationType::Meihua 铸造
- [ ] 支持 DivinationType::Bazi 铸造（mock 测试）
- [ ] 数据迁移脚本编写完成
- [ ] 基准测试通过

---

## Phase 3: AI 模块重构 (Week 4-5)

### 3.1 创建 pallet-divination-ai

**文件清单**:
```
pallets/divination-ai/
├── Cargo.toml
└── src/
    ├── lib.rs              # 主模块 + dispatchables
    ├── types.rs            # 请求、结果、预言机结构体
    ├── oracle.rs           # 预言机管理
    ├── request.rs          # 请求生命周期
    ├── dispute.rs          # 争议处理
    ├── fee.rs              # 费用分配
    ├── weights.rs
    ├── mock.rs
    ├── tests.rs
    └── benchmarking.rs
```

### 3.2 存储结构变更

**旧结构**:
```rust
pub struct InterpretationRequest {
    pub hexagram_id: u64,
    // ...
}
```

**新结构**:
```rust
pub struct InterpretationRequest {
    pub divination_type: DivinationType,
    pub result_id: u64,
    // ...
}

// 按类型索引请求
#[pallet::storage]
pub type RequestsByType<T> = StorageDoubleMap<
    _,
    Blake2_128Concat, DivinationType,
    Blake2_128Concat, u64,  // result_id
    Vec<u64>,  // request_ids
    ValueQuery,
>;
```

### 3.3 开发任务

| 序号 | 任务 | 预计时间 | 依赖 |
|------|------|----------|------|
| 3.3.1 | 创建 Cargo.toml | 1h | Phase 1 |
| 3.3.2 | 复制 meihua-ai 代码 | 1h | - |
| 3.3.3 | 重构 types.rs | 4h | 3.3.2 |
| 3.3.4 | 重构 Config trait | 2h | 3.3.3 |
| 3.3.5 | 重构存储结构 | 4h | 3.3.4 |
| 3.3.6 | 重构 request.rs：请求生命周期 | 4h | 3.3.5 |
| 3.3.7 | 重构 oracle.rs：预言机管理 | 3h | 3.3.5 |
| 3.3.8 | 重构 dispute.rs：争议处理 | 3h | 3.3.5 |
| 3.3.9 | 重构 fee.rs：费用分配 | 2h | 3.3.5 |
| 3.3.10 | 添加 InterpretationContextGenerator trait | 4h | 3.3.6 |
| 3.3.11 | 重构 mock.rs | 4h | 3.3.10 |
| 3.3.12 | 重构测试用例 | 6h | 3.3.11 |
| 3.3.13 | 编写数据迁移脚本 | 4h | 3.3.12 |
| 3.3.14 | 编写基准测试 | 3h | 3.3.12 |

### 3.4 新增 trait: InterpretationContextGenerator

```rust
/// AI 解读上下文生成器
/// 各玄学系统实现此 trait 以生成专用的 AI prompt 上下文
pub trait InterpretationContextGenerator {
    /// 生成 AI 解读的上下文 JSON
    fn generate_context(
        divination_type: DivinationType,
        result_id: u64,
        interpretation_type: InterpretationType,
    ) -> Option<Vec<u8>>;

    /// 获取支持的解读类型
    fn supported_interpretation_types(
        divination_type: DivinationType,
    ) -> Vec<InterpretationType>;
}
```

### 3.5 Phase 3 验收标准

- [ ] `cargo check -p pallet-divination-ai` 编译通过
- [ ] `cargo test -p pallet-divination-ai` 所有测试通过（≥25 个）
- [ ] 支持多类型占卜结果的 AI 解读请求
- [ ] 预言机系统正常工作
- [ ] 争议处理流程完整
- [ ] 数据迁移脚本编写完成

---

## Phase 4: Market 模块重构 (Week 6-7)

### 4.1 创建 pallet-divination-market

**文件清单**:
```
pallets/divination-market/
├── Cargo.toml
└── src/
    ├── lib.rs              # 主模块 + dispatchables
    ├── types.rs            # Provider, Package, Order, Review
    ├── provider.rs         # 提供者管理
    ├── package.rs          # 服务套餐
    ├── order.rs            # 订单管理
    ├── review.rs           # 评价系统
    ├── settlement.rs       # 结算与提现
    ├── weights.rs
    ├── mock.rs
    ├── tests.rs
    └── benchmarking.rs
```

### 4.2 存储结构变更

**新增字段**:
```rust
pub struct Order {
    pub divination_type: DivinationType,  // 新增
    pub result_id: u64,                   // 原 hexagram_id
    // ...
}

pub struct ServicePackage {
    pub supported_types: Vec<DivinationType>,  // 新增：支持的占卜类型
    // ...
}
```

### 4.3 开发任务

| 序号 | 任务 | 预计时间 | 依赖 |
|------|------|----------|------|
| 4.3.1 | 创建 Cargo.toml | 1h | Phase 1 |
| 4.3.2 | 复制 meihua-market 代码 | 1h | - |
| 4.3.3 | 重构 types.rs | 4h | 4.3.2 |
| 4.3.4 | 重构 Config trait | 2h | 4.3.3 |
| 4.3.5 | 重构存储结构 | 4h | 4.3.4 |
| 4.3.6 | 重构 provider.rs | 3h | 4.3.5 |
| 4.3.7 | 重构 package.rs：添加类型过滤 | 4h | 4.3.5 |
| 4.3.8 | 重构 order.rs | 4h | 4.3.5 |
| 4.3.9 | 重构 review.rs | 2h | 4.3.5 |
| 4.3.10 | 重构 settlement.rs | 3h | 4.3.5 |
| 4.3.11 | 重构 mock.rs | 4h | 4.3.10 |
| 4.3.12 | 重构测试用例 | 6h | 4.3.11 |
| 4.3.13 | 编写数据迁移脚本 | 4h | 4.3.12 |
| 4.3.14 | 编写基准测试 | 3h | 4.3.12 |

### 4.4 服务套餐类型过滤

```rust
/// 创建服务套餐时指定支持的占卜类型
pub fn create_package(
    origin: OriginFor<T>,
    service_type: ServiceType,
    supported_divination_types: Vec<DivinationType>,  // 新增
    name: BoundedVec<u8, T::MaxNameLength>,
    price: BalanceOf<T>,
    // ...
) -> DispatchResult {
    // 验证至少支持一种类型
    ensure!(!supported_divination_types.is_empty(), Error::<T>::NoSupportedTypes);
    // ...
}

/// 创建订单时验证类型匹配
pub fn create_order(
    origin: OriginFor<T>,
    provider: T::AccountId,
    divination_type: DivinationType,
    result_id: u64,
    package_id: u32,
    // ...
) -> DispatchResult {
    let package = Packages::<T>::get(&provider, package_id)
        .ok_or(Error::<T>::PackageNotFound)?;

    // 验证套餐支持该占卜类型
    ensure!(
        package.supported_divination_types.contains(&divination_type),
        Error::<T>::DivinationTypeNotSupported
    );
    // ...
}
```

### 4.5 Phase 4 验收标准

- [ ] `cargo check -p pallet-divination-market` 编译通过
- [ ] `cargo test -p pallet-divination-market` 所有测试通过（≥30 个）
- [ ] 服务提供者可指定支持的占卜类型
- [ ] 订单创建时正确验证类型
- [ ] 评价系统正常工作
- [ ] 结算提现流程完整

---

## Phase 5: Runtime 集成 (Week 8)

### 5.1 实现 DivinationProvider

**任务列表**:

| 序号 | 任务 | 预计时间 |
|------|------|----------|
| 5.1.1 | 实现 MeihuaDivinationProvider | 4h |
| 5.1.2 | 实现 BaziDivinationProvider | 4h |
| 5.1.3 | 实现 CombinedDivinationProvider | 3h |
| 5.1.4 | 实现 MeihuaContextGenerator | 3h |
| 5.1.5 | 实现 BaziContextGenerator | 3h |

### 5.2 Runtime 配置

```rust
// runtime/src/configs/mod.rs

// 配置 divination-nft
impl pallet_divination_nft::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type NftCurrency = Balances;
    type DivinationProvider = CombinedDivinationProvider;
    type BaseMintFee = ConstU128<{ 10 * UNIT }>;
    type PlatformFeeRate = ConstU16<250>;  // 2.5%
    type MaxRoyaltyRate = ConstU16<2500>;  // 25%
    type MaxCidLength = ConstU32<128>;
    type MaxNameLength = ConstU32<64>;
    type MaxNftsPerAccount = ConstU32<1000>;
    type MaxOffersPerNft = ConstU32<100>;
    type MaxCollectionsPerAccount = ConstU32<50>;
    type PlatformAccount = TreasuryPalletId;
    type GovernanceOrigin = EnsureRoot<AccountId>;
    type WeightInfo = pallet_divination_nft::weights::SubstrateWeight<Runtime>;
}

// 配置 divination-ai
impl pallet_divination_ai::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type Currency = Balances;
    type DivinationProvider = CombinedDivinationProvider;
    type ContextGenerator = CombinedContextGenerator;
    type BaseInterpretationFee = ConstU128<{ 10 * UNIT }>;
    type MinOracleStake = ConstU128<{ 1000 * UNIT }>;
    type RequestTimeout = ConstU32<{ 10 * MINUTES }>;
    type ProcessingTimeout = ConstU32<{ 30 * MINUTES }>;
    type DisputePeriod = ConstU32<{ 7 * DAYS }>;
    type MaxCidLength = ConstU32<128>;
    type MaxOracles = ConstU32<100>;
    type TreasuryAccount = TreasuryPalletId;
    type GovernanceOrigin = EnsureRoot<AccountId>;
    type ArbitratorOrigin = EnsureSigned<AccountId>;
    type WeightInfo = pallet_divination_ai::weights::SubstrateWeight<Runtime>;
}

// 配置 divination-market
impl pallet_divination_market::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type Currency = Balances;
    type DivinationProvider = CombinedDivinationProvider;
    type MinDeposit = ConstU128<{ 100 * UNIT }>;
    type MinServicePrice = ConstU128<{ 1 * UNIT }>;
    type OrderTimeout = ConstU32<{ 24 * HOURS }>;
    type AcceptTimeout = ConstU32<{ 2 * HOURS }>;
    type ReviewPeriod = ConstU32<{ 7 * DAYS }>;
    type WithdrawalCooldown = ConstU32<{ 3 * DAYS }>;
    type PlatformFeeRate = ConstU16<500>;  // 5%
    type MaxPackagesPerProvider = ConstU32<20>;
    type MaxSpecialties = ConstU32<10>;
    type PlatformAccount = TreasuryPalletId;
    type GovernanceOrigin = EnsureRoot<AccountId>;
    type WeightInfo = pallet_divination_market::weights::SubstrateWeight<Runtime>;
}
```

### 5.3 Pallet 注册

```rust
// runtime/src/lib.rs

#[runtime::pallet_index(80)]
pub type DivinationNft = pallet_divination_nft;

#[runtime::pallet_index(81)]
pub type DivinationAi = pallet_divination_ai;

#[runtime::pallet_index(82)]
pub type DivinationMarket = pallet_divination_market;
```

### 5.4 数据迁移执行

```rust
// runtime/src/lib.rs

type Migrations = (
    pallet_divination_nft::migrations::MigrateFromMeihuaNft<Runtime>,
    pallet_divination_ai::migrations::MigrateFromMeihuaAi<Runtime>,
    pallet_divination_market::migrations::MigrateFromMeihuaMarket<Runtime>,
);
```

### 5.5 集成测试

| 测试场景 | 涉及模块 | 预计时间 |
|---------|---------|----------|
| 梅花卦象 NFT 铸造流程 | meihua + divination-nft | 2h |
| 八字命盘 NFT 铸造流程 | bazi-chart + divination-nft | 2h |
| 梅花 AI 解读请求流程 | meihua + divination-ai | 2h |
| 八字 AI 解读请求流程 | bazi-chart + divination-ai | 2h |
| 服务市场完整订单流程 | divination-market | 3h |
| 跨类型 NFT 交易测试 | divination-nft | 2h |

### 5.6 Phase 5 验收标准

- [ ] `cargo build --release` 编译通过
- [ ] Runtime 启动正常
- [ ] 数据迁移执行成功
- [ ] 所有集成测试通过
- [ ] 链上交易正常执行

---

## Phase 6: 前端适配 (Week 9-10)

### 6.1 TypeScript 类型更新

**新增文件**: `stardust-dapp/src/types/divination.ts`

```typescript
// 占卜类型
export enum DivinationType {
  Meihua = 0,
  Bazi = 1,
  Liuyao = 2,
  Qimen = 3,
  Ziwei = 4,
}

// 通用 NFT 类型
export interface DivinationNft {
  id: number;
  divinationType: DivinationType;
  resultId: number;
  owner: string;
  creator: string;
  rarity: Rarity;
  // ...
}

// 通用解读请求
export interface InterpretationRequest {
  id: number;
  divinationType: DivinationType;
  resultId: number;
  // ...
}
```

### 6.2 服务层重构

**新增文件**: `stardust-dapp/src/services/divinationService.ts`

```typescript
// 通用 NFT 服务
export async function mintDivinationNft(
  divinationType: DivinationType,
  resultId: number,
  name: string,
  metadataCid: string,
  royaltyRate: number
): Promise<number> {
  const api = await getSignedApi();
  const tx = api.tx.divinationNft.mint(
    divinationType,
    resultId,
    // ...
  );
  // ...
}

// 通用 AI 解读服务
export async function requestAiInterpretation(
  divinationType: DivinationType,
  resultId: number,
  interpretationType: InterpretationType
): Promise<number> {
  // ...
}

// 通用市场服务
export async function createMarketOrder(
  divinationType: DivinationType,
  resultId: number,
  providerId: string,
  packageId: number
): Promise<number> {
  // ...
}
```

### 6.3 组件泛化

**通用组件目录**:
```
stardust-dapp/src/features/divination/
├── components/
│   ├── NftCard.tsx           # 通用 NFT 卡片
│   ├── NftMarket.tsx         # 通用 NFT 市场
│   ├── AiInterpretation.tsx  # 通用 AI 解读
│   ├── ServiceMarket.tsx     # 通用服务市场
│   └── RarityBadge.tsx       # 稀有度标签
├── hooks/
│   ├── useDivinationNft.ts
│   ├── useDivinationAi.ts
│   └── useDivinationMarket.ts
└── types.ts
```

**组件插槽模式**:

```tsx
// NftCard.tsx - 通用卡片组件
interface NftCardProps {
  nft: DivinationNft;
  renderPreview: (type: DivinationType, resultId: number) => React.ReactNode;
}

export const NftCard: React.FC<NftCardProps> = ({ nft, renderPreview }) => {
  return (
    <Card>
      {renderPreview(nft.divinationType, nft.resultId)}
      <RarityBadge rarity={nft.rarity} />
      {/* ... */}
    </Card>
  );
};

// 梅花预览组件
export const MeihuaPreview: React.FC<{ resultId: number }> = ({ resultId }) => {
  const hexagram = useMeihuaHexagram(resultId);
  return (
    <div className="hexagram-display">
      <span>{TRIGRAM_SYMBOLS[hexagram.upperTrigram]}</span>
      <span>{TRIGRAM_SYMBOLS[hexagram.lowerTrigram]}</span>
    </div>
  );
};

// 八字预览组件
export const BaziPreview: React.FC<{ resultId: number }> = ({ resultId }) => {
  const chart = useBaziChart(resultId);
  return (
    <div className="bazi-pillars">
      <Pillar label="年" ganzhi={chart.yearPillar} />
      <Pillar label="月" ganzhi={chart.monthPillar} />
      <Pillar label="日" ganzhi={chart.dayPillar} />
      <Pillar label="时" ganzhi={chart.hourPillar} />
    </div>
  );
};

// 使用示例
<NftCard
  nft={nft}
  renderPreview={(type, id) => {
    switch (type) {
      case DivinationType.Meihua:
        return <MeihuaPreview resultId={id} />;
      case DivinationType.Bazi:
        return <BaziPreview resultId={id} />;
      default:
        return <DefaultPreview />;
    }
  }}
/>
```

### 6.4 路由更新

```typescript
// routes.tsx 新增路由

// 通用占卜模块
{ match: h => h === '#/divination/nft', component: lazy(() => import('./features/divination/NftMarketPage')) },
{ match: h => h === '#/divination/my-nft', component: lazy(() => import('./features/divination/MyNftPage')) },
{ match: h => h === '#/divination/market', component: lazy(() => import('./features/divination/ServiceMarketPage')) },

// 八字模块扩展
{ match: h => h === '#/bazi/nft', component: lazy(() => import('./features/bazi/BaziNftPage')) },
{ match: h => h === '#/bazi/ai', component: lazy(() => import('./features/bazi/BaziAiPage')) },
{ match: h => h === '#/bazi/market', component: lazy(() => import('./features/bazi/BaziMarketPage')) },
```

### 6.5 开发任务

| 序号 | 任务 | 预计时间 |
|------|------|----------|
| 6.5.1 | 创建 divination.ts 类型定义 | 3h |
| 6.5.2 | 创建 divinationService.ts | 6h |
| 6.5.3 | 更新 meihuaService.ts（适配新接口） | 4h |
| 6.5.4 | 创建 baziService.ts | 4h |
| 6.5.5 | 创建通用 NftCard 组件 | 4h |
| 6.5.6 | 创建通用 NftMarket 组件 | 6h |
| 6.5.7 | 创建通用 AiInterpretation 组件 | 5h |
| 6.5.8 | 创建通用 ServiceMarket 组件 | 6h |
| 6.5.9 | 创建 MeihuaPreview 组件 | 2h |
| 6.5.10 | 创建 BaziPreview 组件 | 3h |
| 6.5.11 | 创建八字 NFT 页面 | 4h |
| 6.5.12 | 创建八字 AI 解读页面 | 4h |
| 6.5.13 | 创建八字服务市场页面 | 4h |
| 6.5.14 | 更新路由配置 | 1h |
| 6.5.15 | 端到端测试 | 8h |
| 6.5.16 | UI 调整和 bug 修复 | 8h |

### 6.6 Phase 6 验收标准

- [ ] `npm run build` 构建成功
- [ ] TypeScript 类型检查通过
- [ ] 梅花 NFT 功能正常
- [ ] 八字 NFT 功能正常
- [ ] 梅花 AI 解读功能正常
- [ ] 八字 AI 解读功能正常
- [ ] 服务市场功能正常
- [ ] 移动端适配良好

---

## 风险缓解清单

| 风险 | 缓解措施 | 负责阶段 |
|------|---------|---------|
| 数据迁移失败 | 完整备份 + 回滚脚本 | Phase 5 |
| 接口不兼容 | API 版本管理 | Phase 6 |
| 性能下降 | 基准测试 + 优化 | Phase 2-4 |
| 测试覆盖不足 | 严格代码审查 | 全阶段 |

---

## 里程碑总结

| 里程碑 | 完成时间 | 交付物 |
|--------|---------|--------|
| M1 | Week 3 | divination-common + divination-nft |
| M2 | Week 5 | divination-ai |
| M3 | Week 7 | divination-market |
| M4 | Week 8 | Runtime 集成完成 |
| M5 | Week 10 | 前端适配完成，项目交付 |

---

*开发步骤规划文档结束*
