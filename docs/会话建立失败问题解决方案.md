# ä¼šè¯å»ºç«‹å¤±è´¥é—®é¢˜è§£å†³æ–¹æ¡ˆ

> âš ï¸ **æ–‡æ¡£çŠ¶æ€ï¼šå·²è¿‡æ—¶**  
> æœ¬é—®é¢˜å·²é€šè¿‡**æ¶æ„å˜æ›´**å½»åº•è§£å†³ï¼ˆ2025-11-08ï¼‰  
> æ–°æ¶æ„ä¸å†ä¾èµ–è‡ªå®šä¹‰åç«¯ï¼ˆ8787ç«¯å£ï¼‰ï¼Œæ”¹ä¸ºçº¯å‰ç«¯+é“¾ä¸Šå®ç°  
> è¯¦è§ï¼š[æ¶æ„å˜æ›´-ç§»é™¤è‡ªå®šä¹‰åç«¯.md](./æ¶æ„å˜æ›´-ç§»é™¤è‡ªå®šä¹‰åç«¯.md)

---

## ğŸ“‹ é—®é¢˜æè¿°ï¼ˆå†å²è®°å½•ï¼‰

åœ¨ä½¿ç”¨æ¢å¤é’±åŒ…åŠŸèƒ½æ—¶ï¼Œç”¨æˆ·é‡åˆ°é”™è¯¯æç¤ºï¼š**"ä¼šè¯å»ºç«‹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"**

### é”™è¯¯æˆªå›¾ä½ç½®
- é¡µé¢ï¼šæ¢å¤é’±åŒ…é¡µé¢ (`RestoreWalletPage`)
- è§¦å‘æ—¶æœºï¼šå¡«å†™å®ŒåŠ©è®°è¯å’Œå¯†ç ï¼Œç‚¹å‡»"æ¢å¤é’±åŒ…"æŒ‰é’®å
- é”™è¯¯ç±»å‹ï¼šä¼šè¯åˆ›å»ºå¤±è´¥

### âœ… å·²è§£å†³
**è§£å†³æ–¹æ¡ˆ**: ç§»é™¤å¯¹è‡ªå®šä¹‰åç«¯çš„ä¾èµ–ï¼Œæ”¹ä¸ºçº¯å‰ç«¯ä¼šè¯ç®¡ç†  
**å®æ–½æ—¥æœŸ**: 2025-11-08  
**çŠ¶æ€**: é—®é¢˜å·²å½»åº•è§£å†³ï¼Œæœ¬æ–‡æ¡£ä¿ç•™ä½œä¸ºå†å²å‚è€ƒ

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. æŠ€æœ¯æ ˆæ¶æ„

Stardust DApp é‡‡ç”¨å‰åç«¯åˆ†ç¦»æ¶æ„ï¼š
- **å‰ç«¯**: React + TypeScript + Vite (ç«¯å£ 5173)
- **åŒºå—é“¾èŠ‚ç‚¹**: Substrate (ç«¯å£ 9944)
- **åç«¯æœåŠ¡å™¨**: ä¼šè¯ç®¡ç†å’Œè®¤è¯ (ç«¯å£ 8787)

### 2. ä¼šè¯å»ºç«‹æµç¨‹

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant Frontend as å‰ç«¯
    participant Backend as åç«¯æœåŠ¡å™¨
    participant Chain as åŒºå—é“¾èŠ‚ç‚¹
    
    User->>Frontend: å¡«å†™åŠ©è®°è¯å’Œå¯†ç 
    User->>Frontend: ç‚¹å‡»"æ¢å¤é’±åŒ…"
    Frontend->>Frontend: éªŒè¯åŠ©è®°è¯æ ¼å¼
    Frontend->>Chain: æ´¾ç”Ÿé’±åŒ…åœ°å€
    Chain-->>Frontend: è¿”å›åœ°å€
    Frontend->>Frontend: åŠ å¯†ä¿å­˜åˆ°æœ¬åœ°
    Frontend->>Backend: è¯·æ±‚ä¼šè¯æŒ‘æˆ˜ (GET /challenge)
    Backend-->>Frontend: è¿”å›æŒ‘æˆ˜æ¶ˆæ¯
    Frontend->>Frontend: ä½¿ç”¨ç§é’¥ç­¾åæŒ‘æˆ˜
    Frontend->>Backend: éªŒè¯ç­¾å (POST /verify)
    Backend-->>Frontend: è¿”å› sessionId
    Frontend->>Frontend: ä¿å­˜ä¼šè¯çŠ¶æ€
    Frontend->>User: ç™»å½•æˆåŠŸï¼Œè·³è½¬ä¸»é¡µ
```

### 3. é”™è¯¯å‘ç”Ÿç‚¹

**é—®é¢˜**: åç«¯æœåŠ¡å™¨ (http://127.0.0.1:8787) **æœªè¿è¡Œ**

æ‰§è¡Œæµç¨‹ï¼š
```
sessionManager.createSession(address)
  â””â”€> handshakeWithBackend(address)
      â””â”€> fetch('http://127.0.0.1:8787/challenge')
          â””â”€> âŒ è¿æ¥å¤±è´¥ (ECONNREFUSED)
          â””â”€> è¿”å› { error: 'NETWORK_UNREACHABLE' }
  â””â”€> æ£€æŸ¥ result?.sessionId
      â””â”€> âŒ sessionId ä¸ºç©º
  â””â”€> æ£€æŸ¥å¼€å‘æ¨¡å¼
      â””â”€> import.meta.env.DEV = undefined
      â””â”€> import.meta.env.VITE_ALLOW_DEV_SESSION = undefined
      â””â”€> âŒ ä¸åˆ›å»º dev session
  â””â”€> è¿”å› null
  
RestoreWalletPage.handleRestore()
  â””â”€> session === null
  â””â”€> å†æ¬¡æ£€æŸ¥å¼€å‘æ¨¡å¼ âŒ å¤±è´¥
  â””â”€> æŠ›å‡ºé”™è¯¯: "ä¼šè¯å»ºç«‹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"
```

## è§£å†³æ–¹æ¡ˆ

### âœ… æ–¹æ¡ˆä¸€ï¼šå¯ç”¨å¼€å‘æ¨¡å¼ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**: å¼€å‘ã€æµ‹è¯•ç¯å¢ƒï¼Œåç«¯æœåŠ¡å™¨æš‚æœªéƒ¨ç½²

**æ­¥éª¤**:

1. åœ¨å‰ç«¯é¡¹ç›®æ ¹ç›®å½•åˆ›å»º `.env` æ–‡ä»¶ï¼ˆå·²å®Œæˆï¼‰:

```bash
cd /home/xiaodong/æ–‡æ¡£/stardust/stardust-dapp
cat .env
```

2. é‡å¯å‰ç«¯å¼€å‘æœåŠ¡å™¨:

```bash
# å…ˆåœæ­¢å½“å‰è¿è¡Œçš„æœåŠ¡å™¨ (Ctrl+C)
npm run dev
```

3. æµ‹è¯•ç™»å½•åŠŸèƒ½:
   - è®¿é—® http://localhost:5173
   - ç‚¹å‡»"æ¢å¤é’±åŒ…"
   - å¡«å†™åŠ©è®°è¯ï¼ˆ12æˆ–24ä¸ªè¯ï¼‰å’Œå¯†ç 
   - ç‚¹å‡»"æ¢å¤é’±åŒ…"æŒ‰é’®
   - æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ç¡®è®¤ä½¿ç”¨äº† dev session

**å¼€å‘æ¨¡å¼ä¼šè¯ç‰¹å¾**:
- `sessionId` æ ¼å¼: `dev-{address}-{timestamp}`
- `allowances.mock = true` (è¡¨ç¤ºæ¨¡æ‹Ÿæˆæƒ)
- 24å°æ—¶æœ‰æ•ˆæœŸ
- ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨

### âš™ï¸ æ–¹æ¡ˆäºŒï¼šå¯åŠ¨åç«¯æœåŠ¡å™¨

**é€‚ç”¨åœºæ™¯**: ç”Ÿäº§ç¯å¢ƒï¼Œå®Œæ•´åŠŸèƒ½æµ‹è¯•

**è¦æ±‚**:
- éœ€è¦ç‹¬ç«‹çš„åç«¯æœåŠ¡å™¨é¡¹ç›®
- å®ç°ä»¥ä¸‹ API ç«¯ç‚¹:
  - `GET /challenge?address={address}` - è·å–æŒ‘æˆ˜æ¶ˆæ¯
  - `POST /verify` - éªŒè¯ç­¾åå¹¶åˆ›å»ºä¼šè¯

**åç«¯ API è§„èŒƒ**:

1. **è·å–æŒ‘æˆ˜** (`GET /challenge`):
```json
// Request
GET /challenge?address=5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY

// Response
{
  "id": "challenge-uuid-123",
  "message": "Sign this message to authenticate: {timestamp}",
  "expiresAt": 1699876543210
}
```

2. **éªŒè¯ç­¾å** (`POST /verify`):
```json
// Request
POST /verify
{
  "address": "5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY",
  "signature": "0x123abc...",
  "challengeId": "challenge-uuid-123",
  "timestamp": 1699876543210
}

// Response (æˆåŠŸ)
{
  "sessionId": "session-uuid-456",
  "allowances": {
    "maxTransactions": 100,
    "maxAmount": "1000000000000"
  }
}

// Response (å¤±è´¥)
{
  "error": "INVALID_SIGNATURE",
  "message": "Signature verification failed"
}
```

### ğŸ”§ æ–¹æ¡ˆä¸‰ï¼šå‰ç«¯ä»£ç ä¼˜åŒ–ï¼ˆå¤‡é€‰ï¼‰

å¦‚æœé¡¹ç›®è®¡åˆ’é•¿æœŸä½¿ç”¨å¼€å‘æ¨¡å¼ï¼Œå¯ä»¥ä¼˜åŒ–ä»£ç é€»è¾‘ï¼š

**ä¿®æ”¹ `RestoreWalletPage.tsx`**:

```typescript
// åˆ›å»ºä¼šè¯ - ä¼˜åŒ–åçš„é€»è¾‘
let session = await sessionManager.createSession(addr);

// å¼€å‘ç¯å¢ƒè‡ªåŠ¨é™çº§
if (!session) {
  console.warn('ä¼šè¯åˆ›å»ºå¤±è´¥ï¼Œå°è¯•ä½¿ç”¨å¼€å‘æ¨¡å¼');
  try {
    session = sessionManager.forceCreateDevSession(addr);
    console.log('âœ… å¼€å‘æ¨¡å¼ä¼šè¯å·²åˆ›å»º');
  } catch (error) {
    console.error('å¼€å‘æ¨¡å¼ä¼šè¯åˆ›å»ºå¤±è´¥:', error);
    throw new Error('ä¼šè¯å»ºç«‹å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
  }
}

// æˆåŠŸå›è°ƒ
onSuccess?.(addr);
```

## ğŸ“Š éªŒè¯æ­¥éª¤

### 1. æ£€æŸ¥ç¯å¢ƒå˜é‡

```bash
cd /home/xiaodong/æ–‡æ¡£/stardust/stardust-dapp
cat .env | grep VITE_ALLOW_DEV_SESSION
```

åº”è¯¥è¾“å‡º: `VITE_ALLOW_DEV_SESSION=1`

### 2. æ£€æŸ¥å‰ç«¯æœåŠ¡å™¨

```bash
lsof -nP -iTCP:5173 -sTCP:LISTEN
```

åº”è¯¥æœ‰è¿›ç¨‹åœ¨ç›‘å¬ 5173 ç«¯å£

### 3. æ£€æŸ¥åŒºå—é“¾èŠ‚ç‚¹

```bash
lsof -nP -iTCP:9944 -sTCP:LISTEN
```

åº”è¯¥æœ‰è¿›ç¨‹åœ¨ç›‘å¬ 9944 ç«¯å£

### 4. æµ‹è¯•ç™»å½•æµç¨‹

æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å° (F12)ï¼Œè§‚å¯Ÿä»¥ä¸‹æ—¥å¿—ï¼š

```javascript
// æˆåŠŸçš„å¼€å‘æ¨¡å¼æ—¥å¿—
[session] createSession start {address: "5Grw..."}
[session] handshake result {error: "NETWORK_UNREACHABLE"}
[session] no sessionId, using dev fallback
[session] session created {expiresAt: 1699876543210}

// è¡¨å•çŠ¶æ€æ—¥å¿—
ğŸ” è¡¨å•çŠ¶æ€: {
  mnemonicWords: 12,
  passwordLength: 8,
  confirmPasswordLength: 8,
  passwordMatch: true,
  canSubmit: true
}
```

## ğŸ› å¸¸è§é—®é¢˜

### Q1: é‡å¯åè¿˜æ˜¯æŠ¥é”™ï¼Ÿ

**A**: ç¡®ä¿ä»¥ä¸‹å‡ ç‚¹ï¼š
1. `.env` æ–‡ä»¶åœ¨æ­£ç¡®çš„ä½ç½® (`stardust-dapp/.env`)
2. å‰ç«¯å¼€å‘æœåŠ¡å™¨å·²å®Œå…¨é‡å¯
3. æ¸…é™¤æµè§ˆå™¨ç¼“å­˜å¹¶åˆ·æ–°é¡µé¢ (Ctrl+Shift+R)

### Q2: å¼€å‘æ¨¡å¼çš„ä¼šè¯å®‰å…¨å—ï¼Ÿ

**A**: å¼€å‘æ¨¡å¼ä¼šè¯ä»…é€‚ç”¨äºå¼€å‘/æµ‹è¯•ç¯å¢ƒï¼š
- âœ… é’±åŒ…åŠ©è®°è¯ä»ç„¶åŠ å¯†ä¿å­˜åœ¨æœ¬åœ°
- âœ… ç§é’¥æ°¸ä¸ç¦»å¼€æµè§ˆå™¨
- âŒ ä¼šè¯æœªç»åç«¯éªŒè¯
- âŒ æ²¡æœ‰çœŸå®çš„æˆæƒé¢åº¦é™åˆ¶
- âš ï¸ **ä¸è¦åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨å¼€å‘æ¨¡å¼**

### Q3: å¦‚ä½•åŒºåˆ†å¼€å‘ä¼šè¯å’Œæ­£å¼ä¼šè¯ï¼Ÿ

**A**: æŸ¥çœ‹æ§åˆ¶å°æˆ–æ£€æŸ¥ sessionId æ ¼å¼ï¼š
- å¼€å‘ä¼šè¯: `dev-{address}-{timestamp}`
- æ­£å¼ä¼šè¯: åç«¯ç”Ÿæˆçš„ UUID
- æ£€æŸ¥ allowances: `{mock: true}` è¡¨ç¤ºå¼€å‘æ¨¡å¼

### Q4: åç«¯æœåŠ¡å™¨åœ¨å“ªé‡Œï¼Ÿ

**A**: å½“å‰é¡¹ç›®ä¸­**æ²¡æœ‰åŒ…å«åç«¯æœåŠ¡å™¨**çš„å®ç°ã€‚åç«¯æœåŠ¡å™¨éœ€è¦ï¼š
- ç‹¬ç«‹éƒ¨ç½²
- å®ç°æŒ‘æˆ˜-å“åº”è®¤è¯æœºåˆ¶
- æä¾›ä¼šè¯ç®¡ç†åŠŸèƒ½

å»ºè®®ä½¿ç”¨ä»¥ä¸‹æŠ€æœ¯æ ˆå¼€å‘åç«¯ï¼š
- Node.js + Express
- Python + FastAPI
- Rust + Actix-web

## ğŸ“š ç›¸å…³æ–‡ä»¶

### æ ¸å¿ƒæ–‡ä»¶

- **ä¼šè¯ç®¡ç†å™¨**: `stardust-dapp/src/lib/sessionManager.ts`
- **åç«¯æ¥å£**: `stardust-dapp/src/lib/backend.ts`
- **åº”ç”¨é…ç½®**: `stardust-dapp/src/lib/config.ts`
- **æ¢å¤é’±åŒ…é¡µé¢**: `stardust-dapp/src/features/auth/RestoreWalletPage.tsx`

### é…ç½®æ–‡ä»¶

- **ç¯å¢ƒå˜é‡**: `stardust-dapp/.env` (æ–°åˆ›å»º)
- **åŒ…é…ç½®**: `stardust-dapp/package.json`
- **Vite é…ç½®**: `stardust-dapp/vite.config.ts`

## ğŸ”„ æ›´æ–°æ—¥å¿—

### 2025-11-08
- âœ… è¯Šæ–­å¹¶å®šä½é—®é¢˜æ ¹æºï¼šåç«¯æœåŠ¡å™¨æœªè¿è¡Œ
- âœ… åˆ›å»º `.env` æ–‡ä»¶å¯ç”¨å¼€å‘æ¨¡å¼
- âœ… æ·»åŠ è°ƒè¯•æ—¥å¿—åˆ° `RestoreWalletPage.tsx`
- âœ… ç¼–å†™å®Œæ•´çš„é—®é¢˜åˆ†æå’Œè§£å†³æ–¹æ¡ˆæ–‡æ¡£

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### çŸ­æœŸï¼ˆå¼€å‘é˜¶æ®µï¼‰
- [x] å¯ç”¨å¼€å‘æ¨¡å¼ç»•è¿‡åç«¯éªŒè¯
- [ ] æµ‹è¯•å®Œæ•´çš„ç™»å½•æµç¨‹
- [ ] éªŒè¯ä¼šè¯æŒä¹…åŒ–åŠŸèƒ½
- [ ] æµ‹è¯•ä¼šè¯è¿‡æœŸå’Œè‡ªåŠ¨åˆ·æ–°

### ä¸­æœŸï¼ˆæµ‹è¯•é˜¶æ®µï¼‰
- [ ] è®¾è®¡åç«¯ API è§„èŒƒ
- [ ] å¼€å‘åç«¯è®¤è¯æœåŠ¡
- [ ] é›†æˆåç«¯æœåŠ¡åˆ°å¼€å‘ç¯å¢ƒ
- [ ] å®Œæ•´ç«¯åˆ°ç«¯æµ‹è¯•

### é•¿æœŸï¼ˆç”Ÿäº§é˜¶æ®µï¼‰
- [ ] éƒ¨ç½²åç«¯æœåŠ¡å™¨åˆ°ç”Ÿäº§ç¯å¢ƒ
- [ ] é…ç½®è´Ÿè½½å‡è¡¡å’Œå®¹é”™
- [ ] å®æ–½ä¼šè¯å®‰å…¨å®¡è®¡
- [ ] ç›‘æ§å’Œæ—¥å¿—ç³»ç»Ÿ

---

**ç»´æŠ¤è€…**: Stardust å¼€å‘å›¢é˜Ÿ  
**æ–‡æ¡£ç‰ˆæœ¬**: 1.0.0  
**æœ€åæ›´æ–°**: 2025-11-08

