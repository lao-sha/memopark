# é“¾ä¸Šä»£ä»˜ Gas - å…è´¹æ¬¡æ•°é™åˆ¶æ–¹æ¡ˆ

**æ ¸å¿ƒé—®é¢˜**ï¼šé“¾ä¸Šé¢„æˆæƒä»£ä»˜ï¼Œèƒ½å¦é™åˆ¶ä¹°å®¶çš„å…è´¹æ¬¡æ•°ï¼Ÿ

**æ—¥æœŸ**: 2025-10-22  
**ç»“è®º**: âœ… **å¯ä»¥ï¼è€Œä¸”å¼ºçƒˆæ¨èå®æ–½å¤šç§é™åˆ¶ç­–ç•¥**

---

## ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦é™åˆ¶å…è´¹æ¬¡æ•°ï¼Ÿ

### 1.1 æ ¸å¿ƒé—®é¢˜

**é£é™©åˆ†æ**ï¼š
```
å¦‚æœæ²¡æœ‰æ¬¡æ•°é™åˆ¶ï¼š
1. âŒ å•ä¸ªä¹°å®¶å¯ä»¥æ— é™åˆ›å»ºè®¢å•ï¼ˆåˆ·å•ï¼‰
2. âŒ åšå¸‚å•†ä»£ä»˜æ± å¿«é€Ÿè€—å°½
3. âŒ æ­£å¸¸ä¹°å®¶æ— æ³•äº«å—å…è´¹æœåŠ¡
4. âŒ åšå¸‚å•†æ‰¿æ‹…å·¨å¤§é£é™©
```

**å®é™…åœºæ™¯**ï¼š
```
å‡è®¾åšå¸‚å•†å……å€¼ 1000 DUSTï¼š
- å•ç¬” Gas: 0.01 DUST
- å¯åˆ›å»ºè®¢å•æ•°: 100,000 ç¬”

å¦‚æœæ¶æ„ä¹°å®¶åˆ·å•ï¼š
- æ¯åˆ†é’Ÿåˆ›å»º 10 ç¬”è®¢å•
- 1 å°æ—¶è€—å°½: 10 * 60 / 100,000 = 0.6% é¢åº¦
- 7 å¤©è€—å°½: 10 * 60 * 24 * 7 = 100,800 ç¬” > 100,000

ç»“è®ºï¼šå¿…é¡»é™åˆ¶å•ä¸ªä¹°å®¶çš„å…è´¹æ¬¡æ•°ï¼
```

---

### 1.2 é˜²æŠ¤ç›®æ ‡

**éœ€è¦é˜²æŠ¤çš„åœºæ™¯**ï¼š
1. âœ… æ¶æ„åˆ·å•ï¼ˆå•ä¸ªä¹°å®¶å¤§é‡åˆ›å»ºè®¢å•ï¼‰
2. âœ… æ‰¹é‡è´¦æˆ·æ”»å‡»ï¼ˆåˆ›å»ºå¤§é‡è´¦æˆ·ï¼Œæ¯ä¸ªè´¦æˆ·åˆ·ä¸€æ¬¡ï¼‰
3. âœ… èµ„æºå…¬å¹³åˆ†é…ï¼ˆç¡®ä¿æ›´å¤šäººèƒ½äº«å—å…è´¹æœåŠ¡ï¼‰
4. âœ… åšå¸‚å•†æˆæœ¬å¯æ§ï¼ˆé¢„ç®—å¯é¢„æµ‹ï¼‰

---

## äºŒã€å…è´¹æ¬¡æ•°é™åˆ¶ç­–ç•¥

### ğŸ¯ ç­–ç•¥ Aï¼šå›ºå®šæ¬¡æ•°é™åˆ¶ï¼ˆæ¨èâ­â­â­â­â­ï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼š
- æ¯ä¸ªä¹°å®¶å¯¹æ¯ä¸ªåšå¸‚å•†æœ‰å›ºå®šçš„å…è´¹æ¬¡æ•°ï¼ˆå¦‚ 3 æ¬¡ï¼‰
- ç”¨å®Œåéœ€è¦è‡ªå·±æ”¯ä»˜ Gas
- ç®€å•ã€å¯æ§ã€å…¬å¹³

**æŠ€æœ¯å®ç°**ï¼š

```rust
// pallets/market-maker/src/lib.rs

/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šä¹°å®¶å…è´¹è®¢å•é…é¢
/// - è®°å½•æ¯ä¸ªä¹°å®¶å¯¹æ¯ä¸ªåšå¸‚å•†å¯äº«å—çš„å…è´¹æ¬¡æ•°
/// - æ¯æ¬¡åˆ›å»ºå…è´¹è®¢å•æ—¶é€’å‡
/// - ç”¨å®Œåä¹°å®¶éœ€è¦è‡ªå·±æ”¯ä»˜ Gas
/// 
/// å­˜å‚¨ç»“æ„ï¼š(åšå¸‚å•†ID, ä¹°å®¶è´¦æˆ·) => å‰©ä½™å…è´¹æ¬¡æ•°
#[pallet::storage]
#[pallet::getter(fn free_order_quota)]
pub type FreeOrderQuota<T: Config> = StorageDoubleMap<
    _,
    Blake2_128Concat,
    u64,  // maker_id
    Blake2_128Concat,
    T::AccountId,  // buyer
    u32,  // å‰©ä½™å…è´¹æ¬¡æ•°
    ValueQuery,
>;

/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šåšå¸‚å•†å…è´¹æ¬¡æ•°é…ç½®
/// - åšå¸‚å•†å¯ä»¥è®¾ç½®æ¯ä¸ªæ–°ä¹°å®¶çš„åˆå§‹å…è´¹æ¬¡æ•°
/// - é»˜è®¤ä¸º 3 æ¬¡
#[pallet::storage]
#[pallet::getter(fn free_order_quota_config)]
pub type FreeOrderQuotaConfig<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u64,  // maker_id
    u32,  // åˆå§‹å…è´¹æ¬¡æ•°
    ValueQuery,
>;

#[pallet::call]
impl<T: Config> Pallet<T> {
    /// åšå¸‚å•†è®¾ç½®å…è´¹æ¬¡æ•°é…é¢
    /// 
    /// # å‚æ•°
    /// - `origin`: åšå¸‚å•†ç­¾å
    /// - `maker_id`: åšå¸‚å•† ID
    /// - `quota`: æ¯ä¸ªæ–°ä¹°å®¶çš„å…è´¹æ¬¡æ•°ï¼ˆå¦‚ 3ï¼‰
    /// 
    /// # åŠŸèƒ½è¯¦ç»†ä¸­æ–‡æ³¨é‡Š
    /// åšå¸‚å•†å¯ä»¥è®¾ç½®æ¯ä¸ªæ–°ä¹°å®¶å¯ä»¥äº«å—çš„å…è´¹è®¢å•æ¬¡æ•°ã€‚
    /// è®¾ç½®ä¸º 0 è¡¨ç¤ºä¸æä¾›å…è´¹æœåŠ¡ã€‚
    /// 
    /// # æƒé‡
    /// - è¯»å–ï¼š1ï¼ˆåšå¸‚å•†éªŒè¯ï¼‰
    /// - å†™å…¥ï¼š1ï¼ˆé…é¢é…ç½®ï¼‰
    #[pallet::call_index(32)]
    #[pallet::weight(T::DbWeight::get().reads_writes(1, 1))]
    pub fn set_free_quota(
        origin: OriginFor<T>,
        maker_id: u64,
        quota: u32,
    ) -> DispatchResult {
        let who = ensure_signed(origin)?;
        
        // éªŒè¯æ˜¯è¯¥åšå¸‚å•†
        let maker_info = Self::get_maker(maker_id)
            .ok_or(Error::<T>::MakerNotFound)?;
        ensure!(maker_info.account == who, Error::<T>::NotMaker);
        
        // è®¾ç½®é…é¢
        FreeOrderQuotaConfig::<T>::insert(maker_id, quota);
        
        Self::deposit_event(Event::FreeQuotaSet {
            maker_id,
            quota,
        });
        
        Ok(())
    }
    
    /// åšå¸‚å•†ä¸ºç‰¹å®šä¹°å®¶å¢åŠ å…è´¹æ¬¡æ•°
    /// 
    /// # å‚æ•°
    /// - `origin`: åšå¸‚å•†ç­¾å
    /// - `maker_id`: åšå¸‚å•† ID
    /// - `buyer`: ä¹°å®¶è´¦æˆ·
    /// - `additional_quota`: å¢åŠ çš„å…è´¹æ¬¡æ•°
    /// 
    /// # åŠŸèƒ½è¯¦ç»†ä¸­æ–‡æ³¨é‡Š
    /// åšå¸‚å•†å¯ä»¥ä¸ºä¼˜è´¨ä¹°å®¶æˆ–ç‰¹æ®Šåœºæ™¯å¢åŠ é¢å¤–çš„å…è´¹æ¬¡æ•°ã€‚
    /// ä¾‹å¦‚ï¼šä¸ºæ¨å¹¿æ´»åŠ¨çš„ç”¨æˆ·å¢åŠ  5 æ¬¡å…è´¹æœºä¼šã€‚
    #[pallet::call_index(33)]
    #[pallet::weight(T::DbWeight::get().reads_writes(1, 1))]
    pub fn grant_free_quota(
        origin: OriginFor<T>,
        maker_id: u64,
        buyer: AccountIdLookupOf<T>,
        additional_quota: u32,
    ) -> DispatchResult {
        let who = ensure_signed(origin)?;
        let buyer = T::Lookup::lookup(buyer)?;
        
        // éªŒè¯æ˜¯è¯¥åšå¸‚å•†
        let maker_info = Self::get_maker(maker_id)
            .ok_or(Error::<T>::MakerNotFound)?;
        ensure!(maker_info.account == who, Error::<T>::NotMaker);
        
        // å¢åŠ é…é¢
        FreeOrderQuota::<T>::mutate(maker_id, &buyer, |quota| {
            *quota = quota.saturating_add(additional_quota);
        });
        
        Self::deposit_event(Event::FreeQuotaGranted {
            maker_id,
            buyer,
            additional_quota,
        });
        
        Ok(())
    }
}

impl<T: Config> Pallet<T> {
    /// æ£€æŸ¥å¹¶æ¶ˆè´¹ä¹°å®¶çš„å…è´¹æ¬¡æ•°
    /// 
    /// # åŠŸèƒ½è¯¦ç»†ä¸­æ–‡æ³¨é‡Š
    /// å½“ä¹°å®¶å°è¯•åˆ›å»ºå…è´¹è®¢å•æ—¶ï¼Œæ£€æŸ¥å…¶æ˜¯å¦è¿˜æœ‰å…è´¹æ¬¡æ•°é…é¢ã€‚
    /// å¦‚æœæœ‰ï¼Œåˆ™é€’å‡é…é¢ï¼›å¦‚æœæ²¡æœ‰ï¼Œåˆ™è¿”å›é”™è¯¯ã€‚
    /// 
    /// # å‚æ•°
    /// - `maker_id`: åšå¸‚å•† ID
    /// - `buyer`: ä¹°å®¶è´¦æˆ·
    /// 
    /// # è¿”å›
    /// - `Ok(true)`: æœ‰å…è´¹é…é¢ï¼Œå·²é€’å‡
    /// - `Ok(false)`: æ— å…è´¹é…é¢ï¼Œä¹°å®¶éœ€è‡ªå·±æ”¯ä»˜
    /// - `Err`: å…¶ä»–é”™è¯¯
    pub fn consume_free_quota(
        maker_id: u64,
        buyer: &T::AccountId,
    ) -> Result<bool, DispatchError> {
        // è·å–å½“å‰é…é¢
        let mut current_quota = FreeOrderQuota::<T>::get(maker_id, buyer);
        
        // å¦‚æœæ˜¯æ–°ä¹°å®¶ï¼ˆé…é¢ä¸º0ï¼‰ï¼Œåˆå§‹åŒ–é…é¢
        if current_quota == 0 {
            let default_quota = FreeOrderQuotaConfig::<T>::get(maker_id);
            if default_quota == 0 {
                // åšå¸‚å•†ä¸æä¾›å…è´¹æœåŠ¡
                return Ok(false);
            }
            current_quota = default_quota;
        }
        
        // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é…é¢
        if current_quota == 0 {
            return Ok(false);  // æ— é…é¢ï¼Œéœ€è‡ªå·±æ”¯ä»˜
        }
        
        // é€’å‡é…é¢
        FreeOrderQuota::<T>::insert(maker_id, buyer, current_quota.saturating_sub(1));
        
        Self::deposit_event(Event::FreeQuotaConsumed {
            maker_id,
            buyer: buyer.clone(),
            remaining: current_quota.saturating_sub(1),
        });
        
        Ok(true)  // æœ‰é…é¢ï¼Œå·²é€’å‡
    }
    
    /// æŸ¥è¯¢ä¹°å®¶çš„å‰©ä½™å…è´¹æ¬¡æ•°
    pub fn get_remaining_quota(
        maker_id: u64,
        buyer: &T::AccountId,
    ) -> u32 {
        let current_quota = FreeOrderQuota::<T>::get(maker_id, buyer);
        
        // å¦‚æœæ˜¯æ–°ä¹°å®¶ï¼Œè¿”å›é»˜è®¤é…é¢
        if current_quota == 0 {
            return FreeOrderQuotaConfig::<T>::get(maker_id);
        }
        
        current_quota
    }
}

#[pallet::event]
#[pallet::generate_deposit(pub(super) fn deposit_event)]
pub enum Event<T: Config> {
    // ... å…¶ä»–äº‹ä»¶
    
    /// åšå¸‚å•†è®¾ç½®å…è´¹é…é¢
    /// \[åšå¸‚å•†ID, é…é¢\]
    FreeQuotaSet {
        maker_id: u64,
        quota: u32,
    },
    
    /// åšå¸‚å•†ä¸ºä¹°å®¶å¢åŠ å…è´¹é…é¢
    /// \[åšå¸‚å•†ID, ä¹°å®¶, å¢åŠ çš„é…é¢\]
    FreeQuotaGranted {
        maker_id: u64,
        buyer: T::AccountId,
        additional_quota: u32,
    },
    
    /// ä¹°å®¶æ¶ˆè´¹å…è´¹é…é¢
    /// \[åšå¸‚å•†ID, ä¹°å®¶, å‰©ä½™é…é¢\]
    FreeQuotaConsumed {
        maker_id: u64,
        buyer: T::AccountId,
        remaining: u32,
    },
}

#[pallet::error]
pub enum Error<T> {
    // ... å…¶ä»–é”™è¯¯
    
    /// å…è´¹é…é¢å·²ç”¨å®Œ
    FreeQuotaExhausted,
}
```

---

### ğŸ¯ ç­–ç•¥ Bï¼šå‘¨æœŸæ€§é‡ç½®ï¼ˆæ¨èâ­â­â­â­â­ï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼š
- æ¯ä¸ªä¹°å®¶æ¯æœˆæœ‰å›ºå®šçš„å…è´¹æ¬¡æ•°ï¼ˆå¦‚ 5 æ¬¡/æœˆï¼‰
- æ¯æœˆè‡ªåŠ¨é‡ç½®é…é¢
- é€‚åˆé•¿æœŸç”¨æˆ·

**æŠ€æœ¯å®ç°**ï¼š

```rust
// pallets/market-maker/src/lib.rs

/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šä¹°å®¶å…è´¹è®¢å•é…é¢ï¼ˆå¸¦å‘¨æœŸï¼‰
/// 
/// å­˜å‚¨ç»“æ„ï¼š(åšå¸‚å•†ID, ä¹°å®¶è´¦æˆ·) => (é…é¢é‡ç½®æ—¶é—´, å‰©ä½™å…è´¹æ¬¡æ•°)
#[pallet::storage]
pub type FreeOrderQuotaWithPeriod<T: Config> = StorageDoubleMap<
    _,
    Blake2_128Concat,
    u64,  // maker_id
    Blake2_128Concat,
    T::AccountId,  // buyer
    (BlockNumberFor<T>, u32),  // (ä¸‹æ¬¡é‡ç½®æ—¶é—´, å‰©ä½™æ¬¡æ•°)
    OptionQuery,
>;

/// å‡½æ•°çº§è¯¦ç»†ä¸­æ–‡æ³¨é‡Šï¼šå…è´¹é…é¢å‘¨æœŸé…ç½®
/// 
/// å­˜å‚¨ç»“æ„ï¼šåšå¸‚å•†ID => (æ¯å‘¨æœŸå…è´¹æ¬¡æ•°, å‘¨æœŸé•¿åº¦)
#[pallet::storage]
pub type FreeQuotaPeriodConfig<T: Config> = StorageMap<
    _,
    Blake2_128Concat,
    u64,  // maker_id
    (u32, BlockNumberFor<T>),  // (æ¯å‘¨æœŸæ¬¡æ•°, å‘¨æœŸåŒºå—æ•°)
    OptionQuery,
>;

impl<T: Config> Pallet<T> {
    /// æ£€æŸ¥å¹¶æ¶ˆè´¹ä¹°å®¶çš„å…è´¹æ¬¡æ•°ï¼ˆå¸¦å‘¨æœŸé‡ç½®ï¼‰
    /// 
    /// # åŠŸèƒ½è¯¦ç»†ä¸­æ–‡æ³¨é‡Š
    /// æ£€æŸ¥ä¹°å®¶çš„å…è´¹é…é¢ï¼Œå¦‚æœå‘¨æœŸå·²è¿‡ï¼Œåˆ™è‡ªåŠ¨é‡ç½®é…é¢ã€‚
    /// 
    /// # é€»è¾‘
    /// 1. è·å–å½“å‰é…é¢å’Œé‡ç½®æ—¶é—´
    /// 2. å¦‚æœå·²è¿‡é‡ç½®æ—¶é—´ï¼Œé‡ç½®é…é¢
    /// 3. é€’å‡é…é¢
    pub fn consume_free_quota_with_period(
        maker_id: u64,
        buyer: &T::AccountId,
    ) -> Result<bool, DispatchError> {
        let current_block = <frame_system::Pallet<T>>::block_number();
        
        // è·å–é…ç½®
        let (quota_per_period, period_blocks) = FreeQuotaPeriodConfig::<T>::get(maker_id)
            .unwrap_or((3, 30 * 14400));  // é»˜è®¤: 3æ¬¡/æœˆ
        
        if quota_per_period == 0 {
            return Ok(false);  // åšå¸‚å•†ä¸æä¾›å…è´¹æœåŠ¡
        }
        
        // è·å–å½“å‰é…é¢çŠ¶æ€
        let mut quota_state = FreeOrderQuotaWithPeriod::<T>::get(maker_id, buyer);
        
        match quota_state {
            Some((reset_at, remaining)) => {
                // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®
                if current_block >= reset_at {
                    // é‡ç½®é…é¢
                    let next_reset = current_block + period_blocks;
                    FreeOrderQuotaWithPeriod::<T>::insert(
                        maker_id,
                        buyer,
                        (next_reset, quota_per_period.saturating_sub(1)),
                    );
                    
                    Self::deposit_event(Event::FreeQuotaReset {
                        maker_id,
                        buyer: buyer.clone(),
                        new_quota: quota_per_period,
                    });
                    
                    return Ok(true);
                }
                
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é…é¢
                if remaining == 0 {
                    return Ok(false);  // æœ¬å‘¨æœŸé…é¢å·²ç”¨å®Œ
                }
                
                // é€’å‡é…é¢
                FreeOrderQuotaWithPeriod::<T>::insert(
                    maker_id,
                    buyer,
                    (reset_at, remaining.saturating_sub(1)),
                );
                
                Ok(true)
            }
            None => {
                // æ–°ä¹°å®¶ï¼Œåˆå§‹åŒ–é…é¢
                let next_reset = current_block + period_blocks;
                FreeOrderQuotaWithPeriod::<T>::insert(
                    maker_id,
                    buyer,
                    (next_reset, quota_per_period.saturating_sub(1)),
                );
                
                Ok(true)
            }
        }
    }
    
    /// æŸ¥è¯¢ä¹°å®¶çš„å‰©ä½™å…è´¹æ¬¡æ•°å’Œé‡ç½®æ—¶é—´
    pub fn get_remaining_quota_with_period(
        maker_id: u64,
        buyer: &T::AccountId,
    ) -> (u32, BlockNumberFor<T>) {
        let current_block = <frame_system::Pallet<T>>::block_number();
        
        let (quota_per_period, period_blocks) = FreeQuotaPeriodConfig::<T>::get(maker_id)
            .unwrap_or((3, 30 * 14400));
        
        match FreeOrderQuotaWithPeriod::<T>::get(maker_id, buyer) {
            Some((reset_at, remaining)) => {
                if current_block >= reset_at {
                    // å·²åˆ°é‡ç½®æ—¶é—´
                    (quota_per_period, current_block + period_blocks)
                } else {
                    (remaining, reset_at)
                }
            }
            None => {
                // æ–°ä¹°å®¶
                (quota_per_period, current_block + period_blocks)
            }
        }
    }
}

#[pallet::event]
pub enum Event<T: Config> {
    // ... å…¶ä»–äº‹ä»¶
    
    /// å…è´¹é…é¢å·²é‡ç½®
    /// \[åšå¸‚å•†ID, ä¹°å®¶, æ–°é…é¢\]
    FreeQuotaReset {
        maker_id: u64,
        buyer: T::AccountId,
        new_quota: u32,
    },
}
```

---

### ğŸ¯ ç­–ç•¥ Cï¼šåŸºäºä¿¡ç”¨åˆ†çš„åŠ¨æ€é…é¢ï¼ˆæ¨èâ­â­â­â­â­ï¼‰

**æ ¸å¿ƒæ€è·¯**ï¼š
- æ ¹æ®ä¹°å®¶ä¿¡ç”¨åˆ†åŠ¨æ€åˆ†é…å…è´¹æ¬¡æ•°
- é«˜ä¿¡ç”¨ä¹°å®¶äº«å—æ›´å¤šå…è´¹æ¬¡æ•°
- ä¸ç°æœ‰ä¹°å®¶ä¿¡ç”¨ç³»ç»Ÿé›†æˆ

**æŠ€æœ¯å®ç°**ï¼š

```rust
// pallets/market-maker/src/lib.rs

impl<T: Config> Pallet<T> {
    /// æ ¹æ®ä¹°å®¶ä¿¡ç”¨åˆ†è®¡ç®—å…è´¹é…é¢
    /// 
    /// # åŠŸèƒ½è¯¦ç»†ä¸­æ–‡æ³¨é‡Š
    /// æ ¹æ®ä¹°å®¶åœ¨ pallet-buyer-credit ä¸­çš„ä¿¡ç”¨åˆ†ï¼ŒåŠ¨æ€è®¡ç®—å¯äº«å—çš„å…è´¹æ¬¡æ•°ã€‚
    /// 
    /// # ä¿¡ç”¨åˆ†ä¸å…è´¹æ¬¡æ•°æ˜ å°„
    /// ```
    /// ä¿¡ç”¨åˆ† >= 800: 10 æ¬¡/æœˆ
    /// ä¿¡ç”¨åˆ† >= 600: 5 æ¬¡/æœˆ
    /// ä¿¡ç”¨åˆ† >= 400: 3 æ¬¡/æœˆ
    /// ä¿¡ç”¨åˆ† >= 200: 1 æ¬¡/æœˆ
    /// ä¿¡ç”¨åˆ† <  200: 0 æ¬¡ï¼ˆæ— å…è´¹ï¼‰
    /// ```
    pub fn calculate_free_quota_by_credit(
        buyer: &T::AccountId,
    ) -> u32 {
        // è·å–ä¹°å®¶ä¿¡ç”¨åˆ†
        let credit_score = pallet_buyer_credit::Pallet::<T>::get_credit_score(buyer);
        
        // æ ¹æ®ä¿¡ç”¨åˆ†è¿”å›é…é¢
        if credit_score >= 800 {
            10  // ä¼˜è´¨ä¹°å®¶ï¼š10æ¬¡/æœˆ
        } else if credit_score >= 600 {
            5   // è‰¯å¥½ä¹°å®¶ï¼š5æ¬¡/æœˆ
        } else if credit_score >= 400 {
            3   // æ™®é€šä¹°å®¶ï¼š3æ¬¡/æœˆ
        } else if credit_score >= 200 {
            1   // æ–°æ‰‹ä¹°å®¶ï¼š1æ¬¡/æœˆ
        } else {
            0   // ä½ä¿¡ç”¨ä¹°å®¶ï¼šæ— å…è´¹
        }
    }
    
    /// æ£€æŸ¥å¹¶æ¶ˆè´¹ä¹°å®¶çš„å…è´¹æ¬¡æ•°ï¼ˆåŸºäºä¿¡ç”¨åˆ†ï¼‰
    pub fn consume_free_quota_by_credit(
        maker_id: u64,
        buyer: &T::AccountId,
    ) -> Result<bool, DispatchError> {
        // è®¡ç®—ä¹°å®¶åº”äº«å—çš„é…é¢
        let entitled_quota = Self::calculate_free_quota_by_credit(buyer);
        
        if entitled_quota == 0 {
            return Ok(false);  // ä¿¡ç”¨åˆ†ä¸è¶³ï¼Œæ— å…è´¹é…é¢
        }
        
        // ä½¿ç”¨å‘¨æœŸæ€§é…é¢é€»è¾‘
        let current_block = <frame_system::Pallet<T>>::block_number();
        let period_blocks = 30 * 14400;  // 30å¤©
        
        let mut quota_state = FreeOrderQuotaWithPeriod::<T>::get(maker_id, buyer);
        
        match quota_state {
            Some((reset_at, remaining)) => {
                // æ£€æŸ¥æ˜¯å¦éœ€è¦é‡ç½®
                if current_block >= reset_at {
                    // é‡ç½®é…é¢ï¼ˆæ ¹æ®å½“å‰ä¿¡ç”¨åˆ†ï¼‰
                    let next_reset = current_block + period_blocks;
                    FreeOrderQuotaWithPeriod::<T>::insert(
                        maker_id,
                        buyer,
                        (next_reset, entitled_quota.saturating_sub(1)),
                    );
                    
                    return Ok(true);
                }
                
                // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰é…é¢
                if remaining == 0 {
                    return Ok(false);
                }
                
                // é€’å‡é…é¢
                FreeOrderQuotaWithPeriod::<T>::insert(
                    maker_id,
                    buyer,
                    (reset_at, remaining.saturating_sub(1)),
                );
                
                Ok(true)
            }
            None => {
                // æ–°ä¹°å®¶ï¼Œåˆå§‹åŒ–é…é¢ï¼ˆæ ¹æ®ä¿¡ç”¨åˆ†ï¼‰
                let next_reset = current_block + period_blocks;
                FreeOrderQuotaWithPeriod::<T>::insert(
                    maker_id,
                    buyer,
                    (next_reset, entitled_quota.saturating_sub(1)),
                );
                
                Ok(true)
            }
        }
    }
}
```

---

## ä¸‰ã€OTC Order Pallet é›†æˆ

### ä¿®æ”¹ `create_order_free` å‡½æ•°

```rust
// pallets/otc-order/src/lib.rs

#[pallet::call]
impl<T: Config> Pallet<T> {
    /// ä¹°å®¶åˆ›å»ºè®¢å•ï¼ˆåšå¸‚å•†ä»£ä»˜ Gasï¼‰
    /// 
    /// # å…è´¹æ¬¡æ•°é™åˆ¶
    /// ä¹°å®¶éœ€è¦æœ‰å‰©ä½™çš„å…è´¹é…é¢ï¼Œå¦åˆ™éœ€è¦è‡ªå·±æ”¯ä»˜ Gasã€‚
    #[pallet::call_index(11)]
    #[pallet::weight(<T as frame_system::Config>::DbWeight::get().reads_writes(5, 3))]
    pub fn create_order_free(
        origin: OriginFor<T>,
        maker_id: u64,
        qty: BalanceOf<T>,
        payment_commit: H256,
        contact_commit: H256,
    ) -> DispatchResult {
        let taker = ensure_signed(origin)?;
        
        // 1. æ£€æŸ¥ä¹°å®¶æ˜¯å¦æœ‰å…è´¹é…é¢
        let has_free_quota = pallet_market_maker::Pallet::<T>::consume_free_quota_by_credit(
            maker_id,
            &taker,
        )?;
        
        if !has_free_quota {
            // æ— å…è´¹é…é¢ï¼Œè¿”å›é”™è¯¯ï¼Œè®©ä¹°å®¶ä½¿ç”¨æ­£å¸¸çš„ create_order å‡½æ•°
            return Err(Error::<T>::FreeQuotaExhausted.into());
        }
        
        // 2. éªŒè¯åšå¸‚å•†
        let maker_info = pallet_market_maker::ActiveMarketMakers::<T>::get(maker_id)
            .ok_or(Error::<T>::MakerNotFound)?;
        
        // 3. æ£€æŸ¥åšå¸‚å•†ä»£ä»˜æ± ä½™é¢
        let estimated_gas = Self::estimate_gas_fee();
        let sponsor_balance = pallet_market_maker::Pallet::<T>::gas_sponsor_pool(maker_id);
        ensure!(sponsor_balance >= estimated_gas, Error::<T>::MakerGasSponsorInsufficient);
        
        // 4. ä¹°å®¶ä¿¡ç”¨æ£€æŸ¥
        let base_price = pallet_pricing::Pallet::<T>::get_memo_market_price_weighted();
        let amount_usdt = base_price.saturating_mul(qty.saturated_into::<u64>()) / 1_000_000_000_000u64;
        pallet_buyer_credit::Pallet::<T>::check_buyer_limit(&taker, amount_usdt)
            .map_err(|_| Error::<T>::BadState)?;
        
        // 5. åˆ›å»ºè®¢å•ï¼ˆæ­£å¸¸æµç¨‹ï¼‰
        // ... (åˆ›å»ºè®¢å•çš„ä»£ç )
        
        // 6. è§¦å‘äº‹ä»¶
        Self::deposit_event(Event::OrderCreatedFree {
            order_id,
            maker_id,
            taker,
            qty,
            amount: amount_b,
            gas_sponsored: true,
        });
        
        Ok(())
    }
}

#[pallet::error]
pub enum Error<T> {
    // ... å…¶ä»–é”™è¯¯
    
    /// å…è´¹é…é¢å·²ç”¨å®Œ
    FreeQuotaExhausted,
}
```

---

## å››ã€å‰ç«¯é›†æˆ

### æ˜¾ç¤ºå‰©ä½™å…è´¹æ¬¡æ•°

```typescript
// stardust-dapp/src/features/otc/CreateOrderFreePage.tsx

import React, { useState, useEffect } from 'react';
import { Card, Alert, Progress, Tag, Space, Typography } from 'antd';
import { GiftOutlined, ClockCircleOutlined } from '@ant-design/icons';

const { Text } = Typography;

export const CreateOrderFreePage: React.FC = () => {
  const { api, currentAccount } = useSubstrateContext();
  const [remainingQuota, setRemainingQuota] = useState(0);
  const [resetBlock, setResetBlock] = useState(0);
  const [creditScore, setCreditScore] = useState(0);
  
  useEffect(() => {
    if (api && currentAccount) {
      loadQuotaInfo();
    }
  }, [api, currentAccount]);
  
  const loadQuotaInfo = async () => {
    if (!api || !currentAccount) return;
    
    const makerId = 1;  // å‡è®¾åšå¸‚å•†ID=1
    
    // 1. æŸ¥è¯¢ä¿¡ç”¨åˆ†
    const score = await api.query.buyerCredit.creditScores(currentAccount.address);
    setCreditScore(score.toNumber());
    
    // 2. æŸ¥è¯¢å‰©ä½™å…è´¹æ¬¡æ•°
    const quotaInfo = await api.query.marketMaker.freeOrderQuotaWithPeriod(
      makerId,
      currentAccount.address
    );
    
    if (quotaInfo.isSome) {
      const [resetAt, remaining] = quotaInfo.unwrap();
      setResetBlock(resetAt.toNumber());
      setRemainingQuota(remaining.toNumber());
    } else {
      // æ–°ä¹°å®¶ï¼Œæ ¹æ®ä¿¡ç”¨åˆ†è®¡ç®—
      const entitled = calculateQuotaByCreditScore(score.toNumber());
      setRemainingQuota(entitled);
    }
  };
  
  const calculateQuotaByCreditScore = (score: number): number => {
    if (score >= 800) return 10;
    if (score >= 600) return 5;
    if (score >= 400) return 3;
    if (score >= 200) return 1;
    return 0;
  };
  
  const getQuotaLevel = () => {
    if (creditScore >= 800) return { level: 'ä¼˜è´¨', color: 'gold', quota: 10 };
    if (creditScore >= 600) return { level: 'è‰¯å¥½', color: 'green', quota: 5 };
    if (creditScore >= 400) return { level: 'æ™®é€š', color: 'blue', quota: 3 };
    if (creditScore >= 200) return { level: 'æ–°æ‰‹', color: 'orange', quota: 1 };
    return { level: 'å—é™', color: 'red', quota: 0 };
  };
  
  const quotaLevel = getQuotaLevel();
  
  return (
    <div style={{ maxWidth: 600, margin: '0 auto', padding: 24 }}>
      <Card>
        {/* å…è´¹é…é¢çŠ¶æ€å¡ç‰‡ */}
        <Card type="inner" style={{ background: '#f0f5ff', marginBottom: 24 }}>
          <Space direction="vertical" size="middle" style={{ width: '100%' }}>
            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <Space>
                <GiftOutlined style={{ fontSize: 24, color: '#1890ff' }} />
                <Text strong style={{ fontSize: 18 }}>æ‚¨çš„å…è´¹é…é¢</Text>
              </Space>
              <Tag color={quotaLevel.color} style={{ fontSize: 14, padding: '4px 12px' }}>
                {quotaLevel.level}ä¹°å®¶
              </Tag>
            </div>
            
            <div>
              <Text style={{ fontSize: 32, fontWeight: 'bold', color: '#1890ff' }}>
                {remainingQuota}
              </Text>
              <Text type="secondary" style={{ marginLeft: 8 }}>
                / {quotaLevel.quota} æ¬¡æœ¬æœˆå…è´¹
              </Text>
            </div>
            
            <Progress
              percent={(remainingQuota / quotaLevel.quota) * 100}
              strokeColor={{
                '0%': '#108ee9',
                '100%': '#87d068',
              }}
              format={() => `å‰©ä½™ ${remainingQuota} æ¬¡`}
            />
            
            <Space>
              <ClockCircleOutlined />
              <Text type="secondary">
                é…é¢å°†åœ¨ {Math.floor((resetBlock - currentBlock) / 14400)} å¤©åé‡ç½®
              </Text>
            </Space>
          </Space>
        </Card>
        
        {/* ä¿¡ç”¨åˆ†æå‡æç¤º */}
        {creditScore < 800 && (
          <Alert
            message="ğŸ’¡ æå‡ä¿¡ç”¨åˆ†ï¼Œè·å¾—æ›´å¤šå…è´¹æ¬¡æ•°"
            description={
              <div>
                <Text>æ‚¨å½“å‰ä¿¡ç”¨åˆ†ï¼š{creditScore}</Text>
                <br />
                <Text>å®Œæˆæ›´å¤šè®¢å•å¹¶ä¿æŒè‰¯å¥½ä¿¡ç”¨ï¼Œå¯æå‡è‡³æ›´é«˜ç­‰çº§ï¼š</Text>
                <ul style={{ marginTop: 8, marginBottom: 0 }}>
                  <li>ä¼˜è´¨ä¹°å®¶ï¼ˆâ‰¥800åˆ†ï¼‰ï¼š<strong>10æ¬¡/æœˆ</strong></li>
                  <li>è‰¯å¥½ä¹°å®¶ï¼ˆâ‰¥600åˆ†ï¼‰ï¼š<strong>5æ¬¡/æœˆ</strong></li>
                  <li>æ™®é€šä¹°å®¶ï¼ˆâ‰¥400åˆ†ï¼‰ï¼š<strong>3æ¬¡/æœˆ</strong></li>
                </ul>
              </div>
            }
            type="info"
            showIcon
            style={{ marginBottom: 24 }}
          />
        )}
        
        {/* é…é¢ç”¨å®Œæç¤º */}
        {remainingQuota === 0 && (
          <Alert
            message="âš ï¸ æœ¬æœˆå…è´¹æ¬¡æ•°å·²ç”¨å®Œ"
            description="æ‚¨å¯ä»¥ä½¿ç”¨æ™®é€šåˆ›å»ºè®¢å•åŠŸèƒ½ï¼Œæ”¯ä»˜å°‘é‡ Gas è´¹ç”¨ï¼ˆçº¦ 0.01 DUSTï¼‰"
            type="warning"
            showIcon
            style={{ marginBottom: 24 }}
          />
        )}
        
        {/* åˆ›å»ºè®¢å•è¡¨å• */}
        {/* ... */}
      </Card>
    </div>
  );
};
```

---

## äº”ã€ç­–ç•¥å¯¹æ¯”ä¸æ¨è

| ç­–ç•¥ | å¤æ‚åº¦ | é˜²åˆ·èƒ½åŠ› | ç”¨æˆ·ä½“éªŒ | å…¬å¹³æ€§ | æ¨èåº¦ |
|------|--------|---------|---------|--------|--------|
| **A. å›ºå®šæ¬¡æ•°** | ğŸŸ¢ ä½ | ğŸŸ¡ ä¸­ | âœ… å¥½ | âœ… é«˜ | â­â­â­â­ |
| **B. å‘¨æœŸé‡ç½®** | ğŸŸ¡ ä¸­ | âœ… å¼º | âœ… å¥½ | âœ… é«˜ | â­â­â­â­â­ |
| **C. ä¿¡ç”¨åˆ†åŠ¨æ€** | ğŸŸ¡ ä¸­ | âœ… å¼º | âœ… å¾ˆå¥½ | âœ… å¾ˆé«˜ | â­â­â­â­â­ |
| **æ··åˆæ–¹æ¡ˆ** | ğŸ”´ é«˜ | âœ… å¾ˆå¼º | âœ… å¾ˆå¥½ | âœ… å¾ˆé«˜ | â­â­â­â­â­ |

---

## å…­ã€æ¨èå®æ–½æ–¹æ¡ˆ

### âœ… **ç­–ç•¥ Cï¼ˆä¿¡ç”¨åˆ†åŠ¨æ€é…é¢ï¼‰+ ç­–ç•¥ Bï¼ˆå‘¨æœŸé‡ç½®ï¼‰**

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š
```
1. æ ¹æ®ä¹°å®¶ä¿¡ç”¨åˆ†åŠ¨æ€åˆ†é…å…è´¹æ¬¡æ•°
   - ä¼˜è´¨ä¹°å®¶ï¼ˆâ‰¥800åˆ†ï¼‰ï¼š10æ¬¡/æœˆ
   - è‰¯å¥½ä¹°å®¶ï¼ˆâ‰¥600åˆ†ï¼‰ï¼š5æ¬¡/æœˆ
   - æ™®é€šä¹°å®¶ï¼ˆâ‰¥400åˆ†ï¼‰ï¼š3æ¬¡/æœˆ
   - æ–°æ‰‹ä¹°å®¶ï¼ˆâ‰¥200åˆ†ï¼‰ï¼š1æ¬¡/æœˆ
   - ä½ä¿¡ç”¨ä¹°å®¶ï¼ˆ<200åˆ†ï¼‰ï¼š0æ¬¡

2. æ¯æœˆè‡ªåŠ¨é‡ç½®é…é¢
   - æ¯ 30 å¤©é‡ç½®ä¸€æ¬¡
   - é‡ç½®æ—¶æ ¹æ®æœ€æ–°ä¿¡ç”¨åˆ†è®¡ç®—é…é¢

3. åšå¸‚å•†å¯é¢å¤–æˆäºˆé…é¢
   - ç”¨äºæ¨å¹¿æ´»åŠ¨
   - å¥–åŠ±ä¼˜è´¨ä¹°å®¶
```

**ä¼˜åŠ¿**ï¼š
- âœ… **é˜²åˆ·èƒ½åŠ›å¼º**ï¼šä½ä¿¡ç”¨ç”¨æˆ·æ— æ³•æ»¥ç”¨
- âœ… **æ¿€åŠ±æœºåˆ¶**ï¼šé¼“åŠ±ä¹°å®¶æå‡ä¿¡ç”¨
- âœ… **å…¬å¹³åˆ†é…**ï¼šä¼˜è´¨ç”¨æˆ·äº«å—æ›´å¤šç¦åˆ©
- âœ… **çµæ´»å¯æ§**ï¼šåšå¸‚å•†å¯è‡ªå®šä¹‰è§„åˆ™

---

## ä¸ƒã€æ€»ç»“

### âœ… **é“¾ä¸Šä»£ä»˜å¯ä»¥é™åˆ¶å…è´¹æ¬¡æ•°ï¼è€Œä¸”å¼ºçƒˆæ¨èï¼**

| é—®é¢˜ | ç­”æ¡ˆ |
|------|------|
| **èƒ½å¦é™åˆ¶å…è´¹æ¬¡æ•°ï¼Ÿ** | âœ… å¯ä»¥ |
| **æ¨èç­–ç•¥ï¼Ÿ** | ä¿¡ç”¨åˆ†åŠ¨æ€é…é¢ + å‘¨æœŸé‡ç½® |
| **é˜²åˆ·æ•ˆæœï¼Ÿ** | âœ… å¾ˆå¥½ |
| **ç”¨æˆ·ä½“éªŒï¼Ÿ** | âœ… ä¼˜ç§€ï¼ˆæ¿€åŠ±æå‡ä¿¡ç”¨ï¼‰ |
| **å®æ–½éš¾åº¦ï¼Ÿ** | ğŸŸ¡ ä¸­ç­‰ |
| **æ¨èåº¦ï¼Ÿ** | â­â­â­â­â­ **å¼ºçƒˆæ¨è** |

---

### ğŸš€ å®æ–½å»ºè®®

**é˜¶æ®µ 1ï¼šåŸºç¡€ç‰ˆï¼ˆå›ºå®šæ¬¡æ•°ï¼‰**
- æ¯ä¸ªä¹°å®¶ 3 æ¬¡å…è´¹
- ç®€å•å¿«é€Ÿ

**é˜¶æ®µ 2ï¼šä¼˜åŒ–ç‰ˆï¼ˆå‘¨æœŸé‡ç½®ï¼‰**
- æ¯æœˆ 3 æ¬¡å…è´¹
- è‡ªåŠ¨é‡ç½®

**é˜¶æ®µ 3ï¼šå®Œæ•´ç‰ˆï¼ˆä¿¡ç”¨åˆ†åŠ¨æ€ï¼‰**
- æ ¹æ®ä¿¡ç”¨åˆ†åŠ¨æ€åˆ†é…
- æ¿€åŠ±ä¹°å®¶æå‡ä¿¡ç”¨
- å…¬å¹³åˆ†é…èµ„æº

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-10-22  
**æ ¸å¿ƒç»“è®º**: âœ… **å¯ä»¥é™åˆ¶å…è´¹æ¬¡æ•°ï¼Œæ¨èä½¿ç”¨ä¿¡ç”¨åˆ†åŠ¨æ€é…é¢ + å‘¨æœŸé‡ç½®çš„æ··åˆæ–¹æ¡ˆ**  
**å…³é”®ä»·å€¼**: ğŸ’¡ **æ—¢ä¿æŠ¤åšå¸‚å•†æˆæœ¬ï¼Œåˆæ¿€åŠ±ä¹°å®¶æå‡ä¿¡ç”¨ï¼Œå®ç°åŒèµ¢**

