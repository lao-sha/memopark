# 钱包切换功能实现说明

## 📋 概述

为"我的钱包"页面添加了钱包切换功能，支持多账户管理和快速切换。

## 🎯 实现内容

### 1. 新增文件

#### `WalletSwitcher.tsx` - 钱包切换器组件
- **路径**: `memopark-dapp/src/features/wallet/WalletSwitcher.tsx`
- **功能**: 
  - 显示所有本地钱包列表
  - 支持切换当前钱包
  - 显示每个钱包的别名、地址和余额
  - 支持创建新钱包和导入钱包

### 2. 修改文件

#### `WalletManagePage.tsx` - 钱包管理页面
- **新增功能**:
  - 顶部右侧添加"切换"按钮
  - 显示当前钱包别名
  - 监听账户切换事件，自动更新
  - 集成 WalletSwitcher 弹窗

## 🎨 UI 设计

### 钱包管理页面布局

```
┌─────────────────────────────────────┐
│ ← 我的钱包    [🔄 切换]   Mainnet   │
├─────────────────────────────────────┤
│ ┌─────────────────────────────┐ ⚙️ │
│ │ 钱包 5FHneW                  │   │
│ │ 100.0000 MEMO               │   │
│ │                             │   │
│ │ 5FHneW...xyz  📋            │   │
│ └─────────────────────────────┘   │
├─────────────────────────────────────┤
│  [转账 ⇄]        [收款 📱]         │
├─────────────────────────────────────┤
│ 资产                          🔄   │
│ ...                                 │
└─────────────────────────────────────┘
```

### 钱包切换弹窗

```
┌─────────────────────────────────────┐
│ 🔄 切换钱包                    ✕   │
├─────────────────────────────────────┤
│                                     │
│ ┌─────────────────────────────┐   │
│ │ 钱包 5FHneW          ✅当前  │   │ ← 当前钱包（蓝色边框）
│ │ 5FHneW...xyz                │   │
│ │ 余额: 100.0000 MEMO         │   │
│ └─────────────────────────────┘   │
│                                     │
│ ┌─────────────────────────────┐   │
│ │ 我的第二个钱包               │   │ ← 其他钱包（灰色边框）
│ │ 5DTestKLiA...abc            │   │
│ │ 余额: 50.0000 MEMO          │   │
│ └─────────────────────────────┘   │
│                                     │
│ ┌─────────────────────────────┐   │
│ │ 测试钱包                     │   │
│ │ 5CiPPseX...def              │   │
│ │ 余额: 0.0000 MEMO           │   │
│ └─────────────────────────────┘   │
│                                     │
├─────────────────────────────────────┤
│  [➕ 创建新钱包]  [导入钱包]       │
└─────────────────────────────────────┘
```

## 🔧 核心功能

### 1. 钱包列表显示

| 功能 | 说明 | 状态 |
|------|------|------|
| **钱包别名** | 显示用户自定义别名或默认名称 | ✅ |
| **钱包地址** | 显示完整地址 | ✅ |
| **余额查询** | 异步查询每个钱包的链上余额 | ✅ |
| **当前标识** | 高亮显示当前使用的钱包 | ✅ |
| **悬停效果** | 鼠标悬停时改变背景色 | ✅ |

### 2. 钱包切换

```typescript
// 切换钱包流程
const handleSwitch = (address: string) => {
  // 1. 设置当前地址
  setCurrentAddress(address);
  
  // 2. 触发回调
  onSwitch?.(address);
  
  // 3. 关闭弹窗
  onClose();
  
  // 4. 触发全局事件
  window.dispatchEvent(new Event('mp.accountsUpdate'));
}
```

### 3. 事件监听

```typescript
// 监听账户切换事件
useEffect(() => {
  const handleAccountUpdate = () => {
    loadCurrentWallet();
  };
  window.addEventListener('mp.accountsUpdate', handleAccountUpdate);
  
  return () => {
    window.removeEventListener('mp.accountsUpdate', handleAccountUpdate);
  };
}, []);
```

### 4. 余额异步加载

```typescript
// 异步加载余额
items.forEach(async (item, index) => {
  try {
    const bal = await queryFreeBalance(item.address);
    setWallets((prev) => {
      const updated = [...prev];
      if (updated[index]) {
        updated[index] = {
          ...updated[index],
          balance: bal.formatted,
          isLoading: false,
        };
      }
      return updated;
    });
  } catch (e) {
    // 错误处理
  }
});
```

## 💡 设计特点

### 1. 切换按钮
- **位置**: 顶部标题栏右侧
- **样式**: 蓝色边框 + 浅蓝背景
- **图标**: SwapRightOutlined
- **悬停**: 背景色加深

### 2. 钱包卡片样式

#### 当前钱包
- 蓝色边框（2px）
- 浅蓝背景（#e6f7ff）
- 右上角勾选图标
- "当前"徽章

#### 其他钱包
- 灰色边框（1px）
- 白色背景
- 悬停时边框和背景变化

### 3. 弹窗底部操作
- **创建新钱包**: 蓝色边框按钮，跳转到创建页面
- **导入钱包**: 灰色边框按钮，跳转到恢复页面

## 🎨 配色方案

| 元素 | 颜色 | 说明 |
|------|------|------|
| 切换按钮背景 | #e6f7ff | 浅蓝色 |
| 切换按钮边框 | #1890ff | 蓝色 |
| 切换按钮文字 | #1890ff | 蓝色 |
| 当前钱包边框 | #1890ff | 蓝色 |
| 当前钱包背景 | #e6f7ff | 浅蓝色 |
| 其他钱包边框 | #f0f0f0 | 浅灰色 |
| 其他钱包背景 | #fff | 白色 |
| 悬停背景 | #fafafa | 浅灰色 |

## 📊 数据结构

### WalletItem 接口

```typescript
interface WalletItem extends LocalKeystore {
  alias: string;      // 钱包别名
  balance: string;    // 余额
  isLoading: boolean; // 加载状态
}
```

### LocalKeystore 接口

```typescript
interface LocalKeystore {
  address: string;    // 钱包地址
  ciphertext: string; // 加密的助记词
  salt: string;       // 加密盐
  iv: string;         // 初始化向量
  createdAt: number;  // 创建时间
}
```

## 🔄 用户流程

### 切换钱包流程

```
钱包管理页面
  ↓ 点击"切换"按钮
  
钱包切换弹窗 ⭐
  ├─ 查看所有钱包列表
  ├─ 查看每个钱包的余额
  ├─ 点击钱包卡片 → 切换钱包
  ├─ 点击"创建新钱包" → 创建页面
  └─ 点击"导入钱包" → 恢复页面
  
切换成功
  ├─ 弹窗关闭
  ├─ 页面自动更新
  ├─ 显示新钱包信息
  └─ 显示新钱包余额
```

### 创建新钱包流程

```
钱包切换弹窗
  ↓ 点击"创建新钱包"
  
创建钱包页面
  ├─ 设置密码
  ├─ 生成助记词
  ├─ 备份助记词
  └─ 验证助记词
  
创建成功
  ├─ 自动添加到钱包列表
  ├─ 自动设置为当前钱包
  └─ 触发 mp.accountsUpdate 事件
```

## 💻 技术实现

### 1. 多账户管理

使用 `keystore.ts` 中的函数：

```typescript
// 读取所有钱包
loadAllKeystores(): LocalKeystore[]

// 获取当前地址
getCurrentAddress(): string | null

// 设置当前地址
setCurrentAddress(address: string): void

// 获取别名
getAlias(address: string): string

// 设置别名
setAlias(address: string, alias: string): void
```

### 2. 余额查询

```typescript
import { queryFreeBalance } from '../../lib/polkadot-safe';

const bal = await queryFreeBalance(address);
// bal.formatted: "100.0000"
```

### 3. 事件通信

```typescript
// 触发事件
window.dispatchEvent(new Event('mp.accountsUpdate'));

// 监听事件
window.addEventListener('mp.accountsUpdate', handleAccountUpdate);

// 清理监听
window.removeEventListener('mp.accountsUpdate', handleAccountUpdate);
```

## 🎁 使用方式

### 从钱包管理页面切换

1. 进入"我的钱包" → "钱包管理"
2. 点击右上角"切换"按钮
3. 在弹窗中选择要切换的钱包
4. 页面自动更新为新钱包信息

### 从切换弹窗创建新钱包

1. 点击"切换"按钮
2. 点击"创建新钱包"
3. 按流程完成钱包创建
4. 自动切换到新钱包

### 从切换弹窗导入钱包

1. 点击"切换"按钮
2. 点击"导入钱包"
3. 输入助记词和密码
4. 自动切换到导入的钱包

## 🧪 测试场景

### 场景 1: 单个钱包
- ✅ 显示当前钱包信息
- ✅ 切换按钮可点击
- ✅ 弹窗显示一个钱包
- ✅ 钱包标记为"当前"

### 场景 2: 多个钱包
- ✅ 显示所有钱包列表
- ✅ 当前钱包高亮显示
- ✅ 点击其他钱包可切换
- ✅ 切换后页面自动更新

### 场景 3: 无钱包
- ✅ 显示"暂无钱包"提示
- ✅ 可点击创建或导入
- ✅ 创建后自动切换

### 场景 4: 余额查询
- ✅ 异步加载余额
- ✅ 加载中显示"..."
- ✅ 加载失败显示"0.0000"
- ✅ 加载成功显示实际余额

## 📝 代码质量

- ✅ 无 TypeScript 错误
- ✅ 无 ESLint 警告
- ✅ 详细中文注释
- ✅ 状态管理清晰
- ✅ 错误处理完善
- ✅ 事件监听清理

## 🎉 完成状态

| 功能 | 状态 |
|------|------|
| 钱包切换按钮 | ✅ |
| 钱包列表显示 | ✅ |
| 当前钱包标识 | ✅ |
| 余额异步加载 | ✅ |
| 钱包别名显示 | ✅ |
| 切换功能 | ✅ |
| 创建新钱包 | ✅ |
| 导入钱包 | ✅ |
| 事件监听 | ✅ |
| 自动更新 | ✅ |

---

**🎊 钱包切换功能已完成！**

现在用户可以：
1. ✅ 在钱包管理页面看到"切换"按钮
2. ✅ 点击查看所有钱包列表
3. ✅ 查看每个钱包的余额
4. ✅ 快速切换到其他钱包
5. ✅ 从切换弹窗创建或导入新钱包
6. ✅ 页面自动更新为新钱包信息

简洁、高效、用户友好！🚀
