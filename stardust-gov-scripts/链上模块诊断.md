# 链上模块诊断说明

## 问题背景

在运行 `create-listing.js` 时遇到错误：
```
Cannot read properties of undefined (reading 'entries')
```

这表明链上可能没有 `marketMaker` 模块，或者模块/存储名称不同。

## 诊断步骤

### 1. 运行脚本查看诊断信息

再次运行脚本：
```bash
node create-listing.js
```

脚本现在会输出详细的诊断信息：

#### 情况 A: 模块不存在
```
❌ 链上没有 marketMaker 模块！
   可用的模块列表:
   • system
   • timestamp
   • balances
   • transaction
   • sudo
   ...
```

**解决方案**: 链上需要部署包含 `marketMaker` pallet 的运行时

#### 情况 B: 存储不存在
```
❌ marketMaker 模块没有 marketMakers 存储！
   可用的存储列表:
   • applications
   • nextMarketMakerId
   • config
   ...
```

**解决方案**: 需要修改脚本使用正确的存储名称

### 2. 手动查询链上模块

可以创建一个简单的脚本来查看所有可用模块：

```javascript
// check-modules.js
const { ApiPromise, WsProvider } = require('@polkadot/api');

async function main() {
  const api = await ApiPromise.create({ 
    provider: new WsProvider('ws://127.0.0.1:9944') 
  });
  
  console.log('链上所有模块:');
  console.log('='.repeat(60));
  
  Object.keys(api.query).sort().forEach((module, idx) => {
    console.log(`${idx + 1}. ${module}`);
    
    // 显示该模块的存储
    const storages = Object.keys(api.query[module]);
    if (storages.length > 0) {
      storages.forEach(storage => {
        console.log(`   └─ ${storage}`);
      });
    }
  });
  
  await api.disconnect();
}

main().catch(console.error);
```

运行：
```bash
node check-modules.js
```

### 3. 检查 otcListing 模块

如果链上有 `otcListing` 模块但没有 `marketMaker`，说明：
- 链的设计中做市商功能可能在 `otcListing` 模块中
- 需要调整脚本查询逻辑

## 可能的解决方案

### 方案 1: 链上没有 marketMaker 模块

如果是测试环境或开发环境，可能需要：

1. **更新链的运行时**
   ```bash
   # 重新编译包含 marketMaker pallet 的链
   cargo build --release
   ```

2. **重启节点**
   ```bash
   # 使用包含 marketMaker 的运行时启动节点
   ./target/release/node --dev
   ```

### 方案 2: 模块名称不同

如果模块名称不是 `marketMaker`，修改脚本：

```javascript
// 在 create-listing.js 中
// 将 api.query.marketMaker 改为实际的模块名
const entries = await api.query.otc.marketMakers.entries();
// 或
const entries = await api.query.trading.marketMakers.entries();
```

### 方案 3: 存储名称不同

如果存储名称不是 `marketMakers`，修改脚本：

```javascript
// 将 marketMakers 改为实际的存储名
const entries = await api.query.marketMaker.traders.entries();
// 或
const entries = await api.query.marketMaker.providers.entries();
```

### 方案 4: 使用测试数据跳过检查

如果只是想测试脚本其他功能，可以临时跳过做市商检查：

```javascript
// 在 create-listing.js 的 main 函数中
// 注释掉做市商检查
// const mmId = await checkMarketMaker(api, selected.pair.address);
// if (mmId === null) {
//   await api.disconnect();
//   process.exit(1);
// }

// 使用假的 mmId
const mmId = '1'; // 临时使用，仅用于测试
```

## 验证链的状态

### 查看链的元数据

```javascript
const metadata = await api.rpc.state.getMetadata();
console.log(metadata.toHuman());
```

### 查看运行时版本

```javascript
const version = await api.rpc.state.getRuntimeVersion();
console.log('Runtime Version:', version.toHuman());
```

### 检查是否有 otcListing 交易

```javascript
// 检查 otcListing.createListing 方法是否存在
if (api.tx.otcListing && api.tx.otcListing.createListing) {
  console.log('✅ otcListing.createListing 方法存在');
} else {
  console.log('❌ otcListing.createListing 方法不存在');
}
```

## 常见问题

### Q1: 为什么链上没有 marketMaker 模块？

**A**: 可能的原因：
1. 链的运行时没有包含该 pallet
2. 节点版本较旧
3. 使用的是不同的链（不是 Stardust）
4. 链还在开发中，功能未完全部署

### Q2: 如何确认我连接的是正确的链？

**A**: 运行脚本时会显示链的信息：
```javascript
const chain = await api.rpc.system.chain();
const nodeName = await api.rpc.system.name();
const nodeVersion = await api.rpc.system.version();

console.log(`链: ${chain}`);
console.log(`节点: ${nodeName}`);
console.log(`版本: ${nodeVersion}`);
```

期望看到：
- 链: Stardust Development (或 Stardust)
- 节点: Stardust Node (或类似名称)

### Q3: 我应该使用哪个脚本测试？

**A**: 
- 如果链上没有做市商功能，先使用 **批量转账脚本** 测试基本功能
- 如果链上有治理功能，使用 **治理脚本** 测试
- 做市商功能需要链上有对应的 pallet 才能使用

## 下一步

1. **运行诊断**
   ```bash
   node create-listing.js
   ```
   查看输出的诊断信息

2. **确认链的状态**
   - 检查链是否包含 marketMaker pallet
   - 确认存储结构是否正确

3. **根据诊断结果**
   - 如果缺少模块 → 更新链的运行时
   - 如果名称不同 → 修改脚本配置
   - 如果暂时不可用 → 先测试其他功能

## 技术支持

如果以上方法都无法解决，可以：
1. 查看链的源码确认 pallet 配置
2. 联系链的开发团队确认功能状态
3. 使用其他可用的脚本（如批量转账）先进行测试

---

**文档版本**: 1.0  
**更新日期**: 2024年10月17日

