# 批量创建账户并随机转账 - 使用说明

## 📋 功能概述

`batch-transfer.js` 脚本实现以下功能：

1. ✅ **创建1000个新账户**：自动生成助记词和地址
2. ✅ **记录账户信息**：保存到 JSON 文件，便于后续使用
3. ✅ **批量随机转账**：从指定账户向1000个地址转账
4. ✅ **随机金额**：每笔转账金额在 20,000,000-50,000,000 DUST 范围内随机
5. ✅ **结果记录**：保存所有转账结果到文件

---

## 🔧 配置说明

### 关键配置项

```javascript
const BATCH_CONFIG = {
  accountCount: 1000,                     // 创建账户数量
  minAmount: 20_000_000n,                 // 最小转账金额（20,000,000 DUST）
  maxAmount: 50_000_000n,                 // 最大转账金额（50,000,000 DUST）
  accountsFile: 'generated-accounts.json', // 账户信息保存文件
  resultsFile: 'transfer-results.json',   // 转账结果保存文件
  batchSize: 50,                          // 每批处理数量
  delayBetweenBatches: 3000,              // 批次间延迟（毫秒）
  delayBetweenTxs: 500,                   // 交易间延迟（毫秒）
};
```

### 发送账户配置

```javascript
const SENDER_CONFIG = {
  mnemonic: 'satoshi sure behave certain impulse ski slight track century kitchen clutch story',
  expectedAddress: '5CrDBEVDgXUwctSuV8EvQEBo2m187PcxoY36V7H7PGErHUW4',
};
```

---

## 🚀 使用方法

### 1. 安装依赖

```bash
cd /home/xiaodong/文档/stardust/stardust-gov-scripts
npm install
```

### 2. 检查发送账户余额

**计算所需余额**：
- 账户数量：1000
- 平均金额：35,000,000 DUST（20-50百万的中间值）
- 总转账金额：1000 × 35,000,000 = 35,000,000,000 DUST（350亿）
- 预估手续费：约 1000笔 × 0.01 DUST = 10 DUST
- **需要总额**：约 35,000,000,010 DUST

**查询余额**：
```bash
# 使用 governance-cli.js
node governance-cli.js balance 5CrDBEVDgXUwctSuV8EvQEBo2m187PcxoY36V7H7PGErHUW4
```

### 3. 运行脚本

```bash
node batch-transfer.js
```

### 4. 脚本执行流程

```
🚀 批量创建账户并随机转账脚本启动

==========================================================
配置信息:
   账户数量: 1000
   转账范围: 20000000-50000000 DUST
   批次大小: 50
   发送地址: 5CrDBEVDgXUwctSuV8EvQEBo2m187PcxoY36V7H7PGErHUW4
==========================================================

✅ 加密库准备完成
✅ 发送账户地址验证通过
   地址: 5CrDBEVDgXUwctSuV8EvQEBo2m187PcxoY36V7H7PGErHUW4

🔌 正在连接节点: ws://127.0.0.1:9944
✅ 已连接 Stardust • ...

💰 检查账户余额...
   可用余额: 100,000,000,000 DUST

🔑 开始生成 1000 个账户...
==========================================================
   ✅ 已生成 100/1000 个账户
   ✅ 已生成 200/1000 个账户
   ...
   ✅ 已生成 1000/1000 个账户
✅ 账户生成完成！共 1000 个

💾 保存账户信息到文件: generated-accounts.json
✅ 账户信息已保存
   文件路径: /home/xiaodong/文档/stardust/stardust-gov-scripts/generated-accounts.json
   账户数量: 1000

📋 生成转账列表...
==========================================================
总转账金额: 35,234,567,890 DUST
总笔数: 1000
平均金额: 35,234,567 DUST
预估总手续费: 10 DUST
单笔手续费: 0.01 DUST
需要总额: 35,234,567,900 DUST
✅ 余额充足

⚠️  准备开始批量转账
   按 Ctrl+C 取消，或等待 5 秒自动开始...

🎯 开始批量转账...
==========================================================
   分为 20 个批次，每批 50 笔

📦 处理批次 1/20 (50 笔)
------------------------------------------------------------

⚙️  [1/1000] 转账: 5GrwvaEF...
   金额: 23,456,789 DUST
   📦 状态: Ready
   📡 已广播
   ✅ 包含区块: 0x123456...
   🎉 最终确认: 0x123456...
   ✅ 转账成功！

...

📦 处理批次 20/20 (50 笔)
...

==========================================================
📊 批量转账完成
==========================================================
✅ 成功: 998 笔
❌ 失败: 2 笔
📝 总计: 1000 笔
📈 成功率: 99.80%

💰 最终余额查询...
   初始余额: 100,000,000,000 DUST
   最终余额: 64,765,432,100 DUST
   实际花费: 35,234,567,900 DUST

💾 保存转账结果到文件: transfer-results.json
✅ 转账结果已保存

👋 脚本执行完成

📁 生成的文件:
   账户信息: /home/xiaodong/文档/stardust/stardust-gov-scripts/generated-accounts.json
   转账结果: /home/xiaodong/文档/stardust/stardust-gov-scripts/transfer-results.json
```

---

## 📁 生成的文件

### 1. generated-accounts.json

**格式**：
```json
{
  "timestamp": "2025-10-24T12:34:56.789Z",
  "count": 1000,
  "accounts": [
    {
      "index": 1,
      "address": "5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY",
      "mnemonic": "abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon abandon about"
    },
    {
      "index": 2,
      "address": "5FHneW46xGXgs5mUiveU4sbTyGBzmstUspZC92UhjJM694ty",
      "mnemonic": "zoo zoo zoo zoo zoo zoo zoo zoo zoo zoo zoo wrong"
    },
    ...
  ]
}
```

**用途**：
- ✅ 保存所有生成的账户信息
- ✅ 可用于后续导入钱包
- ✅ 可用于验证账户所有权

**注意**：
- ⚠️ **极其重要**：此文件包含助记词，务必妥善保管
- ⚠️ 不要提交到 git 仓库
- ⚠️ 不要分享给他人
- ⚠️ 建议加密存储

---

### 2. transfer-results.json

**格式**：
```json
{
  "timestamp": "2025-10-24T12:45:00.000Z",
  "summary": {
    "total": 1000,
    "success": 998,
    "failed": 2
  },
  "results": [
    {
      "index": 1,
      "recipient": "5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY",
      "amount": "23456789000000000000",
      "amountFormatted": "23,456,789 DUST",
      "success": true,
      "blockHash": "0x1234567890abcdef...",
      "timestamp": "2025-10-24T12:35:01.000Z"
    },
    {
      "index": 2,
      "recipient": "5FHneW46xGXgs5mUiveU4sbTyGBzmstUspZC92UhjJM694ty",
      "amount": "45678901000000000000",
      "amountFormatted": "45,678,901 DUST",
      "success": false,
      "error": "balances.InsufficientBalance: ...",
      "timestamp": "2025-10-24T12:35:02.000Z"
    },
    ...
  ]
}
```

**用途**：
- ✅ 记录所有转账结果
- ✅ 统计成功/失败笔数
- ✅ 排查失败原因
- ✅ 审计和验证

---

## ⚙️ 性能优化

### 分批处理

脚本将1000笔转账分为20个批次，每批50笔：
- ✅ 避免一次性提交过多交易
- ✅ 降低节点负载
- ✅ 提高成功率

### 延迟设置

```javascript
delayBetweenTxs: 500,      // 交易间延迟 500ms
delayBetweenBatches: 3000, // 批次间延迟 3000ms
```

**调整建议**：
- 如果网络快，可以减少延迟（最低100ms）
- 如果经常失败，可以增加延迟（最高5000ms）

---

## 🔒 安全注意事项

### 1. 助记词安全

⚠️ **极其重要**：
- 生成的 `generated-accounts.json` 包含1000个账户的助记词
- 任何人获得此文件都可以控制这些账户的资金
- 务必妥善保管，建议：
  - 加密存储
  - 备份到安全位置
  - 不要提交到 git
  - 不要分享给他人

### 2. 发送账户安全

- 发送账户助记词硬编码在脚本中
- 仅用于测试环境
- 生产环境请使用环境变量或密钥管理系统

### 3. 余额检查

- 脚本会自动检查余额是否充足
- 如余额不足会立即退出
- 建议预留一定余额以应对手续费波动

---

## 🐛 常见问题

### Q1: 脚本执行到一半失败了怎么办？

**回答**：
- ✅ 脚本每个批次后自动保存结果到 `transfer-results.json`
- ✅ 可以查看该文件了解已成功的转账
- ✅ 失败的转账可以手动重试或修改脚本重新运行

**修改方案**：
```javascript
// 1. 加载已保存的结果
const existingResults = JSON.parse(fs.readFileSync('transfer-results.json'));
const successAddresses = new Set(
  existingResults.results
    .filter(r => r.success)
    .map(r => r.recipient)
);

// 2. 过滤已成功的地址
const remainingTransfers = transfers.filter(
  t => !successAddresses.has(t.recipient)
);

// 3. 仅对剩余地址转账
// ...
```

---

### Q2: 如何查看某个账户的余额？

**回答**：
```bash
# 使用 governance-cli.js
node governance-cli.js balance <地址>

# 或从 generated-accounts.json 读取地址
cat generated-accounts.json | jq '.accounts[0].address'
```

---

### Q3: 如何导入生成的账户到钱包？

**回答**：

**Polkadot.js 钱包**：
1. 打开 Polkadot.js Apps
2. 账户 → 添加账户
3. 选择"导入账户"
4. 输入助记词（从 `generated-accounts.json` 复制）
5. 完成导入

**程序化导入**：
```javascript
const { Keyring } = require('@polkadot/api');
const accounts = require('./generated-accounts.json');

const keyring = new Keyring({ type: 'sr25519' });

accounts.accounts.forEach(acc => {
  const pair = keyring.addFromMnemonic(acc.mnemonic);
  console.log(`导入账户 ${acc.index}: ${pair.address}`);
});
```

---

### Q4: 转账金额为什么这么大？

**回答**：
- 配置的金额范围是 20,000,000-50,000,000 DUST
- 这是**整数金额**，不是最小单位
- DUST 代币精度为12位小数
- 实际最小单位金额 = 配置金额 × 10^12

**示例**：
```
配置: minAmount = 20_000_000n (20,000,000 DUST)
精度: 12
实际: 20,000,000 × 10^12 = 20,000,000,000,000,000,000 最小单位
显示: 20,000,000 DUST
```

---

### Q5: 如何修改转账金额范围？

**回答**：

修改 `BATCH_CONFIG`：
```javascript
const BATCH_CONFIG = {
  minAmount: 10n,        // 最小 10 DUST
  maxAmount: 100n,       // 最大 100 DUST
  // ...
};
```

---

## 📊 预估时间

**计算公式**：
```
总时间 = (账户数量 / 批次大小) × 批次间延迟 + 账户数量 × 交易间延迟 + 账户生成时间
```

**示例（默认配置）**：
```
批次数量: 1000 / 50 = 20 批次
批次间延迟: 20 × 3000ms = 60,000ms = 1 分钟
交易间延迟: 1000 × 500ms = 500,000ms = 8.3 分钟
账户生成时间: 约 30 秒
区块确认时间: 每笔约 6 秒 × 1000 = 100 分钟（并行处理）

预估总时间: 约 10-15 分钟
```

**优化建议**：
- 增加批次大小（如100）可减少批次间延迟时间
- 减少交易间延迟（如300ms）可加快执行
- 但可能增加失败率，需要平衡

---

## 📝 修改记录

**2025-10-24**：
- ✅ 实现批量创建1000个账户
- ✅ 实现随机金额转账（20-50百万MEMO）
- ✅ 添加账户信息保存功能
- ✅ 添加转账结果保存功能
- ✅ 添加分批处理和延迟控制
- ✅ 添加进度显示和错误处理
- ✅ 添加余额检查和预估

---

## 🎯 使用场景

1. **压力测试**：测试链的转账性能
2. **空投活动**：批量向用户分发代币
3. **测试环境初始化**：创建测试账户
4. **数据准备**：为其他测试脚本准备账户

---

**最后更新**：2025-10-24  
**状态**：✅ 可用  
**维护人员**：AI Assistant
