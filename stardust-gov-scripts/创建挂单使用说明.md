# 做市商创建挂单脚本使用说明

## 概述

`create-listing.js` 是一个交互式命令行工具，用于做市商在 Stardust 区块链上创建 OTC 挂单。

## 功能特点

✅ **账户选择** - 上下键选择做市商账户  
✅ **身份验证** - 自动验证地址和做市商身份  
✅ **余额检查** - 创建前检查账户余额  
✅ **交互式输入** - 逐个输入挂单参数，每个参数都有详细说明  
✅ **参数验证** - 实时验证输入的有效性  
✅ **参数汇总** - 创建前显示所有参数供确认  
✅ **详细日志** - 显示交易构建和提交的详细信息  

## 做市商账户配置

脚本内置了2个做市商测试账户：

### 做市商 1
```
助记词: gown lounge wolf cake hard sport napkin lock buddy interest session inside
地址: 5C7RjMrgfCJYyscR5Du1BLP99vFGgRDXjAt3ronftJZe39Qo
```

### 做市商 2
```
助记词: gold brick snake six junk cart alpha asset spoon that ice stumble
地址: 5CRubhWmwNmJ3z2Ffqs3nf71XQGHBkfKSc1edNvuHZErqvdL
```

## 使用方法

### 1. 确保节点运行

确保 Stardust 节点正在运行：
```bash
# 默认端口: ws://127.0.0.1:9944
```

### 2. 运行脚本

```bash
# 方式 1: 直接运行
node create-listing.js

# 方式 2: 使用 npm script
npm run create-listing

# 方式 3: 使用快捷命令
npm run listing
```

### 3. 使用自定义节点

```bash
# 指定节点地址
STARDUST_WS=ws://192.168.1.100:9944 node create-listing.js
```

## 操作流程

### 步骤 1: 选择做市商账户

```
🚀 做市商创建挂单脚本
============================================================
✅ 加密库准备完成
📍 选择做市商账户 (↑ ↓ 选择, Enter 确认, Esc 取消)
请选择做市商账户
   ↑ ↓ 切换，Enter 确认，Esc 取消

 > 🏦 做市商 1
   🏦 做市商 2
   退出
```

使用 ↑ ↓ 键选择账户，按 Enter 确认。

### 步骤 2: 连接节点并验证

```
✅ 账户已加载: 5C7RjMrgfCJYyscR5Du1BLP99vFGgRDXjAt3ronftJZe39Qo

🔌 正在连接节点: ws://127.0.0.1:9944
✅ 已连接 Stardust Development • Stardust Node v1.0.0

💰 检查账户余额...
   可用余额: 1000000.0 MEMO

🔍 检查做市商身份...
   活跃做市商数量: 2
✅ 做市商身份确认: mmId = 1
```

### 步骤 3: 输入挂单参数

系统会逐个提示输入以下参数：

#### 1. 交易方向 (side)
```
📝 开始输入挂单参数
============================================================

📌 交易方向 (side)
   说明: 0=买入(Buy), 1=卖出(Sell)
   类型: number
   请输入 [1]: 
```

- **说明**: 挂单类型
- **选项**: `0` = 买入，`1` = 卖出
- **默认值**: 1

#### 2. 基础资产ID (base)
```
📌 基础资产ID (base)
   说明: MEMO 资产 ID（通常为 0）
   类型: number
   请输入 [0]: 
```

- **说明**: 交易对的基础资产
- **通常值**: 0 (MEMO)
- **默认值**: 0

#### 3. 计价资产ID (quote)
```
📌 计价资产ID (quote)
   说明: CNY 资产 ID（通常为 1）
   类型: number
   请输入 [1]: 
```

- **说明**: 交易对的计价资产
- **通常值**: 1 (CNY)
- **默认值**: 1

#### 4. 价差（基点）(pricingSpreadBps)
```
📌 价差（基点） (pricingSpreadBps)
   说明: 价格波动范围，单位为基点(1基点=0.01%)，如100表示1%
   类型: number
   请输入 [100]: 
```

- **说明**: 允许的价格波动范围
- **单位**: 基点 (1基点 = 0.01%)
- **示例**: 100 = 1%, 200 = 2%
- **默认值**: 100

#### 5. 最小数量 (minQty)
```
📌 最小数量 (minQty)
   说明: 单笔交易最小数量（最小单位）
   类型: bigint
   请输入 [1111000000000000]: 
```

- **说明**: 单笔交易允许的最小数量
- **单位**: 最小单位（需要除以 10^12 得到 MEMO）
- **默认值**: 1111000000000000 (约 0.001111 MEMO)

#### 6. 最大数量 (maxQty)
```
📌 最大数量 (maxQty)
   说明: 单笔交易最大数量（最小单位）
   类型: bigint
   请输入 [111111000000000000]: 
```

- **说明**: 单笔交易允许的最大数量
- **单位**: 最小单位
- **默认值**: 111111000000000000 (约 0.111111 MEMO)

#### 7. 总库存 (total)
```
📌 总库存 (total)
   说明: 挂单总库存数量（最小单位）
   类型: bigint
   请输入 [1111111000000000000]: 
```

- **说明**: 挂单的总库存
- **单位**: 最小单位
- **默认值**: 1111111000000000000 (约 1.111111 MEMO)

#### 8. 允许部分成交 (partial)
```
📌 允许部分成交 (partial)
   说明: true=允许部分成交, false=必须全额成交
   类型: boolean
   请输入 [true]: 
```

- **说明**: 是否允许部分成交
- **选项**: `true` 或 `false`
- **默认值**: true

#### 9. 过期时间 (expireAt)
```
📌 过期时间 (expireAt)
   说明: 挂单过期的区块高度（0表示不过期）
   类型: number
   请输入 [22222]: 
```

- **说明**: 挂单自动过期的区块高度
- **特殊值**: 0 = 不过期
- **默认值**: 22222

#### 10. 最低价格 (priceMin)
```
📌 最低价格 (priceMin)
   说明: 可接受的最低价格（最小单位）
   类型: bigint
   请输入 [10000000000]: 
```

- **说明**: 可接受的最低交易价格
- **单位**: 最小单位
- **默认值**: 10000000000

#### 11. 最高价格 (priceMax)
```
📌 最高价格 (priceMax)
   说明: 可接受的最高价格（最小单位）
   类型: bigint
   请输入 [20000000000]: 
```

- **说明**: 可接受的最高交易价格
- **单位**: 最小单位
- **默认值**: 20000000000

#### 12. 条款承诺 (termsCommit)
```
📌 条款承诺 (termsCommit)
   说明: 交易条款的哈希承诺（可选，留空则为 null）
   类型: optional
   请输入 []: 
```

- **说明**: 交易条款的哈希（可选）
- **默认值**: 空（null）

### 步骤 4: 确认参数

输入完所有参数后，系统会显示汇总信息：

```
============================================================
📋 挂单参数汇总
============================================================
交易方向         : 1
   类型: number
   描述: 0=买入(Buy), 1=卖出(Sell)
基础资产ID       : 0
   类型: number
   描述: MEMO 资产 ID（通常为 0）
计价资产ID       : 1
   类型: number
   描述: CNY 资产 ID（通常为 1）
价差（基点）      : 100
   类型: number
   描述: 价格波动范围，单位为基点(1基点=0.01%)，如100表示1%
最小数量         : 1111000000000000
   类型: bigint
   描述: 单笔交易最小数量（最小单位）
最大数量         : 111111000000000000
   类型: bigint
   描述: 单笔交易最大数量（最小单位）
总库存          : 1111111000000000000
   类型: bigint
   描述: 挂单总库存数量（最小单位）
允许部分成交     : true
   类型: boolean
   描述: true=允许部分成交, false=必须全额成交
过期时间         : 22222
   类型: number
   描述: 挂单过期的区块高度（0表示不过期）
最低价格         : 10000000000
   类型: bigint
   描述: 可接受的最低价格（最小单位）
最高价格         : 20000000000
   类型: bigint
   描述: 可接受的最高价格（最小单位）
条款承诺         : null
   类型: optional
   描述: 交易条款的哈希承诺（可选，留空则为 null）
============================================================

按 Enter 确认创建挂单，Esc 取消
```

### 步骤 5: 构建和提交交易

确认后，系统会构建交易并提交：

```
🔨 构建交易...
✅ 交易已构建
   方法: otcListing.createListing
   参数数量: 12
   编码长度: 78
   交易哈希: 0x1234567890abcdef...

📋 交易参数详细信息:
   [0] side: u8
       值: 1
   [1] base: u32
       值: 0
   [2] quote: u32
       值: 1
   [3] pricingSpreadBps: u16
       值: 100
   [4] minQty: u128
       值: 1,111,000,000,000,000
   [5] maxQty: u128
       值: 111,111,000,000,000,000
   [6] total: u128
       值: 1,111,111,000,000,000,000
   [7] partial: bool
       值: true
   [8] expireAt: u32
       值: 22,222
   [9] priceMin: u128
       值: 10,000,000,000
   [10] priceMax: u128
       值: 20,000,000,000
   [11] termsCommit: Option<H256>
       值: None

⚙️  提交交易: 创建挂单
   📦 状态: Ready
   📡 已广播
   ✅ 包含区块: 0xabcdef123...
   🎉 最终确认: 0xabcdef123...
   ✅ 挂单创建成功！
   📌 挂单ID: 5

============================================================
🎉 挂单创建完成！
============================================================
```

## 快捷键说明

### 选择菜单时
- **↑ / ↓** : 上下选择
- **Enter** : 确认选择
- **Esc** : 取消/返回
- **Ctrl+C** : 退出脚本

### 输入参数时
- **Enter** : 确认输入（使用默认值或输入的值）
- **Ctrl+C** : 退出脚本

## 参数说明详解

### 交易方向 (side)
| 值 | 说明 | 用途 |
|---|------|------|
| 0 | Buy | 做市商买入基础资产（用户卖出） |
| 1 | Sell | 做市商卖出基础资产（用户买入） |

### 价差（基点）
- 1 基点 = 0.01%
- 100 基点 = 1%
- 价差用于定义价格波动范围

### 数量单位
所有数量（minQty, maxQty, total）都使用最小单位：
- 1 MEMO = 1,000,000,000,000 最小单位 (10^12)
- 示例: 1111000000000000 = 0.001111 MEMO

### 价格单位
价格（priceMin, priceMax）也使用最小单位，表示每单位基础资产的计价资产数量。

### 过期时间
- 区块高度：挂单将在达到此高度时自动过期
- 0：表示永不过期
- 可以通过 `api.rpc.chain.getHeader()` 查询当前区块高度

## 注意事项

⚠️ **重要提示**

1. **做市商身份** - 必须先成为激活的做市商才能创建挂单
2. **余额充足** - 账户需要有足够余额支付手续费
3. **参数合理性** - 确保 minQty ≤ maxQty ≤ total
4. **价格范围** - 确保 priceMin ≤ priceMax
5. **测试环境** - 建议先在测试网络验证参数
6. **不可撤销** - 交易一旦提交无法撤销

## 错误处理

### 常见错误及解决方案

#### 地址验证失败
```
❌ 地址验证失败
   期望: 5C7RjMrgfCJYyscR5Du1BLP99vFGgRDXjAt3ronftJZe39Qo
   实际: 5Cxxxxxx...
```
**解决**: 检查助记词是否正确

#### 不是做市商
```
❌ 该账户不是做市商！
   请先申请成为做市商
```
**解决**: 使用做市商账户或先申请成为做市商

#### 余额不足
```
❌ 账户余额为零，无法创建挂单
```
**解决**: 向账户充值

#### 参数验证失败
```
   ❌ 请输入 0 (买入) 或 1 (卖出)
```
**解决**: 按照提示输入正确格式的值

#### 节点连接失败
```
❌ Error: Unable to connect to ws://127.0.0.1:9944
```
**解决**: 检查节点是否运行，确认地址和端口

## 示例场景

### 场景 1: 创建卖单（默认参数）

如果你想快速创建一个使用默认参数的卖单，在每个参数提示时直接按 Enter：

```bash
$ npm run listing

# 选择做市商 1
# 每个参数提示时按 Enter 使用默认值
# 最后按 Enter 确认创建
```

### 场景 2: 创建自定义买单

```
交易方向: 0 (买入)
基础资产ID: 0
计价资产ID: 1
价差: 50 (0.5%)
最小数量: 1000000000000 (0.001 MEMO)
最大数量: 100000000000000 (0.1 MEMO)
总库存: 1000000000000000 (1 MEMO)
允许部分成交: true
过期时间: 100000
最低价格: 8000000000
最高价格: 12000000000
条款承诺: (留空)
```

## 技术细节

### 使用的 API
- `api.tx.otcListing.createListing()` - 创建挂单方法
- `api.query.marketMaker.activeMarketMakers()` - 查询已批准的活跃做市商
- `api.query.marketMaker.applications()` - 查询待审核的做市商申请

### 交易参数类型
| 参数 | Rust类型 | JavaScript类型 |
|------|---------|---------------|
| side | u8 | number |
| base | u32 | number |
| quote | u32 | number |
| pricingSpreadBps | u16 | number |
| minQty | u128 | string (转为BigInt) |
| maxQty | u128 | string (转为BigInt) |
| total | u128 | string (转为BigInt) |
| partial | bool | boolean |
| expireAt | u32 | number |
| priceMin | u128 | string (转为BigInt) |
| priceMax | u128 | string (转为BigInt) |
| termsCommit | Option\<H256\> | null or string |

## 自定义配置

### 修改做市商账户

编辑 `create-listing.js`，找到 `MARKET_MAKER_ACCOUNTS` 数组：

```javascript
const MARKET_MAKER_ACCOUNTS = [
  {
    id: 'mm-1',
    label: '🏦 你的做市商名称',
    mnemonic: '你的助记词',
    expectedAddress: '你的地址',
  },
  // 添加更多...
];
```

### 修改默认参数值

编辑 `LISTING_PARAMS` 数组中各参数的 `defaultValue`：

```javascript
{
  name: 'side',
  // ...
  defaultValue: '0',  // 改为买单
}
```

## 安全建议

1. **助记词安全** - 不要在生产环境硬编码助记词
2. **环境变量** - 使用环境变量存储敏感信息
3. **参数验证** - 创建前仔细检查所有参数
4. **测试先行** - 在测试网络充分测试
5. **小额测试** - 首次使用建议小额测试

## 许可证

MIT License

