# 占卜模块数据删除、归档与存储押金完整方案

## 📋 方案总览

本方案为所有占卜模块（八字、紫微、六爻、梅花、奇门、大六壬、小六壬、塔罗）提供统一的数据生命周期管理和经济激励机制。

---

## 🎯 核心功能矩阵

| 功能 | 删除 (Delete) | 归档 (Archive) | 活跃 (Active) |
|-----|--------------|---------------|--------------|
| **数据位置** | 完全清除 | IPFS存储 | 链上存储 |
| **押金状态** | 100%退还 | 50%退还 | 100%锁定 |
| **可恢复性** | ❌ 不可恢复 | ✅ 可解档 | N/A |
| **查询速度** | N/A | 🐌 慢(需解档) | ⚡ 快 |
| **存储成本** | 无 | 💰 低 | 💰💰💰 高 |
| **适用场景** | 测试数据 | 历史记录 | 常用数据 |

---

## 💰 经济模型设计

### 1. 押金标准（USDT计价）

| 占卜类型 | 基础押金 | 归档退还 | 删除退还 | 数据大小 |
|---------|---------|---------|---------|---------|
| 八字 | 0.5 USDT | 0.25 USDT | 0.5 USDT | ~2KB |
| 紫微 | 0.8 USDT | 0.4 USDT | 0.8 USDT | ~3KB |
| 六爻 | 0.3 USDT | 0.15 USDT | 0.3 USDT | ~1.5KB |
| 梅花 | 0.2 USDT | 0.1 USDT | 0.2 USDT | ~1KB |
| 奇门 | 1.0 USDT | 0.5 USDT | 1.0 USDT | ~4KB |
| 大六壬 | 0.8 USDT | 0.4 USDT | 0.8 USDT | ~3KB |
| 小六壬 | 0.2 USDT | 0.1 USDT | 0.2 USDT | ~1KB |
| 塔罗 | 0.3 USDT | 0.15 USDT | 0.3 USDT | ~1.5KB |

### 2. 免费配额

```rust
// 每日免费创建次数（无需押金）
DailyFreeQuota: 3次

// 每月免费创建次数
MonthlyFreeQuota: 10次

// VIP用户加成
Bronze: 5次/天
Silver: 10次/天
Gold: 20次/天
Platinum: 无限制
```

### 3. 费用结构

```rust
// 归档费用
ArchiveFee: 0.1 USDT

// 解档费用
UnarchiveFee: 0.2 USDT

// IPFS存储费用（自动从押金扣除）
IpfsStorageFee: 按pallet-stardust-ipfs标准
```

---

## 🔄 数据生命周期

```
创建记录 (Create)
    ↓ 锁定100%押金
    ↓
┌───────────────────┐
│  Active (活跃)     │ ← 解档 (Unarchive)
│  链上存储          │    补充50%押金
│  100%押金锁定      │    支付解档费
└─────┬─────┬───────┘
      │     │
      │     └─→ 删除 (Delete)
      │         ↓ 清理所有数据
      │         ↓ 退还100%押金
      │         └─→ Deleted (已删除)
      │
      └─→ 归档 (Archive)
          ↓ 上传IPFS
          ↓ 清理链上数据
          ↓ 退还50%押金
          ↓
      ┌───────────────────┐
      │  Archived (归档)   │
      │  IPFS存储          │
      │  50%押金锁定       │
      └─────┬─────────────┘
            │
            └─→ 删除归档 (Delete Archived)
                ↓ 清理IPFS
                ↓ 清理索引
                ↓ 退还剩余50%押金
                └─→ Deleted (已删除)
```

---

## 🏗️ 技术架构

### 1. 模块结构

```
pallets/divination/
├── common/                    # 通用模块
│   ├── deposit/              # 押金管理
│   │   ├── types.rs         # 押金数据结构
│   │   ├── config.rs        # 押金配置
│   │   └── manager.rs       # 押金管理器
│   ├── archive/              # 归档管理
│   │   ├── types.rs         # 归档数据结构
│   │   ├── ipfs.rs          # IPFS集成
│   │   └── manager.rs       # 归档管理器
│   └── lifecycle/            # 生命周期管理
│       ├── delete.rs        # 删除逻辑
│       ├── archive.rs       # 归档逻辑
│       └── restore.rs       # 恢复逻辑
├── bazi/                     # 八字模块
│   └── src/
│       ├── lib.rs           # 主模块
│       └── lifecycle.rs     # 生命周期实现
├── ziwei/                    # 紫微模块
├── liuyao/                   # 六爻模块
└── ...                       # 其他占卜模块
```

### 2. 核心Trait定义

```rust
/// 占卜记录生命周期管理Trait
pub trait DivinationLifecycle {
    type RecordId;
    type AccountId;
    type Balance;
    
    /// 创建记录（锁定押金）
    fn create_with_deposit(
        who: &Self::AccountId,
        data: &[u8],
        privacy_mode: PrivacyMode,
    ) -> Result<Self::RecordId, DispatchError>;
    
    /// 删除记录（退还全额押金）
    fn delete_with_refund(
        who: &Self::AccountId,
        record_id: Self::RecordId,
    ) -> Result<Self::Balance, DispatchError>;
    
    /// 归档记录（退还部分押金）
    fn archive_with_partial_refund(
        who: &Self::AccountId,
        record_id: Self::RecordId,
    ) -> Result<(Vec<u8>, Self::Balance), DispatchError>;
    
    /// 解档记录（补充押金）
    fn unarchive_with_deposit(
        who: &Self::AccountId,
        record_id: Self::RecordId,
        ipfs_cid: &[u8],
    ) -> Result<Self::Balance, DispatchError>;
}

/// 押金管理Trait
pub trait DepositManager {
    type AccountId;
    type Balance;
    
    /// 锁定押金
    fn lock_deposit(
        who: &Self::AccountId,
        amount: Self::Balance,
    ) -> DispatchResult;
    
    /// 解锁押金
    fn unlock_deposit(
        who: &Self::AccountId,
        amount: Self::Balance,
    ) -> DispatchResult;
    
    /// 计算押金金额
    fn calculate_deposit(
        divination_type: DivinationType,
        privacy_mode: PrivacyMode,
        scale: ScaleType,
    ) -> Self::Balance;
}

/// 归档管理Trait
pub trait ArchiveManager {
    type RecordId;
    type AccountId;
    
    /// 上传到IPFS
    fn upload_to_ipfs(
        who: &Self::AccountId,
        data: &[u8],
        tier: IpfsTier,
    ) -> Result<Vec<u8>, DispatchError>;
    
    /// 从IPFS获取
    fn fetch_from_ipfs(
        cid: &[u8],
    ) -> Result<Vec<u8>, DispatchError>;
    
    /// 验证数据完整性
    fn verify_integrity(
        data: &[u8],
        expected_hash: &[u8; 32],
    ) -> bool;
}
```

---

## 📊 可行性分析

### 1. 技术可行性 ✅

| 技术点 | 可行性 | 依赖 | 风险 |
|-------|-------|------|------|
| **押金锁定/解锁** | ✅ 高 | pallet-balances | 低 |
| **USDT计价** | ✅ 高 | pallet-pricing | 低 |
| **IPFS集成** | ✅ 高 | pallet-stardust-ipfs | 中 |
| **数据序列化** | ✅ 高 | SCALE codec | 低 |
| **完整性校验** | ✅ 高 | Blake2哈希 | 低 |
| **OCW自动化** | ⚠️ 中 | Offchain Worker | 中 |

**结论**：技术上完全可行，所有依赖模块已存在且成熟。

### 2. 经济合理性 ✅

#### 2.1 押金标准合理性

```
八字命盘押金: 0.5 USDT
├─ 数据大小: ~2KB
├─ 存储成本: ~0.1 USDT/年
├─ 押金/成本比: 5:1
└─ 结论: ✅ 合理（覆盖5年存储成本）

紫微命盘押金: 0.8 USDT
├─ 数据大小: ~3KB
├─ 存储成本: ~0.15 USDT/年
├─ 押金/成本比: 5.3:1
└─ 结论: ✅ 合理

奇门盘押金: 1.0 USDT
├─ 数据大小: ~4KB
├─ 存储成本: ~0.2 USDT/年
├─ 押金/成本比: 5:1
└─ 结论: ✅ 合理
```

#### 2.2 免费配额合理性

```
每日3次免费 × 30天 = 90次/月
├─ 普通用户需求: 5-10次/月
├─ 配额覆盖率: 900%-1800%
└─ 结论: ✅ 非常宽松，满足正常使用

每月10次免费
├─ 重度用户需求: 20-30次/月
├─ 配额覆盖率: 33%-50%
└─ 结论: ✅ 合理，鼓励付费使用
```

#### 2.3 归档经济模型

```
归档退还50%押金
├─ 用户收益: 立即回收50%资金
├─ 系统收益: 释放链上存储空间
├─ IPFS成本: 0.05 USDT/年（Temporary层）
├─ 剩余押金覆盖: 10年存储成本
└─ 结论: ✅ 双赢模型

解档费用: 0.2 USDT
├─ IPFS读取成本: ~0.05 USDT
├─ 链上写入成本: ~0.1 USDT
├─ 利润率: 25%
└─ 结论: ✅ 合理，覆盖成本并有盈余
```

### 3. 用户体验合理性 ✅

#### 3.1 操作复杂度

| 操作 | 步骤数 | 用户理解难度 | 评分 |
|-----|-------|------------|------|
| 创建记录 | 1步 | 简单 | ⭐⭐⭐⭐⭐ |
| 删除记录 | 1步 | 简单 | ⭐⭐⭐⭐⭐ |
| 归档记录 | 1步 | 中等 | ⭐⭐⭐⭐ |
| 解档记录 | 1步 | 中等 | ⭐⭐⭐⭐ |

**结论**：操作简单，用户友好。

#### 3.2 经济负担

```
普通用户（5次/月）
├─ 免费配额: 10次/月
├─ 实际花费: 0 USDT
└─ 结论: ✅ 完全免费

重度用户（30次/月）
├─ 免费配额: 10次
├─ 付费次数: 20次
├─ 平均押金: 0.5 USDT
├─ 总押金: 10 USDT
├─ 归档退还: 5 USDT（50%）
├─ 净成本: 5 USDT/月
└─ 结论: ✅ 可接受（约$5/月）

商业用户（100次/月）
├─ 免费配额: 10次
├─ 付费次数: 90次
├─ 平均押金: 0.5 USDT
├─ 总押金: 45 USDT
├─ 归档退还: 22.5 USDT
├─ 净成本: 22.5 USDT/月
└─ 结论: ✅ 合理（约$22.5/月）
```

### 4. 系统影响分析 ✅

#### 4.1 存储优化效果

```
假设场景：10,000个活跃用户
├─ 平均每用户: 20条记录
├─ 总记录数: 200,000条
├─ 平均记录大小: 2KB
├─ 总存储: 400MB

归档50%历史记录后：
├─ 链上记录: 100,000条
├─ 链上存储: 200MB
├─ IPFS存储: 200MB
├─ 节省链上空间: 50%
└─ 结论: ✅ 显著优化
```

#### 4.2 经济收益

```
押金池规模（10,000用户）
├─ 活跃记录押金: 100,000 × 0.5 = 50,000 USDT
├─ 归档记录押金: 100,000 × 0.25 = 25,000 USDT
├─ 总押金池: 75,000 USDT
└─ 结论: ✅ 形成稳定押金池

归档费用收入
├─ 月归档次数: 10,000次
├─ 归档费用: 0.1 USDT
├─ 月收入: 1,000 USDT
└─ 结论: ✅ 可持续收入来源
```

---

## 🚀 实施路线图

### Phase 1: 基础押金机制（2周）

**目标**：实现基础押金锁定/解锁功能

- [ ] 定义押金数据结构
- [ ] 实现押金管理器
- [ ] 集成pallet-pricing汇率查询
- [ ] 实现免费配额机制
- [ ] 编写单元测试

**交付物**：
- `pallet-divination-common/deposit` 模块
- 押金配置参数
- 测试用例

### Phase 2: 删除功能（1周）

**目标**：实现所有占卜模块的删除接口

- [ ] 实现统一删除接口
- [ ] 为每个占卜模块添加删除方法
- [ ] 实现押金退还逻辑
- [ ] 实现删除审计日志
- [ ] 编写集成测试

**交付物**：
- 8个占卜模块的删除接口
- 删除审计系统
- 测试用例

### Phase 3: 归档功能（3周）

**目标**：实现IPFS归档和恢复功能

- [ ] 定义归档数据结构
- [ ] 实现IPFS上传/下载
- [ ] 实现数据序列化/反序列化
- [ ] 实现归档索引系统
- [ ] 实现解档恢复逻辑
- [ ] 编写端到端测试

**交付物**：
- `pallet-divination-common/archive` 模块
- IPFS集成
- 归档索引系统
- 测试用例

### Phase 4: 前端集成（2周）

**目标**：提供用户友好的UI界面

- [ ] 设计押金管理界面
- [ ] 实现删除确认对话框
- [ ] 实现归档/解档操作界面
- [ ] 实现归档记录浏览器
- [ ] 用户文档和教程

**交付物**：
- React组件库
- 用户操作指南
- 视频教程

### Phase 5: 优化和监控（1周）

**目标**：性能优化和运营监控

- [ ] 实现批量操作接口
- [ ] 添加性能监控指标
- [ ] 实现自动归档建议
- [ ] 优化Gas消耗
- [ ] 压力测试

**交付物**：
- 性能优化报告
- 监控仪表板
- 压力测试报告

---

## 📈 预期效果

### 1. 存储优化

```
预期归档率: 40-60%
├─ 链上存储减少: 40-60%
├─ 节点同步速度提升: 20-30%
└─ 存储成本降低: 50-70%
```

### 2. 用户满意度

```
预期用户反馈:
├─ 数据自主权: ⭐⭐⭐⭐⭐
├─ 隐私保护: ⭐⭐⭐⭐⭐
├─ 经济负担: ⭐⭐⭐⭐
└─ 操作便利性: ⭐⭐⭐⭐
```

### 3. 经济效益

```
年度收益预测（10,000用户）:
├─ 归档费用: 12,000 USDT/年
├─ 解档费用: 4,000 USDT/年
├─ 总收入: 16,000 USDT/年
├─ IPFS成本: 5,000 USDT/年
├─ 净利润: 11,000 USDT/年
└─ ROI: 220%
```

---

## ⚠️ 风险与对策

### 1. 技术风险

| 风险 | 影响 | 概率 | 对策 |
|-----|------|------|------|
| IPFS不稳定 | 高 | 中 | 多副本+备用存储 |
| 数据损坏 | 高 | 低 | 完整性校验+冗余 |
| Gas费用过高 | 中 | 低 | 批量操作优化 |

### 2. 经济风险

| 风险 | 影响 | 概率 | 对策 |
|-----|------|------|------|
| DUST价格暴跌 | 高 | 中 | USDT计价+动态调整 |
| 押金不足 | 中 | 低 | 最低押金限制 |
| 恶意刷数据 | 中 | 中 | 频率限制+押金门槛 |

### 3. 用户体验风险

| 风险 | 影响 | 概率 | 对策 |
|-----|------|------|------|
| 操作复杂 | 中 | 低 | 简化UI+教程 |
| 误删数据 | 高 | 中 | 二次确认+冷静期 |
| 解档失败 | 中 | 低 | 自动重试+客服支持 |

---

## 📝 总结

### 可行性结论

✅ **技术可行性**: 高 - 所有技术组件成熟可用  
✅ **经济合理性**: 高 - 押金标准合理，经济模型健康  
✅ **用户体验**: 优 - 操作简单，经济负担可接受  
✅ **系统效益**: 显著 - 存储优化50%+，可持续收入  

### 推荐实施

**强烈推荐实施本方案**，理由：

1. **用户需求明确**：数据自主权是基本需求
2. **技术成熟可靠**：无技术障碍，风险可控
3. **经济模型健康**：押金合理，收益可观
4. **系统优化显著**：存储减少50%+
5. **竞争力提升**：行业领先的数据管理能力

### 关键成功因素

1. **合理的押金标准**：既保护系统又不影响用户
2. **充足的免费配额**：满足普通用户需求
3. **简单的操作流程**：降低用户学习成本
4. **可靠的IPFS集成**：确保归档数据安全
5. **完善的监控体系**：及时发现和解决问题

---

**方案版本**: v1.0  
**最后更新**: 2024-12-28  
**状态**: 待审批
