# OTC 订单创建修复使用说明

## 🎯 修复说明

**修复时间**：2025-10-17  
**修复内容**：将 OTC 订单创建从后端 API 改为直接链上交互  
**影响范围**：`http://127.0.0.1:5173/#/otc/order` 页面  

## ✅ 修复的问题

1. ✅ `ERR_CONNECTION_REFUSED` 错误
2. ✅ `providerId is not defined` 错误
3. ✅ `Failed to execute 'removeChild'` 错误
4. ✅ 无法创建订单的问题

## 🚀 快速开始

### 1. 启动链节点
```bash
cd /home/xiaodong/文档/memopark
./start-node.sh
```

### 2. 启动前端
```bash
cd /home/xiaodong/文档/memopark/memopark-dapp
npm run dev
```

### 3. 访问页面
打开浏览器访问：`http://127.0.0.1:5173/#/otc/order`

## 📖 使用流程

### 第一步：查看可用挂单
1. 页面加载后自动显示"可用挂单列表"
2. 列表包含以下信息：
   - **挂单 ID**
   - **方向**：Buy（买入）/ Sell（卖出）
   - **数量**：最小/最大/剩余
   - **价差**：pricingSpreadBps（基点）
   - **有效期**：expireAt（区块高度）
   - **状态**：Active（激活）

### 第二步：选择挂单
1. 点击表格中的某一行挂单
2. 下方显示"当前选中的挂单信息"
3. 包含详细信息：
   - 做市商 ID
   - 做市商地址
   - 手续费率
   - 数量范围
   - 等等

### 第三步：填写订单信息
1. **支付方式**：选择支付类型（alipay、wechat 等）
2. **下单模式**：选择"MEMO 数量"模式
   - ⚠️ 注意：暂不支持"法币金额"模式
3. **MEMO 数量**：输入要购买/出售的数量
   - 必须在挂单的最小和最大数量之间
   - 不能超过剩余库存

### 第四步：创建订单
1. 点击"创建订单"按钮
2. 系统自动验证：
   - ✅ 是否连接钱包
   - ✅ 是否选择挂单
   - ✅ 数量是否在范围内
3. 弹出密码输入框：
   - 🔐 输入本地钱包密码（至少 8 位）
   - 最多可重试 3 次
4. 等待交易上链：
   - 显示"正在创建订单..."
   - 交易成功后显示交易哈希

### 第五步：查看订单状态
1. 订单创建成功后，显示：
   - ✅ 交易哈希
   - ✅ 订单 ID
   - ✅ 数量和金额
2. 系统每 5 秒自动查询链上订单状态
3. 订单状态包括：
   - `Created`：已创建
   - `PaidOrCommitted`：已支付或已承诺
   - `Released`：已释放
   - `Refunded`：已退款
   - `Canceled`：已取消
   - `Disputed`：争议中
   - `Closed`：已关闭

## 🔧 技术细节

### 链端调用
```typescript
// 调用 otc-order pallet 的 open_order 方法
api.tx.otcOrder.openOrder(
  listingId,      // 挂单 ID
  price,          // 价格（12 位小数）
  qty,            // 数量（12 位小数）
  amount,         // 总金额
  paymentCommit,  // 支付承诺哈希
  contactCommit   // 联系承诺哈希
)
```

### 承诺哈希
- **支付承诺**：包含支付方式、时间戳、账户地址
- **联系承诺**：包含联系方式、时间戳、账户地址
- **作用**：保护隐私，链上仅存储哈希值

### 价格计算
- 当前简化为 1:1 汇率
- 后续将对接链上预言机获取实时价格

## ⚠️ 注意事项

### 1. 必须先创建挂单
- 使用命令行脚本创建挂单：
  ```bash
  cd /home/xiaodong/文档/memopark/memopark-gov-scripts
  node create-listing.js
  ```

### 2. 必须连接钱包
- 确保本地钱包已创建
- 确保钱包有足够余额
- 记住钱包密码（至少 8 位）

### 3. 数量必须在范围内
- 不能低于最小数量（minQty）
- 不能超过最大数量（maxQty）
- 不能超过剩余库存（remaining）

### 4. 暂不支持法币模式
- 当前仅支持"MEMO 数量"模式
- 法币模式需要对接价格预言机

## 🐛 常见问题

### Q1：页面显示"无可用挂单"
**A1**：请先使用命令行脚本创建挂单
```bash
cd memopark-gov-scripts
node create-listing.js
```

### Q2：点击"创建订单"没有反应
**A2**：检查以下几点：
- ✅ 是否选择了挂单？
- ✅ 是否输入了数量？
- ✅ 数量是否在范围内？
- ✅ 是否连接了钱包？

### Q3：密码输入后提示"地址不匹配"
**A3**：当前账户与 keystore 不匹配，请检查：
- 是否切换了账户？
- 是否使用了正确的密码？
- 是否选择了正确的钱包？

### Q4：交易一直在"正在创建订单..."
**A4**：检查链节点是否正常运行：
```bash
# 检查节点日志
tail -f /home/xiaodong/文档/memopark/node.log
```

### Q5：订单状态一直不更新
**A5**：手动刷新页面或检查链端订单：
```bash
# 使用脚本查询订单
cd memopark-gov-scripts
node 查看订单状态.js
```

## 📊 测试用例

### 测试 1：正常创建订单
1. 选择挂单 ID = 1
2. 输入数量 = 100 MEMO
3. 输入密码
4. 预期：交易成功，显示哈希

### 测试 2：数量超出范围
1. 选择挂单 ID = 1
2. 输入数量 = 1 MEMO（低于最小值）
3. 预期：提示"订单数量不能低于最小数量"

### 测试 3：密码错误
1. 选择挂单 ID = 1
2. 输入数量 = 100 MEMO
3. 输入错误密码
4. 预期：提示"密码错误"或"地址不匹配"

### 测试 4：取消创建
1. 选择挂单 ID = 1
2. 输入数量 = 100 MEMO
3. 点击密码框的"取消"
4. 预期：提示"用户取消"

## 📝 相关文档

- [OTC 挂单页面使用说明](./OTC挂单页面使用说明.md)
- [OTC 订单创建功能分析](../docs/OTC订单创建功能分析.md)
- [OTC 订单创建链上交互修复完成报告](../docs/OTC订单创建链上交互修复完成报告.md)

## 🎉 总结

✅ 修复完成，现在可以正常创建 OTC 订单  
✅ 所有交易直接在链上进行，无需中间服务  
✅ 保护用户隐私，使用承诺哈希技术  
✅ 自动轮询订单状态，实时更新  

**开始使用**：访问 `http://127.0.0.1:5173/#/otc/order` 🚀

