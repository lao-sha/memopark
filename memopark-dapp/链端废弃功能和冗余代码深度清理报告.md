# é“¾ç«¯åºŸå¼ƒåŠŸèƒ½å’Œå†—ä½™ä»£ç æ·±åº¦æ¸…ç†æŠ¥å‘Š

> æ£€æŸ¥æ—¥æœŸï¼š2025-10-27  
> æ£€æŸ¥èŒƒå›´ï¼šé“¾ç«¯å·²åˆ é™¤åŠŸèƒ½ã€åºŸå¼ƒä»£ç ã€å†—ä½™ç›®å½•

---

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šæ·±å…¥æ£€æŸ¥äº†å‰ç«¯ä»£ç ä¸­å¼•ç”¨é“¾ç«¯å·²åˆ é™¤åŠŸèƒ½çš„æƒ…å†µï¼Œè¯†åˆ«å‡ºä»¥ä¸‹éœ€è¦æ¸…ç†çš„é¡¹ç›®ï¼š

| ç±»åˆ« | æ•°é‡ | ä¼˜å…ˆçº§ |
|------|------|--------|
| å·²åºŸå¼ƒçš„é“¾ç«¯åŠŸèƒ½å¼•ç”¨ | 2ä¸ª | ğŸ”´ é«˜ |
| æœªå®šä¹‰çš„å˜é‡å’Œå‡½æ•° | 5+ | ğŸ”´ é«˜ |
| ç©ºç›®å½• | 1ä¸ª | ğŸŸ¡ ä¸­ |
| æ³¨é‡Šæ‰çš„åºŸå¼ƒä»£ç  | 4+ | ğŸŸ¡ ä¸­ |
| Subsquidç›¸å…³çš„ç¦ç”¨ä»£ç å— | 14ä¸ªæ–‡ä»¶ | ğŸŸ¢ ä½ |

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ï¼šé“¾ç«¯å·²åˆ é™¤çš„åŠŸèƒ½

### 1. FeeGuard åŠŸèƒ½ï¼ˆå·²ä»é“¾ç«¯ç§»é™¤ï¼‰

**çŠ¶æ€ï¼š** å·²ç§»é™¤ä½†æ®‹ç•™æ³¨é‡Šä»£ç 

#### ç›¸å…³æ–‡ä»¶ï¼š

**src/routes.tsxï¼ˆç¬¬65è¡Œï¼‰**
```typescript
// { match: h => h === '#/fee-guard', component: lazy(() => import('./features/fee-guard/FeeGuardAdminPage')) },  // å·²ç§»é™¤ FeeGuard
```

**src/App.tsxï¼ˆç¬¬38è¡Œï¼‰**
```typescript
// import FeeGuardAdminPage from './features/fee-guard/FeeGuardAdminPage';  // å·²ç§»é™¤ FeeGuard
```

**src/features/home/HomePage.tsxï¼ˆç¬¬11è¡Œå’Œç¬¬167è¡Œï¼‰**
```typescript
// import FeeGuardCard from './FeeGuardCard'  // å·²ç§»é™¤ FeeGuard
// ...
{/* <FeeGuardCard /> */}  {/* å·²ç§»é™¤ FeeGuard */}
```

#### å½±å“è¯„ä¼°ï¼š

- âœ… **æ— åŠŸèƒ½å½±å“** - å·²ç»å®Œå…¨æ³¨é‡Šæ‰
- ğŸŸ¡ **ä»£ç æ¸…æ´åº¦** - æ³¨é‡Šæ®‹ç•™å½±å“å¯è¯»æ€§
- ğŸŸ¢ **æ— ç¼–è¯‘é”™è¯¯** - ä¸ä¼šå¯¼è‡´é”™è¯¯

#### å»ºè®®æ¸…ç†ï¼š

**åˆ é™¤æ‰€æœ‰FeeGuardç›¸å…³çš„æ³¨é‡Šè¡Œ**

```bash
# å»ºè®®æ¸…ç†çš„è¡Œæ•°ï¼š
# routes.tsx: ç¬¬65è¡Œ
# App.tsx: ç¬¬38è¡Œ
# HomePage.tsx: ç¬¬11è¡Œã€ç¬¬167è¡Œ
```

**æ¸…ç†æ­¥éª¤ï¼š**
1. ç§»é™¤routes.tsxä¸­çš„æ³¨é‡Šè·¯ç”±
2. ç§»é™¤App.tsxä¸­çš„æ³¨é‡Šå¯¼å…¥
3. ç§»é™¤HomePage.tsxä¸­çš„æ³¨é‡Šå¯¼å…¥å’Œç»„ä»¶å¼•ç”¨
4. ç¡®è®¤features/fee-guard/ç›®å½•ä¸å­˜åœ¨ï¼ˆå·²ç¡®è®¤ï¼‰

---

### 2. Subsquid åŠŸèƒ½ï¼ˆå·²ç¦ç”¨ä½†æ®‹ç•™ä»£ç ï¼‰

**çŠ¶æ€ï¼š** å·²ä½¿ç”¨ `false &&` ç¦ç”¨ï¼Œä½†å­˜åœ¨æœªå®šä¹‰å˜é‡é”™è¯¯

#### ä¸»è¦é—®é¢˜æ–‡ä»¶ï¼š

**src/features/dashboard/DashboardPage.tsx**

**ä½ç½®ï¼š** ç¬¬148-208è¡Œ

**é—®é¢˜ä»£ç ï¼š**
```typescript
{/* å…¨å±€é“¾ä¸Šç›´è¿æ¨¡å¼ï¼Œæš‚æ—¶éšè— Subsquid ç›¸å…³åŠŸèƒ½ */}
{false && (
  <Space direction="vertical" style={{ width: '100%' }} size={8}>
    {squidError && <Alert type="error" showIcon message={squidError} />}
    
    <Card size="small" title="è¿‘30å¤©æ–°å¢å¢“åœ°">
      {dailyNewGraves.map(d => (
        // ...
      ))}
    </Card>
    
    <Card size="small" title="è¿‘7å¤©å›­åŒº Top5ï¼ˆæ–°å¢å¢“åœ°ï¼‰">
      {topParks.length === 0 ? // ...
    </Card>
    
    <Card size="small" title="è¿‘7å¤©å¢“åœ° Top5ï¼ˆæŒ‰æœ€è¿‘åŠ¨ä½œæ•°ï¼‰">
      {topGraves.length === 0 ? // ...
    </Card>
    
    <Card size="small" title="æœ€è¿‘äº‹ä»¶ï¼ˆGraveActionsï¼‰">
      {recentActions.length === 0 ? // ...
    </Card>
  </Space>
)}
```

**æœªå®šä¹‰çš„å˜é‡ï¼ˆ5ä¸ªï¼‰ï¼š**
1. `squidError` - æœªå£°æ˜
2. `dailyNewGraves` - æœªå£°æ˜
3. `topParks` - æœªå£°æ˜
4. `topGraves` - æœªå£°æ˜
5. `recentActions` - æœªå£°æ˜

#### å…¶ä»–Subsquidç›¸å…³æ–‡ä»¶ï¼ˆ14ä¸ªï¼‰ï¼š

æ ¹æ®æœç´¢ç»“æœï¼Œä»¥ä¸‹æ–‡ä»¶åŒ…å«squidç›¸å…³å¼•ç”¨ï¼š

1. src/features/grave/GraveDetailPage.tsx
2. src/features/otc/OrderDetailPage.tsx
3. src/features/otc/MyOtcPage.tsx
4. src/features/dashboard/DashboardPage.tsx â­ **ä¸»è¦é—®é¢˜**
5. src/features/ledger/TopGravesPage.tsx
6. src/features/guestbook/GuestbookPage.tsx
7. src/features/ledger/LedgerOverviewPage.tsx
8. src/features/notifications/NotificationCenterPage.tsx
9. src/features/memorial/HallPage.tsx
10. src/components/discovery/RecentOfferingsTimeline.tsx
11. src/features/offerings/OfferingsTimeline.tsx
12. src/features/offerings/OfferingsByWho.tsx
13. src/features/grave/GraveListPage.tsx
14. src/features/offerings/OfferPage.tsx

#### å½±å“è¯„ä¼°ï¼š

- ğŸ”´ **ç¼–è¯‘é”™è¯¯** - TypeScriptæŠ¥é”™ï¼ˆCannot find nameï¼‰
- ğŸŸ¡ **ä»£ç è†¨èƒ€** - çº¦60è¡Œæ— ç”¨ä»£ç 
- ğŸŸ¢ **è¿è¡Œæ—¶æ— å½±å“** - `false &&` çŸ­è·¯ï¼Œä»£ç ä¸ä¼šæ‰§è¡Œ

#### å»ºè®®æ¸…ç†ï¼š

**é€‰é¡¹1ï¼šå®Œå…¨åˆ é™¤ï¼ˆæ¨èï¼‰**

åˆ é™¤æ•´ä¸ª `false &&` ä»£ç å—ï¼ˆç¬¬148-208è¡Œï¼‰ï¼ŒåŒ…æ‹¬æ‰€æœ‰æœªå®šä¹‰å˜é‡çš„å¼•ç”¨ã€‚

**é€‰é¡¹2ï¼šä¿®å¤åä¿ç•™ï¼ˆå¦‚æœå°†æ¥å¯èƒ½å¯ç”¨ï¼‰**

å¦‚æœSubsquidåŠŸèƒ½å°†æ¥å¯èƒ½æ¢å¤ï¼Œåº”è¯¥ï¼š
1. æ·»åŠ å˜é‡å®šä¹‰ï¼š
```typescript
const [squidError, setSquidError] = useState<string | null>(null)
const [dailyNewGraves, setDailyNewGraves] = useState<any[]>([])
const [topParks, setTopParks] = useState<any[]>([])
const [topGraves, setTopGraves] = useState<any[]>([])
const [recentActions, setRecentActions] = useState<any[]>([])
```

2. æˆ–è€…ä½¿ç”¨ç¯å¢ƒå˜é‡æ§åˆ¶ï¼š
```typescript
{import.meta.env.VITE_ENABLE_SUBSQUID && (
  // ... Subsquidä»£ç 
)}
```

**å½“å‰å»ºè®®ï¼š** å®Œå…¨åˆ é™¤ï¼ˆé€‰é¡¹1ï¼‰ï¼Œå› ä¸ºå·²æ ‡æ³¨"å·²åºŸå¼ƒ"ã€‚

---

## ğŸ”´ ä¸¥é‡é—®é¢˜ï¼šæœªå®šä¹‰çš„å˜é‡å’Œå‡½æ•°

### 3. CreateOrderPage.tsx ä¸­çš„æœªå®šä¹‰å¼•ç”¨

**ä½ç½®ï¼š** src/features/otc/CreateOrderPage.tsx

#### é—®é¢˜1ï¼šæœªå®šä¹‰çš„ `dayjs`ï¼ˆç¬¬1122è¡Œï¼‰

```typescript
<Descriptions.Item label="æœ‰æ•ˆæœŸè‡³">
  {dayjs((order.expired_at || 0) * 1000).format('YYYY-MM-DD HH:mm:ss')}
</Descriptions.Item>
```

**é—®é¢˜ï¼š** `dayjs` æœªå¯¼å…¥

**ä¿®å¤ï¼š**
```typescript
// åœ¨æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å¯¼å…¥
import dayjs from 'dayjs'
```

æˆ–è€…ä½¿ç”¨åŸç”ŸDateï¼š
```typescript
{new Date((order.expired_at || 0) * 1000).toLocaleString('zh-CN')}
```

#### é—®é¢˜2ï¼šæœªå®šä¹‰çš„ `getPaymentDeadline`ï¼ˆç¬¬1461è¡Œï¼‰

```typescript
const paymentInfo = {
  amount: calculateOrderAmount(),
  makerAddress: maker.owner,
  makerTronAddress: maker.tronAddress || 'æœªé…ç½®',
  deadline: getPaymentDeadline()  // âŒ æœªå®šä¹‰
}
```

**é—®é¢˜ï¼š** `getPaymentDeadline` å‡½æ•°æœªå®šä¹‰

**å¯èƒ½åŸå› ï¼š** å‡½æ•°è¢«åˆ é™¤æˆ–é‡å‘½å

**å»ºè®®ä¿®å¤ï¼š**
```typescript
// é€‰é¡¹1ï¼šå¦‚æœdeadlineä¸å†éœ€è¦
const paymentInfo = {
  amount: calculateOrderAmount(),
  makerAddress: maker.owner,
  makerTronAddress: maker.tronAddress || 'æœªé…ç½®',
  // deadline: getPaymentDeadline()  // å·²åºŸå¼ƒ
}

// é€‰é¡¹2ï¼šå¦‚æœéœ€è¦deadlineï¼Œé‡æ–°å®ç°
const getPaymentDeadline = () => {
  const now = Date.now()
  const deadline = now + (order.payment_timeout || 30 * 60) * 1000
  return new Date(deadline).toLocaleString('zh-CN')
}
```

---

### 4. CreateOrderPage.tsx ä¸­çš„æœªå®šä¹‰ `form` å˜é‡

**ä½ç½®ï¼š** src/features/otc/CreateOrderPage.tsxï¼ˆç¬¬1298è¡Œï¼‰

```typescript
form.validateFields()  // âŒ form æœªå®šä¹‰
```

**é—®é¢˜ï¼š** `form` å˜é‡æœªå®šä¹‰

**å¯èƒ½åŸå› ï¼š** ç¼ºå°‘ `const [form] = Form.useForm()` å£°æ˜

**ä¿®å¤ï¼š**
```typescript
// åœ¨ç»„ä»¶é¡¶éƒ¨æ·»åŠ 
const [form] = Form.useForm()
```

---

### 5. CreateOrderPage.tsx ä¸­çš„æœªå®šä¹‰ `selectedMaker`

**ä½ç½®ï¼š** src/features/otc/CreateOrderPage.tsxï¼ˆç¬¬1302è¡Œï¼‰

```typescript
selectedMaker.owner  // âŒ selectedMaker æœªå®šä¹‰
```

**å¯èƒ½åŸå› ï¼š** å˜é‡åé”™è¯¯æˆ–ç¼ºå°‘å£°æ˜

**æ£€æŸ¥ï¼š** åº”è¯¥æ˜¯ `maker` è€Œä¸æ˜¯ `selectedMaker`

---

### 6. CreateOrderPage.tsx ä¸­çš„æœªå®šä¹‰ `selectedAccount`

**ä½ç½®ï¼š** src/features/otc/CreateOrderPage.tsxï¼ˆç¬¬1352è¡Œï¼‰

```typescript
selectedAccount.address  // âŒ selectedAccount æœªå®šä¹‰
```

**å¯èƒ½åŸå› ï¼š** åº”è¯¥ä½¿ç”¨ `currentAccount` æˆ– `account`

**ä¿®å¤ï¼š**
```typescript
// å¦‚æœä½¿ç”¨äº†useWallet
const { currentAccount } = useWallet()
// ç„¶åä½¿ç”¨
currentAccount?.address
```

---

## ğŸŸ¡ ä¸­ç­‰é—®é¢˜ï¼šç©ºç›®å½•

### 7. features/park/ ç©ºç›®å½•

**ä½ç½®ï¼š** src/features/park/

**çŠ¶æ€ï¼š** ç›®å½•å­˜åœ¨ä½†å®Œå…¨ä¸ºç©º

**æ£€æŸ¥ç»“æœï¼š**
```bash
$ ls -la src/features/park/
# ... no children found ...
```

**å½±å“ï¼š**
- ğŸŸ¡ **é¡¹ç›®ç»“æ„æ··ä¹±** - ç©ºç›®å½•æ— æ„ä¹‰
- ğŸŸ¢ **æ— åŠŸèƒ½å½±å“** - ä¸ä¼šå¯¼è‡´é”™è¯¯

**å»ºè®®ï¼š** åˆ é™¤ç©ºç›®å½•

```bash
rm -rf src/features/park/
```

---

## ğŸŸ¢ è½»å¾®é—®é¢˜ï¼šå·²åºŸå¼ƒåŠŸèƒ½çš„æ³¨é‡Š

### 8. å„æ–‡ä»¶ä¸­çš„"å·²ç§»é™¤"ã€"å·²åºŸå¼ƒ"æ³¨é‡Š

æ ¹æ®æœç´¢ç»“æœï¼Œä»¥ä¸‹æ–‡ä»¶åŒ…å«åºŸå¼ƒåŠŸèƒ½çš„æ³¨é‡Šï¼š

1. **src/features/home/HomePage.tsx** - FeeGuardç›¸å…³
2. **src/App.tsx** - FeeGuardå¯¼å…¥
3. **src/routes.tsx** - FeeGuardè·¯ç”±
4. **src/features/grave/GraveDetailPage.tsx** - åŠŸèƒ½åºŸå¼ƒæ ‡æ³¨
5. **src/features/deceased/CreateDeceasedForm.tsx** - åŠŸèƒ½åºŸå¼ƒæ ‡æ³¨
6. **src/features/otc/CreateOrderPage.tsx** - åŠŸèƒ½åºŸå¼ƒæ ‡æ³¨
7. **src/features/governance/lib/governance.ts** - åŠŸèƒ½åºŸå¼ƒæ ‡æ³¨
8. **src/features/grave/GraveAudioPicker.tsx** - åŠŸèƒ½åºŸå¼ƒæ ‡æ³¨

**å»ºè®®ï¼š** å®¡æŸ¥è¿™äº›æ³¨é‡Šï¼Œå†³å®šæ˜¯å®Œå…¨åˆ é™¤è¿˜æ˜¯ä¿ç•™ä½œä¸ºæ–‡æ¡£

---

## ğŸ“Š æ¸…ç†ä¼˜å…ˆçº§å’Œè®¡åˆ’

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆç«‹å³æ¸…ç†ï¼‰

1. **åˆ é™¤DashboardPageä¸­çš„Subsquidä»£ç å—**
   - æ–‡ä»¶ï¼šsrc/features/dashboard/DashboardPage.tsx
   - è¡Œæ•°ï¼šç¬¬148-208è¡Œï¼ˆçº¦60è¡Œï¼‰
   - åŸå› ï¼šåŒ…å«æœªå®šä¹‰å˜é‡ï¼Œå¯¼è‡´TypeScripté”™è¯¯

2. **ä¿®å¤CreateOrderPageä¸­çš„æœªå®šä¹‰å¼•ç”¨**
   - æ–‡ä»¶ï¼šsrc/features/otc/CreateOrderPage.tsx
   - é—®é¢˜ï¼š
     - æ·»åŠ  `dayjs` å¯¼å…¥æˆ–ä½¿ç”¨åŸç”ŸDate
     - å®šä¹‰æˆ–åˆ é™¤ `getPaymentDeadline`
     - æ·»åŠ  `form` å£°æ˜
     - ä¿®å¤ `selectedMaker` å¼•ç”¨
     - ä¿®å¤ `selectedAccount` å¼•ç”¨

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆæœ¬å‘¨æ¸…ç†ï¼‰

3. **åˆ é™¤FeeGuardç›¸å…³æ³¨é‡Š**
   - æ–‡ä»¶ï¼šroutes.tsx, App.tsx, HomePage.tsx
   - è¡Œæ•°ï¼šçº¦4è¡Œ
   - åŸå› ï¼šä»£ç æ¸…æ´åº¦

4. **åˆ é™¤ç©ºç›®å½•**
   - ç›®å½•ï¼šsrc/features/park/
   - åŸå› ï¼šé¡¹ç›®ç»“æ„æ•´æ´

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆè®¡åˆ’æ¸…ç†ï¼‰

5. **å®¡æŸ¥å…¶ä»–Subsquidç›¸å…³æ–‡ä»¶**
   - æ–‡ä»¶ï¼š14ä¸ªæ–‡ä»¶ï¼ˆè§ä¸Šæ–‡åˆ—è¡¨ï¼‰
   - åŸå› ï¼šç¡®è®¤æ˜¯å¦éœ€è¦æ¸…ç†

6. **æ¸…ç†æˆ–æ›´æ–°åºŸå¼ƒåŠŸèƒ½æ³¨é‡Š**
   - æ–‡ä»¶ï¼š8ä¸ªæ–‡ä»¶ï¼ˆè§ä¸Šæ–‡åˆ—è¡¨ï¼‰
   - åŸå› ï¼šæ–‡æ¡£æ•´æ´

---

## ğŸ› ï¸ ç«‹å³æ‰§è¡Œçš„æ¸…ç†è„šæœ¬

### æ¸…ç†1ï¼šåˆ é™¤DashboardPageä¸­çš„Subsquidä»£ç å—

<function_calls>
<invoke name="read_file">
<parameter name="target_file">/home/xiaodong/æ–‡æ¡£/memopark/memopark-dapp/src/features/dashboard/DashboardPage.tsx
