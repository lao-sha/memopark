# Memopark DApp 团队审查和功能测试指南

> 日期：2025-10-27  
> 版本：清理完成后的验证版本

---

## 🚨 前置问题修复

### 系统文件监听器限制问题

开发服务器启动时遇到错误：
```
Error: ENOSPC: System limit for number of file watchers reached
```

**解决方案（需要sudo权限）：**

```bash
# 临时增加限制
sudo sysctl fs.inotify.max_user_watches=524288

# 永久增加限制
echo fs.inotify.max_user_watches=524288 | sudo tee -a /etc/sysctl.conf
sudo sysctl -p
```

**验证修复：**
```bash
cat /proc/sys/fs/inotify/max_user_watches
# 应该显示 524288
```

---

## 📋 团队审查清单

### 1. 代码变更审查 ✓

#### 1.1 已删除的文件（14个）

请确认以下文件可以安全删除：

**备份文件：**
- [ ] `src/features/affiliate/RewardParamsPanel.tsx.bak` - 确认不需要
- [ ] `src/features/affiliate/RewardParamsPanel.tsx.new` - 确认不需要

**测试文件：**
- [ ] `src/main-basic.tsx` - 确认不需要
- [ ] `src/main-test.tsx` - 确认不需要

**示例文件：**
- [ ] `src/examples/MultiRecipientEncryptionExample.tsx` - 确认不需要

**冗余Context：**
- [ ] `src/context/PolkadotContext.tsx` - 已统一到WalletProvider
- [ ] `src/contexts/AccountContext.tsx` - 已统一到WalletProvider
- [ ] `src/substrate/SubstrateContext.tsx` - 已统一到WalletProvider

**空目录：**
- [ ] `src/context/` - 已清空
- [ ] `src/contexts/` - 已清空
- [ ] `src/substrate/` - 已清空

**重复目录：**
- [ ] `src/components/Governance/` - 已合并到 `governance/`

#### 1.2 修改的文件（6个）

请审查以下代码更改是否正确：

**文件1: `src/features/chat/ChatWindow.tsx`**
```diff
- import { useAccount } from '../../contexts/AccountContext';
+ import { useWallet } from '../../providers/WalletProvider';

- const { account } = useAccount();
+ const { currentAccount: account } = useWallet();
```
- [ ] 导入更改正确
- [ ] 变量名映射正确
- [ ] 功能正常

**文件2: `src/features/chat/ChatList.tsx`**
```diff
- import { useAccount } from '../../contexts/AccountContext';
+ import { useWallet } from '../../providers/WalletProvider';

- const { account } = useAccount();
+ const { currentAccount: account } = useWallet();
```
- [ ] 导入更改正确
- [ ] 变量名映射正确
- [ ] 功能正常

**文件3: `src/features/operator-rewards/OperatorRewardsDashboard.tsx`**
```diff
- import { usePolkadot } from '../../context/PolkadotContext';
+ import { useWallet } from '../../providers/WalletProvider';

- const { api, account } = usePolkadot();
+ const { api, currentAccount: account } = useWallet();
```
- [ ] 导入更改正确
- [ ] 变量名映射正确
- [ ] 功能正常

**文件4: `src/features/storage-treasury/StorageTreasuryDashboard.tsx`**
```diff
- import { useSubstrateContext } from '../../substrate/SubstrateContext';
+ import { useWallet } from '../../providers/WalletProvider';

- const { api, apiState } = useSubstrateContext();
+ const { api } = useWallet();

- if (!api || apiState !== 'READY') return;
+ if (!api) return;
```
- [ ] 导入更改正确
- [ ] 移除apiState逻辑正确
- [ ] 功能正常

**文件5: `src/lib/sessionManager.ts`**
```diff
- import { SecureStorage } from './secureStorageSimple'
+ import { SecureStorage } from './secureStorage'
```
- [ ] 导入路径更新正确
- [ ] 功能正常

**文件6: `src/utils/committeeEncryption.ts`**
```diff
- export interface MultiRecipientEncryptedData {
+ export interface CommitteeEncryptedData {
```
- [ ] 接口重命名正确
- [ ] 所有引用已更新
- [ ] 与multiRecipientEncryption.ts无冲突

#### 1.3 重命名的文件

**存储实现重命名：**
- [ ] `src/lib/secureStorage.ts` → `secureStorage-aes.ts.unused` - 正确标记为未使用
- [ ] `src/lib/secureStorageSimple.ts` → `secureStorage.ts` - 现在是主实现

---

## 🧪 功能测试清单

### 2. 核心功能测试

在系统限制问题修复后，运行开发服务器：
```bash
npm run dev
```

#### 2.1 钱包连接功能 ⭐ 高优先级

**测试场景1：钱包连接**
- [ ] 打开应用首页
- [ ] 检查钱包连接状态显示正常
- [ ] 点击"连接钱包"按钮
- [ ] 验证钱包列表显示
- [ ] 选择一个钱包账户
- [ ] 确认连接成功

**测试场景2：账户切换**
- [ ] 连接钱包后，打开账户选择器
- [ ] 切换到另一个账户
- [ ] 确认页面状态更新
- [ ] 验证账户地址显示正确

**测试场景3：钱包断开**
- [ ] 断开钱包连接
- [ ] 确认状态重置
- [ ] 页面提示正确

**预期行为：**
- ✅ 所有钱包功能正常
- ✅ Context状态管理正确
- ✅ 无控制台错误

#### 2.2 聊天功能 ⭐ 高优先级

**原因：** 聊天功能使用了修改后的Context

**测试场景1：聊天列表**
- [ ] 导航到聊天页面 `#/chat`
- [ ] 验证聊天会话列表加载
- [ ] 检查当前账户显示正确
- [ ] 验证无Console错误

**测试场景2：聊天窗口**
- [ ] 选择一个聊天会话
- [ ] 验证消息列表加载
- [ ] 发送一条测试消息
- [ ] 确认消息发送成功
- [ ] 检查账户信息显示正确

**测试场景3：文件上传（如果启用）**
- [ ] 尝试上传图片或文件
- [ ] 验证上传功能正常
- [ ] 确认加密功能正常（如适用）

**预期行为：**
- ✅ 聊天列表正常加载
- ✅ 消息发送功能正常
- ✅ 账户信息显示正确
- ✅ 无Context相关错误

#### 2.3 运营者奖励Dashboard ⭐ 中优先级

**原因：** 使用了修改后的Context

**测试场景：**
- [ ] 导航到运营者奖励Dashboard `#/operator-rewards` （如果有路由）
- [ ] 验证API连接状态
- [ ] 检查数据加载
- [ ] 验证账户信息显示
- [ ] 测试奖励分配功能（如有权限）

**预期行为：**
- ✅ Dashboard正常加载
- ✅ API连接正常
- ✅ 数据显示正确
- ✅ 无Context相关错误

#### 2.4 存储Treasury Dashboard ⭐ 中优先级

**原因：** 使用了修改后的Context，并移除了apiState

**测试场景：**
- [ ] 导航到存储Treasury Dashboard `#/storage-treasury`
- [ ] 验证API连接（不依赖apiState）
- [ ] 检查存储池余额显示
- [ ] 验证分配历史加载
- [ ] 检查路由表配置显示

**预期行为：**
- ✅ Dashboard正常加载
- ✅ 移除apiState后功能正常
- ✅ 所有数据正确显示
- ✅ 无API状态相关错误

#### 2.5 通用功能测试 ⭐ 低优先级

**测试场景：浏览主要页面**
- [ ] 首页 `/`
- [ ] Dashboard `#/dashboard`
- [ ] 墓地列表 `#/grave/my`
- [ ] 逝者列表 `#/deceased/list`
- [ ] OTC订单 `#/orders`
- [ ] 其他主要页面

**预期行为：**
- ✅ 所有页面正常加载
- ✅ 无Context相关错误
- ✅ 导航功能正常
- ✅ 数据加载正常

---

## 🔍 控制台错误检查

### 3. 开发工具检查

打开浏览器开发工具（F12），检查：

#### 3.1 Console标签

**不应该看到的错误：**
- ❌ `PolkadotContext is not defined`
- ❌ `AccountContext is not defined`
- ❌ `SubstrateContext is not defined`
- ❌ `Cannot find module 'secureStorageSimple'`
- ❌ `apiState is not defined`

**可以忽略的警告：**
- ⚠️ Polkadot API类型警告（既存问题）
- ⚠️ React DevTools提示

#### 3.2 Network标签

**检查项：**
- [ ] API请求正常发送
- [ ] WebSocket连接正常（如果使用）
- [ ] 无异常的404错误

#### 3.3 React DevTools（如果安装）

**检查项：**
- [ ] WalletProvider在组件树中
- [ ] Context值正确传递
- [ ] 组件状态更新正常

---

## 📝 测试结果记录

### 测试执行记录表

| 功能 | 测试人 | 日期 | 状态 | 备注 |
|------|--------|------|------|------|
| 钱包连接 | | | ⏳ | |
| 账户切换 | | | ⏳ | |
| 聊天列表 | | | ⏳ | |
| 聊天窗口 | | | ⏳ | |
| 消息发送 | | | ⏳ | |
| 运营者Dashboard | | | ⏳ | |
| 存储Dashboard | | | ⏳ | |
| 页面导航 | | | ⏳ | |

**状态标记：**
- ⏳ 待测试
- ✅ 通过
- ❌ 失败
- ⚠️ 有问题但不影响主要功能

---

## 🐛 问题报告模板

如果发现问题，请使用以下模板报告：

```markdown
### 问题描述
[简短描述问题]

### 重现步骤
1. 
2. 
3. 

### 预期行为
[描述预期的正确行为]

### 实际行为
[描述实际发生的情况]

### 错误信息
[粘贴Console错误信息]

### 环境信息
- 浏览器：
- 版本：
- 清理版本：是

### 截图
[如果可能，附上截图]

### 是否与清理相关
- [ ] 是 - 与Context统一相关
- [ ] 是 - 与存储实现相关
- [ ] 是 - 与目录结构相关
- [ ] 否 - 既存问题
```

---

## ✅ 审查通过标准

### 代码审查通过标准

- [ ] 所有6个修改的文件已审查
- [ ] 所有删除的文件确认可删除
- [ ] 代码逻辑正确
- [ ] 命名规范一致
- [ ] 无明显的逻辑错误

### 功能测试通过标准

- [ ] 钱包连接功能正常（80%测试通过）
- [ ] 聊天功能正常（80%测试通过）
- [ ] Dashboard功能正常（80%测试通过）
- [ ] 页面导航正常（80%测试通过）
- [ ] 无严重的Console错误
- [ ] 无功能回退

### 最终批准标准

**可以批准提交的条件：**
1. ✅ 代码审查通过
2. ✅ 核心功能测试通过（至少80%）
3. ✅ 无严重的回归问题
4. ✅ 团队成员确认无异议

**不建议提交的情况：**
- ❌ 发现严重的功能回退
- ❌ 核心功能无法使用
- ❌ 大量Console错误
- ❌ 团队成员有严重异议

---

## 📊 审查总结模板

完成审查后，填写此总结：

```markdown
## 团队审查总结

**审查日期：** [日期]  
**审查人员：** [姓名列表]

### 代码审查结果
- 审查的文件数：6
- 通过：[ ]
- 需要修改：[ ]
- 问题数量：[ ]

### 功能测试结果
- 测试的功能：[ ]个
- 通过：[ ]个
- 失败：[ ]个
- 成功率：[ ]%

### 发现的问题
1. [问题描述]
2. [问题描述]

### 是否批准提交
- [ ] 批准 - 可以立即提交
- [ ] 批准 - 修复轻微问题后提交
- [ ] 不批准 - 需要重大修改

### 审查结论
[总结审查结果和建议]

### 签名
- [ ] 前端负责人
- [ ] 技术负责人
- [ ] QA负责人
```

---

## 🚀 提交前最后检查

在提交到Git前，执行最后检查：

```bash
# 1. 确认所有改动
git status
git diff

# 2. 检查暂存的文件
git add .
git status

# 3. 运行快速测试
npm run build  # 确保可以构建
npm run lint   # 确保代码质量

# 4. 提交（分3次）
git commit -m "feat: 清理冗余备份和测试文件

- 删除 5 个备份和测试文件
- 删除未使用的示例文件
- 合并重复的目录结构

BREAKING CHANGE: 删除了 main-basic.tsx 和 main-test.tsx"

git commit -m "refactor: 统一Context接口和安全存储实现

- 删除3个冗余的Context导出（PolkadotContext, AccountContext, SubstrateContext）
- 统一使用 WalletProvider
- 重命名secureStorageSimple为secureStorage
- 更新4个组件的Context使用

BREAKING CHANGE: 
- 所有Context别名已删除，统一使用 useWallet
- secureStorageSimple 已重命名为 secureStorage"

git commit -m "refactor: 重命名CommitteeEncryptedData避免接口冲突

- 将committeeEncryption.ts中的MultiRecipientEncryptedData重命名为CommitteeEncryptedData
- 避免与multiRecipientEncryption.ts的接口命名冲突
- 提高代码可读性和类型安全性"
```

---

## 📞 支持和帮助

如有问题，请联系：
- 技术负责人：[联系方式]
- 前端团队：[联系方式]

---

**文档结束**

请按照此指南进行团队审查和功能测试。
祝测试顺利！ 🎉

