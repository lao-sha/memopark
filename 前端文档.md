### 前端技术方案（手机 DApp）

- **应用框架**: React 18 + TypeScript（Vite）
- **UI**: Ant Design v5（不引入 Tailwind）
- **数据与状态**: TanStack Query + Zustand
- **Substrate SDK**: @polkadot/api（前端“本地钱包模式”，不依赖浏览器扩展）
- **移动适配**: PWA（可选）+ Capacitor（相机/相册/文件/通知/深链能力）
- **签名模式**: 默认托管私钥（后端 HSM/MPC 远程签名），支持非托管兜底（钱包内置浏览器/Deep Link/扫码）

---

### 初始化与依赖

```bash
# 创建项目
pnpm create vite memopark-dapp --template react-ts
cd memopark-dapp
pnpm i

# UI 与基础库
pnpm i antd @ant-design/icons dayjs

# 数据与状态
pnpm i @tanstack/react-query zustand

# Substrate SDK（默认）
pnpm i @polkadot/api

# 开发工具（可选）
pnpm i -D eslint prettier
```

---

### Vite 与 Polyfill（@polkadot/api 需要）

```bash
pnpm i -D vite-plugin-node-stdlib-browser @esbuild-plugins/node-globals-polyfill
```

```ts
// vite.config.ts
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import { NodeGlobalsPolyfillPlugin } from '@esbuild-plugins/node-globals-polyfill';
import stdLibBrowser from 'vite-plugin-node-stdlib-browser';

export default defineConfig({
  plugins: [react(), stdLibBrowser()],
  define: { global: 'globalThis' },
  optimizeDeps: {
    esbuildOptions: {
      define: { global: 'globalThis' },
      plugins: [NodeGlobalsPolyfillPlugin({ buffer: true })]
    }
  },
  build: { target: 'es2020' }
});
```

---

### 移动端基础与 AntD 引入

```html
<!-- index.html / <head> -->
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
```

```ts
// src/main.tsx
import 'antd/dist/reset.css';
```

```css
/* src/index.css */
html, body, #root { height: 100%; }
body { margin: 0; background: #f7f8fa; }
.safe-area { padding-bottom: env(safe-area-inset-bottom); }
```

---

### 入口与主题（AntD + React Query）

```tsx
// src/main.tsx
import React from 'react';
import ReactDOM from 'react-dom/client';
import { ConfigProvider, App as AntdApp, theme } from 'antd';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import App from './App';
import 'antd/dist/reset.css';
import './index.css';

const qc = new QueryClient();

ReactDOM.createRoot(document.getElementById('root')!).render(
  <ConfigProvider
    theme={{ algorithm: theme.defaultAlgorithm, token: { colorPrimary: '#2F80ED', borderRadius: 8 } }}
  >
    <QueryClientProvider client={qc}>
      <AntdApp>
        <App />
      </AntdApp>
    </QueryClientProvider>
  </ConfigProvider>
);
```

---

### 环境变量

```env
# .env
VITE_WS_ENDPOINT=ws://127.0.0.1:9944
```

---

### Substrate 连接（最小封装）

```ts
// src/shared/polkadot.ts
import { ApiPromise, WsProvider } from '@polkadot/api';

let apiPromise: Promise<ApiPromise> | null = null;
export function getApi(): Promise<ApiPromise> {
  if (!apiPromise) {
    const endpoint = import.meta.env.VITE_WS_ENDPOINT as string;
    apiPromise = ApiPromise.create({ provider: new WsProvider(endpoint) });
  }
  return apiPromise;
}
```

> 本项目已移除浏览器扩展依赖，签名改为“本地钱包模式”（助记词+密码）。

---

### 示例页面：发送一次 remark 交易（本地签名）

```tsx
// 使用 WalletProvider 的 signAndSendLocalFromKeystore 即可完成本地签名发送。
```

---

### 托管私钥方案（最优实践）

- **核心**: 前端只“构造交易”，不持私钥；将 SignerPayloadJSON 发往“签名网关”，由 HSM/KMS 或 MPC/TSS 进行签名并返回；可由后端代播交易。
- **策略引擎**: pallet/call 白名单、目的地址白名单、额度（单/日/周）、速率限制、风控评分、地理/IP 画像、四眼审批/时间锁（大额）
- **接口契约**：
  - POST `/sign`：输入 SignerPayloadJSON + 解析后的 call 元信息（模块/方法/金额/目标等），输出签名与可选 txHash
  - POST `/broadcast`（可选）：由后端代播，内建重试与多 RPC 冗余
- **审计与告警**: 全链路留痕，日志摘要可锚定上链；异常 / 超额 / 非白名单目标即时告警
- **可迁移**: 用户可随时迁出到自管钱包（非托管模式），关键账户强制多签/时间锁

---

### 非托管兜底（可选）

- **钱包内置浏览器**: SubWallet/Nova 注入 `window.injectedWeb3`，直接签名
- **Deep Link/Universal Link**: 调起外部钱包签名并回传结果
- **二维码离线签名**: Polkadot Vault（高价值操作推荐）

---

### PWA（可选）与 Capacitor（可选）

- **PWA**: 添加 manifest.json 与 Service Worker，实现“添加到主屏幕、离线缓存”
- **Capacitor**: 需要系统相机/相册/文件/通知/深链时集成
  - `pnpm i @capacitor/core @capacitor/cli`
  - `npx cap init` → `npx cap add android` / `npx cap add ios`
  - `npx cap sync`，按需使用插件（Camera、Filesystem、App、Push Notifications）

---

### 目录结构建议

```
src/
  shared/
    api | polkadot.ts | accounts.ts | utils
    hooks (useApi/useAccount/useTx/useEvents)
    ui (金额输入/确认弹窗/地址显示)
  features/
    park | grave | offerings | ledger | referrals | affiliate | evidence | otc
  App.tsx
```

---

### 安全与体验要点

- **费用与 ED**: 交易前用 `paymentInfo` 预估手续费并提示 Existential Deposit
- **参数校验**: 前端解析元数据，直观展示金额/目标；拒绝任意十六进制直签
- **错误与重试**: 统一 `useTx` Hook 管理签名、事件过滤、错误码与重试
- **隐私**: 上链仅存 CID/承诺哈希，不存明文；媒体本地压缩/EXIF 清理后上传

---

### 运行与构建

```bash
pnpm dev        # 开发
pnpm build      # 构建
pnpm preview    # 预览
```

---

### 后续扩展

- **索引层**: SubQuery/Subsquid 提供排行榜、周度统计、应得/已结算等聚合数据
- **暗色主题**: `ConfigProvider` 切换 `theme.darkAlgorithm`
- **国际化**: dayjs 本地化，或接入 i18n


